"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const column_1 = require("./column");
const schema_1 = require("./schema");
const compat_1 = require("./util/compat");
const recordbatch_1 = require("./recordbatch");
const reader_1 = require("./ipc/reader");
const index_1 = require("./vector/index");
const writer_1 = require("./ipc/writer");
class Table extends index_1.Chunked {
    constructor(...args) {
        let schema = null;
        if (args[0] instanceof schema_1.Schema) {
            schema = args.shift();
        }
        let chunks = args.reduce(function flatten(xs, x) {
            return Array.isArray(x) ? x.reduce(flatten, xs) : [...xs, x];
        }, []).filter((x) => x instanceof recordbatch_1.RecordBatch);
        if (!schema && !(schema = chunks[0] && chunks[0].schema)) {
            throw new TypeError('Table must be initialized with a Schema or at least one RecordBatch');
        }
        if (!chunks[0]) {
            chunks[0] = new recordbatch_1.RecordBatch(schema, 0, []);
        }
        super(chunks[0].type, chunks);
        this._schema = schema;
        this._chunks = chunks;
    }
    /** @nocollapse */
    static empty() { return new Table(new schema_1.Schema([]), []); }
    /** @nocollapse */
    static from(source) {
        if (!source) {
            return Table.empty();
        }
        let reader = reader_1.RecordBatchReader.from(source);
        if (compat_1.isPromise(reader)) {
            return (() => tslib_1.__awaiter(this, void 0, void 0, function* () { return yield Table.from(yield reader); }))();
        }
        if (reader.isSync() && (reader = reader.open())) {
            return !reader.schema ? Table.empty() : new Table(reader.schema, [...reader]);
        }
        return ((opening) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            var e_1, _a;
            const reader = yield opening;
            const schema = reader.schema;
            const batches = [];
            if (schema) {
                try {
                    for (var reader_2 = tslib_1.__asyncValues(reader), reader_2_1; reader_2_1 = yield reader_2.next(), !reader_2_1.done;) {
                        let batch = reader_2_1.value;
                        batches.push(batch);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (reader_2_1 && !reader_2_1.done && (_a = reader_2.return)) yield _a.call(reader_2);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                return new Table(schema, batches);
            }
            return Table.empty();
        }))(reader.open());
    }
    /** @nocollapse */
    static fromAsync(source) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield Table.from(source);
        });
    }
    /** @nocollapse */
    static fromVectors(vectors, names) {
        return new Table(recordbatch_1.RecordBatch.from(vectors, names));
    }
    /** @nocollapse */
    static fromStruct(struct) {
        const schema = new schema_1.Schema(struct.type.children);
        const chunks = (struct instanceof index_1.Chunked ? struct.chunks : [struct]);
        return new Table(schema, chunks.map((chunk) => new recordbatch_1.RecordBatch(schema, chunk.data)));
    }
    get schema() { return this._schema; }
    get length() { return this._length; }
    get chunks() { return this._chunks; }
    get numCols() { return this._numChildren; }
    clone(chunks = this._chunks) {
        return new Table(this._schema, chunks);
    }
    getColumnAt(index) {
        return this.getChildAt(index);
    }
    getColumn(name) {
        return this.getColumnAt(this.getColumnIndex(name));
    }
    getColumnIndex(name) {
        return this._schema.fields.findIndex((f) => f.name === name);
    }
    getChildAt(index) {
        if (index < 0 || index >= this.numChildren) {
            return null;
        }
        let schema = this._schema;
        let column, field, chunks;
        let columns = this._children || (this._children = []);
        if (column = columns[index]) {
            return column;
        }
        if (field = (schema.fields || [])[index]) {
            chunks = this._chunks
                .map((chunk) => chunk.getChildAt(index))
                .filter((vec) => vec != null);
            if (chunks.length > 0) {
                return (columns[index] = new column_1.Column(field, chunks));
            }
        }
        return null;
    }
    // @ts-ignore
    serialize(encoding = 'binary', stream = true) {
        const writer = !stream
            ? writer_1.RecordBatchFileWriter
            : writer_1.RecordBatchStreamWriter;
        return writer.writeAll(this._chunks).toUint8Array(true);
    }
    count() {
        return this._length;
    }
    select(...columnNames) {
        return new Table(this._chunks.map((batch) => batch.select(...columnNames)));
    }
}
exports.Table = Table;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFHLElBQUk7UUFDL0MsTUFBTSxNQUFNLEdBQUcsQ0FBQyxNQUFNO1lBQ2xCLENBQUMsQ0FBQyw4QkFBcUI7WUFDdkIsQ0FBQyxDQUFDLGdDQUF1QixDQUFDO1FBQzlCLE9BQU8sTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFDTSxLQUFLO1FBQ1IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFDTSxNQUFNLENBQUMsR0FBRyxXQUFxQjtRQUNsQyxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hGLENBQUM7Q0FDSjtBQTlJRCxzQkE4SUMiLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgQ29sdW1uIH0gZnJvbSAnLi9jb2x1bW4nO1xuaW1wb3J0IHsgU2NoZW1hLCBGaWVsZCB9IGZyb20gJy4vc2NoZW1hJztcbmltcG9ydCB7IGlzUHJvbWlzZSB9IGZyb20gJy4vdXRpbC9jb21wYXQnO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2ggfSBmcm9tICcuL3JlY29yZGJhdGNoJztcbmltcG9ydCB7IFZlY3RvciBhcyBWVHlwZSB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBEYXRhRnJhbWUgfSBmcm9tICcuL2NvbXB1dGUvZGF0YWZyYW1lJztcbmltcG9ydCB7IFJlY29yZEJhdGNoUmVhZGVyIH0gZnJvbSAnLi9pcGMvcmVhZGVyJztcbmltcG9ydCB7IFZlY3RvciwgQ2h1bmtlZCB9IGZyb20gJy4vdmVjdG9yL2luZGV4JztcbmltcG9ydCB7IERhdGFUeXBlLCBSb3dMaWtlLCBTdHJ1Y3QgfSBmcm9tICcuL3R5cGUnO1xuaW1wb3J0IHsgQ2xvbmFibGUsIFNsaWNlYWJsZSwgQXBwbGljYXRpdmUgfSBmcm9tICcuL3ZlY3Rvcic7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaEZpbGVXcml0ZXIsIFJlY29yZEJhdGNoU3RyZWFtV3JpdGVyIH0gZnJvbSAnLi9pcGMvd3JpdGVyJztcblxuZXhwb3J0IGludGVyZmFjZSBUYWJsZTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4ge1xuXG4gICAgZ2V0KGluZGV4OiBudW1iZXIpOiBTdHJ1Y3Q8VD5bJ1RWYWx1ZSddO1xuICAgIFtTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8Um93TGlrZTxUPj47XG5cbiAgICBzbGljZShiZWdpbj86IG51bWJlciwgZW5kPzogbnVtYmVyKTogVGFibGU8VD47XG4gICAgY29uY2F0KC4uLm90aGVyczogVmVjdG9yPFN0cnVjdDxUPj5bXSk6IFRhYmxlPFQ+O1xuICAgIGNsb25lKGNodW5rcz86IFJlY29yZEJhdGNoPFQ+W10sIG9mZnNldHM/OiBVaW50MzJBcnJheSk6IFRhYmxlPFQ+O1xuXG4gICAgc2NhbihuZXh0OiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5OZXh0RnVuYywgYmluZD86IGltcG9ydCgnLi9jb21wdXRlL2RhdGFmcmFtZScpLkJpbmRGdW5jKTogdm9pZDtcbiAgICBjb3VudEJ5KG5hbWU6IGltcG9ydCgnLi9jb21wdXRlL3ByZWRpY2F0ZScpLkNvbCB8IHN0cmluZyk6IGltcG9ydCgnLi9jb21wdXRlL2RhdGFmcmFtZScpLkNvdW50QnlSZXN1bHQ7XG4gICAgZmlsdGVyKHByZWRpY2F0ZTogaW1wb3J0KCcuL2NvbXB1dGUvcHJlZGljYXRlJykuUHJlZGljYXRlKTogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuRmlsdGVyZWREYXRhRnJhbWU8VD47XG59XG5cbmV4cG9ydCBjbGFzcyBUYWJsZTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT5cbiAgICBleHRlbmRzIENodW5rZWQ8U3RydWN0PFQ+PlxuICAgIGltcGxlbWVudHMgRGF0YUZyYW1lPFQ+LFxuICAgICAgICAgICAgICAgQ2xvbmFibGU8VGFibGU8VD4+LFxuICAgICAgICAgICAgICAgU2xpY2VhYmxlPFRhYmxlPFQ+PixcbiAgICAgICAgICAgICAgIEFwcGxpY2F0aXZlPFN0cnVjdDxUPiwgVGFibGU8VD4+IHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZW1wdHk8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+KCkgeyByZXR1cm4gbmV3IFRhYmxlPFQ+KG5ldyBTY2hlbWEoW10pLCBbXSk7IH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PigpOiBUYWJsZTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBSZWNvcmRCYXRjaFJlYWRlcjxUPik6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzApOiBUYWJsZTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmcyKTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMSk6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzMpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21Bcmc0KTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnNSk6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IFByb21pc2VMaWtlPFJlY29yZEJhdGNoUmVhZGVyPFQ+Pik6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U/OiBhbnkpIHtcblxuICAgICAgICBpZiAoIXNvdXJjZSkgeyByZXR1cm4gVGFibGUuZW1wdHk8VD4oKTsgfVxuXG4gICAgICAgIGxldCByZWFkZXIgPSBSZWNvcmRCYXRjaFJlYWRlci5mcm9tPFQ+KHNvdXJjZSkgYXMgUmVjb3JkQmF0Y2hSZWFkZXI8VD4gfCBQcm9taXNlPFJlY29yZEJhdGNoUmVhZGVyPFQ+PjtcblxuICAgICAgICBpZiAoaXNQcm9taXNlPFJlY29yZEJhdGNoUmVhZGVyPFQ+PihyZWFkZXIpKSB7XG4gICAgICAgICAgICByZXR1cm4gKGFzeW5jICgpID0+IGF3YWl0IFRhYmxlLmZyb20oYXdhaXQgcmVhZGVyKSkoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVhZGVyLmlzU3luYygpICYmIChyZWFkZXIgPSByZWFkZXIub3BlbigpKSkge1xuICAgICAgICAgICAgcmV0dXJuICFyZWFkZXIuc2NoZW1hID8gVGFibGUuZW1wdHk8VD4oKSA6IG5ldyBUYWJsZTxUPihyZWFkZXIuc2NoZW1hLCBbLi4ucmVhZGVyXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIChhc3luYyAob3BlbmluZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVhZGVyID0gYXdhaXQgb3BlbmluZztcbiAgICAgICAgICAgIGNvbnN0IHNjaGVtYSA9IHJlYWRlci5zY2hlbWE7XG4gICAgICAgICAgICBjb25zdCBiYXRjaGVzOiBSZWNvcmRCYXRjaFtdID0gW107XG4gICAgICAgICAgICBpZiAoc2NoZW1hKSB7XG4gICAgICAgICAgICAgICAgZm9yIGF3YWl0IChsZXQgYmF0Y2ggb2YgcmVhZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGJhdGNoZXMucHVzaChiYXRjaCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFibGU8VD4oc2NoZW1hLCBiYXRjaGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBUYWJsZS5lbXB0eTxUPigpO1xuICAgICAgICB9KShyZWFkZXIub3BlbigpKTtcbiAgICB9XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGZyb21Bc3luYzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmdzKTogUHJvbWlzZTxUYWJsZTxUPj4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgVGFibGUuZnJvbTxUPihzb3VyY2UgYXMgYW55KTtcbiAgICB9XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGZyb21WZWN0b3JzPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55Pih2ZWN0b3JzOiBWVHlwZTxUW2tleW9mIFRdPltdLCBuYW1lcz86IChrZXlvZiBUKVtdKSB7XG4gICAgICAgIHJldHVybiBuZXcgVGFibGUoUmVjb3JkQmF0Y2guZnJvbSh2ZWN0b3JzLCBuYW1lcykpO1xuICAgIH1cblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbVN0cnVjdDxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oc3RydWN0OiBWZWN0b3I8U3RydWN0PFQ+Pikge1xuICAgICAgICBjb25zdCBzY2hlbWEgPSBuZXcgU2NoZW1hPFQ+KHN0cnVjdC50eXBlLmNoaWxkcmVuKTtcbiAgICAgICAgY29uc3QgY2h1bmtzID0gKHN0cnVjdCBpbnN0YW5jZW9mIENodW5rZWQgPyBzdHJ1Y3QuY2h1bmtzIDogW3N0cnVjdF0pIGFzIFZUeXBlPFN0cnVjdDxUPj5bXTtcbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZShzY2hlbWEsIGNodW5rcy5tYXAoKGNodW5rKSA9PiBuZXcgUmVjb3JkQmF0Y2goc2NoZW1hLCBjaHVuay5kYXRhKSkpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKC4uLmJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKHNjaGVtYTogU2NoZW1hLCBiYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvcihzY2hlbWE6IFNjaGVtYSwgLi4uYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3IoLi4uYXJnczogYW55W10pIHtcblxuICAgICAgICBsZXQgc2NoZW1hOiBTY2hlbWEgPSBudWxsITtcblxuICAgICAgICBpZiAoYXJnc1swXSBpbnN0YW5jZW9mIFNjaGVtYSkgeyBzY2hlbWEgPSBhcmdzLnNoaWZ0KCk7IH1cblxuICAgICAgICBsZXQgY2h1bmtzID0gYXJncy5yZWR1Y2UoZnVuY3Rpb24gZmxhdHRlbih4czogYW55W10sIHg6IGFueSk6IGFueVtdIHtcbiAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHgpID8geC5yZWR1Y2UoZmxhdHRlbiwgeHMpIDogWy4uLnhzLCB4XTtcbiAgICAgICAgfSwgW10pLmZpbHRlcigoeDogYW55KTogeCBpcyBSZWNvcmRCYXRjaDxUPiA9PiB4IGluc3RhbmNlb2YgUmVjb3JkQmF0Y2gpO1xuXG4gICAgICAgIGlmICghc2NoZW1hICYmICEoc2NoZW1hID0gY2h1bmtzWzBdICYmIGNodW5rc1swXS5zY2hlbWEpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUYWJsZSBtdXN0IGJlIGluaXRpYWxpemVkIHdpdGggYSBTY2hlbWEgb3IgYXQgbGVhc3Qgb25lIFJlY29yZEJhdGNoJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNodW5rc1swXSkgeyBjaHVua3NbMF0gPSBuZXcgUmVjb3JkQmF0Y2goc2NoZW1hLCAwLCBbXSk7IH1cblxuICAgICAgICBzdXBlcihjaHVua3NbMF0udHlwZSwgY2h1bmtzKTtcblxuICAgICAgICB0aGlzLl9zY2hlbWEgPSBzY2hlbWE7XG4gICAgICAgIHRoaXMuX2NodW5rcyA9IGNodW5rcztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3NjaGVtYTogU2NoZW1hO1xuICAgIC8vIExpc3Qgb2YgaW5uZXIgUmVjb3JkQmF0Y2hlc1xuICAgIHByb3RlY3RlZCBfY2h1bmtzOiBSZWNvcmRCYXRjaDxUPltdO1xuICAgIHByb3RlY3RlZCBfY2hpbGRyZW4/OiBDb2x1bW48VFtrZXlvZiBUXT5bXTtcblxuICAgIHB1YmxpYyBnZXQgc2NoZW1hKCkgeyByZXR1cm4gdGhpcy5fc2NoZW1hOyB9XG4gICAgcHVibGljIGdldCBsZW5ndGgoKSB7IHJldHVybiB0aGlzLl9sZW5ndGg7IH1cbiAgICBwdWJsaWMgZ2V0IGNodW5rcygpIHsgcmV0dXJuIHRoaXMuX2NodW5rczsgfVxuICAgIHB1YmxpYyBnZXQgbnVtQ29scygpIHsgcmV0dXJuIHRoaXMuX251bUNoaWxkcmVuOyB9XG5cbiAgICBwdWJsaWMgY2xvbmUoY2h1bmtzID0gdGhpcy5fY2h1bmtzKSB7XG4gICAgICAgIHJldHVybiBuZXcgVGFibGU8VD4odGhpcy5fc2NoZW1hLCBjaHVua3MpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRDb2x1bW5BdDxSIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+KGluZGV4OiBudW1iZXIpOiBDb2x1bW48Uj4gfCBudWxsIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2hpbGRBdChpbmRleCk7XG4gICAgfVxuICAgIHB1YmxpYyBnZXRDb2x1bW48UiBleHRlbmRzIGtleW9mIFQ+KG5hbWU6IFIpOiBDb2x1bW48VFtSXT4gfCBudWxsIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29sdW1uQXQodGhpcy5nZXRDb2x1bW5JbmRleChuYW1lKSkgYXMgQ29sdW1uPFRbUl0+IHwgbnVsbDtcbiAgICB9XG4gICAgcHVibGljIGdldENvbHVtbkluZGV4PFIgZXh0ZW5kcyBrZXlvZiBUPihuYW1lOiBSKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zY2hlbWEuZmllbGRzLmZpbmRJbmRleCgoZikgPT4gZi5uYW1lID09PSBuYW1lKTtcbiAgICB9XG4gICAgcHVibGljIGdldENoaWxkQXQ8UiBleHRlbmRzIERhdGFUeXBlID0gYW55PihpbmRleDogbnVtYmVyKTogQ29sdW1uPFI+IHwgbnVsbCB7XG4gICAgICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5udW1DaGlsZHJlbikgeyByZXR1cm4gbnVsbDsgfVxuICAgICAgICBsZXQgc2NoZW1hID0gdGhpcy5fc2NoZW1hO1xuICAgICAgICBsZXQgY29sdW1uOiBDb2x1bW48Uj4sIGZpZWxkOiBGaWVsZDxSPiwgY2h1bmtzOiBWZWN0b3I8Uj5bXTtcbiAgICAgICAgbGV0IGNvbHVtbnMgPSB0aGlzLl9jaGlsZHJlbiB8fCAodGhpcy5fY2hpbGRyZW4gPSBbXSkgYXMgQ29sdW1uW107XG4gICAgICAgIGlmIChjb2x1bW4gPSBjb2x1bW5zW2luZGV4XSkgeyByZXR1cm4gY29sdW1uIGFzIENvbHVtbjxSPjsgfVxuICAgICAgICBpZiAoZmllbGQgPSAoKHNjaGVtYS5maWVsZHMgfHwgW10pW2luZGV4XSBhcyBGaWVsZDxSPikpIHtcbiAgICAgICAgICAgIGNodW5rcyA9IHRoaXMuX2NodW5rc1xuICAgICAgICAgICAgICAgIC5tYXAoKGNodW5rKSA9PiBjaHVuay5nZXRDaGlsZEF0PFI+KGluZGV4KSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKCh2ZWMpOiB2ZWMgaXMgVmVjdG9yPFI+ID0+IHZlYyAhPSBudWxsKTtcbiAgICAgICAgICAgIGlmIChjaHVua3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAoY29sdW1uc1tpbmRleF0gPSBuZXcgQ29sdW1uPFI+KGZpZWxkLCBjaHVua3MpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHVibGljIHNlcmlhbGl6ZShlbmNvZGluZyA9ICdiaW5hcnknLCBzdHJlYW0gPSB0cnVlKSB7XG4gICAgICAgIGNvbnN0IHdyaXRlciA9ICFzdHJlYW1cbiAgICAgICAgICAgID8gUmVjb3JkQmF0Y2hGaWxlV3JpdGVyXG4gICAgICAgICAgICA6IFJlY29yZEJhdGNoU3RyZWFtV3JpdGVyO1xuICAgICAgICByZXR1cm4gd3JpdGVyLndyaXRlQWxsKHRoaXMuX2NodW5rcykudG9VaW50OEFycmF5KHRydWUpO1xuICAgIH1cbiAgICBwdWJsaWMgY291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xlbmd0aDtcbiAgICB9XG4gICAgcHVibGljIHNlbGVjdCguLi5jb2x1bW5OYW1lczogc3RyaW5nW10pIHtcbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZSh0aGlzLl9jaHVua3MubWFwKChiYXRjaCkgPT4gYmF0Y2guc2VsZWN0KC4uLmNvbHVtbk5hbWVzKSkpO1xuICAgIH1cbn1cbiJdfQ==
