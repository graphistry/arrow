"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const data_1 = require("./data");
const column_1 = require("./column");
const schema_1 = require("./schema");
const compat_1 = require("./util/compat");
const recordbatch_1 = require("./recordbatch");
const reader_1 = require("./ipc/reader");
const index_1 = require("./vector/index");
const recordbatch_2 = require("./util/recordbatch");
const recordbatch_3 = require("./util/recordbatch");
const writer_1 = require("./ipc/writer");
class Table extends index_1.Chunked {
    constructor(...args) {
        let schema = null;
        if (args[0] instanceof schema_1.Schema) {
            schema = args.shift();
        }
        let chunks = args.reduce(function flatten(xs, x) {
            return Array.isArray(x) ? x.reduce(flatten, xs) : [...xs, x];
        }, []).filter((x) => x instanceof recordbatch_1.RecordBatch);
        if (!schema && !(schema = chunks[0] && chunks[0].schema)) {
            throw new TypeError('Table must be initialized with a Schema or at least one RecordBatch');
        }
        if (!chunks[0]) {
            chunks[0] = new recordbatch_1.RecordBatch(schema, 0, []);
        }
        super(chunks[0].type, chunks);
        this._schema = schema;
        this._chunks = chunks;
    }
    /** @nocollapse */
    static empty() { return new Table(new schema_1.Schema([]), []); }
    /** @nocollapse */
    static from(source) {
        if (!source) {
            return Table.empty();
        }
        let reader = reader_1.RecordBatchReader.from(source);
        if (compat_1.isPromise(reader)) {
            return (async () => await Table.from(await reader))();
        }
        if (reader.isSync() && (reader = reader.open())) {
            return !reader.schema ? Table.empty() : new Table(reader.schema, [...reader]);
        }
        return (async (opening) => {
            const reader = await opening;
            const schema = reader.schema;
            const batches = [];
            if (schema) {
                for await (let batch of reader) {
                    batches.push(batch);
                }
                return new Table(schema, batches);
            }
            return Table.empty();
        })(reader.open());
    }
    /** @nocollapse */
    static async fromAsync(source) {
        return await Table.from(source);
    }
    /** @nocollapse */
    static fromVectors(vectors, fields) {
        return Table.new(vectors, fields);
    }
    /** @nocollapse */
    static fromStruct(struct) {
        return Table.new(struct.data.childData, struct.type.children);
    }
    /** @nocollapse */
    static new(...args) {
        let x = args[0], columns;
        if (x instanceof column_1.Column || (Array.isArray(x) && (x[0] instanceof column_1.Column))) {
            columns = args.reduce(function flatten(xs, x) {
                return Array.isArray(x) ? x.reduce(flatten, xs) : [...xs, x];
            }, []).filter((x) => x instanceof column_1.Column);
        }
        else {
            const [chunks, fields = []] = args;
            columns = chunks.map((chunk, i) => {
                const { [i]: name = `${i}` } = fields;
                const v = chunk instanceof data_1.Data ? index_1.Vector.new(chunk) : chunk;
                const f = name instanceof schema_1.Field ? name : new schema_1.Field(name, chunk.type);
                return column_1.Column.new(f, [v]);
            });
        }
        return new Table(...recordbatch_2.distributeColumnsIntoRecordBatches(columns));
    }
    get schema() { return this._schema; }
    get length() { return this._length; }
    get chunks() { return this._chunks; }
    get numCols() { return this._numChildren; }
    clone(chunks = this._chunks) {
        return new Table(this._schema, chunks);
    }
    getColumnAt(index) {
        return this.getChildAt(index);
    }
    getColumn(name) {
        return this.getColumnAt(this.getColumnIndex(name));
    }
    getColumnIndex(name) {
        return this._schema.fields.findIndex((f) => f.name === name);
    }
    getChildAt(index) {
        if (index < 0 || index >= this.numChildren) {
            return null;
        }
        let field, child;
        const fields = this._schema.fields;
        const columns = this._children || (this._children = []);
        if (child = columns[index]) {
            return child;
        }
        if (field = fields[index]) {
            const chunks = this._chunks
                .map((chunk) => chunk.getChildAt(index))
                .filter((vec) => vec != null);
            if (chunks.length > 0) {
                return (columns[index] = new column_1.Column(field, chunks));
            }
        }
        return null;
    }
    // @ts-ignore
    serialize(encoding = 'binary', stream = true) {
        const writer = !stream
            ? writer_1.RecordBatchFileWriter
            : writer_1.RecordBatchStreamWriter;
        return writer.writeAll(this._chunks).toUint8Array(true);
    }
    count() {
        return this._length;
    }
    select(...columnNames) {
        const nameToIndex = this._schema.fields.reduce((m, f, i) => m.set(f.name, i), new Map());
        return this.selectAt(...columnNames.map((columnName) => nameToIndex.get(columnName)));
    }
    selectAt(...columnIndices) {
        const schema = this._schema.selectAt(...columnIndices);
        return new Table(schema, this._chunks.map(({ length, data: { childData } }) => {
            return new recordbatch_1.RecordBatch(schema, length, columnIndices.map((i) => childData[i]));
        }));
    }
    assign(other) {
        const fields = this._schema.fields;
        const [indices, oldToNew] = other.schema.fields.reduce((memo, f2, newIdx) => {
            const [indices, oldToNew] = memo;
            const i = fields.findIndex((f) => f.compareTo(f2));
            ~i ? (oldToNew[i] = newIdx) : indices.push(newIdx);
            return memo;
        }, [[], []]);
        const schema = this._schema.assign(other.schema);
        const columns = [
            ...fields.map((_f, i, _fs, j = oldToNew[i]) => (j === undefined ? this.getColumnAt(i) : other.getColumnAt(j))),
            ...indices.map((i) => other.getColumnAt(i))
        ].filter(Boolean);
        return new Table(...recordbatch_3.distributeVectorsIntoRecordBatches(schema, columns));
    }
}
exports.Table = Table;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxDQUFFLENBQUM7WUFDcEUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBRSxDQUFDO1NBQy9DLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBeUMsQ0FBQztRQUUxRCxPQUFPLElBQUksS0FBSyxDQUFDLEdBQUcsZ0RBQWtDLENBQVEsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDcEYsQ0FBQztDQUNKO0FBN0xELHNCQTZMQyIsImZpbGUiOiJ0YWJsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBEYXRhIH0gZnJvbSAnLi9kYXRhJztcbmltcG9ydCB7IENvbHVtbiB9IGZyb20gJy4vY29sdW1uJztcbmltcG9ydCB7IFNjaGVtYSwgRmllbGQgfSBmcm9tICcuL3NjaGVtYSc7XG5pbXBvcnQgeyBpc1Byb21pc2UgfSBmcm9tICcuL3V0aWwvY29tcGF0JztcbmltcG9ydCB7IFJlY29yZEJhdGNoIH0gZnJvbSAnLi9yZWNvcmRiYXRjaCc7XG5pbXBvcnQgeyBEYXRhRnJhbWUgfSBmcm9tICcuL2NvbXB1dGUvZGF0YWZyYW1lJztcbmltcG9ydCB7IFJlY29yZEJhdGNoUmVhZGVyIH0gZnJvbSAnLi9pcGMvcmVhZGVyJztcbmltcG9ydCB7IFZlY3RvciwgQ2h1bmtlZCB9IGZyb20gJy4vdmVjdG9yL2luZGV4JztcbmltcG9ydCB7IERhdGFUeXBlLCBSb3dMaWtlLCBTdHJ1Y3QgfSBmcm9tICcuL3R5cGUnO1xuaW1wb3J0IHsgQ2xvbmFibGUsIFNsaWNlYWJsZSwgQXBwbGljYXRpdmUgfSBmcm9tICcuL3ZlY3Rvcic7XG5pbXBvcnQgeyBkaXN0cmlidXRlQ29sdW1uc0ludG9SZWNvcmRCYXRjaGVzIH0gZnJvbSAnLi91dGlsL3JlY29yZGJhdGNoJztcbmltcG9ydCB7IGRpc3RyaWJ1dGVWZWN0b3JzSW50b1JlY29yZEJhdGNoZXMgfSBmcm9tICcuL3V0aWwvcmVjb3JkYmF0Y2gnO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2hGaWxlV3JpdGVyLCBSZWNvcmRCYXRjaFN0cmVhbVdyaXRlciB9IGZyb20gJy4vaXBjL3dyaXRlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGFibGU8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+IHtcblxuICAgIGdldChpbmRleDogbnVtYmVyKTogU3RydWN0PFQ+WydUVmFsdWUnXTtcbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPFJvd0xpa2U8VD4+O1xuXG4gICAgc2xpY2UoYmVnaW4/OiBudW1iZXIsIGVuZD86IG51bWJlcik6IFRhYmxlPFQ+O1xuICAgIGNvbmNhdCguLi5vdGhlcnM6IFZlY3RvcjxTdHJ1Y3Q8VD4+W10pOiBUYWJsZTxUPjtcbiAgICBjbG9uZShjaHVua3M/OiBSZWNvcmRCYXRjaDxUPltdLCBvZmZzZXRzPzogVWludDMyQXJyYXkpOiBUYWJsZTxUPjtcblxuICAgIHNjYW4obmV4dDogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuTmV4dEZ1bmMsIGJpbmQ/OiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5CaW5kRnVuYyk6IHZvaWQ7XG4gICAgY291bnRCeShuYW1lOiBpbXBvcnQoJy4vY29tcHV0ZS9wcmVkaWNhdGUnKS5Db2wgfCBzdHJpbmcpOiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5Db3VudEJ5UmVzdWx0O1xuICAgIGZpbHRlcihwcmVkaWNhdGU6IGltcG9ydCgnLi9jb21wdXRlL3ByZWRpY2F0ZScpLlByZWRpY2F0ZSk6IGltcG9ydCgnLi9jb21wdXRlL2RhdGFmcmFtZScpLkZpbHRlcmVkRGF0YUZyYW1lPFQ+O1xufVxuXG5leHBvcnQgY2xhc3MgVGFibGU8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+XG4gICAgZXh0ZW5kcyBDaHVua2VkPFN0cnVjdDxUPj5cbiAgICBpbXBsZW1lbnRzIERhdGFGcmFtZTxUPixcbiAgICAgICAgICAgICAgIENsb25hYmxlPFRhYmxlPFQ+PixcbiAgICAgICAgICAgICAgIFNsaWNlYWJsZTxUYWJsZTxUPj4sXG4gICAgICAgICAgICAgICBBcHBsaWNhdGl2ZTxTdHJ1Y3Q8VD4sIFRhYmxlPFQ+PiB7XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGVtcHR5PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PigpIHsgcmV0dXJuIG5ldyBUYWJsZTxUPihuZXcgU2NoZW1hKFtdKSwgW10pOyB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oKTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogUmVjb3JkQmF0Y2hSZWFkZXI8VD4pOiBUYWJsZTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmcwKTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMik6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzEpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmczKTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnNCk6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzUpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBQcm9taXNlTGlrZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj4pOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlPzogYW55KSB7XG5cbiAgICAgICAgaWYgKCFzb3VyY2UpIHsgcmV0dXJuIFRhYmxlLmVtcHR5PFQ+KCk7IH1cblxuICAgICAgICBsZXQgcmVhZGVyID0gUmVjb3JkQmF0Y2hSZWFkZXIuZnJvbTxUPihzb3VyY2UpIGFzIFJlY29yZEJhdGNoUmVhZGVyPFQ+IHwgUHJvbWlzZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj47XG5cbiAgICAgICAgaWYgKGlzUHJvbWlzZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj4ocmVhZGVyKSkge1xuICAgICAgICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiBhd2FpdCBUYWJsZS5mcm9tKGF3YWl0IHJlYWRlcikpKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlYWRlci5pc1N5bmMoKSAmJiAocmVhZGVyID0gcmVhZGVyLm9wZW4oKSkpIHtcbiAgICAgICAgICAgIHJldHVybiAhcmVhZGVyLnNjaGVtYSA/IFRhYmxlLmVtcHR5PFQ+KCkgOiBuZXcgVGFibGU8VD4ocmVhZGVyLnNjaGVtYSwgWy4uLnJlYWRlcl0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoYXN5bmMgKG9wZW5pbmcpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IGF3YWl0IG9wZW5pbmc7XG4gICAgICAgICAgICBjb25zdCBzY2hlbWEgPSByZWFkZXIuc2NoZW1hO1xuICAgICAgICAgICAgY29uc3QgYmF0Y2hlczogUmVjb3JkQmF0Y2hbXSA9IFtdO1xuICAgICAgICAgICAgaWYgKHNjaGVtYSkge1xuICAgICAgICAgICAgICAgIGZvciBhd2FpdCAobGV0IGJhdGNoIG9mIHJlYWRlcikge1xuICAgICAgICAgICAgICAgICAgICBiYXRjaGVzLnB1c2goYmF0Y2gpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRhYmxlPFQ+KHNjaGVtYSwgYmF0Y2hlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gVGFibGUuZW1wdHk8VD4oKTtcbiAgICAgICAgfSkocmVhZGVyLm9wZW4oKSk7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBmcm9tQXN5bmM8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJncyk6IFByb21pc2U8VGFibGU8VD4+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IFRhYmxlLmZyb208VD4oc291cmNlIGFzIGFueSk7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tVmVjdG9yczxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4odmVjdG9yczogVmVjdG9yPFRba2V5b2YgVF0+W10sIGZpZWxkcz86IChrZXlvZiBUIHwgRmllbGQ8VFtrZXlvZiBUXT4pW10pIHtcbiAgICAgICAgcmV0dXJuIFRhYmxlLm5ldzxUPih2ZWN0b3JzLCBmaWVsZHMpO1xuICAgIH1cblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbVN0cnVjdDxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oc3RydWN0OiBWZWN0b3I8U3RydWN0PFQ+Pikge1xuICAgICAgICByZXR1cm4gVGFibGUubmV3PFQ+KHN0cnVjdC5kYXRhLmNoaWxkRGF0YSBhcyBEYXRhPFRba2V5b2YgVF0+W10sIHN0cnVjdC50eXBlLmNoaWxkcmVuKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oY2h1bmtzOiAoRGF0YTxUW2tleW9mIFRdPiB8IFZlY3RvcjxUW2tleW9mIFRdPilbXSwgZmllbGRzPzogKGtleW9mIFQgfCBGaWVsZDxUW2tleW9mIFRdPilbXSk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PiguLi5jb2x1bW5zOiAoQ29sdW1uPFRba2V5b2YgVF0+IHwgQ29sdW1uPFRba2V5b2YgVF0+W10pW10pOiBUYWJsZTxUPjtcbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oLi4uYXJnczogYW55W10pOiBUYWJsZTxUPiB7XG4gICAgICAgIGxldCB4ID0gYXJnc1swXSwgY29sdW1uczogQ29sdW1uPFRba2V5b2YgVF0+W107XG4gICAgICAgIGlmICh4IGluc3RhbmNlb2YgQ29sdW1uIHx8IChBcnJheS5pc0FycmF5KHgpICYmICh4WzBdIGluc3RhbmNlb2YgQ29sdW1uKSkpIHtcbiAgICAgICAgICAgIGNvbHVtbnMgPSBhcmdzLnJlZHVjZShmdW5jdGlvbiBmbGF0dGVuKHhzOiBhbnlbXSwgeDogYW55KTogYW55W10ge1xuICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHgpID8geC5yZWR1Y2UoZmxhdHRlbiwgeHMpIDogWy4uLnhzLCB4XTtcbiAgICAgICAgICAgIH0sIFtdKS5maWx0ZXIoKHg6IGFueSk6IHggaXMgQ29sdW1uPFRba2V5b2YgVF0+ID0+IHggaW5zdGFuY2VvZiBDb2x1bW4pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgW2NodW5rcywgZmllbGRzID0gW11dID0gYXJncyBhcyBbXG4gICAgICAgICAgICAgICAgKERhdGE8VFtrZXlvZiBUXT4gfCBWZWN0b3I8VFtrZXlvZiBUXT4pW10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAoc3RyaW5nIHwgRmllbGQ8VFtrZXlvZiBUXT4pW11dO1xuICAgICAgICAgICAgY29sdW1ucyA9IGNodW5rcy5tYXAoKGNodW5rLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgeyBbaV06IG5hbWUgPSBgJHtpfWB9ID0gZmllbGRzO1xuICAgICAgICAgICAgICAgIGNvbnN0IHYgPSBjaHVuayBpbnN0YW5jZW9mIERhdGEgPyBWZWN0b3IubmV3KGNodW5rKSA6IGNodW5rO1xuICAgICAgICAgICAgICAgIGNvbnN0IGYgPSBuYW1lIGluc3RhbmNlb2YgRmllbGQgPyBuYW1lIGFzIEZpZWxkPFRba2V5b2YgVF0+IDogbmV3IEZpZWxkKG5hbWUsIGNodW5rLnR5cGUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBDb2x1bW4ubmV3KGYsIFt2XSkgYXMgQ29sdW1uPFRba2V5b2YgVF0+O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZSguLi5kaXN0cmlidXRlQ29sdW1uc0ludG9SZWNvcmRCYXRjaGVzKGNvbHVtbnMpKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihiYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvciguLi5iYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvcihzY2hlbWE6IFNjaGVtYSwgYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3Ioc2NoZW1hOiBTY2hlbWEsIC4uLmJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKC4uLmFyZ3M6IGFueVtdKSB7XG5cbiAgICAgICAgbGV0IHNjaGVtYTogU2NoZW1hID0gbnVsbCE7XG5cbiAgICAgICAgaWYgKGFyZ3NbMF0gaW5zdGFuY2VvZiBTY2hlbWEpIHsgc2NoZW1hID0gYXJncy5zaGlmdCgpOyB9XG5cbiAgICAgICAgbGV0IGNodW5rcyA9IGFyZ3MucmVkdWNlKGZ1bmN0aW9uIGZsYXR0ZW4oeHM6IGFueVtdLCB4OiBhbnkpOiBhbnlbXSB7XG4gICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh4KSA/IHgucmVkdWNlKGZsYXR0ZW4sIHhzKSA6IFsuLi54cywgeF07XG4gICAgICAgIH0sIFtdKS5maWx0ZXIoKHg6IGFueSk6IHggaXMgUmVjb3JkQmF0Y2g8VD4gPT4geCBpbnN0YW5jZW9mIFJlY29yZEJhdGNoKTtcblxuICAgICAgICBpZiAoIXNjaGVtYSAmJiAhKHNjaGVtYSA9IGNodW5rc1swXSAmJiBjaHVua3NbMF0uc2NoZW1hKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGFibGUgbXVzdCBiZSBpbml0aWFsaXplZCB3aXRoIGEgU2NoZW1hIG9yIGF0IGxlYXN0IG9uZSBSZWNvcmRCYXRjaCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjaHVua3NbMF0pIHsgY2h1bmtzWzBdID0gbmV3IFJlY29yZEJhdGNoKHNjaGVtYSwgMCwgW10pOyB9XG5cbiAgICAgICAgc3VwZXIoY2h1bmtzWzBdLnR5cGUsIGNodW5rcyk7XG5cbiAgICAgICAgdGhpcy5fc2NoZW1hID0gc2NoZW1hO1xuICAgICAgICB0aGlzLl9jaHVua3MgPSBjaHVua3M7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9zY2hlbWE6IFNjaGVtYTxUPjtcbiAgICAvLyBMaXN0IG9mIGlubmVyIFJlY29yZEJhdGNoZXNcbiAgICBwcm90ZWN0ZWQgX2NodW5rczogUmVjb3JkQmF0Y2g8VD5bXTtcbiAgICBwcm90ZWN0ZWQgX2NoaWxkcmVuPzogQ29sdW1uPFRba2V5b2YgVF0+W107XG5cbiAgICBwdWJsaWMgZ2V0IHNjaGVtYSgpIHsgcmV0dXJuIHRoaXMuX3NjaGVtYTsgfVxuICAgIHB1YmxpYyBnZXQgbGVuZ3RoKCkgeyByZXR1cm4gdGhpcy5fbGVuZ3RoOyB9XG4gICAgcHVibGljIGdldCBjaHVua3MoKSB7IHJldHVybiB0aGlzLl9jaHVua3M7IH1cbiAgICBwdWJsaWMgZ2V0IG51bUNvbHMoKSB7IHJldHVybiB0aGlzLl9udW1DaGlsZHJlbjsgfVxuXG4gICAgcHVibGljIGNsb25lKGNodW5rcyA9IHRoaXMuX2NodW5rcykge1xuICAgICAgICByZXR1cm4gbmV3IFRhYmxlPFQ+KHRoaXMuX3NjaGVtYSwgY2h1bmtzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q29sdW1uQXQ8UiBleHRlbmRzIERhdGFUeXBlID0gYW55PihpbmRleDogbnVtYmVyKTogQ29sdW1uPFI+IHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENoaWxkQXQoaW5kZXgpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q29sdW1uPFIgZXh0ZW5kcyBrZXlvZiBUPihuYW1lOiBSKTogQ29sdW1uPFRbUl0+IHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENvbHVtbkF0KHRoaXMuZ2V0Q29sdW1uSW5kZXgobmFtZSkpIGFzIENvbHVtbjxUW1JdPiB8IG51bGw7XG4gICAgfVxuICAgIHB1YmxpYyBnZXRDb2x1bW5JbmRleDxSIGV4dGVuZHMga2V5b2YgVD4obmFtZTogUikge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2NoZW1hLmZpZWxkcy5maW5kSW5kZXgoKGYpID0+IGYubmFtZSA9PT0gbmFtZSk7XG4gICAgfVxuICAgIHB1YmxpYyBnZXRDaGlsZEF0PFIgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4oaW5kZXg6IG51bWJlcik6IENvbHVtbjxSPiB8IG51bGwge1xuICAgICAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMubnVtQ2hpbGRyZW4pIHsgcmV0dXJuIG51bGw7IH1cbiAgICAgICAgbGV0IGZpZWxkOiBGaWVsZDxSPiwgY2hpbGQ6IENvbHVtbjxSPjtcbiAgICAgICAgY29uc3QgZmllbGRzID0gKHRoaXMuX3NjaGVtYSBhcyBTY2hlbWE8YW55PikuZmllbGRzO1xuICAgICAgICBjb25zdCBjb2x1bW5zID0gdGhpcy5fY2hpbGRyZW4gfHwgKHRoaXMuX2NoaWxkcmVuID0gW10pIGFzIENvbHVtbltdO1xuICAgICAgICBpZiAoY2hpbGQgPSBjb2x1bW5zW2luZGV4XSkgeyByZXR1cm4gY2hpbGQgYXMgQ29sdW1uPFI+OyB9XG4gICAgICAgIGlmIChmaWVsZCA9IGZpZWxkc1tpbmRleF0pIHtcbiAgICAgICAgICAgIGNvbnN0IGNodW5rcyA9IHRoaXMuX2NodW5rc1xuICAgICAgICAgICAgICAgIC5tYXAoKGNodW5rKSA9PiBjaHVuay5nZXRDaGlsZEF0PFI+KGluZGV4KSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKCh2ZWMpOiB2ZWMgaXMgVmVjdG9yPFI+ID0+IHZlYyAhPSBudWxsKTtcbiAgICAgICAgICAgIGlmIChjaHVua3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAoY29sdW1uc1tpbmRleF0gPSBuZXcgQ29sdW1uPFI+KGZpZWxkLCBjaHVua3MpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHVibGljIHNlcmlhbGl6ZShlbmNvZGluZyA9ICdiaW5hcnknLCBzdHJlYW0gPSB0cnVlKSB7XG4gICAgICAgIGNvbnN0IHdyaXRlciA9ICFzdHJlYW1cbiAgICAgICAgICAgID8gUmVjb3JkQmF0Y2hGaWxlV3JpdGVyXG4gICAgICAgICAgICA6IFJlY29yZEJhdGNoU3RyZWFtV3JpdGVyO1xuICAgICAgICByZXR1cm4gd3JpdGVyLndyaXRlQWxsKHRoaXMuX2NodW5rcykudG9VaW50OEFycmF5KHRydWUpO1xuICAgIH1cbiAgICBwdWJsaWMgY291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xlbmd0aDtcbiAgICB9XG4gICAgcHVibGljIHNlbGVjdDxLIGV4dGVuZHMga2V5b2YgVCA9IGFueT4oLi4uY29sdW1uTmFtZXM6IEtbXSkge1xuICAgICAgICBjb25zdCBuYW1lVG9JbmRleCA9IHRoaXMuX3NjaGVtYS5maWVsZHMucmVkdWNlKChtLCBmLCBpKSA9PiBtLnNldChmLm5hbWUgYXMgSywgaSksIG5ldyBNYXA8SywgbnVtYmVyPigpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0QXQoLi4uY29sdW1uTmFtZXMubWFwKChjb2x1bW5OYW1lKSA9PiBuYW1lVG9JbmRleC5nZXQoY29sdW1uTmFtZSkhKSk7XG4gICAgfVxuICAgIHB1YmxpYyBzZWxlY3RBdDxLIGV4dGVuZHMgVFtrZXlvZiBUXSA9IGFueT4oLi4uY29sdW1uSW5kaWNlczogbnVtYmVyW10pIHtcbiAgICAgICAgY29uc3Qgc2NoZW1hID0gdGhpcy5fc2NoZW1hLnNlbGVjdEF0PEs+KC4uLmNvbHVtbkluZGljZXMpO1xuICAgICAgICByZXR1cm4gbmV3IFRhYmxlKHNjaGVtYSwgdGhpcy5fY2h1bmtzLm1hcCgoeyBsZW5ndGgsIGRhdGE6IHsgY2hpbGREYXRhIH0gfSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWNvcmRCYXRjaChzY2hlbWEsIGxlbmd0aCwgY29sdW1uSW5kaWNlcy5tYXAoKGkpID0+IGNoaWxkRGF0YVtpXSkpO1xuICAgICAgICB9KSk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3NpZ248UiBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4ob3RoZXI6IFRhYmxlPFI+KSB7XG5cbiAgICAgICAgY29uc3QgZmllbGRzID0gdGhpcy5fc2NoZW1hLmZpZWxkcztcbiAgICAgICAgY29uc3QgW2luZGljZXMsIG9sZFRvTmV3XSA9IG90aGVyLnNjaGVtYS5maWVsZHMucmVkdWNlKChtZW1vLCBmMiwgbmV3SWR4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBbaW5kaWNlcywgb2xkVG9OZXddID0gbWVtbztcbiAgICAgICAgICAgIGNvbnN0IGkgPSBmaWVsZHMuZmluZEluZGV4KChmKSA9PiBmLmNvbXBhcmVUbyhmMikpO1xuICAgICAgICAgICAgfmkgPyAob2xkVG9OZXdbaV0gPSBuZXdJZHgpIDogaW5kaWNlcy5wdXNoKG5ld0lkeCk7XG4gICAgICAgICAgICByZXR1cm4gbWVtbztcbiAgICAgICAgfSwgW1tdLCBbXV0gYXMgbnVtYmVyW11bXSk7XG5cbiAgICAgICAgY29uc3Qgc2NoZW1hID0gdGhpcy5fc2NoZW1hLmFzc2lnbihvdGhlci5zY2hlbWEpO1xuICAgICAgICBjb25zdCBjb2x1bW5zID0gW1xuICAgICAgICAgICAgLi4uZmllbGRzLm1hcCgoX2YsIGksIF9mcywgaiA9IG9sZFRvTmV3W2ldKSA9PlxuICAgICAgICAgICAgICAgIChqID09PSB1bmRlZmluZWQgPyB0aGlzLmdldENvbHVtbkF0KGkpIDogb3RoZXIuZ2V0Q29sdW1uQXQoaikpISksXG4gICAgICAgICAgICAuLi5pbmRpY2VzLm1hcCgoaSkgPT4gb3RoZXIuZ2V0Q29sdW1uQXQoaSkhKVxuICAgICAgICBdLmZpbHRlcihCb29sZWFuKSBhcyBDb2x1bW48KFQgJiBSKVtrZXlvZiBUIHwga2V5b2YgUl0+W107XG5cbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZSguLi5kaXN0cmlidXRlVmVjdG9yc0ludG9SZWNvcmRCYXRjaGVzPFQgJiBSPihzY2hlbWEsIGNvbHVtbnMpKTtcbiAgICB9XG59XG4iXX0=
