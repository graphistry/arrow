"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const column_1 = require("./column");
const schema_1 = require("./schema");
const compat_1 = require("./util/compat");
const recordbatch_1 = require("./recordbatch");
const reader_1 = require("./ipc/reader");
const index_1 = require("./vector/index");
const writer_1 = require("./ipc/writer");
class Table {
    constructor(...args) {
        // List of inner Vectors, possibly spanning batches
        this._columns = [];
        let schema = null;
        if (args[0] instanceof schema_1.Schema) {
            schema = args.shift();
        }
        let batches = args.reduce(function flatten(xs, x) {
            return Array.isArray(x) ? x.reduce(flatten, xs) : [...xs, x];
        }, []).filter((x) => x instanceof recordbatch_1.RecordBatch);
        if (!schema && !(schema = batches[0] && batches[0].schema)) {
            throw new TypeError('Table must be initialized with a Schema or at least one RecordBatch with a Schema');
        }
        this._schema = schema;
        this._batches = batches;
        this._batchesUnion = batches.length == 0
            ? new recordbatch_1.RecordBatch(schema, 0, [])
            : batches.length === 1 ? batches[0]
                : index_1.ChunkedVector.concat(...batches);
        this._length = this.batchesUnion.length;
        this._numCols = this.schema.fields.length;
    }
    /** @nocollapse */
    static empty() { return new Table(new schema_1.Schema([]), []); }
    /** @nocollapse */
    static from(source) {
        if (!source) {
            return Table.empty();
        }
        let reader = reader_1.RecordBatchReader.from(source);
        if (compat_1.isPromise(reader)) {
            return (() => tslib_1.__awaiter(this, void 0, void 0, function* () { return yield Table.from(yield reader); }))();
        }
        if (reader.isSync() && (reader = reader.open())) {
            return !reader.schema ? Table.empty() : new Table(reader.schema, [...reader]);
        }
        return ((opening) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            var e_1, _a;
            const reader = yield opening;
            const schema = reader.schema;
            const batches = [];
            if (schema) {
                try {
                    for (var reader_2 = tslib_1.__asyncValues(reader), reader_2_1; reader_2_1 = yield reader_2.next(), !reader_2_1.done;) {
                        let batch = reader_2_1.value;
                        batches.push(batch);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (reader_2_1 && !reader_2_1.done && (_a = reader_2.return)) yield _a.call(reader_2);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                return new Table(schema, batches);
            }
            return Table.empty();
        }))(reader.open());
    }
    /** @nocollapse */
    static fromAsync(source) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield Table.from(source);
        });
    }
    /** @nocollapse */
    static fromVectors(vectors, names) {
        return new Table(recordbatch_1.RecordBatch.from(vectors, names));
    }
    /** @nocollapse */
    static fromStruct(struct) {
        const schema = new schema_1.Schema(struct.type.children);
        const chunks = (struct instanceof index_1.ChunkedVector ? struct.chunks : [struct]);
        return new Table(schema, chunks.map((chunk) => new recordbatch_1.RecordBatch(schema, chunk.data)));
    }
    get schema() { return this._schema; }
    get length() { return this._length; }
    get numCols() { return this._numCols; }
    get batches() { return this._batches; }
    get batchesUnion() { return this._batchesUnion; }
    get(index) {
        return this.batchesUnion.get(index);
    }
    getColumn(name) {
        return this.getColumnAt(this.getColumnIndex(name));
    }
    getColumnAt(index) {
        if (index < 0 || index >= this.numCols) {
            return null;
        }
        if (this.batches.length === 1) {
            return this.batches[0].getChildAt(index);
        }
        return new column_1.Column(this.schema.fields[index], this.batches.map((b) => b.getChildAt(index)));
    }
    getColumnIndex(name) {
        return this.schema.fields.findIndex((f) => f.name === name);
    }
    [Symbol.iterator]() {
        return this.batchesUnion[Symbol.iterator]();
    }
    // @ts-ignore
    serialize(encoding = 'binary', stream = true) {
        const writer = !stream
            ? writer_1.RecordBatchFileWriter
            : writer_1.RecordBatchStreamWriter;
        return writer.writeAll(this.batches).toUint8Array(true);
    }
    count() {
        return this.length;
    }
    select(...columnNames) {
        return new Table(this.batches.map((batch) => batch.select(...columnNames)));
    }
}
exports.Table = Table;
// protect batches, batchesUnion from es2015/umd mangler
// (<any> Table.prototype)._batches = Object.freeze([]);
// (<any> Table.prototype)._batchesUnion = Object.freeze([]);

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQztRQUM5QixPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBQ00sS0FBSztRQUNSLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBQ00sTUFBTSxDQUFDLEdBQUcsV0FBcUI7UUFDbEMsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRixDQUFDO0NBQ0o7QUFoSkQsc0JBZ0pDO0FBRUQsd0RBQXdEO0FBQ3hELHdEQUF3RDtBQUN4RCw2REFBNkQiLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgQ29sdW1uIH0gZnJvbSAnLi9jb2x1bW4nO1xuaW1wb3J0IHsgU2NoZW1hLCBGaWVsZCB9IGZyb20gJy4vc2NoZW1hJztcbmltcG9ydCB7IGlzUHJvbWlzZSB9IGZyb20gJy4vdXRpbC9jb21wYXQnO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2ggfSBmcm9tICcuL3JlY29yZGJhdGNoJztcbmltcG9ydCB7IFZlY3RvciBhcyBWVHlwZSB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaFJlYWRlciB9IGZyb20gJy4vaXBjL3JlYWRlcic7XG5pbXBvcnQgeyBEYXRhVHlwZSwgUm93TGlrZSwgU3RydWN0IH0gZnJvbSAnLi90eXBlJztcbmltcG9ydCB7IFZlY3RvciwgQ2h1bmtlZFZlY3RvciB9IGZyb20gJy4vdmVjdG9yL2luZGV4JztcbmltcG9ydCB7IFJlY29yZEJhdGNoRmlsZVdyaXRlciwgUmVjb3JkQmF0Y2hTdHJlYW1Xcml0ZXIgfSBmcm9tICcuL2lwYy93cml0ZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIERhdGFGcmFtZTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4ge1xuICAgIGNvdW50KCk6IG51bWJlcjtcbiAgICBmaWx0ZXIocHJlZGljYXRlOiBpbXBvcnQoJy4vY29tcHV0ZS9wcmVkaWNhdGUnKS5QcmVkaWNhdGUpOiBEYXRhRnJhbWU8VD47XG4gICAgY291bnRCeShuYW1lOiBpbXBvcnQoJy4vY29tcHV0ZS9wcmVkaWNhdGUnKS5Db2wgfCBzdHJpbmcpOiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5Db3VudEJ5UmVzdWx0O1xuICAgIHNjYW4obmV4dDogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuTmV4dEZ1bmMsIGJpbmQ/OiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5CaW5kRnVuYyk6IHZvaWQ7XG4gICAgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxSb3dMaWtlPFQ+Pjtcbn1cblxuZXhwb3J0IGNsYXNzIFRhYmxlPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PiBpbXBsZW1lbnRzIERhdGFGcmFtZTxUPiB7XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGVtcHR5PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PigpIHsgcmV0dXJuIG5ldyBUYWJsZTxUPihuZXcgU2NoZW1hKFtdKSwgW10pOyB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oKTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogUmVjb3JkQmF0Y2hSZWFkZXI8VD4pOiBUYWJsZTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmcwKTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMSk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzIpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmczKTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnNCk6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IFByb21pc2VMaWtlPFJlY29yZEJhdGNoUmVhZGVyPFQ+Pik6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U/OiBhbnkpIHtcblxuICAgICAgICBpZiAoIXNvdXJjZSkgeyByZXR1cm4gVGFibGUuZW1wdHk8VD4oKTsgfVxuXG4gICAgICAgIGxldCByZWFkZXIgPSBSZWNvcmRCYXRjaFJlYWRlci5mcm9tPFQ+KHNvdXJjZSkgYXMgUmVjb3JkQmF0Y2hSZWFkZXI8VD4gfCBQcm9taXNlPFJlY29yZEJhdGNoUmVhZGVyPFQ+PjtcblxuICAgICAgICBpZiAoaXNQcm9taXNlPFJlY29yZEJhdGNoUmVhZGVyPFQ+PihyZWFkZXIpKSB7XG4gICAgICAgICAgICByZXR1cm4gKGFzeW5jICgpID0+IGF3YWl0IFRhYmxlLmZyb20oYXdhaXQgcmVhZGVyKSkoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVhZGVyLmlzU3luYygpICYmIChyZWFkZXIgPSByZWFkZXIub3BlbigpKSkge1xuICAgICAgICAgICAgcmV0dXJuICFyZWFkZXIuc2NoZW1hID8gVGFibGUuZW1wdHk8VD4oKSA6IG5ldyBUYWJsZTxUPihyZWFkZXIuc2NoZW1hLCBbLi4ucmVhZGVyXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIChhc3luYyAob3BlbmluZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVhZGVyID0gYXdhaXQgb3BlbmluZztcbiAgICAgICAgICAgIGNvbnN0IHNjaGVtYSA9IHJlYWRlci5zY2hlbWE7XG4gICAgICAgICAgICBjb25zdCBiYXRjaGVzOiBSZWNvcmRCYXRjaFtdID0gW107XG4gICAgICAgICAgICBpZiAoc2NoZW1hKSB7XG4gICAgICAgICAgICAgICAgZm9yIGF3YWl0IChsZXQgYmF0Y2ggb2YgcmVhZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGJhdGNoZXMucHVzaChiYXRjaCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFibGU8VD4oc2NoZW1hLCBiYXRjaGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBUYWJsZS5lbXB0eTxUPigpO1xuICAgICAgICB9KShyZWFkZXIub3BlbigpKTtcbiAgICB9XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGZyb21Bc3luYzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmdzKTogUHJvbWlzZTxUYWJsZTxUPj4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgVGFibGUuZnJvbTxUPihzb3VyY2UgYXMgYW55KTtcbiAgICB9XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGZyb21WZWN0b3JzPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55Pih2ZWN0b3JzOiBWVHlwZTxUW2tleW9mIFRdPltdLCBuYW1lcz86IChrZXlvZiBUKVtdKSB7XG4gICAgICAgIHJldHVybiBuZXcgVGFibGUoUmVjb3JkQmF0Y2guZnJvbSh2ZWN0b3JzLCBuYW1lcykpO1xuICAgIH1cblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbVN0cnVjdDxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oc3RydWN0OiBWZWN0b3I8U3RydWN0PFQ+Pikge1xuICAgICAgICBjb25zdCBzY2hlbWEgPSBuZXcgU2NoZW1hPFQ+KHN0cnVjdC50eXBlLmNoaWxkcmVuKTtcbiAgICAgICAgY29uc3QgY2h1bmtzID0gKHN0cnVjdCBpbnN0YW5jZW9mIENodW5rZWRWZWN0b3IgPyBzdHJ1Y3QuY2h1bmtzIDogW3N0cnVjdF0pIGFzIFZUeXBlPFN0cnVjdDxUPj5bXTtcbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZShzY2hlbWEsIGNodW5rcy5tYXAoKGNodW5rKSA9PiBuZXcgUmVjb3JkQmF0Y2goc2NoZW1hLCBjaHVuay5kYXRhKSkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfc2NoZW1hOiBTY2hlbWE7XG4gICAgcHJvdGVjdGVkIF9sZW5ndGg6IG51bWJlcjtcbiAgICBwcm90ZWN0ZWQgX251bUNvbHM6IG51bWJlcjtcbiAgICAvLyBMaXN0IG9mIGlubmVyIFJlY29yZEJhdGNoZXNcbiAgICBwcm90ZWN0ZWQgX2JhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W107XG4gICAgLy8gTGlzdCBvZiBpbm5lciBWZWN0b3JzLCBwb3NzaWJseSBzcGFubmluZyBiYXRjaGVzXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IF9jb2x1bW5zOiBWZWN0b3I8YW55PltdID0gW107XG4gICAgLy8gVW5pb24gb2YgYWxsIGlubmVyIFJlY29yZEJhdGNoZXMgaW50byBvbmUgUmVjb3JkQmF0Y2gsIHBvc3NpYmx5IGNodW5rZWQuXG4gICAgLy8gSWYgdGhlIFRhYmxlIGhhcyBqdXN0IG9uZSBpbm5lciBSZWNvcmRCYXRjaCwgdGhpcyBwb2ludHMgdG8gdGhhdC5cbiAgICAvLyBJZiB0aGUgVGFibGUgaGFzIG11bHRpcGxlIGlubmVyIFJlY29yZEJhdGNoZXMsIHRoZW4gdGhpcyBpcyBhIENodW5rZWQgdmlld1xuICAgIC8vIG92ZXIgdGhlIGxpc3Qgb2YgUmVjb3JkQmF0Y2hlcy4gVGhpcyBhbGxvd3MgdXMgdG8gZGVsZWdhdGUgdGhlIHJlc3BvbnNpYmlsaXR5XG4gICAgLy8gb2YgaW5kZXhpbmcsIGl0ZXJhdGluZywgc2xpY2luZywgYW5kIHZpc2l0aW5nIHRvIHRoZSBOZXN0ZWQvQ2h1bmtlZCBEYXRhL1ZpZXdzLlxuICAgIHByb3RlY3RlZCBfYmF0Y2hlc1VuaW9uOiBWZWN0b3I8U3RydWN0PFQ+PjtcblxuICAgIGNvbnN0cnVjdG9yKGJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKC4uLmJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKHNjaGVtYTogU2NoZW1hLCBiYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvcihzY2hlbWE6IFNjaGVtYSwgLi4uYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3IoLi4uYXJnczogYW55W10pIHtcblxuICAgICAgICBsZXQgc2NoZW1hOiBTY2hlbWEgPSBudWxsITtcblxuICAgICAgICBpZiAoYXJnc1swXSBpbnN0YW5jZW9mIFNjaGVtYSkge1xuICAgICAgICAgICAgc2NoZW1hID0gYXJncy5zaGlmdCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJhdGNoZXMgPSBhcmdzLnJlZHVjZShmdW5jdGlvbiBmbGF0dGVuKHhzOiBhbnlbXSwgeDogYW55KTogYW55W10ge1xuICAgICAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoeCkgPyB4LnJlZHVjZShmbGF0dGVuLCB4cykgOiBbLi4ueHMsIHhdO1xuICAgICAgICB9LCBbXSkuZmlsdGVyKCh4OiBhbnkpOiB4IGlzIFJlY29yZEJhdGNoPFQ+ID0+IHggaW5zdGFuY2VvZiBSZWNvcmRCYXRjaCk7XG5cbiAgICAgICAgaWYgKCFzY2hlbWEgJiYgIShzY2hlbWEgPSBiYXRjaGVzWzBdICYmIGJhdGNoZXNbMF0uc2NoZW1hKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGFibGUgbXVzdCBiZSBpbml0aWFsaXplZCB3aXRoIGEgU2NoZW1hIG9yIGF0IGxlYXN0IG9uZSBSZWNvcmRCYXRjaCB3aXRoIGEgU2NoZW1hJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9zY2hlbWEgPSBzY2hlbWE7XG4gICAgICAgIHRoaXMuX2JhdGNoZXMgPSBiYXRjaGVzO1xuICAgICAgICB0aGlzLl9iYXRjaGVzVW5pb24gPSBiYXRjaGVzLmxlbmd0aCA9PSAwXG4gICAgICAgICAgICA/IG5ldyBSZWNvcmRCYXRjaDxUPihzY2hlbWEsIDAsIFtdKVxuICAgICAgICAgICAgOiBiYXRjaGVzLmxlbmd0aCA9PT0gMSA/IGJhdGNoZXNbMF1cbiAgICAgICAgICAgIDogQ2h1bmtlZFZlY3Rvci5jb25jYXQ8U3RydWN0PFQ+PiguLi5iYXRjaGVzKSBhcyBWZWN0b3I8U3RydWN0PFQ+PjtcblxuICAgICAgICB0aGlzLl9sZW5ndGggPSB0aGlzLmJhdGNoZXNVbmlvbi5sZW5ndGg7XG4gICAgICAgIHRoaXMuX251bUNvbHMgPSB0aGlzLnNjaGVtYS5maWVsZHMubGVuZ3RoO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc2NoZW1hKCkgeyByZXR1cm4gdGhpcy5fc2NoZW1hOyB9XG4gICAgcHVibGljIGdldCBsZW5ndGgoKSB7IHJldHVybiB0aGlzLl9sZW5ndGg7IH1cbiAgICBwdWJsaWMgZ2V0IG51bUNvbHMoKSB7IHJldHVybiB0aGlzLl9udW1Db2xzOyB9XG4gICAgcHVibGljIGdldCBiYXRjaGVzKCkgeyByZXR1cm4gdGhpcy5fYmF0Y2hlczsgfVxuICAgIHB1YmxpYyBnZXQgYmF0Y2hlc1VuaW9uKCkgeyByZXR1cm4gdGhpcy5fYmF0Y2hlc1VuaW9uOyB9XG5cbiAgICBwdWJsaWMgZ2V0KGluZGV4OiBudW1iZXIpOiBTdHJ1Y3Q8VD5bJ1RWYWx1ZSddIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYmF0Y2hlc1VuaW9uLmdldChpbmRleCkhO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q29sdW1uPFIgZXh0ZW5kcyBrZXlvZiBUPihuYW1lOiBSKTogVmVjdG9yPFRbUl0+IHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENvbHVtbkF0KHRoaXMuZ2V0Q29sdW1uSW5kZXgobmFtZSkpIGFzIFZlY3RvcjxUW1JdPiB8IG51bGw7XG4gICAgfVxuICAgIHB1YmxpYyBnZXRDb2x1bW5BdDxUIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+KGluZGV4OiBudW1iZXIpOiBWZWN0b3I8VD4gfCBudWxsIHtcbiAgICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLm51bUNvbHMpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmJhdGNoZXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5iYXRjaGVzWzBdLmdldENoaWxkQXQ8VD4oaW5kZXgpIGFzIFZlY3RvcjxUPiB8IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBDb2x1bW48VD4oXG4gICAgICAgICAgICB0aGlzLnNjaGVtYS5maWVsZHNbaW5kZXhdIGFzIEZpZWxkPFQ+LFxuICAgICAgICAgICAgdGhpcy5iYXRjaGVzLm1hcCgoYikgPT4gYi5nZXRDaGlsZEF0PFQ+KGluZGV4KSEgYXMgVmVjdG9yPFQ+KSk7XG4gICAgfVxuICAgIHB1YmxpYyBnZXRDb2x1bW5JbmRleDxSIGV4dGVuZHMga2V5b2YgVD4obmFtZTogUikge1xuICAgICAgICByZXR1cm4gdGhpcy5zY2hlbWEuZmllbGRzLmZpbmRJbmRleCgoZikgPT4gZi5uYW1lID09PSBuYW1lKTtcbiAgICB9XG4gICAgcHVibGljIFtTeW1ib2wuaXRlcmF0b3JdKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5iYXRjaGVzVW5pb25bU3ltYm9sLml0ZXJhdG9yXSgpIGFzIEl0ZXJhYmxlSXRlcmF0b3I8Um93TGlrZTxUPj47XG4gICAgfVxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwdWJsaWMgc2VyaWFsaXplKGVuY29kaW5nID0gJ2JpbmFyeScsIHN0cmVhbSA9IHRydWUpIHtcbiAgICAgICAgY29uc3Qgd3JpdGVyID0gIXN0cmVhbVxuICAgICAgICAgICAgPyBSZWNvcmRCYXRjaEZpbGVXcml0ZXJcbiAgICAgICAgICAgIDogUmVjb3JkQmF0Y2hTdHJlYW1Xcml0ZXI7XG4gICAgICAgIHJldHVybiB3cml0ZXIud3JpdGVBbGwodGhpcy5iYXRjaGVzKS50b1VpbnQ4QXJyYXkodHJ1ZSk7XG4gICAgfVxuICAgIHB1YmxpYyBjb3VudCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5sZW5ndGg7XG4gICAgfVxuICAgIHB1YmxpYyBzZWxlY3QoLi4uY29sdW1uTmFtZXM6IHN0cmluZ1tdKSB7XG4gICAgICAgIHJldHVybiBuZXcgVGFibGUodGhpcy5iYXRjaGVzLm1hcCgoYmF0Y2gpID0+IGJhdGNoLnNlbGVjdCguLi5jb2x1bW5OYW1lcykpKTtcbiAgICB9XG59XG5cbi8vIHByb3RlY3QgYmF0Y2hlcywgYmF0Y2hlc1VuaW9uIGZyb20gZXMyMDE1L3VtZCBtYW5nbGVyXG4vLyAoPGFueT4gVGFibGUucHJvdG90eXBlKS5fYmF0Y2hlcyA9IE9iamVjdC5mcmVlemUoW10pO1xuLy8gKDxhbnk+IFRhYmxlLnByb3RvdHlwZSkuX2JhdGNoZXNVbmlvbiA9IE9iamVjdC5mcmVlemUoW10pO1xuIl19
