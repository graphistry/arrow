"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const column_1 = require("./column");
const schema_1 = require("./schema");
const compat_1 = require("./util/compat");
const recordbatch_1 = require("./recordbatch");
const reader_1 = require("./ipc/reader");
const index_1 = require("./vector/index");
const writer_1 = require("./ipc/writer");
class Table extends index_1.Chunked {
    constructor(...args) {
        let schema = null;
        if (args[0] instanceof schema_1.Schema) {
            schema = args.shift();
        }
        let chunks = args.reduce(function flatten(xs, x) {
            return Array.isArray(x) ? x.reduce(flatten, xs) : [...xs, x];
        }, []).filter((x) => x instanceof recordbatch_1.RecordBatch);
        if (!schema && !(schema = chunks[0] && chunks[0].schema)) {
            throw new TypeError('Table must be initialized with a Schema or at least one RecordBatch');
        }
        if (!chunks[0]) {
            chunks[0] = new recordbatch_1.RecordBatch(schema, 0, []);
        }
        super(chunks[0].type, chunks);
        this._schema = schema;
        this._chunks = chunks;
    }
    /** @nocollapse */
    static empty() { return new Table(new schema_1.Schema([]), []); }
    /** @nocollapse */
    static from(source) {
        if (!source) {
            return Table.empty();
        }
        let reader = reader_1.RecordBatchReader.from(source);
        if (compat_1.isPromise(reader)) {
            return (async () => await Table.from(await reader))();
        }
        if (reader.isSync() && (reader = reader.open())) {
            return !reader.schema ? Table.empty() : new Table(reader.schema, [...reader]);
        }
        return (async (opening) => {
            const reader = await opening;
            const schema = reader.schema;
            const batches = [];
            if (schema) {
                for await (let batch of reader) {
                    batches.push(batch);
                }
                return new Table(schema, batches);
            }
            return Table.empty();
        })(reader.open());
    }
    /** @nocollapse */
    static async fromAsync(source) {
        return await Table.from(source);
    }
    /** @nocollapse */
    static fromVectors(vectors, names) {
        return new Table(recordbatch_1.RecordBatch.from(vectors, names));
    }
    /** @nocollapse */
    static fromStruct(struct) {
        const schema = new schema_1.Schema(struct.type.children);
        const chunks = (struct instanceof index_1.Chunked ? struct.chunks : [struct]);
        return new Table(schema, chunks.map((chunk) => new recordbatch_1.RecordBatch(schema, chunk.data)));
    }
    get schema() { return this._schema; }
    get length() { return this._length; }
    get chunks() { return this._chunks; }
    get numCols() { return this._numChildren; }
    clone(chunks = this._chunks) {
        return new Table(this._schema, chunks);
    }
    getColumnAt(index) {
        return this.getChildAt(index);
    }
    getColumn(name) {
        return this.getColumnAt(this.getColumnIndex(name));
    }
    getColumnIndex(name) {
        return this._schema.fields.findIndex((f) => f.name === name);
    }
    getChildAt(index) {
        if (index < 0 || index >= this.numChildren) {
            return null;
        }
        let schema = this._schema;
        let column, field, chunks;
        let columns = this._children || (this._children = []);
        if (column = columns[index]) {
            return column;
        }
        if (field = (schema.fields || [])[index]) {
            chunks = this._chunks
                .map((chunk) => chunk.getChildAt(index))
                .filter((vec) => vec != null);
            if (chunks.length > 0) {
                return (columns[index] = new column_1.Column(field, chunks));
            }
        }
        return null;
    }
    // @ts-ignore
    serialize(encoding = 'binary', stream = true) {
        const writer = !stream
            ? writer_1.RecordBatchFileWriter
            : writer_1.RecordBatchStreamWriter;
        return writer.writeAll(this._chunks).toUint8Array(true);
    }
    count() {
        return this._length;
    }
    select(...columnNames) {
        return new Table(this._chunks.map((batch) => batch.select(...columnNames)));
    }
}
exports.Table = Table;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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bEIsQ0FBQyxDQUFDLDhCQUFxQjtZQUN2QixDQUFDLENBQUMsZ0NBQXVCLENBQUM7UUFDOUIsT0FBTyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUNNLEtBQUs7UUFDUixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDeEIsQ0FBQztJQUNNLE1BQU0sQ0FBQyxHQUFHLFdBQXFCO1FBQ2xDLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEYsQ0FBQztDQUNKO0FBOUlELHNCQThJQyIsImZpbGUiOiJ0YWJsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBDb2x1bW4gfSBmcm9tICcuL2NvbHVtbic7XG5pbXBvcnQgeyBTY2hlbWEsIEZpZWxkIH0gZnJvbSAnLi9zY2hlbWEnO1xuaW1wb3J0IHsgaXNQcm9taXNlIH0gZnJvbSAnLi91dGlsL2NvbXBhdCc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaCB9IGZyb20gJy4vcmVjb3JkYmF0Y2gnO1xuaW1wb3J0IHsgVmVjdG9yIGFzIFZUeXBlIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IERhdGFGcmFtZSB9IGZyb20gJy4vY29tcHV0ZS9kYXRhZnJhbWUnO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2hSZWFkZXIgfSBmcm9tICcuL2lwYy9yZWFkZXInO1xuaW1wb3J0IHsgVmVjdG9yLCBDaHVua2VkIH0gZnJvbSAnLi92ZWN0b3IvaW5kZXgnO1xuaW1wb3J0IHsgRGF0YVR5cGUsIFJvd0xpa2UsIFN0cnVjdCB9IGZyb20gJy4vdHlwZSc7XG5pbXBvcnQgeyBDbG9uYWJsZSwgU2xpY2VhYmxlLCBBcHBsaWNhdGl2ZSB9IGZyb20gJy4vdmVjdG9yJztcbmltcG9ydCB7IFJlY29yZEJhdGNoRmlsZVdyaXRlciwgUmVjb3JkQmF0Y2hTdHJlYW1Xcml0ZXIgfSBmcm9tICcuL2lwYy93cml0ZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRhYmxlPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PiB7XG5cbiAgICBnZXQoaW5kZXg6IG51bWJlcik6IFN0cnVjdDxUPlsnVFZhbHVlJ107XG4gICAgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxSb3dMaWtlPFQ+PjtcblxuICAgIHNsaWNlKGJlZ2luPzogbnVtYmVyLCBlbmQ/OiBudW1iZXIpOiBUYWJsZTxUPjtcbiAgICBjb25jYXQoLi4ub3RoZXJzOiBWZWN0b3I8U3RydWN0PFQ+PltdKTogVGFibGU8VD47XG4gICAgY2xvbmUoY2h1bmtzPzogUmVjb3JkQmF0Y2g8VD5bXSwgb2Zmc2V0cz86IFVpbnQzMkFycmF5KTogVGFibGU8VD47XG5cbiAgICBzY2FuKG5leHQ6IGltcG9ydCgnLi9jb21wdXRlL2RhdGFmcmFtZScpLk5leHRGdW5jLCBiaW5kPzogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuQmluZEZ1bmMpOiB2b2lkO1xuICAgIGNvdW50QnkobmFtZTogaW1wb3J0KCcuL2NvbXB1dGUvcHJlZGljYXRlJykuQ29sIHwgc3RyaW5nKTogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuQ291bnRCeVJlc3VsdDtcbiAgICBmaWx0ZXIocHJlZGljYXRlOiBpbXBvcnQoJy4vY29tcHV0ZS9wcmVkaWNhdGUnKS5QcmVkaWNhdGUpOiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5GaWx0ZXJlZERhdGFGcmFtZTxUPjtcbn1cblxuZXhwb3J0IGNsYXNzIFRhYmxlPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PlxuICAgIGV4dGVuZHMgQ2h1bmtlZDxTdHJ1Y3Q8VD4+XG4gICAgaW1wbGVtZW50cyBEYXRhRnJhbWU8VD4sXG4gICAgICAgICAgICAgICBDbG9uYWJsZTxUYWJsZTxUPj4sXG4gICAgICAgICAgICAgICBTbGljZWFibGU8VGFibGU8VD4+LFxuICAgICAgICAgICAgICAgQXBwbGljYXRpdmU8U3RydWN0PFQ+LCBUYWJsZTxUPj4ge1xuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBlbXB0eTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oKSB7IHJldHVybiBuZXcgVGFibGU8VD4obmV3IFNjaGVtYShbXSksIFtdKTsgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KCk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IFJlY29yZEJhdGNoUmVhZGVyPFQ+KTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMCk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzIpOiBUYWJsZTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmcxKTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMyk6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzQpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21Bcmc1KTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogUHJvbWlzZUxpa2U8UmVjb3JkQmF0Y2hSZWFkZXI8VD4+KTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZT86IGFueSkge1xuXG4gICAgICAgIGlmICghc291cmNlKSB7IHJldHVybiBUYWJsZS5lbXB0eTxUPigpOyB9XG5cbiAgICAgICAgbGV0IHJlYWRlciA9IFJlY29yZEJhdGNoUmVhZGVyLmZyb208VD4oc291cmNlKSBhcyBSZWNvcmRCYXRjaFJlYWRlcjxUPiB8IFByb21pc2U8UmVjb3JkQmF0Y2hSZWFkZXI8VD4+O1xuXG4gICAgICAgIGlmIChpc1Byb21pc2U8UmVjb3JkQmF0Y2hSZWFkZXI8VD4+KHJlYWRlcikpIHtcbiAgICAgICAgICAgIHJldHVybiAoYXN5bmMgKCkgPT4gYXdhaXQgVGFibGUuZnJvbShhd2FpdCByZWFkZXIpKSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZWFkZXIuaXNTeW5jKCkgJiYgKHJlYWRlciA9IHJlYWRlci5vcGVuKCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gIXJlYWRlci5zY2hlbWEgPyBUYWJsZS5lbXB0eTxUPigpIDogbmV3IFRhYmxlPFQ+KHJlYWRlci5zY2hlbWEsIFsuLi5yZWFkZXJdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKGFzeW5jIChvcGVuaW5nKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWFkZXIgPSBhd2FpdCBvcGVuaW5nO1xuICAgICAgICAgICAgY29uc3Qgc2NoZW1hID0gcmVhZGVyLnNjaGVtYTtcbiAgICAgICAgICAgIGNvbnN0IGJhdGNoZXM6IFJlY29yZEJhdGNoW10gPSBbXTtcbiAgICAgICAgICAgIGlmIChzY2hlbWEpIHtcbiAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGxldCBiYXRjaCBvZiByZWFkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgYmF0Y2hlcy5wdXNoKGJhdGNoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYWJsZTxUPihzY2hlbWEsIGJhdGNoZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIFRhYmxlLmVtcHR5PFQ+KCk7XG4gICAgICAgIH0pKHJlYWRlci5vcGVuKCkpO1xuICAgIH1cblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgZnJvbUFzeW5jPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZ3MpOiBQcm9taXNlPFRhYmxlPFQ+PiB7XG4gICAgICAgIHJldHVybiBhd2FpdCBUYWJsZS5mcm9tPFQ+KHNvdXJjZSBhcyBhbnkpO1xuICAgIH1cblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbVZlY3RvcnM8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+KHZlY3RvcnM6IFZUeXBlPFRba2V5b2YgVF0+W10sIG5hbWVzPzogKGtleW9mIFQpW10pIHtcbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZShSZWNvcmRCYXRjaC5mcm9tKHZlY3RvcnMsIG5hbWVzKSk7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tU3RydWN0PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PihzdHJ1Y3Q6IFZlY3RvcjxTdHJ1Y3Q8VD4+KSB7XG4gICAgICAgIGNvbnN0IHNjaGVtYSA9IG5ldyBTY2hlbWE8VD4oc3RydWN0LnR5cGUuY2hpbGRyZW4pO1xuICAgICAgICBjb25zdCBjaHVua3MgPSAoc3RydWN0IGluc3RhbmNlb2YgQ2h1bmtlZCA/IHN0cnVjdC5jaHVua3MgOiBbc3RydWN0XSkgYXMgVlR5cGU8U3RydWN0PFQ+PltdO1xuICAgICAgICByZXR1cm4gbmV3IFRhYmxlKHNjaGVtYSwgY2h1bmtzLm1hcCgoY2h1bmspID0+IG5ldyBSZWNvcmRCYXRjaChzY2hlbWEsIGNodW5rLmRhdGEpKSk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3IoLi4uYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3Ioc2NoZW1hOiBTY2hlbWEsIGJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKHNjaGVtYTogU2NoZW1hLCAuLi5iYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvciguLi5hcmdzOiBhbnlbXSkge1xuXG4gICAgICAgIGxldCBzY2hlbWE6IFNjaGVtYSA9IG51bGwhO1xuXG4gICAgICAgIGlmIChhcmdzWzBdIGluc3RhbmNlb2YgU2NoZW1hKSB7IHNjaGVtYSA9IGFyZ3Muc2hpZnQoKTsgfVxuXG4gICAgICAgIGxldCBjaHVua3MgPSBhcmdzLnJlZHVjZShmdW5jdGlvbiBmbGF0dGVuKHhzOiBhbnlbXSwgeDogYW55KTogYW55W10ge1xuICAgICAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoeCkgPyB4LnJlZHVjZShmbGF0dGVuLCB4cykgOiBbLi4ueHMsIHhdO1xuICAgICAgICB9LCBbXSkuZmlsdGVyKCh4OiBhbnkpOiB4IGlzIFJlY29yZEJhdGNoPFQ+ID0+IHggaW5zdGFuY2VvZiBSZWNvcmRCYXRjaCk7XG5cbiAgICAgICAgaWYgKCFzY2hlbWEgJiYgIShzY2hlbWEgPSBjaHVua3NbMF0gJiYgY2h1bmtzWzBdLnNjaGVtYSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RhYmxlIG11c3QgYmUgaW5pdGlhbGl6ZWQgd2l0aCBhIFNjaGVtYSBvciBhdCBsZWFzdCBvbmUgUmVjb3JkQmF0Y2gnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2h1bmtzWzBdKSB7IGNodW5rc1swXSA9IG5ldyBSZWNvcmRCYXRjaChzY2hlbWEsIDAsIFtdKTsgfVxuXG4gICAgICAgIHN1cGVyKGNodW5rc1swXS50eXBlLCBjaHVua3MpO1xuXG4gICAgICAgIHRoaXMuX3NjaGVtYSA9IHNjaGVtYTtcbiAgICAgICAgdGhpcy5fY2h1bmtzID0gY2h1bmtzO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfc2NoZW1hOiBTY2hlbWE7XG4gICAgLy8gTGlzdCBvZiBpbm5lciBSZWNvcmRCYXRjaGVzXG4gICAgcHJvdGVjdGVkIF9jaHVua3M6IFJlY29yZEJhdGNoPFQ+W107XG4gICAgcHJvdGVjdGVkIF9jaGlsZHJlbj86IENvbHVtbjxUW2tleW9mIFRdPltdO1xuXG4gICAgcHVibGljIGdldCBzY2hlbWEoKSB7IHJldHVybiB0aGlzLl9zY2hlbWE7IH1cbiAgICBwdWJsaWMgZ2V0IGxlbmd0aCgpIHsgcmV0dXJuIHRoaXMuX2xlbmd0aDsgfVxuICAgIHB1YmxpYyBnZXQgY2h1bmtzKCkgeyByZXR1cm4gdGhpcy5fY2h1bmtzOyB9XG4gICAgcHVibGljIGdldCBudW1Db2xzKCkgeyByZXR1cm4gdGhpcy5fbnVtQ2hpbGRyZW47IH1cblxuICAgIHB1YmxpYyBjbG9uZShjaHVua3MgPSB0aGlzLl9jaHVua3MpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZTxUPih0aGlzLl9zY2hlbWEsIGNodW5rcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENvbHVtbkF0PFIgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4oaW5kZXg6IG51bWJlcik6IENvbHVtbjxSPiB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDaGlsZEF0KGluZGV4KTtcbiAgICB9XG4gICAgcHVibGljIGdldENvbHVtbjxSIGV4dGVuZHMga2V5b2YgVD4obmFtZTogUik6IENvbHVtbjxUW1JdPiB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDb2x1bW5BdCh0aGlzLmdldENvbHVtbkluZGV4KG5hbWUpKSBhcyBDb2x1bW48VFtSXT4gfCBudWxsO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q29sdW1uSW5kZXg8UiBleHRlbmRzIGtleW9mIFQ+KG5hbWU6IFIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYS5maWVsZHMuZmluZEluZGV4KChmKSA9PiBmLm5hbWUgPT09IG5hbWUpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q2hpbGRBdDxSIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+KGluZGV4OiBudW1iZXIpOiBDb2x1bW48Uj4gfCBudWxsIHtcbiAgICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLm51bUNoaWxkcmVuKSB7IHJldHVybiBudWxsOyB9XG4gICAgICAgIGxldCBzY2hlbWEgPSB0aGlzLl9zY2hlbWE7XG4gICAgICAgIGxldCBjb2x1bW46IENvbHVtbjxSPiwgZmllbGQ6IEZpZWxkPFI+LCBjaHVua3M6IFZlY3RvcjxSPltdO1xuICAgICAgICBsZXQgY29sdW1ucyA9IHRoaXMuX2NoaWxkcmVuIHx8ICh0aGlzLl9jaGlsZHJlbiA9IFtdKSBhcyBDb2x1bW5bXTtcbiAgICAgICAgaWYgKGNvbHVtbiA9IGNvbHVtbnNbaW5kZXhdKSB7IHJldHVybiBjb2x1bW4gYXMgQ29sdW1uPFI+OyB9XG4gICAgICAgIGlmIChmaWVsZCA9ICgoc2NoZW1hLmZpZWxkcyB8fCBbXSlbaW5kZXhdIGFzIEZpZWxkPFI+KSkge1xuICAgICAgICAgICAgY2h1bmtzID0gdGhpcy5fY2h1bmtzXG4gICAgICAgICAgICAgICAgLm1hcCgoY2h1bmspID0+IGNodW5rLmdldENoaWxkQXQ8Uj4oaW5kZXgpKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoKHZlYyk6IHZlYyBpcyBWZWN0b3I8Uj4gPT4gdmVjICE9IG51bGwpO1xuICAgICAgICAgICAgaWYgKGNodW5rcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChjb2x1bW5zW2luZGV4XSA9IG5ldyBDb2x1bW48Uj4oZmllbGQsIGNodW5rcykpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwdWJsaWMgc2VyaWFsaXplKGVuY29kaW5nID0gJ2JpbmFyeScsIHN0cmVhbSA9IHRydWUpIHtcbiAgICAgICAgY29uc3Qgd3JpdGVyID0gIXN0cmVhbVxuICAgICAgICAgICAgPyBSZWNvcmRCYXRjaEZpbGVXcml0ZXJcbiAgICAgICAgICAgIDogUmVjb3JkQmF0Y2hTdHJlYW1Xcml0ZXI7XG4gICAgICAgIHJldHVybiB3cml0ZXIud3JpdGVBbGwodGhpcy5fY2h1bmtzKS50b1VpbnQ4QXJyYXkodHJ1ZSk7XG4gICAgfVxuICAgIHB1YmxpYyBjb3VudCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fbGVuZ3RoO1xuICAgIH1cbiAgICBwdWJsaWMgc2VsZWN0KC4uLmNvbHVtbk5hbWVzOiBzdHJpbmdbXSkge1xuICAgICAgICByZXR1cm4gbmV3IFRhYmxlKHRoaXMuX2NodW5rcy5tYXAoKGJhdGNoKSA9PiBiYXRjaC5zZWxlY3QoLi4uY29sdW1uTmFtZXMpKSk7XG4gICAgfVxufVxuIl19
