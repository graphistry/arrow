"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const column_1 = require("./column");
const schema_1 = require("./schema");
const compat_1 = require("./util/compat");
const recordbatch_1 = require("./recordbatch");
const reader_1 = require("./ipc/reader");
const index_1 = require("./vector/index");
const args_1 = require("./util/args");
const recordbatch_2 = require("./util/recordbatch");
const recordbatch_3 = require("./util/recordbatch");
const writer_1 = require("./ipc/writer");
class Table extends index_1.Chunked {
    constructor(...args) {
        let schema = null;
        if (args[0] instanceof schema_1.Schema) {
            schema = args.shift();
        }
        let chunks = args_1.selectArgs(recordbatch_1.RecordBatch, args);
        if (!schema && !(schema = chunks[0] && chunks[0].schema)) {
            throw new TypeError('Table must be initialized with a Schema or at least one RecordBatch');
        }
        if (!chunks[0]) {
            chunks[0] = new recordbatch_1.RecordBatch(schema, 0, []);
        }
        super(chunks[0].type, chunks);
        this._schema = schema;
        this._chunks = chunks;
    }
    /** @nocollapse */
    static empty() { return new Table(new schema_1.Schema([]), []); }
    /** @nocollapse */
    static from(source) {
        if (!source) {
            return Table.empty();
        }
        let reader = reader_1.RecordBatchReader.from(source);
        if (compat_1.isPromise(reader)) {
            return (async () => await Table.from(await reader))();
        }
        if (reader.isSync() && (reader = reader.open())) {
            return !reader.schema ? Table.empty() : new Table(reader.schema, [...reader]);
        }
        return (async (opening) => {
            const reader = await opening;
            const schema = reader.schema;
            const batches = [];
            if (schema) {
                for await (let batch of reader) {
                    batches.push(batch);
                }
                return new Table(schema, batches);
            }
            return Table.empty();
        })(reader.open());
    }
    /** @nocollapse */
    static async fromAsync(source) {
        return await Table.from(source);
    }
    /** @nocollapse */
    static fromStruct(struct) {
        return Table.new(struct.data.childData, struct.type.children);
    }
    /** @nocollapse */
    static new(...cols) {
        return new Table(...recordbatch_2.distributeColumnsIntoRecordBatches(args_1.selectColumnArgs(cols)));
    }
    get schema() { return this._schema; }
    get length() { return this._length; }
    get chunks() { return this._chunks; }
    get numCols() { return this._numChildren; }
    clone(chunks = this._chunks) {
        return new Table(this._schema, chunks);
    }
    getColumn(name) {
        return this.getColumnAt(this.getColumnIndex(name));
    }
    getColumnAt(index) {
        return this.getChildAt(index);
    }
    getColumnIndex(name) {
        return this._schema.fields.findIndex((f) => f.name === name);
    }
    getChildAt(index) {
        if (index < 0 || index >= this.numChildren) {
            return null;
        }
        let field, child;
        const fields = this._schema.fields;
        const columns = this._children || (this._children = []);
        if (child = columns[index]) {
            return child;
        }
        if (field = fields[index]) {
            const chunks = this._chunks
                .map((chunk) => chunk.getChildAt(index))
                .filter((vec) => vec != null);
            if (chunks.length > 0) {
                return (columns[index] = new column_1.Column(field, chunks));
            }
        }
        return null;
    }
    // @ts-ignore
    serialize(encoding = 'binary', stream = true) {
        const writer = !stream
            ? writer_1.RecordBatchFileWriter
            : writer_1.RecordBatchStreamWriter;
        return writer.writeAll(this._chunks).toUint8Array(true);
    }
    count() {
        return this._length;
    }
    select(...columnNames) {
        const nameToIndex = this._schema.fields.reduce((m, f, i) => m.set(f.name, i), new Map());
        return this.selectAt(...columnNames.map((columnName) => nameToIndex.get(columnName)).filter((x) => x > -1));
    }
    selectAt(...columnIndices) {
        const schema = this._schema.selectAt(...columnIndices);
        return new Table(schema, this._chunks.map(({ length, data: { childData } }) => {
            return new recordbatch_1.RecordBatch(schema, length, columnIndices.map((i) => childData[i]).filter(Boolean));
        }));
    }
    assign(other) {
        const fields = this._schema.fields;
        const [indices, oldToNew] = other.schema.fields.reduce((memo, f2, newIdx) => {
            const [indices, oldToNew] = memo;
            const i = fields.findIndex((f) => f.compareTo(f2));
            ~i ? (oldToNew[i] = newIdx) : indices.push(newIdx);
            return memo;
        }, [[], []]);
        const schema = this._schema.assign(other.schema);
        const columns = [
            ...fields.map((_f, i, _fs, j = oldToNew[i]) => (j === undefined ? this.getColumnAt(i) : other.getColumnAt(j))),
            ...indices.map((i) => other.getColumnAt(i))
        ].filter(Boolean);
        return new Table(...recordbatch_3.distributeVectorsIntoRecordBatches(schema, columns));
    }
}
exports.Table = Table;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUNuRCxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbkQsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBZSxDQUFDLENBQUM7UUFFM0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2pELE1BQU0sT0FBTyxHQUFHO1lBQ1osR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQzFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBRSxDQUFDO1lBQ3BFLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUUsQ0FBQztTQUMvQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQXlDLENBQUM7UUFFMUQsT0FBTyxJQUFJLEtBQUssQ0FBQyxHQUFHLGdEQUFrQyxDQUFRLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLENBQUM7Q0FDSjtBQXpORCxzQkF5TkMiLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgRGF0YSB9IGZyb20gJy4vZGF0YSc7XG5pbXBvcnQgeyBDb2x1bW4gfSBmcm9tICcuL2NvbHVtbic7XG5pbXBvcnQgeyBTY2hlbWEsIEZpZWxkIH0gZnJvbSAnLi9zY2hlbWEnO1xuaW1wb3J0IHsgaXNQcm9taXNlIH0gZnJvbSAnLi91dGlsL2NvbXBhdCc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaCB9IGZyb20gJy4vcmVjb3JkYmF0Y2gnO1xuaW1wb3J0IHsgRGF0YUZyYW1lIH0gZnJvbSAnLi9jb21wdXRlL2RhdGFmcmFtZSc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaFJlYWRlciB9IGZyb20gJy4vaXBjL3JlYWRlcic7XG5pbXBvcnQgeyBWZWN0b3IsIENodW5rZWQgfSBmcm9tICcuL3ZlY3Rvci9pbmRleCc7XG5pbXBvcnQgeyBEYXRhVHlwZSwgUm93TGlrZSwgU3RydWN0IH0gZnJvbSAnLi90eXBlJztcbmltcG9ydCB7IENsb25hYmxlLCBTbGljZWFibGUsIEFwcGxpY2F0aXZlIH0gZnJvbSAnLi92ZWN0b3InO1xuaW1wb3J0IHsgc2VsZWN0Q29sdW1uQXJncywgc2VsZWN0QXJncyB9IGZyb20gJy4vdXRpbC9hcmdzJztcbmltcG9ydCB7IGRpc3RyaWJ1dGVDb2x1bW5zSW50b1JlY29yZEJhdGNoZXMgfSBmcm9tICcuL3V0aWwvcmVjb3JkYmF0Y2gnO1xuaW1wb3J0IHsgZGlzdHJpYnV0ZVZlY3RvcnNJbnRvUmVjb3JkQmF0Y2hlcyB9IGZyb20gJy4vdXRpbC9yZWNvcmRiYXRjaCc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaEZpbGVXcml0ZXIsIFJlY29yZEJhdGNoU3RyZWFtV3JpdGVyIH0gZnJvbSAnLi9pcGMvd3JpdGVyJztcblxudHlwZSBWZWN0b3JNYXAgPSB7IFtrZXk6IHN0cmluZ106IFZlY3RvciB9O1xudHlwZSBGaWVsZHM8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfT4gPSAoa2V5b2YgVClbXSB8IEZpZWxkPFRba2V5b2YgVF0+W107XG50eXBlIENoaWxkRGF0YTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9PiA9IERhdGE8VFtrZXlvZiBUXT5bXSB8IFZlY3RvcjxUW2tleW9mIFRdPltdO1xudHlwZSBDb2x1bW5zPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0+ID0gQ29sdW1uPFRba2V5b2YgVF0+W10gfCBDb2x1bW48VFtrZXlvZiBUXT5bXVtdO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRhYmxlPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+IHtcblxuICAgIGdldChpbmRleDogbnVtYmVyKTogU3RydWN0PFQ+WydUVmFsdWUnXTtcbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPFJvd0xpa2U8VD4+O1xuXG4gICAgc2xpY2UoYmVnaW4/OiBudW1iZXIsIGVuZD86IG51bWJlcik6IFRhYmxlPFQ+O1xuICAgIGNvbmNhdCguLi5vdGhlcnM6IFZlY3RvcjxTdHJ1Y3Q8VD4+W10pOiBUYWJsZTxUPjtcbiAgICBjbG9uZShjaHVua3M/OiBSZWNvcmRCYXRjaDxUPltdLCBvZmZzZXRzPzogVWludDMyQXJyYXkpOiBUYWJsZTxUPjtcblxuICAgIHNjYW4obmV4dDogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuTmV4dEZ1bmMsIGJpbmQ/OiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5CaW5kRnVuYyk6IHZvaWQ7XG4gICAgY291bnRCeShuYW1lOiBpbXBvcnQoJy4vY29tcHV0ZS9wcmVkaWNhdGUnKS5Db2wgfCBzdHJpbmcpOiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5Db3VudEJ5UmVzdWx0O1xuICAgIGZpbHRlcihwcmVkaWNhdGU6IGltcG9ydCgnLi9jb21wdXRlL3ByZWRpY2F0ZScpLlByZWRpY2F0ZSk6IGltcG9ydCgnLi9jb21wdXRlL2RhdGFmcmFtZScpLkZpbHRlcmVkRGF0YUZyYW1lPFQ+O1xufVxuXG5leHBvcnQgY2xhc3MgVGFibGU8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT5cbiAgICBleHRlbmRzIENodW5rZWQ8U3RydWN0PFQ+PlxuICAgIGltcGxlbWVudHMgRGF0YUZyYW1lPFQ+LFxuICAgICAgICAgICAgICAgQ2xvbmFibGU8VGFibGU8VD4+LFxuICAgICAgICAgICAgICAgU2xpY2VhYmxlPFRhYmxlPFQ+PixcbiAgICAgICAgICAgICAgIEFwcGxpY2F0aXZlPFN0cnVjdDxUPiwgVGFibGU8VD4+IHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZW1wdHk8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oKSB7IHJldHVybiBuZXcgVGFibGU8VD4obmV3IFNjaGVtYShbXSksIFtdKTsgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KCk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IFJlY29yZEJhdGNoUmVhZGVyPFQ+KTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMCk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzIpOiBUYWJsZTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmcxKTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMyk6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzQpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21Bcmc1KTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogUHJvbWlzZUxpa2U8UmVjb3JkQmF0Y2hSZWFkZXI8VD4+KTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZT86IGFueSkge1xuXG4gICAgICAgIGlmICghc291cmNlKSB7IHJldHVybiBUYWJsZS5lbXB0eTxUPigpOyB9XG5cbiAgICAgICAgbGV0IHJlYWRlciA9IFJlY29yZEJhdGNoUmVhZGVyLmZyb208VD4oc291cmNlKSBhcyBSZWNvcmRCYXRjaFJlYWRlcjxUPiB8IFByb21pc2U8UmVjb3JkQmF0Y2hSZWFkZXI8VD4+O1xuXG4gICAgICAgIGlmIChpc1Byb21pc2U8UmVjb3JkQmF0Y2hSZWFkZXI8VD4+KHJlYWRlcikpIHtcbiAgICAgICAgICAgIHJldHVybiAoYXN5bmMgKCkgPT4gYXdhaXQgVGFibGUuZnJvbShhd2FpdCByZWFkZXIpKSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZWFkZXIuaXNTeW5jKCkgJiYgKHJlYWRlciA9IHJlYWRlci5vcGVuKCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gIXJlYWRlci5zY2hlbWEgPyBUYWJsZS5lbXB0eTxUPigpIDogbmV3IFRhYmxlPFQ+KHJlYWRlci5zY2hlbWEsIFsuLi5yZWFkZXJdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKGFzeW5jIChvcGVuaW5nKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWFkZXIgPSBhd2FpdCBvcGVuaW5nO1xuICAgICAgICAgICAgY29uc3Qgc2NoZW1hID0gcmVhZGVyLnNjaGVtYTtcbiAgICAgICAgICAgIGNvbnN0IGJhdGNoZXM6IFJlY29yZEJhdGNoW10gPSBbXTtcbiAgICAgICAgICAgIGlmIChzY2hlbWEpIHtcbiAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGxldCBiYXRjaCBvZiByZWFkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgYmF0Y2hlcy5wdXNoKGJhdGNoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYWJsZTxUPihzY2hlbWEsIGJhdGNoZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIFRhYmxlLmVtcHR5PFQ+KCk7XG4gICAgICAgIH0pKHJlYWRlci5vcGVuKCkpO1xuICAgIH1cblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgZnJvbUFzeW5jPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJncyk6IFByb21pc2U8VGFibGU8VD4+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IFRhYmxlLmZyb208VD4oc291cmNlIGFzIGFueSk7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tU3RydWN0PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHN0cnVjdDogVmVjdG9yPFN0cnVjdDxUPj4pIHtcbiAgICAgICAgcmV0dXJuIFRhYmxlLm5ldzxUPihzdHJ1Y3QuZGF0YS5jaGlsZERhdGEgYXMgRGF0YTxUW2tleW9mIFRdPltdLCBzdHJ1Y3QudHlwZS5jaGlsZHJlbik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHN1bW1hcnkgQ3JlYXRlIGEgbmV3IFRhYmxlIGZyb20gYSBjb2xsZWN0aW9uIG9mIENvbHVtbnMgb3IgVmVjdG9ycyxcbiAgICAgKiB3aXRoIGFuIG9wdGlvbmFsIGxpc3Qgb2YgbmFtZXMgb3IgRmllbGRzLlxuICAgICAqXG4gICAgICpcbiAgICAgKiBgVGFibGUubmV3YCBhY2NlcHRzIGFuIE9iamVjdCBvZlxuICAgICAqIENvbHVtbnMgb3IgVmVjdG9ycywgd2hlcmUgdGhlIGtleXMgd2lsbCBiZSB1c2VkIGFzIHRoZSBmaWVsZCBuYW1lc1xuICAgICAqIGZvciB0aGUgU2NoZW1hOlxuICAgICAqIGBgYHRzXG4gICAgICogY29uc3QgaTMycyA9IEludDMyVmVjdG9yLmZyb20oWzEsIDIsIDNdKTtcbiAgICAgKiBjb25zdCBmMzJzID0gRmxvYXQzMlZlY3Rvci5mcm9tKFsuMSwgLjIsIC4zXSk7XG4gICAgICogY29uc3QgdGFibGUgPSBUYWJsZS5uZXcoeyBpMzI6IGkzMnMsIGYzMjogZjMycyB9KTtcbiAgICAgKiBhc3NlcnQodGFibGUuc2NoZW1hLmZpZWxkc1swXS5uYW1lID09PSAnaTMyJyk7XG4gICAgICogYGBgXG4gICAgICpcbiAgICAgKiBJdCBhbHNvIGFjY2VwdHMgYSBhIGxpc3Qgb2YgVmVjdG9ycyB3aXRoIGFuIG9wdGlvbmFsIGxpc3Qgb2YgbmFtZXMgb3JcbiAgICAgKiBGaWVsZHMgZm9yIHRoZSByZXN1bHRpbmcgU2NoZW1hLiBJZiB0aGUgbGlzdCBpcyBvbWl0dGVkIG9yIGEgbmFtZSBpc1xuICAgICAqIG1pc3NpbmcsIHRoZSBudW1lcmljIGluZGV4IG9mIGVhY2ggVmVjdG9yIHdpbGwgYmUgdXNlZCBhcyB0aGUgbmFtZTpcbiAgICAgKiBgYGB0c1xuICAgICAqIGNvbnN0IGkzMnMgPSBJbnQzMlZlY3Rvci5mcm9tKFsxLCAyLCAzXSk7XG4gICAgICogY29uc3QgZjMycyA9IEZsb2F0MzJWZWN0b3IuZnJvbShbLjEsIC4yLCAuM10pO1xuICAgICAqIGNvbnN0IHRhYmxlID0gVGFibGUubmV3KFtpMzJzLCBmMzJzXSwgWydpMzInXSk7XG4gICAgICogYXNzZXJ0KHRhYmxlLnNjaGVtYS5maWVsZHNbMF0ubmFtZSA9PT0gJ2kzMicpO1xuICAgICAqIGFzc2VydCh0YWJsZS5zY2hlbWEuZmllbGRzWzFdLm5hbWUgPT09ICcxJyk7XG4gICAgICogYGBgXG4gICAgICpcbiAgICAgKiBJZiB0aGUgc3VwcGxpZWQgYXJndW1lbnRzIGFyZSBDb2x1bW5zLCBgVGFibGUubmV3YCB3aWxsIGluZmVyIHRoZSBTY2hlbWFcbiAgICAgKiBmcm9tIHRoZSBDb2x1bW5zOlxuICAgICAqIGBgYHRzXG4gICAgICogY29uc3QgaTMycyA9IENvbHVtbi5uZXcoJ2kzMicsIEludDMyVmVjdG9yLmZyb20oWzEsIDIsIDNdKSk7XG4gICAgICogY29uc3QgZjMycyA9IENvbHVtbi5uZXcoJ2YzMicsIEZsb2F0MzJWZWN0b3IuZnJvbShbLjEsIC4yLCAuM10pKTtcbiAgICAgKiBjb25zdCB0YWJsZSA9IFRhYmxlLm5ldyhpMzJzLCBmMzJzKTtcbiAgICAgKiBhc3NlcnQodGFibGUuc2NoZW1hLmZpZWxkc1swXS5uYW1lID09PSAnaTMyJyk7XG4gICAgICogYXNzZXJ0KHRhYmxlLnNjaGVtYS5maWVsZHNbMV0ubmFtZSA9PT0gJ2YzMicpO1xuICAgICAqIGBgYFxuICAgICAqXG4gICAgICogSWYgdGhlIHN1cHBsaWVkIFZlY3RvciBvciBDb2x1bW4gbGVuZ3RocyBhcmUgdW5lcXVhbCwgYFRhYmxlLm5ld2Agd2lsbFxuICAgICAqIGV4dGVuZCB0aGUgbGVuZ3RocyBvZiB0aGUgc2hvcnRlciBDb2x1bW5zLCBhbGxvY2F0aW5nIGFkZGl0aW9uYWwgYnl0ZXNcbiAgICAgKiB0byByZXByZXNlbnQgdGhlIGFkZGl0aW9uYWwgbnVsbCBzbG90cy4gVGhlIG1lbW9yeSByZXF1aXJlZCB0byBhbGxvY2F0ZVxuICAgICAqIHRoZXNlIGFkZGl0aW9uYWwgYml0bWFwcyBjYW4gYmUgY29tcHV0ZWQgYXM6XG4gICAgICogYGBgdHNcbiAgICAgKiBsZXQgYWRkaXRpb25hbEJ5dGVzID0gMDtcbiAgICAgKiBmb3IgKGxldCB2ZWMgaW4gc2hvcnRlcl92ZWN0b3JzKSB7XG4gICAgICogICAgIGFkZGl0aW9uYWxCeXRlcyArPSAoKChsb25nZXN0TGVuZ3RoIC0gdmVjLmxlbmd0aCkgKyA2MykgJiB+NjMpID4+IDM7XG4gICAgICogfVxuICAgICAqIGBgYFxuICAgICAqXG4gICAgICogRm9yIGV4YW1wbGUsIGFuIGFkZGl0aW9uYWwgbnVsbCBiaXRtYXAgZm9yIG9uZSBtaWxsaW9uIG51bGwgdmFsdWVzIHdvdWxkIHJlcXVpcmVcbiAgICAgKiAxMjUsMDAwIGJ5dGVzIChgKCgxZTYgKyA2MykgJiB+NjMpID4+IDNgKSwgb3IgYXBwcm94LiBgMC4xMU1pQmBcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PiguLi5jb2x1bW5zOiBDb2x1bW5zPFQ+KTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBuZXc8VCBleHRlbmRzIFZlY3Rvck1hcCA9IGFueT4oY2hpbGRyZW46IFQpOiBUYWJsZTx7IFtQIGluIGtleW9mIFRdOiBUW1BdWyd0eXBlJ10gfT47XG4gICAgcHVibGljIHN0YXRpYyBuZXc8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oY2hpbGRyZW46IENoaWxkRGF0YTxUPiwgZmllbGRzPzogRmllbGRzPFQ+KTogVGFibGU8VD47XG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBuZXcoLi4uY29sczogYW55W10pIHtcbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZSguLi5kaXN0cmlidXRlQ29sdW1uc0ludG9SZWNvcmRCYXRjaGVzKHNlbGVjdENvbHVtbkFyZ3MoY29scykpKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihiYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvciguLi5iYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvcihzY2hlbWE6IFNjaGVtYTxUPiwgYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3Ioc2NoZW1hOiBTY2hlbWE8VD4sIC4uLmJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKC4uLmFyZ3M6IGFueVtdKSB7XG5cbiAgICAgICAgbGV0IHNjaGVtYTogU2NoZW1hID0gbnVsbCE7XG5cbiAgICAgICAgaWYgKGFyZ3NbMF0gaW5zdGFuY2VvZiBTY2hlbWEpIHsgc2NoZW1hID0gYXJncy5zaGlmdCgpOyB9XG5cbiAgICAgICAgbGV0IGNodW5rcyA9IHNlbGVjdEFyZ3M8UmVjb3JkQmF0Y2g8VD4+KFJlY29yZEJhdGNoLCBhcmdzKTtcblxuICAgICAgICBpZiAoIXNjaGVtYSAmJiAhKHNjaGVtYSA9IGNodW5rc1swXSAmJiBjaHVua3NbMF0uc2NoZW1hKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGFibGUgbXVzdCBiZSBpbml0aWFsaXplZCB3aXRoIGEgU2NoZW1hIG9yIGF0IGxlYXN0IG9uZSBSZWNvcmRCYXRjaCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjaHVua3NbMF0pIHsgY2h1bmtzWzBdID0gbmV3IFJlY29yZEJhdGNoKHNjaGVtYSwgMCwgW10pOyB9XG5cbiAgICAgICAgc3VwZXIoY2h1bmtzWzBdLnR5cGUsIGNodW5rcyk7XG5cbiAgICAgICAgdGhpcy5fc2NoZW1hID0gc2NoZW1hO1xuICAgICAgICB0aGlzLl9jaHVua3MgPSBjaHVua3M7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9zY2hlbWE6IFNjaGVtYTxUPjtcbiAgICAvLyBMaXN0IG9mIGlubmVyIFJlY29yZEJhdGNoZXNcbiAgICBwcm90ZWN0ZWQgX2NodW5rczogUmVjb3JkQmF0Y2g8VD5bXTtcbiAgICBwcm90ZWN0ZWQgX2NoaWxkcmVuPzogQ29sdW1uPFRba2V5b2YgVF0+W107XG5cbiAgICBwdWJsaWMgZ2V0IHNjaGVtYSgpIHsgcmV0dXJuIHRoaXMuX3NjaGVtYTsgfVxuICAgIHB1YmxpYyBnZXQgbGVuZ3RoKCkgeyByZXR1cm4gdGhpcy5fbGVuZ3RoOyB9XG4gICAgcHVibGljIGdldCBjaHVua3MoKSB7IHJldHVybiB0aGlzLl9jaHVua3M7IH1cbiAgICBwdWJsaWMgZ2V0IG51bUNvbHMoKSB7IHJldHVybiB0aGlzLl9udW1DaGlsZHJlbjsgfVxuXG4gICAgcHVibGljIGNsb25lKGNodW5rcyA9IHRoaXMuX2NodW5rcykge1xuICAgICAgICByZXR1cm4gbmV3IFRhYmxlPFQ+KHRoaXMuX3NjaGVtYSwgY2h1bmtzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q29sdW1uPFIgZXh0ZW5kcyBrZXlvZiBUPihuYW1lOiBSKTogQ29sdW1uPFRbUl0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29sdW1uQXQodGhpcy5nZXRDb2x1bW5JbmRleChuYW1lKSkgYXMgQ29sdW1uPFRbUl0+O1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q29sdW1uQXQ8UiBleHRlbmRzIERhdGFUeXBlID0gYW55PihpbmRleDogbnVtYmVyKTogQ29sdW1uPFI+IHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENoaWxkQXQoaW5kZXgpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q29sdW1uSW5kZXg8UiBleHRlbmRzIGtleW9mIFQ+KG5hbWU6IFIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYS5maWVsZHMuZmluZEluZGV4KChmKSA9PiBmLm5hbWUgPT09IG5hbWUpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q2hpbGRBdDxSIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+KGluZGV4OiBudW1iZXIpOiBDb2x1bW48Uj4gfCBudWxsIHtcbiAgICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLm51bUNoaWxkcmVuKSB7IHJldHVybiBudWxsOyB9XG4gICAgICAgIGxldCBmaWVsZDogRmllbGQ8Uj4sIGNoaWxkOiBDb2x1bW48Uj47XG4gICAgICAgIGNvbnN0IGZpZWxkcyA9ICh0aGlzLl9zY2hlbWEgYXMgU2NoZW1hPGFueT4pLmZpZWxkcztcbiAgICAgICAgY29uc3QgY29sdW1ucyA9IHRoaXMuX2NoaWxkcmVuIHx8ICh0aGlzLl9jaGlsZHJlbiA9IFtdKSBhcyBDb2x1bW5bXTtcbiAgICAgICAgaWYgKGNoaWxkID0gY29sdW1uc1tpbmRleF0pIHsgcmV0dXJuIGNoaWxkIGFzIENvbHVtbjxSPjsgfVxuICAgICAgICBpZiAoZmllbGQgPSBmaWVsZHNbaW5kZXhdKSB7XG4gICAgICAgICAgICBjb25zdCBjaHVua3MgPSB0aGlzLl9jaHVua3NcbiAgICAgICAgICAgICAgICAubWFwKChjaHVuaykgPT4gY2h1bmsuZ2V0Q2hpbGRBdDxSPihpbmRleCkpXG4gICAgICAgICAgICAgICAgLmZpbHRlcigodmVjKTogdmVjIGlzIFZlY3RvcjxSPiA9PiB2ZWMgIT0gbnVsbCk7XG4gICAgICAgICAgICBpZiAoY2h1bmtzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKGNvbHVtbnNbaW5kZXhdID0gbmV3IENvbHVtbjxSPihmaWVsZCwgY2h1bmtzKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHB1YmxpYyBzZXJpYWxpemUoZW5jb2RpbmcgPSAnYmluYXJ5Jywgc3RyZWFtID0gdHJ1ZSkge1xuICAgICAgICBjb25zdCB3cml0ZXIgPSAhc3RyZWFtXG4gICAgICAgICAgICA/IFJlY29yZEJhdGNoRmlsZVdyaXRlclxuICAgICAgICAgICAgOiBSZWNvcmRCYXRjaFN0cmVhbVdyaXRlcjtcbiAgICAgICAgcmV0dXJuIHdyaXRlci53cml0ZUFsbCh0aGlzLl9jaHVua3MpLnRvVWludDhBcnJheSh0cnVlKTtcbiAgICB9XG4gICAgcHVibGljIGNvdW50KCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9sZW5ndGg7XG4gICAgfVxuICAgIHB1YmxpYyBzZWxlY3Q8SyBleHRlbmRzIGtleW9mIFQgPSBhbnk+KC4uLmNvbHVtbk5hbWVzOiBLW10pIHtcbiAgICAgICAgY29uc3QgbmFtZVRvSW5kZXggPSB0aGlzLl9zY2hlbWEuZmllbGRzLnJlZHVjZSgobSwgZiwgaSkgPT4gbS5zZXQoZi5uYW1lIGFzIEssIGkpLCBuZXcgTWFwPEssIG51bWJlcj4oKSk7XG4gICAgICAgIHJldHVybiB0aGlzLnNlbGVjdEF0KC4uLmNvbHVtbk5hbWVzLm1hcCgoY29sdW1uTmFtZSkgPT4gbmFtZVRvSW5kZXguZ2V0KGNvbHVtbk5hbWUpISkuZmlsdGVyKCh4KSA9PiB4ID4gLTEpKTtcbiAgICB9XG4gICAgcHVibGljIHNlbGVjdEF0PEsgZXh0ZW5kcyBUW2tleW9mIFRdID0gYW55PiguLi5jb2x1bW5JbmRpY2VzOiBudW1iZXJbXSkge1xuICAgICAgICBjb25zdCBzY2hlbWEgPSB0aGlzLl9zY2hlbWEuc2VsZWN0QXQ8Sz4oLi4uY29sdW1uSW5kaWNlcyk7XG4gICAgICAgIHJldHVybiBuZXcgVGFibGUoc2NoZW1hLCB0aGlzLl9jaHVua3MubWFwKCh7IGxlbmd0aCwgZGF0YTogeyBjaGlsZERhdGEgfSB9KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFJlY29yZEJhdGNoKHNjaGVtYSwgbGVuZ3RoLCBjb2x1bW5JbmRpY2VzLm1hcCgoaSkgPT4gY2hpbGREYXRhW2ldKS5maWx0ZXIoQm9vbGVhbikpO1xuICAgICAgICB9KSk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3NpZ248UiBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4ob3RoZXI6IFRhYmxlPFI+KSB7XG5cbiAgICAgICAgY29uc3QgZmllbGRzID0gdGhpcy5fc2NoZW1hLmZpZWxkcztcbiAgICAgICAgY29uc3QgW2luZGljZXMsIG9sZFRvTmV3XSA9IG90aGVyLnNjaGVtYS5maWVsZHMucmVkdWNlKChtZW1vLCBmMiwgbmV3SWR4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBbaW5kaWNlcywgb2xkVG9OZXddID0gbWVtbztcbiAgICAgICAgICAgIGNvbnN0IGkgPSBmaWVsZHMuZmluZEluZGV4KChmKSA9PiBmLmNvbXBhcmVUbyhmMikpO1xuICAgICAgICAgICAgfmkgPyAob2xkVG9OZXdbaV0gPSBuZXdJZHgpIDogaW5kaWNlcy5wdXNoKG5ld0lkeCk7XG4gICAgICAgICAgICByZXR1cm4gbWVtbztcbiAgICAgICAgfSwgW1tdLCBbXV0gYXMgbnVtYmVyW11bXSk7XG5cbiAgICAgICAgY29uc3Qgc2NoZW1hID0gdGhpcy5fc2NoZW1hLmFzc2lnbihvdGhlci5zY2hlbWEpO1xuICAgICAgICBjb25zdCBjb2x1bW5zID0gW1xuICAgICAgICAgICAgLi4uZmllbGRzLm1hcCgoX2YsIGksIF9mcywgaiA9IG9sZFRvTmV3W2ldKSA9PlxuICAgICAgICAgICAgICAgIChqID09PSB1bmRlZmluZWQgPyB0aGlzLmdldENvbHVtbkF0KGkpIDogb3RoZXIuZ2V0Q29sdW1uQXQoaikpISksXG4gICAgICAgICAgICAuLi5pbmRpY2VzLm1hcCgoaSkgPT4gb3RoZXIuZ2V0Q29sdW1uQXQoaSkhKVxuICAgICAgICBdLmZpbHRlcihCb29sZWFuKSBhcyBDb2x1bW48KFQgJiBSKVtrZXlvZiBUIHwga2V5b2YgUl0+W107XG5cbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZSguLi5kaXN0cmlidXRlVmVjdG9yc0ludG9SZWNvcmRCYXRjaGVzPFQgJiBSPihzY2hlbWEsIGNvbHVtbnMpKTtcbiAgICB9XG59XG4iXX0=
