"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const data_1 = require("./data");
const column_1 = require("./column");
const schema_1 = require("./schema");
const compat_1 = require("./util/compat");
const recordbatch_1 = require("./recordbatch");
const array_1 = require("./util/array");
const reader_1 = require("./ipc/reader");
const index_1 = require("./vector/index");
const recordbatch_2 = require("./util/recordbatch");
const recordbatch_3 = require("./util/recordbatch");
const writer_1 = require("./ipc/writer");
class Table extends index_1.Chunked {
    constructor(...args) {
        let schema = null;
        if (args[0] instanceof schema_1.Schema) {
            schema = args.shift();
        }
        let chunks = array_1.selectAndFlatten(recordbatch_1.RecordBatch, args);
        if (!schema && !(schema = chunks[0] && chunks[0].schema)) {
            throw new TypeError('Table must be initialized with a Schema or at least one RecordBatch');
        }
        if (!chunks[0]) {
            chunks[0] = new recordbatch_1.RecordBatch(schema, 0, []);
        }
        super(chunks[0].type, chunks);
        this._schema = schema;
        this._chunks = chunks;
    }
    /** @nocollapse */
    static empty() { return new Table(new schema_1.Schema([]), []); }
    /** @nocollapse */
    static from(source) {
        if (!source) {
            return Table.empty();
        }
        let reader = reader_1.RecordBatchReader.from(source);
        if (compat_1.isPromise(reader)) {
            return (async () => await Table.from(await reader))();
        }
        if (reader.isSync() && (reader = reader.open())) {
            return !reader.schema ? Table.empty() : new Table(reader.schema, [...reader]);
        }
        return (async (opening) => {
            const reader = await opening;
            const schema = reader.schema;
            const batches = [];
            if (schema) {
                for await (let batch of reader) {
                    batches.push(batch);
                }
                return new Table(schema, batches);
            }
            return Table.empty();
        })(reader.open());
    }
    /** @nocollapse */
    static async fromAsync(source) {
        return await Table.from(source);
    }
    /** @nocollapse */
    static fromVectors(vectors, fields) {
        return Table.new(vectors, fields);
    }
    /** @nocollapse */
    static fromStruct(struct) {
        return Table.new(struct.data.childData, struct.type.children);
    }
    /** @nocollapse */
    static new(...args) {
        let x = args[0], columns;
        if (x instanceof column_1.Column || (Array.isArray(x) && (x[0] instanceof column_1.Column))) {
            columns = array_1.selectAndFlatten(column_1.Column, args);
        }
        else {
            const [chunks, fields = []] = args;
            columns = chunks.map((chunk, i) => {
                const { [i]: name = `${i}` } = fields;
                const v = chunk instanceof data_1.Data ? index_1.Vector.new(chunk) : chunk;
                const f = name instanceof schema_1.Field ? name : new schema_1.Field(name, chunk.type);
                return column_1.Column.new(f, [v]);
            });
        }
        return new Table(...recordbatch_2.distributeColumnsIntoRecordBatches(columns));
    }
    get schema() { return this._schema; }
    get length() { return this._length; }
    get chunks() { return this._chunks; }
    get numCols() { return this._numChildren; }
    clone(chunks = this._chunks) {
        return new Table(this._schema, chunks);
    }
    getColumnAt(index) {
        return this.getChildAt(index);
    }
    getColumn(name) {
        return this.getColumnAt(this.getColumnIndex(name));
    }
    getColumnIndex(name) {
        return this._schema.fields.findIndex((f) => f.name === name);
    }
    getChildAt(index) {
        if (index < 0 || index >= this.numChildren) {
            return null;
        }
        let field, child;
        const fields = this._schema.fields;
        const columns = this._children || (this._children = []);
        if (child = columns[index]) {
            return child;
        }
        if (field = fields[index]) {
            const chunks = this._chunks
                .map((chunk) => chunk.getChildAt(index))
                .filter((vec) => vec != null);
            if (chunks.length > 0) {
                return (columns[index] = new column_1.Column(field, chunks));
            }
        }
        return null;
    }
    // @ts-ignore
    serialize(encoding = 'binary', stream = true) {
        const writer = !stream
            ? writer_1.RecordBatchFileWriter
            : writer_1.RecordBatchStreamWriter;
        return writer.writeAll(this._chunks).toUint8Array(true);
    }
    count() {
        return this._length;
    }
    select(...columnNames) {
        const nameToIndex = this._schema.fields.reduce((m, f, i) => m.set(f.name, i), new Map());
        return this.selectAt(...columnNames.map((columnName) => nameToIndex.get(columnName)).filter((x) => x > -1));
    }
    selectAt(...columnIndices) {
        const schema = this._schema.selectAt(...columnIndices);
        return new Table(schema, this._chunks.map(({ length, data: { childData } }) => {
            return new recordbatch_1.RecordBatch(schema, length, columnIndices.map((i) => childData[i]).filter(Boolean));
        }));
    }
    assign(other) {
        const fields = this._schema.fields;
        const [indices, oldToNew] = other.schema.fields.reduce((memo, f2, newIdx) => {
            const [indices, oldToNew] = memo;
            const i = fields.findIndex((f) => f.compareTo(f2));
            ~i ? (oldToNew[i] = newIdx) : indices.push(newIdx);
            return memo;
        }, [[], []]);
        const schema = this._schema.assign(other.schema);
        const columns = [
            ...fields.map((_f, i, _fs, j = oldToNew[i]) => (j === undefined ? this.getColumnAt(i) : other.getColumnAt(j))),
            ...indices.map((i) => other.getColumnAt(i))
        ].filter(Boolean);
        return new Table(...recordbatch_3.distributeVectorsIntoRecordBatches(schema, columns));
    }
}
exports.Table = Table;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbkQsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBZSxDQUFDLENBQUM7UUFFM0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2pELE1BQU0sT0FBTyxHQUFHO1lBQ1osR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQzFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBRSxDQUFDO1lBQ3BFLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUUsQ0FBQztTQUMvQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQXlDLENBQUM7UUFFMUQsT0FBTyxJQUFJLEtBQUssQ0FBQyxHQUFHLGdEQUFrQyxDQUFRLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLENBQUM7Q0FDSjtBQXpMRCxzQkF5TEMiLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgRGF0YSB9IGZyb20gJy4vZGF0YSc7XG5pbXBvcnQgeyBDb2x1bW4gfSBmcm9tICcuL2NvbHVtbic7XG5pbXBvcnQgeyBTY2hlbWEsIEZpZWxkIH0gZnJvbSAnLi9zY2hlbWEnO1xuaW1wb3J0IHsgaXNQcm9taXNlIH0gZnJvbSAnLi91dGlsL2NvbXBhdCc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaCB9IGZyb20gJy4vcmVjb3JkYmF0Y2gnO1xuaW1wb3J0IHsgRGF0YUZyYW1lIH0gZnJvbSAnLi9jb21wdXRlL2RhdGFmcmFtZSc7XG5pbXBvcnQgeyBzZWxlY3RBbmRGbGF0dGVuIH0gZnJvbSAnLi91dGlsL2FycmF5JztcbmltcG9ydCB7IFJlY29yZEJhdGNoUmVhZGVyIH0gZnJvbSAnLi9pcGMvcmVhZGVyJztcbmltcG9ydCB7IFZlY3RvciwgQ2h1bmtlZCB9IGZyb20gJy4vdmVjdG9yL2luZGV4JztcbmltcG9ydCB7IERhdGFUeXBlLCBSb3dMaWtlLCBTdHJ1Y3QgfSBmcm9tICcuL3R5cGUnO1xuaW1wb3J0IHsgQ2xvbmFibGUsIFNsaWNlYWJsZSwgQXBwbGljYXRpdmUgfSBmcm9tICcuL3ZlY3Rvcic7XG5pbXBvcnQgeyBkaXN0cmlidXRlQ29sdW1uc0ludG9SZWNvcmRCYXRjaGVzIH0gZnJvbSAnLi91dGlsL3JlY29yZGJhdGNoJztcbmltcG9ydCB7IGRpc3RyaWJ1dGVWZWN0b3JzSW50b1JlY29yZEJhdGNoZXMgfSBmcm9tICcuL3V0aWwvcmVjb3JkYmF0Y2gnO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2hGaWxlV3JpdGVyLCBSZWNvcmRCYXRjaFN0cmVhbVdyaXRlciB9IGZyb20gJy4vaXBjL3dyaXRlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGFibGU8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+IHtcblxuICAgIGdldChpbmRleDogbnVtYmVyKTogU3RydWN0PFQ+WydUVmFsdWUnXTtcbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPFJvd0xpa2U8VD4+O1xuXG4gICAgc2xpY2UoYmVnaW4/OiBudW1iZXIsIGVuZD86IG51bWJlcik6IFRhYmxlPFQ+O1xuICAgIGNvbmNhdCguLi5vdGhlcnM6IFZlY3RvcjxTdHJ1Y3Q8VD4+W10pOiBUYWJsZTxUPjtcbiAgICBjbG9uZShjaHVua3M/OiBSZWNvcmRCYXRjaDxUPltdLCBvZmZzZXRzPzogVWludDMyQXJyYXkpOiBUYWJsZTxUPjtcblxuICAgIHNjYW4obmV4dDogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuTmV4dEZ1bmMsIGJpbmQ/OiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5CaW5kRnVuYyk6IHZvaWQ7XG4gICAgY291bnRCeShuYW1lOiBpbXBvcnQoJy4vY29tcHV0ZS9wcmVkaWNhdGUnKS5Db2wgfCBzdHJpbmcpOiBpbXBvcnQoJy4vY29tcHV0ZS9kYXRhZnJhbWUnKS5Db3VudEJ5UmVzdWx0O1xuICAgIGZpbHRlcihwcmVkaWNhdGU6IGltcG9ydCgnLi9jb21wdXRlL3ByZWRpY2F0ZScpLlByZWRpY2F0ZSk6IGltcG9ydCgnLi9jb21wdXRlL2RhdGFmcmFtZScpLkZpbHRlcmVkRGF0YUZyYW1lPFQ+O1xufVxuXG5leHBvcnQgY2xhc3MgVGFibGU8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+XG4gICAgZXh0ZW5kcyBDaHVua2VkPFN0cnVjdDxUPj5cbiAgICBpbXBsZW1lbnRzIERhdGFGcmFtZTxUPixcbiAgICAgICAgICAgICAgIENsb25hYmxlPFRhYmxlPFQ+PixcbiAgICAgICAgICAgICAgIFNsaWNlYWJsZTxUYWJsZTxUPj4sXG4gICAgICAgICAgICAgICBBcHBsaWNhdGl2ZTxTdHJ1Y3Q8VD4sIFRhYmxlPFQ+PiB7XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGVtcHR5PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PigpIHsgcmV0dXJuIG5ldyBUYWJsZTxUPihuZXcgU2NoZW1hKFtdKSwgW10pOyB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oKTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogUmVjb3JkQmF0Y2hSZWFkZXI8VD4pOiBUYWJsZTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmcwKTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMik6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzEpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmczKTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnNCk6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzUpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBQcm9taXNlTGlrZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj4pOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlPzogYW55KSB7XG5cbiAgICAgICAgaWYgKCFzb3VyY2UpIHsgcmV0dXJuIFRhYmxlLmVtcHR5PFQ+KCk7IH1cblxuICAgICAgICBsZXQgcmVhZGVyID0gUmVjb3JkQmF0Y2hSZWFkZXIuZnJvbTxUPihzb3VyY2UpIGFzIFJlY29yZEJhdGNoUmVhZGVyPFQ+IHwgUHJvbWlzZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj47XG5cbiAgICAgICAgaWYgKGlzUHJvbWlzZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj4ocmVhZGVyKSkge1xuICAgICAgICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiBhd2FpdCBUYWJsZS5mcm9tKGF3YWl0IHJlYWRlcikpKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlYWRlci5pc1N5bmMoKSAmJiAocmVhZGVyID0gcmVhZGVyLm9wZW4oKSkpIHtcbiAgICAgICAgICAgIHJldHVybiAhcmVhZGVyLnNjaGVtYSA/IFRhYmxlLmVtcHR5PFQ+KCkgOiBuZXcgVGFibGU8VD4ocmVhZGVyLnNjaGVtYSwgWy4uLnJlYWRlcl0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoYXN5bmMgKG9wZW5pbmcpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IGF3YWl0IG9wZW5pbmc7XG4gICAgICAgICAgICBjb25zdCBzY2hlbWEgPSByZWFkZXIuc2NoZW1hO1xuICAgICAgICAgICAgY29uc3QgYmF0Y2hlczogUmVjb3JkQmF0Y2hbXSA9IFtdO1xuICAgICAgICAgICAgaWYgKHNjaGVtYSkge1xuICAgICAgICAgICAgICAgIGZvciBhd2FpdCAobGV0IGJhdGNoIG9mIHJlYWRlcikge1xuICAgICAgICAgICAgICAgICAgICBiYXRjaGVzLnB1c2goYmF0Y2gpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRhYmxlPFQ+KHNjaGVtYSwgYmF0Y2hlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gVGFibGUuZW1wdHk8VD4oKTtcbiAgICAgICAgfSkocmVhZGVyLm9wZW4oKSk7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBmcm9tQXN5bmM8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJncyk6IFByb21pc2U8VGFibGU8VD4+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IFRhYmxlLmZyb208VD4oc291cmNlIGFzIGFueSk7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tVmVjdG9yczxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4odmVjdG9yczogVmVjdG9yPFRba2V5b2YgVF0+W10sIGZpZWxkcz86IChrZXlvZiBUIHwgRmllbGQ8VFtrZXlvZiBUXT4pW10pIHtcbiAgICAgICAgcmV0dXJuIFRhYmxlLm5ldzxUPih2ZWN0b3JzLCBmaWVsZHMpO1xuICAgIH1cblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbVN0cnVjdDxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oc3RydWN0OiBWZWN0b3I8U3RydWN0PFQ+Pikge1xuICAgICAgICByZXR1cm4gVGFibGUubmV3PFQ+KHN0cnVjdC5kYXRhLmNoaWxkRGF0YSBhcyBEYXRhPFRba2V5b2YgVF0+W10sIHN0cnVjdC50eXBlLmNoaWxkcmVuKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oY2h1bmtzOiAoRGF0YTxUW2tleW9mIFRdPiB8IFZlY3RvcjxUW2tleW9mIFRdPilbXSwgZmllbGRzPzogKGtleW9mIFQgfCBGaWVsZDxUW2tleW9mIFRdPilbXSk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlOyB9ID0gYW55PiguLi5jb2x1bW5zOiAoQ29sdW1uPFRba2V5b2YgVF0+IHwgQ29sdW1uPFRba2V5b2YgVF0+W10pW10pOiBUYWJsZTxUPjtcbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oLi4uYXJnczogYW55W10pOiBUYWJsZTxUPiB7XG4gICAgICAgIGxldCB4ID0gYXJnc1swXSwgY29sdW1uczogQ29sdW1uPFRba2V5b2YgVF0+W107XG4gICAgICAgIGlmICh4IGluc3RhbmNlb2YgQ29sdW1uIHx8IChBcnJheS5pc0FycmF5KHgpICYmICh4WzBdIGluc3RhbmNlb2YgQ29sdW1uKSkpIHtcbiAgICAgICAgICAgIGNvbHVtbnMgPSBzZWxlY3RBbmRGbGF0dGVuPENvbHVtbjxUW2tleW9mIFRdPj4oQ29sdW1uLCBhcmdzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IFtjaHVua3MsIGZpZWxkcyA9IFtdXSA9IGFyZ3MgYXMgW1xuICAgICAgICAgICAgICAgIChEYXRhPFRba2V5b2YgVF0+IHwgVmVjdG9yPFRba2V5b2YgVF0+KVtdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgKHN0cmluZyB8IEZpZWxkPFRba2V5b2YgVF0+KVtdXTtcbiAgICAgICAgICAgIGNvbHVtbnMgPSBjaHVua3MubWFwKChjaHVuaywgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgW2ldOiBuYW1lID0gYCR7aX1gfSA9IGZpZWxkcztcbiAgICAgICAgICAgICAgICBjb25zdCB2ID0gY2h1bmsgaW5zdGFuY2VvZiBEYXRhID8gVmVjdG9yLm5ldyhjaHVuaykgOiBjaHVuaztcbiAgICAgICAgICAgICAgICBjb25zdCBmID0gbmFtZSBpbnN0YW5jZW9mIEZpZWxkID8gbmFtZSBhcyBGaWVsZDxUW2tleW9mIFRdPiA6IG5ldyBGaWVsZChuYW1lLCBjaHVuay50eXBlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gQ29sdW1uLm5ldyhmLCBbdl0pIGFzIENvbHVtbjxUW2tleW9mIFRdPjtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgVGFibGUoLi4uZGlzdHJpYnV0ZUNvbHVtbnNJbnRvUmVjb3JkQmF0Y2hlcyhjb2x1bW5zKSk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3IoLi4uYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3Ioc2NoZW1hOiBTY2hlbWEsIGJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKHNjaGVtYTogU2NoZW1hLCAuLi5iYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvciguLi5hcmdzOiBhbnlbXSkge1xuXG4gICAgICAgIGxldCBzY2hlbWE6IFNjaGVtYSA9IG51bGwhO1xuXG4gICAgICAgIGlmIChhcmdzWzBdIGluc3RhbmNlb2YgU2NoZW1hKSB7IHNjaGVtYSA9IGFyZ3Muc2hpZnQoKTsgfVxuXG4gICAgICAgIGxldCBjaHVua3MgPSBzZWxlY3RBbmRGbGF0dGVuPFJlY29yZEJhdGNoPFQ+PihSZWNvcmRCYXRjaCwgYXJncyk7XG5cbiAgICAgICAgaWYgKCFzY2hlbWEgJiYgIShzY2hlbWEgPSBjaHVua3NbMF0gJiYgY2h1bmtzWzBdLnNjaGVtYSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RhYmxlIG11c3QgYmUgaW5pdGlhbGl6ZWQgd2l0aCBhIFNjaGVtYSBvciBhdCBsZWFzdCBvbmUgUmVjb3JkQmF0Y2gnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2h1bmtzWzBdKSB7IGNodW5rc1swXSA9IG5ldyBSZWNvcmRCYXRjaChzY2hlbWEsIDAsIFtdKTsgfVxuXG4gICAgICAgIHN1cGVyKGNodW5rc1swXS50eXBlLCBjaHVua3MpO1xuXG4gICAgICAgIHRoaXMuX3NjaGVtYSA9IHNjaGVtYTtcbiAgICAgICAgdGhpcy5fY2h1bmtzID0gY2h1bmtzO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfc2NoZW1hOiBTY2hlbWE8VD47XG4gICAgLy8gTGlzdCBvZiBpbm5lciBSZWNvcmRCYXRjaGVzXG4gICAgcHJvdGVjdGVkIF9jaHVua3M6IFJlY29yZEJhdGNoPFQ+W107XG4gICAgcHJvdGVjdGVkIF9jaGlsZHJlbj86IENvbHVtbjxUW2tleW9mIFRdPltdO1xuXG4gICAgcHVibGljIGdldCBzY2hlbWEoKSB7IHJldHVybiB0aGlzLl9zY2hlbWE7IH1cbiAgICBwdWJsaWMgZ2V0IGxlbmd0aCgpIHsgcmV0dXJuIHRoaXMuX2xlbmd0aDsgfVxuICAgIHB1YmxpYyBnZXQgY2h1bmtzKCkgeyByZXR1cm4gdGhpcy5fY2h1bmtzOyB9XG4gICAgcHVibGljIGdldCBudW1Db2xzKCkgeyByZXR1cm4gdGhpcy5fbnVtQ2hpbGRyZW47IH1cblxuICAgIHB1YmxpYyBjbG9uZShjaHVua3MgPSB0aGlzLl9jaHVua3MpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZTxUPih0aGlzLl9zY2hlbWEsIGNodW5rcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENvbHVtbkF0PFIgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4oaW5kZXg6IG51bWJlcik6IENvbHVtbjxSPiB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDaGlsZEF0KGluZGV4KTtcbiAgICB9XG4gICAgcHVibGljIGdldENvbHVtbjxSIGV4dGVuZHMga2V5b2YgVD4obmFtZTogUik6IENvbHVtbjxUW1JdPiB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDb2x1bW5BdCh0aGlzLmdldENvbHVtbkluZGV4KG5hbWUpKSBhcyBDb2x1bW48VFtSXT4gfCBudWxsO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q29sdW1uSW5kZXg8UiBleHRlbmRzIGtleW9mIFQ+KG5hbWU6IFIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYS5maWVsZHMuZmluZEluZGV4KChmKSA9PiBmLm5hbWUgPT09IG5hbWUpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q2hpbGRBdDxSIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+KGluZGV4OiBudW1iZXIpOiBDb2x1bW48Uj4gfCBudWxsIHtcbiAgICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLm51bUNoaWxkcmVuKSB7IHJldHVybiBudWxsOyB9XG4gICAgICAgIGxldCBmaWVsZDogRmllbGQ8Uj4sIGNoaWxkOiBDb2x1bW48Uj47XG4gICAgICAgIGNvbnN0IGZpZWxkcyA9ICh0aGlzLl9zY2hlbWEgYXMgU2NoZW1hPGFueT4pLmZpZWxkcztcbiAgICAgICAgY29uc3QgY29sdW1ucyA9IHRoaXMuX2NoaWxkcmVuIHx8ICh0aGlzLl9jaGlsZHJlbiA9IFtdKSBhcyBDb2x1bW5bXTtcbiAgICAgICAgaWYgKGNoaWxkID0gY29sdW1uc1tpbmRleF0pIHsgcmV0dXJuIGNoaWxkIGFzIENvbHVtbjxSPjsgfVxuICAgICAgICBpZiAoZmllbGQgPSBmaWVsZHNbaW5kZXhdKSB7XG4gICAgICAgICAgICBjb25zdCBjaHVua3MgPSB0aGlzLl9jaHVua3NcbiAgICAgICAgICAgICAgICAubWFwKChjaHVuaykgPT4gY2h1bmsuZ2V0Q2hpbGRBdDxSPihpbmRleCkpXG4gICAgICAgICAgICAgICAgLmZpbHRlcigodmVjKTogdmVjIGlzIFZlY3RvcjxSPiA9PiB2ZWMgIT0gbnVsbCk7XG4gICAgICAgICAgICBpZiAoY2h1bmtzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKGNvbHVtbnNbaW5kZXhdID0gbmV3IENvbHVtbjxSPihmaWVsZCwgY2h1bmtzKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHB1YmxpYyBzZXJpYWxpemUoZW5jb2RpbmcgPSAnYmluYXJ5Jywgc3RyZWFtID0gdHJ1ZSkge1xuICAgICAgICBjb25zdCB3cml0ZXIgPSAhc3RyZWFtXG4gICAgICAgICAgICA/IFJlY29yZEJhdGNoRmlsZVdyaXRlclxuICAgICAgICAgICAgOiBSZWNvcmRCYXRjaFN0cmVhbVdyaXRlcjtcbiAgICAgICAgcmV0dXJuIHdyaXRlci53cml0ZUFsbCh0aGlzLl9jaHVua3MpLnRvVWludDhBcnJheSh0cnVlKTtcbiAgICB9XG4gICAgcHVibGljIGNvdW50KCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9sZW5ndGg7XG4gICAgfVxuICAgIHB1YmxpYyBzZWxlY3Q8SyBleHRlbmRzIGtleW9mIFQgPSBhbnk+KC4uLmNvbHVtbk5hbWVzOiBLW10pIHtcbiAgICAgICAgY29uc3QgbmFtZVRvSW5kZXggPSB0aGlzLl9zY2hlbWEuZmllbGRzLnJlZHVjZSgobSwgZiwgaSkgPT4gbS5zZXQoZi5uYW1lIGFzIEssIGkpLCBuZXcgTWFwPEssIG51bWJlcj4oKSk7XG4gICAgICAgIHJldHVybiB0aGlzLnNlbGVjdEF0KC4uLmNvbHVtbk5hbWVzLm1hcCgoY29sdW1uTmFtZSkgPT4gbmFtZVRvSW5kZXguZ2V0KGNvbHVtbk5hbWUpISkuZmlsdGVyKCh4KSA9PiB4ID4gLTEpKTtcbiAgICB9XG4gICAgcHVibGljIHNlbGVjdEF0PEsgZXh0ZW5kcyBUW2tleW9mIFRdID0gYW55PiguLi5jb2x1bW5JbmRpY2VzOiBudW1iZXJbXSkge1xuICAgICAgICBjb25zdCBzY2hlbWEgPSB0aGlzLl9zY2hlbWEuc2VsZWN0QXQ8Sz4oLi4uY29sdW1uSW5kaWNlcyk7XG4gICAgICAgIHJldHVybiBuZXcgVGFibGUoc2NoZW1hLCB0aGlzLl9jaHVua3MubWFwKCh7IGxlbmd0aCwgZGF0YTogeyBjaGlsZERhdGEgfSB9KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFJlY29yZEJhdGNoKHNjaGVtYSwgbGVuZ3RoLCBjb2x1bW5JbmRpY2VzLm1hcCgoaSkgPT4gY2hpbGREYXRhW2ldKS5maWx0ZXIoQm9vbGVhbikpO1xuICAgICAgICB9KSk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3NpZ248UiBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4ob3RoZXI6IFRhYmxlPFI+KSB7XG5cbiAgICAgICAgY29uc3QgZmllbGRzID0gdGhpcy5fc2NoZW1hLmZpZWxkcztcbiAgICAgICAgY29uc3QgW2luZGljZXMsIG9sZFRvTmV3XSA9IG90aGVyLnNjaGVtYS5maWVsZHMucmVkdWNlKChtZW1vLCBmMiwgbmV3SWR4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBbaW5kaWNlcywgb2xkVG9OZXddID0gbWVtbztcbiAgICAgICAgICAgIGNvbnN0IGkgPSBmaWVsZHMuZmluZEluZGV4KChmKSA9PiBmLmNvbXBhcmVUbyhmMikpO1xuICAgICAgICAgICAgfmkgPyAob2xkVG9OZXdbaV0gPSBuZXdJZHgpIDogaW5kaWNlcy5wdXNoKG5ld0lkeCk7XG4gICAgICAgICAgICByZXR1cm4gbWVtbztcbiAgICAgICAgfSwgW1tdLCBbXV0gYXMgbnVtYmVyW11bXSk7XG5cbiAgICAgICAgY29uc3Qgc2NoZW1hID0gdGhpcy5fc2NoZW1hLmFzc2lnbihvdGhlci5zY2hlbWEpO1xuICAgICAgICBjb25zdCBjb2x1bW5zID0gW1xuICAgICAgICAgICAgLi4uZmllbGRzLm1hcCgoX2YsIGksIF9mcywgaiA9IG9sZFRvTmV3W2ldKSA9PlxuICAgICAgICAgICAgICAgIChqID09PSB1bmRlZmluZWQgPyB0aGlzLmdldENvbHVtbkF0KGkpIDogb3RoZXIuZ2V0Q29sdW1uQXQoaikpISksXG4gICAgICAgICAgICAuLi5pbmRpY2VzLm1hcCgoaSkgPT4gb3RoZXIuZ2V0Q29sdW1uQXQoaSkhKVxuICAgICAgICBdLmZpbHRlcihCb29sZWFuKSBhcyBDb2x1bW48KFQgJiBSKVtrZXlvZiBUIHwga2V5b2YgUl0+W107XG5cbiAgICAgICAgcmV0dXJuIG5ldyBUYWJsZSguLi5kaXN0cmlidXRlVmVjdG9yc0ludG9SZWNvcmRCYXRjaGVzPFQgJiBSPihzY2hlbWEsIGNvbHVtbnMpKTtcbiAgICB9XG59XG4iXX0=
