// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import streamAdapters from './io/adapters';
import { RecordBatchReader } from './ipc/reader';
import { RecordBatchWriter } from './ipc/writer';
import { isIterable, isAsyncIterable } from './util/compat';
import { AsyncByteStream, AsyncByteQueue } from './io/stream';
streamAdapters.toReadableDOMStream = toReadableDOMStream;
RecordBatchReader['throughDOM'] = recordBatchReaderThroughDOMStream;
RecordBatchWriter['throughDOM'] = recordBatchWriterThroughDOMStream;
export { ArrowType, DateUnit, IntervalUnit, MessageHeader, MetadataVersion, Precision, TimeUnit, Type, UnionMode, VectorType, Data, DataType, Null, Bool, Int, Int8, Int16, Int32, Int64, Uint8, Uint16, Uint32, Uint64, Float, Float16, Float32, Float64, Utf8, Binary, FixedSizeBinary, Date_, DateDay, DateMillisecond, Timestamp, TimestampSecond, TimestampMillisecond, TimestampMicrosecond, TimestampNanosecond, Time, TimeSecond, TimeMillisecond, TimeMicrosecond, TimeNanosecond, Decimal, List, Struct, Union, DenseUnion, SparseUnion, Dictionary, Interval, IntervalDayTime, IntervalYearMonth, FixedSizeList, Map_, Table, Column, Schema, Field, Visitor, Vector, BaseVector, BinaryVector, BoolVector, ChunkedVector, DateVector, DateDayVector, DateMillisecondVector, DecimalVector, DictionaryVector, FixedSizeBinaryVector, FixedSizeListVector, FloatVector, Float16Vector, Float32Vector, Float64Vector, IntervalVector, IntervalDayTimeVector, IntervalYearMonthVector, IntVector, Int8Vector, Int16Vector, Int32Vector, Int64Vector, Uint8Vector, Uint16Vector, Uint32Vector, Uint64Vector, ListVector, MapVector, NullVector, StructVector, TimestampVector, TimestampSecondVector, TimestampMillisecondVector, TimestampMicrosecondVector, TimestampNanosecondVector, TimeVector, TimeSecondVector, TimeMillisecondVector, TimeMicrosecondVector, TimeNanosecondVector, UnionVector, DenseUnionVector, SparseUnionVector, Utf8Vector, ByteStream, AsyncByteStream, AsyncByteQueue, RecordBatchReader, RecordBatchFileReader, RecordBatchStreamReader, AsyncRecordBatchFileReader, AsyncRecordBatchStreamReader, RecordBatchWriter, RecordBatchFileWriter, RecordBatchStreamWriter, MessageReader, AsyncMessageReader, JSONMessageReader, Message, RecordBatch, Dataframe, FilteredDataFrame, CountByResult, predicate, util } from './Arrow';
function recordBatchReaderThroughDOMStream() {
    const through = new AsyncByteQueue();
    let reader = null;
    const readable = new ReadableStream({
        async cancel() { await through.close(); },
        async start(controller) { await next(controller, reader || (reader = await open())); },
        async pull(controller) { reader ? await next(controller, reader) : controller.close(); }
    });
    return { writable: new WritableStream(through), readable };
    async function open() {
        return await (await RecordBatchReader.from(through)).open();
    }
    async function next(controller, reader) {
        let size = controller.desiredSize;
        let r = null;
        while (!(r = await reader.next()).done) {
            controller.enqueue(r.value);
            if (size != null && --size <= 0) {
                return;
            }
        }
        controller.close();
    }
}
function recordBatchWriterThroughDOMStream(writableStrategy, readableStrategy) {
    const through = new AsyncByteQueue();
    const writer = new this().reset(through);
    const reader = new AsyncByteStream(through);
    const readable = new ReadableStream({
        type: 'bytes',
        async cancel() { await through.close(); },
        async pull(controller) { await next(controller); },
        async start(controller) { await next(controller); },
    }, readableStrategy);
    return { writable: new WritableStream(writer, writableStrategy), readable };
    async function next(controller) {
        let buf = null;
        let size = controller.desiredSize;
        while (buf = await reader.read(size || null)) {
            // Work around https://github.com/whatwg/streams/blob/0ebe4b042e467d9876d80ae045de3843092ad797/reference-implementation/lib/helpers.js#L126
            controller.enqueue((buf.buffer.byteLength !== 0) ? buf : buf.slice());
            if (size != null && (size -= buf.byteLength) <= 0) {
                return;
            }
        }
        controller.close();
    }
}
function toReadableDOMStream(source, options) {
    if (isAsyncIterable(source)) {
        return asyncIterableAsReadableDOMStream(source, options);
    }
    if (isIterable(source)) {
        return iterableAsReadableDOMStream(source, options);
    }
    throw new Error(`toReadableDOMStream() must be called with an Iterable or AsyncIterable`);
}
function iterableAsReadableDOMStream(source, options) {
    let it = null;
    return new ReadableStream({
        ...options,
        start(controller) { next(controller, it || (it = source[Symbol.iterator]())); },
        pull(controller) { it ? (next(controller, it)) : controller.close(); },
        cancel() { (it && (it.return && it.return()) || true) && (it = null); }
    });
    function next(controller, it) {
        let size = controller.desiredSize;
        let r = null;
        while ((size == null || size-- > 0) && !(r = it.next()).done) {
            controller.enqueue(r.value);
        }
        r && r.done && controller.close();
    }
}
function asyncIterableAsReadableDOMStream(source, options) {
    let it = null;
    return new ReadableStream({
        ...options,
        async start(controller) { await next(controller, it || (it = source[Symbol.asyncIterator]())); },
        async pull(controller) { it ? (await next(controller, it)) : controller.close(); },
        async cancel() { (it && (it.return && await it.return()) || true) && (it = null); },
    });
    async function next(controller, it) {
        let size = controller.desiredSize;
        let r = null;
        while ((size == null || size-- > 0) && !(r = await it.next()).done) {
            controller.enqueue(r.value);
        }
        r && r.done && controller.close();
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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ZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBEYXRhVHlwZSB9IGZyb20gJy4vdHlwZSc7XG5pbXBvcnQgc3RyZWFtQWRhcHRlcnMgZnJvbSAnLi9pby9hZGFwdGVycyc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaCB9IGZyb20gJy4vcmVjb3JkYmF0Y2gnO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2hSZWFkZXIgfSBmcm9tICcuL2lwYy9yZWFkZXInO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2hXcml0ZXIgfSBmcm9tICcuL2lwYy93cml0ZXInO1xuaW1wb3J0IHsgUmVhZGFibGVET01TdHJlYW1PcHRpb25zIH0gZnJvbSAnLi9pby9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGlzSXRlcmFibGUsIGlzQXN5bmNJdGVyYWJsZSB9IGZyb20gJy4vdXRpbC9jb21wYXQnO1xuaW1wb3J0IHsgQXN5bmNCeXRlU3RyZWFtLCBBc3luY0J5dGVRdWV1ZSB9IGZyb20gJy4vaW8vc3RyZWFtJztcblxuc3RyZWFtQWRhcHRlcnMudG9SZWFkYWJsZURPTVN0cmVhbSA9IHRvUmVhZGFibGVET01TdHJlYW07XG5SZWNvcmRCYXRjaFJlYWRlclsndGhyb3VnaERPTSddID0gcmVjb3JkQmF0Y2hSZWFkZXJUaHJvdWdoRE9NU3RyZWFtO1xuUmVjb3JkQmF0Y2hXcml0ZXJbJ3Rocm91Z2hET00nXSA9IHJlY29yZEJhdGNoV3JpdGVyVGhyb3VnaERPTVN0cmVhbTtcblxuZXhwb3J0IHtcbiAgICBBcnJvd1R5cGUsIERhdGVVbml0LCBJbnRlcnZhbFVuaXQsIE1lc3NhZ2VIZWFkZXIsIE1ldGFkYXRhVmVyc2lvbiwgUHJlY2lzaW9uLCBUaW1lVW5pdCwgVHlwZSwgVW5pb25Nb2RlLCBWZWN0b3JUeXBlLFxuICAgIERhdGEsXG4gICAgRGF0YVR5cGUsXG4gICAgTnVsbCxcbiAgICBCb29sLFxuICAgIEludCwgSW50OCwgSW50MTYsIEludDMyLCBJbnQ2NCwgVWludDgsIFVpbnQxNiwgVWludDMyLCBVaW50NjQsXG4gICAgRmxvYXQsIEZsb2F0MTYsIEZsb2F0MzIsIEZsb2F0NjQsXG4gICAgVXRmOCxcbiAgICBCaW5hcnksXG4gICAgRml4ZWRTaXplQmluYXJ5LFxuICAgIERhdGVfLCBEYXRlRGF5LCBEYXRlTWlsbGlzZWNvbmQsXG4gICAgVGltZXN0YW1wLCBUaW1lc3RhbXBTZWNvbmQsIFRpbWVzdGFtcE1pbGxpc2Vjb25kLCBUaW1lc3RhbXBNaWNyb3NlY29uZCwgVGltZXN0YW1wTmFub3NlY29uZCxcbiAgICBUaW1lLCBUaW1lU2Vjb25kLCBUaW1lTWlsbGlzZWNvbmQsIFRpbWVNaWNyb3NlY29uZCwgVGltZU5hbm9zZWNvbmQsXG4gICAgRGVjaW1hbCxcbiAgICBMaXN0LFxuICAgIFN0cnVjdCxcbiAgICBVbmlvbiwgRGVuc2VVbmlvbiwgU3BhcnNlVW5pb24sXG4gICAgRGljdGlvbmFyeSxcbiAgICBJbnRlcnZhbCwgSW50ZXJ2YWxEYXlUaW1lLCBJbnRlcnZhbFllYXJNb250aCxcbiAgICBGaXhlZFNpemVMaXN0LFxuICAgIE1hcF8sXG4gICAgVGFibGUsIERhdGFGcmFtZSxcbiAgICBDb2x1bW4sXG4gICAgU2NoZW1hLCBGaWVsZCxcbiAgICBWaXNpdG9yLFxuICAgIFZlY3RvcixcbiAgICBCYXNlVmVjdG9yLFxuICAgIEJpbmFyeVZlY3RvcixcbiAgICBCb29sVmVjdG9yLFxuICAgIENodW5rZWRWZWN0b3IsXG4gICAgRGF0ZVZlY3RvciwgRGF0ZURheVZlY3RvciwgRGF0ZU1pbGxpc2Vjb25kVmVjdG9yLFxuICAgIERlY2ltYWxWZWN0b3IsXG4gICAgRGljdGlvbmFyeVZlY3RvcixcbiAgICBGaXhlZFNpemVCaW5hcnlWZWN0b3IsXG4gICAgRml4ZWRTaXplTGlzdFZlY3RvcixcbiAgICBGbG9hdFZlY3RvciwgRmxvYXQxNlZlY3RvciwgRmxvYXQzMlZlY3RvciwgRmxvYXQ2NFZlY3RvcixcbiAgICBJbnRlcnZhbFZlY3RvciwgSW50ZXJ2YWxEYXlUaW1lVmVjdG9yLCBJbnRlcnZhbFllYXJNb250aFZlY3RvcixcbiAgICBJbnRWZWN0b3IsIEludDhWZWN0b3IsIEludDE2VmVjdG9yLCBJbnQzMlZlY3RvciwgSW50NjRWZWN0b3IsIFVpbnQ4VmVjdG9yLCBVaW50MTZWZWN0b3IsIFVpbnQzMlZlY3RvciwgVWludDY0VmVjdG9yLFxuICAgIExpc3RWZWN0b3IsXG4gICAgTWFwVmVjdG9yLFxuICAgIE51bGxWZWN0b3IsXG4gICAgU3RydWN0VmVjdG9yLFxuICAgIFRpbWVzdGFtcFZlY3RvciwgVGltZXN0YW1wU2Vjb25kVmVjdG9yLCBUaW1lc3RhbXBNaWxsaXNlY29uZFZlY3RvciwgVGltZXN0YW1wTWljcm9zZWNvbmRWZWN0b3IsIFRpbWVzdGFtcE5hbm9zZWNvbmRWZWN0b3IsXG4gICAgVGltZVZlY3RvciwgVGltZVNlY29uZFZlY3RvciwgVGltZU1pbGxpc2Vjb25kVmVjdG9yLCBUaW1lTWljcm9zZWNvbmRWZWN0b3IsIFRpbWVOYW5vc2Vjb25kVmVjdG9yLFxuICAgIFVuaW9uVmVjdG9yLCBEZW5zZVVuaW9uVmVjdG9yLCBTcGFyc2VVbmlvblZlY3RvcixcbiAgICBVdGY4VmVjdG9yLFxuICAgIEJ5dGVTdHJlYW0sIEFzeW5jQnl0ZVN0cmVhbSwgQXN5bmNCeXRlUXVldWUsIFJlYWRhYmxlU291cmNlLCBXcml0YWJsZVNpbmssXG4gICAgUmVjb3JkQmF0Y2hSZWFkZXIsIFJlY29yZEJhdGNoRmlsZVJlYWRlciwgUmVjb3JkQmF0Y2hTdHJlYW1SZWFkZXIsIEFzeW5jUmVjb3JkQmF0Y2hGaWxlUmVhZGVyLCBBc3luY1JlY29yZEJhdGNoU3RyZWFtUmVhZGVyLFxuICAgIFJlY29yZEJhdGNoV3JpdGVyLCBSZWNvcmRCYXRjaEZpbGVXcml0ZXIsIFJlY29yZEJhdGNoU3RyZWFtV3JpdGVyLFxuICAgIE1lc3NhZ2VSZWFkZXIsIEFzeW5jTWVzc2FnZVJlYWRlciwgSlNPTk1lc3NhZ2VSZWFkZXIsXG4gICAgTWVzc2FnZSxcbiAgICBSZWNvcmRCYXRjaCxcbiAgICBBcnJvd0pTT05MaWtlLCBGaWxlSGFuZGxlLCBSZWFkYWJsZSwgV3JpdGFibGUsIFJlYWRhYmxlV3JpdGFibGUsIFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyxcbiAgICBEYXRhZnJhbWUsIEZpbHRlcmVkRGF0YUZyYW1lLCBDb3VudEJ5UmVzdWx0LCBCaW5kRnVuYywgTmV4dEZ1bmMsXG4gICAgcHJlZGljYXRlLFxuICAgIHV0aWxcbn0gZnJvbSAnLi9BcnJvdyc7XG5cbmZ1bmN0aW9uIHJlY29yZEJhdGNoUmVhZGVyVGhyb3VnaERPTVN0cmVhbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PigpIHtcblxuICAgIGNvbnN0IHRocm91Z2ggPSBuZXcgQXN5bmNCeXRlUXVldWUoKTtcbiAgICBsZXQgcmVhZGVyOiBSZWNvcmRCYXRjaFJlYWRlcjxUPiB8IG51bGwgPSBudWxsO1xuXG4gICAgY29uc3QgcmVhZGFibGUgPSBuZXcgUmVhZGFibGVTdHJlYW08UmVjb3JkQmF0Y2g8VD4+KHtcbiAgICAgICAgYXN5bmMgY2FuY2VsKCkgeyBhd2FpdCB0aHJvdWdoLmNsb3NlKCk7IH0sXG4gICAgICAgIGFzeW5jIHN0YXJ0KGNvbnRyb2xsZXIpIHsgYXdhaXQgbmV4dChjb250cm9sbGVyLCByZWFkZXIgfHwgKHJlYWRlciA9IGF3YWl0IG9wZW4oKSkpOyB9LFxuICAgICAgICBhc3luYyBwdWxsKGNvbnRyb2xsZXIpIHsgcmVhZGVyID8gYXdhaXQgbmV4dChjb250cm9sbGVyLCByZWFkZXIpIDogY29udHJvbGxlci5jbG9zZSgpOyB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4geyB3cml0YWJsZTogbmV3IFdyaXRhYmxlU3RyZWFtKHRocm91Z2gpLCByZWFkYWJsZSB9O1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gb3BlbigpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IChhd2FpdCBSZWNvcmRCYXRjaFJlYWRlci5mcm9tKHRocm91Z2gpKS5vcGVuKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZnVuY3Rpb24gbmV4dChjb250cm9sbGVyOiBSZWFkYWJsZVN0cmVhbURlZmF1bHRDb250cm9sbGVyPFJlY29yZEJhdGNoPFQ+PiwgcmVhZGVyOiBSZWNvcmRCYXRjaFJlYWRlcjxUPikge1xuICAgICAgICBsZXQgc2l6ZSA9IGNvbnRyb2xsZXIuZGVzaXJlZFNpemU7XG4gICAgICAgIGxldCByOiBJdGVyYXRvclJlc3VsdDxSZWNvcmRCYXRjaDxUPj4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgd2hpbGUgKCEociA9IGF3YWl0IHJlYWRlci5uZXh0KCkpLmRvbmUpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShyLnZhbHVlKTtcbiAgICAgICAgICAgIGlmIChzaXplICE9IG51bGwgJiYgLS1zaXplIDw9IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29udHJvbGxlci5jbG9zZSgpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcmVjb3JkQmF0Y2hXcml0ZXJUaHJvdWdoRE9NU3RyZWFtPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KFxuICAgIHRoaXM6IHR5cGVvZiBSZWNvcmRCYXRjaFdyaXRlcixcbiAgICB3cml0YWJsZVN0cmF0ZWd5PzogUXVldWluZ1N0cmF0ZWd5PFJlY29yZEJhdGNoPFQ+PixcbiAgICByZWFkYWJsZVN0cmF0ZWd5PzogeyBoaWdoV2F0ZXJNYXJrPzogbnVtYmVyLCBzaXplPzogYW55IH1cbikge1xuXG4gICAgY29uc3QgdGhyb3VnaCA9IG5ldyBBc3luY0J5dGVRdWV1ZSgpO1xuICAgIGNvbnN0IHdyaXRlciA9IG5ldyB0aGlzPFQ+KCkucmVzZXQodGhyb3VnaCk7XG4gICAgY29uc3QgcmVhZGVyID0gbmV3IEFzeW5jQnl0ZVN0cmVhbSh0aHJvdWdoKTtcbiAgICBjb25zdCByZWFkYWJsZSA9IG5ldyBSZWFkYWJsZVN0cmVhbSh7XG4gICAgICAgIHR5cGU6ICdieXRlcycsXG4gICAgICAgIGFzeW5jIGNhbmNlbCgpIHsgYXdhaXQgdGhyb3VnaC5jbG9zZSgpOyB9LFxuICAgICAgICBhc3luYyBwdWxsKGNvbnRyb2xsZXIpIHsgYXdhaXQgbmV4dChjb250cm9sbGVyKTsgfSxcbiAgICAgICAgYXN5bmMgc3RhcnQoY29udHJvbGxlcikgeyBhd2FpdCBuZXh0KGNvbnRyb2xsZXIpOyB9LFxuICAgIH0sIHJlYWRhYmxlU3RyYXRlZ3kpO1xuXG4gICAgcmV0dXJuIHsgd3JpdGFibGU6IG5ldyBXcml0YWJsZVN0cmVhbSh3cml0ZXIsIHdyaXRhYmxlU3RyYXRlZ3kpLCByZWFkYWJsZSB9O1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gbmV4dChjb250cm9sbGVyOiBSZWFkYWJsZVN0cmVhbURlZmF1bHRDb250cm9sbGVyPFVpbnQ4QXJyYXk+KSB7XG4gICAgICAgIGxldCBidWY6IFVpbnQ4QXJyYXkgfCBudWxsID0gbnVsbDtcbiAgICAgICAgbGV0IHNpemUgPSBjb250cm9sbGVyLmRlc2lyZWRTaXplO1xuICAgICAgICB3aGlsZSAoYnVmID0gYXdhaXQgcmVhZGVyLnJlYWQoc2l6ZSB8fCBudWxsKSkge1xuICAgICAgICAgICAgLy8gV29yayBhcm91bmQgaHR0cHM6Ly9naXRodWIuY29tL3doYXR3Zy9zdHJlYW1zL2Jsb2IvMGViZTRiMDQyZTQ2N2Q5ODc2ZDgwYWUwNDVkZTM4NDMwOTJhZDc5Ny9yZWZlcmVuY2UtaW1wbGVtZW50YXRpb24vbGliL2hlbHBlcnMuanMjTDEyNlxuICAgICAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKChidWYuYnVmZmVyLmJ5dGVMZW5ndGggIT09IDApID8gYnVmIDogYnVmLnNsaWNlKCkpO1xuICAgICAgICAgICAgaWYgKHNpemUgIT0gbnVsbCAmJiAoc2l6ZSAtPSBidWYuYnl0ZUxlbmd0aCkgPD0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb250cm9sbGVyLmNsb3NlKCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiB0b1JlYWRhYmxlRE9NU3RyZWFtPFQ+KHNvdXJjZTogSXRlcmFibGU8VD4gfCBBc3luY0l0ZXJhYmxlPFQ+LCBvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKTogUmVhZGFibGVTdHJlYW08VD4ge1xuICAgIGlmIChpc0FzeW5jSXRlcmFibGU8VD4oc291cmNlKSkgeyByZXR1cm4gYXN5bmNJdGVyYWJsZUFzUmVhZGFibGVET01TdHJlYW0oc291cmNlLCBvcHRpb25zKTsgfVxuICAgIGlmIChpc0l0ZXJhYmxlPFQ+KHNvdXJjZSkpIHsgcmV0dXJuIGl0ZXJhYmxlQXNSZWFkYWJsZURPTVN0cmVhbShzb3VyY2UsIG9wdGlvbnMpOyB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGB0b1JlYWRhYmxlRE9NU3RyZWFtKCkgbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBJdGVyYWJsZSBvciBBc3luY0l0ZXJhYmxlYCk7XG59XG5cbmZ1bmN0aW9uIGl0ZXJhYmxlQXNSZWFkYWJsZURPTVN0cmVhbTxUPihzb3VyY2U6IEl0ZXJhYmxlPFQ+LCBvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKSB7XG5cbiAgICBsZXQgaXQ6IEl0ZXJhdG9yPFQ+IHwgbnVsbCA9IG51bGw7XG5cbiAgICByZXR1cm4gbmV3IFJlYWRhYmxlU3RyZWFtPFQ+KHtcbiAgICAgICAgLi4ub3B0aW9ucyBhcyBhbnksXG4gICAgICAgIHN0YXJ0KGNvbnRyb2xsZXIpIHsgbmV4dChjb250cm9sbGVyLCBpdCB8fCAoaXQgPSBzb3VyY2VbU3ltYm9sLml0ZXJhdG9yXSgpKSk7IH0sXG4gICAgICAgIHB1bGwoY29udHJvbGxlcikgeyBpdCA/IChuZXh0KGNvbnRyb2xsZXIsIGl0KSkgOiBjb250cm9sbGVyLmNsb3NlKCk7IH0sXG4gICAgICAgIGNhbmNlbCgpIHsgKGl0ICYmIChpdC5yZXR1cm4gJiYgaXQucmV0dXJuKCkpIHx8IHRydWUpICYmIChpdCA9IG51bGwpOyB9XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBuZXh0KGNvbnRyb2xsZXI6IFJlYWRhYmxlU3RyZWFtRGVmYXVsdENvbnRyb2xsZXI8VD4sIGl0OiBJdGVyYXRvcjxUPikge1xuICAgICAgICBsZXQgc2l6ZSA9IGNvbnRyb2xsZXIuZGVzaXJlZFNpemU7XG4gICAgICAgIGxldCByOiBJdGVyYXRvclJlc3VsdDxUPiB8IG51bGwgPSBudWxsO1xuICAgICAgICB3aGlsZSAoKHNpemUgPT0gbnVsbCB8fCBzaXplLS0gPiAwKSAmJiAhKHIgPSBpdC5uZXh0KCkpLmRvbmUpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShyLnZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICByICYmIHIuZG9uZSAmJiBjb250cm9sbGVyLmNsb3NlKCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBhc3luY0l0ZXJhYmxlQXNSZWFkYWJsZURPTVN0cmVhbTxUPihzb3VyY2U6IEFzeW5jSXRlcmFibGU8VD4sIG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpIHtcblxuICAgIGxldCBpdDogQXN5bmNJdGVyYXRvcjxUPiB8IG51bGwgPSBudWxsO1xuXG4gICAgcmV0dXJuIG5ldyBSZWFkYWJsZVN0cmVhbTxUPih7XG4gICAgICAgIC4uLm9wdGlvbnMgYXMgYW55LFxuICAgICAgICBhc3luYyBzdGFydChjb250cm9sbGVyKSB7IGF3YWl0IG5leHQoY29udHJvbGxlciwgaXQgfHwgKGl0ID0gc291cmNlW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpKSk7IH0sXG4gICAgICAgIGFzeW5jIHB1bGwoY29udHJvbGxlcikgeyBpdCA/IChhd2FpdCBuZXh0KGNvbnRyb2xsZXIsIGl0KSkgOiBjb250cm9sbGVyLmNsb3NlKCk7IH0sXG4gICAgICAgIGFzeW5jIGNhbmNlbCgpIHsgKGl0ICYmIChpdC5yZXR1cm4gJiYgYXdhaXQgaXQucmV0dXJuKCkpIHx8IHRydWUpICYmIChpdCA9IG51bGwpOyB9LFxuICAgIH0pO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gbmV4dChjb250cm9sbGVyOiBSZWFkYWJsZVN0cmVhbURlZmF1bHRDb250cm9sbGVyPFQ+LCBpdDogQXN5bmNJdGVyYXRvcjxUPikge1xuICAgICAgICBsZXQgc2l6ZSA9IGNvbnRyb2xsZXIuZGVzaXJlZFNpemU7XG4gICAgICAgIGxldCByOiBJdGVyYXRvclJlc3VsdDxUPiB8IG51bGwgPSBudWxsO1xuICAgICAgICB3aGlsZSAoKHNpemUgPT0gbnVsbCB8fCBzaXplLS0gPiAwKSAmJiAhKHIgPSBhd2FpdCBpdC5uZXh0KCkpLmRvbmUpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShyLnZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICByICYmIHIuZG9uZSAmJiBjb250cm9sbGVyLmNsb3NlKCk7XG4gICAgfVxufVxuIl19
