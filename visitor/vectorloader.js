"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const text_encoding_utf_8_1 = require("text-encoding-utf-8");
const data_1 = require("../data");
const schema_1 = require("../schema");
const type_1 = require("../type");
const visitor_1 = require("../visitor");
const bit_1 = require("../util/bit");
const int_1 = require("../util/int");
const enum_1 = require("../enum");
const buffer_1 = require("../util/buffer");
const utf8Encoder = new text_encoding_utf_8_1.TextEncoder('utf-8');
class VectorLoader extends visitor_1.Visitor {
    constructor(bytes, nodes, buffers) {
        super();
        this.nodesIndex = -1;
        this.buffersIndex = -1;
        this.bytes = bytes;
        this.nodes = nodes;
        this.buffers = buffers;
    }
    visit(node) {
        return super.visit(node instanceof schema_1.Field ? node.type : node);
    }
    visitNull(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Null(type, 0, length, nullCount, this.readNullBitmap(type, nullCount)); }
    visitBool(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Bool(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitInt(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Int(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitFloat(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Float(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitUtf8(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Utf8(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.readData(type)); }
    visitBinary(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Binary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.readData(type)); }
    visitFixedSizeBinary(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.FixedSizeBinary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitDate(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Date(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitTimestamp(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Timestamp(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitTime(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Time(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitDecimal(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Decimal(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitList(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.List(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.visit(type.children[0])); }
    visitStruct(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Struct(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visitMany(type.children)); }
    visitUnion(type) { return type.mode === enum_1.UnionMode.Sparse ? this.visitSparseUnion(type) : this.visitDenseUnion(type); }
    visitDenseUnion(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Union(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readTypeIds(type), this.readOffsets(type), this.visitMany(type.children)); }
    visitSparseUnion(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Union(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readTypeIds(type), this.visitMany(type.children)); }
    visitDictionary(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Dictionary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type.indices)); }
    visitInterval(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Interval(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitFixedSizeList(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.FixedSizeList(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visit(type.children[0])); }
    visitMap(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Map(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visitMany(type.children)); }
    nextFieldNode() { return this.nodes[++this.nodesIndex]; }
    nextBufferRange() { return this.buffers[++this.buffersIndex]; }
    readNullBitmap(type, nullCount, buffer = this.nextBufferRange()) {
        return nullCount > 0 && this.readData(type, buffer) || new Uint8Array(0);
    }
    readOffsets(type, buffer) { return this.readData(type, buffer); }
    readTypeIds(type, buffer) { return this.readData(type, buffer); }
    readData(_type, { length, offset } = this.nextBufferRange()) {
        return this.bytes.subarray(offset, offset + length);
    }
}
exports.VectorLoader = VectorLoader;
class JSONVectorLoader extends VectorLoader {
    constructor(sources, nodes, buffers) {
        super(new Uint8Array(0), nodes, buffers);
        this.sources = sources;
    }
    readNullBitmap(_type, nullCount, { offset } = this.nextBufferRange()) {
        return nullCount <= 0 ? new Uint8Array(0) : bit_1.packBools(this.sources[offset]);
    }
    readOffsets(_type, { offset } = this.nextBufferRange()) {
        return buffer_1.toArrayBufferView(Uint8Array, buffer_1.toArrayBufferView(Int32Array, this.sources[offset]));
    }
    readTypeIds(type, { offset } = this.nextBufferRange()) {
        return buffer_1.toArrayBufferView(Uint8Array, buffer_1.toArrayBufferView(type.ArrayType, this.sources[offset]));
    }
    readData(type, { offset } = this.nextBufferRange()) {
        const { sources } = this;
        if (type_1.DataType.isTimestamp(type)) {
            return buffer_1.toArrayBufferView(Uint8Array, int_1.Int64.convertArray(sources[offset]));
        }
        else if ((type_1.DataType.isInt(type) || type_1.DataType.isTime(type)) && type.bitWidth === 64) {
            return buffer_1.toArrayBufferView(Uint8Array, int_1.Int64.convertArray(sources[offset]));
        }
        else if (type_1.DataType.isDate(type) && type.unit === enum_1.DateUnit.MILLISECOND) {
            return buffer_1.toArrayBufferView(Uint8Array, int_1.Int64.convertArray(sources[offset]));
        }
        else if (type_1.DataType.isDecimal(type)) {
            return buffer_1.toArrayBufferView(Uint8Array, int_1.Int128.convertArray(sources[offset]));
        }
        else if (type_1.DataType.isBinary(type) || type_1.DataType.isFixedSizeBinary(type)) {
            return binaryDataFromJSON(sources[offset]);
        }
        else if (type_1.DataType.isBool(type)) {
            return bit_1.packBools(sources[offset]);
        }
        else if (type_1.DataType.isUtf8(type)) {
            return utf8Encoder.encode(sources[offset].join(''));
        }
        return buffer_1.toArrayBufferView(Uint8Array, buffer_1.toArrayBufferView(type.ArrayType, sources[offset].map((x) => +x)));
    }
}
exports.JSONVectorLoader = JSONVectorLoader;
function binaryDataFromJSON(values) {
    // "DATA": ["49BC7D5B6C47D2","3F5FB6D9322026"]
    // There are definitely more efficient ways to do this... but it gets the
    // job done.
    const joined = values.join('');
    const data = new Uint8Array(joined.length / 2);
    for (let i = 0; i < joined.length; i += 2) {
        data[i >> 1] = parseInt(joined.substr(i, 2), 16);
    }
    return data;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDdkMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDcEQ7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDIiwiZmlsZSI6InZpc2l0b3IvdmVjdG9ybG9hZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IFRleHRFbmNvZGVyIH0gZnJvbSAndGV4dC1lbmNvZGluZy11dGYtOCc7XG5cbmltcG9ydCB7IERhdGEgfSBmcm9tICcuLi9kYXRhJztcbmltcG9ydCAqIGFzIHR5cGUgZnJvbSAnLi4vdHlwZSc7XG5pbXBvcnQgeyBGaWVsZCB9IGZyb20gJy4uL3NjaGVtYSc7XG5pbXBvcnQgeyBEYXRhVHlwZSB9IGZyb20gJy4uL3R5cGUnO1xuaW1wb3J0IHsgVmlzaXRvciB9IGZyb20gJy4uL3Zpc2l0b3InO1xuaW1wb3J0IHsgcGFja0Jvb2xzIH0gZnJvbSAnLi4vdXRpbC9iaXQnO1xuaW1wb3J0IHsgSW50NjQsIEludDEyOCB9IGZyb20gJy4uL3V0aWwvaW50JztcbmltcG9ydCB7IFVuaW9uTW9kZSwgRGF0ZVVuaXQgfSBmcm9tICcuLi9lbnVtJztcbmltcG9ydCB7IHRvQXJyYXlCdWZmZXJWaWV3IH0gZnJvbSAnLi4vdXRpbC9idWZmZXInO1xuaW1wb3J0IHsgQnVmZmVyUmVnaW9uLCBGaWVsZE5vZGUgfSBmcm9tICcuLi9pcGMvbWV0YWRhdGEvbWVzc2FnZSc7XG5cbmNvbnN0IHV0ZjhFbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCd1dGYtOCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIFZlY3RvckxvYWRlciBleHRlbmRzIFZpc2l0b3Ige1xuICAgIHZpc2l0TWFueSA8VCBleHRlbmRzIERhdGFUeXBlPihub2RlczogKEZpZWxkPFQ+IHwgVClbXSk6IERhdGE8VD5bXTtcbiAgICB2aXNpdCAgICAgPFQgZXh0ZW5kcyBEYXRhVHlwZT4obm9kZTogICBGaWVsZDxUPiB8IFQgICApOiBEYXRhPFQ+O1xufVxuXG5leHBvcnQgY2xhc3MgVmVjdG9yTG9hZGVyIGV4dGVuZHMgVmlzaXRvciB7XG4gICAgcHJpdmF0ZSBieXRlczogVWludDhBcnJheTtcbiAgICBwcml2YXRlIG5vZGVzOiBGaWVsZE5vZGVbXTtcbiAgICBwcml2YXRlIG5vZGVzSW5kZXg6IG51bWJlciA9IC0xO1xuICAgIHByaXZhdGUgYnVmZmVyczogQnVmZmVyUmVnaW9uW107XG4gICAgcHJpdmF0ZSBidWZmZXJzSW5kZXg6IG51bWJlciA9IC0xO1xuICAgIGNvbnN0cnVjdG9yKGJ5dGVzOiBVaW50OEFycmF5LCBub2RlczogRmllbGROb2RlW10sIGJ1ZmZlcnM6IEJ1ZmZlclJlZ2lvbltdKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuYnl0ZXMgPSBieXRlcztcbiAgICAgICAgdGhpcy5ub2RlcyA9IG5vZGVzO1xuICAgICAgICB0aGlzLmJ1ZmZlcnMgPSBidWZmZXJzO1xuICAgIH1cblxuICAgIHB1YmxpYyB2aXNpdDxUIGV4dGVuZHMgRGF0YVR5cGU+KG5vZGU6IEZpZWxkPFQ+IHwgVCk6IERhdGE8VD4ge1xuICAgICAgICByZXR1cm4gc3VwZXIudmlzaXQobm9kZSBpbnN0YW5jZW9mIEZpZWxkID8gbm9kZS50eXBlIDogbm9kZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHZpc2l0TnVsbCAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5OdWxsPiAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICBEYXRhLk51bGwodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0Qm9vbCAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5Cb29sPiAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICBEYXRhLkJvb2wodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0SW50ICAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5JbnQ+ICAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICAgRGF0YS5JbnQodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0RmxvYXQgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5GbG9hdD4gICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgIERhdGEuRmxvYXQodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0VXRmOCAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5VdGY4PiAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICBEYXRhLlV0ZjgodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkT2Zmc2V0cyh0eXBlKSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0QmluYXJ5ICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5CaW5hcnk+ICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgRGF0YS5CaW5hcnkodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkT2Zmc2V0cyh0eXBlKSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0Rml4ZWRTaXplQmluYXJ5IDxUIGV4dGVuZHMgdHlwZS5GaXhlZFNpemVCaW5hcnk+ICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gRGF0YS5GaXhlZFNpemVCaW5hcnkodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0RGF0ZSAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5EYXRlXz4gICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICBEYXRhLkRhdGUodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0VGltZXN0YW1wICAgICAgIDxUIGV4dGVuZHMgdHlwZS5UaW1lc3RhbXA+ICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgRGF0YS5UaW1lc3RhbXAodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0VGltZSAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5UaW1lPiAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICBEYXRhLlRpbWUodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0RGVjaW1hbCAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5EZWNpbWFsPiAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICBEYXRhLkRlY2ltYWwodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0TGlzdCAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5MaXN0PiAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICBEYXRhLkxpc3QodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkT2Zmc2V0cyh0eXBlKSwgdGhpcy52aXNpdCh0eXBlLmNoaWxkcmVuWzBdKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0U3RydWN0ICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5TdHJ1Y3Q+ICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgRGF0YS5TdHJ1Y3QodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy52aXNpdE1hbnkodHlwZS5jaGlsZHJlbikpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0VW5pb24gICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5Vbmlvbj4gICAgICAgICAgICh0eXBlOiBUICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgeyByZXR1cm4gdHlwZS5tb2RlID09PSBVbmlvbk1vZGUuU3BhcnNlID8gdGhpcy52aXNpdFNwYXJzZVVuaW9uKHR5cGUgYXMgdHlwZS5TcGFyc2VVbmlvbikgOiB0aGlzLnZpc2l0RGVuc2VVbmlvbih0eXBlIGFzIHR5cGUuRGVuc2VVbmlvbik7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0RGVuc2VVbmlvbiAgICAgIDxUIGV4dGVuZHMgdHlwZS5EZW5zZVVuaW9uPiAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgIERhdGEuVW5pb24odHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkVHlwZUlkcyh0eXBlKSwgdGhpcy5yZWFkT2Zmc2V0cyh0eXBlKSwgdGhpcy52aXNpdE1hbnkodHlwZS5jaGlsZHJlbikpOyB9XG4gICAgcHVibGljIHZpc2l0U3BhcnNlVW5pb24gICAgIDxUIGV4dGVuZHMgdHlwZS5TcGFyc2VVbmlvbj4gICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgIERhdGEuVW5pb24odHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkVHlwZUlkcyh0eXBlKSwgdGhpcy52aXNpdE1hbnkodHlwZS5jaGlsZHJlbikpOyAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0RGljdGlvbmFyeSAgICAgIDxUIGV4dGVuZHMgdHlwZS5EaWN0aW9uYXJ5PiAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICBEYXRhLkRpY3Rpb25hcnkodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlLmluZGljZXMpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0SW50ZXJ2YWwgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5JbnRlcnZhbD4gICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgIERhdGEuSW50ZXJ2YWwodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0Rml4ZWRTaXplTGlzdCAgIDxUIGV4dGVuZHMgdHlwZS5GaXhlZFNpemVMaXN0PiAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICBEYXRhLkZpeGVkU2l6ZUxpc3QodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy52aXNpdCh0eXBlLmNoaWxkcmVuWzBdKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0TWFwICAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5NYXBfPiAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICAgRGF0YS5NYXAodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy52aXNpdE1hbnkodHlwZS5jaGlsZHJlbikpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICBwcm90ZWN0ZWQgbmV4dEZpZWxkTm9kZSgpIHsgcmV0dXJuIHRoaXMubm9kZXNbKyt0aGlzLm5vZGVzSW5kZXhdOyB9XG4gICAgcHJvdGVjdGVkIG5leHRCdWZmZXJSYW5nZSgpIHsgcmV0dXJuIHRoaXMuYnVmZmVyc1srK3RoaXMuYnVmZmVyc0luZGV4XTsgfVxuICAgIHByb3RlY3RlZCByZWFkTnVsbEJpdG1hcDxUIGV4dGVuZHMgRGF0YVR5cGU+KHR5cGU6IFQsIG51bGxDb3VudDogbnVtYmVyLCBidWZmZXIgPSB0aGlzLm5leHRCdWZmZXJSYW5nZSgpKSB7XG4gICAgICAgIHJldHVybiBudWxsQ291bnQgPiAwICYmIHRoaXMucmVhZERhdGEodHlwZSwgYnVmZmVyKSB8fCBuZXcgVWludDhBcnJheSgwKTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHJlYWRPZmZzZXRzPFQgZXh0ZW5kcyBEYXRhVHlwZT4odHlwZTogVCwgYnVmZmVyPzogQnVmZmVyUmVnaW9uKSB7IHJldHVybiB0aGlzLnJlYWREYXRhKHR5cGUsIGJ1ZmZlcik7IH1cbiAgICBwcm90ZWN0ZWQgcmVhZFR5cGVJZHM8VCBleHRlbmRzIERhdGFUeXBlPih0eXBlOiBULCBidWZmZXI/OiBCdWZmZXJSZWdpb24pIHsgcmV0dXJuIHRoaXMucmVhZERhdGEodHlwZSwgYnVmZmVyKTsgfVxuICAgIHByb3RlY3RlZCByZWFkRGF0YTxUIGV4dGVuZHMgRGF0YVR5cGU+KF90eXBlOiBULCB7IGxlbmd0aCwgb2Zmc2V0IH0gPSB0aGlzLm5leHRCdWZmZXJSYW5nZSgpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJ5dGVzLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBKU09OVmVjdG9yTG9hZGVyIGV4dGVuZHMgVmVjdG9yTG9hZGVyIHtcbiAgICBwcml2YXRlIHNvdXJjZXM6IGFueVtdW107XG4gICAgY29uc3RydWN0b3Ioc291cmNlczogYW55W11bXSwgbm9kZXM6IEZpZWxkTm9kZVtdLCBidWZmZXJzOiBCdWZmZXJSZWdpb25bXSkge1xuICAgICAgICBzdXBlcihuZXcgVWludDhBcnJheSgwKSwgbm9kZXMsIGJ1ZmZlcnMpO1xuICAgICAgICB0aGlzLnNvdXJjZXMgPSBzb3VyY2VzO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZE51bGxCaXRtYXA8VCBleHRlbmRzIERhdGFUeXBlPihfdHlwZTogVCwgbnVsbENvdW50OiBudW1iZXIsIHsgb2Zmc2V0IH0gPSB0aGlzLm5leHRCdWZmZXJSYW5nZSgpKSB7XG4gICAgICAgIHJldHVybiBudWxsQ291bnQgPD0gMCA/IG5ldyBVaW50OEFycmF5KDApIDogcGFja0Jvb2xzKHRoaXMuc291cmNlc1tvZmZzZXRdKTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHJlYWRPZmZzZXRzPFQgZXh0ZW5kcyBEYXRhVHlwZT4oX3R5cGU6IFQsIHsgb2Zmc2V0IH0gPSB0aGlzLm5leHRCdWZmZXJSYW5nZSgpKSB7XG4gICAgICAgIHJldHVybiB0b0FycmF5QnVmZmVyVmlldyhVaW50OEFycmF5LCB0b0FycmF5QnVmZmVyVmlldyhJbnQzMkFycmF5LCB0aGlzLnNvdXJjZXNbb2Zmc2V0XSkpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZFR5cGVJZHM8VCBleHRlbmRzIERhdGFUeXBlPih0eXBlOiBULCB7IG9mZnNldCB9ID0gdGhpcy5uZXh0QnVmZmVyUmFuZ2UoKSkge1xuICAgICAgICByZXR1cm4gdG9BcnJheUJ1ZmZlclZpZXcoVWludDhBcnJheSwgdG9BcnJheUJ1ZmZlclZpZXcodHlwZS5BcnJheVR5cGUsIHRoaXMuc291cmNlc1tvZmZzZXRdKSk7XG4gICAgfVxuICAgIHByb3RlY3RlZCByZWFkRGF0YTxUIGV4dGVuZHMgRGF0YVR5cGU+KHR5cGU6IFQsIHsgb2Zmc2V0IH0gPSB0aGlzLm5leHRCdWZmZXJSYW5nZSgpKSB7XG4gICAgICAgIGNvbnN0IHsgc291cmNlcyB9ID0gdGhpcztcbiAgICAgICAgaWYgKERhdGFUeXBlLmlzVGltZXN0YW1wKHR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdG9BcnJheUJ1ZmZlclZpZXcoVWludDhBcnJheSwgSW50NjQuY29udmVydEFycmF5KHNvdXJjZXNbb2Zmc2V0XSBhcyBzdHJpbmdbXSkpO1xuICAgICAgICB9IGVsc2UgaWYgKChEYXRhVHlwZS5pc0ludCh0eXBlKSB8fCBEYXRhVHlwZS5pc1RpbWUodHlwZSkpICYmIHR5cGUuYml0V2lkdGggPT09IDY0KSB7XG4gICAgICAgICAgICByZXR1cm4gdG9BcnJheUJ1ZmZlclZpZXcoVWludDhBcnJheSwgSW50NjQuY29udmVydEFycmF5KHNvdXJjZXNbb2Zmc2V0XSBhcyBzdHJpbmdbXSkpO1xuICAgICAgICB9IGVsc2UgaWYgKERhdGFUeXBlLmlzRGF0ZSh0eXBlKSAmJiB0eXBlLnVuaXQgPT09IERhdGVVbml0Lk1JTExJU0VDT05EKSB7XG4gICAgICAgICAgICByZXR1cm4gdG9BcnJheUJ1ZmZlclZpZXcoVWludDhBcnJheSwgSW50NjQuY29udmVydEFycmF5KHNvdXJjZXNbb2Zmc2V0XSBhcyBzdHJpbmdbXSkpO1xuICAgICAgICB9IGVsc2UgaWYgKERhdGFUeXBlLmlzRGVjaW1hbCh0eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRvQXJyYXlCdWZmZXJWaWV3KFVpbnQ4QXJyYXksIEludDEyOC5jb252ZXJ0QXJyYXkoc291cmNlc1tvZmZzZXRdIGFzIHN0cmluZ1tdKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoRGF0YVR5cGUuaXNCaW5hcnkodHlwZSkgfHwgRGF0YVR5cGUuaXNGaXhlZFNpemVCaW5hcnkodHlwZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBiaW5hcnlEYXRhRnJvbUpTT04oc291cmNlc1tvZmZzZXRdIGFzIHN0cmluZ1tdKTtcbiAgICAgICAgfSBlbHNlIGlmIChEYXRhVHlwZS5pc0Jvb2wodHlwZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBwYWNrQm9vbHMoc291cmNlc1tvZmZzZXRdIGFzIG51bWJlcltdKTtcbiAgICAgICAgfSBlbHNlIGlmIChEYXRhVHlwZS5pc1V0ZjgodHlwZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB1dGY4RW5jb2Rlci5lbmNvZGUoKHNvdXJjZXNbb2Zmc2V0XSBhcyBzdHJpbmdbXSkuam9pbignJykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0b0FycmF5QnVmZmVyVmlldyhVaW50OEFycmF5LCB0b0FycmF5QnVmZmVyVmlldyh0eXBlLkFycmF5VHlwZSwgc291cmNlc1tvZmZzZXRdLm1hcCgoeCkgPT4gK3gpKSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBiaW5hcnlEYXRhRnJvbUpTT04odmFsdWVzOiBzdHJpbmdbXSkge1xuICAgIC8vIFwiREFUQVwiOiBbXCI0OUJDN0Q1QjZDNDdEMlwiLFwiM0Y1RkI2RDkzMjIwMjZcIl1cbiAgICAvLyBUaGVyZSBhcmUgZGVmaW5pdGVseSBtb3JlIGVmZmljaWVudCB3YXlzIHRvIGRvIHRoaXMuLi4gYnV0IGl0IGdldHMgdGhlXG4gICAgLy8gam9iIGRvbmUuXG4gICAgY29uc3Qgam9pbmVkID0gdmFsdWVzLmpvaW4oJycpO1xuICAgIGNvbnN0IGRhdGEgPSBuZXcgVWludDhBcnJheShqb2luZWQubGVuZ3RoIC8gMik7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBqb2luZWQubGVuZ3RoOyBpICs9IDIpIHtcbiAgICAgICAgZGF0YVtpID4+IDFdID0gcGFyc2VJbnQoam9pbmVkLnN1YnN0cihpLCAyKSwgMTYpO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbn1cbiJdfQ==
