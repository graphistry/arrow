"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const data_1 = require("../data");
const schema_1 = require("../schema");
const type_1 = require("../type");
const visitor_1 = require("../visitor");
const bit_1 = require("../util/bit");
const utf8_1 = require("../util/utf8");
const int_1 = require("../util/int");
const enum_1 = require("../enum");
const buffer_1 = require("../util/buffer");
class VectorLoader extends visitor_1.Visitor {
    constructor(bytes, nodes, buffers) {
        super();
        this.nodesIndex = -1;
        this.buffersIndex = -1;
        this.bytes = bytes;
        this.nodes = nodes;
        this.buffers = buffers;
    }
    visit(node) {
        return super.visit(node instanceof schema_1.Field ? node.type : node);
    }
    visitNull(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Null(type, 0, length, nullCount, this.readNullBitmap(type, nullCount)); }
    visitBool(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Bool(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitInt(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Int(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitFloat(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Float(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitUtf8(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Utf8(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.readData(type)); }
    visitBinary(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Binary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.readData(type)); }
    visitFixedSizeBinary(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.FixedSizeBinary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitDate(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Date(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitTimestamp(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Timestamp(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitTime(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Time(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitDecimal(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Decimal(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitList(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.List(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.visit(type.children[0])); }
    visitStruct(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Struct(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visitMany(type.children)); }
    visitUnion(type) { return type.mode === enum_1.UnionMode.Sparse ? this.visitSparseUnion(type) : this.visitDenseUnion(type); }
    visitDenseUnion(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Union(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readTypeIds(type), this.readOffsets(type), this.visitMany(type.children)); }
    visitSparseUnion(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Union(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readTypeIds(type), this.visitMany(type.children)); }
    visitDictionary(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Dictionary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type.indices)); }
    visitInterval(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Interval(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitFixedSizeList(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.FixedSizeList(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visit(type.children[0])); }
    visitMap(type, { length, nullCount } = this.nextFieldNode()) { return data_1.Data.Map(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visitMany(type.children)); }
    nextFieldNode() { return this.nodes[++this.nodesIndex]; }
    nextBufferRange() { return this.buffers[++this.buffersIndex]; }
    readNullBitmap(type, nullCount, buffer = this.nextBufferRange()) {
        return nullCount > 0 && this.readData(type, buffer) || new Uint8Array(0);
    }
    readOffsets(type, buffer) { return this.readData(type, buffer); }
    readTypeIds(type, buffer) { return this.readData(type, buffer); }
    readData(_type, { length, offset } = this.nextBufferRange()) {
        return this.bytes.subarray(offset, offset + length);
    }
}
exports.VectorLoader = VectorLoader;
class JSONVectorLoader extends VectorLoader {
    constructor(sources, nodes, buffers) {
        super(new Uint8Array(0), nodes, buffers);
        this.sources = sources;
    }
    readNullBitmap(_type, nullCount, { offset } = this.nextBufferRange()) {
        return nullCount <= 0 ? new Uint8Array(0) : bit_1.packBools(this.sources[offset]);
    }
    readOffsets(_type, { offset } = this.nextBufferRange()) {
        return buffer_1.toArrayBufferView(Uint8Array, buffer_1.toArrayBufferView(Int32Array, this.sources[offset]));
    }
    readTypeIds(type, { offset } = this.nextBufferRange()) {
        return buffer_1.toArrayBufferView(Uint8Array, buffer_1.toArrayBufferView(type.ArrayType, this.sources[offset]));
    }
    readData(type, { offset } = this.nextBufferRange()) {
        const { sources } = this;
        if (type_1.DataType.isTimestamp(type)) {
            return buffer_1.toArrayBufferView(Uint8Array, int_1.Int64.convertArray(sources[offset]));
        }
        else if ((type_1.DataType.isInt(type) || type_1.DataType.isTime(type)) && type.bitWidth === 64) {
            return buffer_1.toArrayBufferView(Uint8Array, int_1.Int64.convertArray(sources[offset]));
        }
        else if (type_1.DataType.isDate(type) && type.unit === enum_1.DateUnit.MILLISECOND) {
            return buffer_1.toArrayBufferView(Uint8Array, int_1.Int64.convertArray(sources[offset]));
        }
        else if (type_1.DataType.isDecimal(type)) {
            return buffer_1.toArrayBufferView(Uint8Array, int_1.Int128.convertArray(sources[offset]));
        }
        else if (type_1.DataType.isBinary(type) || type_1.DataType.isFixedSizeBinary(type)) {
            return binaryDataFromJSON(sources[offset]);
        }
        else if (type_1.DataType.isBool(type)) {
            return bit_1.packBools(sources[offset]);
        }
        else if (type_1.DataType.isUtf8(type)) {
            return utf8_1.encodeUtf8(sources[offset].join(''));
        }
        return buffer_1.toArrayBufferView(Uint8Array, buffer_1.toArrayBufferView(type.ArrayType, sources[offset].map((x) => +x)));
    }
}
exports.JSONVectorLoader = JSONVectorLoader;
/** @ignore */
function binaryDataFromJSON(values) {
    // "DATA": ["49BC7D5B6C47D2","3F5FB6D9322026"]
    // There are definitely more efficient ways to do this... but it gets the
    // job done.
    const joined = values.join('');
    const data = new Uint8Array(joined.length / 2);
    for (let i = 0; i < joined.length; i += 2) {
        data[i >> 1] = parseInt(joined.substr(i, 2), 16);
    }
    return data;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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UUFDdkMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDcEQ7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDIiwiZmlsZSI6InZpc2l0b3IvdmVjdG9ybG9hZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IERhdGEgfSBmcm9tICcuLi9kYXRhJztcbmltcG9ydCAqIGFzIHR5cGUgZnJvbSAnLi4vdHlwZSc7XG5pbXBvcnQgeyBGaWVsZCB9IGZyb20gJy4uL3NjaGVtYSc7XG5pbXBvcnQgeyBEYXRhVHlwZSB9IGZyb20gJy4uL3R5cGUnO1xuaW1wb3J0IHsgVmlzaXRvciB9IGZyb20gJy4uL3Zpc2l0b3InO1xuaW1wb3J0IHsgcGFja0Jvb2xzIH0gZnJvbSAnLi4vdXRpbC9iaXQnO1xuaW1wb3J0IHsgZW5jb2RlVXRmOCB9IGZyb20gJy4uL3V0aWwvdXRmOCc7XG5pbXBvcnQgeyBJbnQ2NCwgSW50MTI4IH0gZnJvbSAnLi4vdXRpbC9pbnQnO1xuaW1wb3J0IHsgVW5pb25Nb2RlLCBEYXRlVW5pdCB9IGZyb20gJy4uL2VudW0nO1xuaW1wb3J0IHsgdG9BcnJheUJ1ZmZlclZpZXcgfSBmcm9tICcuLi91dGlsL2J1ZmZlcic7XG5pbXBvcnQgeyBCdWZmZXJSZWdpb24sIEZpZWxkTm9kZSB9IGZyb20gJy4uL2lwYy9tZXRhZGF0YS9tZXNzYWdlJztcblxuZXhwb3J0IGludGVyZmFjZSBWZWN0b3JMb2FkZXIgZXh0ZW5kcyBWaXNpdG9yIHtcbiAgICB2aXNpdDxUIGV4dGVuZHMgRGF0YVR5cGU+KG5vZGU6IEZpZWxkPFQ+IHwgVCk6IERhdGE8VD47XG4gICAgdmlzaXRNYW55PFQgZXh0ZW5kcyBEYXRhVHlwZT4obm9kZXM6IChGaWVsZDxUPiB8IFQpW10pOiBEYXRhPFQ+W107XG59XG5cbmV4cG9ydCBjbGFzcyBWZWN0b3JMb2FkZXIgZXh0ZW5kcyBWaXNpdG9yIHtcbiAgICBwcml2YXRlIGJ5dGVzOiBVaW50OEFycmF5O1xuICAgIHByaXZhdGUgbm9kZXM6IEZpZWxkTm9kZVtdO1xuICAgIHByaXZhdGUgbm9kZXNJbmRleDogbnVtYmVyID0gLTE7XG4gICAgcHJpdmF0ZSBidWZmZXJzOiBCdWZmZXJSZWdpb25bXTtcbiAgICBwcml2YXRlIGJ1ZmZlcnNJbmRleDogbnVtYmVyID0gLTE7XG4gICAgY29uc3RydWN0b3IoYnl0ZXM6IFVpbnQ4QXJyYXksIG5vZGVzOiBGaWVsZE5vZGVbXSwgYnVmZmVyczogQnVmZmVyUmVnaW9uW10pIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5ieXRlcyA9IGJ5dGVzO1xuICAgICAgICB0aGlzLm5vZGVzID0gbm9kZXM7XG4gICAgICAgIHRoaXMuYnVmZmVycyA9IGJ1ZmZlcnM7XG4gICAgfVxuXG4gICAgcHVibGljIHZpc2l0PFQgZXh0ZW5kcyBEYXRhVHlwZT4obm9kZTogRmllbGQ8VD4gfCBUKTogRGF0YTxUPiB7XG4gICAgICAgIHJldHVybiBzdXBlci52aXNpdChub2RlIGluc3RhbmNlb2YgRmllbGQgPyBub2RlLnR5cGUgOiBub2RlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdmlzaXROdWxsICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLk51bGw+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuTnVsbCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRCb29sICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkJvb2w+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuQm9vbCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRJbnQgICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkludD4gICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgICBEYXRhLkludCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRGbG9hdCAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkZsb2F0PiAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgRGF0YS5GbG9hdCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRVdGY4ICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLlV0Zjg+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuVXRmOCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWRPZmZzZXRzKHR5cGUpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRCaW5hcnkgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkJpbmFyeT4gICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICBEYXRhLkJpbmFyeSh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWRPZmZzZXRzKHR5cGUpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRGaXhlZFNpemVCaW5hcnkgPFQgZXh0ZW5kcyB0eXBlLkZpeGVkU2l6ZUJpbmFyeT4gKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiBEYXRhLkZpeGVkU2l6ZUJpbmFyeSh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXREYXRlICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkRhdGVfPiAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuRGF0ZSh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRUaW1lc3RhbXAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLlRpbWVzdGFtcD4gICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICBEYXRhLlRpbWVzdGFtcCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRUaW1lICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLlRpbWU+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuVGltZSh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXREZWNpbWFsICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkRlY2ltYWw+ICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgIERhdGEuRGVjaW1hbCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRMaXN0ICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkxpc3Q+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuTGlzdCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWRPZmZzZXRzKHR5cGUpLCB0aGlzLnZpc2l0KHR5cGUuY2hpbGRyZW5bMF0pKTsgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRTdHJ1Y3QgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLlN0cnVjdD4gICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICBEYXRhLlN0cnVjdCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnZpc2l0TWFueSh0eXBlLmNoaWxkcmVuKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRVbmlvbiAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLlVuaW9uPiAgICAgICAgICAgKHR5cGU6IFQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB7IHJldHVybiB0eXBlLm1vZGUgPT09IFVuaW9uTW9kZS5TcGFyc2UgPyB0aGlzLnZpc2l0U3BhcnNlVW5pb24odHlwZSBhcyB0eXBlLlNwYXJzZVVuaW9uKSA6IHRoaXMudmlzaXREZW5zZVVuaW9uKHR5cGUgYXMgdHlwZS5EZW5zZVVuaW9uKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXREZW5zZVVuaW9uICAgICAgPFQgZXh0ZW5kcyB0eXBlLkRlbnNlVW5pb24+ICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgRGF0YS5Vbmlvbih0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWRUeXBlSWRzKHR5cGUpLCB0aGlzLnJlYWRPZmZzZXRzKHR5cGUpLCB0aGlzLnZpc2l0TWFueSh0eXBlLmNoaWxkcmVuKSk7IH1cbiAgICBwdWJsaWMgdmlzaXRTcGFyc2VVbmlvbiAgICAgPFQgZXh0ZW5kcyB0eXBlLlNwYXJzZVVuaW9uPiAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgRGF0YS5Vbmlvbih0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWRUeXBlSWRzKHR5cGUpLCB0aGlzLnZpc2l0TWFueSh0eXBlLmNoaWxkcmVuKSk7ICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXREaWN0aW9uYXJ5ICAgICAgPFQgZXh0ZW5kcyB0eXBlLkRpY3Rpb25hcnk+ICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgIERhdGEuRGljdGlvbmFyeSh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUuaW5kaWNlcykpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRJbnRlcnZhbCAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkludGVydmFsPiAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgRGF0YS5JbnRlcnZhbCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRGaXhlZFNpemVMaXN0ICAgPFQgZXh0ZW5kcyB0eXBlLkZpeGVkU2l6ZUxpc3Q+ICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgIERhdGEuRml4ZWRTaXplTGlzdCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnZpc2l0KHR5cGUuY2hpbGRyZW5bMF0pKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRNYXAgICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLk1hcF8+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgICBEYXRhLk1hcCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnZpc2l0TWFueSh0eXBlLmNoaWxkcmVuKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgIHByb3RlY3RlZCBuZXh0RmllbGROb2RlKCkgeyByZXR1cm4gdGhpcy5ub2Rlc1srK3RoaXMubm9kZXNJbmRleF07IH1cbiAgICBwcm90ZWN0ZWQgbmV4dEJ1ZmZlclJhbmdlKCkgeyByZXR1cm4gdGhpcy5idWZmZXJzWysrdGhpcy5idWZmZXJzSW5kZXhdOyB9XG4gICAgcHJvdGVjdGVkIHJlYWROdWxsQml0bWFwPFQgZXh0ZW5kcyBEYXRhVHlwZT4odHlwZTogVCwgbnVsbENvdW50OiBudW1iZXIsIGJ1ZmZlciA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgcmV0dXJuIG51bGxDb3VudCA+IDAgJiYgdGhpcy5yZWFkRGF0YSh0eXBlLCBidWZmZXIpIHx8IG5ldyBVaW50OEFycmF5KDApO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZE9mZnNldHM8VCBleHRlbmRzIERhdGFUeXBlPih0eXBlOiBULCBidWZmZXI/OiBCdWZmZXJSZWdpb24pIHsgcmV0dXJuIHRoaXMucmVhZERhdGEodHlwZSwgYnVmZmVyKTsgfVxuICAgIHByb3RlY3RlZCByZWFkVHlwZUlkczxUIGV4dGVuZHMgRGF0YVR5cGU+KHR5cGU6IFQsIGJ1ZmZlcj86IEJ1ZmZlclJlZ2lvbikgeyByZXR1cm4gdGhpcy5yZWFkRGF0YSh0eXBlLCBidWZmZXIpOyB9XG4gICAgcHJvdGVjdGVkIHJlYWREYXRhPFQgZXh0ZW5kcyBEYXRhVHlwZT4oX3R5cGU6IFQsIHsgbGVuZ3RoLCBvZmZzZXQgfSA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnl0ZXMuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyBsZW5ndGgpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIEpTT05WZWN0b3JMb2FkZXIgZXh0ZW5kcyBWZWN0b3JMb2FkZXIge1xuICAgIHByaXZhdGUgc291cmNlczogYW55W11bXTtcbiAgICBjb25zdHJ1Y3Rvcihzb3VyY2VzOiBhbnlbXVtdLCBub2RlczogRmllbGROb2RlW10sIGJ1ZmZlcnM6IEJ1ZmZlclJlZ2lvbltdKSB7XG4gICAgICAgIHN1cGVyKG5ldyBVaW50OEFycmF5KDApLCBub2RlcywgYnVmZmVycyk7XG4gICAgICAgIHRoaXMuc291cmNlcyA9IHNvdXJjZXM7XG4gICAgfVxuICAgIHByb3RlY3RlZCByZWFkTnVsbEJpdG1hcDxUIGV4dGVuZHMgRGF0YVR5cGU+KF90eXBlOiBULCBudWxsQ291bnQ6IG51bWJlciwgeyBvZmZzZXQgfSA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgcmV0dXJuIG51bGxDb3VudCA8PSAwID8gbmV3IFVpbnQ4QXJyYXkoMCkgOiBwYWNrQm9vbHModGhpcy5zb3VyY2VzW29mZnNldF0pO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZE9mZnNldHM8VCBleHRlbmRzIERhdGFUeXBlPihfdHlwZTogVCwgeyBvZmZzZXQgfSA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgcmV0dXJuIHRvQXJyYXlCdWZmZXJWaWV3KFVpbnQ4QXJyYXksIHRvQXJyYXlCdWZmZXJWaWV3KEludDMyQXJyYXksIHRoaXMuc291cmNlc1tvZmZzZXRdKSk7XG4gICAgfVxuICAgIHByb3RlY3RlZCByZWFkVHlwZUlkczxUIGV4dGVuZHMgRGF0YVR5cGU+KHR5cGU6IFQsIHsgb2Zmc2V0IH0gPSB0aGlzLm5leHRCdWZmZXJSYW5nZSgpKSB7XG4gICAgICAgIHJldHVybiB0b0FycmF5QnVmZmVyVmlldyhVaW50OEFycmF5LCB0b0FycmF5QnVmZmVyVmlldyh0eXBlLkFycmF5VHlwZSwgdGhpcy5zb3VyY2VzW29mZnNldF0pKTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHJlYWREYXRhPFQgZXh0ZW5kcyBEYXRhVHlwZT4odHlwZTogVCwgeyBvZmZzZXQgfSA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgY29uc3QgeyBzb3VyY2VzIH0gPSB0aGlzO1xuICAgICAgICBpZiAoRGF0YVR5cGUuaXNUaW1lc3RhbXAodHlwZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0b0FycmF5QnVmZmVyVmlldyhVaW50OEFycmF5LCBJbnQ2NC5jb252ZXJ0QXJyYXkoc291cmNlc1tvZmZzZXRdIGFzIHN0cmluZ1tdKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoKERhdGFUeXBlLmlzSW50KHR5cGUpIHx8IERhdGFUeXBlLmlzVGltZSh0eXBlKSkgJiYgdHlwZS5iaXRXaWR0aCA9PT0gNjQpIHtcbiAgICAgICAgICAgIHJldHVybiB0b0FycmF5QnVmZmVyVmlldyhVaW50OEFycmF5LCBJbnQ2NC5jb252ZXJ0QXJyYXkoc291cmNlc1tvZmZzZXRdIGFzIHN0cmluZ1tdKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoRGF0YVR5cGUuaXNEYXRlKHR5cGUpICYmIHR5cGUudW5pdCA9PT0gRGF0ZVVuaXQuTUlMTElTRUNPTkQpIHtcbiAgICAgICAgICAgIHJldHVybiB0b0FycmF5QnVmZmVyVmlldyhVaW50OEFycmF5LCBJbnQ2NC5jb252ZXJ0QXJyYXkoc291cmNlc1tvZmZzZXRdIGFzIHN0cmluZ1tdKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoRGF0YVR5cGUuaXNEZWNpbWFsKHR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdG9BcnJheUJ1ZmZlclZpZXcoVWludDhBcnJheSwgSW50MTI4LmNvbnZlcnRBcnJheShzb3VyY2VzW29mZnNldF0gYXMgc3RyaW5nW10pKTtcbiAgICAgICAgfSBlbHNlIGlmIChEYXRhVHlwZS5pc0JpbmFyeSh0eXBlKSB8fCBEYXRhVHlwZS5pc0ZpeGVkU2l6ZUJpbmFyeSh0eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGJpbmFyeURhdGFGcm9tSlNPTihzb3VyY2VzW29mZnNldF0gYXMgc3RyaW5nW10pO1xuICAgICAgICB9IGVsc2UgaWYgKERhdGFUeXBlLmlzQm9vbCh0eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHBhY2tCb29scyhzb3VyY2VzW29mZnNldF0gYXMgbnVtYmVyW10pO1xuICAgICAgICB9IGVsc2UgaWYgKERhdGFUeXBlLmlzVXRmOCh0eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGVuY29kZVV0ZjgoKHNvdXJjZXNbb2Zmc2V0XSBhcyBzdHJpbmdbXSkuam9pbignJykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0b0FycmF5QnVmZmVyVmlldyhVaW50OEFycmF5LCB0b0FycmF5QnVmZmVyVmlldyh0eXBlLkFycmF5VHlwZSwgc291cmNlc1tvZmZzZXRdLm1hcCgoeCkgPT4gK3gpKSk7XG4gICAgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24gYmluYXJ5RGF0YUZyb21KU09OKHZhbHVlczogc3RyaW5nW10pIHtcbiAgICAvLyBcIkRBVEFcIjogW1wiNDlCQzdENUI2QzQ3RDJcIixcIjNGNUZCNkQ5MzIyMDI2XCJdXG4gICAgLy8gVGhlcmUgYXJlIGRlZmluaXRlbHkgbW9yZSBlZmZpY2llbnQgd2F5cyB0byBkbyB0aGlzLi4uIGJ1dCBpdCBnZXRzIHRoZVxuICAgIC8vIGpvYiBkb25lLlxuICAgIGNvbnN0IGpvaW5lZCA9IHZhbHVlcy5qb2luKCcnKTtcbiAgICBjb25zdCBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoam9pbmVkLmxlbmd0aCAvIDIpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgam9pbmVkLmxlbmd0aDsgaSArPSAyKSB7XG4gICAgICAgIGRhdGFbaSA+PiAxXSA9IHBhcnNlSW50KGpvaW5lZC5zdWJzdHIoaSwgMiksIDE2KTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG59XG4iXX0=
