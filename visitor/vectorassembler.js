"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const vector_1 = require("../vector");
const visitor_1 = require("../visitor");
const enum_1 = require("../enum");
const recordbatch_1 = require("../recordbatch");
const buffer_1 = require("../util/buffer");
const bit_1 = require("../util/bit");
const message_1 = require("../ipc/metadata/message");
const type_1 = require("../type");
class VectorAssembler extends visitor_1.Visitor {
    constructor() {
        super();
        this._byteLength = 0;
        this._nodes = [];
        this._buffers = [];
        this._bufferRegions = [];
    }
    /** @nocollapse */
    static assemble(...args) {
        const vectors = args.reduce(function flatten(xs, x) {
            if (Array.isArray(x)) {
                return x.reduce(flatten, xs);
            }
            if (!(x instanceof recordbatch_1.RecordBatch)) {
                return [...xs, x];
            }
            return [...xs, ...x.schema.fields.map((_, i) => x.getChildAt(i))];
        }, []).filter((x) => x instanceof vector_1.Vector);
        return new VectorAssembler().visitMany(vectors)[0];
    }
    visit(vector) {
        if (!type_1.DataType.isDictionary(vector.type)) {
            const { data, length, nullCount } = vector;
            if (length > 2147483647) {
                throw new RangeError('Cannot write arrays larger than 2^31 - 1 in length');
            }
            addBuffer.call(this, nullCount <= 0
                ? new Uint8Array(0) // placeholder validity buffer
                : bit_1.truncateBitmap(data.offset, length, data.nullBitmap)).nodes.push(new message_1.FieldNode(length, nullCount));
        }
        return super.visit(vector);
    }
    visitNull(_nullV) { return this; }
    visitDictionary(vector) {
        // Assemble the indices here, Dictionary assembled separately.
        return this.visit(vector.indices);
    }
    get nodes() { return this._nodes; }
    get buffers() { return this._buffers; }
    get byteLength() { return this._byteLength; }
    get bufferRegions() { return this._bufferRegions; }
}
exports.VectorAssembler = VectorAssembler;
function addBuffer(values) {
    const byteLength = (values.byteLength + 7) & ~7; // Round up to a multiple of 8
    this.buffers.push(values);
    this.bufferRegions.push(new message_1.BufferRegion(this._byteLength, byteLength));
    this._byteLength += byteLength;
    return this;
}
function assembleUnion(vector) {
    const { type, length, typeIds, valueOffsets } = vector;
    // All Union Vectors have a typeIds buffer
    addBuffer.call(this, typeIds);
    // If this is a Sparse Union, treat it like all other Nested types
    if (type.mode === enum_1.UnionMode.Sparse) {
        return assembleNestedVector.call(this, vector);
    }
    else if (type.mode === enum_1.UnionMode.Dense) {
        // If this is a Dense Union, add the valueOffsets buffer and potentially slice the children
        if (vector.offset <= 0) {
            // If the Vector hasn't been sliced, write the existing valueOffsets
            addBuffer.call(this, valueOffsets);
            // We can treat this like all other Nested types
            return assembleNestedVector.call(this, vector);
        }
        else {
            // A sliced Dense Union is an unpleasant case. Because the offsets are different for
            // each child vector, we need to "rebase" the valueOffsets for each child
            // Union typeIds are not necessary 0-indexed
            const maxChildTypeId = typeIds.reduce((x, y) => Math.max(x, y), typeIds[0]);
            const childLengths = new Int32Array(maxChildTypeId + 1);
            // Set all to -1 to indicate that we haven't observed a first occurrence of a particular child yet
            const childOffsets = new Int32Array(maxChildTypeId + 1).fill(-1);
            const shiftedOffsets = new Int32Array(length);
            // If we have a non-zero offset, then the value offsets do not start at
            // zero. We must a) create a new offsets array with shifted offsets and
            // b) slice the values array accordingly
            const unshiftedOffsets = buffer_1.rebaseValueOffsets(-valueOffsets[0], length, valueOffsets);
            for (let typeId, shift, index = -1; ++index < length;) {
                if ((shift = childOffsets[typeId = typeIds[index]]) === -1) {
                    shift = childOffsets[typeId] = unshiftedOffsets[typeId];
                }
                shiftedOffsets[index] = unshiftedOffsets[index] - shift;
                ++childLengths[typeId];
            }
            addBuffer.call(this, shiftedOffsets);
            // Slice and visit children accordingly
            for (let child, childIndex = -1, numChildren = type.children.length; ++childIndex < numChildren;) {
                if (child = vector.getChildAt(childIndex)) {
                    const typeId = type.typeIds[childIndex];
                    const childLength = Math.min(length, childLengths[typeId]);
                    this.visit(child.slice(childOffsets[typeId], childLength));
                }
            }
        }
    }
    return this;
}
function assembleBoolVector(vector) {
    // Bool vector is a special case of FlatVector, as its data buffer needs to stay packed
    let values;
    if (vector.nullCount >= vector.length) {
        // If all values are null, just insert a placeholder empty data buffer (fastest path)
        return addBuffer.call(this, new Uint8Array(0));
    }
    else if ((values = vector.values) instanceof Uint8Array) {
        // If values is already a Uint8Array, slice the bitmap (fast path)
        return addBuffer.call(this, bit_1.truncateBitmap(vector.offset, vector.length, values));
    }
    // Otherwise if the underlying data *isn't* a Uint8Array, enumerate
    // the values as bools and re-pack them into a Uint8Array (slow path)
    return addBuffer.call(this, bit_1.packBools(vector));
}
function assembleFlatVector(vector) {
    return addBuffer.call(this, vector.values.subarray(0, vector.length * vector.stride));
}
function assembleFlatListVector(vector) {
    const { length, values, valueOffsets } = vector;
    const firstOffset = valueOffsets[0];
    const lastOffset = valueOffsets[length];
    const byteLength = Math.min(lastOffset - firstOffset, values.byteLength - firstOffset);
    // Push in the order FlatList types read their buffers
    addBuffer.call(this, buffer_1.rebaseValueOffsets(-valueOffsets[0], length, valueOffsets)); // valueOffsets buffer first
    addBuffer.call(this, values.subarray(firstOffset, firstOffset + byteLength)); // sliced values buffer second
    return this;
}
function assembleListVector(vector) {
    const { length, valueOffsets } = vector;
    // If we have valueOffsets (ListVector), push that buffer first
    if (valueOffsets) {
        addBuffer.call(this, buffer_1.rebaseValueOffsets(valueOffsets[0], length, valueOffsets));
    }
    // Then insert the List's values child
    return this.visit(vector.getChildAt(0));
}
function assembleNestedVector(vector) {
    return this.visitMany(vector.type.children.map((_, i) => vector.getChildAt(i)).filter(Boolean))[0];
}
VectorAssembler.prototype.visitBool = assembleBoolVector;
VectorAssembler.prototype.visitInt = assembleFlatVector;
VectorAssembler.prototype.visitFloat = assembleFlatVector;
VectorAssembler.prototype.visitUtf8 = assembleFlatListVector;
VectorAssembler.prototype.visitBinary = assembleFlatListVector;
VectorAssembler.prototype.visitFixedSizeBinary = assembleFlatVector;
VectorAssembler.prototype.visitDate = assembleFlatVector;
VectorAssembler.prototype.visitTimestamp = assembleFlatVector;
VectorAssembler.prototype.visitTime = assembleFlatVector;
VectorAssembler.prototype.visitDecimal = assembleFlatVector;
VectorAssembler.prototype.visitList = assembleListVector;
VectorAssembler.prototype.visitStruct = assembleNestedVector;
VectorAssembler.prototype.visitUnion = assembleUnion;
VectorAssembler.prototype.visitInterval = assembleFlatVector;
VectorAssembler.prototype.visitFixedSizeList = assembleListVector;
VectorAssembler.prototype.visitMap = assembleNestedVector;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpc2l0b3IvdmVjdG9yYXNzZW1ibGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw2REFBNkQ7QUFDN0QsK0RBQStEO0FBQy9ELHdEQUF3RDtBQUN4RCw2REFBNkQ7QUFDN0Qsb0RBQW9EO0FBQ3BELDZEQUE2RDtBQUM3RCw2REFBNkQ7QUFDN0QsRUFBRTtBQUNGLCtDQUErQztBQUMvQyxFQUFFO0FBQ0YsNkRBQTZEO0FBQzdELDhEQUE4RDtBQUM5RCx5REFBeUQ7QUFDekQsNERBQTREO0FBQzVELDBEQUEwRDtBQUMxRCxxQkFBcUI7O0FBR3JCLHNDQUFtQztBQUNuQyx3Q0FBcUM7QUFDckMsa0NBQTBDO0FBQzFDLGdEQUE2QztBQUU3QywyQ0FBb0Q7QUFDcEQscUNBQXdEO0FBQ3hELHFEQUFrRTtBQUNsRSxrQ0FJaUI7QUE0QmpCLE1BQWEsZUFBZ0IsU0FBUSxpQkFBTztJQWN4QztRQUF3QixLQUFLLEVBQUUsQ0FBQztRQTJCdEIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFDaEIsV0FBTSxHQUFnQixFQUFFLENBQUM7UUFDekIsYUFBUSxHQUFzQixFQUFFLENBQUM7UUFDakMsbUJBQWMsR0FBbUIsRUFBRSxDQUFDO0lBOUJiLENBQUM7SUFabEMsa0JBQWtCO0lBQ1gsTUFBTSxDQUFDLFFBQVEsQ0FBaUMsR0FBRyxJQUFpQjtRQUV2RSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsT0FBTyxDQUFDLEVBQVMsRUFBRSxDQUFNO1lBQzFELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFBRSxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2FBQUU7WUFDdkQsSUFBSSxDQUFDLENBQUMsQ0FBQyxZQUFZLHlCQUFXLENBQUMsRUFBRTtnQkFBRSxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFBRTtZQUN2RCxPQUFPLENB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QyxRQUFRLEdBQW1CLGtCQUFrQixDQUFDO0FBQ3hFLGVBQWUsQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFpQixrQkFBa0IsQ0FBQztBQUN4RSxlQUFlLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBYyxzQkFBc0IsQ0FBQztBQUN4RSxlQUFlLENBQUMsU0FBUyxDQUFDLFdBQVcsR0FBWSxzQkFBc0IsQ0FBQztBQUN4RSxlQUFlLENBQUMsU0FBUyxDQUFDLG9CQUFvQixHQUFPLGtCQUFrQixDQUFDO0FBQ3hFLGVBQWUsQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFrQixrQkFBa0IsQ0FBQztBQUN4RSxlQUFlLENBQUMsU0FBUyxDQUFDLGNBQWMsR0FBYSxrQkFBa0IsQ0FBQztBQUN4RSxlQUFlLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBa0Isa0JBQWtCLENBQUM7QUFDeEUsZUFBZSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQWUsa0JBQWtCLENBQUM7QUFDeEUsZUFBZSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQWtCLGtCQUFrQixDQUFDO0FBQ3hFLGVBQWUsQ0FBQyxTQUFTLENBQUMsV0FBVyxHQUFjLG9CQUFvQixDQUFDO0FBQ3hFLGVBQWUsQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFzQixhQUFhLENBQUM7QUFDeEUsZUFBZSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEdBQWMsa0JBQWtCLENBQUM7QUFDeEUsZUFBZSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsR0FBUyxrQkFBa0IsQ0FBQztBQUN4RSxlQUFlLENBQUMsU0FBUyxDQUFDLFFBQVEsR0FBaUIsb0JBQW9CLENBQUMiLCJmaWxlIjoidmlzaXRvci92ZWN0b3Jhc3NlbWJsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgRGF0YSB9IGZyb20gJy4uL2RhdGEnO1xuaW1wb3J0IHsgVmVjdG9yIH0gZnJvbSAnLi4vdmVjdG9yJztcbmltcG9ydCB7IFZpc2l0b3IgfSBmcm9tICcuLi92aXNpdG9yJztcbmltcG9ydCB7IFR5cGUsIFVuaW9uTW9kZSB9IGZyb20gJy4uL2VudW0nO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2ggfSBmcm9tICcuLi9yZWNvcmRiYXRjaCc7XG5pbXBvcnQgeyBWZWN0b3IgYXMgVlR5cGUgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IHJlYmFzZVZhbHVlT2Zmc2V0cyB9IGZyb20gJy4uL3V0aWwvYnVmZmVyJztcbmltcG9ydCB7IHBhY2tCb29scywgdHJ1bmNhdGVCaXRtYXAgfSBmcm9tICcuLi91dGlsL2JpdCc7XG5pbXBvcnQgeyBCdWZmZXJSZWdpb24sIEZpZWxkTm9kZSB9IGZyb20gJy4uL2lwYy9tZXRhZGF0YS9tZXNzYWdlJztcbmltcG9ydCB7XG4gICAgRGF0YVR5cGUsIERpY3Rpb25hcnksXG4gICAgRmxvYXQsIEludCwgRGF0ZV8sIEludGVydmFsLCBUaW1lLCBUaW1lc3RhbXAsIFVuaW9uLFxuICAgIEJvb2wsIE51bGwsIFV0ZjgsIEJpbmFyeSwgRGVjaW1hbCwgRml4ZWRTaXplQmluYXJ5LCBMaXN0LCBGaXhlZFNpemVMaXN0LCBNYXBfLCBTdHJ1Y3QsXG59IGZyb20gJy4uL3R5cGUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFZlY3RvckFzc2VtYmxlciBleHRlbmRzIFZpc2l0b3Ige1xuICAgIHZpc2l0TWFueSA8VCBleHRlbmRzIFZlY3Rvcj4gIChub2RlczogVFtdKTogdGhpc1tdO1xuICAgIHZpc2l0ICAgICA8VCBleHRlbmRzIFZlY3Rvcj4gIChub2RlOiBUICAgKTogdGhpcztcbiAgICBnZXRWaXNpdEZuPFQgZXh0ZW5kcyBUeXBlPiAgICAobm9kZTogVCAgICAgICApOiAodmVjdG9yOiBWVHlwZTxUPikgPT4gdGhpcztcbiAgICBnZXRWaXNpdEZuPFQgZXh0ZW5kcyBEYXRhVHlwZT4obm9kZTogVlR5cGU8VD4pOiAodmVjdG9yOiBWVHlwZTxUPikgPT4gdGhpcztcbiAgICBnZXRWaXNpdEZuPFQgZXh0ZW5kcyBEYXRhVHlwZT4obm9kZTogRGF0YTxUPiApOiAodmVjdG9yOiBWVHlwZTxUPikgPT4gdGhpcztcbiAgICBnZXRWaXNpdEZuPFQgZXh0ZW5kcyBEYXRhVHlwZT4obm9kZTogVCAgICAgICApOiAodmVjdG9yOiBWVHlwZTxUPikgPT4gdGhpcztcblxuICAgIHZpc2l0Qm9vbCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBCb29sPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogdGhpcztcbiAgICB2aXNpdEludCAgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgSW50PiAgICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHRoaXM7XG4gICAgdmlzaXRGbG9hdCAgICAgICAgICAgICAgICA8VCBleHRlbmRzIEZsb2F0PiAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB0aGlzO1xuICAgIHZpc2l0VXRmOCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBVdGY4PiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogdGhpcztcbiAgICB2aXNpdEJpbmFyeSAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgQmluYXJ5PiAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHRoaXM7XG4gICAgdmlzaXRGaXhlZFNpemVCaW5hcnkgICAgICA8VCBleHRlbmRzIEZpeGVkU2l6ZUJpbmFyeT4gKHZlY3RvcjogVlR5cGU8VD4pOiB0aGlzO1xuICAgIHZpc2l0RGF0ZSAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBEYXRlXz4gICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogdGhpcztcbiAgICB2aXNpdFRpbWVzdGFtcCAgICAgICAgICAgIDxUIGV4dGVuZHMgVGltZXN0YW1wPiAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHRoaXM7XG4gICAgdmlzaXRUaW1lICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIFRpbWU+ICAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB0aGlzO1xuICAgIHZpc2l0RGVjaW1hbCAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBEZWNpbWFsPiAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogdGhpcztcbiAgICB2aXNpdExpc3QgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgTGlzdD4gICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHRoaXM7XG4gICAgdmlzaXRTdHJ1Y3QgICAgICAgICAgICAgICA8VCBleHRlbmRzIFN0cnVjdD4gICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB0aGlzO1xuICAgIHZpc2l0VW5pb24gICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBVbmlvbj4gICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogdGhpcztcbiAgICB2aXNpdEludGVydmFsICAgICAgICAgICAgIDxUIGV4dGVuZHMgSW50ZXJ2YWw+ICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHRoaXM7XG4gICAgdmlzaXRGaXhlZFNpemVMaXN0ICAgICAgICA8VCBleHRlbmRzIEZpeGVkU2l6ZUxpc3Q+ICAgKHZlY3RvcjogVlR5cGU8VD4pOiB0aGlzO1xuICAgIHZpc2l0TWFwICAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBNYXBfPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogdGhpcztcbn1cblxuZXhwb3J0IGNsYXNzIFZlY3RvckFzc2VtYmxlciBleHRlbmRzIFZpc2l0b3Ige1xuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBhc3NlbWJsZTxUIGV4dGVuZHMgVmVjdG9yIHwgUmVjb3JkQmF0Y2g+KC4uLmFyZ3M6IChUIHwgVFtdKVtdKSB7XG5cbiAgICAgICAgY29uc3QgdmVjdG9ycyA9IGFyZ3MucmVkdWNlKGZ1bmN0aW9uIGZsYXR0ZW4oeHM6IGFueVtdLCB4OiBhbnkpOiBhbnlbXSB7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh4KSkgeyByZXR1cm4geC5yZWR1Y2UoZmxhdHRlbiwgeHMpOyB9XG4gICAgICAgICAgICBpZiAoISh4IGluc3RhbmNlb2YgUmVjb3JkQmF0Y2gpKSB7IHJldHVybiBbLi4ueHMsIHhdOyB9XG4gICAgICAgICAgICByZXR1cm4gWy4uLnhzLCAuLi54LnNjaGVtYS5maWVsZHMubWFwKChfLCBpKSA9PiB4LmdldENoaWxkQXQoaSkhKV07XG4gICAgICAgIH0sIFtdKS5maWx0ZXIoKHg6IGFueSk6IHggaXMgVmVjdG9yID0+IHggaW5zdGFuY2VvZiBWZWN0b3IpO1xuXG4gICAgICAgIHJldHVybiBuZXcgVmVjdG9yQXNzZW1ibGVyKCkudmlzaXRNYW55KHZlY3RvcnMpWzBdO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29uc3RydWN0b3IoKSB7IHN1cGVyKCk7IH1cblxuICAgIHB1YmxpYyB2aXNpdDxUIGV4dGVuZHMgVmVjdG9yPih2ZWN0b3I6IFQpOiB0aGlzIHtcbiAgICAgICAgaWYgKCFEYXRhVHlwZS5pc0RpY3Rpb25hcnkodmVjdG9yLnR5cGUpKSB7XG4gICAgICAgICAgICBjb25zdCB7IGRhdGEsIGxlbmd0aCwgbnVsbENvdW50IH0gPSB2ZWN0b3I7XG4gICAgICAgICAgICBpZiAobGVuZ3RoID4gMjE0NzQ4MzY0Nykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdDYW5ub3Qgd3JpdGUgYXJyYXlzIGxhcmdlciB0aGFuIDJeMzEgLSAxIGluIGxlbmd0aCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYWRkQnVmZmVyLmNhbGwodGhpcywgbnVsbENvdW50IDw9IDBcbiAgICAgICAgICAgICAgICA/IG5ldyBVaW50OEFycmF5KDApIC8vIHBsYWNlaG9sZGVyIHZhbGlkaXR5IGJ1ZmZlclxuICAgICAgICAgICAgICAgIDogdHJ1bmNhdGVCaXRtYXAoZGF0YS5vZmZzZXQsIGxlbmd0aCwgZGF0YS5udWxsQml0bWFwKVxuICAgICAgICAgICAgKS5ub2Rlcy5wdXNoKG5ldyBGaWVsZE5vZGUobGVuZ3RoLCBudWxsQ291bnQpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3VwZXIudmlzaXQodmVjdG9yKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdmlzaXROdWxsPFQgZXh0ZW5kcyBOdWxsPihfbnVsbFY6IFZUeXBlPFQ+KSB7IHJldHVybiB0aGlzOyB9XG4gICAgcHVibGljIHZpc2l0RGljdGlvbmFyeTxUIGV4dGVuZHMgRGljdGlvbmFyeT4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICAvLyBBc3NlbWJsZSB0aGUgaW5kaWNlcyBoZXJlLCBEaWN0aW9uYXJ5IGFzc2VtYmxlZCBzZXBhcmF0ZWx5LlxuICAgICAgICByZXR1cm4gdGhpcy52aXNpdCh2ZWN0b3IuaW5kaWNlcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBub2RlcygpIHsgcmV0dXJuIHRoaXMuX25vZGVzOyB9XG4gICAgcHVibGljIGdldCBidWZmZXJzKCkgeyByZXR1cm4gdGhpcy5fYnVmZmVyczsgfVxuICAgIHB1YmxpYyBnZXQgYnl0ZUxlbmd0aCgpIHsgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGg7IH1cbiAgICBwdWJsaWMgZ2V0IGJ1ZmZlclJlZ2lvbnMoKSB7IHJldHVybiB0aGlzLl9idWZmZXJSZWdpb25zOyB9XG5cbiAgICBwcm90ZWN0ZWQgX2J5dGVMZW5ndGggPSAwO1xuICAgIHByb3RlY3RlZCBfbm9kZXM6IEZpZWxkTm9kZVtdID0gW107XG4gICAgcHJvdGVjdGVkIF9idWZmZXJzOiBBcnJheUJ1ZmZlclZpZXdbXSA9IFtdO1xuICAgIHByb3RlY3RlZCBfYnVmZmVyUmVnaW9uczogQnVmZmVyUmVnaW9uW10gPSBbXTtcbn1cblxuZnVuY3Rpb24gYWRkQnVmZmVyKHRoaXM6IFZlY3RvckFzc2VtYmxlciwgdmFsdWVzOiBBcnJheUJ1ZmZlclZpZXcpIHtcbiAgICBjb25zdCBieXRlTGVuZ3RoID0gKHZhbHVlcy5ieXRlTGVuZ3RoICsgNykgJiB+NzsgLy8gUm91bmQgdXAgdG8gYSBtdWx0aXBsZSBvZiA4XG4gICAgdGhpcy5idWZmZXJzLnB1c2godmFsdWVzKTtcbiAgICB0aGlzLmJ1ZmZlclJlZ2lvbnMucHVzaChuZXcgQnVmZmVyUmVnaW9uKHRoaXMuX2J5dGVMZW5ndGgsIGJ5dGVMZW5ndGgpKTtcbiAgICB0aGlzLl9ieXRlTGVuZ3RoICs9IGJ5dGVMZW5ndGg7XG4gICAgcmV0dXJuIHRoaXM7XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlVW5pb248VCBleHRlbmRzIFVuaW9uPih0aGlzOiBWZWN0b3JBc3NlbWJsZXIsIHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICBjb25zdCB7IHR5cGUsIGxlbmd0aCwgdHlwZUlkcywgdmFsdWVPZmZzZXRzIH0gPSB2ZWN0b3I7XG4gICAgLy8gQWxsIFVuaW9uIFZlY3RvcnMgaGF2ZSBhIHR5cGVJZHMgYnVmZmVyXG4gICAgYWRkQnVmZmVyLmNhbGwodGhpcywgdHlwZUlkcyk7XG4gICAgLy8gSWYgdGhpcyBpcyBhIFNwYXJzZSBVbmlvbiwgdHJlYXQgaXQgbGlrZSBhbGwgb3RoZXIgTmVzdGVkIHR5cGVzXG4gICAgaWYgKHR5cGUubW9kZSA9PT0gVW5pb25Nb2RlLlNwYXJzZSkge1xuICAgICAgICByZXR1cm4gYXNzZW1ibGVOZXN0ZWRWZWN0b3IuY2FsbCh0aGlzLCB2ZWN0b3IpO1xuICAgIH0gZWxzZSBpZiAodHlwZS5tb2RlID09PSBVbmlvbk1vZGUuRGVuc2UpIHtcbiAgICAgICAgLy8gSWYgdGhpcyBpcyBhIERlbnNlIFVuaW9uLCBhZGQgdGhlIHZhbHVlT2Zmc2V0cyBidWZmZXIgYW5kIHBvdGVudGlhbGx5IHNsaWNlIHRoZSBjaGlsZHJlblxuICAgICAgICBpZiAodmVjdG9yLm9mZnNldCA8PSAwKSB7XG4gICAgICAgICAgICAvLyBJZiB0aGUgVmVjdG9yIGhhc24ndCBiZWVuIHNsaWNlZCwgd3JpdGUgdGhlIGV4aXN0aW5nIHZhbHVlT2Zmc2V0c1xuICAgICAgICAgICAgYWRkQnVmZmVyLmNhbGwodGhpcywgdmFsdWVPZmZzZXRzKTtcbiAgICAgICAgICAgIC8vIFdlIGNhbiB0cmVhdCB0aGlzIGxpa2UgYWxsIG90aGVyIE5lc3RlZCB0eXBlc1xuICAgICAgICAgICAgcmV0dXJuIGFzc2VtYmxlTmVzdGVkVmVjdG9yLmNhbGwodGhpcywgdmVjdG9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIEEgc2xpY2VkIERlbnNlIFVuaW9uIGlzIGFuIHVucGxlYXNhbnQgY2FzZS4gQmVjYXVzZSB0aGUgb2Zmc2V0cyBhcmUgZGlmZmVyZW50IGZvclxuICAgICAgICAgICAgLy8gZWFjaCBjaGlsZCB2ZWN0b3IsIHdlIG5lZWQgdG8gXCJyZWJhc2VcIiB0aGUgdmFsdWVPZmZzZXRzIGZvciBlYWNoIGNoaWxkXG4gICAgICAgICAgICAvLyBVbmlvbiB0eXBlSWRzIGFyZSBub3QgbmVjZXNzYXJ5IDAtaW5kZXhlZFxuICAgICAgICAgICAgY29uc3QgbWF4Q2hpbGRUeXBlSWQgPSB0eXBlSWRzLnJlZHVjZSgoeCwgeSkgPT4gTWF0aC5tYXgoeCwgeSksIHR5cGVJZHNbMF0pO1xuICAgICAgICAgICAgY29uc3QgY2hpbGRMZW5ndGhzID0gbmV3IEludDMyQXJyYXkobWF4Q2hpbGRUeXBlSWQgKyAxKTtcbiAgICAgICAgICAgIC8vIFNldCBhbGwgdG8gLTEgdG8gaW5kaWNhdGUgdGhhdCB3ZSBoYXZlbid0IG9ic2VydmVkIGEgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhIHBhcnRpY3VsYXIgY2hpbGQgeWV0XG4gICAgICAgICAgICBjb25zdCBjaGlsZE9mZnNldHMgPSBuZXcgSW50MzJBcnJheShtYXhDaGlsZFR5cGVJZCArIDEpLmZpbGwoLTEpO1xuICAgICAgICAgICAgY29uc3Qgc2hpZnRlZE9mZnNldHMgPSBuZXcgSW50MzJBcnJheShsZW5ndGgpO1xuICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIG5vbi16ZXJvIG9mZnNldCwgdGhlbiB0aGUgdmFsdWUgb2Zmc2V0cyBkbyBub3Qgc3RhcnQgYXRcbiAgICAgICAgICAgIC8vIHplcm8uIFdlIG11c3QgYSkgY3JlYXRlIGEgbmV3IG9mZnNldHMgYXJyYXkgd2l0aCBzaGlmdGVkIG9mZnNldHMgYW5kXG4gICAgICAgICAgICAvLyBiKSBzbGljZSB0aGUgdmFsdWVzIGFycmF5IGFjY29yZGluZ2x5XG4gICAgICAgICAgICBjb25zdCB1bnNoaWZ0ZWRPZmZzZXRzID0gcmViYXNlVmFsdWVPZmZzZXRzKC12YWx1ZU9mZnNldHNbMF0sIGxlbmd0aCwgdmFsdWVPZmZzZXRzKTtcbiAgICAgICAgICAgIGZvciAobGV0IHR5cGVJZCwgc2hpZnQsIGluZGV4ID0gLTE7ICsraW5kZXggPCBsZW5ndGg7KSB7XG4gICAgICAgICAgICAgICAgaWYgKChzaGlmdCA9IGNoaWxkT2Zmc2V0c1t0eXBlSWQgPSB0eXBlSWRzW2luZGV4XV0pID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBzaGlmdCA9IGNoaWxkT2Zmc2V0c1t0eXBlSWRdID0gdW5zaGlmdGVkT2Zmc2V0c1t0eXBlSWRdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzaGlmdGVkT2Zmc2V0c1tpbmRleF0gPSB1bnNoaWZ0ZWRPZmZzZXRzW2luZGV4XSAtIHNoaWZ0O1xuICAgICAgICAgICAgICAgICsrY2hpbGRMZW5ndGhzW3R5cGVJZF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhZGRCdWZmZXIuY2FsbCh0aGlzLCBzaGlmdGVkT2Zmc2V0cyk7XG4gICAgICAgICAgICAvLyBTbGljZSBhbmQgdmlzaXQgY2hpbGRyZW4gYWNjb3JkaW5nbHlcbiAgICAgICAgICAgIGZvciAobGV0IGNoaWxkOiBWZWN0b3IgfCBudWxsLCBjaGlsZEluZGV4ID0gLTEsIG51bUNoaWxkcmVuID0gdHlwZS5jaGlsZHJlbi5sZW5ndGg7ICsrY2hpbGRJbmRleCA8IG51bUNoaWxkcmVuOykge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9IHZlY3Rvci5nZXRDaGlsZEF0KGNoaWxkSW5kZXgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHR5cGVJZCA9IHR5cGUudHlwZUlkc1tjaGlsZEluZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGRMZW5ndGggPSBNYXRoLm1pbihsZW5ndGgsIGNoaWxkTGVuZ3Roc1t0eXBlSWRdKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXNpdChjaGlsZC5zbGljZShjaGlsZE9mZnNldHNbdHlwZUlkXSwgY2hpbGRMZW5ndGgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlQm9vbFZlY3RvcjxUIGV4dGVuZHMgQm9vbD4odGhpczogVmVjdG9yQXNzZW1ibGVyLCB2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgLy8gQm9vbCB2ZWN0b3IgaXMgYSBzcGVjaWFsIGNhc2Ugb2YgRmxhdFZlY3RvciwgYXMgaXRzIGRhdGEgYnVmZmVyIG5lZWRzIHRvIHN0YXkgcGFja2VkXG4gICAgbGV0IHZhbHVlczogVWludDhBcnJheTtcbiAgICBpZiAodmVjdG9yLm51bGxDb3VudCA+PSB2ZWN0b3IubGVuZ3RoKSB7XG4gICAgICAgIC8vIElmIGFsbCB2YWx1ZXMgYXJlIG51bGwsIGp1c3QgaW5zZXJ0IGEgcGxhY2Vob2xkZXIgZW1wdHkgZGF0YSBidWZmZXIgKGZhc3Rlc3QgcGF0aClcbiAgICAgICAgcmV0dXJuIGFkZEJ1ZmZlci5jYWxsKHRoaXMsIG5ldyBVaW50OEFycmF5KDApKTtcbiAgICB9IGVsc2UgaWYgKCh2YWx1ZXMgPSB2ZWN0b3IudmFsdWVzKSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHtcbiAgICAgICAgLy8gSWYgdmFsdWVzIGlzIGFscmVhZHkgYSBVaW50OEFycmF5LCBzbGljZSB0aGUgYml0bWFwIChmYXN0IHBhdGgpXG4gICAgICAgIHJldHVybiBhZGRCdWZmZXIuY2FsbCh0aGlzLCB0cnVuY2F0ZUJpdG1hcCh2ZWN0b3Iub2Zmc2V0LCB2ZWN0b3IubGVuZ3RoLCB2YWx1ZXMpKTtcbiAgICB9XG4gICAgLy8gT3RoZXJ3aXNlIGlmIHRoZSB1bmRlcmx5aW5nIGRhdGEgKmlzbid0KiBhIFVpbnQ4QXJyYXksIGVudW1lcmF0ZVxuICAgIC8vIHRoZSB2YWx1ZXMgYXMgYm9vbHMgYW5kIHJlLXBhY2sgdGhlbSBpbnRvIGEgVWludDhBcnJheSAoc2xvdyBwYXRoKVxuICAgIHJldHVybiBhZGRCdWZmZXIuY2FsbCh0aGlzLCBwYWNrQm9vbHModmVjdG9yKSk7XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlRmxhdFZlY3RvcjxUIGV4dGVuZHMgSW50IHwgRmxvYXQgfCBGaXhlZFNpemVCaW5hcnkgfCBEYXRlXyB8IFRpbWVzdGFtcCB8IFRpbWUgfCBEZWNpbWFsIHwgSW50ZXJ2YWw+KHRoaXM6IFZlY3RvckFzc2VtYmxlciwgdmVjdG9yOiBWVHlwZTxUPikge1xuICAgIHJldHVybiBhZGRCdWZmZXIuY2FsbCh0aGlzLCB2ZWN0b3IudmFsdWVzLnN1YmFycmF5KDAsIHZlY3Rvci5sZW5ndGggKiB2ZWN0b3Iuc3RyaWRlKSk7XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlRmxhdExpc3RWZWN0b3I8VCBleHRlbmRzIFV0ZjggfCBCaW5hcnk+KHRoaXM6IFZlY3RvckFzc2VtYmxlciwgdmVjdG9yOiBWVHlwZTxUPikge1xuICAgIGNvbnN0IHsgbGVuZ3RoLCB2YWx1ZXMsIHZhbHVlT2Zmc2V0cyB9ID0gdmVjdG9yO1xuICAgIGNvbnN0IGZpcnN0T2Zmc2V0ID0gdmFsdWVPZmZzZXRzWzBdO1xuICAgIGNvbnN0IGxhc3RPZmZzZXQgPSB2YWx1ZU9mZnNldHNbbGVuZ3RoXTtcbiAgICBjb25zdCBieXRlTGVuZ3RoID0gTWF0aC5taW4obGFzdE9mZnNldCAtIGZpcnN0T2Zmc2V0LCB2YWx1ZXMuYnl0ZUxlbmd0aCAtIGZpcnN0T2Zmc2V0KTtcbiAgICAvLyBQdXNoIGluIHRoZSBvcmRlciBGbGF0TGlzdCB0eXBlcyByZWFkIHRoZWlyIGJ1ZmZlcnNcbiAgICBhZGRCdWZmZXIuY2FsbCh0aGlzLCByZWJhc2VWYWx1ZU9mZnNldHMoLXZhbHVlT2Zmc2V0c1swXSwgbGVuZ3RoLCB2YWx1ZU9mZnNldHMpKTsgLy8gdmFsdWVPZmZzZXRzIGJ1ZmZlciBmaXJzdFxuICAgIGFkZEJ1ZmZlci5jYWxsKHRoaXMsIHZhbHVlcy5zdWJhcnJheShmaXJzdE9mZnNldCwgZmlyc3RPZmZzZXQgKyBieXRlTGVuZ3RoKSk7IC8vIHNsaWNlZCB2YWx1ZXMgYnVmZmVyIHNlY29uZFxuICAgIHJldHVybiB0aGlzO1xufVxuXG5mdW5jdGlvbiBhc3NlbWJsZUxpc3RWZWN0b3I8VCBleHRlbmRzIExpc3QgfCBGaXhlZFNpemVMaXN0Pih0aGlzOiBWZWN0b3JBc3NlbWJsZXIsIHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICBjb25zdCB7IGxlbmd0aCwgdmFsdWVPZmZzZXRzIH0gPSB2ZWN0b3I7XG4gICAgLy8gSWYgd2UgaGF2ZSB2YWx1ZU9mZnNldHMgKExpc3RWZWN0b3IpLCBwdXNoIHRoYXQgYnVmZmVyIGZpcnN0XG4gICAgaWYgKHZhbHVlT2Zmc2V0cykge1xuICAgICAgICBhZGRCdWZmZXIuY2FsbCh0aGlzLCByZWJhc2VWYWx1ZU9mZnNldHModmFsdWVPZmZzZXRzWzBdLCBsZW5ndGgsIHZhbHVlT2Zmc2V0cykpO1xuICAgIH1cbiAgICAvLyBUaGVuIGluc2VydCB0aGUgTGlzdCdzIHZhbHVlcyBjaGlsZFxuICAgIHJldHVybiB0aGlzLnZpc2l0KHZlY3Rvci5nZXRDaGlsZEF0KDApISk7XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlTmVzdGVkVmVjdG9yPFQgZXh0ZW5kcyBTdHJ1Y3QgfCBNYXBfIHwgVW5pb24+KHRoaXM6IFZlY3RvckFzc2VtYmxlciwgdmVjdG9yOiBWVHlwZTxUPikge1xuICAgIHJldHVybiB0aGlzLnZpc2l0TWFueSh2ZWN0b3IudHlwZS5jaGlsZHJlbi5tYXAoKF8sIGkpID0+IHZlY3Rvci5nZXRDaGlsZEF0KGkpISkuZmlsdGVyKEJvb2xlYW4pKVswXTtcbn1cblxuVmVjdG9yQXNzZW1ibGVyLnByb3RvdHlwZS52aXNpdEJvb2wgICAgICAgICAgICA9ICAgICBhc3NlbWJsZUJvb2xWZWN0b3I7XG5WZWN0b3JBc3NlbWJsZXIucHJvdG90eXBlLnZpc2l0SW50ICAgICAgICAgICAgID0gICAgIGFzc2VtYmxlRmxhdFZlY3RvcjtcblZlY3RvckFzc2VtYmxlci5wcm90b3R5cGUudmlzaXRGbG9hdCAgICAgICAgICAgPSAgICAgYXNzZW1ibGVGbGF0VmVjdG9yO1xuVmVjdG9yQXNzZW1ibGVyLnByb3RvdHlwZS52aXNpdFV0ZjggICAgICAgICAgICA9IGFzc2VtYmxlRmxhdExpc3RWZWN0b3I7XG5WZWN0b3JBc3NlbWJsZXIucHJvdG90eXBlLnZpc2l0QmluYXJ5ICAgICAgICAgID0gYXNzZW1ibGVGbGF0TGlzdFZlY3RvcjtcblZlY3RvckFzc2VtYmxlci5wcm90b3R5cGUudmlzaXRGaXhlZFNpemVCaW5hcnkgPSAgICAgYXNzZW1ibGVGbGF0VmVjdG9yO1xuVmVjdG9yQXNzZW1ibGVyLnByb3RvdHlwZS52aXNpdERhdGUgICAgICAgICAgICA9ICAgICBhc3NlbWJsZUZsYXRWZWN0b3I7XG5WZWN0b3JBc3NlbWJsZXIucHJvdG90eXBlLnZpc2l0VGltZXN0YW1wICAgICAgID0gICAgIGFzc2VtYmxlRmxhdFZlY3RvcjtcblZlY3RvckFzc2VtYmxlci5wcm90b3R5cGUudmlzaXRUaW1lICAgICAgICAgICAgPSAgICAgYXNzZW1ibGVGbGF0VmVjdG9yO1xuVmVjdG9yQXNzZW1ibGVyLnByb3RvdHlwZS52aXNpdERlY2ltYWwgICAgICAgICA9ICAgICBhc3NlbWJsZUZsYXRWZWN0b3I7XG5WZWN0b3JBc3NlbWJsZXIucHJvdG90eXBlLnZpc2l0TGlzdCAgICAgICAgICAgID0gICAgIGFzc2VtYmxlTGlzdFZlY3RvcjtcblZlY3RvckFzc2VtYmxlci5wcm90b3R5cGUudmlzaXRTdHJ1Y3QgICAgICAgICAgPSAgIGFzc2VtYmxlTmVzdGVkVmVjdG9yO1xuVmVjdG9yQXNzZW1ibGVyLnByb3RvdHlwZS52aXNpdFVuaW9uICAgICAgICAgICA9ICAgICAgICAgIGFzc2VtYmxlVW5pb247XG5WZWN0b3JBc3NlbWJsZXIucHJvdG90eXBlLnZpc2l0SW50ZXJ2YWwgICAgICAgID0gICAgIGFzc2VtYmxlRmxhdFZlY3RvcjtcblZlY3RvckFzc2VtYmxlci5wcm90b3R5cGUudmlzaXRGaXhlZFNpemVMaXN0ICAgPSAgICAgYXNzZW1ibGVMaXN0VmVjdG9yO1xuVmVjdG9yQXNzZW1ibGVyLnByb3RvdHlwZS52aXNpdE1hcCAgICAgICAgICAgICA9ICAgYXNzZW1ibGVOZXN0ZWRWZWN0b3I7XG4iXX0=
