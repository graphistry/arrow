"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const bn_1 = require("../util/bn");
const column_1 = require("../column");
const vector_1 = require("../vector");
const visitor_1 = require("../visitor");
const recordbatch_1 = require("../recordbatch");
const enum_1 = require("../enum");
const enum_2 = require("../enum");
const bit_1 = require("../util/bit");
const array_1 = require("../util/array");
const type_1 = require("../type");
class JSONVectorAssembler extends visitor_1.Visitor {
    /** @nocollapse */
    static assemble(...args) {
        return new JSONVectorAssembler().visitMany(array_1.selectAndFlattenColumnChildren(recordbatch_1.RecordBatch, args));
    }
    visit(column) {
        const { data, name, length } = column;
        const { offset, nullCount, nullBitmap } = data;
        const type = type_1.DataType.isDictionary(column.type) ? column.type.indices : column.type;
        const buffers = Object.assign([], data.buffers, { [enum_1.VectorType.VALIDITY]: undefined });
        return {
            'name': name,
            'count': length,
            'VALIDITY': nullCount <= 0
                ? Array.from({ length }, () => 1)
                : [...bit_1.iterateBits(nullBitmap, offset, length, null, bit_1.getBit)],
            ...super.visit(vector_1.Vector.new(data.clone(type, offset, length, 0, buffers)))
        };
    }
    visitNull() { return {}; }
    visitBool({ values, offset, length }) {
        return { 'DATA': [...bit_1.iterateBits(values, offset, length, null, bit_1.getBool)] };
    }
    visitInt(vector) {
        return {
            'DATA': vector.type.bitWidth < 64
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitFloat(vector) {
        return { 'DATA': [...vector.values] };
    }
    visitUtf8(vector) {
        return { 'DATA': [...vector], 'OFFSET': [...vector.valueOffsets] };
    }
    visitBinary(vector) {
        return { 'DATA': [...binaryToString(vector)], OFFSET: [...vector.valueOffsets] };
    }
    visitFixedSizeBinary(vector) {
        return { 'DATA': [...binaryToString(vector)] };
    }
    visitDate(vector) {
        return {
            'DATA': vector.type.unit === enum_2.DateUnit.DAY
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitTimestamp(vector) {
        return { 'DATA': [...bigNumsToStrings(vector.values, 2)] };
    }
    visitTime(vector) {
        return {
            'DATA': vector.type.unit < enum_2.TimeUnit.MICROSECOND
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitDecimal(vector) {
        return { 'DATA': [...bigNumsToStrings(vector.values, 4)] };
    }
    visitList(vector) {
        return {
            'OFFSET': [...vector.valueOffsets],
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitStruct(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitUnion(vector) {
        return {
            'TYPE': [...vector.typeIds],
            'OFFSET': vector.type.mode === enum_2.UnionMode.Dense ? [...vector.valueOffsets] : undefined,
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitInterval(vector) {
        return { 'DATA': [...vector.values] };
    }
    visitFixedSizeList(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitMap(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
}
exports.JSONVectorAssembler = JSONVectorAssembler;
/** @ignore */
function* binaryToString(vector) {
    for (const octets of vector) {
        yield octets.reduce((str, byte) => {
            return `${str}${('0' + (byte & 0xFF).toString(16)).slice(-2)}`;
        }, '').toUpperCase();
    }
}
/** @ignore */
function* bigNumsToStrings(values, stride) {
    for (let i = -1, n = values.length / stride; ++i < n;) {
        yield `${bn_1.BN.new(values.subarray((i + 0) * stride, (i + 1) * stride))}`;
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpc2l0b3IvanNvbnZlY3RvcmFzc2VtYmxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsNkRBQTZEO0FBQzdELCtEQUErRDtBQUMvRCx3REFBd0Q7QUFDeEQsNkRBQTZEO0FBQzdELG9EQUFvRDtBQUNwRCw2REFBNkQ7QUFDN0QsNkRBQTZEO0FBQzdELEVBQUU7QUFDRiwrQ0FBK0M7QUFDL0MsRUFBRTtBQUNGLDZEQUE2RDtBQUM3RCw4REFBOEQ7QUFDOUQseURBQXlEO0FBQ3pELDREQUE0RDtBQUM1RCwwREFBMEQ7QUFDMUQscUJBQXFCOztBQUVyQixtQ0FBZ0M7QUFDaEMsc0NBQW1DO0FBQ25DLHNDQUFtQztBQUNuQyx3Q0FBcUM7QUFDckMsZ0RBQTZDO0FBRTdDLGtDQUFtRDtBQUNuRCxrQ0FBd0Q7QUFDeEQscUNBQTJEO0FBQzNELHlDQUErRDtBQUMvRCxrQ0FJaUI7QUEyQmpCLE1BQWEsbUJBQW9CLFNBQVEsaUJBQU87SUFFNUMsa0JBQWtCO0lBQ1gsTUFBTSxDQUFDLFFBQVEsQ0FBaUMsR0FBRyxJQUFpQjtRQUN2RSxPQUFPLElBQUksbUJBQW1CLEVBQUUsQ0FBQyxTQUFTLENBQUMsc0NBQThCLENBQUMseUJBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2xHLENBQUM7SUFFTSxLQUFLLENBQW1CLE1BQVM7UUFDcEMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDO1FBQ3RDLE1BQU0sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQztRQUMvQyxNQUFNLElBQUksR0FBRyxlQUFRLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDcEYsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsaUJBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ3RGLE9BQU87WUFDSCxNQUFNLEVBQUUsSUFBSTtZQUNaLE9BQU8sRUFBRSxNQUFNO1lBQ2YsVUFBVSxFQUFFLFNBQVMsSUFBSSxDQUFDO2dCQUN0QixDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDakMsQ0FBQyxDQUFDLENBQUMsR0FBRyxpQkFBVyxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxZQUFNLENBQUMsQ0FBQztZQUNoRSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsZUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzNFLENBQUM7SUFDTixDQUFDO0lBQ00sU0FBUyxLQUFLLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxQixTQUFTLENBQWlCLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQVk7UUFDakUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLEdBQUcsaUJBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsYUFBTyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQy9FLENBQUM7SUFDTSxRQUFRLENBQWdCLE1BQWdCO1FBQzNDLE9BQU87WUFDSCxNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRTtnQkFDN0IsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO2dCQUNwQixDQUFDLENBQUMsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxNQUFvQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQzlFLENBQUM7SUFDTixDQUFDO0lBQ00sVUFBVSxDQUFrQixNQUFnQjtRQUMvQyxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBQ00sU0FBUyxDQUFpQixNQUFnQjtRQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO0lBQ3ZFLENBQUM7SUFDTSxXQUFXLENBQW1CLE1BQWdCO1FBQ2pELE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUM7SUFDckYsQ0FBQztJQUNNLG9CQUFvQixDQUE0QixNQUFnQjtRQUNuRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ25ELENBQUM7SUFDTSxTQUFTLENBQWtCLE1BQWdCO1FBQzlDLE9BQU87WUFDSCxNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssZUFBUSxDQUFDLEdBQUc7Z0JBQ3JDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztnQkFDcEIsQ0FBQyxDQUFDLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2hELENBQUM7SUFDTixDQUFDO0lBQ00sY0FBYyxDQUFzQixNQUFnQjtRQUN2RCxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUMvRCxDQUFDO0lBQ00sU0FBUyxDQUFpQixNQUFnQjtRQUM3QyxPQUFPO1lBQ0gsTUFBTSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLGVBQVEsQ0FBQyxXQUFXO2dCQUMzQyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQ3BCLENBQUMsQ0FBQyxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNoRCxDQUFDO0lBQ04sQ0FBQztJQUNNLFlBQVksQ0FBb0IsTUFBZ0I7UUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDL0QsQ0FBQztJQUNNLFNBQVMsQ0FBaUIsTUFBZ0I7UUFDN0MsT0FBTztZQUNILFFBQVEsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUNsQyxVQUFVLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQzFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxlQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMxRCxDQUFDO0lBQ04sQ0FBQztJQUNNLFdBQVcsQ0FBbUIsTUFBZ0I7UUFDakQsT0FBTztZQUNILFVBQVUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FDMUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLGVBQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzFELENBQUM7SUFDTixDQUFDO0lBQ00sVUFBVSxDQUFrQixNQUFnQjtRQUMvQyxPQUFPO1lBQ0gsTUFBTSxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQzNCLFFBQVEsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxnQkFBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztZQUNyRixVQUFVLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLGVBQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3JHLENBQUM7SUFDTixDQUFDO0lBQ00sYUFBYSxDQUFxQixNQUFnQjtRQUNyRCxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBQ00sa0JBQWtCLENBQTBCLE1BQWdCO1FBQy9ELE9BQU87WUFDSCxVQUFVLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQzFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxlQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMxRCxDQUFDO0lBQ04sQ0FBQztJQUNNLFFBQVEsQ0FBaUIsTUFBZ0I7UUFDNUMsT0FBTztZQUNILFVBQVUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FDMUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLGVBQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzFELENBQUM7SUFDTixDQUFDO0NBQ0o7QUFuR0Qsa0RBbUdDO0FBRUQsY0FBYztBQUNkLFFBQVEsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFnRDtJQUNyRSxLQUFLLE1BQU0sTUFBTSxJQUFJLE1BQThCLEVBQUU7UUFDakQsTUFBTSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQzlCLE9BQU8sR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNuRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7S0FDeEI7QUFDTCxDQUFDO0FBRUQsY0FBYztBQUNkLFFBQVEsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLE1BQWdDLEVBQUUsTUFBYztJQUN2RSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxHQUFHLE1BQU0sRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUc7UUFDbkQsTUFBTSxHQUFHLE9BQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDO0tBQzFFO0FBQ0wsQ0FBQyIsImZpbGUiOiJ2aXNpdG9yL2pzb252ZWN0b3Jhc3NlbWJsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgQk4gfSBmcm9tICcuLi91dGlsL2JuJztcbmltcG9ydCB7IENvbHVtbiB9IGZyb20gJy4uL2NvbHVtbic7XG5pbXBvcnQgeyBWZWN0b3IgfSBmcm9tICcuLi92ZWN0b3InO1xuaW1wb3J0IHsgVmlzaXRvciB9IGZyb20gJy4uL3Zpc2l0b3InO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2ggfSBmcm9tICcuLi9yZWNvcmRiYXRjaCc7XG5pbXBvcnQgeyBWZWN0b3IgYXMgVlR5cGUgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFZlY3RvclR5cGUgYXMgQnVmZmVyVHlwZSB9IGZyb20gJy4uL2VudW0nO1xuaW1wb3J0IHsgVW5pb25Nb2RlLCBEYXRlVW5pdCwgVGltZVVuaXQgfSBmcm9tICcuLi9lbnVtJztcbmltcG9ydCB7IGl0ZXJhdGVCaXRzLCBnZXRCaXQsIGdldEJvb2wgfSBmcm9tICcuLi91dGlsL2JpdCc7XG5pbXBvcnQgeyBzZWxlY3RBbmRGbGF0dGVuQ29sdW1uQ2hpbGRyZW4gfSBmcm9tICcuLi91dGlsL2FycmF5JztcbmltcG9ydCB7XG4gICAgRGF0YVR5cGUsXG4gICAgRmxvYXQsIEludCwgRGF0ZV8sIEludGVydmFsLCBUaW1lLCBUaW1lc3RhbXAsIFVuaW9uLFxuICAgIEJvb2wsIE51bGwsIFV0ZjgsIEJpbmFyeSwgRGVjaW1hbCwgRml4ZWRTaXplQmluYXJ5LCBMaXN0LCBGaXhlZFNpemVMaXN0LCBNYXBfLCBTdHJ1Y3QsXG59IGZyb20gJy4uL3R5cGUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEpTT05WZWN0b3JBc3NlbWJsZXIgZXh0ZW5kcyBWaXNpdG9yIHtcblxuICAgIHZpc2l0ICAgICA8VCBleHRlbmRzIENvbHVtbj4gIChub2RlOiBUICApOiBvYmplY3Q7XG4gICAgdmlzaXRNYW55IDxUIGV4dGVuZHMgQ29sdW1uPiAgKGNvbHM6IFRbXSk6IG9iamVjdFtdO1xuICAgIGdldFZpc2l0Rm48VCBleHRlbmRzIERhdGFUeXBlPihub2RlOiBDb2x1bW48VD4pOiAoY29sdW1uOiBDb2x1bW48VD4pID0+IHsgbmFtZTogc3RyaW5nLCBjb3VudDogbnVtYmVyLCBWQUxJRElUWTogKDAgfCAxKVtdLCBEQVRBPzogYW55W10sIE9GRlNFVD86IG51bWJlcltdLCBUWVBFPzogbnVtYmVyW10sIGNoaWxkcmVuPzogYW55W10gfTtcblxuICAgIHZpc2l0TnVsbCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBOdWxsPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyB9O1xuICAgIHZpc2l0Qm9vbCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBCb29sPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBib29sZWFuW10gfTtcbiAgICB2aXNpdEludCAgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgSW50PiAgICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogKG51bWJlciB8IHN0cmluZylbXSAgfTtcbiAgICB2aXNpdEZsb2F0ICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgRmxvYXQ+ICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogbnVtYmVyW10gIH07XG4gICAgdmlzaXRVdGY4ICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIFV0Zjg+ICAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IHN0cmluZ1tdLCBPRkZTRVQ6IG51bWJlcltdIH07XG4gICAgdmlzaXRCaW5hcnkgICAgICAgICAgICAgICA8VCBleHRlbmRzIEJpbmFyeT4gICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IHN0cmluZ1tdLCBPRkZTRVQ6IG51bWJlcltdIH07XG4gICAgdmlzaXRGaXhlZFNpemVCaW5hcnkgICAgICA8VCBleHRlbmRzIEZpeGVkU2l6ZUJpbmFyeT4gKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IHN0cmluZ1tdICB9O1xuICAgIHZpc2l0RGF0ZSAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBEYXRlXz4gICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBudW1iZXJbXSAgfTtcbiAgICB2aXNpdFRpbWVzdGFtcCAgICAgICAgICAgIDxUIGV4dGVuZHMgVGltZXN0YW1wPiAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogc3RyaW5nW10gIH07XG4gICAgdmlzaXRUaW1lICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIFRpbWU+ICAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IG51bWJlcltdICB9O1xuICAgIHZpc2l0RGVjaW1hbCAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBEZWNpbWFsPiAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBzdHJpbmdbXSAgfTtcbiAgICB2aXNpdExpc3QgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgTGlzdD4gICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgY2hpbGRyZW46IGFueVtdLCBPRkZTRVQ6IG51bWJlcltdIH07XG4gICAgdmlzaXRTdHJ1Y3QgICAgICAgICAgICAgICA8VCBleHRlbmRzIFN0cnVjdD4gICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IGNoaWxkcmVuOiBhbnlbXSB9O1xuICAgIHZpc2l0VW5pb24gICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBVbmlvbj4gICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBjaGlsZHJlbjogYW55W10sIFRZUEU6IG51bWJlcltdLCAgfTtcbiAgICB2aXNpdEludGVydmFsICAgICAgICAgICAgIDxUIGV4dGVuZHMgSW50ZXJ2YWw+ICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogbnVtYmVyW10gIH07XG4gICAgdmlzaXRGaXhlZFNpemVMaXN0ICAgICAgICA8VCBleHRlbmRzIEZpeGVkU2l6ZUxpc3Q+ICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IGNoaWxkcmVuOiBhbnlbXSB9O1xuICAgIHZpc2l0TWFwICAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBNYXBfPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBjaGlsZHJlbjogYW55W10gfTtcbn1cblxuZXhwb3J0IGNsYXNzIEpTT05WZWN0b3JBc3NlbWJsZXIgZXh0ZW5kcyBWaXNpdG9yIHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYXNzZW1ibGU8VCBleHRlbmRzIENvbHVtbiB8IFJlY29yZEJhdGNoPiguLi5hcmdzOiAoVCB8IFRbXSlbXSkge1xuICAgICAgICByZXR1cm4gbmV3IEpTT05WZWN0b3JBc3NlbWJsZXIoKS52aXNpdE1hbnkoc2VsZWN0QW5kRmxhdHRlbkNvbHVtbkNoaWxkcmVuKFJlY29yZEJhdGNoLCBhcmdzKSk7XG4gICAgfVxuXG4gICAgcHVibGljIHZpc2l0PFQgZXh0ZW5kcyBDb2x1bW4+KGNvbHVtbjogVCkge1xuICAgICAgICBjb25zdCB7IGRhdGEsIG5hbWUsIGxlbmd0aCB9ID0gY29sdW1uO1xuICAgICAgICBjb25zdCB7IG9mZnNldCwgbnVsbENvdW50LCBudWxsQml0bWFwIH0gPSBkYXRhO1xuICAgICAgICBjb25zdCB0eXBlID0gRGF0YVR5cGUuaXNEaWN0aW9uYXJ5KGNvbHVtbi50eXBlKSA/IGNvbHVtbi50eXBlLmluZGljZXMgOiBjb2x1bW4udHlwZTtcbiAgICAgICAgY29uc3QgYnVmZmVycyA9IE9iamVjdC5hc3NpZ24oW10sIGRhdGEuYnVmZmVycywgeyBbQnVmZmVyVHlwZS5WQUxJRElUWV06IHVuZGVmaW5lZCB9KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICduYW1lJzogbmFtZSxcbiAgICAgICAgICAgICdjb3VudCc6IGxlbmd0aCxcbiAgICAgICAgICAgICdWQUxJRElUWSc6IG51bGxDb3VudCA8PSAwXG4gICAgICAgICAgICAgICAgPyBBcnJheS5mcm9tKHsgbGVuZ3RoIH0sICgpID0+IDEpXG4gICAgICAgICAgICAgICAgOiBbLi4uaXRlcmF0ZUJpdHMobnVsbEJpdG1hcCwgb2Zmc2V0LCBsZW5ndGgsIG51bGwsIGdldEJpdCldLFxuICAgICAgICAgICAgLi4uc3VwZXIudmlzaXQoVmVjdG9yLm5ldyhkYXRhLmNsb25lKHR5cGUsIG9mZnNldCwgbGVuZ3RoLCAwLCBidWZmZXJzKSkpXG4gICAgICAgIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdE51bGwoKSB7IHJldHVybiB7fTsgfVxuICAgIHB1YmxpYyB2aXNpdEJvb2w8VCBleHRlbmRzIEJvb2w+KHsgdmFsdWVzLCBvZmZzZXQsIGxlbmd0aCB9OiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4geyAnREFUQSc6IFsuLi5pdGVyYXRlQml0cyh2YWx1ZXMsIG9mZnNldCwgbGVuZ3RoLCBudWxsLCBnZXRCb29sKV0gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0SW50PFQgZXh0ZW5kcyBJbnQ+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdEQVRBJzogdmVjdG9yLnR5cGUuYml0V2lkdGggPCA2NFxuICAgICAgICAgICAgICAgID8gWy4uLnZlY3Rvci52YWx1ZXNdXG4gICAgICAgICAgICAgICAgOiBbLi4uYmlnTnVtc1RvU3RyaW5ncyh2ZWN0b3IudmFsdWVzIGFzIChJbnQzMkFycmF5IHwgVWludDMyQXJyYXkpLCAyKV1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0RmxvYXQ8VCBleHRlbmRzIEZsb2F0Pih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7ICdEQVRBJzogWy4uLnZlY3Rvci52YWx1ZXNdIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdFV0Zjg8VCBleHRlbmRzIFV0Zjg+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4udmVjdG9yXSwgJ09GRlNFVCc6IFsuLi52ZWN0b3IudmFsdWVPZmZzZXRzXSB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRCaW5hcnk8VCBleHRlbmRzIEJpbmFyeT4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4geyAnREFUQSc6IFsuLi5iaW5hcnlUb1N0cmluZyh2ZWN0b3IpXSwgT0ZGU0VUOiBbLi4udmVjdG9yLnZhbHVlT2Zmc2V0c10gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0Rml4ZWRTaXplQmluYXJ5PFQgZXh0ZW5kcyBGaXhlZFNpemVCaW5hcnk+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uYmluYXJ5VG9TdHJpbmcodmVjdG9yKV0gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0RGF0ZTxUIGV4dGVuZHMgRGF0ZV8+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdEQVRBJzogdmVjdG9yLnR5cGUudW5pdCA9PT0gRGF0ZVVuaXQuREFZXG4gICAgICAgICAgICAgICAgPyBbLi4udmVjdG9yLnZhbHVlc11cbiAgICAgICAgICAgICAgICA6IFsuLi5iaWdOdW1zVG9TdHJpbmdzKHZlY3Rvci52YWx1ZXMsIDIpXVxuICAgICAgICB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRUaW1lc3RhbXA8VCBleHRlbmRzIFRpbWVzdGFtcD4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4geyAnREFUQSc6IFsuLi5iaWdOdW1zVG9TdHJpbmdzKHZlY3Rvci52YWx1ZXMsIDIpXSB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRUaW1lPFQgZXh0ZW5kcyBUaW1lPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnREFUQSc6IHZlY3Rvci50eXBlLnVuaXQgPCBUaW1lVW5pdC5NSUNST1NFQ09ORFxuICAgICAgICAgICAgICAgID8gWy4uLnZlY3Rvci52YWx1ZXNdXG4gICAgICAgICAgICAgICAgOiBbLi4uYmlnTnVtc1RvU3RyaW5ncyh2ZWN0b3IudmFsdWVzLCAyKV1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0RGVjaW1hbDxUIGV4dGVuZHMgRGVjaW1hbD4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4geyAnREFUQSc6IFsuLi5iaWdOdW1zVG9TdHJpbmdzKHZlY3Rvci52YWx1ZXMsIDQpXSB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRMaXN0PFQgZXh0ZW5kcyBMaXN0Pih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnT0ZGU0VUJzogWy4uLnZlY3Rvci52YWx1ZU9mZnNldHNdLFxuICAgICAgICAgICAgJ2NoaWxkcmVuJzogdmVjdG9yLnR5cGUuY2hpbGRyZW4ubWFwKChmLCBpKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMudmlzaXQobmV3IENvbHVtbihmLCBbdmVjdG9yLmdldENoaWxkQXQoaSkhXSkpKVxuICAgICAgICB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRTdHJ1Y3Q8VCBleHRlbmRzIFN0cnVjdD4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ2NoaWxkcmVuJzogdmVjdG9yLnR5cGUuY2hpbGRyZW4ubWFwKChmLCBpKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMudmlzaXQobmV3IENvbHVtbihmLCBbdmVjdG9yLmdldENoaWxkQXQoaSkhXSkpKVxuICAgICAgICB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRVbmlvbjxUIGV4dGVuZHMgVW5pb24+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdUWVBFJzogWy4uLnZlY3Rvci50eXBlSWRzXSxcbiAgICAgICAgICAgICdPRkZTRVQnOiB2ZWN0b3IudHlwZS5tb2RlID09PSBVbmlvbk1vZGUuRGVuc2UgPyBbLi4udmVjdG9yLnZhbHVlT2Zmc2V0c10gOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAnY2hpbGRyZW4nOiB2ZWN0b3IudHlwZS5jaGlsZHJlbi5tYXAoKGYsIGkpID0+IHRoaXMudmlzaXQobmV3IENvbHVtbihmLCBbdmVjdG9yLmdldENoaWxkQXQoaSkhXSkpKVxuICAgICAgICB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRJbnRlcnZhbDxUIGV4dGVuZHMgSW50ZXJ2YWw+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4udmVjdG9yLnZhbHVlc10gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0Rml4ZWRTaXplTGlzdDxUIGV4dGVuZHMgRml4ZWRTaXplTGlzdD4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ2NoaWxkcmVuJzogdmVjdG9yLnR5cGUuY2hpbGRyZW4ubWFwKChmLCBpKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMudmlzaXQobmV3IENvbHVtbihmLCBbdmVjdG9yLmdldENoaWxkQXQoaSkhXSkpKVxuICAgICAgICB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRNYXA8VCBleHRlbmRzIE1hcF8+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdjaGlsZHJlbic6IHZlY3Rvci50eXBlLmNoaWxkcmVuLm1hcCgoZiwgaSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiogYmluYXJ5VG9TdHJpbmcodmVjdG9yOiBWZWN0b3I8QmluYXJ5PiB8IFZlY3RvcjxGaXhlZFNpemVCaW5hcnk+KSB7XG4gICAgZm9yIChjb25zdCBvY3RldHMgb2YgdmVjdG9yIGFzIEl0ZXJhYmxlPFVpbnQ4QXJyYXk+KSB7XG4gICAgICAgIHlpZWxkIG9jdGV0cy5yZWR1Y2UoKHN0ciwgYnl0ZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGAke3N0cn0keygnMCcgKyAoYnl0ZSAmIDB4RkYpLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTIpfWA7XG4gICAgICAgIH0sICcnKS50b1VwcGVyQ2FzZSgpO1xuICAgIH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uKiBiaWdOdW1zVG9TdHJpbmdzKHZhbHVlczogVWludDMyQXJyYXkgfCBJbnQzMkFycmF5LCBzdHJpZGU6IG51bWJlcikge1xuICAgIGZvciAobGV0IGkgPSAtMSwgbiA9IHZhbHVlcy5sZW5ndGggLyBzdHJpZGU7ICsraSA8IG47KSB7XG4gICAgICAgIHlpZWxkIGAke0JOLm5ldyh2YWx1ZXMuc3ViYXJyYXkoKGkgKyAwKSAqIHN0cmlkZSwgKGkgKyAxKSAqIHN0cmlkZSkpfWA7XG4gICAgfVxufVxuIl19
