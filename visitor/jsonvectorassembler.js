"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const bn_1 = require("../util/bn");
const column_1 = require("../column");
const vector_1 = require("../vector");
const visitor_1 = require("../visitor");
const recordbatch_1 = require("../recordbatch");
const enum_1 = require("../enum");
const enum_2 = require("../enum");
const bit_1 = require("../util/bit");
const type_1 = require("../type");
class JSONVectorAssembler extends visitor_1.Visitor {
    /** @nocollapse */
    static assemble(...args) {
        const vectors = args.reduce(function flatten(xs, x) {
            if (Array.isArray(x)) {
                return x.reduce(flatten, xs);
            }
            if (!(x instanceof recordbatch_1.RecordBatch)) {
                return [...xs, x];
            }
            return xs.concat(x.schema.fields.map((f, i) => new column_1.Column(f, [x.getChildAt(i)])));
        }, []).filter((x) => x instanceof column_1.Column);
        return new JSONVectorAssembler().visitMany(vectors);
    }
    visit(column) {
        const { data, name, length } = column;
        const { offset, nullCount, nullBitmap } = data;
        const type = type_1.DataType.isDictionary(column.type) ? column.type.indices : column.type;
        const buffers = Object.assign([], data.buffers, { [enum_1.VectorType.VALIDITY]: undefined });
        return {
            'name': name,
            'count': length,
            'VALIDITY': nullCount <= 0
                ? Array.from({ length }, () => 1)
                : [...bit_1.iterateBits(nullBitmap, offset, length, null, bit_1.getBit)],
            ...super.visit(vector_1.Vector.new(data.clone(type, offset, length, 0, buffers)))
        };
    }
    visitNull() { return {}; }
    visitBool({ values, offset, length }) {
        return { 'DATA': [...bit_1.iterateBits(values, offset, length, null, bit_1.getBool)] };
    }
    visitInt(vector) {
        return {
            'DATA': vector.type.bitWidth < 64
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitFloat(vector) {
        return { 'DATA': [...vector.values] };
    }
    visitUtf8(vector) {
        return { 'DATA': [...vector], 'OFFSET': [...vector.valueOffsets] };
    }
    visitBinary(vector) {
        return { 'DATA': [...binaryToString(vector)], OFFSET: [...vector.valueOffsets] };
    }
    visitFixedSizeBinary(vector) {
        return { 'DATA': [...binaryToString(vector)] };
    }
    visitDate(vector) {
        return {
            'DATA': vector.type.unit === enum_2.DateUnit.DAY
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitTimestamp(vector) {
        return { 'DATA': [...bigNumsToStrings(vector.values, 2)] };
    }
    visitTime(vector) {
        return {
            'DATA': vector.type.unit < enum_2.TimeUnit.MICROSECOND
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitDecimal(vector) {
        return { 'DATA': [...bigNumsToStrings(vector.values, 4)] };
    }
    visitList(vector) {
        return {
            'OFFSET': [...vector.valueOffsets],
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitStruct(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitUnion(vector) {
        return {
            'TYPE': [...vector.typeIds],
            'OFFSET': vector.type.mode === enum_2.UnionMode.Dense ? [...vector.valueOffsets] : undefined,
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitInterval(vector) {
        return { 'DATA': [...vector.values] };
    }
    visitFixedSizeList(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitMap(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
}
exports.JSONVectorAssembler = JSONVectorAssembler;
/** @ignore */
function* binaryToString(vector) {
    for (const octets of vector) {
        yield octets.reduce((str, byte) => {
            return `${str}${('0' + (byte & 0xFF).toString(16)).slice(-2)}`;
        }, '').toUpperCase();
    }
}
/** @ignore */
function* bigNumsToStrings(values, stride) {
    for (let i = -1, n = values.length / stride; ++i < n;) {
        yield `${bn_1.BN.new(values.subarray((i + 0) * stride, (i + 1) * stride))}`;
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpc2l0b3IvanNvbnZlY3RvcmFzc2VtYmxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsNkRBQTZEO0FBQzdELCtEQUErRDtBQUMvRCx3REFBd0Q7QUFDeEQsNkRBQTZEO0FBQzdELG9EQUFvRDtBQUNwRCw2REFBNkQ7QUFDN0QsNkRBQTZEO0FBQzdELEVBQUU7QUFDRiwrQ0FBK0M7QUFDL0MsRUFBRTtBQUNGLDZEQUE2RDtBQUM3RCw4REFBOEQ7QUFDOUQseURBQXlEO0FBQ3pELDREQUE0RDtBQUM1RCwwREFBMEQ7QUFDMUQscUJBQXFCOztBQUVyQixtQ0FBZ0M7QUFDaEMsc0NBQW1DO0FBQ25DLHNDQUFtQztBQUNuQyx3Q0FBcUM7QUFDckMsZ0RBQTZDO0FBRTdDLGtDQUFtRDtBQUNuRCxrQ0FBd0Q7QUFDeEQscUNBQTJEO0FBQzNELGtDQUlpQjtBQTJCakIsTUFBYSxtQkFBb0IsU0FBUSxpQkFBTztJQUU1QyxrQkFBa0I7SUFDWCxNQUFNLENBQUMsUUFBUSxDQUFpQyxHQUFHLElBQWlCO1FBRXZFLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxPQUFPLENBQUMsRUFBUyxFQUFFLENBQU07WUFDMUQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUFFLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFBRTtZQUN2RCxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVkseUJBQVcsQ0FBQyxFQUFFO2dCQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUFFO1lBQ3ZELE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2hDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxlQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxD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LENBQUMsRUFBRSxDQUFDO1FBQ25FLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztLQUN4QjtBQUNMLENBQUM7QUFFRCxjQUFjO0FBQ2QsUUFBUSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsTUFBZ0MsRUFBRSxNQUFjO0lBQ3ZFLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRztRQUNuRCxNQUFNLEdBQUcsT0FBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUM7S0FDMUU7QUFDTCxDQUFDIiwiZmlsZSI6InZpc2l0b3IvanNvbnZlY3RvcmFzc2VtYmxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBCTiB9IGZyb20gJy4uL3V0aWwvYm4nO1xuaW1wb3J0IHsgQ29sdW1uIH0gZnJvbSAnLi4vY29sdW1uJztcbmltcG9ydCB7IFZlY3RvciB9IGZyb20gJy4uL3ZlY3Rvcic7XG5pbXBvcnQgeyBWaXNpdG9yIH0gZnJvbSAnLi4vdmlzaXRvcic7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaCB9IGZyb20gJy4uL3JlY29yZGJhdGNoJztcbmltcG9ydCB7IFZlY3RvciBhcyBWVHlwZSB9IGZyb20gJy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgVmVjdG9yVHlwZSBhcyBCdWZmZXJUeXBlIH0gZnJvbSAnLi4vZW51bSc7XG5pbXBvcnQgeyBVbmlvbk1vZGUsIERhdGVVbml0LCBUaW1lVW5pdCB9IGZyb20gJy4uL2VudW0nO1xuaW1wb3J0IHsgaXRlcmF0ZUJpdHMsIGdldEJpdCwgZ2V0Qm9vbCB9IGZyb20gJy4uL3V0aWwvYml0JztcbmltcG9ydCB7XG4gICAgRGF0YVR5cGUsXG4gICAgRmxvYXQsIEludCwgRGF0ZV8sIEludGVydmFsLCBUaW1lLCBUaW1lc3RhbXAsIFVuaW9uLFxuICAgIEJvb2wsIE51bGwsIFV0ZjgsIEJpbmFyeSwgRGVjaW1hbCwgRml4ZWRTaXplQmluYXJ5LCBMaXN0LCBGaXhlZFNpemVMaXN0LCBNYXBfLCBTdHJ1Y3QsXG59IGZyb20gJy4uL3R5cGUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEpTT05WZWN0b3JBc3NlbWJsZXIgZXh0ZW5kcyBWaXNpdG9yIHtcblxuICAgIHZpc2l0ICAgICA8VCBleHRlbmRzIENvbHVtbj4gIChub2RlOiBUICApOiBvYmplY3Q7XG4gICAgdmlzaXRNYW55IDxUIGV4dGVuZHMgQ29sdW1uPiAgKGNvbHM6IFRbXSk6IG9iamVjdFtdO1xuICAgIGdldFZpc2l0Rm48VCBleHRlbmRzIERhdGFUeXBlPihub2RlOiBDb2x1bW48VD4pOiAoY29sdW1uOiBDb2x1bW48VD4pID0+IHsgbmFtZTogc3RyaW5nLCBjb3VudDogbnVtYmVyLCBWQUxJRElUWTogKDAgfCAxKVtdLCBEQVRBPzogYW55W10sIE9GRlNFVD86IG51bWJlcltdLCBUWVBFPzogbnVtYmVyW10sIGNoaWxkcmVuPzogYW55W10gfTtcblxuICAgIHZpc2l0TnVsbCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBOdWxsPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyB9O1xuICAgIHZpc2l0Qm9vbCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBCb29sPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBib29sZWFuW10gfTtcbiAgICB2aXNpdEludCAgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgSW50PiAgICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogKG51bWJlciB8IHN0cmluZylbXSAgfTtcbiAgICB2aXNpdEZsb2F0ICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgRmxvYXQ+ICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogbnVtYmVyW10gIH07XG4gICAgdmlzaXRVdGY4ICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIFV0Zjg+ICAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IHN0cmluZ1tdLCBPRkZTRVQ6IG51bWJlcltdIH07XG4gICAgdmlzaXRCaW5hcnkgICAgICAgICAgICAgICA8VCBleHRlbmRzIEJpbmFyeT4gICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IHN0cmluZ1tdLCBPRkZTRVQ6IG51bWJlcltdIH07XG4gICAgdmlzaXRGaXhlZFNpemVCaW5hcnkgICAgICA8VCBleHRlbmRzIEZpeGVkU2l6ZUJpbmFyeT4gKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IHN0cmluZ1tdICB9O1xuICAgIHZpc2l0RGF0ZSAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBEYXRlXz4gICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBudW1iZXJbXSAgfTtcbiAgICB2aXNpdFRpbWVzdGFtcCAgICAgICAgICAgIDxUIGV4dGVuZHMgVGltZXN0YW1wPiAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogc3RyaW5nW10gIH07XG4gICAgdmlzaXRUaW1lICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIFRpbWU+ICAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IG51bWJlcltdICB9O1xuICAgIHZpc2l0RGVjaW1hbCAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBEZWNpbWFsPiAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBzdHJpbmdbXSAgfTtcbiAgICB2aXNpdExpc3QgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgTGlzdD4gICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgY2hpbGRyZW46IGFueVtdLCBPRkZTRVQ6IG51bWJlcltdIH07XG4gICAgdmlzaXRTdHJ1Y3QgICAgICAgICAgICAgICA8VCBleHRlbmRzIFN0cnVjdD4gICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IGNoaWxkcmVuOiBhbnlbXSB9O1xuICAgIHZpc2l0VW5pb24gICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBVbmlvbj4gICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBjaGlsZHJlbjogYW55W10sIFRZUEU6IG51bWJlcltdLCAgfTtcbiAgICB2aXNpdEludGVydmFsICAgICAgICAgICAgIDxUIGV4dGVuZHMgSW50ZXJ2YWw+ICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogbnVtYmVyW10gIH07XG4gICAgdmlzaXRGaXhlZFNpemVMaXN0ICAgICAgICA8VCBleHRlbmRzIEZpeGVkU2l6ZUxpc3Q+ICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IGNoaWxkcmVuOiBhbnlbXSB9O1xuICAgIHZpc2l0TWFwICAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBNYXBfPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBjaGlsZHJlbjogYW55W10gfTtcbn1cblxuZXhwb3J0IGNsYXNzIEpTT05WZWN0b3JBc3NlbWJsZXIgZXh0ZW5kcyBWaXNpdG9yIHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYXNzZW1ibGU8VCBleHRlbmRzIENvbHVtbiB8IFJlY29yZEJhdGNoPiguLi5hcmdzOiAoVCB8IFRbXSlbXSkge1xuXG4gICAgICAgIGNvbnN0IHZlY3RvcnMgPSBhcmdzLnJlZHVjZShmdW5jdGlvbiBmbGF0dGVuKHhzOiBhbnlbXSwgeDogYW55KTogYW55W10ge1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoeCkpIHsgcmV0dXJuIHgucmVkdWNlKGZsYXR0ZW4sIHhzKTsgfVxuICAgICAgICAgICAgaWYgKCEoeCBpbnN0YW5jZW9mIFJlY29yZEJhdGNoKSkgeyByZXR1cm4gWy4uLnhzLCB4XTsgfVxuICAgICAgICAgICAgcmV0dXJuIHhzLmNvbmNhdCh4LnNjaGVtYS5maWVsZHMubWFwKFxuICAgICAgICAgICAgICAgIChmLCBpKSA9PiBuZXcgQ29sdW1uKGYsIFt4LmdldENoaWxkQXQoaSkhXSkpKTtcbiAgICAgICAgfSwgW10pLmZpbHRlcigoeDogYW55KTogeCBpcyBDb2x1bW4gPT4geCBpbnN0YW5jZW9mIENvbHVtbik7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBKU09OVmVjdG9yQXNzZW1ibGVyKCkudmlzaXRNYW55KHZlY3RvcnMpO1xuICAgIH1cblxuICAgIHB1YmxpYyB2aXNpdDxUIGV4dGVuZHMgQ29sdW1uPihjb2x1bW46IFQpIHtcbiAgICAgICAgY29uc3QgeyBkYXRhLCBuYW1lLCBsZW5ndGggfSA9IGNvbHVtbjtcbiAgICAgICAgY29uc3QgeyBvZmZzZXQsIG51bGxDb3VudCwgbnVsbEJpdG1hcCB9ID0gZGF0YTtcbiAgICAgICAgY29uc3QgdHlwZSA9IERhdGFUeXBlLmlzRGljdGlvbmFyeShjb2x1bW4udHlwZSkgPyBjb2x1bW4udHlwZS5pbmRpY2VzIDogY29sdW1uLnR5cGU7XG4gICAgICAgIGNvbnN0IGJ1ZmZlcnMgPSBPYmplY3QuYXNzaWduKFtdLCBkYXRhLmJ1ZmZlcnMsIHsgW0J1ZmZlclR5cGUuVkFMSURJVFldOiB1bmRlZmluZWQgfSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnbmFtZSc6IG5hbWUsXG4gICAgICAgICAgICAnY291bnQnOiBsZW5ndGgsXG4gICAgICAgICAgICAnVkFMSURJVFknOiBudWxsQ291bnQgPD0gMFxuICAgICAgICAgICAgICAgID8gQXJyYXkuZnJvbSh7IGxlbmd0aCB9LCAoKSA9PiAxKVxuICAgICAgICAgICAgICAgIDogWy4uLml0ZXJhdGVCaXRzKG51bGxCaXRtYXAsIG9mZnNldCwgbGVuZ3RoLCBudWxsLCBnZXRCaXQpXSxcbiAgICAgICAgICAgIC4uLnN1cGVyLnZpc2l0KFZlY3Rvci5uZXcoZGF0YS5jbG9uZSh0eXBlLCBvZmZzZXQsIGxlbmd0aCwgMCwgYnVmZmVycykpKVxuICAgICAgICB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXROdWxsKCkgeyByZXR1cm4ge307IH1cbiAgICBwdWJsaWMgdmlzaXRCb29sPFQgZXh0ZW5kcyBCb29sPih7IHZhbHVlcywgb2Zmc2V0LCBsZW5ndGggfTogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uaXRlcmF0ZUJpdHModmFsdWVzLCBvZmZzZXQsIGxlbmd0aCwgbnVsbCwgZ2V0Qm9vbCldIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdEludDxUIGV4dGVuZHMgSW50Pih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnREFUQSc6IHZlY3Rvci50eXBlLmJpdFdpZHRoIDwgNjRcbiAgICAgICAgICAgICAgICA/IFsuLi52ZWN0b3IudmFsdWVzXVxuICAgICAgICAgICAgICAgIDogWy4uLmJpZ051bXNUb1N0cmluZ3ModmVjdG9yLnZhbHVlcyBhcyAoSW50MzJBcnJheSB8IFVpbnQzMkFycmF5KSwgMildXG4gICAgICAgIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdEZsb2F0PFQgZXh0ZW5kcyBGbG9hdD4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4geyAnREFUQSc6IFsuLi52ZWN0b3IudmFsdWVzXSB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRVdGY4PFQgZXh0ZW5kcyBVdGY4Pih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7ICdEQVRBJzogWy4uLnZlY3Rvcl0sICdPRkZTRVQnOiBbLi4udmVjdG9yLnZhbHVlT2Zmc2V0c10gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0QmluYXJ5PFQgZXh0ZW5kcyBCaW5hcnk+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uYmluYXJ5VG9TdHJpbmcodmVjdG9yKV0sIE9GRlNFVDogWy4uLnZlY3Rvci52YWx1ZU9mZnNldHNdIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdEZpeGVkU2l6ZUJpbmFyeTxUIGV4dGVuZHMgRml4ZWRTaXplQmluYXJ5Pih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7ICdEQVRBJzogWy4uLmJpbmFyeVRvU3RyaW5nKHZlY3RvcildIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdERhdGU8VCBleHRlbmRzIERhdGVfPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnREFUQSc6IHZlY3Rvci50eXBlLnVuaXQgPT09IERhdGVVbml0LkRBWVxuICAgICAgICAgICAgICAgID8gWy4uLnZlY3Rvci52YWx1ZXNdXG4gICAgICAgICAgICAgICAgOiBbLi4uYmlnTnVtc1RvU3RyaW5ncyh2ZWN0b3IudmFsdWVzLCAyKV1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0VGltZXN0YW1wPFQgZXh0ZW5kcyBUaW1lc3RhbXA+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uYmlnTnVtc1RvU3RyaW5ncyh2ZWN0b3IudmFsdWVzLCAyKV0gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0VGltZTxUIGV4dGVuZHMgVGltZT4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ0RBVEEnOiB2ZWN0b3IudHlwZS51bml0IDwgVGltZVVuaXQuTUlDUk9TRUNPTkRcbiAgICAgICAgICAgICAgICA/IFsuLi52ZWN0b3IudmFsdWVzXVxuICAgICAgICAgICAgICAgIDogWy4uLmJpZ051bXNUb1N0cmluZ3ModmVjdG9yLnZhbHVlcywgMildXG4gICAgICAgIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdERlY2ltYWw8VCBleHRlbmRzIERlY2ltYWw+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uYmlnTnVtc1RvU3RyaW5ncyh2ZWN0b3IudmFsdWVzLCA0KV0gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0TGlzdDxUIGV4dGVuZHMgTGlzdD4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ09GRlNFVCc6IFsuLi52ZWN0b3IudmFsdWVPZmZzZXRzXSxcbiAgICAgICAgICAgICdjaGlsZHJlbic6IHZlY3Rvci50eXBlLmNoaWxkcmVuLm1hcCgoZiwgaSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0U3RydWN0PFQgZXh0ZW5kcyBTdHJ1Y3Q+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdjaGlsZHJlbic6IHZlY3Rvci50eXBlLmNoaWxkcmVuLm1hcCgoZiwgaSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0VW5pb248VCBleHRlbmRzIFVuaW9uPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnVFlQRSc6IFsuLi52ZWN0b3IudHlwZUlkc10sXG4gICAgICAgICAgICAnT0ZGU0VUJzogdmVjdG9yLnR5cGUubW9kZSA9PT0gVW5pb25Nb2RlLkRlbnNlID8gWy4uLnZlY3Rvci52YWx1ZU9mZnNldHNdIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgJ2NoaWxkcmVuJzogdmVjdG9yLnR5cGUuY2hpbGRyZW4ubWFwKChmLCBpKSA9PiB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0SW50ZXJ2YWw8VCBleHRlbmRzIEludGVydmFsPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7ICdEQVRBJzogWy4uLnZlY3Rvci52YWx1ZXNdIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdEZpeGVkU2l6ZUxpc3Q8VCBleHRlbmRzIEZpeGVkU2l6ZUxpc3Q+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdjaGlsZHJlbic6IHZlY3Rvci50eXBlLmNoaWxkcmVuLm1hcCgoZiwgaSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0TWFwPFQgZXh0ZW5kcyBNYXBfPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnY2hpbGRyZW4nOiB2ZWN0b3IudHlwZS5jaGlsZHJlbi5tYXAoKGYsIGkpID0+XG4gICAgICAgICAgICAgICAgdGhpcy52aXNpdChuZXcgQ29sdW1uKGYsIFt2ZWN0b3IuZ2V0Q2hpbGRBdChpKSFdKSkpXG4gICAgICAgIH07XG4gICAgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24qIGJpbmFyeVRvU3RyaW5nKHZlY3RvcjogVmVjdG9yPEJpbmFyeT4gfCBWZWN0b3I8Rml4ZWRTaXplQmluYXJ5Pikge1xuICAgIGZvciAoY29uc3Qgb2N0ZXRzIG9mIHZlY3RvciBhcyBJdGVyYWJsZTxVaW50OEFycmF5Pikge1xuICAgICAgICB5aWVsZCBvY3RldHMucmVkdWNlKChzdHIsIGJ5dGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBgJHtzdHJ9JHsoJzAnICsgKGJ5dGUgJiAweEZGKS50b1N0cmluZygxNikpLnNsaWNlKC0yKX1gO1xuICAgICAgICB9LCAnJykudG9VcHBlckNhc2UoKTtcbiAgICB9XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiogYmlnTnVtc1RvU3RyaW5ncyh2YWx1ZXM6IFVpbnQzMkFycmF5IHwgSW50MzJBcnJheSwgc3RyaWRlOiBudW1iZXIpIHtcbiAgICBmb3IgKGxldCBpID0gLTEsIG4gPSB2YWx1ZXMubGVuZ3RoIC8gc3RyaWRlOyArK2kgPCBuOykge1xuICAgICAgICB5aWVsZCBgJHtCTi5uZXcodmFsdWVzLnN1YmFycmF5KChpICsgMCkgKiBzdHJpZGUsIChpICsgMSkgKiBzdHJpZGUpKX1gO1xuICAgIH1cbn1cbiJdfQ==
