"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const column_1 = require("../column");
const vector_1 = require("../vector");
const visitor_1 = require("../visitor");
const recordbatch_1 = require("../recordbatch");
const enum_1 = require("../enum");
const enum_2 = require("../enum");
const bit_1 = require("../util/bit");
const type_1 = require("../type");
class JSONVectorAssembler extends visitor_1.Visitor {
    /** @nocollapse */
    static assemble(...args) {
        const vectors = args.reduce(function flatten(xs, x) {
            if (Array.isArray(x)) {
                return x.reduce(flatten, xs);
            }
            if (!(x instanceof recordbatch_1.RecordBatch)) {
                return [...xs, x];
            }
            return xs.concat(x.schema.fields.map((f, i) => new column_1.Column(f, [x.getChildAt(i)])));
        }, []).filter((x) => x instanceof column_1.Column);
        return new JSONVectorAssembler().visitMany(vectors);
    }
    visit(column) {
        const { data, name, length } = column;
        const { offset, nullCount, nullBitmap } = data;
        const buffers = Object.assign({}, data.buffers, { [enum_1.VectorType.VALIDITY]: undefined });
        const type = type_1.DataType.isDictionary(column.type) ? column.type.indices : column.type;
        return Object.assign({ 'name': name, 'count': length, 'VALIDITY': nullCount <= 0
                ? Array.from({ length }, () => 1)
                : [...bit_1.iterateBits(nullBitmap, offset, length, null, bit_1.getBit)] }, super.visit(vector_1.Vector.new(data.clone(type, offset, length, 0, buffers))));
    }
    visitNull() { return {}; }
    visitBool({ values, offset, length }) {
        return { 'DATA': [...bit_1.iterateBits(values, offset, length, null, bit_1.getBool)] };
    }
    visitInt(vector) {
        return {
            'DATA': vector.type.bitWidth < 64
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitFloat(vector) {
        return { 'DATA': [...vector.values] };
    }
    visitUtf8(vector) {
        return { 'DATA': [...vector], 'OFFSET': [...vector.valueOffsets] };
    }
    visitBinary(vector) {
        return { 'DATA': [...binaryToString(vector)], OFFSET: [...vector.valueOffsets] };
    }
    visitFixedSizeBinary(vector) {
        return { 'DATA': [...binaryToString(vector)] };
    }
    visitDate(vector) {
        return {
            'DATA': vector.type.unit === enum_2.DateUnit.DAY
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitTimestamp(vector) {
        return { 'DATA': [...bigNumsToStrings(vector.values, 2)] };
    }
    visitTime(vector) {
        return {
            'DATA': vector.type.unit < enum_2.TimeUnit.MICROSECOND
                ? [...vector.values]
                : [...bigNumsToStrings(vector.values, 2)]
        };
    }
    visitDecimal(vector) {
        return { 'DATA': [...bigNumsToStrings(vector.values, 4)] };
    }
    visitList(vector) {
        return {
            'OFFSET': [...vector.valueOffsets],
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitStruct(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitUnion(vector) {
        return {
            'TYPE': [...vector.typeIds],
            'OFFSET': vector.type.mode === enum_2.UnionMode.Dense ? [...vector.valueOffsets] : undefined,
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitInterval(vector) {
        return { 'DATA': [...vector.values] };
    }
    visitFixedSizeList(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
    visitMap(vector) {
        return {
            'children': vector.type.children.map((f, i) => this.visit(new column_1.Column(f, [vector.getChildAt(i)])))
        };
    }
}
exports.JSONVectorAssembler = JSONVectorAssembler;
/** @ignore */
function* binaryToString(vector) {
    for (const octets of vector) {
        yield octets.reduce((str, byte) => {
            return `${str}${('0' + (byte & 0xFF).toString(16)).slice(-2)}`;
        }, '').toUpperCase();
    }
}
/** @ignore */
function* bigNumsToStrings(values, stride) {
    for (let i = -1, n = values.length / stride; ++i < n;) {
        yield bignumToString(values.subarray((i + 0) * stride, (i + 1) * stride));
    }
}
/** @ignore */
function bignumToString({ buffer, byteOffset, length }) {
    let digits = '', i = -1;
    let r = new Uint32Array(2);
    let a = new Uint16Array(buffer, byteOffset, length * 2);
    let b = new Uint32Array((a = new Uint16Array(a).reverse()).buffer);
    let n = a.length - 1;
    do {
        for (r[0] = a[i = 0]; i < n;) {
            a[i++] = r[1] = r[0] / 10;
            r[0] = ((r[0] - r[1] * 10) << 16) + a[i];
        }
        a[i] = r[1] = r[0] / 10;
        r[0] = r[0] - r[1] * 10;
        digits = `${r[0]}${digits}`;
    } while (b[0] || b[1] || b[2] || b[3]);
    return digits ? digits : `0`;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpc2l0b3IvanNvbnZlY3RvcmFzc2VtYmxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsNkRBQTZEO0FBQzdELCtEQUErRDtBQUMvRCx3REFBd0Q7QUFDeEQsNkRBQTZEO0FBQzdELG9EQUFvRDtBQUNwRCw2REFBNkQ7QUFDN0QsNkRBQTZEO0FBQzdELEVBQUU7QUFDRiwrQ0FBK0M7QUFDL0MsRUFBRTtBQUNGLDZEQUE2RDtBQUM3RCw4REFBOEQ7QUFDOUQseURBQXlEO0FBQ3pELDREQUE0RDtBQUM1RCwwREFBMEQ7QUFDMUQscUJBQXFCOztBQUVyQixzQ0FBbUM7QUFDbkMsc0NBQW1DO0FBQ25DLHdDQUFxQztBQUNyQyxnREFBNkM7QUFFN0Msa0NBQW1EO0FBQ25ELGtDQUF3RDtBQUN4RCxxQ0FBMkQ7QUFDM0Qsa0NBSWlCO0FBMkJqQixNQUFhLG1CQUFvQixTQUFRLGlCQUFPO0lBRTVDLGtCQUFrQjtJQUNYLE1BQU0sQ0FBQyxRQUFRLENBQWlDLEdBQUcsSUFBaUI7UUFFdkUsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLE9BQU8sQ0FBQyxFQUFTLEVBQUUsQ0FBTTtZQUMxRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQUUsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQzthQUFFO1lBQ3ZELElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSx5QkFBVyxDQUFDLEVBQUU7Z0JBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQUU7WUFDdkQsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDaEMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLGVBQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFD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LEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMxQixDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzVDO1FBQ0QsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN4QixNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUM7S0FDL0IsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7SUFFdkMsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0FBQ2pDLENBQUMiLCJmaWxlIjoidmlzaXRvci9qc29udmVjdG9yYXNzZW1ibGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IENvbHVtbiB9IGZyb20gJy4uL2NvbHVtbic7XG5pbXBvcnQgeyBWZWN0b3IgfSBmcm9tICcuLi92ZWN0b3InO1xuaW1wb3J0IHsgVmlzaXRvciB9IGZyb20gJy4uL3Zpc2l0b3InO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2ggfSBmcm9tICcuLi9yZWNvcmRiYXRjaCc7XG5pbXBvcnQgeyBWZWN0b3IgYXMgVlR5cGUgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFZlY3RvclR5cGUgYXMgQnVmZmVyVHlwZSB9IGZyb20gJy4uL2VudW0nO1xuaW1wb3J0IHsgVW5pb25Nb2RlLCBEYXRlVW5pdCwgVGltZVVuaXQgfSBmcm9tICcuLi9lbnVtJztcbmltcG9ydCB7IGl0ZXJhdGVCaXRzLCBnZXRCaXQsIGdldEJvb2wgfSBmcm9tICcuLi91dGlsL2JpdCc7XG5pbXBvcnQge1xuICAgIERhdGFUeXBlLFxuICAgIEZsb2F0LCBJbnQsIERhdGVfLCBJbnRlcnZhbCwgVGltZSwgVGltZXN0YW1wLCBVbmlvbixcbiAgICBCb29sLCBOdWxsLCBVdGY4LCBCaW5hcnksIERlY2ltYWwsIEZpeGVkU2l6ZUJpbmFyeSwgTGlzdCwgRml4ZWRTaXplTGlzdCwgTWFwXywgU3RydWN0LFxufSBmcm9tICcuLi90eXBlJztcblxuZXhwb3J0IGludGVyZmFjZSBKU09OVmVjdG9yQXNzZW1ibGVyIGV4dGVuZHMgVmlzaXRvciB7XG5cbiAgICB2aXNpdCAgICAgPFQgZXh0ZW5kcyBDb2x1bW4+ICAobm9kZTogVCAgKTogb2JqZWN0O1xuICAgIHZpc2l0TWFueSA8VCBleHRlbmRzIENvbHVtbj4gIChjb2xzOiBUW10pOiBvYmplY3RbXTtcbiAgICBnZXRWaXNpdEZuPFQgZXh0ZW5kcyBEYXRhVHlwZT4obm9kZTogQ29sdW1uPFQ+KTogKGNvbHVtbjogQ29sdW1uPFQ+KSA9PiB7IG5hbWU6IHN0cmluZywgY291bnQ6IG51bWJlciwgVkFMSURJVFk6ICgwIHwgMSlbXSwgREFUQT86IGFueVtdLCBPRkZTRVQ/OiBudW1iZXJbXSwgVFlQRT86IG51bWJlcltdLCBjaGlsZHJlbj86IGFueVtdIH07XG5cbiAgICB2aXNpdE51bGwgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgTnVsbD4gICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgfTtcbiAgICB2aXNpdEJvb2wgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgQm9vbD4gICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogYm9vbGVhbltdIH07XG4gICAgdmlzaXRJbnQgICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIEludD4gICAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IChudW1iZXIgfCBzdHJpbmcpW10gIH07XG4gICAgdmlzaXRGbG9hdCAgICAgICAgICAgICAgICA8VCBleHRlbmRzIEZsb2F0PiAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IG51bWJlcltdICB9O1xuICAgIHZpc2l0VXRmOCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBVdGY4PiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBzdHJpbmdbXSwgT0ZGU0VUOiBudW1iZXJbXSB9O1xuICAgIHZpc2l0QmluYXJ5ICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBCaW5hcnk+ICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBzdHJpbmdbXSwgT0ZGU0VUOiBudW1iZXJbXSB9O1xuICAgIHZpc2l0Rml4ZWRTaXplQmluYXJ5ICAgICAgPFQgZXh0ZW5kcyBGaXhlZFNpemVCaW5hcnk+ICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBzdHJpbmdbXSAgfTtcbiAgICB2aXNpdERhdGUgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgRGF0ZV8+ICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogbnVtYmVyW10gIH07XG4gICAgdmlzaXRUaW1lc3RhbXAgICAgICAgICAgICA8VCBleHRlbmRzIFRpbWVzdGFtcD4gICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IHN0cmluZ1tdICB9O1xuICAgIHZpc2l0VGltZSAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBUaW1lPiAgICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBEQVRBOiBudW1iZXJbXSAgfTtcbiAgICB2aXNpdERlY2ltYWwgICAgICAgICAgICAgIDxUIGV4dGVuZHMgRGVjaW1hbD4gICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgREFUQTogc3RyaW5nW10gIH07XG4gICAgdmlzaXRMaXN0ICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIExpc3Q+ICAgICAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IGNoaWxkcmVuOiBhbnlbXSwgT0ZGU0VUOiBudW1iZXJbXSB9O1xuICAgIHZpc2l0U3RydWN0ICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyBTdHJ1Y3Q+ICAgICAgICAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBjaGlsZHJlbjogYW55W10gfTtcbiAgICB2aXNpdFVuaW9uICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgVW5pb24+ICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgY2hpbGRyZW46IGFueVtdLCBUWVBFOiBudW1iZXJbXSwgIH07XG4gICAgdmlzaXRJbnRlcnZhbCAgICAgICAgICAgICA8VCBleHRlbmRzIEludGVydmFsPiAgICAgICAgKHZlY3RvcjogVlR5cGU8VD4pOiB7IERBVEE6IG51bWJlcltdICB9O1xuICAgIHZpc2l0Rml4ZWRTaXplTGlzdCAgICAgICAgPFQgZXh0ZW5kcyBGaXhlZFNpemVMaXN0PiAgICh2ZWN0b3I6IFZUeXBlPFQ+KTogeyBjaGlsZHJlbjogYW55W10gfTtcbiAgICB2aXNpdE1hcCAgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgTWFwXz4gICAgICAgICAgICAodmVjdG9yOiBWVHlwZTxUPik6IHsgY2hpbGRyZW46IGFueVtdIH07XG59XG5cbmV4cG9ydCBjbGFzcyBKU09OVmVjdG9yQXNzZW1ibGVyIGV4dGVuZHMgVmlzaXRvciB7XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGFzc2VtYmxlPFQgZXh0ZW5kcyBDb2x1bW4gfCBSZWNvcmRCYXRjaD4oLi4uYXJnczogKFQgfCBUW10pW10pIHtcblxuICAgICAgICBjb25zdCB2ZWN0b3JzID0gYXJncy5yZWR1Y2UoZnVuY3Rpb24gZmxhdHRlbih4czogYW55W10sIHg6IGFueSk6IGFueVtdIHtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHgpKSB7IHJldHVybiB4LnJlZHVjZShmbGF0dGVuLCB4cyk7IH1cbiAgICAgICAgICAgIGlmICghKHggaW5zdGFuY2VvZiBSZWNvcmRCYXRjaCkpIHsgcmV0dXJuIFsuLi54cywgeF07IH1cbiAgICAgICAgICAgIHJldHVybiB4cy5jb25jYXQoeC5zY2hlbWEuZmllbGRzLm1hcChcbiAgICAgICAgICAgICAgICAoZiwgaSkgPT4gbmV3IENvbHVtbihmLCBbeC5nZXRDaGlsZEF0KGkpIV0pKSk7XG4gICAgICAgIH0sIFtdKS5maWx0ZXIoKHg6IGFueSk6IHggaXMgQ29sdW1uID0+IHggaW5zdGFuY2VvZiBDb2x1bW4pO1xuXG4gICAgICAgIHJldHVybiBuZXcgSlNPTlZlY3RvckFzc2VtYmxlcigpLnZpc2l0TWFueSh2ZWN0b3JzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdmlzaXQ8VCBleHRlbmRzIENvbHVtbj4oY29sdW1uOiBUKSB7XG4gICAgICAgIGNvbnN0IHsgZGF0YSwgbmFtZSwgbGVuZ3RoIH0gPSBjb2x1bW47XG4gICAgICAgIGNvbnN0IHsgb2Zmc2V0LCBudWxsQ291bnQsIG51bGxCaXRtYXAgfSA9IGRhdGE7XG4gICAgICAgIGNvbnN0IGJ1ZmZlcnMgPSB7IC4uLmRhdGEuYnVmZmVycywgW0J1ZmZlclR5cGUuVkFMSURJVFldOiB1bmRlZmluZWQgfTtcbiAgICAgICAgY29uc3QgdHlwZSA9IERhdGFUeXBlLmlzRGljdGlvbmFyeShjb2x1bW4udHlwZSkgPyBjb2x1bW4udHlwZS5pbmRpY2VzIDogY29sdW1uLnR5cGU7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnbmFtZSc6IG5hbWUsXG4gICAgICAgICAgICAnY291bnQnOiBsZW5ndGgsXG4gICAgICAgICAgICAnVkFMSURJVFknOiBudWxsQ291bnQgPD0gMFxuICAgICAgICAgICAgICAgID8gQXJyYXkuZnJvbSh7IGxlbmd0aCB9LCAoKSA9PiAxKVxuICAgICAgICAgICAgICAgIDogWy4uLml0ZXJhdGVCaXRzKG51bGxCaXRtYXAsIG9mZnNldCwgbGVuZ3RoLCBudWxsLCBnZXRCaXQpXSxcbiAgICAgICAgICAgIC4uLnN1cGVyLnZpc2l0KFZlY3Rvci5uZXcoZGF0YS5jbG9uZSh0eXBlLCBvZmZzZXQsIGxlbmd0aCwgMCwgYnVmZmVycykpKVxuICAgICAgICB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXROdWxsKCkgeyByZXR1cm4ge307IH1cbiAgICBwdWJsaWMgdmlzaXRCb29sPFQgZXh0ZW5kcyBCb29sPih7IHZhbHVlcywgb2Zmc2V0LCBsZW5ndGggfTogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uaXRlcmF0ZUJpdHModmFsdWVzLCBvZmZzZXQsIGxlbmd0aCwgbnVsbCwgZ2V0Qm9vbCldIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdEludDxUIGV4dGVuZHMgSW50Pih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnREFUQSc6IHZlY3Rvci50eXBlLmJpdFdpZHRoIDwgNjRcbiAgICAgICAgICAgICAgICA/IFsuLi52ZWN0b3IudmFsdWVzXVxuICAgICAgICAgICAgICAgIDogWy4uLmJpZ051bXNUb1N0cmluZ3ModmVjdG9yLnZhbHVlcyBhcyAoSW50MzJBcnJheSB8IFVpbnQzMkFycmF5KSwgMildXG4gICAgICAgIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdEZsb2F0PFQgZXh0ZW5kcyBGbG9hdD4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4geyAnREFUQSc6IFsuLi52ZWN0b3IudmFsdWVzXSB9O1xuICAgIH1cbiAgICBwdWJsaWMgdmlzaXRVdGY4PFQgZXh0ZW5kcyBVdGY4Pih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7ICdEQVRBJzogWy4uLnZlY3Rvcl0sICdPRkZTRVQnOiBbLi4udmVjdG9yLnZhbHVlT2Zmc2V0c10gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0QmluYXJ5PFQgZXh0ZW5kcyBCaW5hcnk+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uYmluYXJ5VG9TdHJpbmcodmVjdG9yKV0sIE9GRlNFVDogWy4uLnZlY3Rvci52YWx1ZU9mZnNldHNdIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdEZpeGVkU2l6ZUJpbmFyeTxUIGV4dGVuZHMgRml4ZWRTaXplQmluYXJ5Pih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7ICdEQVRBJzogWy4uLmJpbmFyeVRvU3RyaW5nKHZlY3RvcildIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdERhdGU8VCBleHRlbmRzIERhdGVfPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnREFUQSc6IHZlY3Rvci50eXBlLnVuaXQgPT09IERhdGVVbml0LkRBWVxuICAgICAgICAgICAgICAgID8gWy4uLnZlY3Rvci52YWx1ZXNdXG4gICAgICAgICAgICAgICAgOiBbLi4uYmlnTnVtc1RvU3RyaW5ncyh2ZWN0b3IudmFsdWVzLCAyKV1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0VGltZXN0YW1wPFQgZXh0ZW5kcyBUaW1lc3RhbXA+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uYmlnTnVtc1RvU3RyaW5ncyh2ZWN0b3IudmFsdWVzLCAyKV0gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0VGltZTxUIGV4dGVuZHMgVGltZT4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ0RBVEEnOiB2ZWN0b3IudHlwZS51bml0IDwgVGltZVVuaXQuTUlDUk9TRUNPTkRcbiAgICAgICAgICAgICAgICA/IFsuLi52ZWN0b3IudmFsdWVzXVxuICAgICAgICAgICAgICAgIDogWy4uLmJpZ051bXNUb1N0cmluZ3ModmVjdG9yLnZhbHVlcywgMildXG4gICAgICAgIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdERlY2ltYWw8VCBleHRlbmRzIERlY2ltYWw+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHsgJ0RBVEEnOiBbLi4uYmlnTnVtc1RvU3RyaW5ncyh2ZWN0b3IudmFsdWVzLCA0KV0gfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0TGlzdDxUIGV4dGVuZHMgTGlzdD4odmVjdG9yOiBWVHlwZTxUPikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ09GRlNFVCc6IFsuLi52ZWN0b3IudmFsdWVPZmZzZXRzXSxcbiAgICAgICAgICAgICdjaGlsZHJlbic6IHZlY3Rvci50eXBlLmNoaWxkcmVuLm1hcCgoZiwgaSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0U3RydWN0PFQgZXh0ZW5kcyBTdHJ1Y3Q+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdjaGlsZHJlbic6IHZlY3Rvci50eXBlLmNoaWxkcmVuLm1hcCgoZiwgaSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0VW5pb248VCBleHRlbmRzIFVuaW9uPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnVFlQRSc6IFsuLi52ZWN0b3IudHlwZUlkc10sXG4gICAgICAgICAgICAnT0ZGU0VUJzogdmVjdG9yLnR5cGUubW9kZSA9PT0gVW5pb25Nb2RlLkRlbnNlID8gWy4uLnZlY3Rvci52YWx1ZU9mZnNldHNdIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgJ2NoaWxkcmVuJzogdmVjdG9yLnR5cGUuY2hpbGRyZW4ubWFwKChmLCBpKSA9PiB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0SW50ZXJ2YWw8VCBleHRlbmRzIEludGVydmFsPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7ICdEQVRBJzogWy4uLnZlY3Rvci52YWx1ZXNdIH07XG4gICAgfVxuICAgIHB1YmxpYyB2aXNpdEZpeGVkU2l6ZUxpc3Q8VCBleHRlbmRzIEZpeGVkU2l6ZUxpc3Q+KHZlY3RvcjogVlR5cGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdjaGlsZHJlbic6IHZlY3Rvci50eXBlLmNoaWxkcmVuLm1hcCgoZiwgaSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0KG5ldyBDb2x1bW4oZiwgW3ZlY3Rvci5nZXRDaGlsZEF0KGkpIV0pKSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIHZpc2l0TWFwPFQgZXh0ZW5kcyBNYXBfPih2ZWN0b3I6IFZUeXBlPFQ+KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnY2hpbGRyZW4nOiB2ZWN0b3IudHlwZS5jaGlsZHJlbi5tYXAoKGYsIGkpID0+XG4gICAgICAgICAgICAgICAgdGhpcy52aXNpdChuZXcgQ29sdW1uKGYsIFt2ZWN0b3IuZ2V0Q2hpbGRBdChpKSFdKSkpXG4gICAgICAgIH07XG4gICAgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24qIGJpbmFyeVRvU3RyaW5nKHZlY3RvcjogVmVjdG9yPEJpbmFyeT4gfCBWZWN0b3I8Rml4ZWRTaXplQmluYXJ5Pikge1xuICAgIGZvciAoY29uc3Qgb2N0ZXRzIG9mIHZlY3RvciBhcyBJdGVyYWJsZTxVaW50OEFycmF5Pikge1xuICAgICAgICB5aWVsZCBvY3RldHMucmVkdWNlKChzdHIsIGJ5dGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBgJHtzdHJ9JHsoJzAnICsgKGJ5dGUgJiAweEZGKS50b1N0cmluZygxNikpLnNsaWNlKC0yKX1gO1xuICAgICAgICB9LCAnJykudG9VcHBlckNhc2UoKTtcbiAgICB9XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiogYmlnTnVtc1RvU3RyaW5ncyh2YWx1ZXM6IFVpbnQzMkFycmF5IHwgSW50MzJBcnJheSwgc3RyaWRlOiBudW1iZXIpIHtcbiAgICBmb3IgKGxldCBpID0gLTEsIG4gPSB2YWx1ZXMubGVuZ3RoIC8gc3RyaWRlOyArK2kgPCBuOykge1xuICAgICAgICB5aWVsZCBiaWdudW1Ub1N0cmluZyh2YWx1ZXMuc3ViYXJyYXkoKGkgKyAwKSAqIHN0cmlkZSwgKGkgKyAxKSAqIHN0cmlkZSkpO1xuICAgIH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uIGJpZ251bVRvU3RyaW5nKHsgYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGggfTogVWludDMyQXJyYXkgfCBJbnQzMkFycmF5KSB7XG5cbiAgICBsZXQgZGlnaXRzID0gJycsIGkgPSAtMTtcbiAgICBsZXQgciA9IG5ldyBVaW50MzJBcnJheSgyKTtcbiAgICBsZXQgYSA9IG5ldyBVaW50MTZBcnJheShidWZmZXIsIGJ5dGVPZmZzZXQsIGxlbmd0aCAqIDIpO1xuICAgIGxldCBiID0gbmV3IFVpbnQzMkFycmF5KChhID0gbmV3IFVpbnQxNkFycmF5KGEpLnJldmVyc2UoKSkuYnVmZmVyKTtcbiAgICBsZXQgbiA9IGEubGVuZ3RoIC0gMTtcblxuICAgIGRvIHtcbiAgICAgICAgZm9yIChyWzBdID0gYVtpID0gMF07IGkgPCBuOykge1xuICAgICAgICAgICAgYVtpKytdID0gclsxXSA9IHJbMF0gLyAxMDtcbiAgICAgICAgICAgIHJbMF0gPSAoKHJbMF0gLSByWzFdICogMTApIDw8IDE2KSArIGFbaV07XG4gICAgICAgIH1cbiAgICAgICAgYVtpXSA9IHJbMV0gPSByWzBdIC8gMTA7XG4gICAgICAgIHJbMF0gPSByWzBdIC0gclsxXSAqIDEwO1xuICAgICAgICBkaWdpdHMgPSBgJHtyWzBdfSR7ZGlnaXRzfWA7XG4gICAgfSB3aGlsZSAoYlswXSB8fCBiWzFdIHx8IGJbMl0gfHwgYlszXSk7XG5cbiAgICByZXR1cm4gZGlnaXRzID8gZGlnaXRzIDogYDBgO1xufVxuIl19
