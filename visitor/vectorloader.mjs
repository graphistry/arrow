// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import { TextEncoder } from 'text-encoding-utf-8';
import { Data } from '../data';
import { Field } from '../schema';
import { DataType } from '../type';
import { Visitor } from '../visitor';
import { packBools } from '../util/bit';
import { Int64, Int128 } from '../util/int';
import { UnionMode, DateUnit } from '../enum';
import { toArrayBufferView } from '../util/buffer';
const utf8Encoder = new TextEncoder('utf-8');
export class VectorLoader extends Visitor {
    constructor(bytes, nodes, buffers) {
        super();
        this.nodesIndex = -1;
        this.buffersIndex = -1;
        this.bytes = bytes;
        this.nodes = nodes;
        this.buffers = buffers;
    }
    visitMany(nodes) {
        return nodes.map((node) => this.visit(node instanceof Field ? node.type : node));
    }
    visitNull(type, { length, nullCount } = this.nextFieldNode()) { return Data.Null(type, 0, length, nullCount, this.readNullBitmap(type, nullCount)); }
    visitBool(type, { length, nullCount } = this.nextFieldNode()) { return Data.Bool(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitInt(type, { length, nullCount } = this.nextFieldNode()) { return Data.Int(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitFloat(type, { length, nullCount } = this.nextFieldNode()) { return Data.Float(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitUtf8(type, { length, nullCount } = this.nextFieldNode()) { return Data.Utf8(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.readData(type)); }
    visitBinary(type, { length, nullCount } = this.nextFieldNode()) { return Data.Binary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.readData(type)); }
    visitFixedSizeBinary(type, { length, nullCount } = this.nextFieldNode()) { return Data.FixedSizeBinary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitDate(type, { length, nullCount } = this.nextFieldNode()) { return Data.Date(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitTimestamp(type, { length, nullCount } = this.nextFieldNode()) { return Data.Timestamp(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitTime(type, { length, nullCount } = this.nextFieldNode()) { return Data.Time(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitDecimal(type, { length, nullCount } = this.nextFieldNode()) { return Data.Decimal(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitList(type, { length, nullCount } = this.nextFieldNode()) { return Data.List(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.visitMany(type.children)); }
    visitStruct(type, { length, nullCount } = this.nextFieldNode()) { return Data.Struct(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visitMany(type.children)); }
    visitUnion(type) { return type.mode === UnionMode.Sparse ? this.visitSparseUnion(type) : this.visitDenseUnion(type); }
    visitDenseUnion(type, { length, nullCount } = this.nextFieldNode()) { return Data.Union(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readTypeIds(type), this.readOffsets(type), this.visitMany(type.children)); }
    visitSparseUnion(type, { length, nullCount } = this.nextFieldNode()) { return Data.Union(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readTypeIds(type), this.visitMany(type.children)); }
    visitDictionary(type, { length, nullCount } = this.nextFieldNode()) { return Data.Dictionary(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type.indices)); }
    visitInterval(type, { length, nullCount } = this.nextFieldNode()) { return Data.Interval(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.readData(type)); }
    visitFixedSizeList(type, { length, nullCount } = this.nextFieldNode()) { return Data.FixedSizeList(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visitMany(type.children)); }
    visitMap(type, { length, nullCount } = this.nextFieldNode()) { return Data.Map(type, 0, length, nullCount, this.readNullBitmap(type, nullCount), this.visitMany(type.children)); }
    nextFieldNode() { return this.nodes[++this.nodesIndex]; }
    nextBufferRange() { return this.buffers[++this.buffersIndex]; }
    readNullBitmap(type, nullCount, buffer = this.nextBufferRange()) {
        return nullCount > 0 && this.readData(type, buffer) || new Uint8Array(0);
    }
    readOffsets(type, buffer) { return this.readData(type, buffer); }
    readTypeIds(type, buffer) { return this.readData(type, buffer); }
    readData(_type, { length, offset } = this.nextBufferRange()) {
        return this.bytes.subarray(offset, offset + length);
    }
}
export class JSONVectorLoader extends VectorLoader {
    constructor(sources, nodes, buffers) {
        super(new Uint8Array(0), nodes, buffers);
        this.sources = sources;
    }
    readNullBitmap(_type, nullCount, { offset } = this.nextBufferRange()) {
        return nullCount <= 0 ? new Uint8Array(0) : packBools(this.sources[offset]);
    }
    readOffsets(_type, { offset } = this.nextBufferRange()) {
        return toArrayBufferView(Uint8Array, toArrayBufferView(Int32Array, this.sources[offset]));
    }
    readTypeIds(_type, { offset } = this.nextBufferRange()) {
        return toArrayBufferView(Uint8Array, toArrayBufferView(Int8Array, this.sources[offset]));
    }
    readData(type, { offset } = this.nextBufferRange()) {
        const { sources } = this;
        if (DataType.isTimestamp(type)) {
            return toArrayBufferView(Uint8Array, Int64.convertArray(sources[offset]));
        }
        else if ((DataType.isInt(type) || DataType.isTime(type)) && type.bitWidth === 64) {
            return toArrayBufferView(Uint8Array, Int64.convertArray(sources[offset]));
        }
        else if (DataType.isDate(type) && type.unit === DateUnit.MILLISECOND) {
            return toArrayBufferView(Uint8Array, Int64.convertArray(sources[offset]));
        }
        else if (DataType.isDecimal(type)) {
            return toArrayBufferView(Uint8Array, Int128.convertArray(sources[offset]));
        }
        else if (DataType.isBinary(type) || DataType.isFixedSizeBinary(type)) {
            return binaryDataFromJSON(sources[offset]);
        }
        else if (DataType.isBool(type)) {
            return packBools(sources[offset]);
        }
        else if (DataType.isUtf8(type)) {
            return utf8Encoder.encode(sources[offset].join(''));
        }
        return toArrayBufferView(Uint8Array, toArrayBufferView(type.ArrayType, sources[offset].map((x) => +x)));
    }
}
function binaryDataFromJSON(values) {
    // "DATA": ["49BC7D5B6C47D2","3F5FB6D9322026"]
    // There are definitely more efficient ways to do this... but it gets the
    // job done.
    const joined = values.join('');
    const data = new Uint8Array(joined.length / 2);
    for (let i = 0; i < joined.length; i += 2) {
        data[i >> 1] = parseInt(joined.substr(i, 2), 16);
    }
    return data;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpc2l0b3IvdmVjdG9ybG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDZEQUE2RDtBQUM3RCwrREFBK0Q7QUFDL0Qsd0RBQXdEO0FBQ3hELDZEQUE2RDtBQUM3RCxvREFBb0Q7QUFDcEQsNkRBQTZEO0FBQzdELDZEQUE2RDtBQUM3RCxFQUFFO0FBQ0YsK0NBQStDO0FBQy9DLEVBQUU7QUFDRiw2REFBNkQ7QUFDN0QsOERBQThEO0FBQzlELHlEQUF5RDtBQUN6RCw0REFBNEQ7QUFDNUQsMERBQTBEO0FBQzFELHFCQUFxQjtBQUVyQixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFbEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUUvQixPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDbkMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNyQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR25ELE1BQU0sV0FBVyxHQUFHLElBQUksV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBTzdDLE1BQU0sT0FBTyxZQUFhLFNBQVEsT0FBTztJQU1yQyxZQUFZLEtBQWlCLEVBQUUsS0FBa0IsRUFBRSxPQUF1QjtRQUN0RSxLQUFLLEVBQUUsQ0FBQztRQUpKLGVBQVUsR0FBVyxDQUFDLENBQUMsQ0FBQztRQUV4QixpQkFBWSxHQUFXLENBQUMsQ0FBQyxDQUFDO1FBRzlCLElBQUksQ0FBQyxLQUFLLEdBQUcs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Q0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVHLENBQUM7Q0FDSjtBQUVELFNBQVMsa0JBQWtCLENBQUMsTUFBZ0I7SUFDeEMsOENBQThDO0lBQzlDLHlFQUF5RTtJQUN6RSxZQUFZO0lBQ1osTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMvQixNQUFNLElBQUksR0FBRyxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQy9DLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDdkMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDcEQ7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDIiwiZmlsZSI6InZpc2l0b3IvdmVjdG9ybG9hZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IFRleHRFbmNvZGVyIH0gZnJvbSAndGV4dC1lbmNvZGluZy11dGYtOCc7XG5cbmltcG9ydCB7IERhdGEgfSBmcm9tICcuLi9kYXRhJztcbmltcG9ydCAqIGFzIHR5cGUgZnJvbSAnLi4vdHlwZSc7XG5pbXBvcnQgeyBGaWVsZCB9IGZyb20gJy4uL3NjaGVtYSc7XG5pbXBvcnQgeyBEYXRhVHlwZSB9IGZyb20gJy4uL3R5cGUnO1xuaW1wb3J0IHsgVmlzaXRvciB9IGZyb20gJy4uL3Zpc2l0b3InO1xuaW1wb3J0IHsgcGFja0Jvb2xzIH0gZnJvbSAnLi4vdXRpbC9iaXQnO1xuaW1wb3J0IHsgSW50NjQsIEludDEyOCB9IGZyb20gJy4uL3V0aWwvaW50JztcbmltcG9ydCB7IFVuaW9uTW9kZSwgRGF0ZVVuaXQgfSBmcm9tICcuLi9lbnVtJztcbmltcG9ydCB7IHRvQXJyYXlCdWZmZXJWaWV3IH0gZnJvbSAnLi4vdXRpbC9idWZmZXInO1xuaW1wb3J0IHsgQnVmZmVyUmVnaW9uLCBGaWVsZE5vZGUgfSBmcm9tICcuLi9pcGMvbWV0YWRhdGEvbWVzc2FnZSc7XG5cbmNvbnN0IHV0ZjhFbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCd1dGYtOCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIFZlY3RvckxvYWRlciBleHRlbmRzIFZpc2l0b3Ige1xuICAgIHZpc2l0TWFueSA8VCBleHRlbmRzIERhdGFUeXBlPihub2RlczogKEZpZWxkPFQ+IHwgVClbXSk6IERhdGE8VD5bXTtcbiAgICB2aXNpdCAgICAgPFQgZXh0ZW5kcyBEYXRhVHlwZT4obm9kZTogVCAgICAgICAgICAgICAgICApOiBEYXRhPFQ+O1xufVxuXG5leHBvcnQgY2xhc3MgVmVjdG9yTG9hZGVyIGV4dGVuZHMgVmlzaXRvciB7XG4gICAgcHJpdmF0ZSBieXRlczogVWludDhBcnJheTtcbiAgICBwcml2YXRlIG5vZGVzOiBGaWVsZE5vZGVbXTtcbiAgICBwcml2YXRlIG5vZGVzSW5kZXg6IG51bWJlciA9IC0xO1xuICAgIHByaXZhdGUgYnVmZmVyczogQnVmZmVyUmVnaW9uW107XG4gICAgcHJpdmF0ZSBidWZmZXJzSW5kZXg6IG51bWJlciA9IC0xO1xuICAgIGNvbnN0cnVjdG9yKGJ5dGVzOiBVaW50OEFycmF5LCBub2RlczogRmllbGROb2RlW10sIGJ1ZmZlcnM6IEJ1ZmZlclJlZ2lvbltdKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuYnl0ZXMgPSBieXRlcztcbiAgICAgICAgdGhpcy5ub2RlcyA9IG5vZGVzO1xuICAgICAgICB0aGlzLmJ1ZmZlcnMgPSBidWZmZXJzO1xuICAgIH1cblxuICAgIHB1YmxpYyB2aXNpdE1hbnk8VCBleHRlbmRzIERhdGFUeXBlPihub2RlczogKEZpZWxkPFQ+IHwgVClbXSk6IERhdGE8VD5bXSB7XG4gICAgICAgIHJldHVybiBub2Rlcy5tYXAoKG5vZGUpID0+IHRoaXMudmlzaXQobm9kZSBpbnN0YW5jZW9mIEZpZWxkID8gbm9kZS50eXBlIDogbm9kZSkpO1xuICAgIH1cblxuICAgIHB1YmxpYyB2aXNpdE51bGwgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5OdWxsPiAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICBEYXRhLk51bGwodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0Qm9vbCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkJvb2w+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuQm9vbCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRJbnQgICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIHR5cGUuSW50PiAgICAgICAgICAgICAodHlwZTogVCwgeyBsZW5ndGgsIG51bGxDb3VudCB9ID0gdGhpcy5uZXh0RmllbGROb2RlKCkpIHsgcmV0dXJuICAgICAgICAgICAgIERhdGEuSW50KHR5cGUsIDAsIGxlbmd0aCwgbnVsbENvdW50LCB0aGlzLnJlYWROdWxsQml0bWFwKHR5cGUsIG51bGxDb3VudCksIHRoaXMucmVhZERhdGEodHlwZSkpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgIHB1YmxpYyB2aXNpdEZsb2F0ICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5GbG9hdD4gICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgIERhdGEuRmxvYXQodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0VXRmOCAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLlV0Zjg+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuVXRmOCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWRPZmZzZXRzKHR5cGUpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRCaW5hcnkgICAgICAgICAgICAgICA8VCBleHRlbmRzIHR5cGUuQmluYXJ5PiAgICAgICAgICAodHlwZTogVCwgeyBsZW5ndGgsIG51bGxDb3VudCB9ID0gdGhpcy5uZXh0RmllbGROb2RlKCkpIHsgcmV0dXJuICAgICAgICAgIERhdGEuQmluYXJ5KHR5cGUsIDAsIGxlbmd0aCwgbnVsbENvdW50LCB0aGlzLnJlYWROdWxsQml0bWFwKHR5cGUsIG51bGxDb3VudCksIHRoaXMucmVhZE9mZnNldHModHlwZSksIHRoaXMucmVhZERhdGEodHlwZSkpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgIHB1YmxpYyB2aXNpdEZpeGVkU2l6ZUJpbmFyeSAgICAgIDxUIGV4dGVuZHMgdHlwZS5GaXhlZFNpemVCaW5hcnk+ICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gRGF0YS5GaXhlZFNpemVCaW5hcnkodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0RGF0ZSAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkRhdGVfPiAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgIERhdGEuRGF0ZSh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRUaW1lc3RhbXAgICAgICAgICAgICA8VCBleHRlbmRzIHR5cGUuVGltZXN0YW1wPiAgICAgICAodHlwZTogVCwgeyBsZW5ndGgsIG51bGxDb3VudCB9ID0gdGhpcy5uZXh0RmllbGROb2RlKCkpIHsgcmV0dXJuICAgICAgIERhdGEuVGltZXN0YW1wKHR5cGUsIDAsIGxlbmd0aCwgbnVsbENvdW50LCB0aGlzLnJlYWROdWxsQml0bWFwKHR5cGUsIG51bGxDb3VudCksIHRoaXMucmVhZERhdGEodHlwZSkpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgIHB1YmxpYyB2aXNpdFRpbWUgICAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5UaW1lPiAgICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgICBEYXRhLlRpbWUodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkRGF0YSh0eXBlKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0RGVjaW1hbCAgICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkRlY2ltYWw+ICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgIERhdGEuRGVjaW1hbCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRMaXN0ICAgICAgICAgICAgICAgICA8VCBleHRlbmRzIHR5cGUuTGlzdD4gICAgICAgICAgICAodHlwZTogVCwgeyBsZW5ndGgsIG51bGxDb3VudCB9ID0gdGhpcy5uZXh0RmllbGROb2RlKCkpIHsgcmV0dXJuICAgICAgICAgICAgRGF0YS5MaXN0KHR5cGUsIDAsIGxlbmd0aCwgbnVsbENvdW50LCB0aGlzLnJlYWROdWxsQml0bWFwKHR5cGUsIG51bGxDb3VudCksIHRoaXMucmVhZE9mZnNldHModHlwZSksIHRoaXMudmlzaXRNYW55KHR5cGUuY2hpbGRyZW4pKTsgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgIHB1YmxpYyB2aXNpdFN0cnVjdCAgICAgICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5TdHJ1Y3Q+ICAgICAgICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgRGF0YS5TdHJ1Y3QodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy52aXNpdE1hbnkodHlwZS5jaGlsZHJlbikpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0VW5pb24gICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLlVuaW9uPiAgICAgICAgICAgKHR5cGU6IFQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB7IHJldHVybiB0eXBlLm1vZGUgPT09IFVuaW9uTW9kZS5TcGFyc2UgPyB0aGlzLnZpc2l0U3BhcnNlVW5pb24odHlwZSBhcyB0eXBlLlNwYXJzZVVuaW9uKSA6IHRoaXMudmlzaXREZW5zZVVuaW9uKHR5cGUgYXMgdHlwZS5EZW5zZVVuaW9uKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXREZW5zZVVuaW9uICAgICAgICAgICA8VCBleHRlbmRzIHR5cGUuRGVuc2VVbmlvbj4gICAgICAodHlwZTogVCwgeyBsZW5ndGgsIG51bGxDb3VudCB9ID0gdGhpcy5uZXh0RmllbGROb2RlKCkpIHsgcmV0dXJuICAgICAgICAgICBEYXRhLlVuaW9uKHR5cGUsIDAsIGxlbmd0aCwgbnVsbENvdW50LCB0aGlzLnJlYWROdWxsQml0bWFwKHR5cGUsIG51bGxDb3VudCksIHRoaXMucmVhZFR5cGVJZHModHlwZSksIHRoaXMucmVhZE9mZnNldHModHlwZSksIHRoaXMudmlzaXRNYW55KHR5cGUuY2hpbGRyZW4pKTsgfVxuICAgIHB1YmxpYyB2aXNpdFNwYXJzZVVuaW9uICAgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5TcGFyc2VVbmlvbj4gICAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICAgICAgICAgIERhdGEuVW5pb24odHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkVHlwZUlkcyh0eXBlKSwgdGhpcy52aXNpdE1hbnkodHlwZS5jaGlsZHJlbikpOyAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0RGljdGlvbmFyeSAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLkRpY3Rpb25hcnk+ICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgIERhdGEuRGljdGlvbmFyeSh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUuaW5kaWNlcykpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBwdWJsaWMgdmlzaXRJbnRlcnZhbCAgICAgICAgICAgICA8VCBleHRlbmRzIHR5cGUuSW50ZXJ2YWw+ICAgICAgICAodHlwZTogVCwgeyBsZW5ndGgsIG51bGxDb3VudCB9ID0gdGhpcy5uZXh0RmllbGROb2RlKCkpIHsgcmV0dXJuICAgICAgICBEYXRhLkludGVydmFsKHR5cGUsIDAsIGxlbmd0aCwgbnVsbENvdW50LCB0aGlzLnJlYWROdWxsQml0bWFwKHR5cGUsIG51bGxDb3VudCksIHRoaXMucmVhZERhdGEodHlwZSkpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgIHB1YmxpYyB2aXNpdEZpeGVkU2l6ZUxpc3QgICAgICAgIDxUIGV4dGVuZHMgdHlwZS5GaXhlZFNpemVMaXN0PiAgICh0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH0gPSB0aGlzLm5leHRGaWVsZE5vZGUoKSkgeyByZXR1cm4gICBEYXRhLkZpeGVkU2l6ZUxpc3QodHlwZSwgMCwgbGVuZ3RoLCBudWxsQ291bnQsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy52aXNpdE1hbnkodHlwZS5jaGlsZHJlbikpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgcHVibGljIHZpc2l0TWFwICAgICAgICAgICAgICAgICAgPFQgZXh0ZW5kcyB0eXBlLk1hcF8+ICAgICAgICAgICAgKHR5cGU6IFQsIHsgbGVuZ3RoLCBudWxsQ291bnQgfSA9IHRoaXMubmV4dEZpZWxkTm9kZSgpKSB7IHJldHVybiAgICAgICAgICAgICBEYXRhLk1hcCh0eXBlLCAwLCBsZW5ndGgsIG51bGxDb3VudCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnZpc2l0TWFueSh0eXBlLmNoaWxkcmVuKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgIHByb3RlY3RlZCBuZXh0RmllbGROb2RlKCkgeyByZXR1cm4gdGhpcy5ub2Rlc1srK3RoaXMubm9kZXNJbmRleF07IH1cbiAgICBwcm90ZWN0ZWQgbmV4dEJ1ZmZlclJhbmdlKCkgeyByZXR1cm4gdGhpcy5idWZmZXJzWysrdGhpcy5idWZmZXJzSW5kZXhdOyB9XG4gICAgcHJvdGVjdGVkIHJlYWROdWxsQml0bWFwPFQgZXh0ZW5kcyBEYXRhVHlwZT4odHlwZTogVCwgbnVsbENvdW50OiBudW1iZXIsIGJ1ZmZlciA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgcmV0dXJuIG51bGxDb3VudCA+IDAgJiYgdGhpcy5yZWFkRGF0YSh0eXBlLCBidWZmZXIpIHx8IG5ldyBVaW50OEFycmF5KDApO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZE9mZnNldHM8VCBleHRlbmRzIERhdGFUeXBlPih0eXBlOiBULCBidWZmZXI/OiBCdWZmZXJSZWdpb24pIHsgcmV0dXJuIHRoaXMucmVhZERhdGEodHlwZSwgYnVmZmVyKTsgfVxuICAgIHByb3RlY3RlZCByZWFkVHlwZUlkczxUIGV4dGVuZHMgRGF0YVR5cGU+KHR5cGU6IFQsIGJ1ZmZlcj86IEJ1ZmZlclJlZ2lvbikgeyByZXR1cm4gdGhpcy5yZWFkRGF0YSh0eXBlLCBidWZmZXIpOyB9XG4gICAgcHJvdGVjdGVkIHJlYWREYXRhPFQgZXh0ZW5kcyBEYXRhVHlwZT4oX3R5cGU6IFQsIHsgbGVuZ3RoLCBvZmZzZXQgfSA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnl0ZXMuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyBsZW5ndGgpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIEpTT05WZWN0b3JMb2FkZXIgZXh0ZW5kcyBWZWN0b3JMb2FkZXIge1xuICAgIHByaXZhdGUgc291cmNlczogYW55W11bXTtcbiAgICBjb25zdHJ1Y3Rvcihzb3VyY2VzOiBhbnlbXVtdLCBub2RlczogRmllbGROb2RlW10sIGJ1ZmZlcnM6IEJ1ZmZlclJlZ2lvbltdKSB7XG4gICAgICAgIHN1cGVyKG5ldyBVaW50OEFycmF5KDApLCBub2RlcywgYnVmZmVycyk7XG4gICAgICAgIHRoaXMuc291cmNlcyA9IHNvdXJjZXM7XG4gICAgfVxuICAgIHByb3RlY3RlZCByZWFkTnVsbEJpdG1hcDxUIGV4dGVuZHMgRGF0YVR5cGU+KF90eXBlOiBULCBudWxsQ291bnQ6IG51bWJlciwgeyBvZmZzZXQgfSA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgcmV0dXJuIG51bGxDb3VudCA8PSAwID8gbmV3IFVpbnQ4QXJyYXkoMCkgOiBwYWNrQm9vbHModGhpcy5zb3VyY2VzW29mZnNldF0pO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZE9mZnNldHM8VCBleHRlbmRzIERhdGFUeXBlPihfdHlwZTogVCwgeyBvZmZzZXQgfSA9IHRoaXMubmV4dEJ1ZmZlclJhbmdlKCkpIHtcbiAgICAgICAgcmV0dXJuIHRvQXJyYXlCdWZmZXJWaWV3KFVpbnQ4QXJyYXksIHRvQXJyYXlCdWZmZXJWaWV3KEludDMyQXJyYXksIHRoaXMuc291cmNlc1tvZmZzZXRdKSk7XG4gICAgfVxuICAgIHByb3RlY3RlZCByZWFkVHlwZUlkczxUIGV4dGVuZHMgRGF0YVR5cGU+KF90eXBlOiBULCB7IG9mZnNldCB9ID0gdGhpcy5uZXh0QnVmZmVyUmFuZ2UoKSkge1xuICAgICAgICByZXR1cm4gdG9BcnJheUJ1ZmZlclZpZXcoVWludDhBcnJheSwgdG9BcnJheUJ1ZmZlclZpZXcoSW50OEFycmF5LCB0aGlzLnNvdXJjZXNbb2Zmc2V0XSkpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZERhdGE8VCBleHRlbmRzIERhdGFUeXBlPih0eXBlOiBULCB7IG9mZnNldCB9ID0gdGhpcy5uZXh0QnVmZmVyUmFuZ2UoKSkge1xuICAgICAgICBjb25zdCB7IHNvdXJjZXMgfSA9IHRoaXM7XG4gICAgICAgIGlmIChEYXRhVHlwZS5pc1RpbWVzdGFtcCh0eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRvQXJyYXlCdWZmZXJWaWV3KFVpbnQ4QXJyYXksIEludDY0LmNvbnZlcnRBcnJheShzb3VyY2VzW29mZnNldF0gYXMgc3RyaW5nW10pKTtcbiAgICAgICAgfSBlbHNlIGlmICgoRGF0YVR5cGUuaXNJbnQodHlwZSkgfHwgRGF0YVR5cGUuaXNUaW1lKHR5cGUpKSAmJiB0eXBlLmJpdFdpZHRoID09PSA2NCkge1xuICAgICAgICAgICAgcmV0dXJuIHRvQXJyYXlCdWZmZXJWaWV3KFVpbnQ4QXJyYXksIEludDY0LmNvbnZlcnRBcnJheShzb3VyY2VzW29mZnNldF0gYXMgc3RyaW5nW10pKTtcbiAgICAgICAgfSBlbHNlIGlmIChEYXRhVHlwZS5pc0RhdGUodHlwZSkgJiYgdHlwZS51bml0ID09PSBEYXRlVW5pdC5NSUxMSVNFQ09ORCkge1xuICAgICAgICAgICAgcmV0dXJuIHRvQXJyYXlCdWZmZXJWaWV3KFVpbnQ4QXJyYXksIEludDY0LmNvbnZlcnRBcnJheShzb3VyY2VzW29mZnNldF0gYXMgc3RyaW5nW10pKTtcbiAgICAgICAgfSBlbHNlIGlmIChEYXRhVHlwZS5pc0RlY2ltYWwodHlwZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0b0FycmF5QnVmZmVyVmlldyhVaW50OEFycmF5LCBJbnQxMjguY29udmVydEFycmF5KHNvdXJjZXNbb2Zmc2V0XSBhcyBzdHJpbmdbXSkpO1xuICAgICAgICB9IGVsc2UgaWYgKERhdGFUeXBlLmlzQmluYXJ5KHR5cGUpIHx8IERhdGFUeXBlLmlzRml4ZWRTaXplQmluYXJ5KHR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gYmluYXJ5RGF0YUZyb21KU09OKHNvdXJjZXNbb2Zmc2V0XSBhcyBzdHJpbmdbXSk7XG4gICAgICAgIH0gZWxzZSBpZiAoRGF0YVR5cGUuaXNCb29sKHR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gcGFja0Jvb2xzKHNvdXJjZXNbb2Zmc2V0XSBhcyBudW1iZXJbXSk7XG4gICAgICAgIH0gZWxzZSBpZiAoRGF0YVR5cGUuaXNVdGY4KHR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdXRmOEVuY29kZXIuZW5jb2RlKChzb3VyY2VzW29mZnNldF0gYXMgc3RyaW5nW10pLmpvaW4oJycpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdG9BcnJheUJ1ZmZlclZpZXcoVWludDhBcnJheSwgdG9BcnJheUJ1ZmZlclZpZXcodHlwZS5BcnJheVR5cGUsIHNvdXJjZXNbb2Zmc2V0XS5tYXAoKHgpID0+ICt4KSkpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gYmluYXJ5RGF0YUZyb21KU09OKHZhbHVlczogc3RyaW5nW10pIHtcbiAgICAvLyBcIkRBVEFcIjogW1wiNDlCQzdENUI2QzQ3RDJcIixcIjNGNUZCNkQ5MzIyMDI2XCJdXG4gICAgLy8gVGhlcmUgYXJlIGRlZmluaXRlbHkgbW9yZSBlZmZpY2llbnQgd2F5cyB0byBkbyB0aGlzLi4uIGJ1dCBpdCBnZXRzIHRoZVxuICAgIC8vIGpvYiBkb25lLlxuICAgIGNvbnN0IGpvaW5lZCA9IHZhbHVlcy5qb2luKCcnKTtcbiAgICBjb25zdCBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoam9pbmVkLmxlbmd0aCAvIDIpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgam9pbmVkLmxlbmd0aDsgaSArPSAyKSB7XG4gICAgICAgIGRhdGFbaSA+PiAxXSA9IHBhcnNlSW50KGpvaW5lZC5zdWJzdHIoaSwgMiksIDE2KTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG59XG4iXX0=
