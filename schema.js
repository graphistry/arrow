"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const type_1 = require("./type");
const typecomparator_1 = require("./visitor/typecomparator");
class Schema {
    constructor(fields, metadata, dictionaries, dictionaryFields) {
        this._fields = (fields || []);
        this._metadata = metadata || new Map();
        if (!dictionaries || !dictionaryFields) {
            ({ dictionaries, dictionaryFields } = generateDictionaryMap(fields, dictionaries || new Map(), dictionaryFields || new Map()));
        }
        this._dictionaries = dictionaries;
        this._dictionaryFields = dictionaryFields;
    }
    /** @nocollapse */
    static from(chunks, names = []) {
        return new Schema(chunks.map((v, i) => new Field('' + (names[i] || i), v.type)));
    }
    get fields() { return this._fields; }
    get metadata() { return this._metadata; }
    get dictionaries() { return this._dictionaries; }
    get dictionaryFields() { return this._dictionaryFields; }
    get [Symbol.toStringTag]() { return 'Schema'; }
    toString() {
        return `Schema<{ ${this._fields.map((f, i) => `${i}: ${f}`).join(', ')} }>`;
    }
    compareTo(other) {
        return typecomparator_1.instance.compareSchemas(this, other);
    }
    select(...columnNames) {
        const names = columnNames.reduce((xs, x) => (xs[x] = true) && xs, Object.create(null));
        return new Schema(this._fields.filter((f) => names[f.name]), this.metadata);
    }
    selectAt(...columnIndices) {
        return new Schema(columnIndices.map((i) => this._fields[i]), this.metadata);
    }
    assign(...args) {
        const other = args[0] instanceof Schema ? args[0]
            : new Schema(args.reduce(function flatten(xs, x) {
                return Array.isArray(x) ? x.reduce(flatten, xs) : [...xs, x];
            }, []).filter((x) => x instanceof Field));
        const curFields = [...this._fields];
        const curDictionaries = [...this.dictionaries];
        const curDictionaryFields = this.dictionaryFields;
        const metadata = mergeMaps(this.metadata, other.metadata);
        const newFields = other.fields.filter((f2) => {
            const i = curFields.findIndex((f) => f.compareTo(f2));
            return ~i ? (curFields[i] = curFields[i].clone({
                metadata: mergeMaps(curFields[i].metadata, f2.metadata)
            })) && false : true;
        });
        const { dictionaries, dictionaryFields } = generateDictionaryMap(newFields, new Map(), new Map());
        const newDictionaries = [...dictionaries].filter(([y]) => !curDictionaries.every(([x]) => x === y));
        const newDictionaryFields = [...dictionaryFields].map(([id, newDictFields]) => {
            return [id, [...(curDictionaryFields.get(id) || []), ...newDictFields.map((f) => {
                        const i = newFields.findIndex((f2) => f2.compareTo(f));
                        const { dictionary, indices, isOrdered, dictionaryVector } = f.type;
                        const type = new type_1.Dictionary(dictionary, indices, id, isOrdered, dictionaryVector);
                        return newFields[i] = f.clone({ type });
                    })]];
        });
        return new Schema([...curFields, ...newFields], metadata, new Map([...curDictionaries, ...newDictionaries]), new Map([...curDictionaryFields, ...newDictionaryFields]));
    }
}
exports.Schema = Schema;
class Field {
    constructor(name, type, nullable = false, metadata) {
        this._name = name;
        this._type = type;
        this._nullable = nullable;
        this._metadata = metadata || new Map();
    }
    get type() { return this._type; }
    get name() { return this._name; }
    get nullable() { return this._nullable; }
    get metadata() { return this._metadata; }
    get typeId() { return this._type.typeId; }
    get [Symbol.toStringTag]() { return 'Field'; }
    get indices() {
        return type_1.DataType.isDictionary(this._type) ? this._type.indices : this._type;
    }
    toString() { return `${this.name}: ${this.type}`; }
    compareTo(other) {
        return typecomparator_1.instance.compareField(this, other);
    }
    clone(props) {
        props || (props = {});
        return new Field(props.name === undefined ? this.name : props.name, props.type === undefined ? this.type : props.type, props.nullable === undefined ? this.nullable : props.nullable, props.metadata === undefined ? this.metadata : props.metadata);
    }
}
exports.Field = Field;
/** @ignore */
function mergeMaps(m1, m2) {
    return new Map([...(m1 || new Map()), ...(m2 || new Map())]);
}
/** @ignore */
function generateDictionaryMap(fields, dictionaries, dictionaryFields) {
    for (let i = -1, n = fields.length; ++i < n;) {
        const field = fields[i];
        const type = field.type;
        if (type_1.DataType.isDictionary(type)) {
            if (!dictionaryFields.get(type.id)) {
                dictionaryFields.set(type.id, []);
            }
            if (!dictionaries.has(type.id)) {
                dictionaries.set(type.id, type.dictionary);
                dictionaryFields.get(type.id).push(field);
            }
            else if (dictionaries.get(type.id) !== type.dictionary) {
                throw new Error(`Cannot create Schema containing two different dictionaries with the same Id`);
            }
        }
        if (type.children) {
            generateDictionaryMap(type.children, dictionaries, dictionaryFields);
        }
    }
    return { dictionaries, dictionaryFields };
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFJLENBQUMsRUFBRSxDQUFDLEVBQUU7Z0JBQ2hDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2FBQ3JDO1lBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUM1QixZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUMzQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBRSxDQUFDLElBQUksQ0FBQyxLQUFZLENBQUMsQ0FBQzthQUNyRDtpQkFBTSxJQUFJLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQ3RELE1BQU0sSUFBSSxLQUFLLENBQUMsNkVBQTZFLENBQUMsQ0FBQzthQUNsRztTQUNKO1FBQ0QsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2YscUJBQXFCLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztTQUN4RTtLQUNKO0lBRUQsT0FBTyxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxDQUFDO0FBQzlDLENBQUMiLCJmaWxlIjoic2NoZW1hLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IERhdGEgfSBmcm9tICcuL2RhdGEnO1xuaW1wb3J0IHsgVmVjdG9yIH0gZnJvbSAnLi92ZWN0b3InO1xuaW1wb3J0IHsgRGF0YVR5cGUsIERpY3Rpb25hcnkgfSBmcm9tICcuL3R5cGUnO1xuaW1wb3J0IHsgaW5zdGFuY2UgYXMgY29tcGFyZXIgfSBmcm9tICcuL3Zpc2l0b3IvdHlwZWNvbXBhcmF0b3InO1xuXG5leHBvcnQgY2xhc3MgU2NoZW1hPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+IHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihjaHVua3M6IChEYXRhPFRba2V5b2YgVF0+IHwgVmVjdG9yPFRba2V5b2YgVF0+KVtdLCBuYW1lczogKGtleW9mIFQpW10gPSBbXSkge1xuICAgICAgICByZXR1cm4gbmV3IFNjaGVtYTxUPihjaHVua3MubWFwKCh2LCBpKSA9PiBuZXcgRmllbGQoJycgKyAobmFtZXNbaV0gfHwgaSksIHYudHlwZSkpKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX2ZpZWxkczogRmllbGQ8VFtrZXlvZiBUXT5bXTtcbiAgICBwcm90ZWN0ZWQgX21ldGFkYXRhOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xuICAgIHByb3RlY3RlZCBfZGljdGlvbmFyaWVzOiBNYXA8bnVtYmVyLCBEYXRhVHlwZT47XG4gICAgcHJvdGVjdGVkIF9kaWN0aW9uYXJ5RmllbGRzOiBNYXA8bnVtYmVyLCBGaWVsZDxEaWN0aW9uYXJ5PltdPjtcbiAgICBwdWJsaWMgZ2V0IGZpZWxkcygpIHsgcmV0dXJuIHRoaXMuX2ZpZWxkczsgfVxuICAgIHB1YmxpYyBnZXQgbWV0YWRhdGEoKTogTWFwPHN0cmluZywgc3RyaW5nPiB7IHJldHVybiB0aGlzLl9tZXRhZGF0YTsgfVxuICAgIHB1YmxpYyBnZXQgZGljdGlvbmFyaWVzKCk6IE1hcDxudW1iZXIsIERhdGFUeXBlPiB7IHJldHVybiB0aGlzLl9kaWN0aW9uYXJpZXM7IH1cbiAgICBwdWJsaWMgZ2V0IGRpY3Rpb25hcnlGaWVsZHMoKTogTWFwPG51bWJlciwgRmllbGQ8RGljdGlvbmFyeT5bXT4geyByZXR1cm4gdGhpcy5fZGljdGlvbmFyeUZpZWxkczsgfVxuXG4gICAgY29uc3RydWN0b3IoZmllbGRzOiBGaWVsZFtdLFxuICAgICAgICAgICAgICAgIG1ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPixcbiAgICAgICAgICAgICAgICBkaWN0aW9uYXJpZXM/OiBNYXA8bnVtYmVyLCBEYXRhVHlwZT4sXG4gICAgICAgICAgICAgICAgZGljdGlvbmFyeUZpZWxkcz86IE1hcDxudW1iZXIsIEZpZWxkPERpY3Rpb25hcnk+W10+KSB7XG4gICAgICAgIHRoaXMuX2ZpZWxkcyA9IChmaWVsZHMgfHwgW10pIGFzIEZpZWxkPFRba2V5b2YgVF0+W107XG4gICAgICAgIHRoaXMuX21ldGFkYXRhID0gbWV0YWRhdGEgfHwgbmV3IE1hcCgpO1xuICAgICAgICBpZiAoIWRpY3Rpb25hcmllcyB8fCAhZGljdGlvbmFyeUZpZWxkcykge1xuICAgICAgICAgICAgKHsgZGljdGlvbmFyaWVzLCBkaWN0aW9uYXJ5RmllbGRzIH0gPSBnZW5lcmF0ZURpY3Rpb25hcnlNYXAoXG4gICAgICAgICAgICAgICAgZmllbGRzLCBkaWN0aW9uYXJpZXMgfHwgbmV3IE1hcCgpLCBkaWN0aW9uYXJ5RmllbGRzIHx8IG5ldyBNYXAoKVxuICAgICAgICAgICAgKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fZGljdGlvbmFyaWVzID0gZGljdGlvbmFyaWVzO1xuICAgICAgICB0aGlzLl9kaWN0aW9uYXJ5RmllbGRzID0gZGljdGlvbmFyeUZpZWxkcztcbiAgICB9XG4gICAgcHVibGljIGdldCBbU3ltYm9sLnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuICdTY2hlbWEnOyB9XG4gICAgcHVibGljIHRvU3RyaW5nKCkge1xuICAgICAgICByZXR1cm4gYFNjaGVtYTx7ICR7dGhpcy5fZmllbGRzLm1hcCgoZiwgaSkgPT4gYCR7aX06ICR7Zn1gKS5qb2luKCcsICcpfSB9PmA7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBhcmVUbyhvdGhlcj86IFNjaGVtYSB8IG51bGwpOiBvdGhlciBpcyBTY2hlbWE8VD4ge1xuICAgICAgICByZXR1cm4gY29tcGFyZXIuY29tcGFyZVNjaGVtYXModGhpcywgb3RoZXIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZWxlY3Q8SyBleHRlbmRzIGtleW9mIFQgPSBhbnk+KC4uLmNvbHVtbk5hbWVzOiBLW10pIHtcbiAgICAgICAgY29uc3QgbmFtZXMgPSBjb2x1bW5OYW1lcy5yZWR1Y2UoKHhzLCB4KSA9PiAoeHNbeF0gPSB0cnVlKSAmJiB4cywgT2JqZWN0LmNyZWF0ZShudWxsKSk7XG4gICAgICAgIHJldHVybiBuZXcgU2NoZW1hPHsgW1AgaW4gS106IFRbUF0gfT4odGhpcy5fZmllbGRzLmZpbHRlcigoZikgPT4gbmFtZXNbZi5uYW1lXSksIHRoaXMubWV0YWRhdGEpO1xuICAgIH1cbiAgICBwdWJsaWMgc2VsZWN0QXQ8SyBleHRlbmRzIFRba2V5b2YgVF0gPSBhbnk+KC4uLmNvbHVtbkluZGljZXM6IG51bWJlcltdKSB7XG4gICAgICAgIHJldHVybiBuZXcgU2NoZW1hPHsgW2tleTogc3RyaW5nXTogSyB9Pihjb2x1bW5JbmRpY2VzLm1hcCgoaSkgPT4gdGhpcy5fZmllbGRzW2ldKSwgdGhpcy5tZXRhZGF0YSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzc2lnbjxSIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihzY2hlbWE6IFNjaGVtYTxSPik6IFNjaGVtYTxUICYgUj47XG4gICAgcHVibGljIGFzc2lnbjxSIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PiguLi5maWVsZHM6IChGaWVsZDxSW2tleW9mIFJdPiB8IEZpZWxkPFJba2V5b2YgUl0+W10pW10pOiBTY2hlbWE8VCAmIFI+O1xuICAgIHB1YmxpYyBhc3NpZ248UiBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oLi4uYXJnczogKFNjaGVtYTxSPiB8IEZpZWxkPFJba2V5b2YgUl0+IHwgRmllbGQ8UltrZXlvZiBSXT5bXSlbXSkge1xuXG4gICAgICAgIGNvbnN0IG90aGVyID0gYXJnc1swXSBpbnN0YW5jZW9mIFNjaGVtYSA/IGFyZ3NbMF0gYXMgU2NoZW1hPFI+XG4gICAgICAgICAgICA6IG5ldyBTY2hlbWE8Uj4oYXJncy5yZWR1Y2UoZnVuY3Rpb24gZmxhdHRlbih4czogYW55W10sIHg6IGFueSk6IGFueVtdIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh4KSA/IHgucmVkdWNlKGZsYXR0ZW4sIHhzKSA6IFsuLi54cywgeF07XG4gICAgICAgICAgICB9LCBbXSkuZmlsdGVyKCh4OiBhbnkpOiB4IGlzIEZpZWxkPFJba2V5b2YgUl0+ID0+IHggaW5zdGFuY2VvZiBGaWVsZCkpO1xuXG4gICAgICAgIGNvbnN0IGN1ckZpZWxkcyA9IFsuLi50aGlzLl9maWVsZHNdIGFzIEZpZWxkW107XG4gICAgICAgIGNvbnN0IGN1ckRpY3Rpb25hcmllcyA9IFsuLi50aGlzLmRpY3Rpb25hcmllc107XG4gICAgICAgIGNvbnN0IGN1ckRpY3Rpb25hcnlGaWVsZHMgPSB0aGlzLmRpY3Rpb25hcnlGaWVsZHM7XG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gbWVyZ2VNYXBzKHRoaXMubWV0YWRhdGEsIG90aGVyLm1ldGFkYXRhKTtcbiAgICAgICAgY29uc3QgbmV3RmllbGRzID0gb3RoZXIuZmllbGRzLmZpbHRlcigoZjIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGkgPSBjdXJGaWVsZHMuZmluZEluZGV4KChmKSA9PiBmLmNvbXBhcmVUbyhmMikpO1xuICAgICAgICAgICAgcmV0dXJuIH5pID8gKGN1ckZpZWxkc1tpXSA9IGN1ckZpZWxkc1tpXS5jbG9uZSh7XG4gICAgICAgICAgICAgICAgbWV0YWRhdGE6IG1lcmdlTWFwcyhjdXJGaWVsZHNbaV0ubWV0YWRhdGEsIGYyLm1ldGFkYXRhKVxuICAgICAgICAgICAgfSkpICYmIGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgfSkgYXMgRmllbGRbXTtcblxuICAgICAgICBjb25zdCB7IGRpY3Rpb25hcmllcywgZGljdGlvbmFyeUZpZWxkcyB9ID0gZ2VuZXJhdGVEaWN0aW9uYXJ5TWFwKG5ld0ZpZWxkcywgbmV3IE1hcCgpLCBuZXcgTWFwKCkpO1xuICAgICAgICBjb25zdCBuZXdEaWN0aW9uYXJpZXMgPSBbLi4uZGljdGlvbmFyaWVzXS5maWx0ZXIoKFt5XSkgPT4gIWN1ckRpY3Rpb25hcmllcy5ldmVyeSgoW3hdKSA9PiB4ID09PSB5KSk7XG4gICAgICAgIGNvbnN0IG5ld0RpY3Rpb25hcnlGaWVsZHMgPSBbLi4uZGljdGlvbmFyeUZpZWxkc10ubWFwKChbaWQsIG5ld0RpY3RGaWVsZHNdKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gW2lkLCBbLi4uKGN1ckRpY3Rpb25hcnlGaWVsZHMuZ2V0KGlkKSB8fCBbXSksIC4uLm5ld0RpY3RGaWVsZHMubWFwKChmKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaSA9IG5ld0ZpZWxkcy5maW5kSW5kZXgoKGYyKSA9PiBmMi5jb21wYXJlVG8oZikpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgZGljdGlvbmFyeSwgaW5kaWNlcywgaXNPcmRlcmVkLCBkaWN0aW9uYXJ5VmVjdG9yIH0gPSBmLnR5cGU7XG4gICAgICAgICAgICAgICAgY29uc3QgdHlwZSA9IG5ldyBEaWN0aW9uYXJ5KGRpY3Rpb25hcnksIGluZGljZXMsIGlkLCBpc09yZGVyZWQsIGRpY3Rpb25hcnlWZWN0b3IpO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXdGaWVsZHNbaV0gPSBmLmNsb25lKHsgdHlwZSB9KTtcbiAgICAgICAgICAgIH0pXV0gYXMgW251bWJlciwgRmllbGQ8RGljdGlvbmFyeT5bXV07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBuZXcgU2NoZW1hPFQgJiBSPihcbiAgICAgICAgICAgIFsuLi5jdXJGaWVsZHMsIC4uLm5ld0ZpZWxkc10sIG1ldGFkYXRhLFxuICAgICAgICAgICAgbmV3IE1hcChbLi4uY3VyRGljdGlvbmFyaWVzLCAuLi5uZXdEaWN0aW9uYXJpZXNdKSxcbiAgICAgICAgICAgIG5ldyBNYXAoWy4uLmN1ckRpY3Rpb25hcnlGaWVsZHMsIC4uLm5ld0RpY3Rpb25hcnlGaWVsZHNdKVxuICAgICAgICApO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIEZpZWxkPFQgZXh0ZW5kcyBEYXRhVHlwZSA9IERhdGFUeXBlPiB7XG4gICAgcHJvdGVjdGVkIF90eXBlOiBUO1xuICAgIHByb3RlY3RlZCBfbmFtZTogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBfbnVsbGFibGU6IHRydWUgfCBmYWxzZTtcbiAgICBwcm90ZWN0ZWQgX21ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPiB8IG51bGw7XG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCB0eXBlOiBULCBudWxsYWJsZTogdHJ1ZSB8IGZhbHNlID0gZmFsc2UsIG1ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPiB8IG51bGwpIHtcbiAgICAgICAgdGhpcy5fbmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMuX3R5cGUgPSB0eXBlO1xuICAgICAgICB0aGlzLl9udWxsYWJsZSA9IG51bGxhYmxlO1xuICAgICAgICB0aGlzLl9tZXRhZGF0YSA9IG1ldGFkYXRhIHx8IG5ldyBNYXAoKTtcbiAgICB9XG4gICAgcHVibGljIGdldCB0eXBlKCkgeyByZXR1cm4gdGhpcy5fdHlwZTsgfVxuICAgIHB1YmxpYyBnZXQgbmFtZSgpIHsgcmV0dXJuIHRoaXMuX25hbWU7IH1cbiAgICBwdWJsaWMgZ2V0IG51bGxhYmxlKCkgeyByZXR1cm4gdGhpcy5fbnVsbGFibGU7IH1cbiAgICBwdWJsaWMgZ2V0IG1ldGFkYXRhKCkgeyByZXR1cm4gdGhpcy5fbWV0YWRhdGE7IH1cbiAgICBwdWJsaWMgZ2V0IHR5cGVJZCgpIHsgcmV0dXJuIHRoaXMuX3R5cGUudHlwZUlkOyB9XG4gICAgcHVibGljIGdldCBbU3ltYm9sLnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuICdGaWVsZCc7IH1cbiAgICBwdWJsaWMgZ2V0IGluZGljZXMoKSB7XG4gICAgICAgIHJldHVybiBEYXRhVHlwZS5pc0RpY3Rpb25hcnkodGhpcy5fdHlwZSkgPyB0aGlzLl90eXBlLmluZGljZXMgOiB0aGlzLl90eXBlO1xuICAgIH1cbiAgICBwdWJsaWMgdG9TdHJpbmcoKSB7IHJldHVybiBgJHt0aGlzLm5hbWV9OiAke3RoaXMudHlwZX1gOyB9XG4gICAgcHVibGljIGNvbXBhcmVUbyhvdGhlcj86IEZpZWxkIHwgbnVsbCk6IG90aGVyIGlzIEZpZWxkPFQ+IHtcbiAgICAgICAgcmV0dXJuIGNvbXBhcmVyLmNvbXBhcmVGaWVsZCh0aGlzLCBvdGhlcik7XG4gICAgfVxuICAgIHB1YmxpYyBjbG9uZTxSIGV4dGVuZHMgRGF0YVR5cGUgPSBUPihwcm9wcz86IHsgbmFtZT86IHN0cmluZywgdHlwZT86IFIsIG51bGxhYmxlPzogYm9vbGVhbiwgbWV0YWRhdGE/OiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCB9KTogRmllbGQ8Uj4ge1xuICAgICAgICBwcm9wcyB8fCAocHJvcHMgPSB7fSk7XG4gICAgICAgIHJldHVybiBuZXcgRmllbGQ8Uj4oXG4gICAgICAgICAgICBwcm9wcy5uYW1lID09PSB1bmRlZmluZWQgPyB0aGlzLm5hbWUgOiBwcm9wcy5uYW1lLFxuICAgICAgICAgICAgcHJvcHMudHlwZSA9PT0gdW5kZWZpbmVkID8gdGhpcy50eXBlIDogcHJvcHMudHlwZSBhcyBhbnksXG4gICAgICAgICAgICBwcm9wcy5udWxsYWJsZSA9PT0gdW5kZWZpbmVkID8gdGhpcy5udWxsYWJsZSA6IHByb3BzLm51bGxhYmxlLFxuICAgICAgICAgICAgcHJvcHMubWV0YWRhdGEgPT09IHVuZGVmaW5lZCA/IHRoaXMubWV0YWRhdGEgOiBwcm9wcy5tZXRhZGF0YSk7XG4gICAgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24gbWVyZ2VNYXBzPFRLZXksIFRWYWw+KG0xPzogTWFwPFRLZXksIFRWYWw+IHwgbnVsbCwgbTI/OiBNYXA8VEtleSwgVFZhbD4gfCBudWxsKTogTWFwPFRLZXksIFRWYWw+IHtcbiAgICByZXR1cm4gbmV3IE1hcChbLi4uKG0xIHx8IG5ldyBNYXAoKSksIC4uLihtMiB8fCBuZXcgTWFwKCkpXSk7XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiBnZW5lcmF0ZURpY3Rpb25hcnlNYXAoZmllbGRzOiBGaWVsZFtdLCBkaWN0aW9uYXJpZXM6IE1hcDxudW1iZXIsIERhdGFUeXBlPiwgZGljdGlvbmFyeUZpZWxkczogTWFwPG51bWJlciwgRmllbGQ8RGljdGlvbmFyeT5bXT4pIHtcblxuICAgIGZvciAobGV0IGkgPSAtMSwgbiA9IGZpZWxkcy5sZW5ndGg7ICsraSA8IG47KSB7XG4gICAgICAgIGNvbnN0IGZpZWxkID0gZmllbGRzW2ldO1xuICAgICAgICBjb25zdCB0eXBlID0gZmllbGQudHlwZTtcbiAgICAgICAgaWYgKERhdGFUeXBlLmlzRGljdGlvbmFyeSh0eXBlKSkge1xuICAgICAgICAgICAgaWYgKCFkaWN0aW9uYXJ5RmllbGRzLmdldCh0eXBlLmlkKSkge1xuICAgICAgICAgICAgICAgIGRpY3Rpb25hcnlGaWVsZHMuc2V0KHR5cGUuaWQsIFtdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghZGljdGlvbmFyaWVzLmhhcyh0eXBlLmlkKSkge1xuICAgICAgICAgICAgICAgIGRpY3Rpb25hcmllcy5zZXQodHlwZS5pZCwgdHlwZS5kaWN0aW9uYXJ5KTtcbiAgICAgICAgICAgICAgICBkaWN0aW9uYXJ5RmllbGRzLmdldCh0eXBlLmlkKSEucHVzaChmaWVsZCBhcyBhbnkpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChkaWN0aW9uYXJpZXMuZ2V0KHR5cGUuaWQpICE9PSB0eXBlLmRpY3Rpb25hcnkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBjcmVhdGUgU2NoZW1hIGNvbnRhaW5pbmcgdHdvIGRpZmZlcmVudCBkaWN0aW9uYXJpZXMgd2l0aCB0aGUgc2FtZSBJZGApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBnZW5lcmF0ZURpY3Rpb25hcnlNYXAodHlwZS5jaGlsZHJlbiwgZGljdGlvbmFyaWVzLCBkaWN0aW9uYXJ5RmllbGRzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IGRpY3Rpb25hcmllcywgZGljdGlvbmFyeUZpZWxkcyB9O1xufVxuIl19
