"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const args_1 = require("./util/args");
const type_1 = require("./type");
const args_2 = require("./util/args");
const typecomparator_1 = require("./visitor/typecomparator");
class Schema {
    constructor(fields = [], metadata, dictionaries, dictionaryFields) {
        this.fields = (fields || []);
        this.metadata = metadata || new Map();
        if (!dictionaries || !dictionaryFields) {
            ({ dictionaries, dictionaryFields } = generateDictionaryMap(fields, dictionaries || new Map(), dictionaryFields || new Map()));
        }
        this.dictionaries = dictionaries;
        this.dictionaryFields = dictionaryFields;
    }
    /** @nocollapse */
    static from(...args) {
        return Schema.new(args[0], args[1]);
    }
    /** @nocollapse */
    static new(...args) {
        return new Schema(args_2.selectFieldArgs(args)[0]);
    }
    get [Symbol.toStringTag]() { return 'Schema'; }
    toString() {
        return `Schema<{ ${this.fields.map((f, i) => `${i}: ${f}`).join(', ')} }>`;
    }
    compareTo(other) {
        return typecomparator_1.instance.compareSchemas(this, other);
    }
    select(...columnNames) {
        const names = columnNames.reduce((xs, x) => (xs[x] = true) && xs, Object.create(null));
        return new Schema(this.fields.filter((f) => names[f.name]), this.metadata);
    }
    selectAt(...columnIndices) {
        return new Schema(columnIndices.map((i) => this.fields[i]).filter(Boolean), this.metadata);
    }
    assign(...args) {
        const other = args[0] instanceof Schema ? args[0]
            : new Schema(args_1.selectArgs(Field, args));
        const curFields = [...this.fields];
        const curDictionaries = [...this.dictionaries];
        const curDictionaryFields = this.dictionaryFields;
        const metadata = mergeMaps(mergeMaps(new Map(), this.metadata), other.metadata);
        const newFields = other.fields.filter((f2) => {
            const i = curFields.findIndex((f) => f.compareTo(f2));
            return ~i ? (curFields[i] = curFields[i].clone({
                metadata: mergeMaps(mergeMaps(new Map(), curFields[i].metadata), f2.metadata)
            })) && false : true;
        });
        const { dictionaries, dictionaryFields } = generateDictionaryMap(newFields, new Map(), new Map());
        const newDictionaries = [...dictionaries].filter(([y]) => !curDictionaries.every(([x]) => x === y));
        const newDictionaryFields = [...dictionaryFields].map(([id, newDictFields]) => {
            return [id, [...(curDictionaryFields.get(id) || []), ...newDictFields.map((f) => {
                        const i = newFields.findIndex((f2) => f2.compareTo(f));
                        const { dictionary, indices, isOrdered, dictionaryVector } = f.type;
                        const type = new type_1.Dictionary(dictionary, indices, id, isOrdered, dictionaryVector);
                        return newFields[i] = f.clone({ type });
                    })]];
        });
        return new Schema([...curFields, ...newFields], metadata, new Map([...curDictionaries, ...newDictionaries]), new Map([...curDictionaryFields, ...newDictionaryFields]));
    }
}
exports.Schema = Schema;
class Field {
    constructor(name, type, nullable = false, metadata) {
        this.name = name;
        this.type = type;
        this.nullable = nullable;
        this.metadata = metadata || new Map();
    }
    /** @nocollapse */
    static new(...args) {
        let [name, type, nullable, metadata] = args;
        if (args[0] && typeof args[0] === 'object') {
            ({ name } = args[0]);
            (type === undefined) && (type = args[0].type);
            (nullable === undefined) && (nullable = args[0].nullable);
            (metadata === undefined) && (metadata = args[0].metadata);
        }
        return new Field(`${name}`, type, nullable, metadata);
    }
    get typeId() { return this.type.typeId; }
    get [Symbol.toStringTag]() { return 'Field'; }
    toString() { return `${this.name}: ${this.type}`; }
    compareTo(other) {
        return typecomparator_1.instance.compareField(this, other);
    }
    clone(...args) {
        let [name, type, nullable, metadata] = args;
        (!args[0] || typeof args[0] !== 'object')
            ? ([name = this.name, type = this.type, nullable = this.nullable, metadata = this.metadata] = args)
            : ({ name = this.name, type = this.type, nullable = this.nullable, metadata = this.metadata } = args[0]);
        return Field.new(name, type, nullable, metadata);
    }
}
exports.Field = Field;
/** @ignore */
function mergeMaps(m1, m2) {
    return new Map([...(m1 || new Map()), ...(m2 || new Map())]);
}
/** @ignore */
function generateDictionaryMap(fields, dictionaries, dictionaryFields) {
    for (let i = -1, n = fields.length; ++i < n;) {
        const field = fields[i];
        const type = field.type;
        if (type_1.DataType.isDictionary(type)) {
            if (!dictionaryFields.get(type.id)) {
                dictionaryFields.set(type.id, []);
            }
            if (!dictionaries.has(type.id)) {
                dictionaries.set(type.id, type.dictionary);
                dictionaryFields.get(type.id).push(field);
            }
            else if (dictionaries.get(type.id) !== type.dictionary) {
                throw new Error(`Cannot create Schema containing two different dictionaries with the same Id`);
            }
        }
        if (type.children) {
            generateDictionaryMap(type.children, dictionaries, dictionaryFields);
        }
    }
    return { dictionaries, dictionaryFields };
}
// Add these here so they're picked up by the externs creator
// in the build, and closure-compiler doesn't minify them away
Schema.prototype.fields = null;
Schema.prototype.metadata = null;
Schema.prototype.dictionaries = null;
Schema.prototype.dictionaryFields = null;
Field.prototype.type = null;
Field.prototype.name = null;
Field.prototype.nullable = null;
Field.prototype.metadata = null;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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R0FBRyxJQUFJLENBQUM7QUFDcEMsS0FBSyxDQUFDLFNBQWlCLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztBQUNwQyxLQUFLLENBQUMsU0FBaUIsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ3hDLEtBQUssQ0FBQyxTQUFpQixDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMiLCJmaWxlIjoic2NoZW1hLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IERhdGEgfSBmcm9tICcuL2RhdGEnO1xuaW1wb3J0IHsgVmVjdG9yIH0gZnJvbSAnLi92ZWN0b3InO1xuaW1wb3J0IHsgc2VsZWN0QXJncyB9IGZyb20gJy4vdXRpbC9hcmdzJztcbmltcG9ydCB7IERhdGFUeXBlLCBEaWN0aW9uYXJ5IH0gZnJvbSAnLi90eXBlJztcbmltcG9ydCB7IHNlbGVjdEZpZWxkQXJncyB9IGZyb20gJy4vdXRpbC9hcmdzJztcbmltcG9ydCB7IGluc3RhbmNlIGFzIGNvbXBhcmVyIH0gZnJvbSAnLi92aXNpdG9yL3R5cGVjb21wYXJhdG9yJztcblxudHlwZSBWZWN0b3JNYXAgPSB7IFtrZXk6IHN0cmluZ106IFZlY3RvciB9O1xudHlwZSBGaWVsZHM8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfT4gPSAoa2V5b2YgVClbXSB8IEZpZWxkPFRba2V5b2YgVF0+W107XG50eXBlIENoaWxkRGF0YTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9PiA9IFRba2V5b2YgVF1bXSB8IERhdGE8VFtrZXlvZiBUXT5bXSB8IFZlY3RvcjxUW2tleW9mIFRdPltdO1xuXG5leHBvcnQgY2xhc3MgU2NoZW1hPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+IHtcblxuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihjaGlsZHJlbjogVCk6IFNjaGVtYTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIFZlY3Rvck1hcCA9IGFueT4oY2hpbGRyZW46IFQpOiBTY2hlbWE8eyBbUCBpbiBrZXlvZiBUXTogVFtQXVsndHlwZSddIH0+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihjaGlsZHJlbjogQ2hpbGREYXRhPFQ+LCBmaWVsZHM/OiBGaWVsZHM8VD4pOiBTY2hlbWE8VD47XG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAgIHJldHVybiBTY2hlbWEubmV3KGFyZ3NbMF0sIGFyZ3NbMV0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KGNoaWxkcmVuOiBUKTogU2NoZW1hPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyBWZWN0b3JNYXAgPSBhbnk+KGNoaWxkcmVuOiBUKTogU2NoZW1hPHsgW1AgaW4ga2V5b2YgVF06IFRbUF1bJ3R5cGUnXSB9PjtcbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihjaGlsZHJlbjogQ2hpbGREYXRhPFQ+LCBmaWVsZHM/OiBGaWVsZHM8VD4pOiBTY2hlbWE8VD47XG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBuZXcoLi4uYXJnczogYW55W10pIHtcbiAgICAgICAgcmV0dXJuIG5ldyBTY2hlbWEoc2VsZWN0RmllbGRBcmdzKGFyZ3MpWzBdKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgZmllbGRzOiBGaWVsZDxUW2tleW9mIFRdPltdO1xuICAgIHB1YmxpYyByZWFkb25seSBtZXRhZGF0YTogTWFwPHN0cmluZywgc3RyaW5nPjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgZGljdGlvbmFyaWVzOiBNYXA8bnVtYmVyLCBEYXRhVHlwZT47XG4gICAgcHVibGljIHJlYWRvbmx5IGRpY3Rpb25hcnlGaWVsZHM6IE1hcDxudW1iZXIsIEZpZWxkPERpY3Rpb25hcnk+W10+O1xuXG4gICAgY29uc3RydWN0b3IoZmllbGRzOiBGaWVsZFtdID0gW10sXG4gICAgICAgICAgICAgICAgbWV0YWRhdGE/OiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCxcbiAgICAgICAgICAgICAgICBkaWN0aW9uYXJpZXM/OiBNYXA8bnVtYmVyLCBEYXRhVHlwZT4gfCBudWxsLFxuICAgICAgICAgICAgICAgIGRpY3Rpb25hcnlGaWVsZHM/OiBNYXA8bnVtYmVyLCBGaWVsZDxEaWN0aW9uYXJ5PltdPiB8IG51bGwpIHtcbiAgICAgICAgdGhpcy5maWVsZHMgPSAoZmllbGRzIHx8IFtdKSBhcyBGaWVsZDxUW2tleW9mIFRdPltdO1xuICAgICAgICB0aGlzLm1ldGFkYXRhID0gbWV0YWRhdGEgfHwgbmV3IE1hcCgpO1xuICAgICAgICBpZiAoIWRpY3Rpb25hcmllcyB8fCAhZGljdGlvbmFyeUZpZWxkcykge1xuICAgICAgICAgICAgKHsgZGljdGlvbmFyaWVzLCBkaWN0aW9uYXJ5RmllbGRzIH0gPSBnZW5lcmF0ZURpY3Rpb25hcnlNYXAoXG4gICAgICAgICAgICAgICAgZmllbGRzLCBkaWN0aW9uYXJpZXMgfHwgbmV3IE1hcCgpLCBkaWN0aW9uYXJ5RmllbGRzIHx8IG5ldyBNYXAoKVxuICAgICAgICAgICAgKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kaWN0aW9uYXJpZXMgPSBkaWN0aW9uYXJpZXM7XG4gICAgICAgIHRoaXMuZGljdGlvbmFyeUZpZWxkcyA9IGRpY3Rpb25hcnlGaWVsZHM7XG4gICAgfVxuICAgIHB1YmxpYyBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKSB7IHJldHVybiAnU2NoZW1hJzsgfVxuICAgIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICAgICAgcmV0dXJuIGBTY2hlbWE8eyAke3RoaXMuZmllbGRzLm1hcCgoZiwgaSkgPT4gYCR7aX06ICR7Zn1gKS5qb2luKCcsICcpfSB9PmA7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBhcmVUbyhvdGhlcj86IFNjaGVtYSB8IG51bGwpOiBvdGhlciBpcyBTY2hlbWE8VD4ge1xuICAgICAgICByZXR1cm4gY29tcGFyZXIuY29tcGFyZVNjaGVtYXModGhpcywgb3RoZXIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZWxlY3Q8SyBleHRlbmRzIGtleW9mIFQgPSBhbnk+KC4uLmNvbHVtbk5hbWVzOiBLW10pIHtcbiAgICAgICAgY29uc3QgbmFtZXMgPSBjb2x1bW5OYW1lcy5yZWR1Y2UoKHhzLCB4KSA9PiAoeHNbeF0gPSB0cnVlKSAmJiB4cywgT2JqZWN0LmNyZWF0ZShudWxsKSk7XG4gICAgICAgIHJldHVybiBuZXcgU2NoZW1hPHsgW1AgaW4gS106IFRbUF0gfT4odGhpcy5maWVsZHMuZmlsdGVyKChmKSA9PiBuYW1lc1tmLm5hbWVdKSwgdGhpcy5tZXRhZGF0YSk7XG4gICAgfVxuICAgIHB1YmxpYyBzZWxlY3RBdDxLIGV4dGVuZHMgVFtrZXlvZiBUXSA9IGFueT4oLi4uY29sdW1uSW5kaWNlczogbnVtYmVyW10pIHtcbiAgICAgICAgcmV0dXJuIG5ldyBTY2hlbWE8eyBba2V5OiBzdHJpbmddOiBLIH0+KGNvbHVtbkluZGljZXMubWFwKChpKSA9PiB0aGlzLmZpZWxkc1tpXSkuZmlsdGVyKEJvb2xlYW4pLCB0aGlzLm1ldGFkYXRhKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXNzaWduPFIgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNjaGVtYTogU2NoZW1hPFI+KTogU2NoZW1hPFQgJiBSPjtcbiAgICBwdWJsaWMgYXNzaWduPFIgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KC4uLmZpZWxkczogKEZpZWxkPFJba2V5b2YgUl0+IHwgRmllbGQ8UltrZXlvZiBSXT5bXSlbXSk6IFNjaGVtYTxUICYgUj47XG4gICAgcHVibGljIGFzc2lnbjxSIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PiguLi5hcmdzOiAoU2NoZW1hPFI+IHwgRmllbGQ8UltrZXlvZiBSXT4gfCBGaWVsZDxSW2tleW9mIFJdPltdKVtdKSB7XG5cbiAgICAgICAgY29uc3Qgb3RoZXIgPSBhcmdzWzBdIGluc3RhbmNlb2YgU2NoZW1hID8gYXJnc1swXSBhcyBTY2hlbWE8Uj5cbiAgICAgICAgICAgIDogbmV3IFNjaGVtYTxSPihzZWxlY3RBcmdzPEZpZWxkPFJba2V5b2YgUl0+PihGaWVsZCwgYXJncykpO1xuXG4gICAgICAgIGNvbnN0IGN1ckZpZWxkcyA9IFsuLi50aGlzLmZpZWxkc10gYXMgRmllbGRbXTtcbiAgICAgICAgY29uc3QgY3VyRGljdGlvbmFyaWVzID0gWy4uLnRoaXMuZGljdGlvbmFyaWVzXTtcbiAgICAgICAgY29uc3QgY3VyRGljdGlvbmFyeUZpZWxkcyA9IHRoaXMuZGljdGlvbmFyeUZpZWxkcztcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBtZXJnZU1hcHMobWVyZ2VNYXBzKG5ldyBNYXAoKSwgdGhpcy5tZXRhZGF0YSksIG90aGVyLm1ldGFkYXRhKTtcbiAgICAgICAgY29uc3QgbmV3RmllbGRzID0gb3RoZXIuZmllbGRzLmZpbHRlcigoZjIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGkgPSBjdXJGaWVsZHMuZmluZEluZGV4KChmKSA9PiBmLmNvbXBhcmVUbyhmMikpO1xuICAgICAgICAgICAgcmV0dXJuIH5pID8gKGN1ckZpZWxkc1tpXSA9IGN1ckZpZWxkc1tpXS5jbG9uZSh7XG4gICAgICAgICAgICAgICAgbWV0YWRhdGE6IG1lcmdlTWFwcyhtZXJnZU1hcHMobmV3IE1hcCgpLCBjdXJGaWVsZHNbaV0ubWV0YWRhdGEpLCBmMi5tZXRhZGF0YSlcbiAgICAgICAgICAgIH0pKSAmJiBmYWxzZSA6IHRydWU7XG4gICAgICAgIH0pIGFzIEZpZWxkW107XG5cbiAgICAgICAgY29uc3QgeyBkaWN0aW9uYXJpZXMsIGRpY3Rpb25hcnlGaWVsZHMgfSA9IGdlbmVyYXRlRGljdGlvbmFyeU1hcChuZXdGaWVsZHMsIG5ldyBNYXAoKSwgbmV3IE1hcCgpKTtcbiAgICAgICAgY29uc3QgbmV3RGljdGlvbmFyaWVzID0gWy4uLmRpY3Rpb25hcmllc10uZmlsdGVyKChbeV0pID0+ICFjdXJEaWN0aW9uYXJpZXMuZXZlcnkoKFt4XSkgPT4geCA9PT0geSkpO1xuICAgICAgICBjb25zdCBuZXdEaWN0aW9uYXJ5RmllbGRzID0gWy4uLmRpY3Rpb25hcnlGaWVsZHNdLm1hcCgoW2lkLCBuZXdEaWN0RmllbGRzXSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFtpZCwgWy4uLihjdXJEaWN0aW9uYXJ5RmllbGRzLmdldChpZCkgfHwgW10pLCAuLi5uZXdEaWN0RmllbGRzLm1hcCgoZikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGkgPSBuZXdGaWVsZHMuZmluZEluZGV4KChmMikgPT4gZjIuY29tcGFyZVRvKGYpKTtcbiAgICAgICAgICAgICAgICBjb25zdCB7IGRpY3Rpb25hcnksIGluZGljZXMsIGlzT3JkZXJlZCwgZGljdGlvbmFyeVZlY3RvciB9ID0gZi50eXBlO1xuICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBuZXcgRGljdGlvbmFyeShkaWN0aW9uYXJ5LCBpbmRpY2VzLCBpZCwgaXNPcmRlcmVkLCBkaWN0aW9uYXJ5VmVjdG9yKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3RmllbGRzW2ldID0gZi5jbG9uZSh7IHR5cGUgfSk7XG4gICAgICAgICAgICB9KV1dIGFzIFtudW1iZXIsIEZpZWxkPERpY3Rpb25hcnk+W11dO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbmV3IFNjaGVtYTxUICYgUj4oXG4gICAgICAgICAgICBbLi4uY3VyRmllbGRzLCAuLi5uZXdGaWVsZHNdLCBtZXRhZGF0YSxcbiAgICAgICAgICAgIG5ldyBNYXAoWy4uLmN1ckRpY3Rpb25hcmllcywgLi4ubmV3RGljdGlvbmFyaWVzXSksXG4gICAgICAgICAgICBuZXcgTWFwKFsuLi5jdXJEaWN0aW9uYXJ5RmllbGRzLCAuLi5uZXdEaWN0aW9uYXJ5RmllbGRzXSlcbiAgICAgICAgKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBGaWVsZDxUIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+IHtcblxuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4ocHJvcHM6IHsgbmFtZTogc3RyaW5nIHwgbnVtYmVyLCB0eXBlOiBULCBudWxsYWJsZT86IGJvb2xlYW4sIG1ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPiB8IG51bGwgfSk6IEZpZWxkPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4obmFtZTogc3RyaW5nIHwgbnVtYmVyIHwgRmllbGQ8VD4sIHR5cGU6IFQsIG51bGxhYmxlPzogYm9vbGVhbiwgbWV0YWRhdGE/OiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCk6IEZpZWxkPFQ+O1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4oLi4uYXJnczogYW55W10pIHtcbiAgICAgICAgbGV0IFtuYW1lLCB0eXBlLCBudWxsYWJsZSwgbWV0YWRhdGFdID0gYXJncztcbiAgICAgICAgaWYgKGFyZ3NbMF0gJiYgdHlwZW9mIGFyZ3NbMF0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAoeyBuYW1lIH0gPSBhcmdzWzBdKTtcbiAgICAgICAgICAgICh0eXBlID09PSB1bmRlZmluZWQpICYmICh0eXBlID0gYXJnc1swXS50eXBlKTtcbiAgICAgICAgICAgIChudWxsYWJsZSA9PT0gdW5kZWZpbmVkKSAmJiAobnVsbGFibGUgPSBhcmdzWzBdLm51bGxhYmxlKTtcbiAgICAgICAgICAgIChtZXRhZGF0YSA9PT0gdW5kZWZpbmVkKSAmJiAobWV0YWRhdGEgPSBhcmdzWzBdLm1ldGFkYXRhKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IEZpZWxkPFQ+KGAke25hbWV9YCwgdHlwZSwgbnVsbGFibGUsIG1ldGFkYXRhKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgdHlwZTogVDtcbiAgICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICAgIHB1YmxpYyByZWFkb25seSBudWxsYWJsZTogYm9vbGVhbjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgbWV0YWRhdGE6IE1hcDxzdHJpbmcsIHN0cmluZz47XG5cbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIHR5cGU6IFQsIG51bGxhYmxlID0gZmFsc2UsIG1ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPiB8IG51bGwpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5udWxsYWJsZSA9IG51bGxhYmxlO1xuICAgICAgICB0aGlzLm1ldGFkYXRhID0gbWV0YWRhdGEgfHwgbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgdHlwZUlkKCkgeyByZXR1cm4gdGhpcy50eXBlLnR5cGVJZDsgfVxuICAgIHB1YmxpYyBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKSB7IHJldHVybiAnRmllbGQnOyB9XG4gICAgcHVibGljIHRvU3RyaW5nKCkgeyByZXR1cm4gYCR7dGhpcy5uYW1lfTogJHt0aGlzLnR5cGV9YDsgfVxuICAgIHB1YmxpYyBjb21wYXJlVG8ob3RoZXI/OiBGaWVsZCB8IG51bGwpOiBvdGhlciBpcyBGaWVsZDxUPiB7XG4gICAgICAgIHJldHVybiBjb21wYXJlci5jb21wYXJlRmllbGQodGhpcywgb3RoZXIpO1xuICAgIH1cbiAgICBwdWJsaWMgY2xvbmU8UiBleHRlbmRzIERhdGFUeXBlID0gVD4ocHJvcHM6IHsgbmFtZT86IHN0cmluZyB8IG51bWJlciwgdHlwZT86IFIsIG51bGxhYmxlPzogYm9vbGVhbiwgbWV0YWRhdGE/OiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCB9KTogRmllbGQ8Uj47XG4gICAgcHVibGljIGNsb25lPFIgZXh0ZW5kcyBEYXRhVHlwZSA9IFQ+KG5hbWU/OiBzdHJpbmcgfCBudW1iZXIgfCBGaWVsZDxUPiwgdHlwZT86IFIsIG51bGxhYmxlPzogYm9vbGVhbiwgbWV0YWRhdGE/OiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCk6IEZpZWxkPFI+O1xuICAgIHB1YmxpYyBjbG9uZTxSIGV4dGVuZHMgRGF0YVR5cGUgPSBUPiguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICBsZXQgW25hbWUsIHR5cGUsIG51bGxhYmxlLCBtZXRhZGF0YV0gPSBhcmdzO1xuICAgICAgICAoIWFyZ3NbMF0gfHwgdHlwZW9mIGFyZ3NbMF0gIT09ICdvYmplY3QnKVxuICAgICAgICAgICAgPyAoW25hbWUgPSB0aGlzLm5hbWUsIHR5cGUgPSB0aGlzLnR5cGUsIG51bGxhYmxlID0gdGhpcy5udWxsYWJsZSwgbWV0YWRhdGEgPSB0aGlzLm1ldGFkYXRhXSA9IGFyZ3MpXG4gICAgICAgICAgICA6ICh7bmFtZSA9IHRoaXMubmFtZSwgdHlwZSA9IHRoaXMudHlwZSwgbnVsbGFibGUgPSB0aGlzLm51bGxhYmxlLCBtZXRhZGF0YSA9IHRoaXMubWV0YWRhdGF9ID0gYXJnc1swXSk7XG4gICAgICAgIHJldHVybiBGaWVsZC5uZXc8Uj4obmFtZSwgdHlwZSwgbnVsbGFibGUsIG1ldGFkYXRhKTtcbiAgICB9XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiBtZXJnZU1hcHM8VEtleSwgVFZhbD4obTE/OiBNYXA8VEtleSwgVFZhbD4gfCBudWxsLCBtMj86IE1hcDxUS2V5LCBUVmFsPiB8IG51bGwpOiBNYXA8VEtleSwgVFZhbD4ge1xuICAgIHJldHVybiBuZXcgTWFwKFsuLi4obTEgfHwgbmV3IE1hcCgpKSwgLi4uKG0yIHx8IG5ldyBNYXAoKSldKTtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uIGdlbmVyYXRlRGljdGlvbmFyeU1hcChmaWVsZHM6IEZpZWxkW10sIGRpY3Rpb25hcmllczogTWFwPG51bWJlciwgRGF0YVR5cGU+LCBkaWN0aW9uYXJ5RmllbGRzOiBNYXA8bnVtYmVyLCBGaWVsZDxEaWN0aW9uYXJ5PltdPikge1xuXG4gICAgZm9yIChsZXQgaSA9IC0xLCBuID0gZmllbGRzLmxlbmd0aDsgKytpIDwgbjspIHtcbiAgICAgICAgY29uc3QgZmllbGQgPSBmaWVsZHNbaV07XG4gICAgICAgIGNvbnN0IHR5cGUgPSBmaWVsZC50eXBlO1xuICAgICAgICBpZiAoRGF0YVR5cGUuaXNEaWN0aW9uYXJ5KHR5cGUpKSB7XG4gICAgICAgICAgICBpZiAoIWRpY3Rpb25hcnlGaWVsZHMuZ2V0KHR5cGUuaWQpKSB7XG4gICAgICAgICAgICAgICAgZGljdGlvbmFyeUZpZWxkcy5zZXQodHlwZS5pZCwgW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFkaWN0aW9uYXJpZXMuaGFzKHR5cGUuaWQpKSB7XG4gICAgICAgICAgICAgICAgZGljdGlvbmFyaWVzLnNldCh0eXBlLmlkLCB0eXBlLmRpY3Rpb25hcnkpO1xuICAgICAgICAgICAgICAgIGRpY3Rpb25hcnlGaWVsZHMuZ2V0KHR5cGUuaWQpIS5wdXNoKGZpZWxkIGFzIGFueSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGRpY3Rpb25hcmllcy5nZXQodHlwZS5pZCkgIT09IHR5cGUuZGljdGlvbmFyeSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNyZWF0ZSBTY2hlbWEgY29udGFpbmluZyB0d28gZGlmZmVyZW50IGRpY3Rpb25hcmllcyB3aXRoIHRoZSBzYW1lIElkYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGdlbmVyYXRlRGljdGlvbmFyeU1hcCh0eXBlLmNoaWxkcmVuLCBkaWN0aW9uYXJpZXMsIGRpY3Rpb25hcnlGaWVsZHMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgZGljdGlvbmFyaWVzLCBkaWN0aW9uYXJ5RmllbGRzIH07XG59XG5cbi8vIEFkZCB0aGVzZSBoZXJlIHNvIHRoZXkncmUgcGlja2VkIHVwIGJ5IHRoZSBleHRlcm5zIGNyZWF0b3Jcbi8vIGluIHRoZSBidWlsZCwgYW5kIGNsb3N1cmUtY29tcGlsZXIgZG9lc24ndCBtaW5pZnkgdGhlbSBhd2F5XG4oU2NoZW1hLnByb3RvdHlwZSBhcyBhbnkpLmZpZWxkcyA9IG51bGw7XG4oU2NoZW1hLnByb3RvdHlwZSBhcyBhbnkpLm1ldGFkYXRhID0gbnVsbDtcbihTY2hlbWEucHJvdG90eXBlIGFzIGFueSkuZGljdGlvbmFyaWVzID0gbnVsbDtcbihTY2hlbWEucHJvdG90eXBlIGFzIGFueSkuZGljdGlvbmFyeUZpZWxkcyA9IG51bGw7XG5cbihGaWVsZC5wcm90b3R5cGUgYXMgYW55KS50eXBlID0gbnVsbDtcbihGaWVsZC5wcm90b3R5cGUgYXMgYW55KS5uYW1lID0gbnVsbDtcbihGaWVsZC5wcm90b3R5cGUgYXMgYW55KS5udWxsYWJsZSA9IG51bGw7XG4oRmllbGQucHJvdG90eXBlIGFzIGFueSkubWV0YWRhdGEgPSBudWxsO1xuIl19
