"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const args_1 = require("./util/args");
const type_1 = require("./type");
const args_2 = require("./util/args");
const typecomparator_1 = require("./visitor/typecomparator");
class Schema {
    constructor(fields = [], metadata, dictionaries, dictionaryFields) {
        this.fields = (fields || []);
        this.metadata = metadata || new Map();
        if (!dictionaries || !dictionaryFields) {
            ({ dictionaries, dictionaryFields } = generateDictionaryMap(fields, dictionaries || new Map(), dictionaryFields || new Map()));
        }
        this.dictionaries = dictionaries;
        this.dictionaryFields = dictionaryFields;
    }
    /** @nocollapse */
    static from(...args) {
        return Schema.new(args[0], args[1]);
    }
    /** @nocollapse */
    static new(...args) {
        return new Schema(args_2.selectFieldArgs(args)[0]);
    }
    get [Symbol.toStringTag]() { return 'Schema'; }
    toString() {
        return `Schema<{ ${this.fields.map((f, i) => `${i}: ${f}`).join(', ')} }>`;
    }
    compareTo(other) {
        return typecomparator_1.instance.compareSchemas(this, other);
    }
    select(...columnNames) {
        const names = columnNames.reduce((xs, x) => (xs[x] = true) && xs, Object.create(null));
        return new Schema(this.fields.filter((f) => names[f.name]), this.metadata);
    }
    selectAt(...columnIndices) {
        return new Schema(columnIndices.map((i) => this.fields[i]).filter(Boolean), this.metadata);
    }
    assign(...args) {
        const other = args[0] instanceof Schema ? args[0]
            : new Schema(args_1.selectArgs(Field, args));
        const curFields = [...this.fields];
        const curDictionaries = [...this.dictionaries];
        const curDictionaryFields = this.dictionaryFields;
        const metadata = mergeMaps(mergeMaps(new Map(), this.metadata), other.metadata);
        const newFields = other.fields.filter((f2) => {
            const i = curFields.findIndex((f) => f.name === f2.name);
            return ~i ? (curFields[i] = f2.clone({
                metadata: mergeMaps(mergeMaps(new Map(), curFields[i].metadata), f2.metadata)
            })) && false : true;
        });
        const { dictionaries, dictionaryFields } = generateDictionaryMap(newFields, new Map(), new Map());
        const newDictionaries = [...dictionaries].filter(([y]) => !curDictionaries.every(([x]) => x === y));
        const newDictionaryFields = [...dictionaryFields].map(([id, newDictFields]) => {
            return [id, [...(curDictionaryFields.get(id) || []), ...newDictFields.map((f) => {
                        const i = newFields.findIndex((f2) => f.name === f2.name);
                        const { dictionary, indices, isOrdered, dictionaryVector } = f.type;
                        const type = new type_1.Dictionary(dictionary, indices, id, isOrdered, dictionaryVector);
                        return newFields[i] = f.clone({ type });
                    })]];
        });
        return new Schema([...curFields, ...newFields], metadata, new Map([...curDictionaries, ...newDictionaries]), new Map([...curDictionaryFields, ...newDictionaryFields]));
    }
}
exports.Schema = Schema;
class Field {
    constructor(name, type, nullable = false, metadata) {
        this.name = name;
        this.type = type;
        this.nullable = nullable;
        this.metadata = metadata || new Map();
    }
    /** @nocollapse */
    static new(...args) {
        let [name, type, nullable, metadata] = args;
        if (args[0] && typeof args[0] === 'object') {
            ({ name } = args[0]);
            (type === undefined) && (type = args[0].type);
            (nullable === undefined) && (nullable = args[0].nullable);
            (metadata === undefined) && (metadata = args[0].metadata);
        }
        return new Field(`${name}`, type, nullable, metadata);
    }
    get typeId() { return this.type.typeId; }
    get [Symbol.toStringTag]() { return 'Field'; }
    toString() { return `${this.name}: ${this.type}`; }
    compareTo(other) {
        return typecomparator_1.instance.compareField(this, other);
    }
    clone(...args) {
        let [name, type, nullable, metadata] = args;
        (!args[0] || typeof args[0] !== 'object')
            ? ([name = this.name, type = this.type, nullable = this.nullable, metadata = this.metadata] = args)
            : ({ name = this.name, type = this.type, nullable = this.nullable, metadata = this.metadata } = args[0]);
        return Field.new(name, type, nullable, metadata);
    }
}
exports.Field = Field;
/** @ignore */
function mergeMaps(m1, m2) {
    return new Map([...(m1 || new Map()), ...(m2 || new Map())]);
}
/** @ignore */
function generateDictionaryMap(fields, dictionaries, dictionaryFields) {
    for (let i = -1, n = fields.length; ++i < n;) {
        const field = fields[i];
        const type = field.type;
        if (type_1.DataType.isDictionary(type)) {
            if (!dictionaryFields.get(type.id)) {
                dictionaryFields.set(type.id, []);
            }
            if (!dictionaries.has(type.id)) {
                dictionaries.set(type.id, type.dictionary);
                dictionaryFields.get(type.id).push(field);
            }
            else if (dictionaries.get(type.id) !== type.dictionary) {
                throw new Error(`Cannot create Schema containing two different dictionaries with the same Id`);
            }
        }
        if (type.children) {
            generateDictionaryMap(type.children, dictionaries, dictionaryFields);
        }
    }
    return { dictionaries, dictionaryFields };
}
// Add these here so they're picked up by the externs creator
// in the build, and closure-compiler doesn't minify them away
Schema.prototype.fields = null;
Schema.prototype.metadata = null;
Schema.prototype.dictionaries = null;
Schema.prototype.dictionaryFields = null;
Field.prototype.type = null;
Field.prototype.name = null;
Field.prototype.nullable = null;
Field.prototype.metadata = null;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SUFBSSxDQUFDO0FBQ3BDLEtBQUssQ0FBQyxTQUFpQixDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDcEMsS0FBSyxDQUFDLFNBQWlCLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztBQUN4QyxLQUFLLENBQUMsU0FBaUIsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDIiwiZmlsZSI6InNjaGVtYS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBEYXRhIH0gZnJvbSAnLi9kYXRhJztcbmltcG9ydCB7IFZlY3RvciB9IGZyb20gJy4vdmVjdG9yJztcbmltcG9ydCB7IHNlbGVjdEFyZ3MgfSBmcm9tICcuL3V0aWwvYXJncyc7XG5pbXBvcnQgeyBEYXRhVHlwZSwgRGljdGlvbmFyeSB9IGZyb20gJy4vdHlwZSc7XG5pbXBvcnQgeyBzZWxlY3RGaWVsZEFyZ3MgfSBmcm9tICcuL3V0aWwvYXJncyc7XG5pbXBvcnQgeyBpbnN0YW5jZSBhcyBjb21wYXJlciB9IGZyb20gJy4vdmlzaXRvci90eXBlY29tcGFyYXRvcic7XG5cbnR5cGUgVmVjdG9yTWFwID0geyBba2V5OiBzdHJpbmddOiBWZWN0b3IgfTtcbnR5cGUgRmllbGRzPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0+ID0gKGtleW9mIFQpW10gfCBGaWVsZDxUW2tleW9mIFRdPltdO1xudHlwZSBDaGlsZERhdGE8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfT4gPSBUW2tleW9mIFRdW10gfCBEYXRhPFRba2V5b2YgVF0+W10gfCBWZWN0b3I8VFtrZXlvZiBUXT5bXTtcblxuZXhwb3J0IGNsYXNzIFNjaGVtYTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PiB7XG5cbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oY2hpbGRyZW46IFQpOiBTY2hlbWE8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyBWZWN0b3JNYXAgPSBhbnk+KGNoaWxkcmVuOiBUKTogU2NoZW1hPHsgW1AgaW4ga2V5b2YgVF06IFRbUF1bJ3R5cGUnXSB9PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oY2hpbGRyZW46IENoaWxkRGF0YTxUPiwgZmllbGRzPzogRmllbGRzPFQ+KTogU2NoZW1hPFQ+O1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbSguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICByZXR1cm4gU2NoZW1hLm5ldyhhcmdzWzBdLCBhcmdzWzFdKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihjaGlsZHJlbjogVCk6IFNjaGVtYTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgVmVjdG9yTWFwID0gYW55PihjaGlsZHJlbjogVCk6IFNjaGVtYTx7IFtQIGluIGtleW9mIFRdOiBUW1BdWyd0eXBlJ10gfT47XG4gICAgcHVibGljIHN0YXRpYyBuZXc8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oY2hpbGRyZW46IENoaWxkRGF0YTxUPiwgZmllbGRzPzogRmllbGRzPFQ+KTogU2NoZW1hPFQ+O1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3KC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAgIHJldHVybiBuZXcgU2NoZW1hKHNlbGVjdEZpZWxkQXJncyhhcmdzKVswXSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlYWRvbmx5IGZpZWxkczogRmllbGQ8VFtrZXlvZiBUXT5bXTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgbWV0YWRhdGE6IE1hcDxzdHJpbmcsIHN0cmluZz47XG4gICAgcHVibGljIHJlYWRvbmx5IGRpY3Rpb25hcmllczogTWFwPG51bWJlciwgRGF0YVR5cGU+O1xuICAgIHB1YmxpYyByZWFkb25seSBkaWN0aW9uYXJ5RmllbGRzOiBNYXA8bnVtYmVyLCBGaWVsZDxEaWN0aW9uYXJ5PltdPjtcblxuICAgIGNvbnN0cnVjdG9yKGZpZWxkczogRmllbGRbXSA9IFtdLFxuICAgICAgICAgICAgICAgIG1ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPiB8IG51bGwsXG4gICAgICAgICAgICAgICAgZGljdGlvbmFyaWVzPzogTWFwPG51bWJlciwgRGF0YVR5cGU+IHwgbnVsbCxcbiAgICAgICAgICAgICAgICBkaWN0aW9uYXJ5RmllbGRzPzogTWFwPG51bWJlciwgRmllbGQ8RGljdGlvbmFyeT5bXT4gfCBudWxsKSB7XG4gICAgICAgIHRoaXMuZmllbGRzID0gKGZpZWxkcyB8fCBbXSkgYXMgRmllbGQ8VFtrZXlvZiBUXT5bXTtcbiAgICAgICAgdGhpcy5tZXRhZGF0YSA9IG1ldGFkYXRhIHx8IG5ldyBNYXAoKTtcbiAgICAgICAgaWYgKCFkaWN0aW9uYXJpZXMgfHwgIWRpY3Rpb25hcnlGaWVsZHMpIHtcbiAgICAgICAgICAgICh7IGRpY3Rpb25hcmllcywgZGljdGlvbmFyeUZpZWxkcyB9ID0gZ2VuZXJhdGVEaWN0aW9uYXJ5TWFwKFxuICAgICAgICAgICAgICAgIGZpZWxkcywgZGljdGlvbmFyaWVzIHx8IG5ldyBNYXAoKSwgZGljdGlvbmFyeUZpZWxkcyB8fCBuZXcgTWFwKClcbiAgICAgICAgICAgICkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGljdGlvbmFyaWVzID0gZGljdGlvbmFyaWVzO1xuICAgICAgICB0aGlzLmRpY3Rpb25hcnlGaWVsZHMgPSBkaWN0aW9uYXJ5RmllbGRzO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0IFtTeW1ib2wudG9TdHJpbmdUYWddKCkgeyByZXR1cm4gJ1NjaGVtYSc7IH1cbiAgICBwdWJsaWMgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBgU2NoZW1hPHsgJHt0aGlzLmZpZWxkcy5tYXAoKGYsIGkpID0+IGAke2l9OiAke2Z9YCkuam9pbignLCAnKX0gfT5gO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wYXJlVG8ob3RoZXI/OiBTY2hlbWEgfCBudWxsKTogb3RoZXIgaXMgU2NoZW1hPFQ+IHtcbiAgICAgICAgcmV0dXJuIGNvbXBhcmVyLmNvbXBhcmVTY2hlbWFzKHRoaXMsIG90aGVyKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2VsZWN0PEsgZXh0ZW5kcyBrZXlvZiBUID0gYW55PiguLi5jb2x1bW5OYW1lczogS1tdKSB7XG4gICAgICAgIGNvbnN0IG5hbWVzID0gY29sdW1uTmFtZXMucmVkdWNlKCh4cywgeCkgPT4gKHhzW3hdID0gdHJ1ZSkgJiYgeHMsIE9iamVjdC5jcmVhdGUobnVsbCkpO1xuICAgICAgICByZXR1cm4gbmV3IFNjaGVtYTx7IFtQIGluIEtdOiBUW1BdIH0+KHRoaXMuZmllbGRzLmZpbHRlcigoZikgPT4gbmFtZXNbZi5uYW1lXSksIHRoaXMubWV0YWRhdGEpO1xuICAgIH1cbiAgICBwdWJsaWMgc2VsZWN0QXQ8SyBleHRlbmRzIFRba2V5b2YgVF0gPSBhbnk+KC4uLmNvbHVtbkluZGljZXM6IG51bWJlcltdKSB7XG4gICAgICAgIHJldHVybiBuZXcgU2NoZW1hPHsgW2tleTogc3RyaW5nXTogSyB9Pihjb2x1bW5JbmRpY2VzLm1hcCgoaSkgPT4gdGhpcy5maWVsZHNbaV0pLmZpbHRlcihCb29sZWFuKSwgdGhpcy5tZXRhZGF0YSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzc2lnbjxSIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihzY2hlbWE6IFNjaGVtYTxSPik6IFNjaGVtYTxUICYgUj47XG4gICAgcHVibGljIGFzc2lnbjxSIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PiguLi5maWVsZHM6IChGaWVsZDxSW2tleW9mIFJdPiB8IEZpZWxkPFJba2V5b2YgUl0+W10pW10pOiBTY2hlbWE8VCAmIFI+O1xuICAgIHB1YmxpYyBhc3NpZ248UiBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oLi4uYXJnczogKFNjaGVtYTxSPiB8IEZpZWxkPFJba2V5b2YgUl0+IHwgRmllbGQ8UltrZXlvZiBSXT5bXSlbXSkge1xuXG4gICAgICAgIGNvbnN0IG90aGVyID0gYXJnc1swXSBpbnN0YW5jZW9mIFNjaGVtYSA/IGFyZ3NbMF0gYXMgU2NoZW1hPFI+XG4gICAgICAgICAgICA6IG5ldyBTY2hlbWE8Uj4oc2VsZWN0QXJnczxGaWVsZDxSW2tleW9mIFJdPj4oRmllbGQsIGFyZ3MpKTtcblxuICAgICAgICBjb25zdCBjdXJGaWVsZHMgPSBbLi4udGhpcy5maWVsZHNdIGFzIEZpZWxkW107XG4gICAgICAgIGNvbnN0IGN1ckRpY3Rpb25hcmllcyA9IFsuLi50aGlzLmRpY3Rpb25hcmllc107XG4gICAgICAgIGNvbnN0IGN1ckRpY3Rpb25hcnlGaWVsZHMgPSB0aGlzLmRpY3Rpb25hcnlGaWVsZHM7XG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gbWVyZ2VNYXBzKG1lcmdlTWFwcyhuZXcgTWFwKCksIHRoaXMubWV0YWRhdGEpLCBvdGhlci5tZXRhZGF0YSk7XG4gICAgICAgIGNvbnN0IG5ld0ZpZWxkcyA9IG90aGVyLmZpZWxkcy5maWx0ZXIoKGYyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpID0gY3VyRmllbGRzLmZpbmRJbmRleCgoZikgPT4gZi5uYW1lID09PSBmMi5uYW1lKTtcbiAgICAgICAgICAgIHJldHVybiB+aSA/IChjdXJGaWVsZHNbaV0gPSBmMi5jbG9uZSh7XG4gICAgICAgICAgICAgICAgbWV0YWRhdGE6IG1lcmdlTWFwcyhtZXJnZU1hcHMobmV3IE1hcCgpLCBjdXJGaWVsZHNbaV0ubWV0YWRhdGEpLCBmMi5tZXRhZGF0YSlcbiAgICAgICAgICAgIH0pKSAmJiBmYWxzZSA6IHRydWU7XG4gICAgICAgIH0pIGFzIEZpZWxkW107XG5cbiAgICAgICAgY29uc3QgeyBkaWN0aW9uYXJpZXMsIGRpY3Rpb25hcnlGaWVsZHMgfSA9IGdlbmVyYXRlRGljdGlvbmFyeU1hcChuZXdGaWVsZHMsIG5ldyBNYXAoKSwgbmV3IE1hcCgpKTtcbiAgICAgICAgY29uc3QgbmV3RGljdGlvbmFyaWVzID0gWy4uLmRpY3Rpb25hcmllc10uZmlsdGVyKChbeV0pID0+ICFjdXJEaWN0aW9uYXJpZXMuZXZlcnkoKFt4XSkgPT4geCA9PT0geSkpO1xuICAgICAgICBjb25zdCBuZXdEaWN0aW9uYXJ5RmllbGRzID0gWy4uLmRpY3Rpb25hcnlGaWVsZHNdLm1hcCgoW2lkLCBuZXdEaWN0RmllbGRzXSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFtpZCwgWy4uLihjdXJEaWN0aW9uYXJ5RmllbGRzLmdldChpZCkgfHwgW10pLCAuLi5uZXdEaWN0RmllbGRzLm1hcCgoZikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGkgPSBuZXdGaWVsZHMuZmluZEluZGV4KChmMikgPT4gZi5uYW1lID09PSBmMi5uYW1lKTtcbiAgICAgICAgICAgICAgICBjb25zdCB7IGRpY3Rpb25hcnksIGluZGljZXMsIGlzT3JkZXJlZCwgZGljdGlvbmFyeVZlY3RvciB9ID0gZi50eXBlO1xuICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBuZXcgRGljdGlvbmFyeShkaWN0aW9uYXJ5LCBpbmRpY2VzLCBpZCwgaXNPcmRlcmVkLCBkaWN0aW9uYXJ5VmVjdG9yKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3RmllbGRzW2ldID0gZi5jbG9uZSh7IHR5cGUgfSk7XG4gICAgICAgICAgICB9KV1dIGFzIFtudW1iZXIsIEZpZWxkPERpY3Rpb25hcnk+W11dO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbmV3IFNjaGVtYTxUICYgUj4oXG4gICAgICAgICAgICBbLi4uY3VyRmllbGRzLCAuLi5uZXdGaWVsZHNdLCBtZXRhZGF0YSxcbiAgICAgICAgICAgIG5ldyBNYXAoWy4uLmN1ckRpY3Rpb25hcmllcywgLi4ubmV3RGljdGlvbmFyaWVzXSksXG4gICAgICAgICAgICBuZXcgTWFwKFsuLi5jdXJEaWN0aW9uYXJ5RmllbGRzLCAuLi5uZXdEaWN0aW9uYXJ5RmllbGRzXSlcbiAgICAgICAgKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBGaWVsZDxUIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+IHtcblxuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4ocHJvcHM6IHsgbmFtZTogc3RyaW5nIHwgbnVtYmVyLCB0eXBlOiBULCBudWxsYWJsZT86IGJvb2xlYW4sIG1ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPiB8IG51bGwgfSk6IEZpZWxkPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4obmFtZTogc3RyaW5nIHwgbnVtYmVyIHwgRmllbGQ8VD4sIHR5cGU6IFQsIG51bGxhYmxlPzogYm9vbGVhbiwgbWV0YWRhdGE/OiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCk6IEZpZWxkPFQ+O1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4oLi4uYXJnczogYW55W10pIHtcbiAgICAgICAgbGV0IFtuYW1lLCB0eXBlLCBudWxsYWJsZSwgbWV0YWRhdGFdID0gYXJncztcbiAgICAgICAgaWYgKGFyZ3NbMF0gJiYgdHlwZW9mIGFyZ3NbMF0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAoeyBuYW1lIH0gPSBhcmdzWzBdKTtcbiAgICAgICAgICAgICh0eXBlID09PSB1bmRlZmluZWQpICYmICh0eXBlID0gYXJnc1swXS50eXBlKTtcbiAgICAgICAgICAgIChudWxsYWJsZSA9PT0gdW5kZWZpbmVkKSAmJiAobnVsbGFibGUgPSBhcmdzWzBdLm51bGxhYmxlKTtcbiAgICAgICAgICAgIChtZXRhZGF0YSA9PT0gdW5kZWZpbmVkKSAmJiAobWV0YWRhdGEgPSBhcmdzWzBdLm1ldGFkYXRhKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IEZpZWxkPFQ+KGAke25hbWV9YCwgdHlwZSwgbnVsbGFibGUsIG1ldGFkYXRhKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgdHlwZTogVDtcbiAgICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICAgIHB1YmxpYyByZWFkb25seSBudWxsYWJsZTogYm9vbGVhbjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgbWV0YWRhdGE6IE1hcDxzdHJpbmcsIHN0cmluZz47XG5cbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIHR5cGU6IFQsIG51bGxhYmxlID0gZmFsc2UsIG1ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPiB8IG51bGwpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5udWxsYWJsZSA9IG51bGxhYmxlO1xuICAgICAgICB0aGlzLm1ldGFkYXRhID0gbWV0YWRhdGEgfHwgbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgdHlwZUlkKCkgeyByZXR1cm4gdGhpcy50eXBlLnR5cGVJZDsgfVxuICAgIHB1YmxpYyBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKSB7IHJldHVybiAnRmllbGQnOyB9XG4gICAgcHVibGljIHRvU3RyaW5nKCkgeyByZXR1cm4gYCR7dGhpcy5uYW1lfTogJHt0aGlzLnR5cGV9YDsgfVxuICAgIHB1YmxpYyBjb21wYXJlVG8ob3RoZXI/OiBGaWVsZCB8IG51bGwpOiBvdGhlciBpcyBGaWVsZDxUPiB7XG4gICAgICAgIHJldHVybiBjb21wYXJlci5jb21wYXJlRmllbGQodGhpcywgb3RoZXIpO1xuICAgIH1cbiAgICBwdWJsaWMgY2xvbmU8UiBleHRlbmRzIERhdGFUeXBlID0gVD4ocHJvcHM6IHsgbmFtZT86IHN0cmluZyB8IG51bWJlciwgdHlwZT86IFIsIG51bGxhYmxlPzogYm9vbGVhbiwgbWV0YWRhdGE/OiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCB9KTogRmllbGQ8Uj47XG4gICAgcHVibGljIGNsb25lPFIgZXh0ZW5kcyBEYXRhVHlwZSA9IFQ+KG5hbWU/OiBzdHJpbmcgfCBudW1iZXIgfCBGaWVsZDxUPiwgdHlwZT86IFIsIG51bGxhYmxlPzogYm9vbGVhbiwgbWV0YWRhdGE/OiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgbnVsbCk6IEZpZWxkPFI+O1xuICAgIHB1YmxpYyBjbG9uZTxSIGV4dGVuZHMgRGF0YVR5cGUgPSBUPiguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICBsZXQgW25hbWUsIHR5cGUsIG51bGxhYmxlLCBtZXRhZGF0YV0gPSBhcmdzO1xuICAgICAgICAoIWFyZ3NbMF0gfHwgdHlwZW9mIGFyZ3NbMF0gIT09ICdvYmplY3QnKVxuICAgICAgICAgICAgPyAoW25hbWUgPSB0aGlzLm5hbWUsIHR5cGUgPSB0aGlzLnR5cGUsIG51bGxhYmxlID0gdGhpcy5udWxsYWJsZSwgbWV0YWRhdGEgPSB0aGlzLm1ldGFkYXRhXSA9IGFyZ3MpXG4gICAgICAgICAgICA6ICh7bmFtZSA9IHRoaXMubmFtZSwgdHlwZSA9IHRoaXMudHlwZSwgbnVsbGFibGUgPSB0aGlzLm51bGxhYmxlLCBtZXRhZGF0YSA9IHRoaXMubWV0YWRhdGF9ID0gYXJnc1swXSk7XG4gICAgICAgIHJldHVybiBGaWVsZC5uZXc8Uj4obmFtZSwgdHlwZSwgbnVsbGFibGUsIG1ldGFkYXRhKTtcbiAgICB9XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiBtZXJnZU1hcHM8VEtleSwgVFZhbD4obTE/OiBNYXA8VEtleSwgVFZhbD4gfCBudWxsLCBtMj86IE1hcDxUS2V5LCBUVmFsPiB8IG51bGwpOiBNYXA8VEtleSwgVFZhbD4ge1xuICAgIHJldHVybiBuZXcgTWFwKFsuLi4obTEgfHwgbmV3IE1hcCgpKSwgLi4uKG0yIHx8IG5ldyBNYXAoKSldKTtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uIGdlbmVyYXRlRGljdGlvbmFyeU1hcChmaWVsZHM6IEZpZWxkW10sIGRpY3Rpb25hcmllczogTWFwPG51bWJlciwgRGF0YVR5cGU+LCBkaWN0aW9uYXJ5RmllbGRzOiBNYXA8bnVtYmVyLCBGaWVsZDxEaWN0aW9uYXJ5PltdPikge1xuXG4gICAgZm9yIChsZXQgaSA9IC0xLCBuID0gZmllbGRzLmxlbmd0aDsgKytpIDwgbjspIHtcbiAgICAgICAgY29uc3QgZmllbGQgPSBmaWVsZHNbaV07XG4gICAgICAgIGNvbnN0IHR5cGUgPSBmaWVsZC50eXBlO1xuICAgICAgICBpZiAoRGF0YVR5cGUuaXNEaWN0aW9uYXJ5KHR5cGUpKSB7XG4gICAgICAgICAgICBpZiAoIWRpY3Rpb25hcnlGaWVsZHMuZ2V0KHR5cGUuaWQpKSB7XG4gICAgICAgICAgICAgICAgZGljdGlvbmFyeUZpZWxkcy5zZXQodHlwZS5pZCwgW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFkaWN0aW9uYXJpZXMuaGFzKHR5cGUuaWQpKSB7XG4gICAgICAgICAgICAgICAgZGljdGlvbmFyaWVzLnNldCh0eXBlLmlkLCB0eXBlLmRpY3Rpb25hcnkpO1xuICAgICAgICAgICAgICAgIGRpY3Rpb25hcnlGaWVsZHMuZ2V0KHR5cGUuaWQpIS5wdXNoKGZpZWxkIGFzIGFueSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGRpY3Rpb25hcmllcy5nZXQodHlwZS5pZCkgIT09IHR5cGUuZGljdGlvbmFyeSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNyZWF0ZSBTY2hlbWEgY29udGFpbmluZyB0d28gZGlmZmVyZW50IGRpY3Rpb25hcmllcyB3aXRoIHRoZSBzYW1lIElkYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGdlbmVyYXRlRGljdGlvbmFyeU1hcCh0eXBlLmNoaWxkcmVuLCBkaWN0aW9uYXJpZXMsIGRpY3Rpb25hcnlGaWVsZHMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgZGljdGlvbmFyaWVzLCBkaWN0aW9uYXJ5RmllbGRzIH07XG59XG5cbi8vIEFkZCB0aGVzZSBoZXJlIHNvIHRoZXkncmUgcGlja2VkIHVwIGJ5IHRoZSBleHRlcm5zIGNyZWF0b3Jcbi8vIGluIHRoZSBidWlsZCwgYW5kIGNsb3N1cmUtY29tcGlsZXIgZG9lc24ndCBtaW5pZnkgdGhlbSBhd2F5XG4oU2NoZW1hLnByb3RvdHlwZSBhcyBhbnkpLmZpZWxkcyA9IG51bGw7XG4oU2NoZW1hLnByb3RvdHlwZSBhcyBhbnkpLm1ldGFkYXRhID0gbnVsbDtcbihTY2hlbWEucHJvdG90eXBlIGFzIGFueSkuZGljdGlvbmFyaWVzID0gbnVsbDtcbihTY2hlbWEucHJvdG90eXBlIGFzIGFueSkuZGljdGlvbmFyeUZpZWxkcyA9IG51bGw7XG5cbihGaWVsZC5wcm90b3R5cGUgYXMgYW55KS50eXBlID0gbnVsbDtcbihGaWVsZC5wcm90b3R5cGUgYXMgYW55KS5uYW1lID0gbnVsbDtcbihGaWVsZC5wcm90b3R5cGUgYXMgYW55KS5udWxsYWJsZSA9IG51bGw7XG4oRmllbGQucHJvdG90eXBlIGFzIGFueSkubWV0YWRhdGEgPSBudWxsO1xuIl19
