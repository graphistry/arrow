"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const type_1 = require("./type");
class Schema {
    constructor(fields, metadata, dictionaries, dictionaryFields) {
        this._fields = fields || [];
        this._metadata = metadata || new Map();
        if (!dictionaries || !dictionaryFields) {
            ({ dictionaries, dictionaryFields } = generateDictionaryMap(fields, dictionaries || new Map(), dictionaryFields || new Map()));
        }
        this._dictionaries = dictionaries;
        this._dictionaryFields = dictionaryFields;
    }
    /** @nocollapse */
    static from(vectors, names = []) {
        return new Schema(vectors.map((v, i) => new Field('' + (names[i] || i), v.type)));
    }
    get fields() { return this._fields; }
    get metadata() { return this._metadata; }
    get dictionaries() { return this._dictionaries; }
    get dictionaryFields() { return this._dictionaryFields; }
    get [Symbol.toStringTag]() { return 'Schema'; }
    toString() {
        return `Schema<{ ${this._fields.map((f, i) => `${i}: ${f}`).join(', ')} }>`;
    }
    select(...columnNames) {
        const names = columnNames.reduce((xs, x) => (xs[x] = true) && xs, Object.create(null));
        return new Schema(this.fields.filter((f) => names[f.name]), this.metadata);
    }
}
exports.Schema = Schema;
class Field {
    constructor(name, type, nullable = false, metadata) {
        this._name = name;
        this._type = type;
        this._nullable = nullable;
        this._metadata = metadata || new Map();
    }
    get type() { return this._type; }
    get name() { return this._name; }
    get nullable() { return this._nullable; }
    get metadata() { return this._metadata; }
    get typeId() { return this._type.typeId; }
    get [Symbol.toStringTag]() { return 'Field'; }
    get indices() {
        return type_1.DataType.isDictionary(this._type) ? this._type.indices : this._type;
    }
    toString() { return `${this.name}: ${this.type}`; }
}
exports.Field = Field;
/** @ignore */
function generateDictionaryMap(fields, dictionaries, dictionaryFields) {
    for (let i = -1, n = fields.length; ++i < n;) {
        const field = fields[i];
        const type = field.type;
        if (type_1.DataType.isDictionary(type)) {
            if (!dictionaryFields.get(type.id)) {
                dictionaryFields.set(type.id, []);
            }
            if (!dictionaries.has(type.id)) {
                dictionaries.set(type.id, type.dictionary);
                dictionaryFields.get(type.id).push(field);
            }
            else if (dictionaries.get(type.id) !== type.dictionary) {
                throw new Error(`Cannot create Schema containing two different dictionaries with the same Id`);
            }
        }
        if (type.children) {
            generateDictionaryMap(type.children, dictionaries, dictionaryFields);
        }
    }
    return { dictionaries, dictionaryFields };
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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c2NoZW1hLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IERhdGFUeXBlLCBEaWN0aW9uYXJ5IH0gZnJvbSAnLi90eXBlJztcbmltcG9ydCB7IFZlY3RvciBhcyBWVHlwZSB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5cbmV4cG9ydCBjbGFzcyBTY2hlbWE8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4ge1xuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHZlY3RvcnM6IFZUeXBlPFRba2V5b2YgVF0+W10sIG5hbWVzOiAoa2V5b2YgVClbXSA9IFtdKSB7XG4gICAgICAgIHJldHVybiBuZXcgU2NoZW1hPFQ+KHZlY3RvcnMubWFwKCh2LCBpKSA9PiBuZXcgRmllbGQoJycgKyAobmFtZXNbaV0gfHwgaSksIHYudHlwZSkpKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX2ZpZWxkczogRmllbGRbXTtcbiAgICBwcm90ZWN0ZWQgX21ldGFkYXRhOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xuICAgIHByb3RlY3RlZCBfZGljdGlvbmFyaWVzOiBNYXA8bnVtYmVyLCBEYXRhVHlwZT47XG4gICAgcHJvdGVjdGVkIF9kaWN0aW9uYXJ5RmllbGRzOiBNYXA8bnVtYmVyLCBGaWVsZDxEaWN0aW9uYXJ5PltdPjtcbiAgICBwdWJsaWMgZ2V0IGZpZWxkcygpOiBGaWVsZFtdIHsgcmV0dXJuIHRoaXMuX2ZpZWxkczsgfVxuICAgIHB1YmxpYyBnZXQgbWV0YWRhdGEoKTogTWFwPHN0cmluZywgc3RyaW5nPiB7IHJldHVybiB0aGlzLl9tZXRhZGF0YTsgfVxuICAgIHB1YmxpYyBnZXQgZGljdGlvbmFyaWVzKCk6IE1hcDxudW1iZXIsIERhdGFUeXBlPiB7IHJldHVybiB0aGlzLl9kaWN0aW9uYXJpZXM7IH1cbiAgICBwdWJsaWMgZ2V0IGRpY3Rpb25hcnlGaWVsZHMoKTogTWFwPG51bWJlciwgRmllbGQ8RGljdGlvbmFyeT5bXT4geyByZXR1cm4gdGhpcy5fZGljdGlvbmFyeUZpZWxkczsgfVxuXG4gICAgY29uc3RydWN0b3IoZmllbGRzOiBGaWVsZFtdLFxuICAgICAgICAgICAgICAgIG1ldGFkYXRhPzogTWFwPHN0cmluZywgc3RyaW5nPixcbiAgICAgICAgICAgICAgICBkaWN0aW9uYXJpZXM/OiBNYXA8bnVtYmVyLCBEYXRhVHlwZT4sXG4gICAgICAgICAgICAgICAgZGljdGlvbmFyeUZpZWxkcz86IE1hcDxudW1iZXIsIEZpZWxkPERpY3Rpb25hcnk+W10+KSB7XG4gICAgICAgIHRoaXMuX2ZpZWxkcyA9IGZpZWxkcyB8fCBbXTtcbiAgICAgICAgdGhpcy5fbWV0YWRhdGEgPSBtZXRhZGF0YSB8fCBuZXcgTWFwKCk7XG4gICAgICAgIGlmICghZGljdGlvbmFyaWVzIHx8ICFkaWN0aW9uYXJ5RmllbGRzKSB7XG4gICAgICAgICAgICAoeyBkaWN0aW9uYXJpZXMsIGRpY3Rpb25hcnlGaWVsZHMgfSA9IGdlbmVyYXRlRGljdGlvbmFyeU1hcChcbiAgICAgICAgICAgICAgICBmaWVsZHMsIGRpY3Rpb25hcmllcyB8fCBuZXcgTWFwKCksIGRpY3Rpb25hcnlGaWVsZHMgfHwgbmV3IE1hcCgpXG4gICAgICAgICAgICApKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9kaWN0aW9uYXJpZXMgPSBkaWN0aW9uYXJpZXM7XG4gICAgICAgIHRoaXMuX2RpY3Rpb25hcnlGaWVsZHMgPSBkaWN0aW9uYXJ5RmllbGRzO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0IFtTeW1ib2wudG9TdHJpbmdUYWddKCkgeyByZXR1cm4gJ1NjaGVtYSc7IH1cbiAgICBwdWJsaWMgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBgU2NoZW1hPHsgJHt0aGlzLl9maWVsZHMubWFwKChmLCBpKSA9PiBgJHtpfTogJHtmfWApLmpvaW4oJywgJyl9IH0+YDtcbiAgICB9XG4gICAgcHVibGljIHNlbGVjdDxLIGV4dGVuZHMga2V5b2YgVCA9IGFueT4oLi4uY29sdW1uTmFtZXM6IEtbXSkge1xuICAgICAgICBjb25zdCBuYW1lcyA9IGNvbHVtbk5hbWVzLnJlZHVjZSgoeHMsIHgpID0+ICh4c1t4XSA9IHRydWUpICYmIHhzLCBPYmplY3QuY3JlYXRlKG51bGwpKTtcbiAgICAgICAgcmV0dXJuIG5ldyBTY2hlbWE8eyBbUCBpbiBLXTogVFtQXSB9Pih0aGlzLmZpZWxkcy5maWx0ZXIoKGYpID0+IG5hbWVzW2YubmFtZV0pLCB0aGlzLm1ldGFkYXRhKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBGaWVsZDxUIGV4dGVuZHMgRGF0YVR5cGUgPSBEYXRhVHlwZT4ge1xuICAgIHByb3RlY3RlZCBfdHlwZTogVDtcbiAgICBwcm90ZWN0ZWQgX25hbWU6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgX251bGxhYmxlOiB0cnVlIHwgZmFsc2U7XG4gICAgcHJvdGVjdGVkIF9tZXRhZGF0YT86IE1hcDxzdHJpbmcsIHN0cmluZz4gfCBudWxsO1xuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgdHlwZTogVCwgbnVsbGFibGU6IHRydWUgfCBmYWxzZSA9IGZhbHNlLCBtZXRhZGF0YT86IE1hcDxzdHJpbmcsIHN0cmluZz4gfCBudWxsKSB7XG4gICAgICAgIHRoaXMuX25hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLl90eXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5fbnVsbGFibGUgPSBudWxsYWJsZTtcbiAgICAgICAgdGhpcy5fbWV0YWRhdGEgPSBtZXRhZGF0YSB8fCBuZXcgTWFwKCk7XG4gICAgfVxuICAgIHB1YmxpYyBnZXQgdHlwZSgpIHsgcmV0dXJuIHRoaXMuX3R5cGU7IH1cbiAgICBwdWJsaWMgZ2V0IG5hbWUoKSB7IHJldHVybiB0aGlzLl9uYW1lOyB9XG4gICAgcHVibGljIGdldCBudWxsYWJsZSgpIHsgcmV0dXJuIHRoaXMuX251bGxhYmxlOyB9XG4gICAgcHVibGljIGdldCBtZXRhZGF0YSgpIHsgcmV0dXJuIHRoaXMuX21ldGFkYXRhOyB9XG4gICAgcHVibGljIGdldCB0eXBlSWQoKSB7IHJldHVybiB0aGlzLl90eXBlLnR5cGVJZDsgfVxuICAgIHB1YmxpYyBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKSB7IHJldHVybiAnRmllbGQnOyB9XG4gICAgcHVibGljIGdldCBpbmRpY2VzKCkge1xuICAgICAgICByZXR1cm4gRGF0YVR5cGUuaXNEaWN0aW9uYXJ5KHRoaXMuX3R5cGUpID8gdGhpcy5fdHlwZS5pbmRpY2VzIDogdGhpcy5fdHlwZTtcbiAgICB9XG4gICAgcHVibGljIHRvU3RyaW5nKCkgeyByZXR1cm4gYCR7dGhpcy5uYW1lfTogJHt0aGlzLnR5cGV9YDsgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVEaWN0aW9uYXJ5TWFwKGZpZWxkczogRmllbGRbXSwgZGljdGlvbmFyaWVzOiBNYXA8bnVtYmVyLCBEYXRhVHlwZT4sIGRpY3Rpb25hcnlGaWVsZHM6IE1hcDxudW1iZXIsIEZpZWxkPERpY3Rpb25hcnk+W10+KSB7XG5cbiAgICBmb3IgKGxldCBpID0gLTEsIG4gPSBmaWVsZHMubGVuZ3RoOyArK2kgPCBuOykge1xuICAgICAgICBjb25zdCBmaWVsZCA9IGZpZWxkc1tpXTtcbiAgICAgICAgY29uc3QgdHlwZSA9IGZpZWxkLnR5cGU7XG4gICAgICAgIGlmIChEYXRhVHlwZS5pc0RpY3Rpb25hcnkodHlwZSkpIHtcbiAgICAgICAgICAgIGlmICghZGljdGlvbmFyeUZpZWxkcy5nZXQodHlwZS5pZCkpIHtcbiAgICAgICAgICAgICAgICBkaWN0aW9uYXJ5RmllbGRzLnNldCh0eXBlLmlkLCBbXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWRpY3Rpb25hcmllcy5oYXModHlwZS5pZCkpIHtcbiAgICAgICAgICAgICAgICBkaWN0aW9uYXJpZXMuc2V0KHR5cGUuaWQsIHR5cGUuZGljdGlvbmFyeSk7XG4gICAgICAgICAgICAgICAgZGljdGlvbmFyeUZpZWxkcy5nZXQodHlwZS5pZCkhLnB1c2goZmllbGQgYXMgYW55KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGljdGlvbmFyaWVzLmdldCh0eXBlLmlkKSAhPT0gdHlwZS5kaWN0aW9uYXJ5KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY3JlYXRlIFNjaGVtYSBjb250YWluaW5nIHR3byBkaWZmZXJlbnQgZGljdGlvbmFyaWVzIHdpdGggdGhlIHNhbWUgSWRgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZS5jaGlsZHJlbikge1xuICAgICAgICAgICAgZ2VuZXJhdGVEaWN0aW9uYXJ5TWFwKHR5cGUuY2hpbGRyZW4sIGRpY3Rpb25hcmllcywgZGljdGlvbmFyeUZpZWxkcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBkaWN0aW9uYXJpZXMsIGRpY3Rpb25hcnlGaWVsZHMgfTtcbn1cbiJdfQ==
