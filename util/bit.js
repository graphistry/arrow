"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @ignore
 */
function getBool(_data, _index, byte, bit) {
    return (byte & 1 << bit) !== 0;
}
exports.getBool = getBool;
/**
 * @ignore
 */
function getBit(_data, _index, byte, bit) {
    return (byte & 1 << bit) >> bit;
}
exports.getBit = getBit;
/**
 * @ignore
 */
function setBool(bytes, index, value) {
    return value ?
        !!(bytes[index >> 3] |= (1 << (index % 8))) || true :
        !(bytes[index >> 3] &= ~(1 << (index % 8))) && false;
}
exports.setBool = setBool;
/**
 * @ignore
 */
function truncateBitmap(offset, length, bitmap) {
    const alignedSize = (bitmap.byteLength + 7) & ~7;
    if (offset > 0 || bitmap.byteLength < alignedSize) {
        const bytes = new Uint8Array(alignedSize);
        bytes.set((offset % 8 === 0)
            // If the offset is a multiple of 8 bits, it's safe to slice the bitmap
            ? bitmap.subarray(offset >> 3)
            // Otherwise iterate each bit from the offset and return a new one
            : packBools(iterateBits(bitmap, offset, length, null, getBool)));
        return bytes;
    }
    return bitmap;
}
exports.truncateBitmap = truncateBitmap;
/**
 * @ignore
 */
function packBools(values) {
    let n = 0, i = 0;
    let xs = [];
    let bit = 0, byte = 0;
    for (const value of values) {
        value && (byte |= 1 << bit);
        if (++bit === 8) {
            xs[i++] = byte;
            byte = bit = 0;
        }
    }
    if (i === 0 || bit > 0) {
        xs[i++] = byte;
    }
    if (i % 8 && (n = i + 8 - i % 8)) {
        do {
            xs[i] = 0;
        } while (++i < n);
    }
    return new Uint8Array(xs);
}
exports.packBools = packBools;
/**
 * @ignore
 */
function* iterateBits(bytes, begin, length, context, get) {
    let bit = begin % 8;
    let byteIndex = begin >> 3;
    let index = 0, remaining = length;
    for (; remaining > 0; bit = 0) {
        let byte = bytes[byteIndex++];
        do {
            yield get(context, index++, byte, bit);
        } while (--remaining > 0 && ++bit < 8);
    }
}
exports.iterateBits = iterateBits;
/**
 * Compute the population count (the number of bits set to 1) for a range of bits in a Uint8Array.
 * @param vector The Uint8Array of bits for which to compute the population count.
 * @param lhs The range's left-hand side (or start) bit
 * @param rhs The range's right-hand side (or end) bit
 */
/**
 * @ignore
 */
function popcnt_bit_range(data, lhs, rhs) {
    if (rhs - lhs <= 0) {
        return 0;
    }
    // If the bit range is less than one byte, sum the 1 bits in the bit range
    if (rhs - lhs < 8) {
        let sum = 0;
        for (const bit of iterateBits(data, lhs, rhs - lhs, data, getBit)) {
            sum += bit;
        }
        return sum;
    }
    // Get the next lowest multiple of 8 from the right hand side
    const rhsInside = rhs >> 3 << 3;
    // Get the next highest multiple of 8 from the left hand side
    const lhsInside = lhs + (lhs % 8 === 0 ? 0 : 8 - lhs % 8);
    return (
    // Get the popcnt of bits between the left hand side, and the next highest multiple of 8
    popcnt_bit_range(data, lhs, lhsInside) +
        // Get the popcnt of bits between the right hand side, and the next lowest multiple of 8
        popcnt_bit_range(data, rhsInside, rhs) +
        // Get the popcnt of all bits between the left and right hand sides' multiples of 8
        popcnt_array(data, lhsInside >> 3, (rhsInside - lhsInside) >> 3));
}
exports.popcnt_bit_range = popcnt_bit_range;
/**
 * @ignore
 */
function popcnt_array(arr, byteOffset, byteLength) {
    let cnt = 0, pos = byteOffset | 0;
    const view = new DataView(arr.buffer, arr.byteOffset, arr.byteLength);
    const len = byteLength === void 0 ? arr.byteLength : pos + byteLength;
    while (len - pos >= 4) {
        cnt += popcnt_uint32(view.getUint32(pos));
        pos += 4;
    }
    while (len - pos >= 2) {
        cnt += popcnt_uint32(view.getUint16(pos));
        pos += 2;
    }
    while (len - pos >= 1) {
        cnt += popcnt_uint32(view.getUint8(pos));
        pos += 1;
    }
    return cnt;
}
exports.popcnt_array = popcnt_array;
/**
 * @ignore
 */
function popcnt_uint32(uint32) {
    let i = uint32 | 0;
    i = i - ((i >>> 1) & 0x55555555);
    i = (i & 0x33333333) + ((i >>> 2) & 0x33333333);
    return (((i + (i >>> 4)) & 0x0F0F0F0F) * 0x01010101) >>> 24;
}
exports.popcnt_uint32 = popcnt_uint32;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWwvYml0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw2REFBNkQ7QUFDN0QsK0RBQStEO0FBQy9ELHdEQUF3RDtBQUN4RCw2REFBNkQ7QUFDN0Qsb0RBQW9EO0FBQ3BELDZEQUE2RDtBQUM3RCw2REFBNkQ7QUFDN0QsRUFBRTtBQUNGLCtDQUErQztBQUMvQyxFQUFFO0FBQ0YsNkRBQTZEO0FBQzdELDhEQUE4RDtBQUM5RCx5REFBeUQ7QUFDekQsNERBQTREO0FBQzVELDBEQUEwRDtBQUMxRCxxQkFBcUI7O0FBRXJCOztHQUVHO0FBQ0gsU0FBZ0IsT0FBTyxDQUFDLEtBQVUsRUFBRSxNQUFjLEVBQUUsSUFBWSxFQUFFLEdBQVc7SUFDekUsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ25DLENBQUM7QUFGRCwwQkFFQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IsTUFBTSxDQUFDLEtBQVUsRUFBRSxNQUFjLEVBQUUsSUFBWSxFQUFFLEdBQVc7SUFDeEUsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksR0FBYyxDQUFDO0FBQy9DLENBQUM7QUFGRCx3QkFFQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IsT0FBTyxDQUFDLEtBQWlCLEVBQUUsS0FBYSxFQUFFLEtBQVU7SUFDaEUsT0FBTyxLQUFLLENBQUMsQ0FBQztRQUNWLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLElBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDO1FBQ3RELENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBRTtBQUM5RCxDQUFDO0FBSkQsMEJBSUM7QUFFRDs7R0FFRztBQUNILFNBQWdCLGNBQWMsQ0FBQyxNQUFjLEVBQUUsTUFBYyxFQUFFLE1BQWtCO0lBQzdFLE1BQU0sV0FBVyxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNqRCxJQUFJLE1BQU0sR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLFVBQVUsR0FBRyxXQUFXLEVBQUU7UUFDL0MsTUFBTSxLQUFLLEdBQUcsSUFBSSxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDMUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hCLHVFQUF1RTtZQUN2RSxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDO1lBQzlCLGtFQUFrRTtZQUNsRSxDQUFDLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sS0FBSyxDQUFDO0tBQ2hCO0lBQ0QsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQztBQVpELHdDQVlDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQixTQUFTLENBQUMsTUFBcUI7SUFDM0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakIsSUFBSSxFQUFFLEdBQWEsRUFBRSxDQUFDO0lBQ3RCLElBQUksR0FBRyxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1FBQ3hCLEtBQUssSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7UUFDNUIsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUU7WUFDYixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDZixJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztTQUNsQjtLQUNKO0lBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7UUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7S0FBRTtJQUMzQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7UUFDOUIsR0FBRztZQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7U0FBRSxRQUFRLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRTtLQUNyQztJQUNELE9BQU8sSUFBSSxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDOUIsQ0FBQztBQWhCRCw4QkFnQkM7QUFFRDs7R0FFRztBQUNILFFBQWUsQ0FBQyxDQUFDLFdBQVcsQ0FBSSxLQUFpQixFQUFFLEtBQWEsRUFBRSxNQUFjLEVBQUUsT0FBWSxFQUM5RCxHQUFrRTtJQUM5RixJQUFJLEdBQUcsR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ3BCLElBQUksU0FBUyxHQUFHLEtBQUssSUFBSSxDQUFDLENBQUM7SUFDM0IsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLFNBQVMsR0FBRyxNQUFNLENBQUM7SUFDbEMsT0FBTyxTQUFTLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLEVBQUU7UUFDM0IsSUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDOUIsR0FBRztZQUNDLE1BQU0sR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDMUMsUUFBUSxFQUFFLFNBQVMsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLEdBQUcsQ0FBQyxFQUFFO0tBQzFDO0FBQ0wsQ0FBQztBQVhELGtDQVdDO0FBRUQ7Ozs7O0dBS0c7QUFDSDs7R0FFRztBQUNILFNBQWdCLGdCQUFnQixDQUFDLElBQWdCLEVBQUUsR0FBVyxFQUFFLEdBQVc7SUFDdkUsSUFBSSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRTtRQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQUU7SUFDakMsMEVBQTBFO0lBQzFFLElBQUksR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLEVBQUU7UUFDZixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDWixLQUFLLE1BQU0sR0FBRyxJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsR0FBRyxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQy9ELEdBQUcsSUFBSSxHQUFHLENBQUM7U0FDZDtRQUNELE9BQU8sR0FBRyxDQUFDO0tBQ2Q7SUFDRCw2REFBNkQ7SUFDN0QsTUFBTSxTQUFTLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEMsNkRBQTZEO0lBQzdELE1BQU0sU0FBUyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDMUQsT0FBTztJQUNILHdGQUF3RjtJQUN4RixnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLFNBQVMsQ0FBQztRQUN0Qyx3RkFBd0Y7UUFDeEYsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxHQUFHLENBQUM7UUFDdEMsbUZBQW1GO1FBQ25GLFlBQVksQ0FBQyxJQUFJLEVBQUUsU0FBUyxJQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FDbkUsQ0FBQztBQUNOLENBQUM7QUF0QkQsNENBc0JDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQixZQUFZLENBQUMsR0FBb0IsRUFBRSxVQUFtQixFQUFFLFVBQW1CO0lBQ3ZGLElBQUksR0FBRyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsVUFBVyxHQUFHLENBQUMsQ0FBQztJQUNuQyxNQUFNLElBQUksR0FBRyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3RFLE1BQU0sR0FBRyxHQUFJLFVBQVUsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQztJQUN2RSxPQUFPLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFO1FBQ25CLEdBQUcsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzFDLEdBQUcsSUFBSSxDQUFDLENBQUM7S0FDWjtJQUNELE9BQU8sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUU7UUFDbkIsR0FBRyxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDMUMsR0FBRyxJQUFJLENBQUMsQ0FBQztLQUNaO0lBQ0QsT0FBTyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRTtRQUNuQixHQUFHLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN6QyxHQUFHLElBQUksQ0FBQyxDQUFDO0tBQ1o7SUFDRCxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUM7QUFqQkQsb0NBaUJDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQixhQUFhLENBQUMsTUFBYztJQUN4QyxJQUFJLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ25CLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUMsQ0FBQztJQUNqQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUMsQ0FBQztJQUNoRCxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUNoRSxDQUFDO0FBTEQsc0NBS0MiLCJmaWxlIjoidXRpbC9iaXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRCb29sKF9kYXRhOiBhbnksIF9pbmRleDogbnVtYmVyLCBieXRlOiBudW1iZXIsIGJpdDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIChieXRlICYgMSA8PCBiaXQpICE9PSAwO1xufVxuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEJpdChfZGF0YTogYW55LCBfaW5kZXg6IG51bWJlciwgYnl0ZTogbnVtYmVyLCBiaXQ6IG51bWJlcik6IDAgfCAxIHtcbiAgICByZXR1cm4gKGJ5dGUgJiAxIDw8IGJpdCkgPj4gYml0IGFzICgwIHwgMSk7XG59XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0Qm9vbChieXRlczogVWludDhBcnJheSwgaW5kZXg6IG51bWJlciwgdmFsdWU6IGFueSkge1xuICAgIHJldHVybiB2YWx1ZSA/XG4gICAgICAgICEhKGJ5dGVzW2luZGV4ID4+IDNdIHw9ICAoMSA8PCAoaW5kZXggJSA4KSkpIHx8IHRydWUgOlxuICAgICAgICAhKGJ5dGVzW2luZGV4ID4+IDNdICY9IH4oMSA8PCAoaW5kZXggJSA4KSkpICYmIGZhbHNlIDtcbn1cblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0cnVuY2F0ZUJpdG1hcChvZmZzZXQ6IG51bWJlciwgbGVuZ3RoOiBudW1iZXIsIGJpdG1hcDogVWludDhBcnJheSkge1xuICAgIGNvbnN0IGFsaWduZWRTaXplID0gKGJpdG1hcC5ieXRlTGVuZ3RoICsgNykgJiB+NztcbiAgICBpZiAob2Zmc2V0ID4gMCB8fCBiaXRtYXAuYnl0ZUxlbmd0aCA8IGFsaWduZWRTaXplKSB7XG4gICAgICAgIGNvbnN0IGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoYWxpZ25lZFNpemUpO1xuICAgICAgICBieXRlcy5zZXQoKG9mZnNldCAlIDggPT09IDApXG4gICAgICAgICAgICAvLyBJZiB0aGUgb2Zmc2V0IGlzIGEgbXVsdGlwbGUgb2YgOCBiaXRzLCBpdCdzIHNhZmUgdG8gc2xpY2UgdGhlIGJpdG1hcFxuICAgICAgICAgICAgPyBiaXRtYXAuc3ViYXJyYXkob2Zmc2V0ID4+IDMpXG4gICAgICAgICAgICAvLyBPdGhlcndpc2UgaXRlcmF0ZSBlYWNoIGJpdCBmcm9tIHRoZSBvZmZzZXQgYW5kIHJldHVybiBhIG5ldyBvbmVcbiAgICAgICAgICAgIDogcGFja0Jvb2xzKGl0ZXJhdGVCaXRzKGJpdG1hcCwgb2Zmc2V0LCBsZW5ndGgsIG51bGwsIGdldEJvb2wpKSk7XG4gICAgICAgIHJldHVybiBieXRlcztcbiAgICB9XG4gICAgcmV0dXJuIGJpdG1hcDtcbn1cblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYWNrQm9vbHModmFsdWVzOiBJdGVyYWJsZTxhbnk+KSB7XG4gICAgbGV0IG4gPSAwLCBpID0gMDtcbiAgICBsZXQgeHM6IG51bWJlcltdID0gW107XG4gICAgbGV0IGJpdCA9IDAsIGJ5dGUgPSAwO1xuICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7XG4gICAgICAgIHZhbHVlICYmIChieXRlIHw9IDEgPDwgYml0KTtcbiAgICAgICAgaWYgKCsrYml0ID09PSA4KSB7XG4gICAgICAgICAgICB4c1tpKytdID0gYnl0ZTtcbiAgICAgICAgICAgIGJ5dGUgPSBiaXQgPSAwO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChpID09PSAwIHx8IGJpdCA+IDApIHsgeHNbaSsrXSA9IGJ5dGU7IH1cbiAgICBpZiAoaSAlIDggJiYgKG4gPSBpICsgOCAtIGkgJSA4KSkge1xuICAgICAgICBkbyB7IHhzW2ldID0gMDsgfSB3aGlsZSAoKytpIDwgbik7XG4gICAgfVxuICAgIHJldHVybiBuZXcgVWludDhBcnJheSh4cyk7XG59XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5leHBvcnQgZnVuY3Rpb24qIGl0ZXJhdGVCaXRzPFQ+KGJ5dGVzOiBVaW50OEFycmF5LCBiZWdpbjogbnVtYmVyLCBsZW5ndGg6IG51bWJlciwgY29udGV4dDogYW55LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IChjb250ZXh0OiBhbnksIGluZGV4OiBudW1iZXIsIGJ5dGU6IG51bWJlciwgYml0OiBudW1iZXIpID0+IFQpIHtcbiAgICBsZXQgYml0ID0gYmVnaW4gJSA4O1xuICAgIGxldCBieXRlSW5kZXggPSBiZWdpbiA+PiAzO1xuICAgIGxldCBpbmRleCA9IDAsIHJlbWFpbmluZyA9IGxlbmd0aDtcbiAgICBmb3IgKDsgcmVtYWluaW5nID4gMDsgYml0ID0gMCkge1xuICAgICAgICBsZXQgYnl0ZSA9IGJ5dGVzW2J5dGVJbmRleCsrXTtcbiAgICAgICAgZG8ge1xuICAgICAgICAgICAgeWllbGQgZ2V0KGNvbnRleHQsIGluZGV4KyssIGJ5dGUsIGJpdCk7XG4gICAgICAgIH0gd2hpbGUgKC0tcmVtYWluaW5nID4gMCAmJiArK2JpdCA8IDgpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBDb21wdXRlIHRoZSBwb3B1bGF0aW9uIGNvdW50ICh0aGUgbnVtYmVyIG9mIGJpdHMgc2V0IHRvIDEpIGZvciBhIHJhbmdlIG9mIGJpdHMgaW4gYSBVaW50OEFycmF5LlxuICogQHBhcmFtIHZlY3RvciBUaGUgVWludDhBcnJheSBvZiBiaXRzIGZvciB3aGljaCB0byBjb21wdXRlIHRoZSBwb3B1bGF0aW9uIGNvdW50LlxuICogQHBhcmFtIGxocyBUaGUgcmFuZ2UncyBsZWZ0LWhhbmQgc2lkZSAob3Igc3RhcnQpIGJpdFxuICogQHBhcmFtIHJocyBUaGUgcmFuZ2UncyByaWdodC1oYW5kIHNpZGUgKG9yIGVuZCkgYml0XG4gKi9cbi8qKlxuICogQGlnbm9yZVxuICovXG5leHBvcnQgZnVuY3Rpb24gcG9wY250X2JpdF9yYW5nZShkYXRhOiBVaW50OEFycmF5LCBsaHM6IG51bWJlciwgcmhzOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGlmIChyaHMgLSBsaHMgPD0gMCkgeyByZXR1cm4gMDsgfVxuICAgIC8vIElmIHRoZSBiaXQgcmFuZ2UgaXMgbGVzcyB0aGFuIG9uZSBieXRlLCBzdW0gdGhlIDEgYml0cyBpbiB0aGUgYml0IHJhbmdlXG4gICAgaWYgKHJocyAtIGxocyA8IDgpIHtcbiAgICAgICAgbGV0IHN1bSA9IDA7XG4gICAgICAgIGZvciAoY29uc3QgYml0IG9mIGl0ZXJhdGVCaXRzKGRhdGEsIGxocywgcmhzIC0gbGhzLCBkYXRhLCBnZXRCaXQpKSB7XG4gICAgICAgICAgICBzdW0gKz0gYml0O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdW07XG4gICAgfVxuICAgIC8vIEdldCB0aGUgbmV4dCBsb3dlc3QgbXVsdGlwbGUgb2YgOCBmcm9tIHRoZSByaWdodCBoYW5kIHNpZGVcbiAgICBjb25zdCByaHNJbnNpZGUgPSByaHMgPj4gMyA8PCAzO1xuICAgIC8vIEdldCB0aGUgbmV4dCBoaWdoZXN0IG11bHRpcGxlIG9mIDggZnJvbSB0aGUgbGVmdCBoYW5kIHNpZGVcbiAgICBjb25zdCBsaHNJbnNpZGUgPSBsaHMgKyAobGhzICUgOCA9PT0gMCA/IDAgOiA4IC0gbGhzICUgOCk7XG4gICAgcmV0dXJuIChcbiAgICAgICAgLy8gR2V0IHRoZSBwb3BjbnQgb2YgYml0cyBiZXR3ZWVuIHRoZSBsZWZ0IGhhbmQgc2lkZSwgYW5kIHRoZSBuZXh0IGhpZ2hlc3QgbXVsdGlwbGUgb2YgOFxuICAgICAgICBwb3BjbnRfYml0X3JhbmdlKGRhdGEsIGxocywgbGhzSW5zaWRlKSArXG4gICAgICAgIC8vIEdldCB0aGUgcG9wY250IG9mIGJpdHMgYmV0d2VlbiB0aGUgcmlnaHQgaGFuZCBzaWRlLCBhbmQgdGhlIG5leHQgbG93ZXN0IG11bHRpcGxlIG9mIDhcbiAgICAgICAgcG9wY250X2JpdF9yYW5nZShkYXRhLCByaHNJbnNpZGUsIHJocykgK1xuICAgICAgICAvLyBHZXQgdGhlIHBvcGNudCBvZiBhbGwgYml0cyBiZXR3ZWVuIHRoZSBsZWZ0IGFuZCByaWdodCBoYW5kIHNpZGVzJyBtdWx0aXBsZXMgb2YgOFxuICAgICAgICBwb3BjbnRfYXJyYXkoZGF0YSwgbGhzSW5zaWRlID4+IDMsIChyaHNJbnNpZGUgLSBsaHNJbnNpZGUpID4+IDMpXG4gICAgKTtcbn1cblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwb3BjbnRfYXJyYXkoYXJyOiBBcnJheUJ1ZmZlclZpZXcsIGJ5dGVPZmZzZXQ/OiBudW1iZXIsIGJ5dGVMZW5ndGg/OiBudW1iZXIpIHtcbiAgICBsZXQgY250ID0gMCwgcG9zID0gYnl0ZU9mZnNldCEgfCAwO1xuICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYXJyLmJ1ZmZlciwgYXJyLmJ5dGVPZmZzZXQsIGFyci5ieXRlTGVuZ3RoKTtcbiAgICBjb25zdCBsZW4gPSAgYnl0ZUxlbmd0aCA9PT0gdm9pZCAwID8gYXJyLmJ5dGVMZW5ndGggOiBwb3MgKyBieXRlTGVuZ3RoO1xuICAgIHdoaWxlIChsZW4gLSBwb3MgPj0gNCkge1xuICAgICAgICBjbnQgKz0gcG9wY250X3VpbnQzMih2aWV3LmdldFVpbnQzMihwb3MpKTtcbiAgICAgICAgcG9zICs9IDQ7XG4gICAgfVxuICAgIHdoaWxlIChsZW4gLSBwb3MgPj0gMikge1xuICAgICAgICBjbnQgKz0gcG9wY250X3VpbnQzMih2aWV3LmdldFVpbnQxNihwb3MpKTtcbiAgICAgICAgcG9zICs9IDI7XG4gICAgfVxuICAgIHdoaWxlIChsZW4gLSBwb3MgPj0gMSkge1xuICAgICAgICBjbnQgKz0gcG9wY250X3VpbnQzMih2aWV3LmdldFVpbnQ4KHBvcykpO1xuICAgICAgICBwb3MgKz0gMTtcbiAgICB9XG4gICAgcmV0dXJuIGNudDtcbn1cblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwb3BjbnRfdWludDMyKHVpbnQzMjogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBsZXQgaSA9IHVpbnQzMiB8IDA7XG4gICAgaSA9IGkgLSAoKGkgPj4+IDEpICYgMHg1NTU1NTU1NSk7XG4gICAgaSA9IChpICYgMHgzMzMzMzMzMykgKyAoKGkgPj4+IDIpICYgMHgzMzMzMzMzMyk7XG4gICAgcmV0dXJuICgoKGkgKyAoaSA+Pj4gNCkpICYgMHgwRjBGMEYwRikgKiAweDAxMDEwMTAxKSA+Pj4gMjQ7XG59XG4iXX0=
