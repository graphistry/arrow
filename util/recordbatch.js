"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const data_1 = require("../data");
const schema_1 = require("../schema");
const chunked_1 = require("../vector/chunked");
const recordbatch_1 = require("../recordbatch");
const noopBuf = new Uint8Array(0);
const nullBufs = (bitmapLength) => [
    noopBuf, noopBuf, new Uint8Array(bitmapLength), noopBuf
];
/** @ignore */
function ensureSameLengthData(schema, chunks, batchLength = chunks.reduce((l, c) => Math.max(l, c.length), 0)) {
    let data;
    let field;
    let i = -1, n = chunks.length;
    const fields = [...schema.fields];
    const batchData = [];
    const bitmapLength = ((batchLength + 63) & ~63) >> 3;
    while (++i < n) {
        if ((data = chunks[i]) && data.length === batchLength) {
            batchData[i] = data;
        }
        else {
            (field = fields[i]).nullable || (fields[i] = fields[i].clone({ nullable: true }));
            batchData[i] = data ? data._changeLengthAndBackfillNullBitmap(batchLength)
                : new data_1.Data(field.type, 0, batchLength, batchLength, nullBufs(bitmapLength));
        }
    }
    return [new schema_1.Schema(fields), batchLength, batchData];
}
exports.ensureSameLengthData = ensureSameLengthData;
/** @ignore */
function distributeColumnsIntoRecordBatches(columns) {
    return distributeVectorsIntoRecordBatches(new schema_1.Schema(columns.map(({ field }) => field)), columns);
}
exports.distributeColumnsIntoRecordBatches = distributeColumnsIntoRecordBatches;
/** @ignore */
function distributeVectorsIntoRecordBatches(schema, vecs) {
    return uniformlyDistributeChunksAcrossRecordBatches(schema, vecs.map((v) => v instanceof chunked_1.Chunked ? v.chunks.map((c) => c.data) : [v.data]));
}
exports.distributeVectorsIntoRecordBatches = distributeVectorsIntoRecordBatches;
/** @ignore */
function uniformlyDistributeChunksAcrossRecordBatches(schema, columns) {
    let numBatches = 0;
    const fields = [...schema.fields];
    const batches = [];
    const memo = { numBatches: columns.reduce((n, c) => Math.max(n, c.length), 0) };
    while (memo.numBatches > 0) {
        const [sameLength, batchLength] = columns.reduce((memo, [chunk]) => {
            const [same, batchLength] = memo;
            const chunkLength = chunk ? chunk.length : batchLength;
            isFinite(batchLength) && same && (memo[0] = chunkLength === batchLength);
            memo[1] = Math.min(batchLength, chunkLength);
            return memo;
        }, [true, Number.POSITIVE_INFINITY]);
        if (isFinite(batchLength) && !(sameLength && batchLength <= 0)) {
            batches[numBatches++] = [batchLength, distributeChildData(fields, batchLength, columns, memo)];
        }
    }
    return [
        schema = new schema_1.Schema(fields),
        batches.map((xs) => new recordbatch_1.RecordBatch(schema, ...xs))
    ];
}
/** @ignore */
function distributeChildData(fields, batchLength, columns, memo) {
    memo.numBatches -= 1;
    let data;
    let field;
    let chunks;
    let length = 0, i = -1, n = columns.length;
    const batchData = [];
    const bitmapLength = ((batchLength + 63) & ~63) >> 3;
    while (++i < n) {
        if ((data = (chunks = columns[i]).shift()) && ((length = data.length) >= batchLength)) {
            if (length === batchLength) {
                batchData[i] = data;
            }
            else {
                batchData[i] = data.slice(0, batchLength);
                data = data.slice(batchLength, length - batchLength);
                memo.numBatches = Math.max(memo.numBatches, chunks.push(data));
            }
        }
        else {
            (field = fields[i]).nullable || (fields[i] = field.clone({ nullable: true }));
            batchData[i] = data ? data._changeLengthAndBackfillNullBitmap(batchLength)
                : new data_1.Data(field.type, 0, batchLength, batchLength, nullBufs(bitmapLength));
        }
    }
    return batchData;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDO2dCQUN0RSxDQUFDLENBQUMsSUFBSSxXQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxRQUFRLENBQUMsWUFBWSxDQUFDLENBQXFCLENBQUM7U0FDdkc7S0FDSjtJQUNELE9BQU8sU0FBUyxDQUFDO0FBQ3JCLENBQUMiLCJmaWxlIjoidXRpbC9yZWNvcmRiYXRjaC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBDb2x1bW4gfSBmcm9tICcuLi9jb2x1bW4nO1xuaW1wb3J0IHsgVmVjdG9yIH0gZnJvbSAnLi4vdmVjdG9yJztcbmltcG9ydCB7IERhdGFUeXBlIH0gZnJvbSAnLi4vdHlwZSc7XG5pbXBvcnQgeyBEYXRhLCBCdWZmZXJzIH0gZnJvbSAnLi4vZGF0YSc7XG5pbXBvcnQgeyBTY2hlbWEsIEZpZWxkIH0gZnJvbSAnLi4vc2NoZW1hJztcbmltcG9ydCB7IENodW5rZWQgfSBmcm9tICcuLi92ZWN0b3IvY2h1bmtlZCc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaCB9IGZyb20gJy4uL3JlY29yZGJhdGNoJztcblxuY29uc3Qgbm9vcEJ1ZiA9IG5ldyBVaW50OEFycmF5KDApO1xuY29uc3QgbnVsbEJ1ZnMgPSAoYml0bWFwTGVuZ3RoOiBudW1iZXIpID0+IDx1bmtub3duPiBbXG4gICAgbm9vcEJ1Ziwgbm9vcEJ1ZiwgbmV3IFVpbnQ4QXJyYXkoYml0bWFwTGVuZ3RoKSwgbm9vcEJ1ZlxuXSBhcyBCdWZmZXJzPGFueT47XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgZnVuY3Rpb24gZW5zdXJlU2FtZUxlbmd0aERhdGE8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oXG4gICAgc2NoZW1hOiBTY2hlbWE8VD4sXG4gICAgY2h1bmtzOiBEYXRhPFRba2V5b2YgVF0+W10sXG4gICAgYmF0Y2hMZW5ndGggPSBjaHVua3MucmVkdWNlKChsLCBjKSA9PiBNYXRoLm1heChsLCBjLmxlbmd0aCksIDApXG4pIHtcbiAgICBsZXQgZGF0YTogRGF0YTxUW2tleW9mIFRdPjtcbiAgICBsZXQgZmllbGQ6IEZpZWxkPFRba2V5b2YgVF0+O1xuICAgIGxldCBpID0gLTEsIG4gPSBjaHVua3MubGVuZ3RoO1xuICAgIGNvbnN0IGZpZWxkcyA9IFsuLi5zY2hlbWEuZmllbGRzXTtcbiAgICBjb25zdCBiYXRjaERhdGEgPSBbXSBhcyBEYXRhPFRba2V5b2YgVF0+W107XG4gICAgY29uc3QgYml0bWFwTGVuZ3RoID0gKChiYXRjaExlbmd0aCArIDYzKSAmIH42MykgPj4gMztcbiAgICB3aGlsZSAoKytpIDwgbikge1xuICAgICAgICBpZiAoKGRhdGEgPSBjaHVua3NbaV0pICYmIGRhdGEubGVuZ3RoID09PSBiYXRjaExlbmd0aCkge1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ldID0gZGF0YTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIChmaWVsZCA9IGZpZWxkc1tpXSkubnVsbGFibGUgfHwgKGZpZWxkc1tpXSA9IGZpZWxkc1tpXS5jbG9uZSh7IG51bGxhYmxlOiB0cnVlIH0pIGFzIEZpZWxkPFRba2V5b2YgVF0+KTtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtpXSA9IGRhdGEgPyBkYXRhLl9jaGFuZ2VMZW5ndGhBbmRCYWNrZmlsbE51bGxCaXRtYXAoYmF0Y2hMZW5ndGgpXG4gICAgICAgICAgICAgICAgOiBuZXcgRGF0YShmaWVsZC50eXBlLCAwLCBiYXRjaExlbmd0aCwgYmF0Y2hMZW5ndGgsIG51bGxCdWZzKGJpdG1hcExlbmd0aCkpIGFzIERhdGE8VFtrZXlvZiBUXT47XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFtuZXcgU2NoZW1hPFQ+KGZpZWxkcyksIGJhdGNoTGVuZ3RoLCBiYXRjaERhdGFdIGFzIFtTY2hlbWE8VD4sIG51bWJlciwgRGF0YTxUW2tleW9mIFRdPltdXTtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBmdW5jdGlvbiBkaXN0cmlidXRlQ29sdW1uc0ludG9SZWNvcmRCYXRjaGVzPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KGNvbHVtbnM6IENvbHVtbjxUW2tleW9mIFRdPltdKTogW1NjaGVtYTxUPiwgUmVjb3JkQmF0Y2g8VD5bXV0ge1xuICAgIHJldHVybiBkaXN0cmlidXRlVmVjdG9yc0ludG9SZWNvcmRCYXRjaGVzPFQ+KG5ldyBTY2hlbWE8VD4oY29sdW1ucy5tYXAoKHsgZmllbGQgfSkgPT4gZmllbGQpKSwgY29sdW1ucyk7XG59XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgZnVuY3Rpb24gZGlzdHJpYnV0ZVZlY3RvcnNJbnRvUmVjb3JkQmF0Y2hlczxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihzY2hlbWE6IFNjaGVtYTxUPiwgdmVjczogKFZlY3RvcjxUW2tleW9mIFRdPiB8IENodW5rZWQ8VFtrZXlvZiBUXT4pW10pOiBbU2NoZW1hPFQ+LCBSZWNvcmRCYXRjaDxUPltdXSB7XG4gICAgcmV0dXJuIHVuaWZvcm1seURpc3RyaWJ1dGVDaHVua3NBY3Jvc3NSZWNvcmRCYXRjaGVzPFQ+KHNjaGVtYSwgdmVjcy5tYXAoKHYpID0+IHYgaW5zdGFuY2VvZiBDaHVua2VkID8gdi5jaHVua3MubWFwKChjKSA9PiBjLmRhdGEpIDogW3YuZGF0YV0pKTtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uIHVuaWZvcm1seURpc3RyaWJ1dGVDaHVua3NBY3Jvc3NSZWNvcmRCYXRjaGVzPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNjaGVtYTogU2NoZW1hPFQ+LCBjb2x1bW5zOiBEYXRhPFRba2V5b2YgVF0+W11bXSk6IFtTY2hlbWE8VD4sIFJlY29yZEJhdGNoPFQ+W11dIHtcblxuICAgIGxldCBudW1CYXRjaGVzID0gMDtcbiAgICBjb25zdCBmaWVsZHMgPSBbLi4uc2NoZW1hLmZpZWxkc107XG4gICAgY29uc3QgYmF0Y2hlcyA9IFtdIGFzIFtudW1iZXIsIERhdGE8VFtrZXlvZiBUXT5bXV1bXTtcbiAgICBjb25zdCBtZW1vID0geyBudW1CYXRjaGVzOiBjb2x1bW5zLnJlZHVjZSgobiwgYykgPT4gTWF0aC5tYXgobiwgYy5sZW5ndGgpLCAwKSB9O1xuXG4gICAgd2hpbGUgKG1lbW8ubnVtQmF0Y2hlcyA+IDApIHtcblxuICAgICAgICBjb25zdCBbc2FtZUxlbmd0aCwgYmF0Y2hMZW5ndGhdID0gY29sdW1ucy5yZWR1Y2UoKG1lbW8sIFtjaHVua10pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IFtzYW1lLCBiYXRjaExlbmd0aF0gPSBtZW1vO1xuICAgICAgICAgICAgY29uc3QgY2h1bmtMZW5ndGggPSBjaHVuayA/IGNodW5rLmxlbmd0aCA6IGJhdGNoTGVuZ3RoO1xuICAgICAgICAgICAgaXNGaW5pdGUoYmF0Y2hMZW5ndGgpICYmIHNhbWUgJiYgKG1lbW9bMF0gPSBjaHVua0xlbmd0aCA9PT0gYmF0Y2hMZW5ndGgpO1xuICAgICAgICAgICAgbWVtb1sxXSA9IE1hdGgubWluKGJhdGNoTGVuZ3RoLCBjaHVua0xlbmd0aCk7XG4gICAgICAgICAgICByZXR1cm4gbWVtbztcbiAgICAgICAgfSwgW3RydWUsIE51bWJlci5QT1NJVElWRV9JTkZJTklUWV0gYXMgW2Jvb2xlYW4sIG51bWJlcl0pO1xuXG4gICAgICAgIGlmIChpc0Zpbml0ZShiYXRjaExlbmd0aCkgJiYgIShzYW1lTGVuZ3RoICYmIGJhdGNoTGVuZ3RoIDw9IDApKSB7XG4gICAgICAgICAgICBiYXRjaGVzW251bUJhdGNoZXMrK10gPSBbYmF0Y2hMZW5ndGgsIGRpc3RyaWJ1dGVDaGlsZERhdGEoZmllbGRzLCBiYXRjaExlbmd0aCwgY29sdW1ucywgbWVtbyldO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBbXG4gICAgICAgIHNjaGVtYSA9IG5ldyBTY2hlbWE8VD4oZmllbGRzKSxcbiAgICAgICAgYmF0Y2hlcy5tYXAoKHhzKSA9PiBuZXcgUmVjb3JkQmF0Y2goc2NoZW1hLCAuLi54cykpXG4gICAgXTtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uIGRpc3RyaWJ1dGVDaGlsZERhdGE8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oZmllbGRzOiBGaWVsZDxUW2tleW9mIFRdPltdLCBiYXRjaExlbmd0aDogbnVtYmVyLCBjb2x1bW5zOiBEYXRhPFRba2V5b2YgVF0+W11bXSwgbWVtbzogeyBudW1CYXRjaGVzOiBudW1iZXIgfSkge1xuICAgIG1lbW8ubnVtQmF0Y2hlcyAtPSAxO1xuICAgIGxldCBkYXRhOiBEYXRhPFRba2V5b2YgVF0+O1xuICAgIGxldCBmaWVsZDogRmllbGQ8VFtrZXlvZiBUXT47XG4gICAgbGV0IGNodW5rczogRGF0YTxUW2tleW9mIFRdPltdO1xuICAgIGxldCBsZW5ndGggPSAwLCBpID0gLTEsIG4gPSBjb2x1bW5zLmxlbmd0aDtcbiAgICBjb25zdCBiYXRjaERhdGEgPSBbXSBhcyBEYXRhPFRba2V5b2YgVF0+W107XG4gICAgY29uc3QgYml0bWFwTGVuZ3RoID0gKChiYXRjaExlbmd0aCArIDYzKSAmIH42MykgPj4gMztcbiAgICB3aGlsZSAoKytpIDwgbikge1xuICAgICAgICBpZiAoKGRhdGEgPSAoY2h1bmtzID0gY29sdW1uc1tpXSkuc2hpZnQoKSEpICYmICgobGVuZ3RoID0gZGF0YS5sZW5ndGgpID49IGJhdGNoTGVuZ3RoKSkge1xuICAgICAgICAgICAgaWYgKGxlbmd0aCA9PT0gYmF0Y2hMZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBiYXRjaERhdGFbaV0gPSBkYXRhO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBiYXRjaERhdGFbaV0gPSBkYXRhLnNsaWNlKDAsIGJhdGNoTGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5zbGljZShiYXRjaExlbmd0aCwgbGVuZ3RoIC0gYmF0Y2hMZW5ndGgpO1xuICAgICAgICAgICAgICAgIG1lbW8ubnVtQmF0Y2hlcyA9IE1hdGgubWF4KG1lbW8ubnVtQmF0Y2hlcywgY2h1bmtzLnB1c2goZGF0YSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgKGZpZWxkID0gZmllbGRzW2ldKS5udWxsYWJsZSB8fCAoZmllbGRzW2ldID0gZmllbGQuY2xvbmUoeyBudWxsYWJsZTogdHJ1ZSB9KSBhcyBGaWVsZDxUW2tleW9mIFRdPik7XG4gICAgICAgICAgICBiYXRjaERhdGFbaV0gPSBkYXRhID8gZGF0YS5fY2hhbmdlTGVuZ3RoQW5kQmFja2ZpbGxOdWxsQml0bWFwKGJhdGNoTGVuZ3RoKVxuICAgICAgICAgICAgICAgIDogbmV3IERhdGEoZmllbGQudHlwZSwgMCwgYmF0Y2hMZW5ndGgsIGJhdGNoTGVuZ3RoLCBudWxsQnVmcyhiaXRtYXBMZW5ndGgpKSBhcyBEYXRhPFRba2V5b2YgVF0+O1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBiYXRjaERhdGE7XG59XG4iXX0=
