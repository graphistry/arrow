"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const data_1 = require("../data");
const schema_1 = require("../schema");
const chunked_1 = require("../vector/chunked");
const recordbatch_1 = require("../recordbatch");
const noopBuf = new Uint8Array(0);
const nullBufs = (bitmapLength) => [
    noopBuf, noopBuf, new Uint8Array(bitmapLength), noopBuf
];
/** @ignore */
function ensureSameLengthData(schema, chunks, batchLength = chunks.reduce((l, c) => Math.max(l, c.length), 0)) {
    let data;
    let field;
    let i = -1, n = chunks.length;
    const fields = [...schema.fields];
    const batchData = [];
    const bitmapLength = ((batchLength + 63) & ~63) >> 3;
    while (++i < n) {
        if ((data = chunks[i]) && data.length === batchLength) {
            batchData[i] = data;
        }
        else {
            (field = fields[i]).nullable || (fields[i] = fields[i].clone({ nullable: true }));
            batchData[i] = data ? data._changeLengthAndBackfillNullBitmap(batchLength)
                : new data_1.Data(field.type, 0, batchLength, batchLength, nullBufs(bitmapLength));
        }
    }
    return [new schema_1.Schema(fields), batchLength, batchData];
}
exports.ensureSameLengthData = ensureSameLengthData;
/** @ignore */
function distributeColumnsIntoRecordBatches(columns) {
    return distributeVectorsIntoRecordBatches(new schema_1.Schema(columns.map(({ field }) => field)), columns);
}
exports.distributeColumnsIntoRecordBatches = distributeColumnsIntoRecordBatches;
/** @ignore */
function distributeVectorsIntoRecordBatches(schema, vecs) {
    return uniformlyDistributeChunksAcrossRecordBatches(schema, vecs.map((v) => v instanceof chunked_1.Chunked ? v.chunks.map((c) => c.data) : [v.data]));
}
exports.distributeVectorsIntoRecordBatches = distributeVectorsIntoRecordBatches;
/** @ignore */
function uniformlyDistributeChunksAcrossRecordBatches(schema, columns) {
    const fields = [...schema.fields];
    const batchArgs = [];
    const memo = { numBatches: columns.reduce((n, c) => Math.max(n, c.length), 0) };
    let sameLength = false, numBatches = 0, batchLength = 0, batchData;
    while (memo.numBatches-- > 0) {
        [sameLength, batchLength] = columns.reduce((memo, [chunk]) => {
            const [same, batchLength] = memo;
            const chunkLength = chunk ? chunk.length : batchLength;
            isFinite(batchLength) && same && (memo[0] = chunkLength === batchLength);
            memo[1] = Math.min(batchLength, chunkLength);
            return memo;
        }, [true, Number.POSITIVE_INFINITY]);
        if (isFinite(batchLength) && !(sameLength && batchLength <= 0)) {
            batchData = distributeChildData(fields, batchLength, columns, memo);
            batchLength > 0 && (batchArgs[numBatches++] = [batchLength, batchData]);
        }
    }
    return [
        schema = new schema_1.Schema(fields, schema.metadata),
        batchArgs.map((xs) => new recordbatch_1.RecordBatch(schema, ...xs))
    ];
}
/** @ignore */
function distributeChildData(fields, batchLength, columns, memo) {
    let data;
    let field;
    let chunks;
    let length = 0, i = -1, n = columns.length;
    const batchData = [];
    const bitmapLength = ((batchLength + 63) & ~63) >> 3;
    while (++i < n) {
        if ((data = (chunks = columns[i]).shift()) && ((length = data.length) >= batchLength)) {
            if (length === batchLength) {
                batchData[i] = data;
            }
            else {
                batchData[i] = data.slice(0, batchLength);
                data = data.slice(batchLength, length - batchLength);
                memo.numBatches = Math.max(memo.numBatches, chunks.push(data));
            }
        }
        else {
            (field = fields[i]).nullable || (fields[i] = field.clone({ nullable: true }));
            batchData[i] = data ? data._changeLengthAndBackfillNullBitmap(batchLength)
                : new data_1.Data(field.type, 0, batchLength, batchLength, nullBufs(bitmapLength));
        }
    }
    return batchData;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QixDQUFDLENBQUM7WUFDbkcsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLFdBQVcsQ0FBQztnQkFDdEUsQ0FBQyxDQUFDLElBQUksV0FBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFxQixDQUFDO1NBQ3ZHO0tBQ0o7SUFDRCxPQUFPLFNBQVMsQ0FBQztBQUNyQixDQUFDIiwiZmlsZSI6InV0aWwvcmVjb3JkYmF0Y2guanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgQ29sdW1uIH0gZnJvbSAnLi4vY29sdW1uJztcbmltcG9ydCB7IFZlY3RvciB9IGZyb20gJy4uL3ZlY3Rvcic7XG5pbXBvcnQgeyBEYXRhVHlwZSB9IGZyb20gJy4uL3R5cGUnO1xuaW1wb3J0IHsgRGF0YSwgQnVmZmVycyB9IGZyb20gJy4uL2RhdGEnO1xuaW1wb3J0IHsgU2NoZW1hLCBGaWVsZCB9IGZyb20gJy4uL3NjaGVtYSc7XG5pbXBvcnQgeyBDaHVua2VkIH0gZnJvbSAnLi4vdmVjdG9yL2NodW5rZWQnO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2ggfSBmcm9tICcuLi9yZWNvcmRiYXRjaCc7XG5cbmNvbnN0IG5vb3BCdWYgPSBuZXcgVWludDhBcnJheSgwKTtcbmNvbnN0IG51bGxCdWZzID0gKGJpdG1hcExlbmd0aDogbnVtYmVyKSA9PiA8dW5rbm93bj4gW1xuICAgIG5vb3BCdWYsIG5vb3BCdWYsIG5ldyBVaW50OEFycmF5KGJpdG1hcExlbmd0aCksIG5vb3BCdWZcbl0gYXMgQnVmZmVyczxhbnk+O1xuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGZ1bmN0aW9uIGVuc3VyZVNhbWVMZW5ndGhEYXRhPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KFxuICAgIHNjaGVtYTogU2NoZW1hPFQ+LFxuICAgIGNodW5rczogRGF0YTxUW2tleW9mIFRdPltdLFxuICAgIGJhdGNoTGVuZ3RoID0gY2h1bmtzLnJlZHVjZSgobCwgYykgPT4gTWF0aC5tYXgobCwgYy5sZW5ndGgpLCAwKVxuKSB7XG4gICAgbGV0IGRhdGE6IERhdGE8VFtrZXlvZiBUXT47XG4gICAgbGV0IGZpZWxkOiBGaWVsZDxUW2tleW9mIFRdPjtcbiAgICBsZXQgaSA9IC0xLCBuID0gY2h1bmtzLmxlbmd0aDtcbiAgICBjb25zdCBmaWVsZHMgPSBbLi4uc2NoZW1hLmZpZWxkc107XG4gICAgY29uc3QgYmF0Y2hEYXRhID0gW10gYXMgRGF0YTxUW2tleW9mIFRdPltdO1xuICAgIGNvbnN0IGJpdG1hcExlbmd0aCA9ICgoYmF0Y2hMZW5ndGggKyA2MykgJiB+NjMpID4+IDM7XG4gICAgd2hpbGUgKCsraSA8IG4pIHtcbiAgICAgICAgaWYgKChkYXRhID0gY2h1bmtzW2ldKSAmJiBkYXRhLmxlbmd0aCA9PT0gYmF0Y2hMZW5ndGgpIHtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtpXSA9IGRhdGE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAoZmllbGQgPSBmaWVsZHNbaV0pLm51bGxhYmxlIHx8IChmaWVsZHNbaV0gPSBmaWVsZHNbaV0uY2xvbmUoeyBudWxsYWJsZTogdHJ1ZSB9KSBhcyBGaWVsZDxUW2tleW9mIFRdPik7XG4gICAgICAgICAgICBiYXRjaERhdGFbaV0gPSBkYXRhID8gZGF0YS5fY2hhbmdlTGVuZ3RoQW5kQmFja2ZpbGxOdWxsQml0bWFwKGJhdGNoTGVuZ3RoKVxuICAgICAgICAgICAgICAgIDogbmV3IERhdGEoZmllbGQudHlwZSwgMCwgYmF0Y2hMZW5ndGgsIGJhdGNoTGVuZ3RoLCBudWxsQnVmcyhiaXRtYXBMZW5ndGgpKSBhcyBEYXRhPFRba2V5b2YgVF0+O1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBbbmV3IFNjaGVtYTxUPihmaWVsZHMpLCBiYXRjaExlbmd0aCwgYmF0Y2hEYXRhXSBhcyBbU2NoZW1hPFQ+LCBudW1iZXIsIERhdGE8VFtrZXlvZiBUXT5bXV07XG59XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgZnVuY3Rpb24gZGlzdHJpYnV0ZUNvbHVtbnNJbnRvUmVjb3JkQmF0Y2hlczxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihjb2x1bW5zOiBDb2x1bW48VFtrZXlvZiBUXT5bXSk6IFtTY2hlbWE8VD4sIFJlY29yZEJhdGNoPFQ+W11dIHtcbiAgICByZXR1cm4gZGlzdHJpYnV0ZVZlY3RvcnNJbnRvUmVjb3JkQmF0Y2hlczxUPihuZXcgU2NoZW1hPFQ+KGNvbHVtbnMubWFwKCh7IGZpZWxkIH0pID0+IGZpZWxkKSksIGNvbHVtbnMpO1xufVxuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRpc3RyaWJ1dGVWZWN0b3JzSW50b1JlY29yZEJhdGNoZXM8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc2NoZW1hOiBTY2hlbWE8VD4sIHZlY3M6IChWZWN0b3I8VFtrZXlvZiBUXT4gfCBDaHVua2VkPFRba2V5b2YgVF0+KVtdKTogW1NjaGVtYTxUPiwgUmVjb3JkQmF0Y2g8VD5bXV0ge1xuICAgIHJldHVybiB1bmlmb3JtbHlEaXN0cmlidXRlQ2h1bmtzQWNyb3NzUmVjb3JkQmF0Y2hlczxUPihzY2hlbWEsIHZlY3MubWFwKCh2KSA9PiB2IGluc3RhbmNlb2YgQ2h1bmtlZCA/IHYuY2h1bmtzLm1hcCgoYykgPT4gYy5kYXRhKSA6IFt2LmRhdGFdKSk7XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiB1bmlmb3JtbHlEaXN0cmlidXRlQ2h1bmtzQWNyb3NzUmVjb3JkQmF0Y2hlczxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihzY2hlbWE6IFNjaGVtYTxUPiwgY29sdW1uczogRGF0YTxUW2tleW9mIFRdPltdW10pOiBbU2NoZW1hPFQ+LCBSZWNvcmRCYXRjaDxUPltdXSB7XG5cbiAgICBjb25zdCBmaWVsZHMgPSBbLi4uc2NoZW1hLmZpZWxkc107XG4gICAgY29uc3QgYmF0Y2hBcmdzID0gW10gYXMgW251bWJlciwgRGF0YTxUW2tleW9mIFRdPltdXVtdO1xuICAgIGNvbnN0IG1lbW8gPSB7IG51bUJhdGNoZXM6IGNvbHVtbnMucmVkdWNlKChuLCBjKSA9PiBNYXRoLm1heChuLCBjLmxlbmd0aCksIDApIH07XG4gICAgbGV0IHNhbWVMZW5ndGggPSBmYWxzZSwgbnVtQmF0Y2hlcyA9IDAsIGJhdGNoTGVuZ3RoID0gMCwgYmF0Y2hEYXRhOiBEYXRhPFRba2V5b2YgVF0+W107XG5cbiAgICB3aGlsZSAobWVtby5udW1CYXRjaGVzLS0gPiAwKSB7XG5cbiAgICAgICAgW3NhbWVMZW5ndGgsIGJhdGNoTGVuZ3RoXSA9IGNvbHVtbnMucmVkdWNlKChtZW1vLCBbY2h1bmtdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBbc2FtZSwgYmF0Y2hMZW5ndGhdID0gbWVtbztcbiAgICAgICAgICAgIGNvbnN0IGNodW5rTGVuZ3RoID0gY2h1bmsgPyBjaHVuay5sZW5ndGggOiBiYXRjaExlbmd0aDtcbiAgICAgICAgICAgIGlzRmluaXRlKGJhdGNoTGVuZ3RoKSAmJiBzYW1lICYmIChtZW1vWzBdID0gY2h1bmtMZW5ndGggPT09IGJhdGNoTGVuZ3RoKTtcbiAgICAgICAgICAgIG1lbW9bMV0gPSBNYXRoLm1pbihiYXRjaExlbmd0aCwgY2h1bmtMZW5ndGgpO1xuICAgICAgICAgICAgcmV0dXJuIG1lbW87XG4gICAgICAgIH0sIFt0cnVlLCBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFldIGFzIFtib29sZWFuLCBudW1iZXJdKTtcblxuICAgICAgICBpZiAoaXNGaW5pdGUoYmF0Y2hMZW5ndGgpICYmICEoc2FtZUxlbmd0aCAmJiBiYXRjaExlbmd0aCA8PSAwKSkge1xuICAgICAgICAgICAgYmF0Y2hEYXRhID0gZGlzdHJpYnV0ZUNoaWxkRGF0YShmaWVsZHMsIGJhdGNoTGVuZ3RoLCBjb2x1bW5zLCBtZW1vKTtcbiAgICAgICAgICAgIGJhdGNoTGVuZ3RoID4gMCAmJiAoYmF0Y2hBcmdzW251bUJhdGNoZXMrK10gPSBbYmF0Y2hMZW5ndGgsIGJhdGNoRGF0YV0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBbXG4gICAgICAgIHNjaGVtYSA9IG5ldyBTY2hlbWE8VD4oZmllbGRzLCBzY2hlbWEubWV0YWRhdGEpLFxuICAgICAgICBiYXRjaEFyZ3MubWFwKCh4cykgPT4gbmV3IFJlY29yZEJhdGNoKHNjaGVtYSwgLi4ueHMpKVxuICAgIF07XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiBkaXN0cmlidXRlQ2hpbGREYXRhPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KGZpZWxkczogRmllbGQ8VFtrZXlvZiBUXT5bXSwgYmF0Y2hMZW5ndGg6IG51bWJlciwgY29sdW1uczogRGF0YTxUW2tleW9mIFRdPltdW10sIG1lbW86IHsgbnVtQmF0Y2hlczogbnVtYmVyIH0pIHtcbiAgICBsZXQgZGF0YTogRGF0YTxUW2tleW9mIFRdPjtcbiAgICBsZXQgZmllbGQ6IEZpZWxkPFRba2V5b2YgVF0+O1xuICAgIGxldCBjaHVua3M6IERhdGE8VFtrZXlvZiBUXT5bXTtcbiAgICBsZXQgbGVuZ3RoID0gMCwgaSA9IC0xLCBuID0gY29sdW1ucy5sZW5ndGg7XG4gICAgY29uc3QgYmF0Y2hEYXRhID0gW10gYXMgRGF0YTxUW2tleW9mIFRdPltdO1xuICAgIGNvbnN0IGJpdG1hcExlbmd0aCA9ICgoYmF0Y2hMZW5ndGggKyA2MykgJiB+NjMpID4+IDM7XG4gICAgd2hpbGUgKCsraSA8IG4pIHtcbiAgICAgICAgaWYgKChkYXRhID0gKGNodW5rcyA9IGNvbHVtbnNbaV0pLnNoaWZ0KCkhKSAmJiAoKGxlbmd0aCA9IGRhdGEubGVuZ3RoKSA+PSBiYXRjaExlbmd0aCkpIHtcbiAgICAgICAgICAgIGlmIChsZW5ndGggPT09IGJhdGNoTGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgYmF0Y2hEYXRhW2ldID0gZGF0YTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYmF0Y2hEYXRhW2ldID0gZGF0YS5zbGljZSgwLCBiYXRjaExlbmd0aCk7XG4gICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEuc2xpY2UoYmF0Y2hMZW5ndGgsIGxlbmd0aCAtIGJhdGNoTGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBtZW1vLm51bUJhdGNoZXMgPSBNYXRoLm1heChtZW1vLm51bUJhdGNoZXMsIGNodW5rcy5wdXNoKGRhdGEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIChmaWVsZCA9IGZpZWxkc1tpXSkubnVsbGFibGUgfHwgKGZpZWxkc1tpXSA9IGZpZWxkLmNsb25lKHsgbnVsbGFibGU6IHRydWUgfSkgYXMgRmllbGQ8VFtrZXlvZiBUXT4pO1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ldID0gZGF0YSA/IGRhdGEuX2NoYW5nZUxlbmd0aEFuZEJhY2tmaWxsTnVsbEJpdG1hcChiYXRjaExlbmd0aClcbiAgICAgICAgICAgICAgICA6IG5ldyBEYXRhKGZpZWxkLnR5cGUsIDAsIGJhdGNoTGVuZ3RoLCBiYXRjaExlbmd0aCwgbnVsbEJ1ZnMoYml0bWFwTGVuZ3RoKSkgYXMgRGF0YTxUW2tleW9mIFRdPjtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYmF0Y2hEYXRhO1xufVxuIl19
