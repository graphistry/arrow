"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const vector_1 = require("../vector");
const row_1 = require("../vector/row");
const buffer_1 = require("../util/buffer");
const compat_1 = require("./compat");
/** @ignore */
function clampIndex(source, index, then) {
    const length = source.length;
    const adjust = index > -1 ? index : (length + (index % length));
    return then ? then(source, adjust) : adjust;
}
exports.clampIndex = clampIndex;
/** @ignore */
let tmp;
/** @ignore */
function clampRange(source, begin, end, then) {
    // Adjust args similar to Array.prototype.slice. Normalize begin/end to
    // clamp between 0 and length, and wrap around on negative indices, e.g.
    // slice(-1, 5) or slice(5, -1)
    let { length: len = 0 } = source;
    let lhs = typeof begin !== 'number' ? 0 : begin;
    let rhs = typeof end !== 'number' ? len : end;
    // wrap around on negative start/end positions
    (lhs < 0) && (lhs = ((lhs % len) + len) % len);
    (rhs < 0) && (rhs = ((rhs % len) + len) % len);
    // ensure lhs <= rhs
    (rhs < lhs) && (tmp = lhs, lhs = rhs, rhs = tmp);
    // ensure rhs <= length
    (rhs > len) && (rhs = len);
    return then ? then(source, lhs, rhs) : [lhs, rhs];
}
exports.clampRange = clampRange;
const big0 = compat_1.BigIntAvailable ? compat_1.BigInt(0) : 0;
/** @ignore */
function createElementComparator(search) {
    let typeofSearch = typeof search;
    // Compare primitives
    if (typeofSearch !== 'object' || search === null) {
        return typeofSearch !== 'bigint'
            ? (value) => value === search
            : (value) => (big0 + value) === search;
    }
    // Compare Dates
    if (search instanceof Date) {
        const valueOfSearch = search.valueOf();
        return (value) => value instanceof Date ? (value.valueOf() === valueOfSearch) : false;
    }
    if (ArrayBuffer.isView(search)) {
        return (value) => value ? buffer_1.compareArrayLike(search, value) : false;
    }
    // Compare Array-likes
    if (Array.isArray(search)) {
        return createArrayLikeComparator(search);
    }
    // Compare Rows
    if (search instanceof row_1.Row) {
        return createRowComparator(search);
    }
    // Compare Vectors
    if (search instanceof vector_1.Vector) {
        return createVectorComparator(search);
    }
    // Compare non-empty Objects
    const keys = Object.keys(search);
    if (keys.length > 0) {
        return createObjectKeysComparator(search, keys);
    }
    // No valid comparator
    return () => false;
}
exports.createElementComparator = createElementComparator;
/** @ignore */
function createArrayLikeComparator(search) {
    const n = search.length;
    const fns = [];
    for (let i = -1; ++i < n;) {
        fns[i] = createElementComparator(search[i]);
    }
    return (value) => {
        if (!value) {
            return false;
        }
        // Handle the case where the search element is an Array, but the
        // values are Rows or Vectors, e.g. list.indexOf(['foo', 'bar'])
        if (value instanceof row_1.Row) {
            if (value[row_1.kLength] !== n) {
                return false;
            }
            for (let i = -1; ++i < n;) {
                if (!(fns[i](value.get(i)))) {
                    return false;
                }
            }
            return true;
        }
        if (value.length !== n) {
            return false;
        }
        if (value instanceof vector_1.Vector) {
            for (let i = -1; ++i < n;) {
                if (!(fns[i](value.get(i)))) {
                    return false;
                }
            }
            return true;
        }
        for (let i = -1; ++i < n;) {
            if (!(fns[i](value[i]))) {
                return false;
            }
        }
        return true;
    };
}
/** @ignore */
function createRowComparator(search) {
    const n = search[row_1.kLength];
    const C = search.constructor;
    const fns = [];
    for (let i = -1; ++i < n;) {
        fns[i] = createElementComparator(search.get(i));
    }
    return (value) => {
        if (!(value instanceof C)) {
            return false;
        }
        if (!(value[row_1.kLength] === n)) {
            return false;
        }
        for (let i = -1; ++i < n;) {
            if (!(fns[i](value.get(i)))) {
                return false;
            }
        }
        return true;
    };
}
/** @ignore */
function createVectorComparator(search) {
    const n = search.length;
    const C = search.constructor;
    const fns = [];
    for (let i = -1; ++i < n;) {
        fns[i] = createElementComparator(search.get(i));
    }
    return (value) => {
        if (!(value instanceof C)) {
            return false;
        }
        if (!(value.length === n)) {
            return false;
        }
        for (let i = -1; ++i < n;) {
            if (!(fns[i](value.get(i)))) {
                return false;
            }
        }
        return true;
    };
}
/** @ignore */
function createObjectKeysComparator(search, keys) {
    const n = keys.length;
    const fns = [];
    for (let i = -1; ++i < n;) {
        fns[i] = createElementComparator(search[keys[i]]);
    }
    return (value) => {
        if (!value || typeof value !== 'object') {
            return false;
        }
        for (let i = -1; ++i < n;) {
            if (!(fns[i](value[keys[i]]))) {
                return false;
            }
        }
        return true;
    };
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDLEdBQUc7WUFDdkIsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUFFLE9BQU8sS0FBSyxDQUFDO2FBQUU7U0FDakQ7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDLENBQUM7QUFDTixDQUFDO0FBRUQsY0FBYztBQUNkLFNBQVMsMEJBQTBCLENBQUMsTUFBVyxFQUFFLElBQWM7SUFDM0QsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN0QixNQUFNLEdBQUcsR0FBRyxFQUE2QixDQUFDO0lBQzFDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHO1FBQ3ZCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNyRDtJQUNELE9BQU8sQ0FBQyxLQUFVLEVBQUUsRUFBRTtRQUNsQixJQUFJLENBQUMsS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUFFLE9BQU8sS0FBSyxDQUFDO1NBQUU7UUFDMUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUc7WUFDdkIsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQUUsT0FBTyxLQUFLLENBQUM7YUFBRTtTQUNuRDtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUMsQ0FBQztBQUNOLENBQUMiLCJmaWxlIjoidXRpbC92ZWN0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgVmVjdG9yIH0gZnJvbSAnLi4vdmVjdG9yJztcbmltcG9ydCB7IFJvdywga0xlbmd0aCB9IGZyb20gJy4uL3ZlY3Rvci9yb3cnO1xuaW1wb3J0IHsgY29tcGFyZUFycmF5TGlrZSB9IGZyb20gJy4uL3V0aWwvYnVmZmVyJztcbmltcG9ydCB7IEJpZ0ludCwgQmlnSW50QXZhaWxhYmxlIH0gZnJvbSAnLi9jb21wYXQnO1xuXG4vKiogQGlnbm9yZSAqL1xudHlwZSBSYW5nZUxpa2UgPSB7IGxlbmd0aDogbnVtYmVyOyBzdHJpZGU/OiBudW1iZXIgfTtcbi8qKiBAaWdub3JlICovXG50eXBlIENsYW1wVGhlbjxUIGV4dGVuZHMgUmFuZ2VMaWtlPiA9IChzb3VyY2U6IFQsIGluZGV4OiBudW1iZXIpID0+IGFueTtcbi8qKiBAaWdub3JlICovXG50eXBlIENsYW1wUmFuZ2VUaGVuPFQgZXh0ZW5kcyBSYW5nZUxpa2U+ID0gKHNvdXJjZTogVCwgb2Zmc2V0OiBudW1iZXIsIGxlbmd0aDogbnVtYmVyKSA9PiBhbnk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGFtcEluZGV4PFQgZXh0ZW5kcyBSYW5nZUxpa2U+KHNvdXJjZTogVCwgaW5kZXg6IG51bWJlcik6IG51bWJlcjtcbmV4cG9ydCBmdW5jdGlvbiBjbGFtcEluZGV4PFQgZXh0ZW5kcyBSYW5nZUxpa2UsIE4gZXh0ZW5kcyBDbGFtcFRoZW48VD4gPSBDbGFtcFRoZW48VD4+KHNvdXJjZTogVCwgaW5kZXg6IG51bWJlciwgdGhlbjogTik6IFJldHVyblR5cGU8Tj47XG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNsYW1wSW5kZXg8VCBleHRlbmRzIFJhbmdlTGlrZSwgTiBleHRlbmRzIENsYW1wVGhlbjxUPiA9IENsYW1wVGhlbjxUPj4oc291cmNlOiBULCBpbmRleDogbnVtYmVyLCB0aGVuPzogTikge1xuICAgIGNvbnN0IGxlbmd0aCA9IHNvdXJjZS5sZW5ndGg7XG4gICAgY29uc3QgYWRqdXN0ID0gaW5kZXggPiAtMSA/IGluZGV4IDogKGxlbmd0aCArIChpbmRleCAlIGxlbmd0aCkpO1xuICAgIHJldHVybiB0aGVuID8gdGhlbihzb3VyY2UsIGFkanVzdCkgOiBhZGp1c3Q7XG59XG5cbi8qKiBAaWdub3JlICovXG5sZXQgdG1wOiBudW1iZXI7XG5leHBvcnQgZnVuY3Rpb24gY2xhbXBSYW5nZTxUIGV4dGVuZHMgUmFuZ2VMaWtlPihzb3VyY2U6IFQsIGJlZ2luOiBudW1iZXIgfCB1bmRlZmluZWQsIGVuZDogbnVtYmVyIHwgdW5kZWZpbmVkKTogW251bWJlciwgbnVtYmVyXTtcbmV4cG9ydCBmdW5jdGlvbiBjbGFtcFJhbmdlPFQgZXh0ZW5kcyBSYW5nZUxpa2UsIE4gZXh0ZW5kcyBDbGFtcFJhbmdlVGhlbjxUPiA9IENsYW1wUmFuZ2VUaGVuPFQ+Pihzb3VyY2U6IFQsIGJlZ2luOiBudW1iZXIgfCB1bmRlZmluZWQsIGVuZDogbnVtYmVyIHwgdW5kZWZpbmVkLCB0aGVuOiBOKTogUmV0dXJuVHlwZTxOPjtcbi8qKiBAaWdub3JlICovXG5leHBvcnQgZnVuY3Rpb24gY2xhbXBSYW5nZTxUIGV4dGVuZHMgUmFuZ2VMaWtlLCBOIGV4dGVuZHMgQ2xhbXBSYW5nZVRoZW48VD4gPSBDbGFtcFJhbmdlVGhlbjxUPj4oc291cmNlOiBULCBiZWdpbjogbnVtYmVyIHwgdW5kZWZpbmVkLCBlbmQ6IG51bWJlciB8IHVuZGVmaW5lZCwgdGhlbj86IE4pIHtcblxuICAgIC8vIEFkanVzdCBhcmdzIHNpbWlsYXIgdG8gQXJyYXkucHJvdG90eXBlLnNsaWNlLiBOb3JtYWxpemUgYmVnaW4vZW5kIHRvXG4gICAgLy8gY2xhbXAgYmV0d2VlbiAwIGFuZCBsZW5ndGgsIGFuZCB3cmFwIGFyb3VuZCBvbiBuZWdhdGl2ZSBpbmRpY2VzLCBlLmcuXG4gICAgLy8gc2xpY2UoLTEsIDUpIG9yIHNsaWNlKDUsIC0xKVxuICAgIGxldCB7IGxlbmd0aDogbGVuID0gMCB9ID0gc291cmNlO1xuICAgIGxldCBsaHMgPSB0eXBlb2YgYmVnaW4gIT09ICdudW1iZXInID8gMCA6IGJlZ2luO1xuICAgIGxldCByaHMgPSB0eXBlb2YgZW5kICE9PSAnbnVtYmVyJyA/IGxlbiA6IGVuZDtcbiAgICAvLyB3cmFwIGFyb3VuZCBvbiBuZWdhdGl2ZSBzdGFydC9lbmQgcG9zaXRpb25zXG4gICAgKGxocyA8IDApICYmIChsaHMgPSAoKGxocyAlIGxlbikgKyBsZW4pICUgbGVuKTtcbiAgICAocmhzIDwgMCkgJiYgKHJocyA9ICgocmhzICUgbGVuKSArIGxlbikgJSBsZW4pO1xuICAgIC8vIGVuc3VyZSBsaHMgPD0gcmhzXG4gICAgKHJocyA8IGxocykgJiYgKHRtcCA9IGxocywgbGhzID0gcmhzLCByaHMgPSB0bXApO1xuICAgICAvLyBlbnN1cmUgcmhzIDw9IGxlbmd0aFxuICAgIChyaHMgPiBsZW4pICYmIChyaHMgPSBsZW4pO1xuXG4gICAgcmV0dXJuIHRoZW4gPyB0aGVuKHNvdXJjZSwgbGhzLCByaHMpIDogW2xocywgcmhzXTtcbn1cblxuY29uc3QgYmlnMCA9IEJpZ0ludEF2YWlsYWJsZSA/IEJpZ0ludCgwKSA6IDA7XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRWxlbWVudENvbXBhcmF0b3Ioc2VhcmNoOiBhbnkpIHtcbiAgICBsZXQgdHlwZW9mU2VhcmNoID0gdHlwZW9mIHNlYXJjaDtcbiAgICAvLyBDb21wYXJlIHByaW1pdGl2ZXNcbiAgICBpZiAodHlwZW9mU2VhcmNoICE9PSAnb2JqZWN0JyB8fCBzZWFyY2ggPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIHR5cGVvZlNlYXJjaCAhPT0gJ2JpZ2ludCdcbiAgICAgICAgICAgID8gKHZhbHVlOiBhbnkpID0+IHZhbHVlID09PSBzZWFyY2hcbiAgICAgICAgICAgIDogKHZhbHVlOiBhbnkpID0+IChiaWcwICsgdmFsdWUpID09PSBzZWFyY2g7XG4gICAgfVxuICAgIC8vIENvbXBhcmUgRGF0ZXNcbiAgICBpZiAoc2VhcmNoIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICBjb25zdCB2YWx1ZU9mU2VhcmNoID0gc2VhcmNoLnZhbHVlT2YoKTtcbiAgICAgICAgcmV0dXJuICh2YWx1ZTogYW55KSA9PiB2YWx1ZSBpbnN0YW5jZW9mIERhdGUgPyAodmFsdWUudmFsdWVPZigpID09PSB2YWx1ZU9mU2VhcmNoKSA6IGZhbHNlO1xuICAgIH1cbiAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHNlYXJjaCkpIHtcbiAgICAgICAgcmV0dXJuICh2YWx1ZTogYW55KSA9PiB2YWx1ZSA/IGNvbXBhcmVBcnJheUxpa2Uoc2VhcmNoLCB2YWx1ZSkgOiBmYWxzZTtcbiAgICB9XG4gICAgLy8gQ29tcGFyZSBBcnJheS1saWtlc1xuICAgIGlmIChBcnJheS5pc0FycmF5KHNlYXJjaCkpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUFycmF5TGlrZUNvbXBhcmF0b3Ioc2VhcmNoKTtcbiAgICB9XG4gICAgLy8gQ29tcGFyZSBSb3dzXG4gICAgaWYgKHNlYXJjaCBpbnN0YW5jZW9mIFJvdykge1xuICAgICAgICByZXR1cm4gY3JlYXRlUm93Q29tcGFyYXRvcihzZWFyY2gpO1xuICAgIH1cbiAgICAvLyBDb21wYXJlIFZlY3RvcnNcbiAgICBpZiAoc2VhcmNoIGluc3RhbmNlb2YgVmVjdG9yKSB7XG4gICAgICAgIHJldHVybiBjcmVhdGVWZWN0b3JDb21wYXJhdG9yKHNlYXJjaCk7XG4gICAgfVxuICAgIC8vIENvbXBhcmUgbm9uLWVtcHR5IE9iamVjdHNcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoc2VhcmNoKTtcbiAgICBpZiAoa2V5cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiBjcmVhdGVPYmplY3RLZXlzQ29tcGFyYXRvcihzZWFyY2gsIGtleXMpO1xuICAgIH1cbiAgICAvLyBObyB2YWxpZCBjb21wYXJhdG9yXG4gICAgcmV0dXJuICgpID0+IGZhbHNlO1xufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24gY3JlYXRlQXJyYXlMaWtlQ29tcGFyYXRvcihzZWFyY2g6IEFycmF5TGlrZTxhbnk+KSB7XG4gICAgY29uc3QgbiA9IHNlYXJjaC5sZW5ndGg7XG4gICAgY29uc3QgZm5zID0gW10gYXMgKCh4OiBhbnkpID0+IGJvb2xlYW4pW107XG4gICAgZm9yIChsZXQgaSA9IC0xOyArK2kgPCBuOykge1xuICAgICAgICBmbnNbaV0gPSBjcmVhdGVFbGVtZW50Q29tcGFyYXRvcigoc2VhcmNoIGFzIGFueSlbaV0pO1xuICAgIH1cbiAgICByZXR1cm4gKHZhbHVlOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKCF2YWx1ZSkgeyByZXR1cm4gZmFsc2U7IH1cbiAgICAgICAgLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIHRoZSBzZWFyY2ggZWxlbWVudCBpcyBhbiBBcnJheSwgYnV0IHRoZVxuICAgICAgICAvLyB2YWx1ZXMgYXJlIFJvd3Mgb3IgVmVjdG9ycywgZS5nLiBsaXN0LmluZGV4T2YoWydmb28nLCAnYmFyJ10pXG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJvdykge1xuICAgICAgICAgICAgaWYgKHZhbHVlW2tMZW5ndGhdICE9PSBuKSB7IHJldHVybiBmYWxzZTsgfVxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IC0xOyArK2kgPCBuOykge1xuICAgICAgICAgICAgICAgIGlmICghKGZuc1tpXSh2YWx1ZS5nZXQoaSkpKSkgeyByZXR1cm4gZmFsc2U7IH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YWx1ZS5sZW5ndGggIT09IG4pIHsgcmV0dXJuIGZhbHNlOyB9XG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFZlY3Rvcikge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IC0xOyArK2kgPCBuOykge1xuICAgICAgICAgICAgICAgIGlmICghKGZuc1tpXSh2YWx1ZS5nZXQoaSkpKSkgeyByZXR1cm4gZmFsc2U7IH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGZvciAobGV0IGkgPSAtMTsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGlmICghKGZuc1tpXSh2YWx1ZVtpXSkpKSB7IHJldHVybiBmYWxzZTsgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH07XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiBjcmVhdGVSb3dDb21wYXJhdG9yKHNlYXJjaDogUm93PGFueT4pIHtcbiAgICBjb25zdCBuID0gc2VhcmNoW2tMZW5ndGhdO1xuICAgIGNvbnN0IEMgPSBzZWFyY2guY29uc3RydWN0b3IgYXMgYW55O1xuICAgIGNvbnN0IGZucyA9IFtdIGFzICgoeDogYW55KSA9PiBib29sZWFuKVtdO1xuICAgIGZvciAobGV0IGkgPSAtMTsgKytpIDwgbjspIHtcbiAgICAgICAgZm5zW2ldID0gY3JlYXRlRWxlbWVudENvbXBhcmF0b3Ioc2VhcmNoLmdldChpKSk7XG4gICAgfVxuICAgIHJldHVybiAodmFsdWU6IGFueSkgPT4ge1xuICAgICAgICBpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIEMpKSB7IHJldHVybiBmYWxzZTsgfVxuICAgICAgICBpZiAoISh2YWx1ZVtrTGVuZ3RoXSA9PT0gbikpIHsgcmV0dXJuIGZhbHNlOyB9XG4gICAgICAgIGZvciAobGV0IGkgPSAtMTsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGlmICghKGZuc1tpXSh2YWx1ZS5nZXQoaSkpKSkgeyByZXR1cm4gZmFsc2U7IH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9O1xufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24gY3JlYXRlVmVjdG9yQ29tcGFyYXRvcihzZWFyY2g6IFZlY3Rvcjxhbnk+KSB7XG4gICAgY29uc3QgbiA9IHNlYXJjaC5sZW5ndGg7XG4gICAgY29uc3QgQyA9IHNlYXJjaC5jb25zdHJ1Y3RvciBhcyBhbnk7XG4gICAgY29uc3QgZm5zID0gW10gYXMgKCh4OiBhbnkpID0+IGJvb2xlYW4pW107XG4gICAgZm9yIChsZXQgaSA9IC0xOyArK2kgPCBuOykge1xuICAgICAgICBmbnNbaV0gPSBjcmVhdGVFbGVtZW50Q29tcGFyYXRvcigoc2VhcmNoIGFzIGFueSkuZ2V0KGkpKTtcbiAgICB9XG4gICAgcmV0dXJuICh2YWx1ZTogYW55KSA9PiB7XG4gICAgICAgIGlmICghKHZhbHVlIGluc3RhbmNlb2YgQykpIHsgcmV0dXJuIGZhbHNlOyB9XG4gICAgICAgIGlmICghKHZhbHVlLmxlbmd0aCA9PT0gbikpIHsgcmV0dXJuIGZhbHNlOyB9XG4gICAgICAgIGZvciAobGV0IGkgPSAtMTsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGlmICghKGZuc1tpXSh2YWx1ZS5nZXQoaSkpKSkgeyByZXR1cm4gZmFsc2U7IH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9O1xufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24gY3JlYXRlT2JqZWN0S2V5c0NvbXBhcmF0b3Ioc2VhcmNoOiBhbnksIGtleXM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgbiA9IGtleXMubGVuZ3RoO1xuICAgIGNvbnN0IGZucyA9IFtdIGFzICgoeDogYW55KSA9PiBib29sZWFuKVtdO1xuICAgIGZvciAobGV0IGkgPSAtMTsgKytpIDwgbjspIHtcbiAgICAgICAgZm5zW2ldID0gY3JlYXRlRWxlbWVudENvbXBhcmF0b3Ioc2VhcmNoW2tleXNbaV1dKTtcbiAgICB9XG4gICAgcmV0dXJuICh2YWx1ZTogYW55KSA9PiB7XG4gICAgICAgIGlmICghdmFsdWUgfHwgdHlwZW9mIHZhbHVlICE9PSAnb2JqZWN0JykgeyByZXR1cm4gZmFsc2U7IH1cbiAgICAgICAgZm9yIChsZXQgaSA9IC0xOyArK2kgPCBuOykge1xuICAgICAgICAgICAgaWYgKCEoZm5zW2ldKHZhbHVlW2tleXNbaV1dKSkpIHsgcmV0dXJuIGZhbHNlOyB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfTtcbn1cbiJdfQ==
