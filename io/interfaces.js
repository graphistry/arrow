"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const adapters_1 = require("./adapters");
/** @ignore */
exports.ITERATOR_DONE = Object.freeze({ done: true, value: void (0) });
/** @ignore */
class ArrowJSON {
    // @ts-ignore
    constructor(_json) {
        this._json = _json;
    }
    get schema() { return this._json['schema']; }
    get batches() { return (this._json['batches'] || []); }
    get dictionaries() { return (this._json['dictionaries'] || []); }
}
exports.ArrowJSON = ArrowJSON;
/** @ignore */
class ReadableInterop {
    tee() {
        return this._getDOMStream().tee();
    }
    pipe(writable, options) {
        return this._getNodeStream().pipe(writable, options);
    }
    pipeTo(writable, options) { return this._getDOMStream().pipeTo(writable, options); }
    pipeThrough(duplex, options) {
        return this._getDOMStream().pipeThrough(duplex, options);
    }
    _getDOMStream() {
        return this._DOMStream || (this._DOMStream = this.toDOMStream());
    }
    _getNodeStream() {
        return this._nodeStream || (this._nodeStream = this.toNodeStream());
    }
}
exports.ReadableInterop = ReadableInterop;
/** @ignore */
class AsyncQueue extends ReadableInterop {
    constructor() {
        super();
        this._values = [];
        this.resolvers = [];
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    get closed() { return this._closedPromise; }
    async cancel(reason) { await this.return(reason); }
    write(value) {
        if (this._ensureOpen()) {
            this.resolvers.length <= 0
                ? (this._values.push(value))
                : (this.resolvers.shift().resolve({ done: false, value }));
        }
    }
    abort(value) {
        if (this._closedPromiseResolve) {
            this.resolvers.length <= 0
                ? (this._error = { error: value })
                : (this.resolvers.shift().reject({ done: true, value }));
        }
    }
    close() {
        if (this._closedPromiseResolve) {
            const { resolvers } = this;
            while (resolvers.length > 0) {
                resolvers.shift().resolve(exports.ITERATOR_DONE);
            }
            this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
        }
    }
    [Symbol.asyncIterator]() { return this; }
    toDOMStream(options) {
        return adapters_1.default.toDOMStream((this._closedPromiseResolve || this._error)
            ? this
            : this._values, options);
    }
    toNodeStream(options) {
        return adapters_1.default.toNodeStream((this._closedPromiseResolve || this._error)
            ? this
            : this._values, options);
    }
    async throw(_) { await this.abort(_); return exports.ITERATOR_DONE; }
    async return(_) { await this.close(); return exports.ITERATOR_DONE; }
    async read(size) { return (await this.next(size, 'read')).value; }
    async peek(size) { return (await this.next(size, 'peek')).value; }
    next(..._args) {
        if (this._values.length > 0) {
            return Promise.resolve({ done: false, value: this._values.shift() });
        }
        else if (this._error) {
            return Promise.reject({ done: true, value: this._error.error });
        }
        else if (!this._closedPromiseResolve) {
            return Promise.resolve(exports.ITERATOR_DONE);
        }
        else {
            return new Promise((resolve, reject) => {
                this.resolvers.push({ resolve, reject });
            });
        }
    }
    _ensureOpen() {
        if (this._closedPromiseResolve) {
            return true;
        }
        throw new Error(`${this} is closed`);
    }
}
exports.AsyncQueue = AsyncQueue;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDekIsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUcsRUFBUyxDQUFDLENBQUM7U0FDaEY7YUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDcEIsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1NBQ25FO2FBQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtZQUNwQyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMscUJBQWEsQ0FBQyxDQUFDO1NBQ3pDO2FBQU07WUFDSCxPQUFPLElBQUksT0FBTyxDQUE0QixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtnQkFDOUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUM3QyxDQUFDLENBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQztJQUVTLFdBQVc7UUFDakIsSUFBSSxJQUFJLENBQUMscUJBQXFCLEVBQUU7WUFDNUIsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxJQUFJLFlBQVksQ0FBQyxDQUFDO0lBQ3pDLENBQUM7Q0FDSjtBQWpGRCxnQ0FpRkMiLCJmaWxlIjoiaW8vaW50ZXJmYWNlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgc3RyZWFtQWRhcHRlcnMgZnJvbSAnLi9hZGFwdGVycyc7XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgY29uc3QgSVRFUkFUT1JfRE9ORTogYW55ID0gT2JqZWN0LmZyZWV6ZSh7IGRvbmU6IHRydWUsIHZhbHVlOiB2b2lkICgwKSB9KTtcblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCB0eXBlIEZpbGVIYW5kbGUgPSBpbXBvcnQoJ2ZzJykucHJvbWlzZXMuRmlsZUhhbmRsZTtcbi8qKiBAaWdub3JlICovXG5leHBvcnQgdHlwZSBBcnJvd0pTT05MaWtlID0geyBzY2hlbWE6IGFueTsgYmF0Y2hlcz86IGFueVtdOyBkaWN0aW9uYXJpZXM/OiBhbnlbXTsgfTtcbi8qKiBAaWdub3JlICovXG5leHBvcnQgdHlwZSBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMgPSB7IHR5cGU6ICdieXRlcycgfCB1bmRlZmluZWQsIGF1dG9BbGxvY2F0ZUNodW5rU2l6ZT86IG51bWJlciwgaGlnaFdhdGVyTWFyaz86IG51bWJlciB9O1xuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGNsYXNzIEFycm93SlNPTiB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2pzb246IEFycm93SlNPTkxpa2UpIHt9XG4gICAgcHVibGljIGdldCBzY2hlbWEoKTogYW55IHsgcmV0dXJuIHRoaXMuX2pzb25bJ3NjaGVtYSddOyB9XG4gICAgcHVibGljIGdldCBiYXRjaGVzKCk6IGFueVtdIHsgcmV0dXJuICh0aGlzLl9qc29uWydiYXRjaGVzJ10gfHwgW10pIGFzIGFueVtdOyB9XG4gICAgcHVibGljIGdldCBkaWN0aW9uYXJpZXMoKTogYW55W10geyByZXR1cm4gKHRoaXMuX2pzb25bJ2RpY3Rpb25hcmllcyddIHx8IFtdKSBhcyBhbnlbXTsgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWFkYWJsZTxUPiB7XG5cbiAgICByZWFkb25seSBjbG9zZWQ6IFByb21pc2U8dm9pZD47XG4gICAgY2FuY2VsKHJlYXNvbj86IGFueSk6IFByb21pc2U8dm9pZD47XG5cbiAgICByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUIHwgbnVsbD47XG4gICAgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VCB8IG51bGw+O1xuICAgIHRocm93KHZhbHVlPzogYW55KTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxhbnk+PjtcbiAgICByZXR1cm4odmFsdWU/OiBhbnkpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PGFueT4+O1xuICAgIG5leHQoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFQ+Pjtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBpbnRlcmZhY2UgV3JpdGFibGU8VD4ge1xuICAgIHJlYWRvbmx5IGNsb3NlZDogUHJvbWlzZTx2b2lkPjtcbiAgICBjbG9zZSgpOiB2b2lkO1xuICAgIHdyaXRlKGNodW5rOiBUKTogdm9pZDtcbiAgICBhYm9ydChyZWFzb24/OiBhbnkpOiB2b2lkO1xufVxuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWFkYWJsZVdyaXRhYmxlPFRSZWFkYWJsZSwgVFdyaXRhYmxlPiBleHRlbmRzIFJlYWRhYmxlPFRSZWFkYWJsZT4sIFdyaXRhYmxlPFRXcml0YWJsZT4ge1xuICAgIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTogQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFRSZWFkYWJsZT47XG4gICAgdG9ET01TdHJlYW0ob3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyk6IFJlYWRhYmxlU3RyZWFtPFRSZWFkYWJsZT47XG4gICAgdG9Ob2RlU3RyZWFtKG9wdGlvbnM/OiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlT3B0aW9ucyk6IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGU7XG59XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUmVhZGFibGVJbnRlcm9wPFQ+IHtcblxuICAgIHB1YmxpYyBhYnN0cmFjdCB0b0RPTVN0cmVhbShvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKTogUmVhZGFibGVTdHJlYW08VD47XG4gICAgcHVibGljIGFic3RyYWN0IHRvTm9kZVN0cmVhbShvcHRpb25zPzogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZU9wdGlvbnMpOiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlO1xuXG4gICAgcHVibGljIHRlZSgpOiBbUmVhZGFibGVTdHJlYW08VD4sIFJlYWRhYmxlU3RyZWFtPFQ+XSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRET01TdHJlYW0oKS50ZWUoKTtcbiAgICB9XG4gICAgcHVibGljIHBpcGU8UiBleHRlbmRzIE5vZGVKUy5Xcml0YWJsZVN0cmVhbT4od3JpdGFibGU6IFIsIG9wdGlvbnM/OiB7IGVuZD86IGJvb2xlYW47IH0pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldE5vZGVTdHJlYW0oKS5waXBlKHdyaXRhYmxlLCBvcHRpb25zKTtcbiAgICB9XG4gICAgcHVibGljIHBpcGVUbyh3cml0YWJsZTogV3JpdGFibGVTdHJlYW08VD4sIG9wdGlvbnM/OiBQaXBlT3B0aW9ucykgeyByZXR1cm4gdGhpcy5fZ2V0RE9NU3RyZWFtKCkucGlwZVRvKHdyaXRhYmxlLCBvcHRpb25zKTsgfVxuICAgIHB1YmxpYyBwaXBlVGhyb3VnaDxSIGV4dGVuZHMgUmVhZGFibGVTdHJlYW08YW55Pj4oZHVwbGV4OiB7IHdyaXRhYmxlOiBXcml0YWJsZVN0cmVhbTxUPiwgcmVhZGFibGU6IFIgfSwgb3B0aW9ucz86IFBpcGVPcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRET01TdHJlYW0oKS5waXBlVGhyb3VnaChkdXBsZXgsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX0RPTVN0cmVhbT86IFJlYWRhYmxlU3RyZWFtPFQ+O1xuICAgIHByaXZhdGUgX2dldERPTVN0cmVhbSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX0RPTVN0cmVhbSB8fCAodGhpcy5fRE9NU3RyZWFtID0gdGhpcy50b0RPTVN0cmVhbSgpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9ub2RlU3RyZWFtPzogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZTtcbiAgICBwcml2YXRlIF9nZXROb2RlU3RyZWFtKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fbm9kZVN0cmVhbSB8fCAodGhpcy5fbm9kZVN0cmVhbSA9IHRoaXMudG9Ob2RlU3RyZWFtKCkpO1xuICAgIH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbnR5cGUgUmVzb2x1dGlvbjxUPiA9IHsgcmVzb2x2ZTogKHZhbHVlPzogVCB8IFByb21pc2VMaWtlPFQ+KSA9PiB2b2lkOyByZWplY3Q6IChyZWFzb24/OiBhbnkpID0+IHZvaWQ7IH07XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgY2xhc3MgQXN5bmNRdWV1ZTxUUmVhZGFibGUgPSBVaW50OEFycmF5LCBUV3JpdGFibGUgPSBUUmVhZGFibGU+IGV4dGVuZHMgUmVhZGFibGVJbnRlcm9wPFRSZWFkYWJsZT5cbiAgICBpbXBsZW1lbnRzIEFzeW5jSXRlcmFibGVJdGVyYXRvcjxUUmVhZGFibGU+LCBSZWFkYWJsZVdyaXRhYmxlPFRSZWFkYWJsZSwgVFdyaXRhYmxlPiB7XG5cbiAgICBwcm90ZWN0ZWQgX3ZhbHVlczogVFdyaXRhYmxlW10gPSBbXTtcbiAgICBwcm90ZWN0ZWQgX2Vycm9yPzogeyBlcnJvcjogYW55OyB9O1xuICAgIHByb3RlY3RlZCBfY2xvc2VkUHJvbWlzZTogUHJvbWlzZTx2b2lkPjtcbiAgICBwcm90ZWN0ZWQgX2Nsb3NlZFByb21pc2VSZXNvbHZlPzogKHZhbHVlPzogYW55KSA9PiB2b2lkO1xuICAgIHByb3RlY3RlZCByZXNvbHZlcnM6IFJlc29sdXRpb248SXRlcmF0b3JSZXN1bHQ8VFJlYWRhYmxlPj5bXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocikgPT4gdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgPSByKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGNsb3NlZCgpOiBQcm9taXNlPHZvaWQ+IHsgcmV0dXJuIHRoaXMuX2Nsb3NlZFByb21pc2U7IH1cbiAgICBwdWJsaWMgYXN5bmMgY2FuY2VsKHJlYXNvbj86IGFueSkgeyBhd2FpdCB0aGlzLnJldHVybihyZWFzb24pOyB9XG4gICAgcHVibGljIHdyaXRlKHZhbHVlOiBUV3JpdGFibGUpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Vuc3VyZU9wZW4oKSkge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMubGVuZ3RoIDw9IDBcbiAgICAgICAgICAgICAgICA/ICh0aGlzLl92YWx1ZXMucHVzaCh2YWx1ZSkpXG4gICAgICAgICAgICAgICAgOiAodGhpcy5yZXNvbHZlcnMuc2hpZnQoKSEucmVzb2x2ZSh7IGRvbmU6IGZhbHNlLCB2YWx1ZSB9IGFzIGFueSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBhYm9ydCh2YWx1ZT86IGFueSkge1xuICAgICAgICBpZiAodGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUpIHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzLmxlbmd0aCA8PSAwXG4gICAgICAgICAgICAgICAgPyAodGhpcy5fZXJyb3IgPSB7IGVycm9yOiB2YWx1ZSB9KVxuICAgICAgICAgICAgICAgIDogKHRoaXMucmVzb2x2ZXJzLnNoaWZ0KCkhLnJlamVjdCh7IGRvbmU6IHRydWUsIHZhbHVlIH0pKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgY2xvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSkge1xuICAgICAgICAgICAgY29uc3QgeyByZXNvbHZlcnMgfSA9IHRoaXM7XG4gICAgICAgICAgICB3aGlsZSAocmVzb2x2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlcnMuc2hpZnQoKSEucmVzb2x2ZShJVEVSQVRPUl9ET05FKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKCk7XG4gICAgICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgeyByZXR1cm4gdGhpczsgfVxuICAgIHB1YmxpYyB0b0RPTVN0cmVhbShvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzdHJlYW1BZGFwdGVycy50b0RPTVN0cmVhbShcbiAgICAgICAgICAgICh0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSB8fCB0aGlzLl9lcnJvcilcbiAgICAgICAgICAgICAgICA/ICh0aGlzIGFzIEFzeW5jSXRlcmFibGU8VFJlYWRhYmxlPilcbiAgICAgICAgICAgICAgICA6ICh0aGlzLl92YWx1ZXMgYXMgYW55KSBhcyBJdGVyYWJsZTxUUmVhZGFibGU+LFxuICAgICAgICAgICAgb3B0aW9ucyk7XG4gICAgfVxuICAgIHB1YmxpYyB0b05vZGVTdHJlYW0ob3B0aW9ucz86IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGVPcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzdHJlYW1BZGFwdGVycy50b05vZGVTdHJlYW0oXG4gICAgICAgICAgICAodGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgfHwgdGhpcy5fZXJyb3IpXG4gICAgICAgICAgICAgICAgPyAodGhpcyBhcyBBc3luY0l0ZXJhYmxlPFRSZWFkYWJsZT4pXG4gICAgICAgICAgICAgICAgOiAodGhpcy5fdmFsdWVzIGFzIGFueSkgYXMgSXRlcmFibGU8VFJlYWRhYmxlPixcbiAgICAgICAgICAgIG9wdGlvbnMpO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgdGhyb3coXz86IGFueSkgeyBhd2FpdCB0aGlzLmFib3J0KF8pOyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgIHB1YmxpYyBhc3luYyByZXR1cm4oXz86IGFueSkgeyBhd2FpdCB0aGlzLmNsb3NlKCk7IHJldHVybiBJVEVSQVRPUl9ET05FOyB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VFJlYWRhYmxlIHwgbnVsbD4geyByZXR1cm4gKGF3YWl0IHRoaXMubmV4dChzaXplLCAncmVhZCcpKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBhc3luYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUUmVhZGFibGUgfCBudWxsPiB7IHJldHVybiAoYXdhaXQgdGhpcy5uZXh0KHNpemUsICdwZWVrJykpLnZhbHVlOyB9XG4gICAgcHVibGljIG5leHQoLi4uX2FyZ3M6IGFueVtdKTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxUUmVhZGFibGU+PiB7XG4gICAgICAgIGlmICh0aGlzLl92YWx1ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRvbmU6IGZhbHNlLCB2YWx1ZTogdGhpcy5fdmFsdWVzLnNoaWZ0KCkhIH0gYXMgYW55KTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9lcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHsgZG9uZTogdHJ1ZSwgdmFsdWU6IHRoaXMuX2Vycm9yLmVycm9yIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShJVEVSQVRPUl9ET05FKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxUUmVhZGFibGU+PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMucHVzaCh7IHJlc29sdmUsIHJlamVjdCB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9lbnN1cmVPcGVuKCkge1xuICAgICAgICBpZiAodGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0aGlzfSBpcyBjbG9zZWRgKTtcbiAgICB9XG59XG4iXX0=
