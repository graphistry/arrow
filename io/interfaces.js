"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const adapters_1 = require("./adapters");
exports.ITERATOR_DONE = Object.freeze({ done: true, value: void (0) });
/**
 * @ignore
 */
class ArrowJSON {
    // @ts-ignore
    constructor(_json) {
        this._json = _json;
    }
    get schema() { return this._json['schema']; }
    get batches() { return (this._json['batches'] || []); }
    get dictionaries() { return (this._json['dictionaries'] || []); }
}
exports.ArrowJSON = ArrowJSON;
class ReadableInterop {
    tee() {
        return this._getReadableDOMStream().tee();
    }
    pipe(writable, options) {
        return this._getReadableNodeStream().pipe(writable, options);
    }
    pipeTo(writable, options) { return this._getReadableDOMStream().pipeTo(writable, options); }
    pipeThrough(duplex, options) {
        return this._getReadableDOMStream().pipeThrough(duplex, options);
    }
    _getReadableDOMStream() {
        return this._readableDOMStream || (this._readableDOMStream = this.toReadableDOMStream());
    }
    _getReadableNodeStream() {
        return this._readableNodeStream || (this._readableNodeStream = this.toReadableNodeStream());
    }
}
exports.ReadableInterop = ReadableInterop;
/**
 * @ignore
 */
class AsyncQueue extends ReadableInterop {
    constructor() {
        super();
        this._values = [];
        this.resolvers = [];
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    get closed() { return this._closedPromise; }
    cancel(reason) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.return(reason); });
    }
    write(value) {
        if (this._ensureOpen()) {
            this.resolvers.length <= 0
                ? (this._values.push(value))
                : (this.resolvers.shift().resolve({ done: false, value }));
        }
    }
    abort(value) {
        if (this._closedPromiseResolve) {
            this.resolvers.length <= 0
                ? (this._error = { error: value })
                : (this.resolvers.shift().reject({ done: true, value }));
        }
    }
    close() {
        if (this._closedPromiseResolve) {
            const { resolvers } = this;
            while (resolvers.length > 0) {
                resolvers.shift().resolve(exports.ITERATOR_DONE);
            }
            this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
        }
    }
    [Symbol.asyncIterator]() { return this; }
    toReadableDOMStream(options) {
        return adapters_1.default.toReadableDOMStream((this._closedPromiseResolve || this._error)
            ? this
            : this._values, options);
    }
    toReadableNodeStream(options) {
        return adapters_1.default.toReadableNodeStream((this._closedPromiseResolve || this._error)
            ? this
            : this._values, options);
    }
    throw(_) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.abort(_); return exports.ITERATOR_DONE; });
    }
    return(_) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.close(); return exports.ITERATOR_DONE; });
    }
    read(size) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.next(size, 'read')).value; });
    }
    peek(size) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.next(size, 'peek')).value; });
    }
    next(..._args) {
        if (this._values.length > 0) {
            return Promise.resolve({ done: false, value: this._values.shift() });
        }
        else if (this._error) {
            return Promise.reject({ done: true, value: this._error.error });
        }
        else if (!this._closedPromiseResolve) {
            return Promise.resolve(exports.ITERATOR_DONE);
        }
        else {
            return new Promise((resolve, reject) => {
                this.resolvers.push({ resolve, reject });
            });
        }
    }
    _ensureOpen() {
        if (this._closedPromiseResolve) {
            return true;
        }
        throw new Error(`${this} is closed`);
    }
}
exports.AsyncQueue = AsyncQueue;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3pCLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFHLEVBQVMsQ0FBQyxDQUFDO1NBQ2hGO2FBQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3BCLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUNuRTthQUFNLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUU7WUFDcEMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLHFCQUFhLENBQUMsQ0FBQztTQUN6QzthQUFNO1lBQ0gsT0FBTyxJQUFJLE9BQU8sQ0FBNEIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7Z0JBQzlELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDN0MsQ0FBQyxDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7SUFFUyxXQUFXO1FBQ2pCLElBQUksSUFBSSxDQUFDLHFCQUFxQixFQUFFO1lBQzVCLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsSUFBSSxZQUFZLENBQUMsQ0FBQztJQUN6QyxDQUFDO0NBQ0o7QUFqRkQsZ0NBaUZDIiwiZmlsZSI6ImlvL2ludGVyZmFjZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHN0cmVhbUFkYXB0ZXJzIGZyb20gJy4vYWRhcHRlcnMnO1xuXG5leHBvcnQgY29uc3QgSVRFUkFUT1JfRE9ORTogYW55ID0gT2JqZWN0LmZyZWV6ZSh7IGRvbmU6IHRydWUsIHZhbHVlOiB2b2lkICgwKSB9KTtcblxuZXhwb3J0IHR5cGUgRmlsZUhhbmRsZSA9IGltcG9ydCgnZnMnKS5wcm9taXNlcy5GaWxlSGFuZGxlO1xuZXhwb3J0IHR5cGUgQXJyb3dKU09OTGlrZSA9IHsgc2NoZW1hOiBhbnk7IGJhdGNoZXM/OiBhbnlbXTsgZGljdGlvbmFyaWVzPzogYW55W107IH07XG5leHBvcnQgdHlwZSBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMgPSB7IHR5cGU6ICdieXRlcycgfCB1bmRlZmluZWQsIGF1dG9BbGxvY2F0ZUNodW5rU2l6ZT86IG51bWJlciwgaGlnaFdhdGVyTWFyaz86IG51bWJlciB9O1xuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGNsYXNzIEFycm93SlNPTiB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2pzb246IEFycm93SlNPTkxpa2UpIHt9XG4gICAgcHVibGljIGdldCBzY2hlbWEoKTogYW55IHsgcmV0dXJuIHRoaXMuX2pzb25bJ3NjaGVtYSddOyB9XG4gICAgcHVibGljIGdldCBiYXRjaGVzKCk6IGFueVtdIHsgcmV0dXJuICh0aGlzLl9qc29uWydiYXRjaGVzJ10gfHwgW10pIGFzIGFueVtdOyB9XG4gICAgcHVibGljIGdldCBkaWN0aW9uYXJpZXMoKTogYW55W10geyByZXR1cm4gKHRoaXMuX2pzb25bJ2RpY3Rpb25hcmllcyddIHx8IFtdKSBhcyBhbnlbXTsgfVxufVxuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWFkYWJsZTxUPiB7XG5cbiAgICByZWFkb25seSBjbG9zZWQ6IFByb21pc2U8dm9pZD47XG4gICAgY2FuY2VsKHJlYXNvbj86IGFueSk6IFByb21pc2U8dm9pZD47XG5cbiAgICByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUIHwgbnVsbD47XG4gICAgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VCB8IG51bGw+O1xuICAgIHRocm93KHZhbHVlPzogYW55KTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxhbnk+PjtcbiAgICByZXR1cm4odmFsdWU/OiBhbnkpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PGFueT4+O1xuICAgIG5leHQoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFQ+Pjtcbn1cblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgV3JpdGFibGU8VD4ge1xuICAgIHJlYWRvbmx5IGNsb3NlZDogUHJvbWlzZTx2b2lkPjtcbiAgICBjbG9zZSgpOiB2b2lkO1xuICAgIHdyaXRlKGNodW5rOiBUKTogdm9pZDtcbiAgICBhYm9ydChyZWFzb24/OiBhbnkpOiB2b2lkO1xufVxuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWFkYWJsZVdyaXRhYmxlPFRSZWFkYWJsZSwgVFdyaXRhYmxlPiBleHRlbmRzIFJlYWRhYmxlPFRSZWFkYWJsZT4sIFdyaXRhYmxlPFRXcml0YWJsZT4ge1xuICAgIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTogQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFRSZWFkYWJsZT47XG4gICAgdG9SZWFkYWJsZURPTVN0cmVhbShvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKTogUmVhZGFibGVTdHJlYW08VFJlYWRhYmxlPjtcbiAgICB0b1JlYWRhYmxlTm9kZVN0cmVhbShvcHRpb25zPzogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZU9wdGlvbnMpOiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlO1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUmVhZGFibGVJbnRlcm9wPFQ+IHtcblxuICAgIHB1YmxpYyBhYnN0cmFjdCB0b1JlYWRhYmxlRE9NU3RyZWFtKG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpOiBSZWFkYWJsZVN0cmVhbTxUPjtcbiAgICBwdWJsaWMgYWJzdHJhY3QgdG9SZWFkYWJsZU5vZGVTdHJlYW0ob3B0aW9ucz86IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGVPcHRpb25zKTogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZTtcblxuICAgIHB1YmxpYyB0ZWUoKTogW1JlYWRhYmxlU3RyZWFtPFQ+LCBSZWFkYWJsZVN0cmVhbTxUPl0ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0UmVhZGFibGVET01TdHJlYW0oKS50ZWUoKTtcbiAgICB9XG4gICAgcHVibGljIHBpcGU8UiBleHRlbmRzIE5vZGVKUy5Xcml0YWJsZVN0cmVhbT4od3JpdGFibGU6IFIsIG9wdGlvbnM/OiB7IGVuZD86IGJvb2xlYW47IH0pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFJlYWRhYmxlTm9kZVN0cmVhbSgpLnBpcGUod3JpdGFibGUsIG9wdGlvbnMpO1xuICAgIH1cbiAgICBwdWJsaWMgcGlwZVRvKHdyaXRhYmxlOiBXcml0YWJsZVN0cmVhbTxUPiwgb3B0aW9ucz86IFBpcGVPcHRpb25zKSB7IHJldHVybiB0aGlzLl9nZXRSZWFkYWJsZURPTVN0cmVhbSgpLnBpcGVUbyh3cml0YWJsZSwgb3B0aW9ucyk7IH1cbiAgICBwdWJsaWMgcGlwZVRocm91Z2g8UiBleHRlbmRzIFJlYWRhYmxlU3RyZWFtPGFueT4+KGR1cGxleDogeyB3cml0YWJsZTogV3JpdGFibGVTdHJlYW08VD4sIHJlYWRhYmxlOiBSIH0sIG9wdGlvbnM/OiBQaXBlT3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0UmVhZGFibGVET01TdHJlYW0oKS5waXBlVGhyb3VnaChkdXBsZXgsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3JlYWRhYmxlRE9NU3RyZWFtPzogUmVhZGFibGVTdHJlYW08VD47XG4gICAgcHJpdmF0ZSBfZ2V0UmVhZGFibGVET01TdHJlYW0oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZURPTVN0cmVhbSB8fCAodGhpcy5fcmVhZGFibGVET01TdHJlYW0gPSB0aGlzLnRvUmVhZGFibGVET01TdHJlYW0oKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVhZGFibGVOb2RlU3RyZWFtPzogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZTtcbiAgICBwcml2YXRlIF9nZXRSZWFkYWJsZU5vZGVTdHJlYW0oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZU5vZGVTdHJlYW0gfHwgKHRoaXMuX3JlYWRhYmxlTm9kZVN0cmVhbSA9IHRoaXMudG9SZWFkYWJsZU5vZGVTdHJlYW0oKSk7XG4gICAgfVxufVxuXG50eXBlIFJlc29sdXRpb248VD4gPSB7IHJlc29sdmU6ICh2YWx1ZT86IFQgfCBQcm9taXNlTGlrZTxUPikgPT4gdm9pZDsgcmVqZWN0OiAocmVhc29uPzogYW55KSA9PiB2b2lkOyB9O1xuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGNsYXNzIEFzeW5jUXVldWU8VFJlYWRhYmxlID0gVWludDhBcnJheSwgVFdyaXRhYmxlID0gVFJlYWRhYmxlPiBleHRlbmRzIFJlYWRhYmxlSW50ZXJvcDxUUmVhZGFibGU+XG4gICAgaW1wbGVtZW50cyBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8VFJlYWRhYmxlPiwgUmVhZGFibGVXcml0YWJsZTxUUmVhZGFibGUsIFRXcml0YWJsZT4ge1xuXG4gICAgcHJvdGVjdGVkIF92YWx1ZXM6IFRXcml0YWJsZVtdID0gW107XG4gICAgcHJvdGVjdGVkIF9lcnJvcj86IHsgZXJyb3I6IGFueTsgfTtcbiAgICBwcm90ZWN0ZWQgX2Nsb3NlZFByb21pc2U6IFByb21pc2U8dm9pZD47XG4gICAgcHJvdGVjdGVkIF9jbG9zZWRQcm9taXNlUmVzb2x2ZT86ICh2YWx1ZT86IGFueSkgPT4gdm9pZDtcbiAgICBwcm90ZWN0ZWQgcmVzb2x2ZXJzOiBSZXNvbHV0aW9uPEl0ZXJhdG9yUmVzdWx0PFRSZWFkYWJsZT4+W10gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlID0gbmV3IFByb21pc2UoKHIpID0+IHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gcik7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBjbG9zZWQoKTogUHJvbWlzZTx2b2lkPiB7IHJldHVybiB0aGlzLl9jbG9zZWRQcm9taXNlOyB9XG4gICAgcHVibGljIGFzeW5jIGNhbmNlbChyZWFzb24/OiBhbnkpIHsgYXdhaXQgdGhpcy5yZXR1cm4ocmVhc29uKTsgfVxuICAgIHB1YmxpYyB3cml0ZSh2YWx1ZTogVFdyaXRhYmxlKSB7XG4gICAgICAgIGlmICh0aGlzLl9lbnN1cmVPcGVuKCkpIHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzLmxlbmd0aCA8PSAwXG4gICAgICAgICAgICAgICAgPyAodGhpcy5fdmFsdWVzLnB1c2godmFsdWUpKVxuICAgICAgICAgICAgICAgIDogKHRoaXMucmVzb2x2ZXJzLnNoaWZ0KCkhLnJlc29sdmUoeyBkb25lOiBmYWxzZSwgdmFsdWUgfSBhcyBhbnkpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgYWJvcnQodmFsdWU/OiBhbnkpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKSB7XG4gICAgICAgICAgICB0aGlzLnJlc29sdmVycy5sZW5ndGggPD0gMFxuICAgICAgICAgICAgICAgID8gKHRoaXMuX2Vycm9yID0geyBlcnJvcjogdmFsdWUgfSlcbiAgICAgICAgICAgICAgICA6ICh0aGlzLnJlc29sdmVycy5zaGlmdCgpIS5yZWplY3QoeyBkb25lOiB0cnVlLCB2YWx1ZSB9KSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIGNsb3NlKCkge1xuICAgICAgICBpZiAodGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgcmVzb2x2ZXJzIH0gPSB0aGlzO1xuICAgICAgICAgICAgd2hpbGUgKHJlc29sdmVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZXJzLnNoaWZ0KCkhLnJlc29sdmUoSVRFUkFUT1JfRE9ORSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSgpO1xuICAgICAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsgcmV0dXJuIHRoaXM7IH1cbiAgICBwdWJsaWMgdG9SZWFkYWJsZURPTVN0cmVhbShvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzdHJlYW1BZGFwdGVycy50b1JlYWRhYmxlRE9NU3RyZWFtKFxuICAgICAgICAgICAgKHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlIHx8IHRoaXMuX2Vycm9yKVxuICAgICAgICAgICAgICAgID8gKHRoaXMgYXMgQXN5bmNJdGVyYWJsZTxUUmVhZGFibGU+KVxuICAgICAgICAgICAgICAgIDogKHRoaXMuX3ZhbHVlcyBhcyBhbnkpIGFzIEl0ZXJhYmxlPFRSZWFkYWJsZT4sXG4gICAgICAgICAgICBvcHRpb25zKTtcbiAgICB9XG4gICAgcHVibGljIHRvUmVhZGFibGVOb2RlU3RyZWFtKG9wdGlvbnM/OiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlT3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc3RyZWFtQWRhcHRlcnMudG9SZWFkYWJsZU5vZGVTdHJlYW0oXG4gICAgICAgICAgICAodGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgfHwgdGhpcy5fZXJyb3IpXG4gICAgICAgICAgICAgICAgPyAodGhpcyBhcyBBc3luY0l0ZXJhYmxlPFRSZWFkYWJsZT4pXG4gICAgICAgICAgICAgICAgOiAodGhpcy5fdmFsdWVzIGFzIGFueSkgYXMgSXRlcmFibGU8VFJlYWRhYmxlPixcbiAgICAgICAgICAgIG9wdGlvbnMpO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgdGhyb3coXz86IGFueSkgeyBhd2FpdCB0aGlzLmFib3J0KF8pOyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgIHB1YmxpYyBhc3luYyByZXR1cm4oXz86IGFueSkgeyBhd2FpdCB0aGlzLmNsb3NlKCk7IHJldHVybiBJVEVSQVRPUl9ET05FOyB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VFJlYWRhYmxlIHwgbnVsbD4geyByZXR1cm4gKGF3YWl0IHRoaXMubmV4dChzaXplLCAncmVhZCcpKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBhc3luYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUUmVhZGFibGUgfCBudWxsPiB7IHJldHVybiAoYXdhaXQgdGhpcy5uZXh0KHNpemUsICdwZWVrJykpLnZhbHVlOyB9XG4gICAgcHVibGljIG5leHQoLi4uX2FyZ3M6IGFueVtdKTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxUUmVhZGFibGU+PiB7XG4gICAgICAgIGlmICh0aGlzLl92YWx1ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRvbmU6IGZhbHNlLCB2YWx1ZTogdGhpcy5fdmFsdWVzLnNoaWZ0KCkhIH0gYXMgYW55KTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9lcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHsgZG9uZTogdHJ1ZSwgdmFsdWU6IHRoaXMuX2Vycm9yLmVycm9yIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShJVEVSQVRPUl9ET05FKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxUUmVhZGFibGU+PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMucHVzaCh7IHJlc29sdmUsIHJlamVjdCB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9lbnN1cmVPcGVuKCkge1xuICAgICAgICBpZiAodGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0aGlzfSBpcyBjbG9zZWRgKTtcbiAgICB9XG59XG4iXX0=
