"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const adapters_1 = require("./adapters");
/** @ignore */
exports.ITERATOR_DONE = Object.freeze({ done: true, value: void (0) });
/** @ignore */
class ArrowJSON {
    // @ts-ignore
    constructor(_json) {
        this._json = _json;
    }
    get schema() { return this._json['schema']; }
    get batches() { return (this._json['batches'] || []); }
    get dictionaries() { return (this._json['dictionaries'] || []); }
}
exports.ArrowJSON = ArrowJSON;
/** @ignore */
class ReadableInterop {
    tee() {
        return this._getDOMStream().tee();
    }
    pipe(writable, options) {
        return this._getNodeStream().pipe(writable, options);
    }
    pipeTo(writable, options) { return this._getDOMStream().pipeTo(writable, options); }
    pipeThrough(duplex, options) {
        return this._getDOMStream().pipeThrough(duplex, options);
    }
    _getDOMStream() {
        return this._DOMStream || (this._DOMStream = this.toDOMStream());
    }
    _getNodeStream() {
        return this._nodeStream || (this._nodeStream = this.toNodeStream());
    }
}
exports.ReadableInterop = ReadableInterop;
/** @ignore */
class AsyncQueue extends ReadableInterop {
    constructor() {
        super();
        this._values = [];
        this.resolvers = [];
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    get closed() { return this._closedPromise; }
    cancel(reason) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.return(reason); });
    }
    write(value) {
        if (this._ensureOpen()) {
            this.resolvers.length <= 0
                ? (this._values.push(value))
                : (this.resolvers.shift().resolve({ done: false, value }));
        }
    }
    abort(value) {
        if (this._closedPromiseResolve) {
            this.resolvers.length <= 0
                ? (this._error = { error: value })
                : (this.resolvers.shift().reject({ done: true, value }));
        }
    }
    close() {
        if (this._closedPromiseResolve) {
            const { resolvers } = this;
            while (resolvers.length > 0) {
                resolvers.shift().resolve(exports.ITERATOR_DONE);
            }
            this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
        }
    }
    [Symbol.asyncIterator]() { return this; }
    toDOMStream(options) {
        return adapters_1.default.toDOMStream((this._closedPromiseResolve || this._error)
            ? this
            : this._values, options);
    }
    toNodeStream(options) {
        return adapters_1.default.toNodeStream((this._closedPromiseResolve || this._error)
            ? this
            : this._values, options);
    }
    throw(_) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.abort(_); return exports.ITERATOR_DONE; });
    }
    return(_) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.close(); return exports.ITERATOR_DONE; });
    }
    read(size) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.next(size, 'read')).value; });
    }
    peek(size) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.next(size, 'peek')).value; });
    }
    next(..._args) {
        if (this._values.length > 0) {
            return Promise.resolve({ done: false, value: this._values.shift() });
        }
        else if (this._error) {
            return Promise.reject({ done: true, value: this._error.error });
        }
        else if (!this._closedPromiseResolve) {
            return Promise.resolve(exports.ITERATOR_DONE);
        }
        else {
            return new Promise((resolve, reject) => {
                this.resolvers.push({ resolve, reject });
            });
        }
    }
    _ensureOpen() {
        if (this._closedPromiseResolve) {
            return true;
        }
        throw new Error(`${this} is closed`);
    }
}
exports.AsyncQueue = AsyncQueue;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN6QixPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRyxFQUFTLENBQUMsQ0FBQztTQUNoRjthQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNwQixPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDbkU7YUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFO1lBQ3BDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxxQkFBYSxDQUFDLENBQUM7U0FDekM7YUFBTTtZQUNILE9BQU8sSUFBSSxPQUFPLENBQTRCLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO2dCQUM5RCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQzdDLENBQUMsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDO0lBRVMsV0FBVztRQUNqQixJQUFJLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtZQUM1QixPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLElBQUksWUFBWSxDQUFDLENBQUM7SUFDekMsQ0FBQztDQUNKO0FBakZELGdDQWlGQyIsImZpbGUiOiJpby9pbnRlcmZhY2VzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCBzdHJlYW1BZGFwdGVycyBmcm9tICcuL2FkYXB0ZXJzJztcblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjb25zdCBJVEVSQVRPUl9ET05FOiBhbnkgPSBPYmplY3QuZnJlZXplKHsgZG9uZTogdHJ1ZSwgdmFsdWU6IHZvaWQgKDApIH0pO1xuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IHR5cGUgRmlsZUhhbmRsZSA9IGltcG9ydCgnZnMnKS5wcm9taXNlcy5GaWxlSGFuZGxlO1xuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCB0eXBlIEFycm93SlNPTkxpa2UgPSB7IHNjaGVtYTogYW55OyBiYXRjaGVzPzogYW55W107IGRpY3Rpb25hcmllcz86IGFueVtdOyB9O1xuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCB0eXBlIFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyA9IHsgdHlwZTogJ2J5dGVzJyB8IHVuZGVmaW5lZCwgYXV0b0FsbG9jYXRlQ2h1bmtTaXplPzogbnVtYmVyLCBoaWdoV2F0ZXJNYXJrPzogbnVtYmVyIH07XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgY2xhc3MgQXJyb3dKU09OIHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfanNvbjogQXJyb3dKU09OTGlrZSkge31cbiAgICBwdWJsaWMgZ2V0IHNjaGVtYSgpOiBhbnkgeyByZXR1cm4gdGhpcy5fanNvblsnc2NoZW1hJ107IH1cbiAgICBwdWJsaWMgZ2V0IGJhdGNoZXMoKTogYW55W10geyByZXR1cm4gKHRoaXMuX2pzb25bJ2JhdGNoZXMnXSB8fCBbXSkgYXMgYW55W107IH1cbiAgICBwdWJsaWMgZ2V0IGRpY3Rpb25hcmllcygpOiBhbnlbXSB7IHJldHVybiAodGhpcy5fanNvblsnZGljdGlvbmFyaWVzJ10gfHwgW10pIGFzIGFueVtdOyB9XG59XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgaW50ZXJmYWNlIFJlYWRhYmxlPFQ+IHtcblxuICAgIHJlYWRvbmx5IGNsb3NlZDogUHJvbWlzZTx2b2lkPjtcbiAgICBjYW5jZWwocmVhc29uPzogYW55KTogUHJvbWlzZTx2b2lkPjtcblxuICAgIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPFQgfCBudWxsPjtcbiAgICBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUIHwgbnVsbD47XG4gICAgdGhyb3codmFsdWU/OiBhbnkpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PGFueT4+O1xuICAgIHJldHVybih2YWx1ZT86IGFueSk6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8YW55Pj47XG4gICAgbmV4dChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8VD4+O1xufVxuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGludGVyZmFjZSBXcml0YWJsZTxUPiB7XG4gICAgcmVhZG9ubHkgY2xvc2VkOiBQcm9taXNlPHZvaWQ+O1xuICAgIGNsb3NlKCk6IHZvaWQ7XG4gICAgd3JpdGUoY2h1bms6IFQpOiB2b2lkO1xuICAgIGFib3J0KHJlYXNvbj86IGFueSk6IHZvaWQ7XG59XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgaW50ZXJmYWNlIFJlYWRhYmxlV3JpdGFibGU8VFJlYWRhYmxlLCBUV3JpdGFibGU+IGV4dGVuZHMgUmVhZGFibGU8VFJlYWRhYmxlPiwgV3JpdGFibGU8VFdyaXRhYmxlPiB7XG4gICAgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpOiBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8VFJlYWRhYmxlPjtcbiAgICB0b0RPTVN0cmVhbShvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKTogUmVhZGFibGVTdHJlYW08VFJlYWRhYmxlPjtcbiAgICB0b05vZGVTdHJlYW0ob3B0aW9ucz86IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGVPcHRpb25zKTogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZTtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZWFkYWJsZUludGVyb3A8VD4ge1xuXG4gICAgcHVibGljIGFic3RyYWN0IHRvRE9NU3RyZWFtKG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpOiBSZWFkYWJsZVN0cmVhbTxUPjtcbiAgICBwdWJsaWMgYWJzdHJhY3QgdG9Ob2RlU3RyZWFtKG9wdGlvbnM/OiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlT3B0aW9ucyk6IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGU7XG5cbiAgICBwdWJsaWMgdGVlKCk6IFtSZWFkYWJsZVN0cmVhbTxUPiwgUmVhZGFibGVTdHJlYW08VD5dIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldERPTVN0cmVhbSgpLnRlZSgpO1xuICAgIH1cbiAgICBwdWJsaWMgcGlwZTxSIGV4dGVuZHMgTm9kZUpTLldyaXRhYmxlU3RyZWFtPih3cml0YWJsZTogUiwgb3B0aW9ucz86IHsgZW5kPzogYm9vbGVhbjsgfSkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Tm9kZVN0cmVhbSgpLnBpcGUod3JpdGFibGUsIG9wdGlvbnMpO1xuICAgIH1cbiAgICBwdWJsaWMgcGlwZVRvKHdyaXRhYmxlOiBXcml0YWJsZVN0cmVhbTxUPiwgb3B0aW9ucz86IFBpcGVPcHRpb25zKSB7IHJldHVybiB0aGlzLl9nZXRET01TdHJlYW0oKS5waXBlVG8od3JpdGFibGUsIG9wdGlvbnMpOyB9XG4gICAgcHVibGljIHBpcGVUaHJvdWdoPFIgZXh0ZW5kcyBSZWFkYWJsZVN0cmVhbTxhbnk+PihkdXBsZXg6IHsgd3JpdGFibGU6IFdyaXRhYmxlU3RyZWFtPFQ+LCByZWFkYWJsZTogUiB9LCBvcHRpb25zPzogUGlwZU9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldERPTVN0cmVhbSgpLnBpcGVUaHJvdWdoKGR1cGxleCwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfRE9NU3RyZWFtPzogUmVhZGFibGVTdHJlYW08VD47XG4gICAgcHJpdmF0ZSBfZ2V0RE9NU3RyZWFtKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fRE9NU3RyZWFtIHx8ICh0aGlzLl9ET01TdHJlYW0gPSB0aGlzLnRvRE9NU3RyZWFtKCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX25vZGVTdHJlYW0/OiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlO1xuICAgIHByaXZhdGUgX2dldE5vZGVTdHJlYW0oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9ub2RlU3RyZWFtIHx8ICh0aGlzLl9ub2RlU3RyZWFtID0gdGhpcy50b05vZGVTdHJlYW0oKSk7XG4gICAgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xudHlwZSBSZXNvbHV0aW9uPFQ+ID0geyByZXNvbHZlOiAodmFsdWU/OiBUIHwgUHJvbWlzZUxpa2U8VD4pID0+IHZvaWQ7IHJlamVjdDogKHJlYXNvbj86IGFueSkgPT4gdm9pZDsgfTtcblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjbGFzcyBBc3luY1F1ZXVlPFRSZWFkYWJsZSA9IFVpbnQ4QXJyYXksIFRXcml0YWJsZSA9IFRSZWFkYWJsZT4gZXh0ZW5kcyBSZWFkYWJsZUludGVyb3A8VFJlYWRhYmxlPlxuICAgIGltcGxlbWVudHMgQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFRSZWFkYWJsZT4sIFJlYWRhYmxlV3JpdGFibGU8VFJlYWRhYmxlLCBUV3JpdGFibGU+IHtcblxuICAgIHByb3RlY3RlZCBfdmFsdWVzOiBUV3JpdGFibGVbXSA9IFtdO1xuICAgIHByb3RlY3RlZCBfZXJyb3I/OiB7IGVycm9yOiBhbnk7IH07XG4gICAgcHJvdGVjdGVkIF9jbG9zZWRQcm9taXNlOiBQcm9taXNlPHZvaWQ+O1xuICAgIHByb3RlY3RlZCBfY2xvc2VkUHJvbWlzZVJlc29sdmU/OiAodmFsdWU/OiBhbnkpID0+IHZvaWQ7XG4gICAgcHJvdGVjdGVkIHJlc29sdmVyczogUmVzb2x1dGlvbjxJdGVyYXRvclJlc3VsdDxUUmVhZGFibGU+PltdID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyKSA9PiB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSA9IHIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgY2xvc2VkKCk6IFByb21pc2U8dm9pZD4geyByZXR1cm4gdGhpcy5fY2xvc2VkUHJvbWlzZTsgfVxuICAgIHB1YmxpYyBhc3luYyBjYW5jZWwocmVhc29uPzogYW55KSB7IGF3YWl0IHRoaXMucmV0dXJuKHJlYXNvbik7IH1cbiAgICBwdWJsaWMgd3JpdGUodmFsdWU6IFRXcml0YWJsZSkge1xuICAgICAgICBpZiAodGhpcy5fZW5zdXJlT3BlbigpKSB7XG4gICAgICAgICAgICB0aGlzLnJlc29sdmVycy5sZW5ndGggPD0gMFxuICAgICAgICAgICAgICAgID8gKHRoaXMuX3ZhbHVlcy5wdXNoKHZhbHVlKSlcbiAgICAgICAgICAgICAgICA6ICh0aGlzLnJlc29sdmVycy5zaGlmdCgpIS5yZXNvbHZlKHsgZG9uZTogZmFsc2UsIHZhbHVlIH0gYXMgYW55KSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIGFib3J0KHZhbHVlPzogYW55KSB7XG4gICAgICAgIGlmICh0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSkge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMubGVuZ3RoIDw9IDBcbiAgICAgICAgICAgICAgICA/ICh0aGlzLl9lcnJvciA9IHsgZXJyb3I6IHZhbHVlIH0pXG4gICAgICAgICAgICAgICAgOiAodGhpcy5yZXNvbHZlcnMuc2hpZnQoKSEucmVqZWN0KHsgZG9uZTogdHJ1ZSwgdmFsdWUgfSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBjbG9zZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKSB7XG4gICAgICAgICAgICBjb25zdCB7IHJlc29sdmVycyB9ID0gdGhpcztcbiAgICAgICAgICAgIHdoaWxlIChyZXNvbHZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmVycy5zaGlmdCgpIS5yZXNvbHZlKElURVJBVE9SX0RPTkUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUoKTtcbiAgICAgICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7IHJldHVybiB0aGlzOyB9XG4gICAgcHVibGljIHRvRE9NU3RyZWFtKG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHN0cmVhbUFkYXB0ZXJzLnRvRE9NU3RyZWFtKFxuICAgICAgICAgICAgKHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlIHx8IHRoaXMuX2Vycm9yKVxuICAgICAgICAgICAgICAgID8gKHRoaXMgYXMgQXN5bmNJdGVyYWJsZTxUUmVhZGFibGU+KVxuICAgICAgICAgICAgICAgIDogKHRoaXMuX3ZhbHVlcyBhcyBhbnkpIGFzIEl0ZXJhYmxlPFRSZWFkYWJsZT4sXG4gICAgICAgICAgICBvcHRpb25zKTtcbiAgICB9XG4gICAgcHVibGljIHRvTm9kZVN0cmVhbShvcHRpb25zPzogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZU9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHN0cmVhbUFkYXB0ZXJzLnRvTm9kZVN0cmVhbShcbiAgICAgICAgICAgICh0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSB8fCB0aGlzLl9lcnJvcilcbiAgICAgICAgICAgICAgICA/ICh0aGlzIGFzIEFzeW5jSXRlcmFibGU8VFJlYWRhYmxlPilcbiAgICAgICAgICAgICAgICA6ICh0aGlzLl92YWx1ZXMgYXMgYW55KSBhcyBJdGVyYWJsZTxUUmVhZGFibGU+LFxuICAgICAgICAgICAgb3B0aW9ucyk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyB0aHJvdyhfPzogYW55KSB7IGF3YWl0IHRoaXMuYWJvcnQoXyk7IHJldHVybiBJVEVSQVRPUl9ET05FOyB9XG4gICAgcHVibGljIGFzeW5jIHJldHVybihfPzogYW55KSB7IGF3YWl0IHRoaXMuY2xvc2UoKTsgcmV0dXJuIElURVJBVE9SX0RPTkU7IH1cblxuICAgIHB1YmxpYyBhc3luYyByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUUmVhZGFibGUgfCBudWxsPiB7IHJldHVybiAoYXdhaXQgdGhpcy5uZXh0KHNpemUsICdyZWFkJykpLnZhbHVlOyB9XG4gICAgcHVibGljIGFzeW5jIHBlZWsoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPFRSZWFkYWJsZSB8IG51bGw+IHsgcmV0dXJuIChhd2FpdCB0aGlzLm5leHQoc2l6ZSwgJ3BlZWsnKSkudmFsdWU7IH1cbiAgICBwdWJsaWMgbmV4dCguLi5fYXJnczogYW55W10pOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFRSZWFkYWJsZT4+IHtcbiAgICAgICAgaWYgKHRoaXMuX3ZhbHVlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgZG9uZTogZmFsc2UsIHZhbHVlOiB0aGlzLl92YWx1ZXMuc2hpZnQoKSEgfSBhcyBhbnkpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2Vycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoeyBkb25lOiB0cnVlLCB2YWx1ZTogdGhpcy5fZXJyb3IuZXJyb3IgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKElURVJBVE9SX0RPTkUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFRSZWFkYWJsZT4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc29sdmVycy5wdXNoKHsgcmVzb2x2ZSwgcmVqZWN0IH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX2Vuc3VyZU9wZW4oKSB7XG4gICAgICAgIGlmICh0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3RoaXN9IGlzIGNsb3NlZGApO1xuICAgIH1cbn1cbiJdfQ==
