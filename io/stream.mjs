// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import streamAdapters from './adapters';
import { decodeUtf8 } from '../util/utf8';
import { ITERATOR_DONE, AsyncQueue } from './interfaces';
import { toUint8Array, joinUint8Arrays } from '../util/buffer';
import { isPromise, isFetchResponse, isIterable, isAsyncIterable, isReadableDOMStream, isReadableNodeStream } from '../util/compat';
/** @ignore */
export class AsyncByteQueue extends AsyncQueue {
    write(value) {
        if ((value = toUint8Array(value)).byteLength > 0) {
            return super.write(value);
        }
    }
    toString(sync = false) {
        return sync
            ? decodeUtf8(this.toUint8Array(true))
            : this.toUint8Array(false).then(decodeUtf8);
    }
    toUint8Array(sync = false) {
        return sync ? joinUint8Arrays(this._values)[0] : (async () => {
            let buffers = [], byteLength = 0;
            for await (const chunk of this) {
                buffers.push(chunk);
                byteLength += chunk.byteLength;
            }
            return joinUint8Arrays(buffers, byteLength)[0];
        })();
    }
}
/** @ignore */
export class ByteStream {
    constructor(source) {
        if (source) {
            this.source = new ByteStreamSource(streamAdapters.fromIterable(source));
        }
    }
    [Symbol.iterator]() { return this; }
    next(value) { return this.source.next(value); }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
/** @ignore */
export class AsyncByteStream {
    constructor(source) {
        if (source instanceof AsyncByteStream) {
            this.source = source.source;
        }
        else if (source instanceof AsyncByteQueue) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));
        }
        else if (isReadableNodeStream(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromNodeStream(source));
        }
        else if (isFetchResponse(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromDOMStream(source.body));
        }
        else if (isIterable(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromIterable(source));
        }
        else if (isPromise(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));
        }
        else if (isAsyncIterable(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));
        }
        else if (isReadableDOMStream(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromDOMStream(source));
        }
    }
    [Symbol.asyncIterator]() { return this; }
    next(value) { return this.source.next(value); }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    get closed() { return this.source.closed; }
    cancel(reason) { return this.source.cancel(reason); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
/** @ignore */
class ByteStreamSource {
    constructor(source) {
        this.source = source;
    }
    cancel(reason) { this.return(reason); }
    peek(size) { return this.next(size, 'peek').value; }
    read(size) { return this.next(size, 'read').value; }
    next(size, cmd = 'read') { return this.source.next({ cmd, size }); }
    throw(value) { return Object.create((this.source.throw && this.source.throw(value)) || ITERATOR_DONE); }
    return(value) { return Object.create((this.source.return && this.source.return(value)) || ITERATOR_DONE); }
}
/** @ignore */
class AsyncByteStreamSource {
    constructor(source) {
        this.source = source;
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    async cancel(reason) { await this.return(reason); }
    get closed() { return this._closedPromise; }
    async read(size) { return (await this.next(size, 'read')).value; }
    async peek(size) { return (await this.next(size, 'peek')).value; }
    async next(size, cmd = 'read') { return (await this.source.next({ cmd, size })); }
    async throw(value) {
        const result = (this.source.throw && await this.source.throw(value)) || ITERATOR_DONE;
        this._closedPromiseResolve && this._closedPromiseResolve();
        this._closedPromiseResolve = undefined;
        return Object.create(result);
    }
    async return(value) {
        const result = (this.source.return && await this.source.return(value)) || ITERATOR_DONE;
        this._closedPromiseResolve && this._closedPromiseResolve();
        this._closedPromiseResolve = undefined;
        return Object.create(result);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LElBQUksSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDM0QsSUFBSSxDQUFDLHFCQUFxQixHQUFHLFNBQVMsQ0FBQztRQUN2QyxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUNNLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBVztRQUMzQixNQUFNLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxhQUFhLENBQUM7UUFDeEYsSUFBSSxDQUFDLHFCQUFxQixJQUFJLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzNELElBQUksQ0FBQyxxQkFBcUIsR0FBRyxTQUFTLENBQUM7UUFDdkMsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Q0FDSiIsImZpbGUiOiJpby9zdHJlYW0uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHN0cmVhbUFkYXB0ZXJzIGZyb20gJy4vYWRhcHRlcnMnO1xuaW1wb3J0IHsgZGVjb2RlVXRmOCB9IGZyb20gJy4uL3V0aWwvdXRmOCc7XG5pbXBvcnQgeyBJVEVSQVRPUl9ET05FLCBSZWFkYWJsZSwgV3JpdGFibGUsIEFzeW5jUXVldWUgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgdG9VaW50OEFycmF5LCBqb2luVWludDhBcnJheXMsIEFycmF5QnVmZmVyVmlld0lucHV0IH0gZnJvbSAnLi4vdXRpbC9idWZmZXInO1xuXG5pbXBvcnQge1xuICAgIGlzUHJvbWlzZSwgaXNGZXRjaFJlc3BvbnNlLFxuICAgIGlzSXRlcmFibGUsIGlzQXN5bmNJdGVyYWJsZSxcbiAgICBpc1JlYWRhYmxlRE9NU3RyZWFtLCBpc1JlYWRhYmxlTm9kZVN0cmVhbVxufSBmcm9tICcuLi91dGlsL2NvbXBhdCc7XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgdHlwZSBXcml0YWJsZVNpbms8VD4gPSBXcml0YWJsZTxUPiB8IFdyaXRhYmxlU3RyZWFtPFQ+IHwgTm9kZUpTLldyaXRhYmxlU3RyZWFtIHwgbnVsbDtcbi8qKiBAaWdub3JlICovXG5leHBvcnQgdHlwZSBSZWFkYWJsZVNvdXJjZTxUPiA9IFJlYWRhYmxlPFQ+IHwgUHJvbWlzZUxpa2U8VD4gfCBBc3luY0l0ZXJhYmxlPFQ+IHwgUmVhZGFibGVTdHJlYW08VD4gfCBOb2RlSlMuUmVhZGFibGVTdHJlYW0gfCBudWxsO1xuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGNsYXNzIEFzeW5jQnl0ZVF1ZXVlPFQgZXh0ZW5kcyBBcnJheUJ1ZmZlclZpZXdJbnB1dCA9IFVpbnQ4QXJyYXk+IGV4dGVuZHMgQXN5bmNRdWV1ZTxVaW50OEFycmF5LCBUPiB7XG4gICAgcHVibGljIHdyaXRlKHZhbHVlOiBBcnJheUJ1ZmZlclZpZXdJbnB1dCB8IFVpbnQ4QXJyYXkpIHtcbiAgICAgICAgaWYgKCh2YWx1ZSA9IHRvVWludDhBcnJheSh2YWx1ZSkpLmJ5dGVMZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gc3VwZXIud3JpdGUodmFsdWUgYXMgVCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIHRvU3RyaW5nKHN5bmM6IHRydWUpOiBzdHJpbmc7XG4gICAgcHVibGljIHRvU3RyaW5nKHN5bmM/OiBmYWxzZSk6IFByb21pc2U8c3RyaW5nPjtcbiAgICBwdWJsaWMgdG9TdHJpbmcoc3luYyA9IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBzeW5jXG4gICAgICAgICAgICA/IGRlY29kZVV0ZjgodGhpcy50b1VpbnQ4QXJyYXkodHJ1ZSkpXG4gICAgICAgICAgICA6IHRoaXMudG9VaW50OEFycmF5KGZhbHNlKS50aGVuKGRlY29kZVV0ZjgpO1xuICAgIH1cbiAgICBwdWJsaWMgdG9VaW50OEFycmF5KHN5bmM6IHRydWUpOiBVaW50OEFycmF5O1xuICAgIHB1YmxpYyB0b1VpbnQ4QXJyYXkoc3luYz86IGZhbHNlKTogUHJvbWlzZTxVaW50OEFycmF5PjtcbiAgICBwdWJsaWMgdG9VaW50OEFycmF5KHN5bmMgPSBmYWxzZSkge1xuICAgICAgICByZXR1cm4gc3luYyA/IGpvaW5VaW50OEFycmF5cyh0aGlzLl92YWx1ZXMgYXMgYW55W10pWzBdIDogKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGxldCBidWZmZXJzID0gW10sIGJ5dGVMZW5ndGggPSAwO1xuICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiB0aGlzKSB7XG4gICAgICAgICAgICAgICAgYnVmZmVycy5wdXNoKGNodW5rKTtcbiAgICAgICAgICAgICAgICBieXRlTGVuZ3RoICs9IGNodW5rLmJ5dGVMZW5ndGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gam9pblVpbnQ4QXJyYXlzKGJ1ZmZlcnMsIGJ5dGVMZW5ndGgpWzBdO1xuICAgICAgICB9KSgpO1xuICAgIH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjbGFzcyBCeXRlU3RyZWFtIGltcGxlbWVudHMgSXRlcmFibGVJdGVyYXRvcjxVaW50OEFycmF5PiB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHByaXZhdGUgc291cmNlOiBCeXRlU3RyZWFtU291cmNlPFVpbnQ4QXJyYXk+O1xuICAgIGNvbnN0cnVjdG9yKHNvdXJjZT86IEl0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0PiB8IEFycmF5QnVmZmVyVmlld0lucHV0KSB7XG4gICAgICAgIGlmIChzb3VyY2UpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEJ5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbUl0ZXJhYmxlKHNvdXJjZSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIFtTeW1ib2wuaXRlcmF0b3JdKCkgeyByZXR1cm4gdGhpczsgfVxuICAgIHB1YmxpYyBuZXh0KHZhbHVlPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS5uZXh0KHZhbHVlKTsgfVxuICAgIHB1YmxpYyB0aHJvdyh2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UudGhyb3codmFsdWUpOyB9XG4gICAgcHVibGljIHJldHVybih2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UucmV0dXJuKHZhbHVlKTsgfVxuICAgIHB1YmxpYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKSB7IHJldHVybiB0aGlzLnNvdXJjZS5wZWVrKHNpemUpOyB9XG4gICAgcHVibGljIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJlYWQoc2l6ZSk7IH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjbGFzcyBBc3luY0J5dGVTdHJlYW0gaW1wbGVtZW50cyBSZWFkYWJsZTxVaW50OEFycmF5PiwgQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFVpbnQ4QXJyYXk+IHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJpdmF0ZSBzb3VyY2U6IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZTxVaW50OEFycmF5PjtcbiAgICBjb25zdHJ1Y3Rvcihzb3VyY2U/OiBQcm9taXNlTGlrZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4gfCBSZXNwb25zZSB8IFJlYWRhYmxlU3RyZWFtPEFycmF5QnVmZmVyVmlld0lucHV0PiB8IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSB8IEFzeW5jSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+IHwgSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KSB7XG4gICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBBc3luY0J5dGVTdHJlYW0pIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gKHNvdXJjZSBhcyBBc3luY0J5dGVTdHJlYW0pLnNvdXJjZTtcbiAgICAgICAgfSBlbHNlIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBBc3luY0J5dGVRdWV1ZSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21Bc3luY0l0ZXJhYmxlKHNvdXJjZSkpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzUmVhZGFibGVOb2RlU3RyZWFtKHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tTm9kZVN0cmVhbShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0ZldGNoUmVzcG9uc2Uoc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21ET01TdHJlYW0oc291cmNlLmJvZHkhKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4oc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21JdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc1Byb21pc2U8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tQXN5bmNJdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0FzeW5jSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tQXN5bmNJdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc1JlYWRhYmxlRE9NU3RyZWFtPEFycmF5QnVmZmVyVmlld0lucHV0Pihzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbURPTVN0cmVhbShzb3VyY2UpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgeyByZXR1cm4gdGhpczsgfVxuICAgIHB1YmxpYyBuZXh0KHZhbHVlPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS5uZXh0KHZhbHVlKTsgfVxuICAgIHB1YmxpYyB0aHJvdyh2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UudGhyb3codmFsdWUpOyB9XG4gICAgcHVibGljIHJldHVybih2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UucmV0dXJuKHZhbHVlKTsgfVxuICAgIHB1YmxpYyBnZXQgY2xvc2VkKCk6IFByb21pc2U8dm9pZD4geyByZXR1cm4gdGhpcy5zb3VyY2UuY2xvc2VkOyB9XG4gICAgcHVibGljIGNhbmNlbChyZWFzb24/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLmNhbmNlbChyZWFzb24pOyB9XG4gICAgcHVibGljIHBlZWsoc2l6ZT86IG51bWJlciB8IG51bGwpIHsgcmV0dXJuIHRoaXMuc291cmNlLnBlZWsoc2l6ZSk7IH1cbiAgICBwdWJsaWMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCkgeyByZXR1cm4gdGhpcy5zb3VyY2UucmVhZChzaXplKTsgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xuaW50ZXJmYWNlIEJ5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPiBleHRlbmRzIEl0ZXJhYmxlSXRlcmF0b3I8VD4ge1xuICAgIG5leHQodmFsdWU/OiB7IGNtZDogJ3BlZWsnIHwgJ3JlYWQnLCBzaXplPzogbnVtYmVyIHwgbnVsbCB9KTogSXRlcmF0b3JSZXN1bHQ8VD47XG59XG5cbi8qKiBAaWdub3JlICovXG5pbnRlcmZhY2UgQXN5bmNCeXRlU3RyZWFtU291cmNlSXRlcmF0b3I8VD4gZXh0ZW5kcyBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8VD4ge1xuICAgIG5leHQodmFsdWU/OiB7IGNtZDogJ3BlZWsnIHwgJ3JlYWQnLCBzaXplPzogbnVtYmVyIHwgbnVsbCB9KTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxUPj47XG59XG5cbi8qKiBAaWdub3JlICovXG5jbGFzcyBCeXRlU3RyZWFtU291cmNlPFQ+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgc291cmNlOiBCeXRlU3RyZWFtU291cmNlSXRlcmF0b3I8VD4pIHt9XG4gICAgcHVibGljIGNhbmNlbChyZWFzb24/OiBhbnkpIHsgdGhpcy5yZXR1cm4ocmVhc29uKTsgfVxuICAgIHB1YmxpYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKTogVCB8IG51bGwgeyByZXR1cm4gdGhpcy5uZXh0KHNpemUsICdwZWVrJykudmFsdWU7IH1cbiAgICBwdWJsaWMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFQgfCBudWxsIHsgcmV0dXJuIHRoaXMubmV4dChzaXplLCAncmVhZCcpLnZhbHVlOyB9XG4gICAgcHVibGljIG5leHQoc2l6ZT86IG51bWJlciB8IG51bGwsIGNtZDogJ3BlZWsnIHwgJ3JlYWQnID0gJ3JlYWQnKSB7IHJldHVybiB0aGlzLnNvdXJjZS5uZXh0KHsgY21kLCBzaXplIH0pOyB9XG4gICAgcHVibGljIHRocm93KHZhbHVlPzogYW55KSB7IHJldHVybiBPYmplY3QuY3JlYXRlKCh0aGlzLnNvdXJjZS50aHJvdyAmJiB0aGlzLnNvdXJjZS50aHJvdyh2YWx1ZSkpIHx8IElURVJBVE9SX0RPTkUpOyB9XG4gICAgcHVibGljIHJldHVybih2YWx1ZT86IGFueSkgeyByZXR1cm4gT2JqZWN0LmNyZWF0ZSgodGhpcy5zb3VyY2UucmV0dXJuICYmIHRoaXMuc291cmNlLnJldHVybih2YWx1ZSkpIHx8IElURVJBVE9SX0RPTkUpOyB9XG59XG5cbi8qKiBAaWdub3JlICovXG5jbGFzcyBBc3luY0J5dGVTdHJlYW1Tb3VyY2U8VD4gaW1wbGVtZW50cyBSZWFkYWJsZTxUPiB7XG5cbiAgICBwcml2YXRlIF9jbG9zZWRQcm9taXNlOiBQcm9taXNlPHZvaWQ+O1xuICAgIHByaXZhdGUgX2Nsb3NlZFByb21pc2VSZXNvbHZlPzogKHZhbHVlPzogYW55KSA9PiB2b2lkO1xuICAgIGNvbnN0cnVjdG9yIChwcm90ZWN0ZWQgc291cmNlOiBCeXRlU3RyZWFtU291cmNlSXRlcmF0b3I8VD4gfCBBc3luY0J5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPikge1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlID0gbmV3IFByb21pc2UoKHIpID0+IHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gcik7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyBjYW5jZWwocmVhc29uPzogYW55KSB7IGF3YWl0IHRoaXMucmV0dXJuKHJlYXNvbik7IH1cbiAgICBwdWJsaWMgZ2V0IGNsb3NlZCgpOiBQcm9taXNlPHZvaWQ+IHsgcmV0dXJuIHRoaXMuX2Nsb3NlZFByb21pc2U7IH1cbiAgICBwdWJsaWMgYXN5bmMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VCB8IG51bGw+IHsgcmV0dXJuIChhd2FpdCB0aGlzLm5leHQoc2l6ZSwgJ3JlYWQnKSkudmFsdWU7IH1cbiAgICBwdWJsaWMgYXN5bmMgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VCB8IG51bGw+IHsgcmV0dXJuIChhd2FpdCB0aGlzLm5leHQoc2l6ZSwgJ3BlZWsnKSkudmFsdWU7IH1cbiAgICBwdWJsaWMgYXN5bmMgbmV4dChzaXplPzogbnVtYmVyIHwgbnVsbCwgY21kOiAncGVlaycgfCAncmVhZCcgPSAncmVhZCcpIHsgcmV0dXJuIChhd2FpdCB0aGlzLnNvdXJjZS5uZXh0KHsgY21kLCBzaXplIH0pKTsgfVxuICAgIHB1YmxpYyBhc3luYyB0aHJvdyh2YWx1ZT86IGFueSkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSAodGhpcy5zb3VyY2UudGhyb3cgJiYgYXdhaXQgdGhpcy5zb3VyY2UudGhyb3codmFsdWUpKSB8fCBJVEVSQVRPUl9ET05FO1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSAmJiB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSgpO1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5jcmVhdGUocmVzdWx0KTtcbiAgICB9XG4gICAgcHVibGljIGFzeW5jIHJldHVybih2YWx1ZT86IGFueSkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSAodGhpcy5zb3VyY2UucmV0dXJuICYmIGF3YWl0IHRoaXMuc291cmNlLnJldHVybih2YWx1ZSkpIHx8IElURVJBVE9SX0RPTkU7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlICYmIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKCk7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShyZXN1bHQpO1xuICAgIH1cbn1cbiJdfQ==
