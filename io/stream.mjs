// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import streamAdapters from './adapters';
import { ITERATOR_DONE, AsyncQueue } from './interfaces';
import { toUint8Array, joinUint8Arrays } from '../util/buffer';
import { isPromise, isFetchResponse, isIterable, isAsyncIterable, isReadableDOMStream, isReadableNodeStream } from '../util/compat';
/**
 * @ignore
 */
export class AsyncByteQueue extends AsyncQueue {
    write(value) {
        if ((value = toUint8Array(value)).byteLength > 0) {
            return super.write(value);
        }
    }
    toUint8Array(sync = false) {
        return sync ? joinUint8Arrays(this.values.slice())[0] : (async () => {
            let buffers = [], byteLength = 0;
            for await (const chunk of this) {
                buffers.push(chunk);
                byteLength += chunk.byteLength;
            }
            return joinUint8Arrays(buffers, byteLength)[0];
        })();
    }
}
/**
 * @ignore
 */
export class ByteStream {
    constructor(source) {
        if (source) {
            this.source = new ByteStreamSource(streamAdapters.fromIterable(source));
        }
    }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
/**
 * @ignore
 */
export class AsyncByteStream {
    constructor(source) {
        if (source instanceof AsyncByteStream) {
            this.source = source.source;
        }
        else if (source instanceof AsyncByteQueue) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));
        }
        else if (isReadableNodeStream(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromReadableNodeStream(source));
        }
        else if (isFetchResponse(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromReadableDOMStream(source.body));
        }
        else if (isIterable(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromIterable(source));
        }
        else if (isPromise(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));
        }
        else if (isAsyncIterable(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));
        }
        else if (isReadableDOMStream(source)) {
            this.source = new AsyncByteStreamSource(streamAdapters.fromReadableDOMStream(source));
        }
    }
    next(value) { return this.source.next(value); }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    get closed() { return this.source.closed; }
    cancel(reason) { return this.source.cancel(reason); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
class ByteStreamSource {
    constructor(source) {
        this.source = source;
    }
    cancel(reason) { this.return(reason); }
    peek(size) { return this.next(size, 'peek').value; }
    read(size) { return this.next(size, 'read').value; }
    next(size, cmd = 'read') { return this.source.next({ cmd, size }); }
    throw(value) { return Object.create((this.source.throw && this.source.throw(value)) || ITERATOR_DONE); }
    return(value) { return Object.create((this.source.return && this.source.return(value)) || ITERATOR_DONE); }
}
class AsyncByteStreamSource {
    constructor(source) {
        this.source = source;
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    async cancel(reason) { await this.return(reason); }
    get closed() { return this._closedPromise; }
    async read(size) { return (await this.next(size, 'read')).value; }
    async peek(size) { return (await this.next(size, 'peek')).value; }
    async next(size, cmd = 'read') { return (await this.source.next({ cmd, size })); }
    async throw(value) {
        const result = (this.source.throw && await this.source.throw(value)) || ITERATOR_DONE;
        this._closedPromiseResolve && this._closedPromiseResolve();
        this._closedPromiseResolve = undefined;
        return Object.create(result);
    }
    async return(value) {
        const result = (this.source.return && await this.source.return(value)) || ITERATOR_DONE;
        this._closedPromiseResolve && this._closedPromiseResolve();
        this._closedPromiseResolve = undefined;
        return Object.create(result);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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bGUiOiJpby9zdHJlYW0uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHN0cmVhbUFkYXB0ZXJzIGZyb20gJy4vYWRhcHRlcnMnO1xuaW1wb3J0IHsgSVRFUkFUT1JfRE9ORSwgUmVhZGFibGUsIFdyaXRhYmxlLCBBc3luY1F1ZXVlIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IHRvVWludDhBcnJheSwgam9pblVpbnQ4QXJyYXlzLCBBcnJheUJ1ZmZlclZpZXdJbnB1dCB9IGZyb20gJy4uL3V0aWwvYnVmZmVyJztcbmltcG9ydCB7XG4gICAgaXNQcm9taXNlLCBpc0ZldGNoUmVzcG9uc2UsXG4gICAgaXNJdGVyYWJsZSwgaXNBc3luY0l0ZXJhYmxlLFxuICAgIGlzUmVhZGFibGVET01TdHJlYW0sIGlzUmVhZGFibGVOb2RlU3RyZWFtXG59IGZyb20gJy4uL3V0aWwvY29tcGF0JztcblxuZXhwb3J0IHR5cGUgV3JpdGFibGVTaW5rPFQ+ID0gV3JpdGFibGU8VD4gfCBXcml0YWJsZVN0cmVhbTxUPiB8IE5vZGVKUy5Xcml0YWJsZVN0cmVhbSB8IG51bGw7XG5leHBvcnQgdHlwZSBSZWFkYWJsZVNvdXJjZTxUPiA9IFJlYWRhYmxlPFQ+IHwgUHJvbWlzZUxpa2U8VD4gfCBBc3luY0l0ZXJhYmxlPFQ+IHwgUmVhZGFibGVTdHJlYW08VD4gfCBOb2RlSlMuUmVhZGFibGVTdHJlYW0gfCBudWxsO1xuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGNsYXNzIEFzeW5jQnl0ZVF1ZXVlPFQgZXh0ZW5kcyBBcnJheUJ1ZmZlclZpZXdJbnB1dCA9IFVpbnQ4QXJyYXk+IGV4dGVuZHMgQXN5bmNRdWV1ZTxVaW50OEFycmF5LCBUPiB7XG4gICAgcHVibGljIHdyaXRlKHZhbHVlOiBBcnJheUJ1ZmZlclZpZXdJbnB1dCB8IFVpbnQ4QXJyYXkpIHtcbiAgICAgICAgaWYgKCh2YWx1ZSA9IHRvVWludDhBcnJheSh2YWx1ZSkpLmJ5dGVMZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gc3VwZXIud3JpdGUodmFsdWUgYXMgVCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jOiB0cnVlKTogVWludDhBcnJheTtcbiAgICBwdWJsaWMgdG9VaW50OEFycmF5KHN5bmM/OiBmYWxzZSk6IFByb21pc2U8VWludDhBcnJheT47XG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jID0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuIHN5bmMgPyBqb2luVWludDhBcnJheXMoKHRoaXMudmFsdWVzIGFzIGFueVtdKS5zbGljZSgpKVswXSA6IChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBsZXQgYnVmZmVycyA9IFtdLCBieXRlTGVuZ3RoID0gMDtcbiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgdGhpcykge1xuICAgICAgICAgICAgICAgIGJ1ZmZlcnMucHVzaChjaHVuayk7XG4gICAgICAgICAgICAgICAgYnl0ZUxlbmd0aCArPSBjaHVuay5ieXRlTGVuZ3RoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGpvaW5VaW50OEFycmF5cyhidWZmZXJzLCBieXRlTGVuZ3RoKVswXTtcbiAgICAgICAgfSkoKTtcbiAgICB9XG59XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5leHBvcnQgY2xhc3MgQnl0ZVN0cmVhbSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHByaXZhdGUgc291cmNlOiBCeXRlU3RyZWFtU291cmNlPFVpbnQ4QXJyYXkgfCBudWxsPjtcbiAgICBjb25zdHJ1Y3Rvcihzb3VyY2U/OiBJdGVyYWJsZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4gfCBBcnJheUJ1ZmZlclZpZXdJbnB1dCkge1xuICAgICAgICBpZiAoc291cmNlKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21JdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgdGhyb3codmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnRocm93KHZhbHVlKTsgfVxuICAgIHB1YmxpYyByZXR1cm4odmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJldHVybih2YWx1ZSk7IH1cbiAgICBwdWJsaWMgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCkgeyByZXR1cm4gdGhpcy5zb3VyY2UucGVlayhzaXplKTsgfVxuICAgIHB1YmxpYyByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKSB7IHJldHVybiB0aGlzLnNvdXJjZS5yZWFkKHNpemUpOyB9XG59XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5leHBvcnQgY2xhc3MgQXN5bmNCeXRlU3RyZWFtIGltcGxlbWVudHMgUmVhZGFibGU8VWludDhBcnJheT4ge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwcml2YXRlIHNvdXJjZTogQXN5bmNCeXRlU3RyZWFtU291cmNlPFVpbnQ4QXJyYXk+O1xuICAgIGNvbnN0cnVjdG9yKHNvdXJjZT86IFByb21pc2VMaWtlPEFycmF5QnVmZmVyVmlld0lucHV0PiB8IFJlc3BvbnNlIHwgUmVhZGFibGVTdHJlYW08QXJyYXlCdWZmZXJWaWV3SW5wdXQ+IHwgTm9kZUpTLlJlYWRhYmxlU3RyZWFtIHwgQXN5bmNJdGVyYWJsZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4gfCBJdGVyYWJsZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4pIHtcbiAgICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIEFzeW5jQnl0ZVN0cmVhbSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSAoc291cmNlIGFzIEFzeW5jQnl0ZVN0cmVhbSkuc291cmNlO1xuICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIEFzeW5jQnl0ZVF1ZXVlKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbUFzeW5jSXRlcmFibGUoc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNSZWFkYWJsZU5vZGVTdHJlYW0oc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21SZWFkYWJsZU5vZGVTdHJlYW0oc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNGZXRjaFJlc3BvbnNlKHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tUmVhZGFibGVET01TdHJlYW0oc291cmNlLmJvZHkhKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4oc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21JdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc1Byb21pc2U8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tQXN5bmNJdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0FzeW5jSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tQXN5bmNJdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc1JlYWRhYmxlRE9NU3RyZWFtPEFycmF5QnVmZmVyVmlld0lucHV0Pihzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbVJlYWRhYmxlRE9NU3RyZWFtKHNvdXJjZSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBuZXh0KHZhbHVlPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS5uZXh0KHZhbHVlKTsgfVxuICAgIHB1YmxpYyB0aHJvdyh2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UudGhyb3codmFsdWUpOyB9XG4gICAgcHVibGljIHJldHVybih2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UucmV0dXJuKHZhbHVlKTsgfVxuICAgIHB1YmxpYyBnZXQgY2xvc2VkKCk6IFByb21pc2U8dm9pZD4geyByZXR1cm4gdGhpcy5zb3VyY2UuY2xvc2VkOyB9XG4gICAgcHVibGljIGNhbmNlbChyZWFzb24/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLmNhbmNlbChyZWFzb24pOyB9XG4gICAgcHVibGljIHBlZWsoc2l6ZT86IG51bWJlciB8IG51bGwpIHsgcmV0dXJuIHRoaXMuc291cmNlLnBlZWsoc2l6ZSk7IH1cbiAgICBwdWJsaWMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCkgeyByZXR1cm4gdGhpcy5zb3VyY2UucmVhZChzaXplKTsgfVxufVxuXG5pbnRlcmZhY2UgQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+IGV4dGVuZHMgSXRlcmFibGVJdGVyYXRvcjxUPiB7XG4gICAgbmV4dCh2YWx1ZT86IHsgY21kOiAncGVlaycgfCAncmVhZCcsIHNpemU/OiBudW1iZXIgfCBudWxsIH0pOiBJdGVyYXRvclJlc3VsdDxUPjtcbn1cblxuaW50ZXJmYWNlIEFzeW5jQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+IGV4dGVuZHMgQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFQ+IHtcbiAgICBuZXh0KHZhbHVlPzogeyBjbWQ6ICdwZWVrJyB8ICdyZWFkJywgc2l6ZT86IG51bWJlciB8IG51bGwgfSk6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8VD4+O1xufVxuXG5jbGFzcyBCeXRlU3RyZWFtU291cmNlPFQ+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgc291cmNlOiBCeXRlU3RyZWFtU291cmNlSXRlcmF0b3I8VD4pIHt9XG4gICAgcHVibGljIGNhbmNlbChyZWFzb24/OiBhbnkpIHsgdGhpcy5yZXR1cm4ocmVhc29uKTsgfVxuICAgIHB1YmxpYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKTogVCB8IG51bGwgeyByZXR1cm4gdGhpcy5uZXh0KHNpemUsICdwZWVrJykudmFsdWU7IH1cbiAgICBwdWJsaWMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFQgfCBudWxsIHsgcmV0dXJuIHRoaXMubmV4dChzaXplLCAncmVhZCcpLnZhbHVlOyB9XG4gICAgcHVibGljIG5leHQoc2l6ZT86IG51bWJlciB8IG51bGwsIGNtZDogJ3BlZWsnIHwgJ3JlYWQnID0gJ3JlYWQnKSB7IHJldHVybiB0aGlzLnNvdXJjZS5uZXh0KHsgY21kLCBzaXplIH0pOyB9XG4gICAgcHVibGljIHRocm93KHZhbHVlPzogYW55KSB7IHJldHVybiBPYmplY3QuY3JlYXRlKCh0aGlzLnNvdXJjZS50aHJvdyAmJiB0aGlzLnNvdXJjZS50aHJvdyh2YWx1ZSkpIHx8IElURVJBVE9SX0RPTkUpOyB9XG4gICAgcHVibGljIHJldHVybih2YWx1ZT86IGFueSkgeyByZXR1cm4gT2JqZWN0LmNyZWF0ZSgodGhpcy5zb3VyY2UucmV0dXJuICYmIHRoaXMuc291cmNlLnJldHVybih2YWx1ZSkpIHx8IElURVJBVE9SX0RPTkUpOyB9XG59XG5cbmNsYXNzIEFzeW5jQnl0ZVN0cmVhbVNvdXJjZTxUPiBpbXBsZW1lbnRzIFJlYWRhYmxlPFQ+IHtcblxuICAgIHByaXZhdGUgX2Nsb3NlZFByb21pc2U6IFByb21pc2U8dm9pZD47XG4gICAgcHJpdmF0ZSBfY2xvc2VkUHJvbWlzZVJlc29sdmU/OiAodmFsdWU/OiBhbnkpID0+IHZvaWQ7XG4gICAgY29uc3RydWN0b3IgKHByb3RlY3RlZCBzb3VyY2U6IEJ5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPiB8IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+KSB7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocikgPT4gdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgPSByKTtcbiAgICB9XG4gICAgcHVibGljIGFzeW5jIGNhbmNlbChyZWFzb24/OiBhbnkpIHsgYXdhaXQgdGhpcy5yZXR1cm4ocmVhc29uKTsgfVxuICAgIHB1YmxpYyBnZXQgY2xvc2VkKCk6IFByb21pc2U8dm9pZD4geyByZXR1cm4gdGhpcy5fY2xvc2VkUHJvbWlzZTsgfVxuICAgIHB1YmxpYyBhc3luYyByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUIHwgbnVsbD4geyByZXR1cm4gKGF3YWl0IHRoaXMubmV4dChzaXplLCAncmVhZCcpKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBhc3luYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUIHwgbnVsbD4geyByZXR1cm4gKGF3YWl0IHRoaXMubmV4dChzaXplLCAncGVlaycpKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBhc3luYyBuZXh0KHNpemU/OiBudW1iZXIgfCBudWxsLCBjbWQ6ICdwZWVrJyB8ICdyZWFkJyA9ICdyZWFkJykgeyByZXR1cm4gKGF3YWl0IHRoaXMuc291cmNlLm5leHQoeyBjbWQsIHNpemUgfSkpOyB9XG4gICAgcHVibGljIGFzeW5jIHRocm93KHZhbHVlPzogYW55KSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9ICh0aGlzLnNvdXJjZS50aHJvdyAmJiBhd2FpdCB0aGlzLnNvdXJjZS50aHJvdyh2YWx1ZSkpIHx8IElURVJBVE9SX0RPTkU7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlICYmIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKCk7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShyZXN1bHQpO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgcmV0dXJuKHZhbHVlPzogYW55KSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9ICh0aGlzLnNvdXJjZS5yZXR1cm4gJiYgYXdhaXQgdGhpcy5zb3VyY2UucmV0dXJuKHZhbHVlKSkgfHwgSVRFUkFUT1JfRE9ORTtcbiAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgJiYgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUoKTtcbiAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgPSB1bmRlZmluZWQ7XG4gICAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKHJlc3VsdCk7XG4gICAgfVxufVxuIl19
