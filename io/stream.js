"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const adapters_1 = require("./adapters");
const utf8_1 = require("../util/utf8");
const interfaces_1 = require("./interfaces");
const buffer_1 = require("../util/buffer");
const compat_1 = require("../util/compat");
/** @ignore */
class AsyncByteQueue extends interfaces_1.AsyncQueue {
    write(value) {
        if ((value = buffer_1.toUint8Array(value)).byteLength > 0) {
            return super.write(value);
        }
    }
    toString(sync = false) {
        return sync
            ? utf8_1.decodeUtf8(this.toUint8Array(true))
            : this.toUint8Array(false).then(utf8_1.decodeUtf8);
    }
    toUint8Array(sync = false) {
        return sync ? buffer_1.joinUint8Arrays(this._values)[0] : (async () => {
            let buffers = [], byteLength = 0;
            for await (const chunk of this) {
                buffers.push(chunk);
                byteLength += chunk.byteLength;
            }
            return buffer_1.joinUint8Arrays(buffers, byteLength)[0];
        })();
    }
}
exports.AsyncByteQueue = AsyncByteQueue;
/** @ignore */
class ByteStream {
    constructor(source) {
        if (source) {
            this.source = new ByteStreamSource(adapters_1.default.fromIterable(source));
        }
    }
    [Symbol.iterator]() { return this; }
    next(value) { return this.source.next(value); }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
exports.ByteStream = ByteStream;
/** @ignore */
class AsyncByteStream {
    constructor(source) {
        if (source instanceof AsyncByteStream) {
            this.source = source.source;
        }
        else if (source instanceof AsyncByteQueue) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isReadableNodeStream(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromNodeStream(source));
        }
        else if (compat_1.isFetchResponse(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromDOMStream(source.body));
        }
        else if (compat_1.isIterable(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromIterable(source));
        }
        else if (compat_1.isPromise(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isAsyncIterable(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isReadableDOMStream(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromDOMStream(source));
        }
    }
    [Symbol.asyncIterator]() { return this; }
    next(value) { return this.source.next(value); }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    get closed() { return this.source.closed; }
    cancel(reason) { return this.source.cancel(reason); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
exports.AsyncByteStream = AsyncByteStream;
/** @ignore */
class ByteStreamSource {
    constructor(source) {
        this.source = source;
    }
    cancel(reason) { this.return(reason); }
    peek(size) { return this.next(size, 'peek').value; }
    read(size) { return this.next(size, 'read').value; }
    next(size, cmd = 'read') { return this.source.next({ cmd, size }); }
    throw(value) { return Object.create((this.source.throw && this.source.throw(value)) || interfaces_1.ITERATOR_DONE); }
    return(value) { return Object.create((this.source.return && this.source.return(value)) || interfaces_1.ITERATOR_DONE); }
}
/** @ignore */
class AsyncByteStreamSource {
    constructor(source) {
        this.source = source;
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    async cancel(reason) { await this.return(reason); }
    get closed() { return this._closedPromise; }
    async read(size) { return (await this.next(size, 'read')).value; }
    async peek(size) { return (await this.next(size, 'peek')).value; }
    async next(size, cmd = 'read') { return (await this.source.next({ cmd, size })); }
    async throw(value) {
        const result = (this.source.throw && await this.source.throw(value)) || interfaces_1.ITERATOR_DONE;
        this._closedPromiseResolve && this._closedPromiseResolve();
        this._closedPromiseResolve = undefined;
        return Object.create(result);
    }
    async return(value) {
        const result = (this.source.return && await this.source.return(value)) || interfaces_1.ITERATOR_DONE;
        this._closedPromiseResolve && this._closedPromiseResolve();
        this._closedPromiseResolve = undefined;
        return Object.create(result);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSwwQkFBYSxDQUFDO1FBQ3hGLElBQUksQ0FBQyxxQkFBcUIsSUFBSSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUMzRCxJQUFJLENBQUMscUJBQXFCLEdBQUcsU0FBUyxDQUFDO1FBQ3ZDLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqQyxDQUFDO0NBQ0oiLCJmaWxlIjoiaW8vc3RyZWFtLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCBzdHJlYW1BZGFwdGVycyBmcm9tICcuL2FkYXB0ZXJzJztcbmltcG9ydCB7IGRlY29kZVV0ZjggfSBmcm9tICcuLi91dGlsL3V0ZjgnO1xuaW1wb3J0IHsgSVRFUkFUT1JfRE9ORSwgUmVhZGFibGUsIFdyaXRhYmxlLCBBc3luY1F1ZXVlIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IHRvVWludDhBcnJheSwgam9pblVpbnQ4QXJyYXlzLCBBcnJheUJ1ZmZlclZpZXdJbnB1dCB9IGZyb20gJy4uL3V0aWwvYnVmZmVyJztcblxuaW1wb3J0IHtcbiAgICBpc1Byb21pc2UsIGlzRmV0Y2hSZXNwb25zZSxcbiAgICBpc0l0ZXJhYmxlLCBpc0FzeW5jSXRlcmFibGUsXG4gICAgaXNSZWFkYWJsZURPTVN0cmVhbSwgaXNSZWFkYWJsZU5vZGVTdHJlYW1cbn0gZnJvbSAnLi4vdXRpbC9jb21wYXQnO1xuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IHR5cGUgV3JpdGFibGVTaW5rPFQ+ID0gV3JpdGFibGU8VD4gfCBXcml0YWJsZVN0cmVhbTxUPiB8IE5vZGVKUy5Xcml0YWJsZVN0cmVhbSB8IG51bGw7XG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IHR5cGUgUmVhZGFibGVTb3VyY2U8VD4gPSBSZWFkYWJsZTxUPiB8IFByb21pc2VMaWtlPFQ+IHwgQXN5bmNJdGVyYWJsZTxUPiB8IFJlYWRhYmxlU3RyZWFtPFQ+IHwgTm9kZUpTLlJlYWRhYmxlU3RyZWFtIHwgbnVsbDtcblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjbGFzcyBBc3luY0J5dGVRdWV1ZTxUIGV4dGVuZHMgQXJyYXlCdWZmZXJWaWV3SW5wdXQgPSBVaW50OEFycmF5PiBleHRlbmRzIEFzeW5jUXVldWU8VWludDhBcnJheSwgVD4ge1xuICAgIHB1YmxpYyB3cml0ZSh2YWx1ZTogQXJyYXlCdWZmZXJWaWV3SW5wdXQgfCBVaW50OEFycmF5KSB7XG4gICAgICAgIGlmICgodmFsdWUgPSB0b1VpbnQ4QXJyYXkodmFsdWUpKS5ieXRlTGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHN1cGVyLndyaXRlKHZhbHVlIGFzIFQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyB0b1N0cmluZyhzeW5jOiB0cnVlKTogc3RyaW5nO1xuICAgIHB1YmxpYyB0b1N0cmluZyhzeW5jPzogZmFsc2UpOiBQcm9taXNlPHN0cmluZz47XG4gICAgcHVibGljIHRvU3RyaW5nKHN5bmMgPSBmYWxzZSkge1xuICAgICAgICByZXR1cm4gc3luY1xuICAgICAgICAgICAgPyBkZWNvZGVVdGY4KHRoaXMudG9VaW50OEFycmF5KHRydWUpKVxuICAgICAgICAgICAgOiB0aGlzLnRvVWludDhBcnJheShmYWxzZSkudGhlbihkZWNvZGVVdGY4KTtcbiAgICB9XG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jOiB0cnVlKTogVWludDhBcnJheTtcbiAgICBwdWJsaWMgdG9VaW50OEFycmF5KHN5bmM/OiBmYWxzZSk6IFByb21pc2U8VWludDhBcnJheT47XG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jID0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuIHN5bmMgPyBqb2luVWludDhBcnJheXModGhpcy5fdmFsdWVzIGFzIGFueVtdKVswXSA6IChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBsZXQgYnVmZmVycyA9IFtdLCBieXRlTGVuZ3RoID0gMDtcbiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgdGhpcykge1xuICAgICAgICAgICAgICAgIGJ1ZmZlcnMucHVzaChjaHVuayk7XG4gICAgICAgICAgICAgICAgYnl0ZUxlbmd0aCArPSBjaHVuay5ieXRlTGVuZ3RoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGpvaW5VaW50OEFycmF5cyhidWZmZXJzLCBieXRlTGVuZ3RoKVswXTtcbiAgICAgICAgfSkoKTtcbiAgICB9XG59XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgY2xhc3MgQnl0ZVN0cmVhbSBpbXBsZW1lbnRzIEl0ZXJhYmxlSXRlcmF0b3I8VWludDhBcnJheT4ge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwcml2YXRlIHNvdXJjZTogQnl0ZVN0cmVhbVNvdXJjZTxVaW50OEFycmF5PjtcbiAgICBjb25zdHJ1Y3Rvcihzb3VyY2U/OiBJdGVyYWJsZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4gfCBBcnJheUJ1ZmZlclZpZXdJbnB1dCkge1xuICAgICAgICBpZiAoc291cmNlKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21JdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsgcmV0dXJuIHRoaXM7IH1cbiAgICBwdWJsaWMgbmV4dCh2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UubmV4dCh2YWx1ZSk7IH1cbiAgICBwdWJsaWMgdGhyb3codmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnRocm93KHZhbHVlKTsgfVxuICAgIHB1YmxpYyByZXR1cm4odmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJldHVybih2YWx1ZSk7IH1cbiAgICBwdWJsaWMgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCkgeyByZXR1cm4gdGhpcy5zb3VyY2UucGVlayhzaXplKTsgfVxuICAgIHB1YmxpYyByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKSB7IHJldHVybiB0aGlzLnNvdXJjZS5yZWFkKHNpemUpOyB9XG59XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgY2xhc3MgQXN5bmNCeXRlU3RyZWFtIGltcGxlbWVudHMgUmVhZGFibGU8VWludDhBcnJheT4sIEFzeW5jSXRlcmFibGVJdGVyYXRvcjxVaW50OEFycmF5PiB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHByaXZhdGUgc291cmNlOiBBc3luY0J5dGVTdHJlYW1Tb3VyY2U8VWludDhBcnJheT47XG4gICAgY29uc3RydWN0b3Ioc291cmNlPzogUHJvbWlzZUxpa2U8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+IHwgUmVzcG9uc2UgfCBSZWFkYWJsZVN0cmVhbTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4gfCBOb2RlSlMuUmVhZGFibGVTdHJlYW0gfCBBc3luY0l0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0PiB8IEl0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0Pikge1xuICAgICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgQXN5bmNCeXRlU3RyZWFtKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IChzb3VyY2UgYXMgQXN5bmNCeXRlU3RyZWFtKS5zb3VyY2U7XG4gICAgICAgIH0gZWxzZSBpZiAoc291cmNlIGluc3RhbmNlb2YgQXN5bmNCeXRlUXVldWUpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tQXN5bmNJdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc1JlYWRhYmxlTm9kZVN0cmVhbShzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbU5vZGVTdHJlYW0oc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNGZXRjaFJlc3BvbnNlKHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tRE9NU3RyZWFtKHNvdXJjZS5ib2R5ISkpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tSXRlcmFibGUoc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNQcm9taXNlPEFycmF5QnVmZmVyVmlld0lucHV0Pihzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbUFzeW5jSXRlcmFibGUoc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNBc3luY0l0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0Pihzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbUFzeW5jSXRlcmFibGUoc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNSZWFkYWJsZURPTVN0cmVhbTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4oc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21ET01TdHJlYW0oc291cmNlKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsgcmV0dXJuIHRoaXM7IH1cbiAgICBwdWJsaWMgbmV4dCh2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UubmV4dCh2YWx1ZSk7IH1cbiAgICBwdWJsaWMgdGhyb3codmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnRocm93KHZhbHVlKTsgfVxuICAgIHB1YmxpYyByZXR1cm4odmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJldHVybih2YWx1ZSk7IH1cbiAgICBwdWJsaWMgZ2V0IGNsb3NlZCgpOiBQcm9taXNlPHZvaWQ+IHsgcmV0dXJuIHRoaXMuc291cmNlLmNsb3NlZDsgfVxuICAgIHB1YmxpYyBjYW5jZWwocmVhc29uPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS5jYW5jZWwocmVhc29uKTsgfVxuICAgIHB1YmxpYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKSB7IHJldHVybiB0aGlzLnNvdXJjZS5wZWVrKHNpemUpOyB9XG4gICAgcHVibGljIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJlYWQoc2l6ZSk7IH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmludGVyZmFjZSBCeXRlU3RyZWFtU291cmNlSXRlcmF0b3I8VD4gZXh0ZW5kcyBJdGVyYWJsZUl0ZXJhdG9yPFQ+IHtcbiAgICBuZXh0KHZhbHVlPzogeyBjbWQ6ICdwZWVrJyB8ICdyZWFkJywgc2l6ZT86IG51bWJlciB8IG51bGwgfSk6IEl0ZXJhdG9yUmVzdWx0PFQ+O1xufVxuXG4vKiogQGlnbm9yZSAqL1xuaW50ZXJmYWNlIEFzeW5jQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+IGV4dGVuZHMgQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFQ+IHtcbiAgICBuZXh0KHZhbHVlPzogeyBjbWQ6ICdwZWVrJyB8ICdyZWFkJywgc2l6ZT86IG51bWJlciB8IG51bGwgfSk6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8VD4+O1xufVxuXG4vKiogQGlnbm9yZSAqL1xuY2xhc3MgQnl0ZVN0cmVhbVNvdXJjZTxUPiB7XG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIHNvdXJjZTogQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+KSB7fVxuICAgIHB1YmxpYyBjYW5jZWwocmVhc29uPzogYW55KSB7IHRoaXMucmV0dXJuKHJlYXNvbik7IH1cbiAgICBwdWJsaWMgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCk6IFQgfCBudWxsIHsgcmV0dXJuIHRoaXMubmV4dChzaXplLCAncGVlaycpLnZhbHVlOyB9XG4gICAgcHVibGljIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpOiBUIHwgbnVsbCB7IHJldHVybiB0aGlzLm5leHQoc2l6ZSwgJ3JlYWQnKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBuZXh0KHNpemU/OiBudW1iZXIgfCBudWxsLCBjbWQ6ICdwZWVrJyB8ICdyZWFkJyA9ICdyZWFkJykgeyByZXR1cm4gdGhpcy5zb3VyY2UubmV4dCh7IGNtZCwgc2l6ZSB9KTsgfVxuICAgIHB1YmxpYyB0aHJvdyh2YWx1ZT86IGFueSkgeyByZXR1cm4gT2JqZWN0LmNyZWF0ZSgodGhpcy5zb3VyY2UudGhyb3cgJiYgdGhpcy5zb3VyY2UudGhyb3codmFsdWUpKSB8fCBJVEVSQVRPUl9ET05FKTsgfVxuICAgIHB1YmxpYyByZXR1cm4odmFsdWU/OiBhbnkpIHsgcmV0dXJuIE9iamVjdC5jcmVhdGUoKHRoaXMuc291cmNlLnJldHVybiAmJiB0aGlzLnNvdXJjZS5yZXR1cm4odmFsdWUpKSB8fCBJVEVSQVRPUl9ET05FKTsgfVxufVxuXG4vKiogQGlnbm9yZSAqL1xuY2xhc3MgQXN5bmNCeXRlU3RyZWFtU291cmNlPFQ+IGltcGxlbWVudHMgUmVhZGFibGU8VD4ge1xuXG4gICAgcHJpdmF0ZSBfY2xvc2VkUHJvbWlzZTogUHJvbWlzZTx2b2lkPjtcbiAgICBwcml2YXRlIF9jbG9zZWRQcm9taXNlUmVzb2x2ZT86ICh2YWx1ZT86IGFueSkgPT4gdm9pZDtcbiAgICBjb25zdHJ1Y3RvciAocHJvdGVjdGVkIHNvdXJjZTogQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+IHwgQXN5bmNCeXRlU3RyZWFtU291cmNlSXRlcmF0b3I8VD4pIHtcbiAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyKSA9PiB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSA9IHIpO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgY2FuY2VsKHJlYXNvbj86IGFueSkgeyBhd2FpdCB0aGlzLnJldHVybihyZWFzb24pOyB9XG4gICAgcHVibGljIGdldCBjbG9zZWQoKTogUHJvbWlzZTx2b2lkPiB7IHJldHVybiB0aGlzLl9jbG9zZWRQcm9taXNlOyB9XG4gICAgcHVibGljIGFzeW5jIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPFQgfCBudWxsPiB7IHJldHVybiAoYXdhaXQgdGhpcy5uZXh0KHNpemUsICdyZWFkJykpLnZhbHVlOyB9XG4gICAgcHVibGljIGFzeW5jIHBlZWsoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPFQgfCBudWxsPiB7IHJldHVybiAoYXdhaXQgdGhpcy5uZXh0KHNpemUsICdwZWVrJykpLnZhbHVlOyB9XG4gICAgcHVibGljIGFzeW5jIG5leHQoc2l6ZT86IG51bWJlciB8IG51bGwsIGNtZDogJ3BlZWsnIHwgJ3JlYWQnID0gJ3JlYWQnKSB7IHJldHVybiAoYXdhaXQgdGhpcy5zb3VyY2UubmV4dCh7IGNtZCwgc2l6ZSB9KSk7IH1cbiAgICBwdWJsaWMgYXN5bmMgdGhyb3codmFsdWU/OiBhbnkpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gKHRoaXMuc291cmNlLnRocm93ICYmIGF3YWl0IHRoaXMuc291cmNlLnRocm93KHZhbHVlKSkgfHwgSVRFUkFUT1JfRE9ORTtcbiAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgJiYgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUoKTtcbiAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgPSB1bmRlZmluZWQ7XG4gICAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKHJlc3VsdCk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyByZXR1cm4odmFsdWU/OiBhbnkpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gKHRoaXMuc291cmNlLnJldHVybiAmJiBhd2FpdCB0aGlzLnNvdXJjZS5yZXR1cm4odmFsdWUpKSB8fCBJVEVSQVRPUl9ET05FO1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSAmJiB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSgpO1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5jcmVhdGUocmVzdWx0KTtcbiAgICB9XG59XG4iXX0=
