"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const adapters_1 = require("./adapters");
const utf8_1 = require("../util/utf8");
const interfaces_1 = require("./interfaces");
const buffer_1 = require("../util/buffer");
const compat_1 = require("../util/compat");
/**
 * @ignore
 */
class AsyncByteQueue extends interfaces_1.AsyncQueue {
    write(value) {
        if ((value = buffer_1.toUint8Array(value)).byteLength > 0) {
            return super.write(value);
        }
    }
    toString(sync = false) {
        return sync
            ? utf8_1.decodeUtf8(this.toUint8Array(true))
            : this.toUint8Array(false).then(utf8_1.decodeUtf8);
    }
    toUint8Array(sync = false) {
        return sync ? buffer_1.joinUint8Arrays(this._values.slice())[0] : (() => tslib_1.__awaiter(this, void 0, void 0, function* () {
            var e_1, _a;
            let buffers = [], byteLength = 0;
            try {
                for (var _b = tslib_1.__asyncValues(this), _c; _c = yield _b.next(), !_c.done;) {
                    const chunk = _c.value;
                    buffers.push(chunk);
                    byteLength += chunk.byteLength;
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) yield _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
            return buffer_1.joinUint8Arrays(buffers, byteLength)[0];
        }))();
    }
}
exports.AsyncByteQueue = AsyncByteQueue;
/**
 * @ignore
 */
class ByteStream {
    constructor(source) {
        if (source) {
            this.source = new ByteStreamSource(adapters_1.default.fromIterable(source));
        }
    }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
exports.ByteStream = ByteStream;
/**
 * @ignore
 */
class AsyncByteStream {
    constructor(source) {
        if (source instanceof AsyncByteStream) {
            this.source = source.source;
        }
        else if (source instanceof AsyncByteQueue) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isReadableNodeStream(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromReadableNodeStream(source));
        }
        else if (compat_1.isFetchResponse(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromReadableDOMStream(source.body));
        }
        else if (compat_1.isIterable(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromIterable(source));
        }
        else if (compat_1.isPromise(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isAsyncIterable(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isReadableDOMStream(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromReadableDOMStream(source));
        }
    }
    next(value) { return this.source.next(value); }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    get closed() { return this.source.closed; }
    cancel(reason) { return this.source.cancel(reason); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
exports.AsyncByteStream = AsyncByteStream;
class ByteStreamSource {
    constructor(source) {
        this.source = source;
    }
    cancel(reason) { this.return(reason); }
    peek(size) { return this.next(size, 'peek').value; }
    read(size) { return this.next(size, 'read').value; }
    next(size, cmd = 'read') { return this.source.next({ cmd, size }); }
    throw(value) { return Object.create((this.source.throw && this.source.throw(value)) || interfaces_1.ITERATOR_DONE); }
    return(value) { return Object.create((this.source.return && this.source.return(value)) || interfaces_1.ITERATOR_DONE); }
}
class AsyncByteStreamSource {
    constructor(source) {
        this.source = source;
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    cancel(reason) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.return(reason); });
    }
    get closed() { return this._closedPromise; }
    read(size) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.next(size, 'read')).value; });
    }
    peek(size) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.next(size, 'peek')).value; });
    }
    next(size, cmd = 'read') {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.source.next({ cmd, size })); });
    }
    throw(value) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const result = (this.source.throw && (yield this.source.throw(value))) || interfaces_1.ITERATOR_DONE;
            this._closedPromiseResolve && this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
            return Object.create(result);
        });
    }
    return(value) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const result = (this.source.return && (yield this.source.return(value))) || interfaces_1.ITERATOR_DONE;
            this._closedPromiseResolve && this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
            return Object.create(result);
        });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QXFCLEdBQUcsU0FBUyxDQUFDO1lBQ3ZDLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNqQyxDQUFDO0tBQUE7Q0FDSiIsImZpbGUiOiJpby9zdHJlYW0uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHN0cmVhbUFkYXB0ZXJzIGZyb20gJy4vYWRhcHRlcnMnO1xuaW1wb3J0IHsgZGVjb2RlVXRmOCB9IGZyb20gJy4uL3V0aWwvdXRmOCc7XG5pbXBvcnQgeyBJVEVSQVRPUl9ET05FLCBSZWFkYWJsZSwgV3JpdGFibGUsIEFzeW5jUXVldWUgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgdG9VaW50OEFycmF5LCBqb2luVWludDhBcnJheXMsIEFycmF5QnVmZmVyVmlld0lucHV0IH0gZnJvbSAnLi4vdXRpbC9idWZmZXInO1xuXG5pbXBvcnQge1xuICAgIGlzUHJvbWlzZSwgaXNGZXRjaFJlc3BvbnNlLFxuICAgIGlzSXRlcmFibGUsIGlzQXN5bmNJdGVyYWJsZSxcbiAgICBpc1JlYWRhYmxlRE9NU3RyZWFtLCBpc1JlYWRhYmxlTm9kZVN0cmVhbVxufSBmcm9tICcuLi91dGlsL2NvbXBhdCc7XG5cbmV4cG9ydCB0eXBlIFdyaXRhYmxlU2luazxUPiA9IFdyaXRhYmxlPFQ+IHwgV3JpdGFibGVTdHJlYW08VD4gfCBOb2RlSlMuV3JpdGFibGVTdHJlYW0gfCBudWxsO1xuZXhwb3J0IHR5cGUgUmVhZGFibGVTb3VyY2U8VD4gPSBSZWFkYWJsZTxUPiB8IFByb21pc2VMaWtlPFQ+IHwgQXN5bmNJdGVyYWJsZTxUPiB8IFJlYWRhYmxlU3RyZWFtPFQ+IHwgTm9kZUpTLlJlYWRhYmxlU3RyZWFtIHwgbnVsbDtcblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBjbGFzcyBBc3luY0J5dGVRdWV1ZTxUIGV4dGVuZHMgQXJyYXlCdWZmZXJWaWV3SW5wdXQgPSBVaW50OEFycmF5PiBleHRlbmRzIEFzeW5jUXVldWU8VWludDhBcnJheSwgVD4ge1xuICAgIHB1YmxpYyB3cml0ZSh2YWx1ZTogQXJyYXlCdWZmZXJWaWV3SW5wdXQgfCBVaW50OEFycmF5KSB7XG4gICAgICAgIGlmICgodmFsdWUgPSB0b1VpbnQ4QXJyYXkodmFsdWUpKS5ieXRlTGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHN1cGVyLndyaXRlKHZhbHVlIGFzIFQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyB0b1N0cmluZyhzeW5jOiB0cnVlKTogc3RyaW5nO1xuICAgIHB1YmxpYyB0b1N0cmluZyhzeW5jPzogZmFsc2UpOiBQcm9taXNlPHN0cmluZz47XG4gICAgcHVibGljIHRvU3RyaW5nKHN5bmMgPSBmYWxzZSkge1xuICAgICAgICByZXR1cm4gc3luY1xuICAgICAgICAgICAgPyBkZWNvZGVVdGY4KHRoaXMudG9VaW50OEFycmF5KHRydWUpKVxuICAgICAgICAgICAgOiB0aGlzLnRvVWludDhBcnJheShmYWxzZSkudGhlbihkZWNvZGVVdGY4KTtcbiAgICB9XG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jOiB0cnVlKTogVWludDhBcnJheTtcbiAgICBwdWJsaWMgdG9VaW50OEFycmF5KHN5bmM/OiBmYWxzZSk6IFByb21pc2U8VWludDhBcnJheT47XG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jID0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuIHN5bmMgPyBqb2luVWludDhBcnJheXMoKHRoaXMuX3ZhbHVlcyBhcyBhbnlbXSkuc2xpY2UoKSlbMF0gOiAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgbGV0IGJ1ZmZlcnMgPSBbXSwgYnl0ZUxlbmd0aCA9IDA7XG4gICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIHRoaXMpIHtcbiAgICAgICAgICAgICAgICBidWZmZXJzLnB1c2goY2h1bmspO1xuICAgICAgICAgICAgICAgIGJ5dGVMZW5ndGggKz0gY2h1bmsuYnl0ZUxlbmd0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBqb2luVWludDhBcnJheXMoYnVmZmVycywgYnl0ZUxlbmd0aClbMF07XG4gICAgICAgIH0pKCk7XG4gICAgfVxufVxuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGNsYXNzIEJ5dGVTdHJlYW0ge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwcml2YXRlIHNvdXJjZTogQnl0ZVN0cmVhbVNvdXJjZTxVaW50OEFycmF5IHwgbnVsbD47XG4gICAgY29uc3RydWN0b3Ioc291cmNlPzogSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+IHwgQXJyYXlCdWZmZXJWaWV3SW5wdXQpIHtcbiAgICAgICAgaWYgKHNvdXJjZSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tSXRlcmFibGUoc291cmNlKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIHRocm93KHZhbHVlPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS50aHJvdyh2YWx1ZSk7IH1cbiAgICBwdWJsaWMgcmV0dXJuKHZhbHVlPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS5yZXR1cm4odmFsdWUpOyB9XG4gICAgcHVibGljIHBlZWsoc2l6ZT86IG51bWJlciB8IG51bGwpIHsgcmV0dXJuIHRoaXMuc291cmNlLnBlZWsoc2l6ZSk7IH1cbiAgICBwdWJsaWMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCkgeyByZXR1cm4gdGhpcy5zb3VyY2UucmVhZChzaXplKTsgfVxufVxuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGNsYXNzIEFzeW5jQnl0ZVN0cmVhbSBpbXBsZW1lbnRzIFJlYWRhYmxlPFVpbnQ4QXJyYXk+IHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJpdmF0ZSBzb3VyY2U6IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZTxVaW50OEFycmF5PjtcbiAgICBjb25zdHJ1Y3Rvcihzb3VyY2U/OiBQcm9taXNlTGlrZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4gfCBSZXNwb25zZSB8IFJlYWRhYmxlU3RyZWFtPEFycmF5QnVmZmVyVmlld0lucHV0PiB8IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSB8IEFzeW5jSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+IHwgSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KSB7XG4gICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBBc3luY0J5dGVTdHJlYW0pIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gKHNvdXJjZSBhcyBBc3luY0J5dGVTdHJlYW0pLnNvdXJjZTtcbiAgICAgICAgfSBlbHNlIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBBc3luY0J5dGVRdWV1ZSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21Bc3luY0l0ZXJhYmxlKHNvdXJjZSkpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzUmVhZGFibGVOb2RlU3RyZWFtKHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tUmVhZGFibGVOb2RlU3RyZWFtKHNvdXJjZSkpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzRmV0Y2hSZXNwb25zZShzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbVJlYWRhYmxlRE9NU3RyZWFtKHNvdXJjZS5ib2R5ISkpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzSXRlcmFibGU8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tSXRlcmFibGUoc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNQcm9taXNlPEFycmF5QnVmZmVyVmlld0lucHV0Pihzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbUFzeW5jSXRlcmFibGUoc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNBc3luY0l0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0Pihzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbUFzeW5jSXRlcmFibGUoc291cmNlKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNSZWFkYWJsZURPTVN0cmVhbTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4oc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21SZWFkYWJsZURPTVN0cmVhbShzb3VyY2UpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgbmV4dCh2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UubmV4dCh2YWx1ZSk7IH1cbiAgICBwdWJsaWMgdGhyb3codmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnRocm93KHZhbHVlKTsgfVxuICAgIHB1YmxpYyByZXR1cm4odmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJldHVybih2YWx1ZSk7IH1cbiAgICBwdWJsaWMgZ2V0IGNsb3NlZCgpOiBQcm9taXNlPHZvaWQ+IHsgcmV0dXJuIHRoaXMuc291cmNlLmNsb3NlZDsgfVxuICAgIHB1YmxpYyBjYW5jZWwocmVhc29uPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS5jYW5jZWwocmVhc29uKTsgfVxuICAgIHB1YmxpYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKSB7IHJldHVybiB0aGlzLnNvdXJjZS5wZWVrKHNpemUpOyB9XG4gICAgcHVibGljIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJlYWQoc2l6ZSk7IH1cbn1cblxuaW50ZXJmYWNlIEJ5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPiBleHRlbmRzIEl0ZXJhYmxlSXRlcmF0b3I8VD4ge1xuICAgIG5leHQodmFsdWU/OiB7IGNtZDogJ3BlZWsnIHwgJ3JlYWQnLCBzaXplPzogbnVtYmVyIHwgbnVsbCB9KTogSXRlcmF0b3JSZXN1bHQ8VD47XG59XG5cbmludGVyZmFjZSBBc3luY0J5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPiBleHRlbmRzIEFzeW5jSXRlcmFibGVJdGVyYXRvcjxUPiB7XG4gICAgbmV4dCh2YWx1ZT86IHsgY21kOiAncGVlaycgfCAncmVhZCcsIHNpemU/OiBudW1iZXIgfCBudWxsIH0pOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFQ+Pjtcbn1cblxuY2xhc3MgQnl0ZVN0cmVhbVNvdXJjZTxUPiB7XG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIHNvdXJjZTogQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+KSB7fVxuICAgIHB1YmxpYyBjYW5jZWwocmVhc29uPzogYW55KSB7IHRoaXMucmV0dXJuKHJlYXNvbik7IH1cbiAgICBwdWJsaWMgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCk6IFQgfCBudWxsIHsgcmV0dXJuIHRoaXMubmV4dChzaXplLCAncGVlaycpLnZhbHVlOyB9XG4gICAgcHVibGljIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpOiBUIHwgbnVsbCB7IHJldHVybiB0aGlzLm5leHQoc2l6ZSwgJ3JlYWQnKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBuZXh0KHNpemU/OiBudW1iZXIgfCBudWxsLCBjbWQ6ICdwZWVrJyB8ICdyZWFkJyA9ICdyZWFkJykgeyByZXR1cm4gdGhpcy5zb3VyY2UubmV4dCh7IGNtZCwgc2l6ZSB9KTsgfVxuICAgIHB1YmxpYyB0aHJvdyh2YWx1ZT86IGFueSkgeyByZXR1cm4gT2JqZWN0LmNyZWF0ZSgodGhpcy5zb3VyY2UudGhyb3cgJiYgdGhpcy5zb3VyY2UudGhyb3codmFsdWUpKSB8fCBJVEVSQVRPUl9ET05FKTsgfVxuICAgIHB1YmxpYyByZXR1cm4odmFsdWU/OiBhbnkpIHsgcmV0dXJuIE9iamVjdC5jcmVhdGUoKHRoaXMuc291cmNlLnJldHVybiAmJiB0aGlzLnNvdXJjZS5yZXR1cm4odmFsdWUpKSB8fCBJVEVSQVRPUl9ET05FKTsgfVxufVxuXG5jbGFzcyBBc3luY0J5dGVTdHJlYW1Tb3VyY2U8VD4gaW1wbGVtZW50cyBSZWFkYWJsZTxUPiB7XG5cbiAgICBwcml2YXRlIF9jbG9zZWRQcm9taXNlOiBQcm9taXNlPHZvaWQ+O1xuICAgIHByaXZhdGUgX2Nsb3NlZFByb21pc2VSZXNvbHZlPzogKHZhbHVlPzogYW55KSA9PiB2b2lkO1xuICAgIGNvbnN0cnVjdG9yIChwcm90ZWN0ZWQgc291cmNlOiBCeXRlU3RyZWFtU291cmNlSXRlcmF0b3I8VD4gfCBBc3luY0J5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPikge1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlID0gbmV3IFByb21pc2UoKHIpID0+IHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gcik7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyBjYW5jZWwocmVhc29uPzogYW55KSB7IGF3YWl0IHRoaXMucmV0dXJuKHJlYXNvbik7IH1cbiAgICBwdWJsaWMgZ2V0IGNsb3NlZCgpOiBQcm9taXNlPHZvaWQ+IHsgcmV0dXJuIHRoaXMuX2Nsb3NlZFByb21pc2U7IH1cbiAgICBwdWJsaWMgYXN5bmMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VCB8IG51bGw+IHsgcmV0dXJuIChhd2FpdCB0aGlzLm5leHQoc2l6ZSwgJ3JlYWQnKSkudmFsdWU7IH1cbiAgICBwdWJsaWMgYXN5bmMgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VCB8IG51bGw+IHsgcmV0dXJuIChhd2FpdCB0aGlzLm5leHQoc2l6ZSwgJ3BlZWsnKSkudmFsdWU7IH1cbiAgICBwdWJsaWMgYXN5bmMgbmV4dChzaXplPzogbnVtYmVyIHwgbnVsbCwgY21kOiAncGVlaycgfCAncmVhZCcgPSAncmVhZCcpIHsgcmV0dXJuIChhd2FpdCB0aGlzLnNvdXJjZS5uZXh0KHsgY21kLCBzaXplIH0pKTsgfVxuICAgIHB1YmxpYyBhc3luYyB0aHJvdyh2YWx1ZT86IGFueSkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSAodGhpcy5zb3VyY2UudGhyb3cgJiYgYXdhaXQgdGhpcy5zb3VyY2UudGhyb3codmFsdWUpKSB8fCBJVEVSQVRPUl9ET05FO1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSAmJiB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSgpO1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5jcmVhdGUocmVzdWx0KTtcbiAgICB9XG4gICAgcHVibGljIGFzeW5jIHJldHVybih2YWx1ZT86IGFueSkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSAodGhpcy5zb3VyY2UucmV0dXJuICYmIGF3YWl0IHRoaXMuc291cmNlLnJldHVybih2YWx1ZSkpIHx8IElURVJBVE9SX0RPTkU7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlICYmIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKCk7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShyZXN1bHQpO1xuICAgIH1cbn1cbiJdfQ==
