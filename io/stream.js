"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const adapters_1 = require("./adapters");
const utf8_1 = require("../util/utf8");
const interfaces_1 = require("./interfaces");
const buffer_1 = require("../util/buffer");
const compat_1 = require("../util/compat");
/** @ignore */
class AsyncByteQueue extends interfaces_1.AsyncQueue {
    write(value) {
        if ((value = buffer_1.toUint8Array(value)).byteLength > 0) {
            return super.write(value);
        }
    }
    toString(sync = false) {
        return sync
            ? utf8_1.decodeUtf8(this.toUint8Array(true))
            : this.toUint8Array(false).then(utf8_1.decodeUtf8);
    }
    toUint8Array(sync = false) {
        return sync ? buffer_1.joinUint8Arrays(this._values.slice())[0] : (() => tslib_1.__awaiter(this, void 0, void 0, function* () {
            var e_1, _a;
            let buffers = [], byteLength = 0;
            try {
                for (var _b = tslib_1.__asyncValues(this), _c; _c = yield _b.next(), !_c.done;) {
                    const chunk = _c.value;
                    buffers.push(chunk);
                    byteLength += chunk.byteLength;
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) yield _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
            return buffer_1.joinUint8Arrays(buffers, byteLength)[0];
        }))();
    }
}
exports.AsyncByteQueue = AsyncByteQueue;
/** @ignore */
class ByteStream {
    constructor(source) {
        if (source) {
            this.source = new ByteStreamSource(adapters_1.default.fromIterable(source));
        }
    }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
exports.ByteStream = ByteStream;
/** @ignore */
class AsyncByteStream {
    constructor(source) {
        if (source instanceof AsyncByteStream) {
            this.source = source.source;
        }
        else if (source instanceof AsyncByteQueue) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isReadableNodeStream(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromReadableNodeStream(source));
        }
        else if (compat_1.isFetchResponse(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromReadableDOMStream(source.body));
        }
        else if (compat_1.isIterable(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromIterable(source));
        }
        else if (compat_1.isPromise(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isAsyncIterable(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromAsyncIterable(source));
        }
        else if (compat_1.isReadableDOMStream(source)) {
            this.source = new AsyncByteStreamSource(adapters_1.default.fromReadableDOMStream(source));
        }
    }
    next(value) { return this.source.next(value); }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    get closed() { return this.source.closed; }
    cancel(reason) { return this.source.cancel(reason); }
    peek(size) { return this.source.peek(size); }
    read(size) { return this.source.read(size); }
}
exports.AsyncByteStream = AsyncByteStream;
/** @ignore */
class ByteStreamSource {
    constructor(source) {
        this.source = source;
    }
    cancel(reason) { this.return(reason); }
    peek(size) { return this.next(size, 'peek').value; }
    read(size) { return this.next(size, 'read').value; }
    next(size, cmd = 'read') { return this.source.next({ cmd, size }); }
    throw(value) { return Object.create((this.source.throw && this.source.throw(value)) || interfaces_1.ITERATOR_DONE); }
    return(value) { return Object.create((this.source.return && this.source.return(value)) || interfaces_1.ITERATOR_DONE); }
}
/** @ignore */
class AsyncByteStreamSource {
    constructor(source) {
        this.source = source;
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    cancel(reason) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.return(reason); });
    }
    get closed() { return this._closedPromise; }
    read(size) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.next(size, 'read')).value; });
    }
    peek(size) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.next(size, 'peek')).value; });
    }
    next(size, cmd = 'read') {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { return (yield this.source.next({ cmd, size })); });
    }
    throw(value) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const result = (this.source.throw && (yield this.source.throw(value))) || interfaces_1.ITERATOR_DONE;
            this._closedPromiseResolve && this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
            return Object.create(result);
        });
    }
    return(value) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const result = (this.source.return && (yield this.source.return(value))) || interfaces_1.ITERATOR_DONE;
            this._closedPromiseResolve && this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
            return Object.create(result);
        });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QzNELElBQUksQ0FBQyxxQkFBcUIsR0FBRyxTQUFTLENBQUM7WUFDdkMsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2pDLENBQUM7S0FBQTtDQUNKIiwiZmlsZSI6ImlvL3N0cmVhbS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgc3RyZWFtQWRhcHRlcnMgZnJvbSAnLi9hZGFwdGVycyc7XG5pbXBvcnQgeyBkZWNvZGVVdGY4IH0gZnJvbSAnLi4vdXRpbC91dGY4JztcbmltcG9ydCB7IElURVJBVE9SX0RPTkUsIFJlYWRhYmxlLCBXcml0YWJsZSwgQXN5bmNRdWV1ZSB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyB0b1VpbnQ4QXJyYXksIGpvaW5VaW50OEFycmF5cywgQXJyYXlCdWZmZXJWaWV3SW5wdXQgfSBmcm9tICcuLi91dGlsL2J1ZmZlcic7XG5cbmltcG9ydCB7XG4gICAgaXNQcm9taXNlLCBpc0ZldGNoUmVzcG9uc2UsXG4gICAgaXNJdGVyYWJsZSwgaXNBc3luY0l0ZXJhYmxlLFxuICAgIGlzUmVhZGFibGVET01TdHJlYW0sIGlzUmVhZGFibGVOb2RlU3RyZWFtXG59IGZyb20gJy4uL3V0aWwvY29tcGF0JztcblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCB0eXBlIFdyaXRhYmxlU2luazxUPiA9IFdyaXRhYmxlPFQ+IHwgV3JpdGFibGVTdHJlYW08VD4gfCBOb2RlSlMuV3JpdGFibGVTdHJlYW0gfCBudWxsO1xuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCB0eXBlIFJlYWRhYmxlU291cmNlPFQ+ID0gUmVhZGFibGU8VD4gfCBQcm9taXNlTGlrZTxUPiB8IEFzeW5jSXRlcmFibGU8VD4gfCBSZWFkYWJsZVN0cmVhbTxUPiB8IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSB8IG51bGw7XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgY2xhc3MgQXN5bmNCeXRlUXVldWU8VCBleHRlbmRzIEFycmF5QnVmZmVyVmlld0lucHV0ID0gVWludDhBcnJheT4gZXh0ZW5kcyBBc3luY1F1ZXVlPFVpbnQ4QXJyYXksIFQ+IHtcbiAgICBwdWJsaWMgd3JpdGUodmFsdWU6IEFycmF5QnVmZmVyVmlld0lucHV0IHwgVWludDhBcnJheSkge1xuICAgICAgICBpZiAoKHZhbHVlID0gdG9VaW50OEFycmF5KHZhbHVlKSkuYnl0ZUxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiBzdXBlci53cml0ZSh2YWx1ZSBhcyBUKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgdG9TdHJpbmcoc3luYzogdHJ1ZSk6IHN0cmluZztcbiAgICBwdWJsaWMgdG9TdHJpbmcoc3luYz86IGZhbHNlKTogUHJvbWlzZTxzdHJpbmc+O1xuICAgIHB1YmxpYyB0b1N0cmluZyhzeW5jID0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuIHN5bmNcbiAgICAgICAgICAgID8gZGVjb2RlVXRmOCh0aGlzLnRvVWludDhBcnJheSh0cnVlKSlcbiAgICAgICAgICAgIDogdGhpcy50b1VpbnQ4QXJyYXkoZmFsc2UpLnRoZW4oZGVjb2RlVXRmOCk7XG4gICAgfVxuICAgIHB1YmxpYyB0b1VpbnQ4QXJyYXkoc3luYzogdHJ1ZSk6IFVpbnQ4QXJyYXk7XG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jPzogZmFsc2UpOiBQcm9taXNlPFVpbnQ4QXJyYXk+O1xuICAgIHB1YmxpYyB0b1VpbnQ4QXJyYXkoc3luYyA9IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBzeW5jID8gam9pblVpbnQ4QXJyYXlzKCh0aGlzLl92YWx1ZXMgYXMgYW55W10pLnNsaWNlKCkpWzBdIDogKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGxldCBidWZmZXJzID0gW10sIGJ5dGVMZW5ndGggPSAwO1xuICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiB0aGlzKSB7XG4gICAgICAgICAgICAgICAgYnVmZmVycy5wdXNoKGNodW5rKTtcbiAgICAgICAgICAgICAgICBieXRlTGVuZ3RoICs9IGNodW5rLmJ5dGVMZW5ndGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gam9pblVpbnQ4QXJyYXlzKGJ1ZmZlcnMsIGJ5dGVMZW5ndGgpWzBdO1xuICAgICAgICB9KSgpO1xuICAgIH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjbGFzcyBCeXRlU3RyZWFtIHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJpdmF0ZSBzb3VyY2U6IEJ5dGVTdHJlYW1Tb3VyY2U8VWludDhBcnJheSB8IG51bGw+O1xuICAgIGNvbnN0cnVjdG9yKHNvdXJjZT86IEl0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0PiB8IEFycmF5QnVmZmVyVmlld0lucHV0KSB7XG4gICAgICAgIGlmIChzb3VyY2UpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEJ5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbUl0ZXJhYmxlKHNvdXJjZSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyB0aHJvdyh2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UudGhyb3codmFsdWUpOyB9XG4gICAgcHVibGljIHJldHVybih2YWx1ZT86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UucmV0dXJuKHZhbHVlKTsgfVxuICAgIHB1YmxpYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKSB7IHJldHVybiB0aGlzLnNvdXJjZS5wZWVrKHNpemUpOyB9XG4gICAgcHVibGljIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJlYWQoc2l6ZSk7IH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjbGFzcyBBc3luY0J5dGVTdHJlYW0gaW1wbGVtZW50cyBSZWFkYWJsZTxVaW50OEFycmF5PiB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHByaXZhdGUgc291cmNlOiBBc3luY0J5dGVTdHJlYW1Tb3VyY2U8VWludDhBcnJheT47XG4gICAgY29uc3RydWN0b3Ioc291cmNlPzogUHJvbWlzZUxpa2U8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+IHwgUmVzcG9uc2UgfCBSZWFkYWJsZVN0cmVhbTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4gfCBOb2RlSlMuUmVhZGFibGVTdHJlYW0gfCBBc3luY0l0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0PiB8IEl0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0Pikge1xuICAgICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgQXN5bmNCeXRlU3RyZWFtKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IChzb3VyY2UgYXMgQXN5bmNCeXRlU3RyZWFtKS5zb3VyY2U7XG4gICAgICAgIH0gZWxzZSBpZiAoc291cmNlIGluc3RhbmNlb2YgQXN5bmNCeXRlUXVldWUpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tQXN5bmNJdGVyYWJsZShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc1JlYWRhYmxlTm9kZVN0cmVhbShzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbVJlYWRhYmxlTm9kZVN0cmVhbShzb3VyY2UpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0ZldGNoUmVzcG9uc2Uoc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21SZWFkYWJsZURPTVN0cmVhbShzb3VyY2UuYm9keSEpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0l0ZXJhYmxlPEFycmF5QnVmZmVyVmlld0lucHV0Pihzb3VyY2UpKSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ldyBBc3luY0J5dGVTdHJlYW1Tb3VyY2Uoc3RyZWFtQWRhcHRlcnMuZnJvbUl0ZXJhYmxlKHNvdXJjZSkpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzUHJvbWlzZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4oc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21Bc3luY0l0ZXJhYmxlKHNvdXJjZSkpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzQXN5bmNJdGVyYWJsZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4oc291cmNlKSkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXcgQXN5bmNCeXRlU3RyZWFtU291cmNlKHN0cmVhbUFkYXB0ZXJzLmZyb21Bc3luY0l0ZXJhYmxlKHNvdXJjZSkpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzUmVhZGFibGVET01TdHJlYW08QXJyYXlCdWZmZXJWaWV3SW5wdXQ+KHNvdXJjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gbmV3IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZShzdHJlYW1BZGFwdGVycy5mcm9tUmVhZGFibGVET01TdHJlYW0oc291cmNlKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIG5leHQodmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLm5leHQodmFsdWUpOyB9XG4gICAgcHVibGljIHRocm93KHZhbHVlPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS50aHJvdyh2YWx1ZSk7IH1cbiAgICBwdWJsaWMgcmV0dXJuKHZhbHVlPzogYW55KSB7IHJldHVybiB0aGlzLnNvdXJjZS5yZXR1cm4odmFsdWUpOyB9XG4gICAgcHVibGljIGdldCBjbG9zZWQoKTogUHJvbWlzZTx2b2lkPiB7IHJldHVybiB0aGlzLnNvdXJjZS5jbG9zZWQ7IH1cbiAgICBwdWJsaWMgY2FuY2VsKHJlYXNvbj86IGFueSkgeyByZXR1cm4gdGhpcy5zb3VyY2UuY2FuY2VsKHJlYXNvbik7IH1cbiAgICBwdWJsaWMgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCkgeyByZXR1cm4gdGhpcy5zb3VyY2UucGVlayhzaXplKTsgfVxuICAgIHB1YmxpYyByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKSB7IHJldHVybiB0aGlzLnNvdXJjZS5yZWFkKHNpemUpOyB9XG59XG5cbi8qKiBAaWdub3JlICovXG5pbnRlcmZhY2UgQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+IGV4dGVuZHMgSXRlcmFibGVJdGVyYXRvcjxUPiB7XG4gICAgbmV4dCh2YWx1ZT86IHsgY21kOiAncGVlaycgfCAncmVhZCcsIHNpemU/OiBudW1iZXIgfCBudWxsIH0pOiBJdGVyYXRvclJlc3VsdDxUPjtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmludGVyZmFjZSBBc3luY0J5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPiBleHRlbmRzIEFzeW5jSXRlcmFibGVJdGVyYXRvcjxUPiB7XG4gICAgbmV4dCh2YWx1ZT86IHsgY21kOiAncGVlaycgfCAncmVhZCcsIHNpemU/OiBudW1iZXIgfCBudWxsIH0pOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFQ+Pjtcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmNsYXNzIEJ5dGVTdHJlYW1Tb3VyY2U8VD4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBzb3VyY2U6IEJ5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPikge31cbiAgICBwdWJsaWMgY2FuY2VsKHJlYXNvbj86IGFueSkgeyB0aGlzLnJldHVybihyZWFzb24pOyB9XG4gICAgcHVibGljIHBlZWsoc2l6ZT86IG51bWJlciB8IG51bGwpOiBUIHwgbnVsbCB7IHJldHVybiB0aGlzLm5leHQoc2l6ZSwgJ3BlZWsnKS52YWx1ZTsgfVxuICAgIHB1YmxpYyByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKTogVCB8IG51bGwgeyByZXR1cm4gdGhpcy5uZXh0KHNpemUsICdyZWFkJykudmFsdWU7IH1cbiAgICBwdWJsaWMgbmV4dChzaXplPzogbnVtYmVyIHwgbnVsbCwgY21kOiAncGVlaycgfCAncmVhZCcgPSAncmVhZCcpIHsgcmV0dXJuIHRoaXMuc291cmNlLm5leHQoeyBjbWQsIHNpemUgfSk7IH1cbiAgICBwdWJsaWMgdGhyb3codmFsdWU/OiBhbnkpIHsgcmV0dXJuIE9iamVjdC5jcmVhdGUoKHRoaXMuc291cmNlLnRocm93ICYmIHRoaXMuc291cmNlLnRocm93KHZhbHVlKSkgfHwgSVRFUkFUT1JfRE9ORSk7IH1cbiAgICBwdWJsaWMgcmV0dXJuKHZhbHVlPzogYW55KSB7IHJldHVybiBPYmplY3QuY3JlYXRlKCh0aGlzLnNvdXJjZS5yZXR1cm4gJiYgdGhpcy5zb3VyY2UucmV0dXJuKHZhbHVlKSkgfHwgSVRFUkFUT1JfRE9ORSk7IH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmNsYXNzIEFzeW5jQnl0ZVN0cmVhbVNvdXJjZTxUPiBpbXBsZW1lbnRzIFJlYWRhYmxlPFQ+IHtcblxuICAgIHByaXZhdGUgX2Nsb3NlZFByb21pc2U6IFByb21pc2U8dm9pZD47XG4gICAgcHJpdmF0ZSBfY2xvc2VkUHJvbWlzZVJlc29sdmU/OiAodmFsdWU/OiBhbnkpID0+IHZvaWQ7XG4gICAgY29uc3RydWN0b3IgKHByb3RlY3RlZCBzb3VyY2U6IEJ5dGVTdHJlYW1Tb3VyY2VJdGVyYXRvcjxUPiB8IEFzeW5jQnl0ZVN0cmVhbVNvdXJjZUl0ZXJhdG9yPFQ+KSB7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocikgPT4gdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgPSByKTtcbiAgICB9XG4gICAgcHVibGljIGFzeW5jIGNhbmNlbChyZWFzb24/OiBhbnkpIHsgYXdhaXQgdGhpcy5yZXR1cm4ocmVhc29uKTsgfVxuICAgIHB1YmxpYyBnZXQgY2xvc2VkKCk6IFByb21pc2U8dm9pZD4geyByZXR1cm4gdGhpcy5fY2xvc2VkUHJvbWlzZTsgfVxuICAgIHB1YmxpYyBhc3luYyByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUIHwgbnVsbD4geyByZXR1cm4gKGF3YWl0IHRoaXMubmV4dChzaXplLCAncmVhZCcpKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBhc3luYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUIHwgbnVsbD4geyByZXR1cm4gKGF3YWl0IHRoaXMubmV4dChzaXplLCAncGVlaycpKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBhc3luYyBuZXh0KHNpemU/OiBudW1iZXIgfCBudWxsLCBjbWQ6ICdwZWVrJyB8ICdyZWFkJyA9ICdyZWFkJykgeyByZXR1cm4gKGF3YWl0IHRoaXMuc291cmNlLm5leHQoeyBjbWQsIHNpemUgfSkpOyB9XG4gICAgcHVibGljIGFzeW5jIHRocm93KHZhbHVlPzogYW55KSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9ICh0aGlzLnNvdXJjZS50aHJvdyAmJiBhd2FpdCB0aGlzLnNvdXJjZS50aHJvdyh2YWx1ZSkpIHx8IElURVJBVE9SX0RPTkU7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlICYmIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKCk7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShyZXN1bHQpO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgcmV0dXJuKHZhbHVlPzogYW55KSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9ICh0aGlzLnNvdXJjZS5yZXR1cm4gJiYgYXdhaXQgdGhpcy5zb3VyY2UucmV0dXJuKHZhbHVlKSkgfHwgSVRFUkFUT1JfRE9ORTtcbiAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgJiYgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUoKTtcbiAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgPSB1bmRlZmluZWQ7XG4gICAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKHJlc3VsdCk7XG4gICAgfVxufVxuIl19
