"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const stream_1 = require("./stream");
const buffer_1 = require("../util/buffer");
/** @ignore */
class RandomAccessFile extends stream_1.ByteStream {
    constructor(buffer, byteLength) {
        super();
        this.position = 0;
        this.buffer = buffer_1.toUint8Array(buffer);
        this.size = typeof byteLength === 'undefined' ? this.buffer.byteLength : byteLength;
    }
    readInt32(position) {
        const { buffer, byteOffset } = this.readAt(position, 4);
        return new DataView(buffer, byteOffset).getInt32(0, true);
    }
    seek(position) {
        this.position = Math.min(position, this.size);
        return position < this.size;
    }
    read(nBytes) {
        const { buffer, size, position } = this;
        if (buffer && position < size) {
            if (typeof nBytes !== 'number') {
                nBytes = Infinity;
            }
            this.position = Math.min(size, position + Math.min(size - position, nBytes));
            return buffer.subarray(position, this.position);
        }
        return null;
    }
    readAt(position, nBytes) {
        const buf = this.buffer;
        const end = Math.min(this.size, position + nBytes);
        return buf ? buf.subarray(position, end) : new Uint8Array(nBytes);
    }
    close() { this.buffer && (this.buffer = null); }
    throw(value) { this.close(); return { done: true, value }; }
    return(value) { this.close(); return { done: true, value }; }
}
exports.RandomAccessFile = RandomAccessFile;
/** @ignore */
class AsyncRandomAccessFile extends stream_1.AsyncByteStream {
    constructor(file, byteLength) {
        super();
        this.position = 0;
        this._handle = file;
        if (typeof byteLength === 'number') {
            this.size = byteLength;
        }
        else {
            this._pending = (() => tslib_1.__awaiter(this, void 0, void 0, function* () {
                delete this._pending;
                this.size = (yield file.stat()).size;
            }))();
        }
    }
    readInt32(position) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { buffer, byteOffset } = yield this.readAt(position, 4);
            return new DataView(buffer, byteOffset).getInt32(0, true);
        });
    }
    seek(position) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this._pending && (yield this._pending);
            this.position = Math.min(position, this.size);
            return position < this.size;
        });
    }
    read(nBytes) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this._pending && (yield this._pending);
            const { _handle: file, size, position } = this;
            if (file && position < size) {
                if (typeof nBytes !== 'number') {
                    nBytes = Infinity;
                }
                let pos = position, offset = 0, bytesRead = 0;
                let end = Math.min(size, pos + Math.min(size - pos, nBytes));
                let buffer = new Uint8Array(Math.max(0, (this.position = end) - pos));
                while ((pos += bytesRead) < end && (offset += bytesRead) < buffer.byteLength) {
                    ({ bytesRead } = yield file.read(buffer, offset, buffer.byteLength - offset, pos));
                }
                return buffer;
            }
            return null;
        });
    }
    readAt(position, nBytes) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this._pending && (yield this._pending);
            const { _handle: file, size } = this;
            if (file && (position + nBytes) < size) {
                const end = Math.min(size, position + nBytes);
                const buffer = new Uint8Array(end - position);
                return (yield file.read(buffer, 0, nBytes, position)).buffer;
            }
            return new Uint8Array(nBytes);
        });
    }
    close() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { const f = this._handle; this._handle = null; f && (yield f.close()); });
    }
    throw(value) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.close(); return { done: true, value }; });
    }
    return(value) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () { yield this.close(); return { done: true, value }; });
    }
}
exports.AsyncRandomAccessFile = AsyncRandomAccessFile;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImlvL2ZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDZEQUE2RDtBQUM3RCwrREFBK0Q7QUFDL0Qsd0RBQXdEO0FBQ3hELDZEQUE2RDtBQUM3RCxvREFBb0Q7QUFDcEQsNkRBQTZEO0FBQzdELDZEQUE2RDtBQUM3RCxFQUFFO0FBQ0YsK0NBQStDO0FBQy9DLEVBQUU7QUFDRiw2REFBNkQ7QUFDN0QsOERBQThEO0FBQzlELHlEQUF5RDtBQUN6RCw0REFBNEQ7QUFDNUQsMERBQTBEO0FBQzFELHFCQUFxQjs7O0FBR3JCLHFDQUF1RDtBQUN2RCwyQ0FBb0U7QUFFcEUsY0FBYztBQUNkLE1BQWEsZ0JBQWlCLFNBQVEsbUJBQVU7SUFJNUMsWUFBWSxNQUE0QixFQUFFLFVBQW1CO1FBQ3pELEtBQUssRUFBRSxDQUFDO1FBSEwsYUFBUSxHQUFXLENBQUMsQ0FBQztRQUl4QixJQUFJLENBQUMsTUFBTSxHQUFHLHFCQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLFVBQVUsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7SUFDeEYsQ0FBQztJQUNNLFNBQVMsQ0FBQyxRQUFnQjtRQUM3QixNQUFNLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3hELE9BQU8sSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUNNLElBQUksQ0FBQyxRQUFnQjtRQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QyxPQUFPLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ2hDLENBQUM7SUFDTSxJQUFJLENBQUMsTUFBc0I7UUFDOUIsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ3hDLElBQUksTUFBTSxJQUFJLFFBQVEsR0FBRyxJQUFJLEVBQUU7WUFDM0IsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7Z0JBQUUsTUFBTSxHQUFHLFFBQVEsQ0FBQzthQUFFO1lBQ3RELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQ3hCLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNuRCxPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUNuRDtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDTSxNQUFNLENBQUMsUUFBZ0IsRUFBRSxNQUFjO1FBQzFDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDeEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsR0FBRyxNQUFNLENBQUMsQ0FBQztRQUNuRCxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RFLENBQUM7SUFDTSxLQUFLLEtBQUssSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hELEtBQUssQ0FBQyxLQUFXLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLE1BQU0sQ0FBQyxLQUFXLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO0NBQzdFO0FBbkNELDRDQW1DQztBQUVELGNBQWM7QUFDZCxNQUFhLHFCQUFzQixTQUFRLHdCQUFlO0lBTXRELFlBQVksSUFBZ0IsRUFBRSxVQUFtQjtRQUM3QyxLQUFLLEVBQUUsQ0FBQztRQUpMLGFBQVEsR0FBVyxDQUFDLENBQUM7UUFLeEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLEVBQUU7WUFDaEMsSUFBSSxDQUFDLElBQUksR0FBRyxVQUFVLENBQUM7U0FDMUI7YUFBTTtZQUNILElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxHQUFTLEVBQUU7Z0JBQ3hCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztnQkFDckIsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3pDLENBQUMsQ0FBQSxDQUFDLEVBQUUsQ0FBQztTQUNSO0lBQ0wsQ0FBQztJQUNZLFNBQVMsQ0FBQyxRQUFnQjs7WUFDbkMsTUFBTSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzlELE9BQU8sSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDOUQsQ0FBQztLQUFBO0lBQ1ksSUFBSSxDQUFDLFFBQWdCOztZQUM5QixJQUFJLENBQUMsUUFBUSxLQUFJLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQSxDQUFDO1lBQ3JDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlDLE9BQU8sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDaEMsQ0FBQztLQUFBO0lBQ1ksSUFBSSxDQUFDLE1BQXNCOztZQUNwQyxJQUFJLENBQUMsUUFBUSxLQUFJLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQSxDQUFDO1lBQ3JDLE1BQU0sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7WUFDL0MsSUFBSSxJQUFJLElBQUksUUFBUSxHQUFHLElBQUksRUFBRTtnQkFDekIsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7b0JBQUUsTUFBTSxHQUFHLFFBQVEsQ0FBQztpQkFBRTtnQkFDdEQsSUFBSSxHQUFHLEdBQUcsUUFBUSxFQUFFLE1BQU0sR0FBRyxDQUFDLEVBQUUsU0FBUyxHQUFHLENBQUMsQ0FBQztnQkFDOUMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUM3RCxJQUFJLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDdEUsT0FBTyxDQUFDLEdBQUcsSUFBSSxTQUFTLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLElBQUksU0FBUyxDQUFDLEdBQUcsTUFBTSxDQUFDLFVBQVUsRUFBRTtvQkFDMUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxVQUFVLEdBQUcsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7aUJBQ3RGO2dCQUNELE9BQU8sTUFBTSxDQUFDO2FBQ2pCO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztLQUFBO0lBQ1ksTUFBTSxDQUFDLFFBQWdCLEVBQUUsTUFBYzs7WUFDaEQsSUFBSSxDQUFDLFFBQVEsS0FBSSxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUEsQ0FBQztZQUNyQyxNQUFNLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7WUFDckMsSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLEdBQUcsSUFBSSxFQUFFO2dCQUNwQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLEdBQUcsTUFBTSxDQUFDLENBQUM7Z0JBQzlDLE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUMsQ0FBQztnQkFDOUMsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQzthQUNoRTtZQUNELE9BQU8sSUFBSSxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEMsQ0FBQztLQUFBO0lBQ1ksS0FBSztzRUFBSyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUksTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUEsQ0FBQyxDQUFDLENBQUM7S0FBQTtJQUM5RSxLQUFLLENBQUMsS0FBVztzRUFBSSxNQUFNLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztLQUFBO0lBQ3hFLE1BQU0sQ0FBQyxLQUFXO3NFQUFJLE1BQU0sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQUE7Q0FDekY7QUF2REQsc0RBdURDIiwiZmlsZSI6ImlvL2ZpbGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgRmlsZUhhbmRsZSB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBCeXRlU3RyZWFtLCBBc3luY0J5dGVTdHJlYW0gfSBmcm9tICcuL3N0cmVhbSc7XG5pbXBvcnQgeyBBcnJheUJ1ZmZlclZpZXdJbnB1dCwgdG9VaW50OEFycmF5IH0gZnJvbSAnLi4vdXRpbC9idWZmZXInO1xuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGNsYXNzIFJhbmRvbUFjY2Vzc0ZpbGUgZXh0ZW5kcyBCeXRlU3RyZWFtIHtcbiAgICBwdWJsaWMgc2l6ZTogbnVtYmVyO1xuICAgIHB1YmxpYyBwb3NpdGlvbjogbnVtYmVyID0gMDtcbiAgICBwcm90ZWN0ZWQgYnVmZmVyOiBVaW50OEFycmF5IHwgbnVsbDtcbiAgICBjb25zdHJ1Y3RvcihidWZmZXI6IEFycmF5QnVmZmVyVmlld0lucHV0LCBieXRlTGVuZ3RoPzogbnVtYmVyKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuYnVmZmVyID0gdG9VaW50OEFycmF5KGJ1ZmZlcik7XG4gICAgICAgIHRoaXMuc2l6ZSA9IHR5cGVvZiBieXRlTGVuZ3RoID09PSAndW5kZWZpbmVkJyA/IHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGggOiBieXRlTGVuZ3RoO1xuICAgIH1cbiAgICBwdWJsaWMgcmVhZEludDMyKHBvc2l0aW9uOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgeyBidWZmZXIsIGJ5dGVPZmZzZXQgfSA9IHRoaXMucmVhZEF0KHBvc2l0aW9uLCA0KTtcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRhVmlldyhidWZmZXIsIGJ5dGVPZmZzZXQpLmdldEludDMyKDAsIHRydWUpO1xuICAgIH1cbiAgICBwdWJsaWMgc2Vlayhwb3NpdGlvbjogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMucG9zaXRpb24gPSBNYXRoLm1pbihwb3NpdGlvbiwgdGhpcy5zaXplKTtcbiAgICAgICAgcmV0dXJuIHBvc2l0aW9uIDwgdGhpcy5zaXplO1xuICAgIH1cbiAgICBwdWJsaWMgcmVhZChuQnl0ZXM/OiBudW1iZXIgfCBudWxsKSB7XG4gICAgICAgIGNvbnN0IHsgYnVmZmVyLCBzaXplLCBwb3NpdGlvbiB9ID0gdGhpcztcbiAgICAgICAgaWYgKGJ1ZmZlciAmJiBwb3NpdGlvbiA8IHNpemUpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbkJ5dGVzICE9PSAnbnVtYmVyJykgeyBuQnl0ZXMgPSBJbmZpbml0eTsgfVxuICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IE1hdGgubWluKHNpemUsXG4gICAgICAgICAgICAgICAgIHBvc2l0aW9uICsgTWF0aC5taW4oc2l6ZSAtIHBvc2l0aW9uLCBuQnl0ZXMpKTtcbiAgICAgICAgICAgIHJldHVybiBidWZmZXIuc3ViYXJyYXkocG9zaXRpb24sIHRoaXMucG9zaXRpb24pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBwdWJsaWMgcmVhZEF0KHBvc2l0aW9uOiBudW1iZXIsIG5CeXRlczogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGJ1ZiA9IHRoaXMuYnVmZmVyO1xuICAgICAgICBjb25zdCBlbmQgPSBNYXRoLm1pbih0aGlzLnNpemUsIHBvc2l0aW9uICsgbkJ5dGVzKTtcbiAgICAgICAgcmV0dXJuIGJ1ZiA/IGJ1Zi5zdWJhcnJheShwb3NpdGlvbiwgZW5kKSA6IG5ldyBVaW50OEFycmF5KG5CeXRlcyk7XG4gICAgfVxuICAgIHB1YmxpYyBjbG9zZSgpIHsgdGhpcy5idWZmZXIgJiYgKHRoaXMuYnVmZmVyID0gbnVsbCk7IH1cbiAgICBwdWJsaWMgdGhyb3codmFsdWU/OiBhbnkpIHsgdGhpcy5jbG9zZSgpOyByZXR1cm4geyBkb25lOiB0cnVlLCB2YWx1ZSB9OyB9XG4gICAgcHVibGljIHJldHVybih2YWx1ZT86IGFueSkgeyB0aGlzLmNsb3NlKCk7IHJldHVybiB7IGRvbmU6IHRydWUsIHZhbHVlIH07IH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjbGFzcyBBc3luY1JhbmRvbUFjY2Vzc0ZpbGUgZXh0ZW5kcyBBc3luY0J5dGVTdHJlYW0ge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwdWJsaWMgc2l6ZTogbnVtYmVyO1xuICAgIHB1YmxpYyBwb3NpdGlvbjogbnVtYmVyID0gMDtcbiAgICBwdWJsaWMgX3BlbmRpbmc/OiBQcm9taXNlPHZvaWQ+O1xuICAgIHByb3RlY3RlZCBfaGFuZGxlOiBGaWxlSGFuZGxlIHwgbnVsbDtcbiAgICBjb25zdHJ1Y3RvcihmaWxlOiBGaWxlSGFuZGxlLCBieXRlTGVuZ3RoPzogbnVtYmVyKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX2hhbmRsZSA9IGZpbGU7XG4gICAgICAgIGlmICh0eXBlb2YgYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgIHRoaXMuc2l6ZSA9IGJ5dGVMZW5ndGg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fcGVuZGluZztcbiAgICAgICAgICAgICAgICB0aGlzLnNpemUgPSAoYXdhaXQgZmlsZS5zdGF0KCkpLnNpemU7XG4gICAgICAgICAgICB9KSgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyByZWFkSW50MzIocG9zaXRpb246IG51bWJlcikge1xuICAgICAgICBjb25zdCB7IGJ1ZmZlciwgYnl0ZU9mZnNldCB9ID0gYXdhaXQgdGhpcy5yZWFkQXQocG9zaXRpb24sIDQpO1xuICAgICAgICByZXR1cm4gbmV3IERhdGFWaWV3KGJ1ZmZlciwgYnl0ZU9mZnNldCkuZ2V0SW50MzIoMCwgdHJ1ZSk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyBzZWVrKHBvc2l0aW9uOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5fcGVuZGluZyAmJiBhd2FpdCB0aGlzLl9wZW5kaW5nO1xuICAgICAgICB0aGlzLnBvc2l0aW9uID0gTWF0aC5taW4ocG9zaXRpb24sIHRoaXMuc2l6ZSk7XG4gICAgICAgIHJldHVybiBwb3NpdGlvbiA8IHRoaXMuc2l6ZTtcbiAgICB9XG4gICAgcHVibGljIGFzeW5jIHJlYWQobkJ5dGVzPzogbnVtYmVyIHwgbnVsbCkge1xuICAgICAgICB0aGlzLl9wZW5kaW5nICYmIGF3YWl0IHRoaXMuX3BlbmRpbmc7XG4gICAgICAgIGNvbnN0IHsgX2hhbmRsZTogZmlsZSwgc2l6ZSwgcG9zaXRpb24gfSA9IHRoaXM7XG4gICAgICAgIGlmIChmaWxlICYmIHBvc2l0aW9uIDwgc2l6ZSkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBuQnl0ZXMgIT09ICdudW1iZXInKSB7IG5CeXRlcyA9IEluZmluaXR5OyB9XG4gICAgICAgICAgICBsZXQgcG9zID0gcG9zaXRpb24sIG9mZnNldCA9IDAsIGJ5dGVzUmVhZCA9IDA7XG4gICAgICAgICAgICBsZXQgZW5kID0gTWF0aC5taW4oc2l6ZSwgcG9zICsgTWF0aC5taW4oc2l6ZSAtIHBvcywgbkJ5dGVzKSk7XG4gICAgICAgICAgICBsZXQgYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoTWF0aC5tYXgoMCwgKHRoaXMucG9zaXRpb24gPSBlbmQpIC0gcG9zKSk7XG4gICAgICAgICAgICB3aGlsZSAoKHBvcyArPSBieXRlc1JlYWQpIDwgZW5kICYmIChvZmZzZXQgKz0gYnl0ZXNSZWFkKSA8IGJ1ZmZlci5ieXRlTGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgKHsgYnl0ZXNSZWFkIH0gPSBhd2FpdCBmaWxlLnJlYWQoYnVmZmVyLCBvZmZzZXQsIGJ1ZmZlci5ieXRlTGVuZ3RoIC0gb2Zmc2V0LCBwb3MpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBidWZmZXI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyByZWFkQXQocG9zaXRpb246IG51bWJlciwgbkJ5dGVzOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5fcGVuZGluZyAmJiBhd2FpdCB0aGlzLl9wZW5kaW5nO1xuICAgICAgICBjb25zdCB7IF9oYW5kbGU6IGZpbGUsIHNpemUgfSA9IHRoaXM7XG4gICAgICAgIGlmIChmaWxlICYmIChwb3NpdGlvbiArIG5CeXRlcykgPCBzaXplKSB7XG4gICAgICAgICAgICBjb25zdCBlbmQgPSBNYXRoLm1pbihzaXplLCBwb3NpdGlvbiArIG5CeXRlcyk7XG4gICAgICAgICAgICBjb25zdCBidWZmZXIgPSBuZXcgVWludDhBcnJheShlbmQgLSBwb3NpdGlvbik7XG4gICAgICAgICAgICByZXR1cm4gKGF3YWl0IGZpbGUucmVhZChidWZmZXIsIDAsIG5CeXRlcywgcG9zaXRpb24pKS5idWZmZXI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KG5CeXRlcyk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyBjbG9zZSgpIHsgY29uc3QgZiA9IHRoaXMuX2hhbmRsZTsgdGhpcy5faGFuZGxlID0gbnVsbDsgZiAmJiBhd2FpdCBmLmNsb3NlKCk7IH1cbiAgICBwdWJsaWMgYXN5bmMgdGhyb3codmFsdWU/OiBhbnkpIHsgYXdhaXQgdGhpcy5jbG9zZSgpOyByZXR1cm4geyBkb25lOiB0cnVlLCB2YWx1ZSB9OyB9XG4gICAgcHVibGljIGFzeW5jIHJldHVybih2YWx1ZT86IGFueSkgeyBhd2FpdCB0aGlzLmNsb3NlKCk7IHJldHVybiB7IGRvbmU6IHRydWUsIHZhbHVlIH07IH1cbn1cbiJdfQ==
