// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import streamAdapters from './adapters';
export const ITERATOR_DONE = Object.freeze({ done: true, value: void (0) });
/**
 * @ignore
 */
export class ArrowJSON {
    constructor(_json) {
        this._json = _json;
    }
    get schema() { return this._json['schema']; }
    get batches() { return (this._json['batches'] || []); }
    get dictionaries() { return (this._json['dictionaries'] || []); }
}
Object.defineProperty(ArrowJSON.prototype, 'schema', { get() { return this._json['schema']; } });
Object.defineProperty(ArrowJSON.prototype, 'batches', { get() { return (this._json['batches'] || []); } });
Object.defineProperty(ArrowJSON.prototype, 'dictionaries', { get() { return (this._json['dictionaries'] || []); } });
export class ReadableInterop {
    tee() {
        return this._getReadableDOMStream().tee();
    }
    pipe(writable, options) {
        return this._getReadableNodeStream().pipe(writable, options);
    }
    pipeTo(writable, options) { return this._getReadableDOMStream().pipeTo(writable, options); }
    pipeThrough(duplex, options) {
        return this._getReadableDOMStream().pipeThrough(duplex, options);
    }
    _getReadableDOMStream() {
        return this._readableDOMStream || (this._readableDOMStream = this.toReadableDOMStream());
    }
    _getReadableNodeStream() {
        return this._readableNodeStream || (this._readableNodeStream = this.toReadableNodeStream());
    }
}
/**
 * @ignore
 */
export class AsyncQueue extends ReadableInterop {
    constructor() {
        super();
        this.values = [];
        this.resolvers = [];
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    get closed() { return this._closedPromise; }
    async cancel(reason) { await this.return(reason); }
    write(value) {
        if (this._ensureOpen()) {
            this.resolvers.length <= 0
                ? (this.values.push(value))
                : (this.resolvers.shift().resolve({ done: false, value }));
        }
    }
    abort(value) {
        if (this._closedPromiseResolve) {
            this.resolvers.length <= 0
                ? (this._error = { error: value })
                : (this.resolvers.shift().reject({ done: true, value }));
        }
    }
    close() {
        if (this._closedPromiseResolve) {
            const { resolvers } = this;
            while (resolvers.length > 0) {
                resolvers.shift().resolve(ITERATOR_DONE);
            }
            this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
        }
    }
    [Symbol.asyncIterator]() { return this; }
    toReadableDOMStream(options) {
        return streamAdapters.toReadableDOMStream(this, options);
    }
    toReadableNodeStream(options) {
        return streamAdapters.toReadableNodeStream(this, options);
    }
    async throw(_) { await this.abort(_); return ITERATOR_DONE; }
    ;
    async return(_) { await this.close(); return ITERATOR_DONE; }
    ;
    async read(size) { return (await this.next(size, 'read')).value; }
    async peek(size) { return (await this.next(size, 'peek')).value; }
    next(..._args) {
        if (this.values.length > 0) {
            return Promise.resolve({ done: false, value: this.values.shift() });
        }
        else if (this._error) {
            return Promise.reject({ done: true, value: this._error.error });
        }
        else if (!this._closedPromiseResolve) {
            return Promise.resolve(ITERATOR_DONE);
        }
        else {
            return new Promise((resolve, reject) => {
                this.resolvers.push({ resolve, reject });
            });
        }
    }
    _ensureOpen() {
        if (this._closedPromiseResolve) {
            return true;
        }
        throw new Error(`${this.constructor.name} is closed`);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LElBQUksQ0FBQztTQUNmO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxZQUFZLENBQUMsQ0FBQztJQUMxRCxDQUFDO0NBQ0oiLCJmaWxlIjoiaW8vaW50ZXJmYWNlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgc3RyZWFtQWRhcHRlcnMgZnJvbSAnLi9hZGFwdGVycyc7XG5cbmV4cG9ydCBjb25zdCBJVEVSQVRPUl9ET05FOiBhbnkgPSBPYmplY3QuZnJlZXplKHsgZG9uZTogdHJ1ZSwgdmFsdWU6IHZvaWQgKDApIH0pO1xuXG5leHBvcnQgdHlwZSBGaWxlSGFuZGxlID0gaW1wb3J0KCdmcycpLnByb21pc2VzLkZpbGVIYW5kbGU7XG5leHBvcnQgdHlwZSBBcnJvd0pTT05MaWtlID0geyBzY2hlbWE6IGFueTsgYmF0Y2hlcz86IGFueVtdOyBkaWN0aW9uYXJpZXM/OiBhbnlbXTsgfTtcbmV4cG9ydCB0eXBlIFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyA9IHsgdHlwZTogJ2J5dGVzJyB8IHVuZGVmaW5lZCwgYXV0b0FsbG9jYXRlQ2h1bmtTaXplPzogbnVtYmVyIH07XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5leHBvcnQgY2xhc3MgQXJyb3dKU09OIHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9qc29uOiBBcnJvd0pTT05MaWtlKSB7fVxuICAgIHB1YmxpYyBnZXQgc2NoZW1hKCk6IGFueSB7IHJldHVybiB0aGlzLl9qc29uWydzY2hlbWEnXTsgfVxuICAgIHB1YmxpYyBnZXQgYmF0Y2hlcygpOiBhbnlbXSB7IHJldHVybiAodGhpcy5fanNvblsnYmF0Y2hlcyddIHx8IFtdKSBhcyBhbnlbXTsgfVxuICAgIHB1YmxpYyBnZXQgZGljdGlvbmFyaWVzKCk6IGFueVtdIHsgcmV0dXJuICh0aGlzLl9qc29uWydkaWN0aW9uYXJpZXMnXSB8fCBbXSkgYXMgYW55W107IH1cbn1cblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KEFycm93SlNPTi5wcm90b3R5cGUsICdzY2hlbWEnLCB7IGdldCgpIHsgcmV0dXJuIHRoaXMuX2pzb25bJ3NjaGVtYSddOyB9fSk7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoQXJyb3dKU09OLnByb3RvdHlwZSwgJ2JhdGNoZXMnLCB7IGdldCgpIHsgcmV0dXJuICh0aGlzLl9qc29uWydiYXRjaGVzJ10gfHwgW10pIGFzIGFueVtdOyB9fSk7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoQXJyb3dKU09OLnByb3RvdHlwZSwgJ2RpY3Rpb25hcmllcycsIHsgZ2V0KCkgeyByZXR1cm4gKHRoaXMuX2pzb25bJ2RpY3Rpb25hcmllcyddIHx8IFtdKSBhcyBhbnlbXTsgfX0pO1xuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWFkYWJsZTxUPiB7XG5cbiAgICByZWFkb25seSBjbG9zZWQ6IFByb21pc2U8dm9pZD47XG4gICAgY2FuY2VsKHJlYXNvbj86IGFueSk6IFByb21pc2U8dm9pZD47XG5cbiAgICByZWFkKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUIHwgbnVsbD47XG4gICAgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VCB8IG51bGw+O1xuICAgIHRocm93KHZhbHVlPzogYW55KTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxhbnk+PjtcbiAgICByZXR1cm4odmFsdWU/OiBhbnkpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PGFueT4+O1xuICAgIG5leHQoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFQ+Pjtcbn1cblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgV3JpdGFibGU8VD4ge1xuICAgIHJlYWRvbmx5IGNsb3NlZDogUHJvbWlzZTx2b2lkPjtcbiAgICBjbG9zZSgpOiB2b2lkO1xuICAgIHdyaXRlKGNodW5rOiBUKTogdm9pZDtcbiAgICBhYm9ydChyZWFzb24/OiBhbnkpOiB2b2lkO1xufVxuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWFkYWJsZVdyaXRhYmxlPFRSZWFkYWJsZSwgVFdyaXRhYmxlPiBleHRlbmRzIFJlYWRhYmxlPFRSZWFkYWJsZT4sIFdyaXRhYmxlPFRXcml0YWJsZT4ge1xuICAgIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTogQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFRSZWFkYWJsZT47XG4gICAgdG9SZWFkYWJsZURPTVN0cmVhbShvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKTogUmVhZGFibGVTdHJlYW08VFJlYWRhYmxlPjtcbiAgICB0b1JlYWRhYmxlTm9kZVN0cmVhbShvcHRpb25zPzogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZU9wdGlvbnMpOiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlO1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUmVhZGFibGVJbnRlcm9wPFQ+IHtcblxuICAgIHB1YmxpYyBhYnN0cmFjdCB0b1JlYWRhYmxlRE9NU3RyZWFtKG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpOiBSZWFkYWJsZVN0cmVhbTxUPjtcbiAgICBwdWJsaWMgYWJzdHJhY3QgdG9SZWFkYWJsZU5vZGVTdHJlYW0ob3B0aW9ucz86IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGVPcHRpb25zKTogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZTtcblxuICAgIHB1YmxpYyB0ZWUoKTogW1JlYWRhYmxlU3RyZWFtPFQ+LCBSZWFkYWJsZVN0cmVhbTxUPl0ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0UmVhZGFibGVET01TdHJlYW0oKS50ZWUoKTtcbiAgICB9XG4gICAgcHVibGljIHBpcGU8UiBleHRlbmRzIE5vZGVKUy5Xcml0YWJsZVN0cmVhbT4od3JpdGFibGU6IFIsIG9wdGlvbnM/OiB7IGVuZD86IGJvb2xlYW47IH0pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFJlYWRhYmxlTm9kZVN0cmVhbSgpLnBpcGUod3JpdGFibGUsIG9wdGlvbnMpO1xuICAgIH1cbiAgICBwdWJsaWMgcGlwZVRvKHdyaXRhYmxlOiBXcml0YWJsZVN0cmVhbTxUPiwgb3B0aW9ucz86IFBpcGVPcHRpb25zKSB7IHJldHVybiB0aGlzLl9nZXRSZWFkYWJsZURPTVN0cmVhbSgpLnBpcGVUbyh3cml0YWJsZSwgb3B0aW9ucyk7IH1cbiAgICBwdWJsaWMgcGlwZVRocm91Z2g8UiBleHRlbmRzIFJlYWRhYmxlU3RyZWFtPGFueT4+KGR1cGxleDogeyB3cml0YWJsZTogV3JpdGFibGVTdHJlYW08VD4sIHJlYWRhYmxlOiBSIH0sIG9wdGlvbnM/OiBQaXBlT3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0UmVhZGFibGVET01TdHJlYW0oKS5waXBlVGhyb3VnaChkdXBsZXgsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3JlYWRhYmxlRE9NU3RyZWFtPzogUmVhZGFibGVTdHJlYW08VD47XG4gICAgcHJpdmF0ZSBfZ2V0UmVhZGFibGVET01TdHJlYW0oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZURPTVN0cmVhbSB8fCAodGhpcy5fcmVhZGFibGVET01TdHJlYW0gPSB0aGlzLnRvUmVhZGFibGVET01TdHJlYW0oKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVhZGFibGVOb2RlU3RyZWFtPzogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZTtcbiAgICBwcml2YXRlIF9nZXRSZWFkYWJsZU5vZGVTdHJlYW0oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZU5vZGVTdHJlYW0gfHwgKHRoaXMuX3JlYWRhYmxlTm9kZVN0cmVhbSA9IHRoaXMudG9SZWFkYWJsZU5vZGVTdHJlYW0oKSk7XG4gICAgfVxufVxuXG50eXBlIFJlc29sdXRpb248VD4gPSB7IHJlc29sdmU6ICh2YWx1ZT86IFQgfCBQcm9taXNlTGlrZTxUPikgPT4gdm9pZDsgcmVqZWN0OiAocmVhc29uPzogYW55KSA9PiB2b2lkOyB9O1xuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGNsYXNzIEFzeW5jUXVldWU8VFJlYWRhYmxlID0gVWludDhBcnJheSwgVFdyaXRhYmxlID0gVFJlYWRhYmxlPiBleHRlbmRzIFJlYWRhYmxlSW50ZXJvcDxUUmVhZGFibGU+XG4gICAgaW1wbGVtZW50cyBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8VFJlYWRhYmxlPiwgUmVhZGFibGVXcml0YWJsZTxUUmVhZGFibGUsIFRXcml0YWJsZT4ge1xuXG4gICAgcHJvdGVjdGVkIHZhbHVlczogVFdyaXRhYmxlW10gPSBbXTtcbiAgICBwcm90ZWN0ZWQgX2Vycm9yPzogeyBlcnJvcjogYW55OyB9O1xuICAgIHByb3RlY3RlZCBfY2xvc2VkUHJvbWlzZTogUHJvbWlzZTx2b2lkPjtcbiAgICBwcm90ZWN0ZWQgX2Nsb3NlZFByb21pc2VSZXNvbHZlPzogKHZhbHVlPzogYW55KSA9PiB2b2lkO1xuICAgIHByb3RlY3RlZCByZXNvbHZlcnM6IFJlc29sdXRpb248SXRlcmF0b3JSZXN1bHQ8VFJlYWRhYmxlPj5bXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocikgPT4gdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUgPSByKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGNsb3NlZCgpOiBQcm9taXNlPHZvaWQ+IHsgcmV0dXJuIHRoaXMuX2Nsb3NlZFByb21pc2U7IH1cbiAgICBwdWJsaWMgYXN5bmMgY2FuY2VsKHJlYXNvbj86IGFueSkgeyBhd2FpdCB0aGlzLnJldHVybihyZWFzb24pOyB9XG4gICAgcHVibGljIHdyaXRlKHZhbHVlOiBUV3JpdGFibGUpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Vuc3VyZU9wZW4oKSkge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMubGVuZ3RoIDw9IDBcbiAgICAgICAgICAgICAgICA/ICh0aGlzLnZhbHVlcy5wdXNoKHZhbHVlKSlcbiAgICAgICAgICAgICAgICA6ICh0aGlzLnJlc29sdmVycy5zaGlmdCgpIS5yZXNvbHZlKHsgZG9uZTogZmFsc2UsIHZhbHVlIH0gYXMgYW55KSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIGFib3J0KHZhbHVlPzogYW55KSB7XG4gICAgICAgIGlmICh0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSkge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMubGVuZ3RoIDw9IDBcbiAgICAgICAgICAgICAgICA/ICh0aGlzLl9lcnJvciA9IHsgZXJyb3I6IHZhbHVlIH0pXG4gICAgICAgICAgICAgICAgOiAodGhpcy5yZXNvbHZlcnMuc2hpZnQoKSEucmVqZWN0KHsgZG9uZTogdHJ1ZSwgdmFsdWUgfSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBjbG9zZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKSB7XG4gICAgICAgICAgICBjb25zdCB7IHJlc29sdmVycyB9ID0gdGhpcztcbiAgICAgICAgICAgIHdoaWxlIChyZXNvbHZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmVycy5zaGlmdCgpIS5yZXNvbHZlKElURVJBVE9SX0RPTkUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUoKTtcbiAgICAgICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7IHJldHVybiB0aGlzOyB9XG4gICAgcHVibGljIHRvUmVhZGFibGVET01TdHJlYW0ob3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc3RyZWFtQWRhcHRlcnMudG9SZWFkYWJsZURPTVN0cmVhbSh0aGlzLCBvcHRpb25zKTtcbiAgICB9XG4gICAgcHVibGljIHRvUmVhZGFibGVOb2RlU3RyZWFtKG9wdGlvbnM/OiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlT3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc3RyZWFtQWRhcHRlcnMudG9SZWFkYWJsZU5vZGVTdHJlYW0odGhpcywgb3B0aW9ucyk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyB0aHJvdyhfPzogYW55KSB7IGF3YWl0IHRoaXMuYWJvcnQoXyk7IHJldHVybiBJVEVSQVRPUl9ET05FOyB9O1xuICAgIHB1YmxpYyBhc3luYyByZXR1cm4oXz86IGFueSkgeyBhd2FpdCB0aGlzLmNsb3NlKCk7IHJldHVybiBJVEVSQVRPUl9ET05FOyB9O1xuXG4gICAgcHVibGljIGFzeW5jIHJlYWQoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPFRSZWFkYWJsZSB8IG51bGw+IHsgcmV0dXJuIChhd2FpdCB0aGlzLm5leHQoc2l6ZSwgJ3JlYWQnKSkudmFsdWU7IH1cbiAgICBwdWJsaWMgYXN5bmMgcGVlayhzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VFJlYWRhYmxlIHwgbnVsbD4geyByZXR1cm4gKGF3YWl0IHRoaXMubmV4dChzaXplLCAncGVlaycpKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBuZXh0KC4uLl9hcmdzOiBhbnlbXSk6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8VFJlYWRhYmxlPj4ge1xuICAgICAgICBpZiAodGhpcy52YWx1ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRvbmU6IGZhbHNlLCB2YWx1ZTogdGhpcy52YWx1ZXMuc2hpZnQoKSEgfSBhcyBhbnkpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2Vycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoeyBkb25lOiB0cnVlLCB2YWx1ZTogdGhpcy5fZXJyb3IuZXJyb3IgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKElURVJBVE9SX0RPTkUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFRSZWFkYWJsZT4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc29sdmVycy5wdXNoKHsgcmVzb2x2ZSwgcmVqZWN0IH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX2Vuc3VyZU9wZW4oKSB7XG4gICAgICAgIGlmICh0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3RoaXMuY29uc3RydWN0b3IubmFtZX0gaXMgY2xvc2VkYCk7XG4gICAgfVxufVxuIl19
