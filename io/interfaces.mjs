// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import streamAdapters from './adapters';
export const ITERATOR_DONE = Object.freeze({ done: true, value: void (0) });
/**
 * @ignore
 */
export class ArrowJSON {
    constructor(_json) {
        this._json = _json;
    }
    get schema() { return this._json['schema']; }
    get batches() { return (this._json['batches'] || []); }
    get dictionaries() { return (this._json['dictionaries'] || []); }
}
Object.defineProperty(ArrowJSON.prototype, 'schema', { get() { return this._json['schema']; } });
Object.defineProperty(ArrowJSON.prototype, 'batches', { get() { return (this._json['batches'] || []); } });
Object.defineProperty(ArrowJSON.prototype, 'dictionaries', { get() { return (this._json['dictionaries'] || []); } });
export class ReadableInterop {
    tee() {
        return this._getReadableDOMStream().tee();
    }
    pipe(writable, options) {
        return this._getReadableNodeStream().pipe(writable, options);
    }
    pipeTo(writable, options) { return this._getReadableDOMStream().pipeTo(writable, options); }
    pipeThrough(duplex, options) {
        return this._getReadableDOMStream().pipeThrough(duplex, options);
    }
    _getReadableDOMStream() {
        return this._readableDOMStream || (this._readableDOMStream = this.toReadableDOMStream());
    }
    _getReadableNodeStream() {
        return this._readableNodeStream || (this._readableNodeStream = this.toReadableNodeStream());
    }
}
/**
 * @ignore
 */
export class AsyncQueue extends ReadableInterop {
    constructor() {
        super();
        this.values = [];
        this.resolvers = [];
        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);
    }
    get closed() { return this._closedPromise; }
    async cancel(reason) { await this.return(reason); }
    write(value) {
        if (this._ensureOpen()) {
            this.resolvers.length <= 0
                ? (this.values.push(value))
                : (this.resolvers.shift().resolve({ done: false, value }));
        }
    }
    abort(value) {
        if (this._closedPromiseResolve) {
            this.resolvers.length <= 0
                ? (this._error = { error: value })
                : (this.resolvers.shift().reject({ done: true, value }));
        }
    }
    close() {
        if (this._closedPromiseResolve) {
            const { resolvers } = this;
            while (resolvers.length > 0) {
                resolvers.shift().resolve(ITERATOR_DONE);
            }
            this._closedPromiseResolve();
            this._closedPromiseResolve = undefined;
        }
    }
    [Symbol.asyncIterator]() { return this; }
    toReadableDOMStream(options) {
        return streamAdapters.toReadableDOMStream(this, options);
    }
    toReadableNodeStream(options) {
        return streamAdapters.toReadableNodeStream(this, options);
    }
    async throw(_) { await this.abort(_); return ITERATOR_DONE; }
    async return(_) { await this.close(); return ITERATOR_DONE; }
    async read(size) { return (await this.next(size, 'read')).value; }
    async peek(size) { return (await this.next(size, 'peek')).value; }
    next(..._args) {
        if (this.values.length > 0) {
            return Promise.resolve({ done: false, value: this.values.shift() });
        }
        else if (this._error) {
            return Promise.reject({ done: true, value: this._error.error });
        }
        else if (!this._closedPromiseResolve) {
            return Promise.resolve(ITERATOR_DONE);
        }
        else {
            return new Promise((resolve, reject) => {
                this.resolvers.push({ resolve, reject });
            });
        }
    }
    _ensureOpen() {
        if (this._closedPromiseResolve) {
            return true;
        }
        throw new Error(`${this.constructor.name} is closed`);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksWUFBWSxDQUFDLENBQUM7SUFDMUQsQ0FBQztDQUNKIiwiZmlsZSI6ImlvL2ludGVyZmFjZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHN0cmVhbUFkYXB0ZXJzIGZyb20gJy4vYWRhcHRlcnMnO1xuXG5leHBvcnQgY29uc3QgSVRFUkFUT1JfRE9ORTogYW55ID0gT2JqZWN0LmZyZWV6ZSh7IGRvbmU6IHRydWUsIHZhbHVlOiB2b2lkICgwKSB9KTtcblxuZXhwb3J0IHR5cGUgRmlsZUhhbmRsZSA9IGltcG9ydCgnZnMnKS5wcm9taXNlcy5GaWxlSGFuZGxlO1xuZXhwb3J0IHR5cGUgQXJyb3dKU09OTGlrZSA9IHsgc2NoZW1hOiBhbnk7IGJhdGNoZXM/OiBhbnlbXTsgZGljdGlvbmFyaWVzPzogYW55W107IH07XG5leHBvcnQgdHlwZSBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMgPSB7IHR5cGU6ICdieXRlcycgfCB1bmRlZmluZWQsIGF1dG9BbGxvY2F0ZUNodW5rU2l6ZT86IG51bWJlciB9O1xuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuZXhwb3J0IGNsYXNzIEFycm93SlNPTiB7XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfanNvbjogQXJyb3dKU09OTGlrZSkge31cbiAgICBwdWJsaWMgZ2V0IHNjaGVtYSgpOiBhbnkgeyByZXR1cm4gdGhpcy5fanNvblsnc2NoZW1hJ107IH1cbiAgICBwdWJsaWMgZ2V0IGJhdGNoZXMoKTogYW55W10geyByZXR1cm4gKHRoaXMuX2pzb25bJ2JhdGNoZXMnXSB8fCBbXSkgYXMgYW55W107IH1cbiAgICBwdWJsaWMgZ2V0IGRpY3Rpb25hcmllcygpOiBhbnlbXSB7IHJldHVybiAodGhpcy5fanNvblsnZGljdGlvbmFyaWVzJ10gfHwgW10pIGFzIGFueVtdOyB9XG59XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShBcnJvd0pTT04ucHJvdG90eXBlLCAnc2NoZW1hJywgeyBnZXQoKSB7IHJldHVybiB0aGlzLl9qc29uWydzY2hlbWEnXTsgfX0pO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KEFycm93SlNPTi5wcm90b3R5cGUsICdiYXRjaGVzJywgeyBnZXQoKSB7IHJldHVybiAodGhpcy5fanNvblsnYmF0Y2hlcyddIHx8IFtdKSBhcyBhbnlbXTsgfX0pO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KEFycm93SlNPTi5wcm90b3R5cGUsICdkaWN0aW9uYXJpZXMnLCB7IGdldCgpIHsgcmV0dXJuICh0aGlzLl9qc29uWydkaWN0aW9uYXJpZXMnXSB8fCBbXSkgYXMgYW55W107IH19KTtcblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUmVhZGFibGU8VD4ge1xuXG4gICAgcmVhZG9ubHkgY2xvc2VkOiBQcm9taXNlPHZvaWQ+O1xuICAgIGNhbmNlbChyZWFzb24/OiBhbnkpOiBQcm9taXNlPHZvaWQ+O1xuXG4gICAgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VCB8IG51bGw+O1xuICAgIHBlZWsoc2l6ZT86IG51bWJlciB8IG51bGwpOiBQcm9taXNlPFQgfCBudWxsPjtcbiAgICB0aHJvdyh2YWx1ZT86IGFueSk6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8YW55Pj47XG4gICAgcmV0dXJuKHZhbHVlPzogYW55KTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxhbnk+PjtcbiAgICBuZXh0KHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxUPj47XG59XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFdyaXRhYmxlPFQ+IHtcbiAgICByZWFkb25seSBjbG9zZWQ6IFByb21pc2U8dm9pZD47XG4gICAgY2xvc2UoKTogdm9pZDtcbiAgICB3cml0ZShjaHVuazogVCk6IHZvaWQ7XG4gICAgYWJvcnQocmVhc29uPzogYW55KTogdm9pZDtcbn1cblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUmVhZGFibGVXcml0YWJsZTxUUmVhZGFibGUsIFRXcml0YWJsZT4gZXh0ZW5kcyBSZWFkYWJsZTxUUmVhZGFibGU+LCBXcml0YWJsZTxUV3JpdGFibGU+IHtcbiAgICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCk6IEFzeW5jSXRlcmFibGVJdGVyYXRvcjxUUmVhZGFibGU+O1xuICAgIHRvUmVhZGFibGVET01TdHJlYW0ob3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyk6IFJlYWRhYmxlU3RyZWFtPFRSZWFkYWJsZT47XG4gICAgdG9SZWFkYWJsZU5vZGVTdHJlYW0ob3B0aW9ucz86IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGVPcHRpb25zKTogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZTtcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFJlYWRhYmxlSW50ZXJvcDxUPiB7XG5cbiAgICBwdWJsaWMgYWJzdHJhY3QgdG9SZWFkYWJsZURPTVN0cmVhbShvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKTogUmVhZGFibGVTdHJlYW08VD47XG4gICAgcHVibGljIGFic3RyYWN0IHRvUmVhZGFibGVOb2RlU3RyZWFtKG9wdGlvbnM/OiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlT3B0aW9ucyk6IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGU7XG5cbiAgICBwdWJsaWMgdGVlKCk6IFtSZWFkYWJsZVN0cmVhbTxUPiwgUmVhZGFibGVTdHJlYW08VD5dIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFJlYWRhYmxlRE9NU3RyZWFtKCkudGVlKCk7XG4gICAgfVxuICAgIHB1YmxpYyBwaXBlPFIgZXh0ZW5kcyBOb2RlSlMuV3JpdGFibGVTdHJlYW0+KHdyaXRhYmxlOiBSLCBvcHRpb25zPzogeyBlbmQ/OiBib29sZWFuOyB9KSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRSZWFkYWJsZU5vZGVTdHJlYW0oKS5waXBlKHdyaXRhYmxlLCBvcHRpb25zKTtcbiAgICB9XG4gICAgcHVibGljIHBpcGVUbyh3cml0YWJsZTogV3JpdGFibGVTdHJlYW08VD4sIG9wdGlvbnM/OiBQaXBlT3B0aW9ucykgeyByZXR1cm4gdGhpcy5fZ2V0UmVhZGFibGVET01TdHJlYW0oKS5waXBlVG8od3JpdGFibGUsIG9wdGlvbnMpOyB9XG4gICAgcHVibGljIHBpcGVUaHJvdWdoPFIgZXh0ZW5kcyBSZWFkYWJsZVN0cmVhbTxhbnk+PihkdXBsZXg6IHsgd3JpdGFibGU6IFdyaXRhYmxlU3RyZWFtPFQ+LCByZWFkYWJsZTogUiB9LCBvcHRpb25zPzogUGlwZU9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFJlYWRhYmxlRE9NU3RyZWFtKCkucGlwZVRocm91Z2goZHVwbGV4LCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9yZWFkYWJsZURPTVN0cmVhbT86IFJlYWRhYmxlU3RyZWFtPFQ+O1xuICAgIHByaXZhdGUgX2dldFJlYWRhYmxlRE9NU3RyZWFtKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVET01TdHJlYW0gfHwgKHRoaXMuX3JlYWRhYmxlRE9NU3RyZWFtID0gdGhpcy50b1JlYWRhYmxlRE9NU3RyZWFtKCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3JlYWRhYmxlTm9kZVN0cmVhbT86IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGU7XG4gICAgcHJpdmF0ZSBfZ2V0UmVhZGFibGVOb2RlU3RyZWFtKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVOb2RlU3RyZWFtIHx8ICh0aGlzLl9yZWFkYWJsZU5vZGVTdHJlYW0gPSB0aGlzLnRvUmVhZGFibGVOb2RlU3RyZWFtKCkpO1xuICAgIH1cbn1cblxudHlwZSBSZXNvbHV0aW9uPFQ+ID0geyByZXNvbHZlOiAodmFsdWU/OiBUIHwgUHJvbWlzZUxpa2U8VD4pID0+IHZvaWQ7IHJlamVjdDogKHJlYXNvbj86IGFueSkgPT4gdm9pZDsgfTtcblxuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmV4cG9ydCBjbGFzcyBBc3luY1F1ZXVlPFRSZWFkYWJsZSA9IFVpbnQ4QXJyYXksIFRXcml0YWJsZSA9IFRSZWFkYWJsZT4gZXh0ZW5kcyBSZWFkYWJsZUludGVyb3A8VFJlYWRhYmxlPlxuICAgIGltcGxlbWVudHMgQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFRSZWFkYWJsZT4sIFJlYWRhYmxlV3JpdGFibGU8VFJlYWRhYmxlLCBUV3JpdGFibGU+IHtcblxuICAgIHByb3RlY3RlZCB2YWx1ZXM6IFRXcml0YWJsZVtdID0gW107XG4gICAgcHJvdGVjdGVkIF9lcnJvcj86IHsgZXJyb3I6IGFueTsgfTtcbiAgICBwcm90ZWN0ZWQgX2Nsb3NlZFByb21pc2U6IFByb21pc2U8dm9pZD47XG4gICAgcHJvdGVjdGVkIF9jbG9zZWRQcm9taXNlUmVzb2x2ZT86ICh2YWx1ZT86IGFueSkgPT4gdm9pZDtcbiAgICBwcm90ZWN0ZWQgcmVzb2x2ZXJzOiBSZXNvbHV0aW9uPEl0ZXJhdG9yUmVzdWx0PFRSZWFkYWJsZT4+W10gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlID0gbmV3IFByb21pc2UoKHIpID0+IHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlID0gcik7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBjbG9zZWQoKTogUHJvbWlzZTx2b2lkPiB7IHJldHVybiB0aGlzLl9jbG9zZWRQcm9taXNlOyB9XG4gICAgcHVibGljIGFzeW5jIGNhbmNlbChyZWFzb24/OiBhbnkpIHsgYXdhaXQgdGhpcy5yZXR1cm4ocmVhc29uKTsgfVxuICAgIHB1YmxpYyB3cml0ZSh2YWx1ZTogVFdyaXRhYmxlKSB7XG4gICAgICAgIGlmICh0aGlzLl9lbnN1cmVPcGVuKCkpIHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzLmxlbmd0aCA8PSAwXG4gICAgICAgICAgICAgICAgPyAodGhpcy52YWx1ZXMucHVzaCh2YWx1ZSkpXG4gICAgICAgICAgICAgICAgOiAodGhpcy5yZXNvbHZlcnMuc2hpZnQoKSEucmVzb2x2ZSh7IGRvbmU6IGZhbHNlLCB2YWx1ZSB9IGFzIGFueSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBhYm9ydCh2YWx1ZT86IGFueSkge1xuICAgICAgICBpZiAodGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUpIHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzLmxlbmd0aCA8PSAwXG4gICAgICAgICAgICAgICAgPyAodGhpcy5fZXJyb3IgPSB7IGVycm9yOiB2YWx1ZSB9KVxuICAgICAgICAgICAgICAgIDogKHRoaXMucmVzb2x2ZXJzLnNoaWZ0KCkhLnJlamVjdCh7IGRvbmU6IHRydWUsIHZhbHVlIH0pKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgY2xvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSkge1xuICAgICAgICAgICAgY29uc3QgeyByZXNvbHZlcnMgfSA9IHRoaXM7XG4gICAgICAgICAgICB3aGlsZSAocmVzb2x2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlcnMuc2hpZnQoKSEucmVzb2x2ZShJVEVSQVRPUl9ET05FKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKCk7XG4gICAgICAgICAgICB0aGlzLl9jbG9zZWRQcm9taXNlUmVzb2x2ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgeyByZXR1cm4gdGhpczsgfVxuICAgIHB1YmxpYyB0b1JlYWRhYmxlRE9NU3RyZWFtKG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHN0cmVhbUFkYXB0ZXJzLnRvUmVhZGFibGVET01TdHJlYW0odGhpcywgb3B0aW9ucyk7XG4gICAgfVxuICAgIHB1YmxpYyB0b1JlYWRhYmxlTm9kZVN0cmVhbShvcHRpb25zPzogaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZU9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHN0cmVhbUFkYXB0ZXJzLnRvUmVhZGFibGVOb2RlU3RyZWFtKHRoaXMsIG9wdGlvbnMpO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgdGhyb3coXz86IGFueSkgeyBhd2FpdCB0aGlzLmFib3J0KF8pOyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgIHB1YmxpYyBhc3luYyByZXR1cm4oXz86IGFueSkgeyBhd2FpdCB0aGlzLmNsb3NlKCk7IHJldHVybiBJVEVSQVRPUl9ET05FOyB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVhZChzaXplPzogbnVtYmVyIHwgbnVsbCk6IFByb21pc2U8VFJlYWRhYmxlIHwgbnVsbD4geyByZXR1cm4gKGF3YWl0IHRoaXMubmV4dChzaXplLCAncmVhZCcpKS52YWx1ZTsgfVxuICAgIHB1YmxpYyBhc3luYyBwZWVrKHNpemU/OiBudW1iZXIgfCBudWxsKTogUHJvbWlzZTxUUmVhZGFibGUgfCBudWxsPiB7IHJldHVybiAoYXdhaXQgdGhpcy5uZXh0KHNpemUsICdwZWVrJykpLnZhbHVlOyB9XG4gICAgcHVibGljIG5leHQoLi4uX2FyZ3M6IGFueVtdKTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxUUmVhZGFibGU+PiB7XG4gICAgICAgIGlmICh0aGlzLnZhbHVlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgZG9uZTogZmFsc2UsIHZhbHVlOiB0aGlzLnZhbHVlcy5zaGlmdCgpISB9IGFzIGFueSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5fZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh7IGRvbmU6IHRydWUsIHZhbHVlOiB0aGlzLl9lcnJvci5lcnJvciB9KTtcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5fY2xvc2VkUHJvbWlzZVJlc29sdmUpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoSVRFUkFUT1JfRE9ORSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8VFJlYWRhYmxlPj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzLnB1c2goeyByZXNvbHZlLCByZWplY3QgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBfZW5zdXJlT3BlbigpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Nsb3NlZFByb21pc2VSZXNvbHZlKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSBpcyBjbG9zZWRgKTtcbiAgICB9XG59XG4iXX0=
