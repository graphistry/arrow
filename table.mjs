// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import { Column } from './column';
import { Schema } from './schema';
import { isPromise } from './util/compat';
import { RecordBatch } from './recordbatch';
import { RecordBatchReader } from './ipc/reader';
import { ChunkedVector } from './vector/index';
import { RecordBatchFileWriter, RecordBatchStreamWriter } from './ipc/writer';
export class Table {
    constructor(...args) {
        // List of inner Vectors, possibly spanning batches
        this._columns = [];
        let schema = null;
        if (args[0] instanceof Schema) {
            schema = args.shift();
        }
        let batches = args.reduce(function flatten(xs, x) {
            return Array.isArray(x) ? x.reduce(flatten, xs) : [...xs, x];
        }, []).filter((x) => x instanceof RecordBatch);
        if (!schema && !(schema = batches[0] && batches[0].schema)) {
            throw new TypeError('Table must be initialized with a Schema or at least one RecordBatch with a Schema');
        }
        this._schema = schema;
        this._batches = batches;
        this._batchesUnion = batches.length == 0
            ? new RecordBatch(schema, 0, [])
            : batches.length === 1 ? batches[0]
                : ChunkedVector.concat(...batches);
        this._length = this.batchesUnion.length;
        this._numCols = this.schema.fields.length;
    }
    /** @nocollapse */
    static empty() { return new Table(new Schema([]), []); }
    /** @nocollapse */
    static from(source) {
        if (!source) {
            return Table.empty();
        }
        let reader = RecordBatchReader.from(source);
        if (isPromise(reader)) {
            return (async () => await Table.from(await reader))();
        }
        if (reader.isSync() && (reader = reader.open())) {
            return !reader.schema ? Table.empty() : new Table(reader.schema, [...reader]);
        }
        return (async (opening) => {
            const reader = await opening;
            const schema = reader.schema;
            const batches = [];
            if (schema) {
                for await (let batch of reader) {
                    batches.push(batch);
                }
                return new Table(schema, batches);
            }
            return Table.empty();
        })(reader.open());
    }
    /** @nocollapse */
    static async fromAsync(source) {
        return await Table.from(source);
    }
    /** @nocollapse */
    static fromVectors(vectors, names) {
        return new Table(RecordBatch.from(vectors, names));
    }
    /** @nocollapse */
    static fromStruct(struct) {
        const schema = new Schema(struct.type.children);
        const chunks = (struct instanceof ChunkedVector ? struct.chunks : [struct]);
        return new Table(schema, chunks.map((chunk) => new RecordBatch(schema, chunk.data)));
    }
    get schema() { return this._schema; }
    get length() { return this._length; }
    get numCols() { return this._numCols; }
    get batches() { return this._batches; }
    get batchesUnion() { return this._batchesUnion; }
    get(index) {
        return this.batchesUnion.get(index);
    }
    getColumn(name) {
        return this.getColumnAt(this.getColumnIndex(name));
    }
    getColumnAt(index) {
        if (index < 0 || index >= this.numCols) {
            return null;
        }
        if (this.batches.length === 1) {
            return this.batches[0].getChildAt(index);
        }
        return new Column(this.schema.fields[index], this.batches.map((b) => b.getChildAt(index)));
    }
    getColumnIndex(name) {
        return this.schema.fields.findIndex((f) => f.name === name);
    }
    [Symbol.iterator]() {
        return this.batchesUnion[Symbol.iterator]();
    }
    // @ts-ignore
    serialize(encoding = 'binary', stream = true) {
        const writer = !stream
            ? RecordBatchFileWriter
            : RecordBatchStreamWriter;
        return writer.writeAll(this.batches).toUint8Array(true);
    }
    count() {
        return this.length;
    }
    select(...columnNames) {
        return new Table(this.batches.map((batch) => batch.select(...columnNames)));
    }
}
// protect batches, batchesUnion from es2015/umd mangler
// (<any> Table.prototype)._batches = Object.freeze([]);
// (<any> Table.prototype)._batchesUnion = Object.freeze([]);

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QVEsQ0FBQyxFQUFrQyxDQUFDO0lBQ2hGLENBQUM7SUFDRCxhQUFhO0lBQ04sU0FBUyxDQUFDLFFBQVEsR0FBRyxRQUFRLEVBQUUsTUFBTSxHQUFHLElBQUk7UUFDL0MsTUFBTSxNQUFNLEdBQUcsQ0FBQyxNQUFNO1lBQ2xCLENBQUMsQ0FBQyxxQkFBcUI7WUFDdkIsQ0FBQyxDQUFDLHVCQUF1QixDQUFDO1FBQzlCLE9BQU8sTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFDTSxLQUFLO1FBQ1IsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFDTSxNQUFNLENBQUMsR0FBRyxXQUFxQjtRQUNsQyxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hGLENBQUM7Q0FDSjtBQUVELHdEQUF3RDtBQUN4RCx3REFBd0Q7QUFDeEQsNkRBQTZEIiwiZmlsZSI6InRhYmxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IENvbHVtbiB9IGZyb20gJy4vY29sdW1uJztcbmltcG9ydCB7IFNjaGVtYSwgRmllbGQgfSBmcm9tICcuL3NjaGVtYSc7XG5pbXBvcnQgeyBpc1Byb21pc2UgfSBmcm9tICcuL3V0aWwvY29tcGF0JztcbmltcG9ydCB7IFJlY29yZEJhdGNoIH0gZnJvbSAnLi9yZWNvcmRiYXRjaCc7XG5pbXBvcnQgeyBWZWN0b3IgYXMgVlR5cGUgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2hSZWFkZXIgfSBmcm9tICcuL2lwYy9yZWFkZXInO1xuaW1wb3J0IHsgRGF0YVR5cGUsIFJvd0xpa2UsIFN0cnVjdCB9IGZyb20gJy4vdHlwZSc7XG5pbXBvcnQgeyBWZWN0b3IsIENodW5rZWRWZWN0b3IgfSBmcm9tICcuL3ZlY3Rvci9pbmRleCc7XG5pbXBvcnQgeyBSZWNvcmRCYXRjaEZpbGVXcml0ZXIsIFJlY29yZEJhdGNoU3RyZWFtV3JpdGVyIH0gZnJvbSAnLi9pcGMvd3JpdGVyJztcblxuZXhwb3J0IGludGVyZmFjZSBEYXRhRnJhbWU8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+IHtcbiAgICBjb3VudCgpOiBudW1iZXI7XG4gICAgZmlsdGVyKHByZWRpY2F0ZTogaW1wb3J0KCcuL2NvbXB1dGUvcHJlZGljYXRlJykuUHJlZGljYXRlKTogRGF0YUZyYW1lPFQ+O1xuICAgIGNvdW50QnkobmFtZTogaW1wb3J0KCcuL2NvbXB1dGUvcHJlZGljYXRlJykuQ29sIHwgc3RyaW5nKTogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuQ291bnRCeVJlc3VsdDtcbiAgICBzY2FuKG5leHQ6IGltcG9ydCgnLi9jb21wdXRlL2RhdGFmcmFtZScpLk5leHRGdW5jLCBiaW5kPzogaW1wb3J0KCcuL2NvbXB1dGUvZGF0YWZyYW1lJykuQmluZEZ1bmMpOiB2b2lkO1xuICAgIFtTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8Um93TGlrZTxUPj47XG59XG5cbmV4cG9ydCBjbGFzcyBUYWJsZTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4gaW1wbGVtZW50cyBEYXRhRnJhbWU8VD4ge1xuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBlbXB0eTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4oKSB7IHJldHVybiBuZXcgVGFibGU8VD4obmV3IFNjaGVtYShbXSksIFtdKTsgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KCk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IFJlY29yZEJhdGNoUmVhZGVyPFQ+KTogVGFibGU8VD47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMCk6IFRhYmxlPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzEpOiBUYWJsZTxUPjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBpbXBvcnQoJy4vaXBjL3JlYWRlcicpLkZyb21BcmcyKTogUHJvbWlzZTxUYWJsZTxUPj47XG4gICAgcHVibGljIHN0YXRpYyBmcm9tPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJnMyk6IFByb21pc2U8VGFibGU8VD4+O1xuICAgIHB1YmxpYyBzdGF0aWMgZnJvbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pihzb3VyY2U6IGltcG9ydCgnLi9pcGMvcmVhZGVyJykuRnJvbUFyZzQpOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlOiBQcm9taXNlTGlrZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj4pOiBQcm9taXNlPFRhYmxlPFQ+PjtcbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGZyb208VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oc291cmNlPzogYW55KSB7XG5cbiAgICAgICAgaWYgKCFzb3VyY2UpIHsgcmV0dXJuIFRhYmxlLmVtcHR5PFQ+KCk7IH1cblxuICAgICAgICBsZXQgcmVhZGVyID0gUmVjb3JkQmF0Y2hSZWFkZXIuZnJvbTxUPihzb3VyY2UpIGFzIFJlY29yZEJhdGNoUmVhZGVyPFQ+IHwgUHJvbWlzZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj47XG5cbiAgICAgICAgaWYgKGlzUHJvbWlzZTxSZWNvcmRCYXRjaFJlYWRlcjxUPj4ocmVhZGVyKSkge1xuICAgICAgICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiBhd2FpdCBUYWJsZS5mcm9tKGF3YWl0IHJlYWRlcikpKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlYWRlci5pc1N5bmMoKSAmJiAocmVhZGVyID0gcmVhZGVyLm9wZW4oKSkpIHtcbiAgICAgICAgICAgIHJldHVybiAhcmVhZGVyLnNjaGVtYSA/IFRhYmxlLmVtcHR5PFQ+KCkgOiBuZXcgVGFibGU8VD4ocmVhZGVyLnNjaGVtYSwgWy4uLnJlYWRlcl0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoYXN5bmMgKG9wZW5pbmcpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IGF3YWl0IG9wZW5pbmc7XG4gICAgICAgICAgICBjb25zdCBzY2hlbWEgPSByZWFkZXIuc2NoZW1hO1xuICAgICAgICAgICAgY29uc3QgYmF0Y2hlczogUmVjb3JkQmF0Y2hbXSA9IFtdO1xuICAgICAgICAgICAgaWYgKHNjaGVtYSkge1xuICAgICAgICAgICAgICAgIGZvciBhd2FpdCAobGV0IGJhdGNoIG9mIHJlYWRlcikge1xuICAgICAgICAgICAgICAgICAgICBiYXRjaGVzLnB1c2goYmF0Y2gpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRhYmxlPFQ+KHNjaGVtYSwgYmF0Y2hlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gVGFibGUuZW1wdHk8VD4oKTtcbiAgICAgICAgfSkocmVhZGVyLm9wZW4oKSk7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBmcm9tQXN5bmM8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+KHNvdXJjZTogaW1wb3J0KCcuL2lwYy9yZWFkZXInKS5Gcm9tQXJncyk6IFByb21pc2U8VGFibGU8VD4+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IFRhYmxlLmZyb208VD4oc291cmNlIGFzIGFueSk7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmcm9tVmVjdG9yczxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZTsgfSA9IGFueT4odmVjdG9yczogVlR5cGU8VFtrZXlvZiBUXT5bXSwgbmFtZXM/OiAoa2V5b2YgVClbXSkge1xuICAgICAgICByZXR1cm4gbmV3IFRhYmxlKFJlY29yZEJhdGNoLmZyb20odmVjdG9ycywgbmFtZXMpKTtcbiAgICB9XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGZyb21TdHJ1Y3Q8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGU7IH0gPSBhbnk+KHN0cnVjdDogVmVjdG9yPFN0cnVjdDxUPj4pIHtcbiAgICAgICAgY29uc3Qgc2NoZW1hID0gbmV3IFNjaGVtYTxUPihzdHJ1Y3QudHlwZS5jaGlsZHJlbik7XG4gICAgICAgIGNvbnN0IGNodW5rcyA9IChzdHJ1Y3QgaW5zdGFuY2VvZiBDaHVua2VkVmVjdG9yID8gc3RydWN0LmNodW5rcyA6IFtzdHJ1Y3RdKSBhcyBWVHlwZTxTdHJ1Y3Q8VD4+W107XG4gICAgICAgIHJldHVybiBuZXcgVGFibGUoc2NoZW1hLCBjaHVua3MubWFwKChjaHVuaykgPT4gbmV3IFJlY29yZEJhdGNoKHNjaGVtYSwgY2h1bmsuZGF0YSkpKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3NjaGVtYTogU2NoZW1hO1xuICAgIHByb3RlY3RlZCBfbGVuZ3RoOiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIF9udW1Db2xzOiBudW1iZXI7XG4gICAgLy8gTGlzdCBvZiBpbm5lciBSZWNvcmRCYXRjaGVzXG4gICAgcHJvdGVjdGVkIF9iYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdO1xuICAgIC8vIExpc3Qgb2YgaW5uZXIgVmVjdG9ycywgcG9zc2libHkgc3Bhbm5pbmcgYmF0Y2hlc1xuICAgIHByb3RlY3RlZCByZWFkb25seSBfY29sdW1uczogVmVjdG9yPGFueT5bXSA9IFtdO1xuICAgIC8vIFVuaW9uIG9mIGFsbCBpbm5lciBSZWNvcmRCYXRjaGVzIGludG8gb25lIFJlY29yZEJhdGNoLCBwb3NzaWJseSBjaHVua2VkLlxuICAgIC8vIElmIHRoZSBUYWJsZSBoYXMganVzdCBvbmUgaW5uZXIgUmVjb3JkQmF0Y2gsIHRoaXMgcG9pbnRzIHRvIHRoYXQuXG4gICAgLy8gSWYgdGhlIFRhYmxlIGhhcyBtdWx0aXBsZSBpbm5lciBSZWNvcmRCYXRjaGVzLCB0aGVuIHRoaXMgaXMgYSBDaHVua2VkIHZpZXdcbiAgICAvLyBvdmVyIHRoZSBsaXN0IG9mIFJlY29yZEJhdGNoZXMuIFRoaXMgYWxsb3dzIHVzIHRvIGRlbGVnYXRlIHRoZSByZXNwb25zaWJpbGl0eVxuICAgIC8vIG9mIGluZGV4aW5nLCBpdGVyYXRpbmcsIHNsaWNpbmcsIGFuZCB2aXNpdGluZyB0byB0aGUgTmVzdGVkL0NodW5rZWQgRGF0YS9WaWV3cy5cbiAgICBwcm90ZWN0ZWQgX2JhdGNoZXNVbmlvbjogVmVjdG9yPFN0cnVjdDxUPj47XG5cbiAgICBjb25zdHJ1Y3RvcihiYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvciguLi5iYXRjaGVzOiBSZWNvcmRCYXRjaDxUPltdKTtcbiAgICBjb25zdHJ1Y3RvcihzY2hlbWE6IFNjaGVtYSwgYmF0Y2hlczogUmVjb3JkQmF0Y2g8VD5bXSk7XG4gICAgY29uc3RydWN0b3Ioc2NoZW1hOiBTY2hlbWEsIC4uLmJhdGNoZXM6IFJlY29yZEJhdGNoPFQ+W10pO1xuICAgIGNvbnN0cnVjdG9yKC4uLmFyZ3M6IGFueVtdKSB7XG5cbiAgICAgICAgbGV0IHNjaGVtYTogU2NoZW1hID0gbnVsbCE7XG5cbiAgICAgICAgaWYgKGFyZ3NbMF0gaW5zdGFuY2VvZiBTY2hlbWEpIHtcbiAgICAgICAgICAgIHNjaGVtYSA9IGFyZ3Muc2hpZnQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBiYXRjaGVzID0gYXJncy5yZWR1Y2UoZnVuY3Rpb24gZmxhdHRlbih4czogYW55W10sIHg6IGFueSk6IGFueVtdIHtcbiAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHgpID8geC5yZWR1Y2UoZmxhdHRlbiwgeHMpIDogWy4uLnhzLCB4XTtcbiAgICAgICAgfSwgW10pLmZpbHRlcigoeDogYW55KTogeCBpcyBSZWNvcmRCYXRjaDxUPiA9PiB4IGluc3RhbmNlb2YgUmVjb3JkQmF0Y2gpO1xuXG4gICAgICAgIGlmICghc2NoZW1hICYmICEoc2NoZW1hID0gYmF0Y2hlc1swXSAmJiBiYXRjaGVzWzBdLnNjaGVtYSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RhYmxlIG11c3QgYmUgaW5pdGlhbGl6ZWQgd2l0aCBhIFNjaGVtYSBvciBhdCBsZWFzdCBvbmUgUmVjb3JkQmF0Y2ggd2l0aCBhIFNjaGVtYScpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc2NoZW1hID0gc2NoZW1hO1xuICAgICAgICB0aGlzLl9iYXRjaGVzID0gYmF0Y2hlcztcbiAgICAgICAgdGhpcy5fYmF0Y2hlc1VuaW9uID0gYmF0Y2hlcy5sZW5ndGggPT0gMFxuICAgICAgICAgICAgPyBuZXcgUmVjb3JkQmF0Y2g8VD4oc2NoZW1hLCAwLCBbXSlcbiAgICAgICAgICAgIDogYmF0Y2hlcy5sZW5ndGggPT09IDEgPyBiYXRjaGVzWzBdXG4gICAgICAgICAgICA6IENodW5rZWRWZWN0b3IuY29uY2F0PFN0cnVjdDxUPj4oLi4uYmF0Y2hlcykgYXMgVmVjdG9yPFN0cnVjdDxUPj47XG5cbiAgICAgICAgdGhpcy5fbGVuZ3RoID0gdGhpcy5iYXRjaGVzVW5pb24ubGVuZ3RoO1xuICAgICAgICB0aGlzLl9udW1Db2xzID0gdGhpcy5zY2hlbWEuZmllbGRzLmxlbmd0aDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHNjaGVtYSgpIHsgcmV0dXJuIHRoaXMuX3NjaGVtYTsgfVxuICAgIHB1YmxpYyBnZXQgbGVuZ3RoKCkgeyByZXR1cm4gdGhpcy5fbGVuZ3RoOyB9XG4gICAgcHVibGljIGdldCBudW1Db2xzKCkgeyByZXR1cm4gdGhpcy5fbnVtQ29sczsgfVxuICAgIHB1YmxpYyBnZXQgYmF0Y2hlcygpIHsgcmV0dXJuIHRoaXMuX2JhdGNoZXM7IH1cbiAgICBwdWJsaWMgZ2V0IGJhdGNoZXNVbmlvbigpIHsgcmV0dXJuIHRoaXMuX2JhdGNoZXNVbmlvbjsgfVxuXG4gICAgcHVibGljIGdldChpbmRleDogbnVtYmVyKTogU3RydWN0PFQ+WydUVmFsdWUnXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJhdGNoZXNVbmlvbi5nZXQoaW5kZXgpITtcbiAgICB9XG4gICAgcHVibGljIGdldENvbHVtbjxSIGV4dGVuZHMga2V5b2YgVD4obmFtZTogUik6IFZlY3RvcjxUW1JdPiB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDb2x1bW5BdCh0aGlzLmdldENvbHVtbkluZGV4KG5hbWUpKSBhcyBWZWN0b3I8VFtSXT4gfCBudWxsO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q29sdW1uQXQ8VCBleHRlbmRzIERhdGFUeXBlID0gYW55PihpbmRleDogbnVtYmVyKTogVmVjdG9yPFQ+IHwgbnVsbCB7XG4gICAgICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5udW1Db2xzKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5iYXRjaGVzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmF0Y2hlc1swXS5nZXRDaGlsZEF0PFQ+KGluZGV4KSBhcyBWZWN0b3I8VD4gfCBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgQ29sdW1uPFQ+KFxuICAgICAgICAgICAgdGhpcy5zY2hlbWEuZmllbGRzW2luZGV4XSBhcyBGaWVsZDxUPixcbiAgICAgICAgICAgIHRoaXMuYmF0Y2hlcy5tYXAoKGIpID0+IGIuZ2V0Q2hpbGRBdDxUPihpbmRleCkhIGFzIFZlY3RvcjxUPikpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0Q29sdW1uSW5kZXg8UiBleHRlbmRzIGtleW9mIFQ+KG5hbWU6IFIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2NoZW1hLmZpZWxkcy5maW5kSW5kZXgoKGYpID0+IGYubmFtZSA9PT0gbmFtZSk7XG4gICAgfVxuICAgIHB1YmxpYyBbU3ltYm9sLml0ZXJhdG9yXSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYmF0Y2hlc1VuaW9uW1N5bWJvbC5pdGVyYXRvcl0oKSBhcyBJdGVyYWJsZUl0ZXJhdG9yPFJvd0xpa2U8VD4+O1xuICAgIH1cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHVibGljIHNlcmlhbGl6ZShlbmNvZGluZyA9ICdiaW5hcnknLCBzdHJlYW0gPSB0cnVlKSB7XG4gICAgICAgIGNvbnN0IHdyaXRlciA9ICFzdHJlYW1cbiAgICAgICAgICAgID8gUmVjb3JkQmF0Y2hGaWxlV3JpdGVyXG4gICAgICAgICAgICA6IFJlY29yZEJhdGNoU3RyZWFtV3JpdGVyO1xuICAgICAgICByZXR1cm4gd3JpdGVyLndyaXRlQWxsKHRoaXMuYmF0Y2hlcykudG9VaW50OEFycmF5KHRydWUpO1xuICAgIH1cbiAgICBwdWJsaWMgY291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoO1xuICAgIH1cbiAgICBwdWJsaWMgc2VsZWN0KC4uLmNvbHVtbk5hbWVzOiBzdHJpbmdbXSkge1xuICAgICAgICByZXR1cm4gbmV3IFRhYmxlKHRoaXMuYmF0Y2hlcy5tYXAoKGJhdGNoKSA9PiBiYXRjaC5zZWxlY3QoLi4uY29sdW1uTmFtZXMpKSk7XG4gICAgfVxufVxuXG4vLyBwcm90ZWN0IGJhdGNoZXMsIGJhdGNoZXNVbmlvbiBmcm9tIGVzMjAxNS91bWQgbWFuZ2xlclxuLy8gKDxhbnk+IFRhYmxlLnByb3RvdHlwZSkuX2JhdGNoZXMgPSBPYmplY3QuZnJlZXplKFtdKTtcbi8vICg8YW55PiBUYWJsZS5wcm90b3R5cGUpLl9iYXRjaGVzVW5pb24gPSBPYmplY3QuZnJlZXplKFtdKTtcbiJdfQ==
