// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import { MessageHeader } from '../enum';
import { flatbuffers } from 'flatbuffers';
var ByteBuffer = flatbuffers.ByteBuffer;
import { Message } from './metadata/message';
import { isFileHandle } from '../util/compat';
import { AsyncRandomAccessFile } from '../io/file';
import { toUint8Array } from '../util/buffer';
import { ByteStream, AsyncByteStream } from '../io/stream';
import { ArrowJSON, ITERATOR_DONE } from '../io/interfaces';
const invalidMessageType = (type) => `Expected ${MessageHeader[type]} Message in stream, but was null or length 0.`;
const nullMessage = (type) => `Header pointer of flatbuffer-encoded ${MessageHeader[type]} Message is null or length 0.`;
const invalidMessageMetadata = (expected, actual) => `Expected to read ${expected} metadata bytes, but only read ${actual}.`;
const invalidMessageBodyLength = (expected, actual) => `Expected to read ${expected} bytes for message body, but only read ${actual}.`;
export class MessageReader {
    constructor(source) {
        this.source = source instanceof ByteStream ? source : new ByteStream(source);
    }
    [Symbol.iterator]() { return this; }
    next() {
        let r;
        if ((r = this.readMetadataLength()).done) {
            return ITERATOR_DONE;
        }
        if ((r = this.readMetadata(r.value)).done) {
            return ITERATOR_DONE;
        }
        return r;
    }
    throw(value) { return this.source.throw(value); }
    return(value) { return this.source.return(value); }
    readMessage(type) {
        let r;
        if ((r = this.next()).done) {
            return null;
        }
        if ((type != null) && r.value.headerType !== type) {
            throw new Error(invalidMessageType(type));
        }
        return r.value;
    }
    readMessageBody(bodyLength) {
        if (bodyLength <= 0) {
            return new Uint8Array(0);
        }
        const buf = toUint8Array(this.source.read(bodyLength));
        if (buf.byteLength < bodyLength) {
            throw new Error(invalidMessageBodyLength(bodyLength, buf.byteLength));
        }
        // 1. Work around bugs in fs.ReadStream's internal Buffer pooling, see: https://github.com/nodejs/node/issues/24817
        // 2. Work around https://github.com/whatwg/streams/blob/0ebe4b042e467d9876d80ae045de3843092ad797/reference-implementation/lib/helpers.js#L126
        return /* 1. */ (buf.byteOffset % 8 === 0) &&
            /* 2. */ (buf.byteOffset + buf.byteLength) <= buf.buffer.byteLength ? buf : buf.slice();
    }
    readSchema(throwIfNull = false) {
        const type = MessageHeader.Schema;
        const message = this.readMessage(type);
        const schema = message && message.header();
        if (throwIfNull && !schema) {
            throw new Error(nullMessage(type));
        }
        return schema;
    }
    readMetadataLength() {
        const buf = this.source.read(PADDING);
        const bb = buf && new ByteBuffer(buf);
        const len = +(bb && bb.readInt32(0));
        return { done: len <= 0, value: len };
    }
    readMetadata(metadataLength) {
        const buf = this.source.read(metadataLength);
        if (!buf) {
            return ITERATOR_DONE;
        }
        if (buf.byteLength < metadataLength) {
            throw new Error(invalidMessageMetadata(metadataLength, buf.byteLength));
        }
        return { done: false, value: Message.decode(buf) };
    }
}
export class AsyncMessageReader {
    constructor(source, byteLength) {
        this.source = source instanceof AsyncByteStream ? source
            : isFileHandle(source)
                ? new AsyncRandomAccessFile(source, byteLength)
                : new AsyncByteStream(source);
    }
    [Symbol.asyncIterator]() { return this; }
    async next() {
        let r;
        if ((r = await this.readMetadataLength()).done) {
            return ITERATOR_DONE;
        }
        if ((r = await this.readMetadata(r.value)).done) {
            return ITERATOR_DONE;
        }
        return r;
    }
    async throw(value) { return await this.source.throw(value); }
    async return(value) { return await this.source.return(value); }
    async readMessage(type) {
        let r;
        if ((r = await this.next()).done) {
            return null;
        }
        if ((type != null) && r.value.headerType !== type) {
            throw new Error(invalidMessageType(type));
        }
        return r.value;
    }
    async readMessageBody(bodyLength) {
        if (bodyLength <= 0) {
            return new Uint8Array(0);
        }
        const buf = toUint8Array(await this.source.read(bodyLength));
        if (buf.byteLength < bodyLength) {
            throw new Error(invalidMessageBodyLength(bodyLength, buf.byteLength));
        }
        // 1. Work around bugs in fs.ReadStream's internal Buffer pooling, see: https://github.com/nodejs/node/issues/24817
        // 2. Work around https://github.com/whatwg/streams/blob/0ebe4b042e467d9876d80ae045de3843092ad797/reference-implementation/lib/helpers.js#L126
        return /* 1. */ (buf.byteOffset % 8 === 0) &&
            /* 2. */ (buf.byteOffset + buf.byteLength) <= buf.buffer.byteLength ? buf : buf.slice();
    }
    async readSchema(throwIfNull = false) {
        const type = MessageHeader.Schema;
        const message = await this.readMessage(type);
        const schema = message && message.header();
        if (throwIfNull && !schema) {
            throw new Error(nullMessage(type));
        }
        return schema;
    }
    async readMetadataLength() {
        const buf = await this.source.read(PADDING);
        const bb = buf && new ByteBuffer(buf);
        const len = +(bb && bb.readInt32(0));
        return { done: len <= 0, value: len };
    }
    async readMetadata(metadataLength) {
        const buf = await this.source.read(metadataLength);
        if (!buf) {
            return ITERATOR_DONE;
        }
        if (buf.byteLength < metadataLength) {
            throw new Error(invalidMessageMetadata(metadataLength, buf.byteLength));
        }
        return { done: false, value: Message.decode(buf) };
    }
}
export class JSONMessageReader extends MessageReader {
    constructor(source) {
        super(new Uint8Array(0));
        this._schema = false;
        this._body = [];
        this._batchIndex = 0;
        this._dictionaryIndex = 0;
        this._json = source instanceof ArrowJSON ? source : new ArrowJSON(source);
    }
    next() {
        const { _json, _batchIndex, _dictionaryIndex } = this;
        const numBatches = _json.batches.length;
        const numDictionaries = _json.dictionaries.length;
        if (!this._schema) {
            this._schema = true;
            const message = Message.fromJSON(_json.schema, MessageHeader.Schema);
            return { value: message, done: _batchIndex >= numBatches && _dictionaryIndex >= numDictionaries };
        }
        if (_dictionaryIndex < numDictionaries) {
            const batch = _json.dictionaries[this._dictionaryIndex++];
            this._body = batch['data']['columns'];
            const message = Message.fromJSON(batch, MessageHeader.DictionaryBatch);
            return { done: false, value: message };
        }
        if (_batchIndex < numBatches) {
            const batch = _json.batches[this._batchIndex++];
            this._body = batch['columns'];
            const message = Message.fromJSON(batch, MessageHeader.RecordBatch);
            return { done: false, value: message };
        }
        this._body = [];
        return ITERATOR_DONE;
    }
    readMessageBody(_bodyLength) {
        return flattenDataSources(this._body);
        function flattenDataSources(xs) {
            return (xs || []).reduce((buffers, column) => [
                ...buffers,
                ...(column['VALIDITY'] && [column['VALIDITY']] || []),
                ...(column['TYPE'] && [column['TYPE']] || []),
                ...(column['OFFSET'] && [column['OFFSET']] || []),
                ...(column['DATA'] && [column['DATA']] || []),
                ...flattenDataSources(column['children'])
            ], []);
        }
    }
    readMessage(type) {
        let r;
        if ((r = this.next()).done) {
            return null;
        }
        if ((type != null) && r.value.headerType !== type) {
            throw new Error(invalidMessageType(type));
        }
        return r.value;
    }
    readSchema() {
        const type = MessageHeader.Schema;
        const message = this.readMessage(type);
        const schema = message && message.header();
        if (!message || !schema) {
            throw new Error(nullMessage(type));
        }
        return schema;
    }
}
export const PADDING = 4;
export const MAGIC_STR = 'ARROW1';
export const MAGIC = new Uint8Array(MAGIC_STR.length);
for (let i = 0; i < MAGIC_STR.length; i += 1 | 0) {
    MAGIC[i] = MAGIC_STR.charCodeAt(i);
}
export function checkForMagicArrowString(buffer, index = 0) {
    for (let i = -1, n = MAGIC.length; ++i < n;) {
        if (MAGIC[i] !== buffer[index + i]) {
            return false;
        }
    }
    return true;
}
export function isValidArrowFile(bb) {
    let fileLength = bb.capacity(), footerLength, lengthOffset;
    if ((fileLength < magicX2AndPadding /*                                  Arrow buffer too small */) ||
        (!checkForMagicArrowString(bb.bytes(), 0) /*                        Missing magic start    */) ||
        (!checkForMagicArrowString(bb.bytes(), fileLength - magicLength) /* Missing magic end      */) ||
        ( /*                                                                 Invalid footer length  */(footerLength = bb.readInt32(lengthOffset = fileLength - magicAndPadding)) < 1 &&
            (footerLength + lengthOffset > fileLength))) {
        return false;
    }
    return true;
}
export const magicLength = MAGIC.length;
export const magicAndPadding = magicLength + PADDING;
export const magicX2AndPadding = magicLength * 2 + PADDING;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsNEZBQ0QsQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUcsVUFBVSxHQUFHLGVBQWUsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUM5RSxDQUFDLFlBQVksR0FBRyxZQUFZLEdBQUcsVUFBVSxDQUFDLENBQUMsRUFBRTtRQUM3QyxPQUFPLEtBQUssQ0FBQztLQUNoQjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztBQUN4QyxNQUFNLENBQUMsTUFBTSxlQUFlLEdBQUcsV0FBVyxHQUFHLE9BQU8sQ0FBQztBQUNyRCxNQUFNLENBQUMsTUFBTSxpQkFBaUIsR0FBRyxXQUFXLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyIsImZpbGUiOiJpcGMvbWVzc2FnZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBNZXNzYWdlSGVhZGVyIH0gZnJvbSAnLi4vZW51bSc7XG5pbXBvcnQgeyBmbGF0YnVmZmVycyB9IGZyb20gJ2ZsYXRidWZmZXJzJztcbmltcG9ydCBCeXRlQnVmZmVyID0gZmxhdGJ1ZmZlcnMuQnl0ZUJ1ZmZlcjtcbmltcG9ydCB7IE1lc3NhZ2UgfSBmcm9tICcuL21ldGFkYXRhL21lc3NhZ2UnO1xuaW1wb3J0IHsgaXNGaWxlSGFuZGxlIH0gZnJvbSAnLi4vdXRpbC9jb21wYXQnO1xuaW1wb3J0IHsgQXN5bmNSYW5kb21BY2Nlc3NGaWxlIH0gZnJvbSAnLi4vaW8vZmlsZSc7XG5pbXBvcnQgeyB0b1VpbnQ4QXJyYXksIEFycmF5QnVmZmVyVmlld0lucHV0IH0gZnJvbSAnLi4vdXRpbC9idWZmZXInO1xuaW1wb3J0IHsgQnl0ZVN0cmVhbSwgUmVhZGFibGVTb3VyY2UsIEFzeW5jQnl0ZVN0cmVhbSB9IGZyb20gJy4uL2lvL3N0cmVhbSc7XG5pbXBvcnQgeyBBcnJvd0pTT04sIEFycm93SlNPTkxpa2UsIElURVJBVE9SX0RPTkUsIEZpbGVIYW5kbGUgfSBmcm9tICcuLi9pby9pbnRlcmZhY2VzJztcblxuY29uc3QgaW52YWxpZE1lc3NhZ2VUeXBlICAgICAgID0gKHR5cGU6IE1lc3NhZ2VIZWFkZXIpID0+IGBFeHBlY3RlZCAke01lc3NhZ2VIZWFkZXJbdHlwZV19IE1lc3NhZ2UgaW4gc3RyZWFtLCBidXQgd2FzIG51bGwgb3IgbGVuZ3RoIDAuYDtcbmNvbnN0IG51bGxNZXNzYWdlICAgICAgICAgICAgICA9ICh0eXBlOiBNZXNzYWdlSGVhZGVyKSA9PiBgSGVhZGVyIHBvaW50ZXIgb2YgZmxhdGJ1ZmZlci1lbmNvZGVkICR7TWVzc2FnZUhlYWRlclt0eXBlXX0gTWVzc2FnZSBpcyBudWxsIG9yIGxlbmd0aCAwLmA7XG5jb25zdCBpbnZhbGlkTWVzc2FnZU1ldGFkYXRhICAgPSAoZXhwZWN0ZWQ6IG51bWJlciwgYWN0dWFsOiBudW1iZXIpID0+IGBFeHBlY3RlZCB0byByZWFkICR7ZXhwZWN0ZWR9IG1ldGFkYXRhIGJ5dGVzLCBidXQgb25seSByZWFkICR7YWN0dWFsfS5gO1xuY29uc3QgaW52YWxpZE1lc3NhZ2VCb2R5TGVuZ3RoID0gKGV4cGVjdGVkOiBudW1iZXIsIGFjdHVhbDogbnVtYmVyKSA9PiBgRXhwZWN0ZWQgdG8gcmVhZCAke2V4cGVjdGVkfSBieXRlcyBmb3IgbWVzc2FnZSBib2R5LCBidXQgb25seSByZWFkICR7YWN0dWFsfS5gO1xuXG5leHBvcnQgY2xhc3MgTWVzc2FnZVJlYWRlciBpbXBsZW1lbnRzIEl0ZXJhYmxlSXRlcmF0b3I8TWVzc2FnZT4ge1xuICAgIHByb3RlY3RlZCBzb3VyY2U6IEJ5dGVTdHJlYW07XG4gICAgY29uc3RydWN0b3Ioc291cmNlOiBCeXRlU3RyZWFtIHwgQXJyYXlCdWZmZXJWaWV3SW5wdXQgfCBJdGVyYWJsZTxBcnJheUJ1ZmZlclZpZXdJbnB1dD4pIHtcbiAgICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2UgaW5zdGFuY2VvZiBCeXRlU3RyZWFtID8gc291cmNlIDogbmV3IEJ5dGVTdHJlYW0oc291cmNlKTtcbiAgICB9XG4gICAgcHVibGljIFtTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8TWVzc2FnZT4geyByZXR1cm4gdGhpcyBhcyBJdGVyYWJsZUl0ZXJhdG9yPE1lc3NhZ2U+OyB9XG4gICAgcHVibGljIG5leHQoKTogSXRlcmF0b3JSZXN1bHQ8TWVzc2FnZT4ge1xuICAgICAgICBsZXQgcjtcbiAgICAgICAgaWYgKChyID0gdGhpcy5yZWFkTWV0YWRhdGFMZW5ndGgoKSkuZG9uZSkgeyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgICAgICBpZiAoKHIgPSB0aGlzLnJlYWRNZXRhZGF0YShyLnZhbHVlKSkuZG9uZSkgeyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgICAgICByZXR1cm4gKDxhbnk+IHIpIGFzIEl0ZXJhdG9yUmVzdWx0PE1lc3NhZ2U+O1xuICAgIH1cbiAgICBwdWJsaWMgdGhyb3codmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnRocm93KHZhbHVlKTsgfVxuICAgIHB1YmxpYyByZXR1cm4odmFsdWU/OiBhbnkpIHsgcmV0dXJuIHRoaXMuc291cmNlLnJldHVybih2YWx1ZSk7IH1cbiAgICBwdWJsaWMgcmVhZE1lc3NhZ2U8VCBleHRlbmRzIE1lc3NhZ2VIZWFkZXI+KHR5cGU/OiBUIHwgbnVsbCkge1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8TWVzc2FnZTxUPj47XG4gICAgICAgIGlmICgociA9IHRoaXMubmV4dCgpKS5kb25lKSB7IHJldHVybiBudWxsOyB9XG4gICAgICAgIGlmICgodHlwZSAhPSBudWxsKSAmJiByLnZhbHVlLmhlYWRlclR5cGUgIT09IHR5cGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpbnZhbGlkTWVzc2FnZVR5cGUodHlwZSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByLnZhbHVlO1xuICAgIH1cbiAgICBwdWJsaWMgcmVhZE1lc3NhZ2VCb2R5KGJvZHlMZW5ndGg6IG51bWJlcik6IFVpbnQ4QXJyYXkge1xuICAgICAgICBpZiAoYm9keUxlbmd0aCA8PSAwKSB7IHJldHVybiBuZXcgVWludDhBcnJheSgwKTsgfVxuICAgICAgICBjb25zdCBidWYgPSB0b1VpbnQ4QXJyYXkodGhpcy5zb3VyY2UucmVhZChib2R5TGVuZ3RoKSk7XG4gICAgICAgIGlmIChidWYuYnl0ZUxlbmd0aCA8IGJvZHlMZW5ndGgpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpbnZhbGlkTWVzc2FnZUJvZHlMZW5ndGgoYm9keUxlbmd0aCwgYnVmLmJ5dGVMZW5ndGgpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyAxLiBXb3JrIGFyb3VuZCBidWdzIGluIGZzLlJlYWRTdHJlYW0ncyBpbnRlcm5hbCBCdWZmZXIgcG9vbGluZywgc2VlOiBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvaXNzdWVzLzI0ODE3XG4gICAgICAgIC8vIDIuIFdvcmsgYXJvdW5kIGh0dHBzOi8vZ2l0aHViLmNvbS93aGF0d2cvc3RyZWFtcy9ibG9iLzBlYmU0YjA0MmU0NjdkOTg3NmQ4MGFlMDQ1ZGUzODQzMDkyYWQ3OTcvcmVmZXJlbmNlLWltcGxlbWVudGF0aW9uL2xpYi9oZWxwZXJzLmpzI0wxMjZcbiAgICAgICAgcmV0dXJuIC8qIDEuICovIChidWYuYnl0ZU9mZnNldCAlIDggPT09IDApICYmXG4gICAgICAgICAgICAgICAvKiAyLiAqLyAoYnVmLmJ5dGVPZmZzZXQgKyBidWYuYnl0ZUxlbmd0aCkgPD0gYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoID8gYnVmIDogYnVmLnNsaWNlKCk7XG4gICAgfVxuICAgIHB1YmxpYyByZWFkU2NoZW1hKHRocm93SWZOdWxsID0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgdHlwZSA9IE1lc3NhZ2VIZWFkZXIuU2NoZW1hO1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5yZWFkTWVzc2FnZSh0eXBlKTtcbiAgICAgICAgY29uc3Qgc2NoZW1hID0gbWVzc2FnZSAmJiBtZXNzYWdlLmhlYWRlcigpO1xuICAgICAgICBpZiAodGhyb3dJZk51bGwgJiYgIXNjaGVtYSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG51bGxNZXNzYWdlKHR5cGUpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2NoZW1hO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZE1ldGFkYXRhTGVuZ3RoKCk6IEl0ZXJhdG9yUmVzdWx0PG51bWJlcj4ge1xuICAgICAgICBjb25zdCBidWYgPSB0aGlzLnNvdXJjZS5yZWFkKFBBRERJTkcpO1xuICAgICAgICBjb25zdCBiYiA9IGJ1ZiAmJiBuZXcgQnl0ZUJ1ZmZlcihidWYpO1xuICAgICAgICBjb25zdCBsZW4gPSArKGJiICYmIGJiLnJlYWRJbnQzMigwKSkhO1xuICAgICAgICByZXR1cm4geyBkb25lOiBsZW4gPD0gMCwgdmFsdWU6IGxlbiB9O1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgcmVhZE1ldGFkYXRhKG1ldGFkYXRhTGVuZ3RoOiBudW1iZXIpOiBJdGVyYXRvclJlc3VsdDxNZXNzYWdlPiB7XG4gICAgICAgIGNvbnN0IGJ1ZiA9IHRoaXMuc291cmNlLnJlYWQobWV0YWRhdGFMZW5ndGgpO1xuICAgICAgICBpZiAoIWJ1ZikgeyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgICAgICBpZiAoYnVmLmJ5dGVMZW5ndGggPCBtZXRhZGF0YUxlbmd0aCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGludmFsaWRNZXNzYWdlTWV0YWRhdGEobWV0YWRhdGFMZW5ndGgsIGJ1Zi5ieXRlTGVuZ3RoKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlOiBNZXNzYWdlLmRlY29kZShidWYpIH07XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgQXN5bmNNZXNzYWdlUmVhZGVyIGltcGxlbWVudHMgQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPE1lc3NhZ2U+IHtcbiAgICBwcm90ZWN0ZWQgc291cmNlOiBBc3luY0J5dGVTdHJlYW07XG4gICAgY29uc3RydWN0b3Ioc291cmNlOiBSZWFkYWJsZVNvdXJjZTxVaW50OEFycmF5Pik7XG4gICAgY29uc3RydWN0b3Ioc291cmNlOiBGaWxlSGFuZGxlLCBieXRlTGVuZ3RoPzogbnVtYmVyKTtcbiAgICBjb25zdHJ1Y3Rvcihzb3VyY2U6IGFueSwgYnl0ZUxlbmd0aD86IG51bWJlcikge1xuICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZSBpbnN0YW5jZW9mIEFzeW5jQnl0ZVN0cmVhbSA/IHNvdXJjZVxuICAgICAgICAgICAgOiBpc0ZpbGVIYW5kbGUoc291cmNlKVxuICAgICAgICAgICAgPyBuZXcgQXN5bmNSYW5kb21BY2Nlc3NGaWxlKHNvdXJjZSwgYnl0ZUxlbmd0aCEpXG4gICAgICAgICAgICA6IG5ldyBBc3luY0J5dGVTdHJlYW0oc291cmNlKTtcbiAgICB9XG4gICAgcHVibGljIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTogQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPE1lc3NhZ2U+IHsgcmV0dXJuIHRoaXMgYXMgQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPE1lc3NhZ2U+OyB9XG4gICAgcHVibGljIGFzeW5jIG5leHQoKTogUHJvbWlzZTxJdGVyYXRvclJlc3VsdDxNZXNzYWdlPj4ge1xuICAgICAgICBsZXQgcjtcbiAgICAgICAgaWYgKChyID0gYXdhaXQgdGhpcy5yZWFkTWV0YWRhdGFMZW5ndGgoKSkuZG9uZSkgeyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgICAgICBpZiAoKHIgPSBhd2FpdCB0aGlzLnJlYWRNZXRhZGF0YShyLnZhbHVlKSkuZG9uZSkgeyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgICAgICByZXR1cm4gKDxhbnk+IHIpIGFzIEl0ZXJhdG9yUmVzdWx0PE1lc3NhZ2U+O1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgdGhyb3codmFsdWU/OiBhbnkpIHsgcmV0dXJuIGF3YWl0IHRoaXMuc291cmNlLnRocm93KHZhbHVlKTsgfVxuICAgIHB1YmxpYyBhc3luYyByZXR1cm4odmFsdWU/OiBhbnkpIHsgcmV0dXJuIGF3YWl0IHRoaXMuc291cmNlLnJldHVybih2YWx1ZSk7IH1cbiAgICBwdWJsaWMgYXN5bmMgcmVhZE1lc3NhZ2U8VCBleHRlbmRzIE1lc3NhZ2VIZWFkZXI+KHR5cGU/OiBUIHwgbnVsbCkge1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8TWVzc2FnZTxUPj47XG4gICAgICAgIGlmICgociA9IGF3YWl0IHRoaXMubmV4dCgpKS5kb25lKSB7IHJldHVybiBudWxsOyB9XG4gICAgICAgIGlmICgodHlwZSAhPSBudWxsKSAmJiByLnZhbHVlLmhlYWRlclR5cGUgIT09IHR5cGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpbnZhbGlkTWVzc2FnZVR5cGUodHlwZSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByLnZhbHVlO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgcmVhZE1lc3NhZ2VCb2R5KGJvZHlMZW5ndGg6IG51bWJlcik6IFByb21pc2U8VWludDhBcnJheT4ge1xuICAgICAgICBpZiAoYm9keUxlbmd0aCA8PSAwKSB7IHJldHVybiBuZXcgVWludDhBcnJheSgwKTsgfVxuICAgICAgICBjb25zdCBidWYgPSB0b1VpbnQ4QXJyYXkoYXdhaXQgdGhpcy5zb3VyY2UucmVhZChib2R5TGVuZ3RoKSk7XG4gICAgICAgIGlmIChidWYuYnl0ZUxlbmd0aCA8IGJvZHlMZW5ndGgpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpbnZhbGlkTWVzc2FnZUJvZHlMZW5ndGgoYm9keUxlbmd0aCwgYnVmLmJ5dGVMZW5ndGgpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyAxLiBXb3JrIGFyb3VuZCBidWdzIGluIGZzLlJlYWRTdHJlYW0ncyBpbnRlcm5hbCBCdWZmZXIgcG9vbGluZywgc2VlOiBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvaXNzdWVzLzI0ODE3XG4gICAgICAgIC8vIDIuIFdvcmsgYXJvdW5kIGh0dHBzOi8vZ2l0aHViLmNvbS93aGF0d2cvc3RyZWFtcy9ibG9iLzBlYmU0YjA0MmU0NjdkOTg3NmQ4MGFlMDQ1ZGUzODQzMDkyYWQ3OTcvcmVmZXJlbmNlLWltcGxlbWVudGF0aW9uL2xpYi9oZWxwZXJzLmpzI0wxMjZcbiAgICAgICAgcmV0dXJuIC8qIDEuICovIChidWYuYnl0ZU9mZnNldCAlIDggPT09IDApICYmXG4gICAgICAgICAgICAgICAvKiAyLiAqLyAoYnVmLmJ5dGVPZmZzZXQgKyBidWYuYnl0ZUxlbmd0aCkgPD0gYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoID8gYnVmIDogYnVmLnNsaWNlKCk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyByZWFkU2NoZW1hKHRocm93SWZOdWxsID0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgdHlwZSA9IE1lc3NhZ2VIZWFkZXIuU2NoZW1hO1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYXdhaXQgdGhpcy5yZWFkTWVzc2FnZSh0eXBlKTtcbiAgICAgICAgY29uc3Qgc2NoZW1hID0gbWVzc2FnZSAmJiBtZXNzYWdlLmhlYWRlcigpO1xuICAgICAgICBpZiAodGhyb3dJZk51bGwgJiYgIXNjaGVtYSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG51bGxNZXNzYWdlKHR5cGUpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2NoZW1hO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgYXN5bmMgcmVhZE1ldGFkYXRhTGVuZ3RoKCk6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8bnVtYmVyPj4ge1xuICAgICAgICBjb25zdCBidWYgPSBhd2FpdCB0aGlzLnNvdXJjZS5yZWFkKFBBRERJTkcpO1xuICAgICAgICBjb25zdCBiYiA9IGJ1ZiAmJiBuZXcgQnl0ZUJ1ZmZlcihidWYpO1xuICAgICAgICBjb25zdCBsZW4gPSArKGJiICYmIGJiLnJlYWRJbnQzMigwKSkhO1xuICAgICAgICByZXR1cm4geyBkb25lOiBsZW4gPD0gMCwgdmFsdWU6IGxlbiB9O1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgYXN5bmMgcmVhZE1ldGFkYXRhKG1ldGFkYXRhTGVuZ3RoOiBudW1iZXIpOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PE1lc3NhZ2U+PiB7XG4gICAgICAgIGNvbnN0IGJ1ZiA9IGF3YWl0IHRoaXMuc291cmNlLnJlYWQobWV0YWRhdGFMZW5ndGgpO1xuICAgICAgICBpZiAoIWJ1ZikgeyByZXR1cm4gSVRFUkFUT1JfRE9ORTsgfVxuICAgICAgICBpZiAoYnVmLmJ5dGVMZW5ndGggPCBtZXRhZGF0YUxlbmd0aCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGludmFsaWRNZXNzYWdlTWV0YWRhdGEobWV0YWRhdGFMZW5ndGgsIGJ1Zi5ieXRlTGVuZ3RoKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlOiBNZXNzYWdlLmRlY29kZShidWYpIH07XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgSlNPTk1lc3NhZ2VSZWFkZXIgZXh0ZW5kcyBNZXNzYWdlUmVhZGVyIHtcbiAgICBwcml2YXRlIF9zY2hlbWEgPSBmYWxzZTtcbiAgICBwcml2YXRlIF9qc29uOiBBcnJvd0pTT047XG4gICAgcHJpdmF0ZSBfYm9keTogYW55W10gPSBbXTtcbiAgICBwcml2YXRlIF9iYXRjaEluZGV4ID0gMDtcbiAgICBwcml2YXRlIF9kaWN0aW9uYXJ5SW5kZXggPSAwO1xuICAgIGNvbnN0cnVjdG9yKHNvdXJjZTogQXJyb3dKU09OIHwgQXJyb3dKU09OTGlrZSkge1xuICAgICAgICBzdXBlcihuZXcgVWludDhBcnJheSgwKSk7XG4gICAgICAgIHRoaXMuX2pzb24gPSBzb3VyY2UgaW5zdGFuY2VvZiBBcnJvd0pTT04gPyBzb3VyY2UgOiBuZXcgQXJyb3dKU09OKHNvdXJjZSk7XG4gICAgfVxuICAgIHB1YmxpYyBuZXh0KCkge1xuICAgICAgICBjb25zdCB7IF9qc29uLCBfYmF0Y2hJbmRleCwgX2RpY3Rpb25hcnlJbmRleCB9ID0gdGhpcztcbiAgICAgICAgY29uc3QgbnVtQmF0Y2hlcyA9IF9qc29uLmJhdGNoZXMubGVuZ3RoO1xuICAgICAgICBjb25zdCBudW1EaWN0aW9uYXJpZXMgPSBfanNvbi5kaWN0aW9uYXJpZXMubGVuZ3RoO1xuICAgICAgICBpZiAoIXRoaXMuX3NjaGVtYSkge1xuICAgICAgICAgICAgdGhpcy5fc2NoZW1hID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBNZXNzYWdlLmZyb21KU09OKF9qc29uLnNjaGVtYSwgTWVzc2FnZUhlYWRlci5TY2hlbWEpO1xuICAgICAgICAgICAgcmV0dXJuIHsgdmFsdWU6IG1lc3NhZ2UsIGRvbmU6IF9iYXRjaEluZGV4ID49IG51bUJhdGNoZXMgJiYgX2RpY3Rpb25hcnlJbmRleCA+PSBudW1EaWN0aW9uYXJpZXMgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoX2RpY3Rpb25hcnlJbmRleCA8IG51bURpY3Rpb25hcmllcykge1xuICAgICAgICAgICAgY29uc3QgYmF0Y2ggPSBfanNvbi5kaWN0aW9uYXJpZXNbdGhpcy5fZGljdGlvbmFyeUluZGV4KytdO1xuICAgICAgICAgICAgdGhpcy5fYm9keSA9IGJhdGNoWydkYXRhJ11bJ2NvbHVtbnMnXTtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBNZXNzYWdlLmZyb21KU09OKGJhdGNoLCBNZXNzYWdlSGVhZGVyLkRpY3Rpb25hcnlCYXRjaCk7XG4gICAgICAgICAgICByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWU6IG1lc3NhZ2UgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoX2JhdGNoSW5kZXggPCBudW1CYXRjaGVzKSB7XG4gICAgICAgICAgICBjb25zdCBiYXRjaCA9IF9qc29uLmJhdGNoZXNbdGhpcy5fYmF0Y2hJbmRleCsrXTtcbiAgICAgICAgICAgIHRoaXMuX2JvZHkgPSBiYXRjaFsnY29sdW1ucyddO1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IE1lc3NhZ2UuZnJvbUpTT04oYmF0Y2gsIE1lc3NhZ2VIZWFkZXIuUmVjb3JkQmF0Y2gpO1xuICAgICAgICAgICAgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlOiBtZXNzYWdlIH07XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYm9keSA9IFtdO1xuICAgICAgICByZXR1cm4gSVRFUkFUT1JfRE9ORTtcbiAgICB9XG4gICAgcHVibGljIHJlYWRNZXNzYWdlQm9keShfYm9keUxlbmd0aD86IG51bWJlcikge1xuICAgICAgICByZXR1cm4gZmxhdHRlbkRhdGFTb3VyY2VzKHRoaXMuX2JvZHkpIGFzIGFueTtcbiAgICAgICAgZnVuY3Rpb24gZmxhdHRlbkRhdGFTb3VyY2VzKHhzOiBhbnlbXSk6IGFueVtdW10ge1xuICAgICAgICAgICAgcmV0dXJuICh4cyB8fCBbXSkucmVkdWNlPGFueVtdW10+KChidWZmZXJzLCBjb2x1bW46IGFueSkgPT4gW1xuICAgICAgICAgICAgICAgIC4uLmJ1ZmZlcnMsXG4gICAgICAgICAgICAgICAgLi4uKGNvbHVtblsnVkFMSURJVFknXSAmJiBbY29sdW1uWydWQUxJRElUWSddXSB8fCBbXSksXG4gICAgICAgICAgICAgICAgLi4uKGNvbHVtblsnVFlQRSddICYmIFtjb2x1bW5bJ1RZUEUnXV0gfHwgW10pLFxuICAgICAgICAgICAgICAgIC4uLihjb2x1bW5bJ09GRlNFVCddICYmIFtjb2x1bW5bJ09GRlNFVCddXSB8fCBbXSksXG4gICAgICAgICAgICAgICAgLi4uKGNvbHVtblsnREFUQSddICYmIFtjb2x1bW5bJ0RBVEEnXV0gfHwgW10pLFxuICAgICAgICAgICAgICAgIC4uLmZsYXR0ZW5EYXRhU291cmNlcyhjb2x1bW5bJ2NoaWxkcmVuJ10pXG4gICAgICAgICAgICBdLCBbXSBhcyBhbnlbXVtdKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgcmVhZE1lc3NhZ2U8VCBleHRlbmRzIE1lc3NhZ2VIZWFkZXI+KHR5cGU/OiBUIHwgbnVsbCkge1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8TWVzc2FnZTxUPj47XG4gICAgICAgIGlmICgociA9IHRoaXMubmV4dCgpKS5kb25lKSB7IHJldHVybiBudWxsOyB9XG4gICAgICAgIGlmICgodHlwZSAhPSBudWxsKSAmJiByLnZhbHVlLmhlYWRlclR5cGUgIT09IHR5cGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpbnZhbGlkTWVzc2FnZVR5cGUodHlwZSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByLnZhbHVlO1xuICAgIH1cbiAgICBwdWJsaWMgcmVhZFNjaGVtYSgpIHtcbiAgICAgICAgY29uc3QgdHlwZSA9IE1lc3NhZ2VIZWFkZXIuU2NoZW1hO1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5yZWFkTWVzc2FnZSh0eXBlKTtcbiAgICAgICAgY29uc3Qgc2NoZW1hID0gbWVzc2FnZSAmJiBtZXNzYWdlLmhlYWRlcigpO1xuICAgICAgICBpZiAoIW1lc3NhZ2UgfHwgIXNjaGVtYSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG51bGxNZXNzYWdlKHR5cGUpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2NoZW1hO1xuICAgIH1cbn1cblxuZXhwb3J0IGNvbnN0IFBBRERJTkcgPSA0O1xuZXhwb3J0IGNvbnN0IE1BR0lDX1NUUiA9ICdBUlJPVzEnO1xuZXhwb3J0IGNvbnN0IE1BR0lDID0gbmV3IFVpbnQ4QXJyYXkoTUFHSUNfU1RSLmxlbmd0aCk7XG5cbmZvciAobGV0IGkgPSAwOyBpIDwgTUFHSUNfU1RSLmxlbmd0aDsgaSArPSAxIHwgMCkge1xuICAgIE1BR0lDW2ldID0gTUFHSUNfU1RSLmNoYXJDb2RlQXQoaSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGVja0Zvck1hZ2ljQXJyb3dTdHJpbmcoYnVmZmVyOiBVaW50OEFycmF5LCBpbmRleCA9IDApIHtcbiAgICBmb3IgKGxldCBpID0gLTEsIG4gPSBNQUdJQy5sZW5ndGg7ICsraSA8IG47KSB7XG4gICAgICAgIGlmIChNQUdJQ1tpXSAhPT0gYnVmZmVyW2luZGV4ICsgaV0pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzVmFsaWRBcnJvd0ZpbGUoYmI6IEJ5dGVCdWZmZXIpIHtcbiAgICBsZXQgZmlsZUxlbmd0aCA9IGJiLmNhcGFjaXR5KCksIGZvb3Rlckxlbmd0aDogbnVtYmVyLCBsZW5ndGhPZmZzZXQ6IG51bWJlcjtcbiAgICBpZiAoKGZpbGVMZW5ndGggPCBtYWdpY1gyQW5kUGFkZGluZyAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcnJvdyBidWZmZXIgdG9vIHNtYWxsICovKSB8fFxuICAgICAgICAoIWNoZWNrRm9yTWFnaWNBcnJvd1N0cmluZyhiYi5ieXRlcygpLCAwKSAvKiAgICAgICAgICAgICAgICAgICAgICAgIE1pc3NpbmcgbWFnaWMgc3RhcnQgICAgKi8pIHx8XG4gICAgICAgICghY2hlY2tGb3JNYWdpY0Fycm93U3RyaW5nKGJiLmJ5dGVzKCksIGZpbGVMZW5ndGggLSBtYWdpY0xlbmd0aCkgLyogTWlzc2luZyBtYWdpYyBlbmQgICAgICAqLykgfHxcbiAgICAgICAgKC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJbnZhbGlkIGZvb3RlciBsZW5ndGggICovXG4gICAgICAgIChmb290ZXJMZW5ndGggPSBiYi5yZWFkSW50MzIobGVuZ3RoT2Zmc2V0ID0gZmlsZUxlbmd0aCAtIG1hZ2ljQW5kUGFkZGluZykpIDwgMSAmJlxuICAgICAgICAoZm9vdGVyTGVuZ3RoICsgbGVuZ3RoT2Zmc2V0ID4gZmlsZUxlbmd0aCkpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBjb25zdCBtYWdpY0xlbmd0aCA9IE1BR0lDLmxlbmd0aDtcbmV4cG9ydCBjb25zdCBtYWdpY0FuZFBhZGRpbmcgPSBtYWdpY0xlbmd0aCArIFBBRERJTkc7XG5leHBvcnQgY29uc3QgbWFnaWNYMkFuZFBhZGRpbmcgPSBtYWdpY0xlbmd0aCAqIDIgKyBQQURESU5HO1xuIl19
