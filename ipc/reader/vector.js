"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const vector_1 = require("../../vector");
const recordbatch_1 = require("../../recordbatch");
const visitor_1 = require("../../visitor");
const metadata_1 = require("../metadata");
const data_1 = require("../../data");
const type_1 = require("../../type");
function* readRecordBatches(messages) {
    for (const { schema, message, loader } of messages) {
        yield* readRecordBatch(schema, message, loader);
    }
}
exports.readRecordBatches = readRecordBatches;
function readRecordBatchesAsync(messages) {
    return tslib_1.__asyncGenerator(this, arguments, function* readRecordBatchesAsync_1() {
        var e_1, _a;
        try {
            for (var messages_1 = tslib_1.__asyncValues(messages), messages_1_1; messages_1_1 = yield tslib_1.__await(messages_1.next()), !messages_1_1.done;) {
                const { schema, message, loader } = messages_1_1.value;
                yield tslib_1.__await(yield* tslib_1.__asyncDelegator(tslib_1.__asyncValues(readRecordBatch(schema, message, loader))));
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (messages_1_1 && !messages_1_1.done && (_a = messages_1.return)) yield tslib_1.__await(_a.call(messages_1));
            }
            finally { if (e_1) throw e_1.error; }
        }
    });
}
exports.readRecordBatchesAsync = readRecordBatchesAsync;
function* readRecordBatch(schema, message, loader) {
    if (metadata_1.Message.isRecordBatch(message)) {
        yield new recordbatch_1.RecordBatch(schema, message.length, loader.visitFields(schema.fields));
    }
    else if (metadata_1.Message.isDictionaryBatch(message)) {
        const dictionaryId = message.id;
        const dictionaries = loader.dictionaries;
        const dictionaryField = schema.dictionaries.get(dictionaryId);
        const dictionaryDataType = dictionaryField.type.dictionary;
        let dictionaryVector = vector_1.Vector.create(loader.visit(dictionaryDataType));
        if (message.isDelta && dictionaries.has(dictionaryId)) {
            dictionaryVector = dictionaries.get(dictionaryId).concat(dictionaryVector);
        }
        dictionaries.set(dictionaryId, dictionaryVector);
    }
}
exports.readRecordBatch = readRecordBatch;
class TypeDataLoader extends visitor_1.TypeVisitor {
    constructor(nodes, buffers, dictionaries) {
        super();
        this.nodes = nodes;
        this.buffers = buffers;
        this.dictionaries = dictionaries;
    }
    visitFields(fields) { return fields.map((field) => this.visit(field.type)); }
    visitNull(type) { return this.visitNullType(type); }
    visitInt(type) { return this.visitFlatType(type); }
    visitFloat(type) { return this.visitFlatType(type); }
    visitBinary(type) { return this.visitFlatList(type); }
    visitUtf8(type) { return this.visitFlatList(type); }
    visitBool(type) { return this.visitBoolType(type); }
    visitDecimal(type) { return this.visitFlatType(type); }
    visitDate(type) { return this.visitFlatType(type); }
    visitTime(type) { return this.visitFlatType(type); }
    visitTimestamp(type) { return this.visitFlatType(type); }
    visitInterval(type) { return this.visitFlatType(type); }
    visitList(type) { return this.visitListType(type); }
    visitStruct(type) { return this.visitNestedType(type); }
    visitUnion(type) { return this.visitUnionType(type); }
    visitFixedSizeBinary(type) { return this.visitFlatType(type); }
    visitFixedSizeList(type) { return this.visitFixedSizeListType(type); }
    visitMap(type) { return this.visitNestedType(type); }
    visitDictionary(type) {
        return new data_1.DictionaryData(type, this.dictionaries.get(type.id), this.visit(type.indices));
    }
    getFieldMetadata() { return this.nodes.next().value; }
    getBufferMetadata() { return this.buffers.next().value; }
    readNullBitmap(type, nullCount, buffer = this.getBufferMetadata()) {
        return nullCount > 0 && this.readData(type, buffer) || new Uint8Array(0);
    }
    visitNullType(type, { length, nullCount } = this.getFieldMetadata()) {
        return new data_1.FlatData(type, length, this.readNullBitmap(type, nullCount), new Uint8Array(0), 0, nullCount);
    }
    visitFlatType(type, { length, nullCount } = this.getFieldMetadata()) {
        return new data_1.FlatData(type, length, this.readNullBitmap(type, nullCount), this.readData(type), 0, nullCount);
    }
    visitBoolType(type, { length, nullCount } = this.getFieldMetadata(), data) {
        return new data_1.BoolData(type, length, this.readNullBitmap(type, nullCount), data || this.readData(type), 0, nullCount);
    }
    visitFlatList(type, { length, nullCount } = this.getFieldMetadata()) {
        return new data_1.FlatListData(type, length, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.readData(type), 0, nullCount);
    }
    visitListType(type, { length, nullCount } = this.getFieldMetadata()) {
        return new data_1.ListData(type, length, this.readNullBitmap(type, nullCount), this.readOffsets(type), this.visit(type.children[0].type), 0, nullCount);
    }
    visitFixedSizeListType(type, { length, nullCount } = this.getFieldMetadata()) {
        return new data_1.SingleNestedData(type, length, this.readNullBitmap(type, nullCount), this.visit(type.children[0].type), 0, nullCount);
    }
    visitNestedType(type, { length, nullCount } = this.getFieldMetadata()) {
        return new data_1.NestedData(type, length, this.readNullBitmap(type, nullCount), this.visitFields(type.children), 0, nullCount);
    }
    visitUnionType(type, { length, nullCount } = this.getFieldMetadata()) {
        return type.mode === type_1.UnionMode.Sparse ?
            new data_1.SparseUnionData(type, length, this.readNullBitmap(type, nullCount), this.readTypeIds(type), this.visitFields(type.children), 0, nullCount) :
            new data_1.DenseUnionData(type, length, this.readNullBitmap(type, nullCount), this.readTypeIds(type), this.readOffsets(type), this.visitFields(type.children), 0, nullCount);
    }
}
exports.TypeDataLoader = TypeDataLoader;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxnQkFBZ0IsRUFBRTtRQUNuSCxPQUFPLElBQUksaUJBQVUsQ0FBSSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUNoSSxDQUFDO0lBQ1MsY0FBYyxDQUFDLElBQThCLEVBQUUsRUFBRSxNQUFNLEVBQUUsU0FBUyxLQUFvQixJQUFJLENBQUMsZ0JBQWdCLEVBQUU7UUFDbkgsT0FBTyxJQUFJLENBQUMsSUFBSSxLQUFLLGdCQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbkMsSUFBSSxzQkFBZSxDQUFDLElBQW1CLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDL0osSUFBSSxxQkFBYyxDQUFDLElBQWtCLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDNUwsQ0FBQztDQUNKO0FBckVELHdDQXFFQyIsImZpbGUiOiJpcGMvcmVhZGVyL3ZlY3Rvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBWZWN0b3IgfSBmcm9tICcuLi8uLi92ZWN0b3InO1xuaW1wb3J0IHsgUmVjb3JkQmF0Y2ggfSBmcm9tICcuLi8uLi9yZWNvcmRiYXRjaCc7XG5pbXBvcnQgeyBUeXBlVmlzaXRvciB9IGZyb20gJy4uLy4uL3Zpc2l0b3InO1xuaW1wb3J0IHsgRmxhdFR5cGUsIE5lc3RlZFR5cGUsIExpc3RUeXBlIH0gZnJvbSAnLi4vLi4vdHlwZSc7XG5pbXBvcnQgeyBNZXNzYWdlLCBGaWVsZE1ldGFkYXRhLCBCdWZmZXJNZXRhZGF0YSB9IGZyb20gJy4uL21ldGFkYXRhJztcbmltcG9ydCB7IEZsYXREYXRhLCBMaXN0RGF0YSwgTmVzdGVkRGF0YSwgU2luZ2xlTmVzdGVkRGF0YSwgRGVuc2VVbmlvbkRhdGEsIFNwYXJzZVVuaW9uRGF0YSwgQm9vbERhdGEsIEZsYXRMaXN0RGF0YSwgRGljdGlvbmFyeURhdGEgfSBmcm9tICcuLi8uLi9kYXRhJztcbmltcG9ydCB7XG4gICAgU2NoZW1hLCBGaWVsZCxcbiAgICBEaWN0aW9uYXJ5LFxuICAgIE51bGwsIEludCwgRmxvYXQsXG4gICAgQmluYXJ5LCBCb29sLCBVdGY4LCBEZWNpbWFsLFxuICAgIERhdGVfLCBUaW1lLCBUaW1lc3RhbXAsIEludGVydmFsLFxuICAgIExpc3QsIFN0cnVjdCwgVW5pb24sIEZpeGVkU2l6ZUJpbmFyeSwgRml4ZWRTaXplTGlzdCwgTWFwXyxcbiAgICBVbmlvbk1vZGUsIFNwYXJzZVVuaW9uLCBEZW5zZVVuaW9uLCBGbGF0TGlzdFR5cGUsIERhdGFUeXBlLFxufSBmcm9tICcuLi8uLi90eXBlJztcblxuZXhwb3J0IGZ1bmN0aW9uKiByZWFkUmVjb3JkQmF0Y2hlcyhtZXNzYWdlczogSXRlcmFibGU8eyBzY2hlbWE6IFNjaGVtYSwgbWVzc2FnZTogTWVzc2FnZSwgbG9hZGVyOiBUeXBlRGF0YUxvYWRlciB9Pikge1xuICAgIGZvciAoY29uc3QgeyBzY2hlbWEsIG1lc3NhZ2UsIGxvYWRlciB9IG9mIG1lc3NhZ2VzKSB7XG4gICAgICAgIHlpZWxkKiByZWFkUmVjb3JkQmF0Y2goc2NoZW1hLCBtZXNzYWdlLCBsb2FkZXIpO1xuICAgIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uKiByZWFkUmVjb3JkQmF0Y2hlc0FzeW5jKG1lc3NhZ2VzOiBBc3luY0l0ZXJhYmxlPHsgc2NoZW1hOiBTY2hlbWEsIG1lc3NhZ2U6IE1lc3NhZ2UsIGxvYWRlcjogVHlwZURhdGFMb2FkZXIgfT4pIHtcbiAgICBmb3IgYXdhaXQgKGNvbnN0IHsgc2NoZW1hLCBtZXNzYWdlLCBsb2FkZXIgfSBvZiBtZXNzYWdlcykge1xuICAgICAgICB5aWVsZCogcmVhZFJlY29yZEJhdGNoKHNjaGVtYSwgbWVzc2FnZSwgbG9hZGVyKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiogcmVhZFJlY29yZEJhdGNoKHNjaGVtYTogU2NoZW1hLCBtZXNzYWdlOiBNZXNzYWdlLCBsb2FkZXI6IFR5cGVEYXRhTG9hZGVyKSB7XG4gICAgaWYgKE1lc3NhZ2UuaXNSZWNvcmRCYXRjaChtZXNzYWdlKSkge1xuICAgICAgICB5aWVsZCBuZXcgUmVjb3JkQmF0Y2goc2NoZW1hLCBtZXNzYWdlLmxlbmd0aCwgbG9hZGVyLnZpc2l0RmllbGRzKHNjaGVtYS5maWVsZHMpKTtcbiAgICB9IGVsc2UgaWYgKE1lc3NhZ2UuaXNEaWN0aW9uYXJ5QmF0Y2gobWVzc2FnZSkpIHtcbiAgICAgICAgY29uc3QgZGljdGlvbmFyeUlkID0gbWVzc2FnZS5pZDtcbiAgICAgICAgY29uc3QgZGljdGlvbmFyaWVzID0gbG9hZGVyLmRpY3Rpb25hcmllcztcbiAgICAgICAgY29uc3QgZGljdGlvbmFyeUZpZWxkID0gc2NoZW1hLmRpY3Rpb25hcmllcy5nZXQoZGljdGlvbmFyeUlkKSE7XG4gICAgICAgIGNvbnN0IGRpY3Rpb25hcnlEYXRhVHlwZSA9IChkaWN0aW9uYXJ5RmllbGQudHlwZSBhcyBEaWN0aW9uYXJ5KS5kaWN0aW9uYXJ5O1xuICAgICAgICBsZXQgZGljdGlvbmFyeVZlY3RvciA9IFZlY3Rvci5jcmVhdGUobG9hZGVyLnZpc2l0KGRpY3Rpb25hcnlEYXRhVHlwZSkpO1xuICAgICAgICBpZiAobWVzc2FnZS5pc0RlbHRhICYmIGRpY3Rpb25hcmllcy5oYXMoZGljdGlvbmFyeUlkKSkge1xuICAgICAgICAgICAgZGljdGlvbmFyeVZlY3RvciA9IGRpY3Rpb25hcmllcy5nZXQoZGljdGlvbmFyeUlkKSEuY29uY2F0KGRpY3Rpb25hcnlWZWN0b3IpO1xuICAgICAgICB9XG4gICAgICAgIGRpY3Rpb25hcmllcy5zZXQoZGljdGlvbmFyeUlkLCBkaWN0aW9uYXJ5VmVjdG9yKTtcbiAgICB9XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBUeXBlRGF0YUxvYWRlciBleHRlbmRzIFR5cGVWaXNpdG9yIHtcblxuICAgIHB1YmxpYyBkaWN0aW9uYXJpZXM6IE1hcDxudW1iZXIsIFZlY3Rvcj47XG4gICAgcHJvdGVjdGVkIG5vZGVzOiBJdGVyYXRvcjxGaWVsZE1ldGFkYXRhPjtcbiAgICBwcm90ZWN0ZWQgYnVmZmVyczogSXRlcmF0b3I8QnVmZmVyTWV0YWRhdGE+O1xuXG4gICAgY29uc3RydWN0b3Iobm9kZXM6IEl0ZXJhdG9yPEZpZWxkTWV0YWRhdGE+LCBidWZmZXJzOiBJdGVyYXRvcjxCdWZmZXJNZXRhZGF0YT4sIGRpY3Rpb25hcmllczogTWFwPG51bWJlciwgVmVjdG9yPikge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLm5vZGVzID0gbm9kZXM7XG4gICAgICAgIHRoaXMuYnVmZmVycyA9IGJ1ZmZlcnM7XG4gICAgICAgIHRoaXMuZGljdGlvbmFyaWVzID0gZGljdGlvbmFyaWVzO1xuICAgIH1cblxuICAgIHB1YmxpYyB2aXNpdEZpZWxkcyhmaWVsZHM6IEZpZWxkW10pIHsgcmV0dXJuIGZpZWxkcy5tYXAoKGZpZWxkKSA9PiB0aGlzLnZpc2l0KGZpZWxkLnR5cGUpKTsgfVxuXG4gICAgcHVibGljIHZpc2l0TnVsbCAgICAgICAgICAgKHR5cGU6IE51bGwpICAgICAgICAgICAgeyByZXR1cm4gdGhpcy52aXNpdE51bGxUeXBlKHR5cGUpOyAgIH1cbiAgICBwdWJsaWMgdmlzaXRJbnQgICAgICAgICAgICAodHlwZTogSW50KSAgICAgICAgICAgICB7IHJldHVybiB0aGlzLnZpc2l0RmxhdFR5cGUodHlwZSk7ICAgfVxuICAgIHB1YmxpYyB2aXNpdEZsb2F0ICAgICAgICAgICh0eXBlOiBGbG9hdCkgICAgICAgICAgIHsgcmV0dXJuIHRoaXMudmlzaXRGbGF0VHlwZSh0eXBlKTsgICB9XG4gICAgcHVibGljIHZpc2l0QmluYXJ5ICAgICAgICAgKHR5cGU6IEJpbmFyeSkgICAgICAgICAgeyByZXR1cm4gdGhpcy52aXNpdEZsYXRMaXN0KHR5cGUpOyAgIH1cbiAgICBwdWJsaWMgdmlzaXRVdGY4ICAgICAgICAgICAodHlwZTogVXRmOCkgICAgICAgICAgICB7IHJldHVybiB0aGlzLnZpc2l0RmxhdExpc3QodHlwZSk7ICAgfVxuICAgIHB1YmxpYyB2aXNpdEJvb2wgICAgICAgICAgICh0eXBlOiBCb29sKSAgICAgICAgICAgIHsgcmV0dXJuIHRoaXMudmlzaXRCb29sVHlwZSh0eXBlKTsgICB9XG4gICAgcHVibGljIHZpc2l0RGVjaW1hbCAgICAgICAgKHR5cGU6IERlY2ltYWwpICAgICAgICAgeyByZXR1cm4gdGhpcy52aXNpdEZsYXRUeXBlKHR5cGUpOyAgIH1cbiAgICBwdWJsaWMgdmlzaXREYXRlICAgICAgICAgICAodHlwZTogRGF0ZV8pICAgICAgICAgICB7IHJldHVybiB0aGlzLnZpc2l0RmxhdFR5cGUodHlwZSk7ICAgfVxuICAgIHB1YmxpYyB2aXNpdFRpbWUgICAgICAgICAgICh0eXBlOiBUaW1lKSAgICAgICAgICAgIHsgcmV0dXJuIHRoaXMudmlzaXRGbGF0VHlwZSh0eXBlKTsgICB9XG4gICAgcHVibGljIHZpc2l0VGltZXN0YW1wICAgICAgKHR5cGU6IFRpbWVzdGFtcCkgICAgICAgeyByZXR1cm4gdGhpcy52aXNpdEZsYXRUeXBlKHR5cGUpOyAgIH1cbiAgICBwdWJsaWMgdmlzaXRJbnRlcnZhbCAgICAgICAodHlwZTogSW50ZXJ2YWwpICAgICAgICB7IHJldHVybiB0aGlzLnZpc2l0RmxhdFR5cGUodHlwZSk7ICAgfVxuICAgIHB1YmxpYyB2aXNpdExpc3QgICAgICAgICAgICh0eXBlOiBMaXN0KSAgICAgICAgICAgIHsgcmV0dXJuIHRoaXMudmlzaXRMaXN0VHlwZSh0eXBlKTsgICB9XG4gICAgcHVibGljIHZpc2l0U3RydWN0ICAgICAgICAgKHR5cGU6IFN0cnVjdCkgICAgICAgICAgeyByZXR1cm4gdGhpcy52aXNpdE5lc3RlZFR5cGUodHlwZSk7IH1cbiAgICBwdWJsaWMgdmlzaXRVbmlvbiAgICAgICAgICAodHlwZTogVW5pb24pICAgICAgICAgICB7IHJldHVybiB0aGlzLnZpc2l0VW5pb25UeXBlKHR5cGUpOyAgfVxuICAgIHB1YmxpYyB2aXNpdEZpeGVkU2l6ZUJpbmFyeSh0eXBlOiBGaXhlZFNpemVCaW5hcnkpIHsgcmV0dXJuIHRoaXMudmlzaXRGbGF0VHlwZSh0eXBlKTsgICB9XG4gICAgcHVibGljIHZpc2l0Rml4ZWRTaXplTGlzdCAgKHR5cGU6IEZpeGVkU2l6ZUxpc3QpICAgeyByZXR1cm4gdGhpcy52aXNpdEZpeGVkU2l6ZUxpc3RUeXBlKHR5cGUpOyB9XG4gICAgcHVibGljIHZpc2l0TWFwICAgICAgICAgICAgKHR5cGU6IE1hcF8pICAgICAgICAgICAgeyByZXR1cm4gdGhpcy52aXNpdE5lc3RlZFR5cGUodHlwZSk7IH1cbiAgICBwdWJsaWMgdmlzaXREaWN0aW9uYXJ5ICAgICAodHlwZTogRGljdGlvbmFyeSkgICAgICB7XG4gICAgICAgIHJldHVybiBuZXcgRGljdGlvbmFyeURhdGEodHlwZSwgdGhpcy5kaWN0aW9uYXJpZXMuZ2V0KHR5cGUuaWQpISwgdGhpcy52aXNpdCh0eXBlLmluZGljZXMpKTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldEZpZWxkTWV0YWRhdGEoKSB7IHJldHVybiB0aGlzLm5vZGVzLm5leHQoKS52YWx1ZTsgfVxuICAgIHByb3RlY3RlZCBnZXRCdWZmZXJNZXRhZGF0YSgpIHsgcmV0dXJuIHRoaXMuYnVmZmVycy5uZXh0KCkudmFsdWU7IH1cbiAgICBwcm90ZWN0ZWQgcmVhZE51bGxCaXRtYXA8VCBleHRlbmRzIERhdGFUeXBlPih0eXBlOiBULCBudWxsQ291bnQ6IG51bWJlciwgYnVmZmVyID0gdGhpcy5nZXRCdWZmZXJNZXRhZGF0YSgpKSB7XG4gICAgICAgIHJldHVybiBudWxsQ291bnQgPiAwICYmIHRoaXMucmVhZERhdGEodHlwZSwgYnVmZmVyKSB8fCBuZXcgVWludDhBcnJheSgwKTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IHJlYWREYXRhPFQgZXh0ZW5kcyBEYXRhVHlwZT4odHlwZTogVCwgYnVmZmVyPzogQnVmZmVyTWV0YWRhdGEpOiBhbnk7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IHJlYWRPZmZzZXRzPFQgZXh0ZW5kcyBEYXRhVHlwZT4odHlwZTogVCwgYnVmZmVyPzogQnVmZmVyTWV0YWRhdGEpOiBhbnk7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IHJlYWRUeXBlSWRzPFQgZXh0ZW5kcyBEYXRhVHlwZT4odHlwZTogVCwgYnVmZmVyPzogQnVmZmVyTWV0YWRhdGEpOiBhbnk7XG4gICAgcHJvdGVjdGVkIHZpc2l0TnVsbFR5cGUodHlwZTogTnVsbCwgeyBsZW5ndGgsIG51bGxDb3VudCB9OiBGaWVsZE1ldGFkYXRhID0gdGhpcy5nZXRGaWVsZE1ldGFkYXRhKCkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBGbGF0RGF0YTxhbnk+KHR5cGUsIGxlbmd0aCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCBuZXcgVWludDhBcnJheSgwKSwgMCwgbnVsbENvdW50KTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHZpc2l0RmxhdFR5cGU8VCBleHRlbmRzIEZsYXRUeXBlPih0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH06IEZpZWxkTWV0YWRhdGEgPSB0aGlzLmdldEZpZWxkTWV0YWRhdGEoKSkge1xuICAgICAgICByZXR1cm4gbmV3IEZsYXREYXRhPFQ+KHR5cGUsIGxlbmd0aCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWREYXRhKHR5cGUpLCAwLCBudWxsQ291bnQpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgdmlzaXRCb29sVHlwZSh0eXBlOiBCb29sLCB7IGxlbmd0aCwgbnVsbENvdW50IH06IEZpZWxkTWV0YWRhdGEgPSB0aGlzLmdldEZpZWxkTWV0YWRhdGEoKSwgZGF0YT86IFVpbnQ4QXJyYXkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBCb29sRGF0YSh0eXBlLCBsZW5ndGgsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgZGF0YSB8fCB0aGlzLnJlYWREYXRhKHR5cGUpLCAwLCBudWxsQ291bnQpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgdmlzaXRGbGF0TGlzdDxUIGV4dGVuZHMgRmxhdExpc3RUeXBlPih0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH06IEZpZWxkTWV0YWRhdGEgPSB0aGlzLmdldEZpZWxkTWV0YWRhdGEoKSkge1xuICAgICAgICByZXR1cm4gbmV3IEZsYXRMaXN0RGF0YTxUPih0eXBlLCBsZW5ndGgsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkT2Zmc2V0cyh0eXBlKSwgdGhpcy5yZWFkRGF0YSh0eXBlKSwgMCwgbnVsbENvdW50KTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHZpc2l0TGlzdFR5cGU8VCBleHRlbmRzIExpc3RUeXBlPih0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH06IEZpZWxkTWV0YWRhdGEgPSB0aGlzLmdldEZpZWxkTWV0YWRhdGEoKSkge1xuICAgICAgICByZXR1cm4gbmV3IExpc3REYXRhPFQ+KHR5cGUsIGxlbmd0aCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnJlYWRPZmZzZXRzKHR5cGUpLCB0aGlzLnZpc2l0KHR5cGUuY2hpbGRyZW4hWzBdLnR5cGUpLCAwLCBudWxsQ291bnQpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgdmlzaXRGaXhlZFNpemVMaXN0VHlwZTxUIGV4dGVuZHMgRml4ZWRTaXplTGlzdD4odHlwZTogVCwgeyBsZW5ndGgsIG51bGxDb3VudCB9OiBGaWVsZE1ldGFkYXRhID0gdGhpcy5nZXRGaWVsZE1ldGFkYXRhKCkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBTaW5nbGVOZXN0ZWREYXRhPFQ+KHR5cGUsIGxlbmd0aCwgdGhpcy5yZWFkTnVsbEJpdG1hcCh0eXBlLCBudWxsQ291bnQpLCB0aGlzLnZpc2l0KHR5cGUuY2hpbGRyZW4hWzBdLnR5cGUpLCAwLCBudWxsQ291bnQpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgdmlzaXROZXN0ZWRUeXBlPFQgZXh0ZW5kcyBOZXN0ZWRUeXBlPih0eXBlOiBULCB7IGxlbmd0aCwgbnVsbENvdW50IH06IEZpZWxkTWV0YWRhdGEgPSB0aGlzLmdldEZpZWxkTWV0YWRhdGEoKSkge1xuICAgICAgICByZXR1cm4gbmV3IE5lc3RlZERhdGE8VD4odHlwZSwgbGVuZ3RoLCB0aGlzLnJlYWROdWxsQml0bWFwKHR5cGUsIG51bGxDb3VudCksIHRoaXMudmlzaXRGaWVsZHModHlwZS5jaGlsZHJlbiksIDAsIG51bGxDb3VudCk7XG4gICAgfVxuICAgIHByb3RlY3RlZCB2aXNpdFVuaW9uVHlwZSh0eXBlOiBEZW5zZVVuaW9uIHwgU3BhcnNlVW5pb24sIHsgbGVuZ3RoLCBudWxsQ291bnQgfTogRmllbGRNZXRhZGF0YSA9IHRoaXMuZ2V0RmllbGRNZXRhZGF0YSgpKSB7XG4gICAgICAgIHJldHVybiB0eXBlLm1vZGUgPT09IFVuaW9uTW9kZS5TcGFyc2UgP1xuICAgICAgICAgICAgbmV3IFNwYXJzZVVuaW9uRGF0YSh0eXBlIGFzIFNwYXJzZVVuaW9uLCBsZW5ndGgsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkVHlwZUlkcyh0eXBlKSwgdGhpcy52aXNpdEZpZWxkcyh0eXBlLmNoaWxkcmVuKSwgMCwgbnVsbENvdW50KSA6XG4gICAgICAgICAgICBuZXcgRGVuc2VVbmlvbkRhdGEodHlwZSBhcyBEZW5zZVVuaW9uLCBsZW5ndGgsIHRoaXMucmVhZE51bGxCaXRtYXAodHlwZSwgbnVsbENvdW50KSwgdGhpcy5yZWFkVHlwZUlkcyh0eXBlKSwgdGhpcy5yZWFkT2Zmc2V0cyh0eXBlKSwgdGhpcy52aXNpdEZpZWxkcyh0eXBlLmNoaWxkcmVuKSwgMCwgbnVsbENvdW50KTtcbiAgICB9XG59XG4iXX0=
