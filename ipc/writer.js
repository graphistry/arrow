"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const message_1 = require("./message");
const schema_1 = require("../schema");
const message_2 = require("./metadata/message");
const metadata = require("./metadata/message");
const chunked_1 = require("../vector/chunked");
const file_1 = require("./metadata/file");
const enum_1 = require("../enum");
const stream_1 = require("../io/stream");
const vectorassembler_1 = require("../visitor/vectorassembler");
const compat_1 = require("../util/compat");
const interfaces_1 = require("../io/interfaces");
const kAlignmentBytes = new Uint8Array(64).fill(0);
class RecordBatchWriter extends interfaces_1.ReadableInterop {
    constructor() {
        super(...arguments);
        this.position = 0;
        this.started = false;
        // @ts-ignore
        this.sink = new stream_1.AsyncByteQueue();
        this.schema = null;
        this.dictionaryBlocks = [];
        this.recordBatchBlocks = [];
    }
    /** @nocollapse */
    static throughNode() { throw new Error(`"throughNode" not available in this environment`); }
    /** @nocollapse */
    static throughDOM() {
        throw new Error(`"throughDOM" not available in this environment`);
    }
    toUint8Array(sync = false) {
        return this.sink.toUint8Array(sync);
    }
    get closed() { return this.sink.closed; }
    [Symbol.asyncIterator]() { return this.sink[Symbol.asyncIterator](); }
    toReadableDOMStream(options) { return this.sink.toReadableDOMStream(options); }
    toReadableNodeStream(options) { return this.sink.toReadableNodeStream(options); }
    close() { return this.reset().sink.close(); }
    abort(reason) { return this.reset().sink.abort(reason); }
    reset(sink = this.sink, schema) {
        if ((sink === this.sink) || (sink instanceof stream_1.AsyncByteQueue)) {
            this.sink = sink;
        }
        else {
            this.sink = new stream_1.AsyncByteQueue();
            if (sink && compat_1.isWritableDOMStream(sink)) {
                this.toReadableDOMStream().pipeTo(sink);
            }
            else if (sink && compat_1.isWritableNodeStream(sink)) {
                this.toReadableNodeStream().pipe(sink);
            }
        }
        this.position = 0;
        this.schema = null;
        this.started = false;
        this.dictionaryBlocks = [];
        this.recordBatchBlocks = [];
        if (schema instanceof schema_1.Schema) {
            this.started = true;
            this.schema = schema;
            this._writeSchema(schema);
        }
        return this;
    }
    write(chunk) {
        if (!this.sink) {
            throw new Error(`RecordBatchWriter is closed`);
        }
        if (!this.started && (this.started = true)) {
            this._writeSchema(this.schema = chunk.schema);
        }
        if (chunk.schema !== this.schema) {
            throw new Error('Schemas unequal');
        }
        this._writeRecordBatch(chunk);
    }
    _writeMessage(message, alignment = 8) {
        const a = alignment - 1;
        const buffer = message_2.Message.encode(message);
        const flatbufferSize = buffer.byteLength;
        const alignedSize = (flatbufferSize + 4 + a) & ~a;
        const nPaddingBytes = alignedSize - flatbufferSize - 4;
        if (message.headerType === enum_1.MessageHeader.RecordBatch) {
            this.recordBatchBlocks.push(new file_1.FileBlock(alignedSize, message.bodyLength, this.position));
        }
        else if (message.headerType === enum_1.MessageHeader.DictionaryBatch) {
            this.dictionaryBlocks.push(new file_1.FileBlock(alignedSize, message.bodyLength, this.position));
        }
        // Write the flatbuffer size prefix including padding
        this._write(Int32Array.of(alignedSize - 4));
        // Write the flatbuffer
        if (flatbufferSize > 0) {
            this._write(buffer);
        }
        // Write any padding
        return this._writePadding(nPaddingBytes);
    }
    _write(buffer) {
        if (buffer && buffer.byteLength > 0) {
            this.sink.write(buffer);
            this.position += buffer.byteLength;
        }
        return this;
    }
    _writeSchema(schema) {
        return this
            ._writeMessage(message_2.Message.from(schema))
            ._writeDictionaries(schema.dictionaryFields);
    }
    _writeFooter() {
        const { schema, recordBatchBlocks, dictionaryBlocks } = this;
        const buffer = file_1.Footer.encode(new file_1.Footer(schema, enum_1.MetadataVersion.V4, recordBatchBlocks, dictionaryBlocks));
        return this
            ._write(buffer) // Write the flatbuffer
            ._write(Int32Array.of(buffer.byteLength)) // then the footer size suffix
            ._writeMagic(); // then the magic suffix
    }
    _writeMagic() {
        return this._write(message_1.MAGIC);
    }
    _writePadding(nBytes) {
        return nBytes > 0 ? this._write(kAlignmentBytes.subarray(0, nBytes)) : this;
    }
    _writeRecordBatch(records) {
        const { byteLength, nodes, bufferRegions, buffers } = vectorassembler_1.VectorAssembler.assemble(records);
        const recordBatch = new metadata.RecordBatch(records.length, nodes, bufferRegions);
        const message = message_2.Message.from(recordBatch, byteLength);
        return this
            ._writeMessage(message)
            ._writeBodyBuffers(buffers);
    }
    _writeDictionaryBatch(dictionary, id, isDelta = false) {
        const { byteLength, nodes, bufferRegions, buffers } = vectorassembler_1.VectorAssembler.assemble(dictionary);
        const recordBatch = new metadata.RecordBatch(dictionary.length, nodes, bufferRegions);
        const dictionaryBatch = new metadata.DictionaryBatch(recordBatch, id, isDelta);
        const message = message_2.Message.from(dictionaryBatch, byteLength);
        return this
            ._writeMessage(message)
            ._writeBodyBuffers(buffers);
    }
    _writeBodyBuffers(buffers) {
        let buffer;
        let size, padding;
        for (let i = -1, n = buffers.length; ++i < n;) {
            if ((buffer = buffers[i]) && (size = buffer.byteLength) > 0) {
                this._write(buffer);
                if ((padding = ((size + 7) & ~7) - size) > 0) {
                    this._writePadding(padding);
                }
            }
        }
        return this;
    }
    _writeDictionaries(dictionaryFields) {
        for (const [id, fields] of dictionaryFields) {
            const vector = fields[0].type.dictionaryVector;
            if (!(vector instanceof chunked_1.ChunkedVector)) {
                this._writeDictionaryBatch(vector, id, false);
            }
            else {
                const chunks = vector.chunks;
                for (let i = -1, n = chunks.length; ++i < n;) {
                    this._writeDictionaryBatch(chunks[i], id, i > 0);
                }
            }
        }
        return this;
    }
}
exports.RecordBatchWriter = RecordBatchWriter;
class RecordBatchFileWriter extends RecordBatchWriter {
    /** @nocollapse */
    static writeAll(batches) {
        const writer = new RecordBatchFileWriter();
        if (!compat_1.isAsyncIterable(batches)) {
            for (const batch of batches) {
                writer.write(batch);
            }
            writer.close();
            return writer;
        }
        return (() => tslib_1.__awaiter(this, void 0, void 0, function* () {
            var e_1, _a;
            try {
                for (var batches_1 = tslib_1.__asyncValues(batches), batches_1_1; batches_1_1 = yield batches_1.next(), !batches_1_1.done;) {
                    const batch = batches_1_1.value;
                    writer.write(batch);
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (batches_1_1 && !batches_1_1.done && (_a = batches_1.return)) yield _a.call(batches_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
            writer.close();
            return writer;
        }))();
    }
    close() {
        this._writeFooter();
        return super.close();
    }
    _writeSchema(schema) {
        return this
            ._writeMagic()._writePadding(2)
            ._writeDictionaries(schema.dictionaryFields);
    }
}
exports.RecordBatchFileWriter = RecordBatchFileWriter;
class RecordBatchStreamWriter extends RecordBatchWriter {
    /** @nocollapse */
    static writeAll(batches) {
        const writer = new RecordBatchStreamWriter();
        if (!compat_1.isAsyncIterable(batches)) {
            for (const batch of batches) {
                writer.write(batch);
            }
            writer.close();
            return writer;
        }
        return (() => tslib_1.__awaiter(this, void 0, void 0, function* () {
            var e_2, _a;
            try {
                for (var batches_2 = tslib_1.__asyncValues(batches), batches_2_1; batches_2_1 = yield batches_2.next(), !batches_2_1.done;) {
                    const batch = batches_2_1.value;
                    writer.write(batch);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (batches_2_1 && !batches_2_1.done && (_a = batches_2.return)) yield _a.call(batches_2);
                }
                finally { if (e_2) throw e_2.error; }
            }
            writer.close();
            return writer;
        }))();
    }
    close() {
        this._writePadding(4);
        return super.close();
    }
}
exports.RecordBatchStreamWriter = RecordBatchStreamWriter;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsQ0FBQyxDQUFDO2FBQzlCLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ3JELENBQUM7Q0FDSjtBQWhDRCxzREFnQ0M7QUFFRCxNQUFhLHVCQUFxRSxTQUFRLGlCQUFvQjtJQUkxRyxrQkFBa0I7SUFDWCxNQUFNLENBQUMsUUFBUSxDQUE4QyxPQUFpRTtRQUNqSSxNQUFNLE1BQU0sR0FBRyxJQUFJLHVCQUF1QixFQUFLLENBQUM7UUFDaEQsSUFBSSxDQUFDLHdCQUFlLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDM0IsS0FBSyxNQUFNLEtBQUssSUFBSSxPQUFPLEVBQUU7Z0JBQ3pCLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDdkI7WUFDRCxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLE1BQU0sQ0FBQztTQUNqQjtRQUNELE9BQU8sQ0FBQyxHQUFTLEVBQUU7OztnQkFDZixLQUEwQixJQUFBLFlBQUEsc0JBQUEsT0FBTyxDQUFBLGFBQUE7b0JBQXRCLE1BQU0sS0FBSyxvQkFBQSxDQUFBO29CQUNsQixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUN2Qjs7Ozs7Ozs7O1lBQ0QsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQyxDQUFBLENBQUMsRUFBRSxDQUFDO0lBQ1QsQ0FBQztJQUNNLEtBQUs7UUFDUixJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLE9BQU8sS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3pCLENBQUM7Q0FDSjtBQTFCRCwwREEwQkMiLCJmaWxlIjoiaXBjL3dyaXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBNQUdJQyB9IGZyb20gJy4vbWVzc2FnZSc7XG5pbXBvcnQgeyBWZWN0b3IgfSBmcm9tICcuLi92ZWN0b3InO1xuaW1wb3J0IHsgU2NoZW1hLCBGaWVsZCB9IGZyb20gJy4uL3NjaGVtYSc7XG5pbXBvcnQgeyBNZXNzYWdlIH0gZnJvbSAnLi9tZXRhZGF0YS9tZXNzYWdlJztcbmltcG9ydCB7IFJlY29yZEJhdGNoIH0gZnJvbSAnLi4vcmVjb3JkYmF0Y2gnO1xuaW1wb3J0ICogYXMgbWV0YWRhdGEgZnJvbSAnLi9tZXRhZGF0YS9tZXNzYWdlJztcbmltcG9ydCB7IERhdGFUeXBlLCBEaWN0aW9uYXJ5IH0gZnJvbSAnLi4vdHlwZSc7XG5pbXBvcnQgeyBDaHVua2VkVmVjdG9yIH0gZnJvbSAnLi4vdmVjdG9yL2NodW5rZWQnO1xuaW1wb3J0IHsgRmlsZUJsb2NrLCBGb290ZXIgfSBmcm9tICcuL21ldGFkYXRhL2ZpbGUnO1xuaW1wb3J0IHsgQXJyYXlCdWZmZXJWaWV3SW5wdXQgfSBmcm9tICcuLi91dGlsL2J1ZmZlcic7XG5pbXBvcnQgeyBNZXNzYWdlSGVhZGVyLCBNZXRhZGF0YVZlcnNpb24gfSBmcm9tICcuLi9lbnVtJztcbmltcG9ydCB7IFdyaXRhYmxlU2luaywgQXN5bmNCeXRlUXVldWUgfSBmcm9tICcuLi9pby9zdHJlYW0nO1xuaW1wb3J0IHsgVmVjdG9yQXNzZW1ibGVyIH0gZnJvbSAnLi4vdmlzaXRvci92ZWN0b3Jhc3NlbWJsZXInO1xuaW1wb3J0IHsgaXNXcml0YWJsZURPTVN0cmVhbSwgaXNXcml0YWJsZU5vZGVTdHJlYW0sIGlzQXN5bmNJdGVyYWJsZSB9IGZyb20gJy4uL3V0aWwvY29tcGF0JztcbmltcG9ydCB7IFdyaXRhYmxlLCBGaWxlSGFuZGxlLCBSZWFkYWJsZUludGVyb3AsIFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyB9IGZyb20gJy4uL2lvL2ludGVyZmFjZXMnO1xuXG5jb25zdCBrQWxpZ25tZW50Qnl0ZXMgPSBuZXcgVWludDhBcnJheSg2NCkuZmlsbCgwKTtcblxuZXhwb3J0IHR5cGUgT3BlbkFyZ3MgPSBGaWxlSGFuZGxlIHwgTm9kZUpTLldyaXRhYmxlU3RyZWFtIHwgV3JpdGFibGVTdHJlYW08VWludDhBcnJheT4gfCBVbmRlcmx5aW5nU2luazxVaW50OEFycmF5PjtcblxuZXhwb3J0IGNsYXNzIFJlY29yZEJhdGNoV3JpdGVyPFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0gPSBhbnk+IGV4dGVuZHMgUmVhZGFibGVJbnRlcm9wPFVpbnQ4QXJyYXk+IGltcGxlbWVudHMgV3JpdGFibGU8UmVjb3JkQmF0Y2g8VD4+IHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdGhyb3VnaE5vZGUoKTogaW1wb3J0KCdzdHJlYW0nKS5EdXBsZXggeyB0aHJvdyBuZXcgRXJyb3IoYFwidGhyb3VnaE5vZGVcIiBub3QgYXZhaWxhYmxlIGluIHRoaXMgZW52aXJvbm1lbnRgKTsgfVxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdGhyb3VnaERPTTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9PigpOiB7IHdyaXRhYmxlOiBXcml0YWJsZVN0cmVhbTxSZWNvcmRCYXRjaDxUPj4sIHJlYWRhYmxlOiBSZWFkYWJsZVN0cmVhbTxVaW50OEFycmF5PiB9IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcInRocm91Z2hET01cIiBub3QgYXZhaWxhYmxlIGluIHRoaXMgZW52aXJvbm1lbnRgKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcG9zaXRpb24gPSAwO1xuICAgIHByb3RlY3RlZCBzdGFydGVkID0gZmFsc2U7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHByb3RlY3RlZCBzaW5rID0gbmV3IEFzeW5jQnl0ZVF1ZXVlKCk7XG4gICAgcHJvdGVjdGVkIHNjaGVtYTogU2NoZW1hIHwgbnVsbCA9IG51bGw7XG4gICAgcHJvdGVjdGVkIGRpY3Rpb25hcnlCbG9ja3M6IEZpbGVCbG9ja1tdID0gW107XG4gICAgcHJvdGVjdGVkIHJlY29yZEJhdGNoQmxvY2tzOiBGaWxlQmxvY2tbXSA9IFtdO1xuXG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jOiB0cnVlKTogVWludDhBcnJheTtcbiAgICBwdWJsaWMgdG9VaW50OEFycmF5KHN5bmM/OiBmYWxzZSk6IFByb21pc2U8VWludDhBcnJheT47XG4gICAgcHVibGljIHRvVWludDhBcnJheShzeW5jOiBhbnkgPSBmYWxzZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zaW5rLnRvVWludDhBcnJheShzeW5jKSBhcyBQcm9taXNlPFVpbnQ4QXJyYXk+IHwgVWludDhBcnJheTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGNsb3NlZCgpIHsgcmV0dXJuIHRoaXMuc2luay5jbG9zZWQ7IH1cbiAgICBwdWJsaWMgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsgcmV0dXJuIHRoaXMuc2lua1tTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTsgfVxuICAgIHB1YmxpYyB0b1JlYWRhYmxlRE9NU3RyZWFtKG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpIHsgcmV0dXJuIHRoaXMuc2luay50b1JlYWRhYmxlRE9NU3RyZWFtKG9wdGlvbnMpOyB9XG4gICAgcHVibGljIHRvUmVhZGFibGVOb2RlU3RyZWFtKG9wdGlvbnM/OiBpbXBvcnQoJ3N0cmVhbScpLlJlYWRhYmxlT3B0aW9ucykgeyByZXR1cm4gdGhpcy5zaW5rLnRvUmVhZGFibGVOb2RlU3RyZWFtKG9wdGlvbnMpOyB9XG5cbiAgICBwdWJsaWMgY2xvc2UoKSB7IHJldHVybiB0aGlzLnJlc2V0KCkuc2luay5jbG9zZSgpOyB9XG4gICAgcHVibGljIGFib3J0KHJlYXNvbj86IGFueSkgeyByZXR1cm4gdGhpcy5yZXNldCgpLnNpbmsuYWJvcnQocmVhc29uKTsgfVxuICAgIHB1YmxpYyByZXNldChzaW5rOiBXcml0YWJsZVNpbms8QXJyYXlCdWZmZXJWaWV3SW5wdXQ+ID0gdGhpcy5zaW5rLCBzY2hlbWE/OiBTY2hlbWE8VD4pIHtcblxuICAgICAgICBpZiAoKHNpbmsgPT09IHRoaXMuc2luaykgfHwgKHNpbmsgaW5zdGFuY2VvZiBBc3luY0J5dGVRdWV1ZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc2luayA9IHNpbmsgYXMgQXN5bmNCeXRlUXVldWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnNpbmsgPSBuZXcgQXN5bmNCeXRlUXVldWUoKTtcbiAgICAgICAgICAgIGlmIChzaW5rICYmIGlzV3JpdGFibGVET01TdHJlYW0oc2luaykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRvUmVhZGFibGVET01TdHJlYW0oKS5waXBlVG8oc2luayk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHNpbmsgJiYgaXNXcml0YWJsZU5vZGVTdHJlYW0oc2luaykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRvUmVhZGFibGVOb2RlU3RyZWFtKCkucGlwZShzaW5rKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucG9zaXRpb24gPSAwO1xuICAgICAgICB0aGlzLnNjaGVtYSA9IG51bGw7XG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmRpY3Rpb25hcnlCbG9ja3MgPSBbXTtcbiAgICAgICAgdGhpcy5yZWNvcmRCYXRjaEJsb2NrcyA9IFtdO1xuXG4gICAgICAgIGlmIChzY2hlbWEgaW5zdGFuY2VvZiBTY2hlbWEpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnNjaGVtYSA9IHNjaGVtYTtcbiAgICAgICAgICAgIHRoaXMuX3dyaXRlU2NoZW1hKHNjaGVtYSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgd3JpdGUoY2h1bms6IFJlY29yZEJhdGNoPFQ+KSB7XG4gICAgICAgIGlmICghdGhpcy5zaW5rKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlY29yZEJhdGNoV3JpdGVyIGlzIGNsb3NlZGApO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5zdGFydGVkICYmICh0aGlzLnN0YXJ0ZWQgPSB0cnVlKSkge1xuICAgICAgICAgICAgdGhpcy5fd3JpdGVTY2hlbWEodGhpcy5zY2hlbWEgPSBjaHVuay5zY2hlbWEpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjaHVuay5zY2hlbWEgIT09IHRoaXMuc2NoZW1hKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NjaGVtYXMgdW5lcXVhbCcpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3dyaXRlUmVjb3JkQmF0Y2goY2h1bmspO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3JpdGVNZXNzYWdlPFQgZXh0ZW5kcyBNZXNzYWdlSGVhZGVyPihtZXNzYWdlOiBNZXNzYWdlPFQ+LCBhbGlnbm1lbnQgPSA4KSB7XG5cbiAgICAgICAgY29uc3QgYSA9IGFsaWdubWVudCAtIDE7XG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IE1lc3NhZ2UuZW5jb2RlKG1lc3NhZ2UpO1xuICAgICAgICBjb25zdCBmbGF0YnVmZmVyU2l6ZSA9IGJ1ZmZlci5ieXRlTGVuZ3RoO1xuICAgICAgICBjb25zdCBhbGlnbmVkU2l6ZSA9IChmbGF0YnVmZmVyU2l6ZSArIDQgKyBhKSAmIH5hO1xuICAgICAgICBjb25zdCBuUGFkZGluZ0J5dGVzID0gYWxpZ25lZFNpemUgLSBmbGF0YnVmZmVyU2l6ZSAtIDQ7XG5cbiAgICAgICAgaWYgKG1lc3NhZ2UuaGVhZGVyVHlwZSA9PT0gTWVzc2FnZUhlYWRlci5SZWNvcmRCYXRjaCkge1xuICAgICAgICAgICAgdGhpcy5yZWNvcmRCYXRjaEJsb2Nrcy5wdXNoKG5ldyBGaWxlQmxvY2soYWxpZ25lZFNpemUsIG1lc3NhZ2UuYm9keUxlbmd0aCwgdGhpcy5wb3NpdGlvbikpO1xuICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UuaGVhZGVyVHlwZSA9PT0gTWVzc2FnZUhlYWRlci5EaWN0aW9uYXJ5QmF0Y2gpIHtcbiAgICAgICAgICAgIHRoaXMuZGljdGlvbmFyeUJsb2Nrcy5wdXNoKG5ldyBGaWxlQmxvY2soYWxpZ25lZFNpemUsIG1lc3NhZ2UuYm9keUxlbmd0aCwgdGhpcy5wb3NpdGlvbikpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gV3JpdGUgdGhlIGZsYXRidWZmZXIgc2l6ZSBwcmVmaXggaW5jbHVkaW5nIHBhZGRpbmdcbiAgICAgICAgdGhpcy5fd3JpdGUoSW50MzJBcnJheS5vZihhbGlnbmVkU2l6ZSAtIDQpKTtcbiAgICAgICAgLy8gV3JpdGUgdGhlIGZsYXRidWZmZXJcbiAgICAgICAgaWYgKGZsYXRidWZmZXJTaXplID4gMCkgeyB0aGlzLl93cml0ZShidWZmZXIpOyB9XG4gICAgICAgIC8vIFdyaXRlIGFueSBwYWRkaW5nXG4gICAgICAgIHJldHVybiB0aGlzLl93cml0ZVBhZGRpbmcoblBhZGRpbmdCeXRlcyk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93cml0ZShidWZmZXI6IEFycmF5QnVmZmVyVmlldykge1xuICAgICAgICBpZiAoYnVmZmVyICYmIGJ1ZmZlci5ieXRlTGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5zaW5rLndyaXRlKGJ1ZmZlcik7XG4gICAgICAgICAgICB0aGlzLnBvc2l0aW9uICs9IGJ1ZmZlci5ieXRlTGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3JpdGVTY2hlbWEoc2NoZW1hOiBTY2hlbWE8VD4pIHtcbiAgICAgICAgcmV0dXJuIHRoaXNcbiAgICAgICAgICAgIC5fd3JpdGVNZXNzYWdlKE1lc3NhZ2UuZnJvbShzY2hlbWEpKVxuICAgICAgICAgICAgLl93cml0ZURpY3Rpb25hcmllcyhzY2hlbWEuZGljdGlvbmFyeUZpZWxkcyk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93cml0ZUZvb3RlcigpIHtcblxuICAgICAgICBjb25zdCB7IHNjaGVtYSwgcmVjb3JkQmF0Y2hCbG9ja3MsIGRpY3Rpb25hcnlCbG9ja3MgfSA9IHRoaXM7XG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IEZvb3Rlci5lbmNvZGUobmV3IEZvb3RlcihcbiAgICAgICAgICAgIHNjaGVtYSEsIE1ldGFkYXRhVmVyc2lvbi5WNCxcbiAgICAgICAgICAgIHJlY29yZEJhdGNoQmxvY2tzLCBkaWN0aW9uYXJ5QmxvY2tzXG4gICAgICAgICkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgICAgICAgICAuX3dyaXRlKGJ1ZmZlcikgLy8gV3JpdGUgdGhlIGZsYXRidWZmZXJcbiAgICAgICAgICAgIC5fd3JpdGUoSW50MzJBcnJheS5vZihidWZmZXIuYnl0ZUxlbmd0aCkpIC8vIHRoZW4gdGhlIGZvb3RlciBzaXplIHN1ZmZpeFxuICAgICAgICAgICAgLl93cml0ZU1hZ2ljKCk7IC8vIHRoZW4gdGhlIG1hZ2ljIHN1ZmZpeFxuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3JpdGVNYWdpYygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3dyaXRlKE1BR0lDKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3dyaXRlUGFkZGluZyhuQnl0ZXM6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gbkJ5dGVzID4gMCA/IHRoaXMuX3dyaXRlKGtBbGlnbm1lbnRCeXRlcy5zdWJhcnJheSgwLCBuQnl0ZXMpKSA6IHRoaXM7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93cml0ZVJlY29yZEJhdGNoKHJlY29yZHM6IFJlY29yZEJhdGNoPFQ+KSB7XG4gICAgICAgIGNvbnN0IHsgYnl0ZUxlbmd0aCwgbm9kZXMsIGJ1ZmZlclJlZ2lvbnMsIGJ1ZmZlcnMgfSA9IFZlY3RvckFzc2VtYmxlci5hc3NlbWJsZShyZWNvcmRzKTtcbiAgICAgICAgY29uc3QgcmVjb3JkQmF0Y2ggPSBuZXcgbWV0YWRhdGEuUmVjb3JkQmF0Y2gocmVjb3Jkcy5sZW5ndGgsIG5vZGVzLCBidWZmZXJSZWdpb25zKTtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IE1lc3NhZ2UuZnJvbShyZWNvcmRCYXRjaCwgYnl0ZUxlbmd0aCk7XG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgICAgICAgICAuX3dyaXRlTWVzc2FnZShtZXNzYWdlKVxuICAgICAgICAgICAgLl93cml0ZUJvZHlCdWZmZXJzKGJ1ZmZlcnMpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3JpdGVEaWN0aW9uYXJ5QmF0Y2goZGljdGlvbmFyeTogVmVjdG9yLCBpZDogbnVtYmVyLCBpc0RlbHRhID0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgeyBieXRlTGVuZ3RoLCBub2RlcywgYnVmZmVyUmVnaW9ucywgYnVmZmVycyB9ID0gVmVjdG9yQXNzZW1ibGVyLmFzc2VtYmxlKGRpY3Rpb25hcnkpO1xuICAgICAgICBjb25zdCByZWNvcmRCYXRjaCA9IG5ldyBtZXRhZGF0YS5SZWNvcmRCYXRjaChkaWN0aW9uYXJ5Lmxlbmd0aCwgbm9kZXMsIGJ1ZmZlclJlZ2lvbnMpO1xuICAgICAgICBjb25zdCBkaWN0aW9uYXJ5QmF0Y2ggPSBuZXcgbWV0YWRhdGEuRGljdGlvbmFyeUJhdGNoKHJlY29yZEJhdGNoLCBpZCwgaXNEZWx0YSk7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBNZXNzYWdlLmZyb20oZGljdGlvbmFyeUJhdGNoLCBieXRlTGVuZ3RoKTtcbiAgICAgICAgcmV0dXJuIHRoaXNcbiAgICAgICAgICAgIC5fd3JpdGVNZXNzYWdlKG1lc3NhZ2UpXG4gICAgICAgICAgICAuX3dyaXRlQm9keUJ1ZmZlcnMoYnVmZmVycyk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93cml0ZUJvZHlCdWZmZXJzKGJ1ZmZlcnM6IEFycmF5QnVmZmVyVmlld1tdKSB7XG4gICAgICAgIGxldCBidWZmZXI6IEFycmF5QnVmZmVyVmlldztcbiAgICAgICAgbGV0IHNpemU6IG51bWJlciwgcGFkZGluZzogbnVtYmVyO1xuICAgICAgICBmb3IgKGxldCBpID0gLTEsIG4gPSBidWZmZXJzLmxlbmd0aDsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGlmICgoYnVmZmVyID0gYnVmZmVyc1tpXSkgJiYgKHNpemUgPSBidWZmZXIuYnl0ZUxlbmd0aCkgPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fd3JpdGUoYnVmZmVyKTtcbiAgICAgICAgICAgICAgICBpZiAoKHBhZGRpbmcgPSAoKHNpemUgKyA3KSAmIH43KSAtIHNpemUpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl93cml0ZVBhZGRpbmcocGFkZGluZyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3JpdGVEaWN0aW9uYXJpZXMoZGljdGlvbmFyeUZpZWxkczogTWFwPG51bWJlciwgRmllbGQ8RGljdGlvbmFyeTxhbnksIGFueT4+W10+KSB7XG4gICAgICAgIGZvciAoY29uc3QgW2lkLCBmaWVsZHNdIG9mIGRpY3Rpb25hcnlGaWVsZHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHZlY3RvciA9IGZpZWxkc1swXS50eXBlLmRpY3Rpb25hcnlWZWN0b3I7XG4gICAgICAgICAgICBpZiAoISh2ZWN0b3IgaW5zdGFuY2VvZiBDaHVua2VkVmVjdG9yKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3dyaXRlRGljdGlvbmFyeUJhdGNoKHZlY3RvciwgaWQsIGZhbHNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2h1bmtzID0gdmVjdG9yLmNodW5rcztcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gLTEsIG4gPSBjaHVua3MubGVuZ3RoOyArK2kgPCBuOykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl93cml0ZURpY3Rpb25hcnlCYXRjaChjaHVua3NbaV0sIGlkLCBpID4gMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJlY29yZEJhdGNoRmlsZVdyaXRlcjxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PiBleHRlbmRzIFJlY29yZEJhdGNoV3JpdGVyPFQ+IHtcblxuICAgIHB1YmxpYyBzdGF0aWMgd3JpdGVBbGw8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oYmF0Y2hlczogSXRlcmFibGU8UmVjb3JkQmF0Y2g8VD4+KTogUmVjb3JkQmF0Y2hGaWxlV3JpdGVyPFQ+O1xuICAgIHB1YmxpYyBzdGF0aWMgd3JpdGVBbGw8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oYmF0Y2hlczogQXN5bmNJdGVyYWJsZTxSZWNvcmRCYXRjaDxUPj4pOiBQcm9taXNlPFJlY29yZEJhdGNoRmlsZVdyaXRlcjxUPj47XG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyB3cml0ZUFsbDxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihiYXRjaGVzOiBJdGVyYWJsZTxSZWNvcmRCYXRjaDxUPj4gfCBBc3luY0l0ZXJhYmxlPFJlY29yZEJhdGNoPFQ+Pikge1xuICAgICAgICBjb25zdCB3cml0ZXIgPSBuZXcgUmVjb3JkQmF0Y2hGaWxlV3JpdGVyPFQ+KCk7XG4gICAgICAgIGlmICghaXNBc3luY0l0ZXJhYmxlKGJhdGNoZXMpKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGJhdGNoIG9mIGJhdGNoZXMpIHtcbiAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUoYmF0Y2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgd3JpdGVyLmNsb3NlKCk7XG4gICAgICAgICAgICByZXR1cm4gd3JpdGVyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBiYXRjaCBvZiBiYXRjaGVzKSB7XG4gICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKGJhdGNoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHdyaXRlci5jbG9zZSgpO1xuICAgICAgICAgICAgcmV0dXJuIHdyaXRlcjtcbiAgICAgICAgfSkoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xvc2UoKSB7XG4gICAgICAgIHRoaXMuX3dyaXRlRm9vdGVyKCk7XG4gICAgICAgIHJldHVybiBzdXBlci5jbG9zZSgpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgX3dyaXRlU2NoZW1hKHNjaGVtYTogU2NoZW1hPFQ+KSB7XG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgICAgICAgICAuX3dyaXRlTWFnaWMoKS5fd3JpdGVQYWRkaW5nKDIpXG4gICAgICAgICAgICAuX3dyaXRlRGljdGlvbmFyaWVzKHNjaGVtYS5kaWN0aW9uYXJ5RmllbGRzKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZWNvcmRCYXRjaFN0cmVhbVdyaXRlcjxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PiBleHRlbmRzIFJlY29yZEJhdGNoV3JpdGVyPFQ+IHtcblxuICAgIHB1YmxpYyBzdGF0aWMgd3JpdGVBbGw8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oYmF0Y2hlczogSXRlcmFibGU8UmVjb3JkQmF0Y2g8VD4+KTogUmVjb3JkQmF0Y2hTdHJlYW1Xcml0ZXI8VD47XG4gICAgcHVibGljIHN0YXRpYyB3cml0ZUFsbDxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PihiYXRjaGVzOiBBc3luY0l0ZXJhYmxlPFJlY29yZEJhdGNoPFQ+Pik6IFByb21pc2U8UmVjb3JkQmF0Y2hTdHJlYW1Xcml0ZXI8VD4+O1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgd3JpdGVBbGw8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfSA9IGFueT4oYmF0Y2hlczogSXRlcmFibGU8UmVjb3JkQmF0Y2g8VD4+IHwgQXN5bmNJdGVyYWJsZTxSZWNvcmRCYXRjaDxUPj4pIHtcbiAgICAgICAgY29uc3Qgd3JpdGVyID0gbmV3IFJlY29yZEJhdGNoU3RyZWFtV3JpdGVyPFQ+KCk7XG4gICAgICAgIGlmICghaXNBc3luY0l0ZXJhYmxlKGJhdGNoZXMpKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGJhdGNoIG9mIGJhdGNoZXMpIHtcbiAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUoYmF0Y2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgd3JpdGVyLmNsb3NlKCk7XG4gICAgICAgICAgICByZXR1cm4gd3JpdGVyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBiYXRjaCBvZiBiYXRjaGVzKSB7XG4gICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKGJhdGNoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHdyaXRlci5jbG9zZSgpO1xuICAgICAgICAgICAgcmV0dXJuIHdyaXRlcjtcbiAgICAgICAgfSkoKTtcbiAgICB9XG4gICAgcHVibGljIGNsb3NlKCkge1xuICAgICAgICB0aGlzLl93cml0ZVBhZGRpbmcoNCk7XG4gICAgICAgIHJldHVybiBzdXBlci5jbG9zZSgpO1xuICAgIH1cbn1cbiJdfQ==
