"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
/* tslint:disable:class-name */
const File_ = require("../../fb/File");
const flatbuffers_1 = require("flatbuffers");
var Long = flatbuffers_1.flatbuffers.Long;
var Builder = flatbuffers_1.flatbuffers.Builder;
var ByteBuffer = flatbuffers_1.flatbuffers.ByteBuffer;
var _Block = File_.org.apache.arrow.flatbuf.Block;
var _Footer = File_.org.apache.arrow.flatbuf.Footer;
const schema_1 = require("../../schema");
const enum_1 = require("../../enum");
const buffer_1 = require("../../util/buffer");
class Footer_ {
    constructor(schema, version = enum_1.MetadataVersion.V4, recordBatches, dictionaryBatches) {
        this.schema = schema;
        this.version = version;
        recordBatches && (this._recordBatches = recordBatches);
        dictionaryBatches && (this._dictionaryBatches = dictionaryBatches);
    }
    /** @nocollapse */
    static decode(buf) {
        buf = new ByteBuffer(buffer_1.toUint8Array(buf));
        const footer = _Footer.getRootAsFooter(buf);
        const schema = schema_1.Schema.decode(footer.schema());
        return new OffHeapFooter(schema, footer);
    }
    /** @nocollapse */
    static encode(footer) {
        const b = new Builder();
        const schemaOffset = schema_1.Schema.encode(b, footer.schema);
        _Footer.startRecordBatchesVector(b, footer.numRecordBatches);
        [...footer.recordBatches()].slice().reverse().forEach((rb) => FileBlock.encode(b, rb));
        const recordBatchesOffset = b.endVector();
        _Footer.startDictionariesVector(b, footer.numDictionaries);
        [...footer.dictionaryBatches()].slice().reverse().forEach((db) => FileBlock.encode(b, db));
        const dictionaryBatchesOffset = b.endVector();
        _Footer.startFooter(b);
        _Footer.addSchema(b, schemaOffset);
        _Footer.addVersion(b, enum_1.MetadataVersion.V4);
        _Footer.addRecordBatches(b, recordBatchesOffset);
        _Footer.addDictionaries(b, dictionaryBatchesOffset);
        _Footer.finishFooterBuffer(b, _Footer.endFooter(b));
        return b.asUint8Array();
    }
    get numRecordBatches() { return this._recordBatches.length; }
    get numDictionaries() { return this._dictionaryBatches.length; }
    *recordBatches() {
        for (let block, i = -1, n = this.numRecordBatches; ++i < n;) {
            if (block = this.getRecordBatch(i)) {
                yield block;
            }
        }
    }
    *dictionaryBatches() {
        for (let block, i = -1, n = this.numDictionaries; ++i < n;) {
            if (block = this.getDictionaryBatch(i)) {
                yield block;
            }
        }
    }
    getRecordBatch(index) {
        return index >= 0
            && index < this.numRecordBatches
            && this._recordBatches[index] || null;
    }
    getDictionaryBatch(index) {
        return index >= 0
            && index < this.numDictionaries
            && this._dictionaryBatches[index] || null;
    }
}
exports.Footer = Footer_;
class OffHeapFooter extends Footer_ {
    constructor(schema, _footer) {
        super(schema, _footer.version());
        this._footer = _footer;
    }
    get numRecordBatches() { return this._footer.recordBatchesLength(); }
    get numDictionaries() { return this._footer.dictionariesLength(); }
    getRecordBatch(index) {
        if (index >= 0 && index < this.numRecordBatches) {
            const fileBlock = this._footer.recordBatches(index);
            if (fileBlock) {
                return FileBlock.decode(fileBlock);
            }
        }
        return null;
    }
    getDictionaryBatch(index) {
        if (index >= 0 && index < this.numDictionaries) {
            const fileBlock = this._footer.dictionaries(index);
            if (fileBlock) {
                return FileBlock.decode(fileBlock);
            }
        }
        return null;
    }
}
class FileBlock {
    /** @nocollapse */
    static decode(block) {
        return new FileBlock(block.metaDataLength(), block.bodyLength(), block.offset());
    }
    /** @nocollapse */
    static encode(b, fileBlock) {
        const { metaDataLength } = fileBlock;
        const offset = new Long(fileBlock.offset, 0);
        const bodyLength = new Long(fileBlock.bodyLength, 0);
        return _Block.createBlock(b, offset, metaDataLength, bodyLength);
    }
    constructor(metaDataLength, bodyLength, offset) {
        this.metaDataLength = metaDataLength;
        this.offset = typeof offset === 'number' ? offset : offset.low;
        this.bodyLength = typeof bodyLength === 'number' ? bodyLength : bodyLength.low;
    }
}
exports.FileBlock = FileBlock;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LEVBQUUsVUFBeUIsRUFBRSxNQUFxQjtRQUNoRixJQUFJLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQztRQUNyQyxJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sTUFBTSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO1FBQy9ELElBQUksQ0FBQyxVQUFVLEdBQUcsT0FBTyxVQUFVLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUM7SUFDbkYsQ0FBQztDQUNKO0FBeEJELDhCQXdCQyIsImZpbGUiOiJpcGMvbWV0YWRhdGEvZmlsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpjbGFzcy1uYW1lICovXG5cbmltcG9ydCAqIGFzIEZpbGVfIGZyb20gJy4uLy4uL2ZiL0ZpbGUnO1xuaW1wb3J0IHsgZmxhdGJ1ZmZlcnMgfSBmcm9tICdmbGF0YnVmZmVycyc7XG5cbmltcG9ydCBMb25nID0gZmxhdGJ1ZmZlcnMuTG9uZztcbmltcG9ydCBCdWlsZGVyID0gZmxhdGJ1ZmZlcnMuQnVpbGRlcjtcbmltcG9ydCBCeXRlQnVmZmVyID0gZmxhdGJ1ZmZlcnMuQnl0ZUJ1ZmZlcjtcbmltcG9ydCBfQmxvY2sgPSBGaWxlXy5vcmcuYXBhY2hlLmFycm93LmZsYXRidWYuQmxvY2s7XG5pbXBvcnQgX0Zvb3RlciA9IEZpbGVfLm9yZy5hcGFjaGUuYXJyb3cuZmxhdGJ1Zi5Gb290ZXI7XG5cbmltcG9ydCB7IFNjaGVtYSB9IGZyb20gJy4uLy4uL3NjaGVtYSc7XG5pbXBvcnQgeyBNZXRhZGF0YVZlcnNpb24gfSBmcm9tICcuLi8uLi9lbnVtJztcbmltcG9ydCB7IHRvVWludDhBcnJheSB9IGZyb20gJy4uLy4uL3V0aWwvYnVmZmVyJztcbmltcG9ydCB7IEFycmF5QnVmZmVyVmlld0lucHV0IH0gZnJvbSAnLi4vLi4vdXRpbC9idWZmZXInO1xuXG5jbGFzcyBGb290ZXJfIHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZGVjb2RlKGJ1ZjogQXJyYXlCdWZmZXJWaWV3SW5wdXQpIHtcbiAgICAgICAgYnVmID0gbmV3IEJ5dGVCdWZmZXIodG9VaW50OEFycmF5KGJ1ZikpO1xuICAgICAgICBjb25zdCBmb290ZXIgPSBfRm9vdGVyLmdldFJvb3RBc0Zvb3RlcihidWYpO1xuICAgICAgICBjb25zdCBzY2hlbWEgPSBTY2hlbWEuZGVjb2RlKGZvb3Rlci5zY2hlbWEoKSEpO1xuICAgICAgICByZXR1cm4gbmV3IE9mZkhlYXBGb290ZXIoc2NoZW1hLCBmb290ZXIpIGFzIEZvb3Rlcl87XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBlbmNvZGUoZm9vdGVyOiBGb290ZXJfKSB7XG5cbiAgICAgICAgY29uc3QgYjogQnVpbGRlciA9IG5ldyBCdWlsZGVyKCk7XG4gICAgICAgIGNvbnN0IHNjaGVtYU9mZnNldCA9IFNjaGVtYS5lbmNvZGUoYiwgZm9vdGVyLnNjaGVtYSk7XG5cbiAgICAgICAgX0Zvb3Rlci5zdGFydFJlY29yZEJhdGNoZXNWZWN0b3IoYiwgZm9vdGVyLm51bVJlY29yZEJhdGNoZXMpO1xuICAgICAgICBbLi4uZm9vdGVyLnJlY29yZEJhdGNoZXMoKV0uc2xpY2UoKS5yZXZlcnNlKCkuZm9yRWFjaCgocmIpID0+IEZpbGVCbG9jay5lbmNvZGUoYiwgcmIpKTtcbiAgICAgICAgY29uc3QgcmVjb3JkQmF0Y2hlc09mZnNldCA9IGIuZW5kVmVjdG9yKCk7XG5cbiAgICAgICAgX0Zvb3Rlci5zdGFydERpY3Rpb25hcmllc1ZlY3RvcihiLCBmb290ZXIubnVtRGljdGlvbmFyaWVzKTtcbiAgICAgICAgWy4uLmZvb3Rlci5kaWN0aW9uYXJ5QmF0Y2hlcygpXS5zbGljZSgpLnJldmVyc2UoKS5mb3JFYWNoKChkYikgPT4gRmlsZUJsb2NrLmVuY29kZShiLCBkYikpO1xuXG4gICAgICAgIGNvbnN0IGRpY3Rpb25hcnlCYXRjaGVzT2Zmc2V0ID0gYi5lbmRWZWN0b3IoKTtcblxuICAgICAgICBfRm9vdGVyLnN0YXJ0Rm9vdGVyKGIpO1xuICAgICAgICBfRm9vdGVyLmFkZFNjaGVtYShiLCBzY2hlbWFPZmZzZXQpO1xuICAgICAgICBfRm9vdGVyLmFkZFZlcnNpb24oYiwgTWV0YWRhdGFWZXJzaW9uLlY0KTtcbiAgICAgICAgX0Zvb3Rlci5hZGRSZWNvcmRCYXRjaGVzKGIsIHJlY29yZEJhdGNoZXNPZmZzZXQpO1xuICAgICAgICBfRm9vdGVyLmFkZERpY3Rpb25hcmllcyhiLCBkaWN0aW9uYXJ5QmF0Y2hlc09mZnNldCk7XG4gICAgICAgIF9Gb290ZXIuZmluaXNoRm9vdGVyQnVmZmVyKGIsIF9Gb290ZXIuZW5kRm9vdGVyKGIpKTtcblxuICAgICAgICByZXR1cm4gYi5hc1VpbnQ4QXJyYXkoKTtcbiAgICB9XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJvdGVjdGVkIF9yZWNvcmRCYXRjaGVzOiBGaWxlQmxvY2tbXTtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJvdGVjdGVkIF9kaWN0aW9uYXJ5QmF0Y2hlczogRmlsZUJsb2NrW107XG4gICAgcHVibGljIGdldCBudW1SZWNvcmRCYXRjaGVzKCkgeyByZXR1cm4gdGhpcy5fcmVjb3JkQmF0Y2hlcy5sZW5ndGg7IH1cbiAgICBwdWJsaWMgZ2V0IG51bURpY3Rpb25hcmllcygpIHsgcmV0dXJuIHRoaXMuX2RpY3Rpb25hcnlCYXRjaGVzLmxlbmd0aDsgfVxuXG4gICAgY29uc3RydWN0b3IocHVibGljIHNjaGVtYTogU2NoZW1hLFxuICAgICAgICAgICAgICAgIHB1YmxpYyB2ZXJzaW9uOiBNZXRhZGF0YVZlcnNpb24gPSBNZXRhZGF0YVZlcnNpb24uVjQsXG4gICAgICAgICAgICAgICAgcmVjb3JkQmF0Y2hlcz86IEZpbGVCbG9ja1tdLCBkaWN0aW9uYXJ5QmF0Y2hlcz86IEZpbGVCbG9ja1tdKSB7XG4gICAgICAgIHJlY29yZEJhdGNoZXMgJiYgKHRoaXMuX3JlY29yZEJhdGNoZXMgPSByZWNvcmRCYXRjaGVzKTtcbiAgICAgICAgZGljdGlvbmFyeUJhdGNoZXMgJiYgKHRoaXMuX2RpY3Rpb25hcnlCYXRjaGVzID0gZGljdGlvbmFyeUJhdGNoZXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyAqcmVjb3JkQmF0Y2hlcygpOiBJdGVyYWJsZTxGaWxlQmxvY2s+IHtcbiAgICAgICAgZm9yIChsZXQgYmxvY2ssIGkgPSAtMSwgbiA9IHRoaXMubnVtUmVjb3JkQmF0Y2hlczsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGlmIChibG9jayA9IHRoaXMuZ2V0UmVjb3JkQmF0Y2goaSkpIHsgeWllbGQgYmxvY2s7IH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyAqZGljdGlvbmFyeUJhdGNoZXMoKTogSXRlcmFibGU8RmlsZUJsb2NrPiB7XG4gICAgICAgIGZvciAobGV0IGJsb2NrLCBpID0gLTEsIG4gPSB0aGlzLm51bURpY3Rpb25hcmllczsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGlmIChibG9jayA9IHRoaXMuZ2V0RGljdGlvbmFyeUJhdGNoKGkpKSB7IHlpZWxkIGJsb2NrOyB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UmVjb3JkQmF0Y2goaW5kZXg6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gaW5kZXggPj0gMFxuICAgICAgICAgICAgJiYgaW5kZXggPCB0aGlzLm51bVJlY29yZEJhdGNoZXNcbiAgICAgICAgICAgICYmIHRoaXMuX3JlY29yZEJhdGNoZXNbaW5kZXhdIHx8IG51bGw7XG4gICAgfVxuXG4gICAgcHVibGljIGdldERpY3Rpb25hcnlCYXRjaChpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBpbmRleCA+PSAwXG4gICAgICAgICAgICAmJiBpbmRleCA8IHRoaXMubnVtRGljdGlvbmFyaWVzXG4gICAgICAgICAgICAmJiB0aGlzLl9kaWN0aW9uYXJ5QmF0Y2hlc1tpbmRleF0gfHwgbnVsbDtcbiAgICB9XG59XG5cbmV4cG9ydCB7IEZvb3Rlcl8gYXMgRm9vdGVyIH07XG5cbmNsYXNzIE9mZkhlYXBGb290ZXIgZXh0ZW5kcyBGb290ZXJfIHtcblxuICAgIHB1YmxpYyBnZXQgbnVtUmVjb3JkQmF0Y2hlcygpIHsgcmV0dXJuIHRoaXMuX2Zvb3Rlci5yZWNvcmRCYXRjaGVzTGVuZ3RoKCk7IH1cbiAgICBwdWJsaWMgZ2V0IG51bURpY3Rpb25hcmllcygpIHsgcmV0dXJuIHRoaXMuX2Zvb3Rlci5kaWN0aW9uYXJpZXNMZW5ndGgoKTsgfVxuXG4gICAgY29uc3RydWN0b3Ioc2NoZW1hOiBTY2hlbWEsIHByb3RlY3RlZCBfZm9vdGVyOiBfRm9vdGVyKSB7XG4gICAgICAgIHN1cGVyKHNjaGVtYSwgX2Zvb3Rlci52ZXJzaW9uKCkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRSZWNvcmRCYXRjaChpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIGlmIChpbmRleCA+PSAwICYmIGluZGV4IDwgdGhpcy5udW1SZWNvcmRCYXRjaGVzKSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlQmxvY2sgPSB0aGlzLl9mb290ZXIucmVjb3JkQmF0Y2hlcyhpbmRleCk7XG4gICAgICAgICAgICBpZiAoZmlsZUJsb2NrKSB7IHJldHVybiBGaWxlQmxvY2suZGVjb2RlKGZpbGVCbG9jayk7IH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0RGljdGlvbmFyeUJhdGNoKGluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzLm51bURpY3Rpb25hcmllcykge1xuICAgICAgICAgICAgY29uc3QgZmlsZUJsb2NrID0gdGhpcy5fZm9vdGVyLmRpY3Rpb25hcmllcyhpbmRleCk7XG4gICAgICAgICAgICBpZiAoZmlsZUJsb2NrKSB7IHJldHVybiBGaWxlQmxvY2suZGVjb2RlKGZpbGVCbG9jayk7IH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBGaWxlQmxvY2sge1xuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBkZWNvZGUoYmxvY2s6IF9CbG9jaykge1xuICAgICAgICByZXR1cm4gbmV3IEZpbGVCbG9jayhibG9jay5tZXRhRGF0YUxlbmd0aCgpLCBibG9jay5ib2R5TGVuZ3RoKCksIGJsb2NrLm9mZnNldCgpKTtcbiAgICB9XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGVuY29kZShiOiBCdWlsZGVyLCBmaWxlQmxvY2s6IEZpbGVCbG9jaykge1xuICAgICAgICBjb25zdCB7IG1ldGFEYXRhTGVuZ3RoIH0gPSBmaWxlQmxvY2s7XG4gICAgICAgIGNvbnN0IG9mZnNldCA9IG5ldyBMb25nKGZpbGVCbG9jay5vZmZzZXQsIDApO1xuICAgICAgICBjb25zdCBib2R5TGVuZ3RoID0gbmV3IExvbmcoZmlsZUJsb2NrLmJvZHlMZW5ndGgsIDApO1xuICAgICAgICByZXR1cm4gX0Jsb2NrLmNyZWF0ZUJsb2NrKGIsIG9mZnNldCwgbWV0YURhdGFMZW5ndGgsIGJvZHlMZW5ndGgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvZmZzZXQ6IG51bWJlcjtcbiAgICBwdWJsaWMgYm9keUxlbmd0aDogbnVtYmVyO1xuICAgIHB1YmxpYyBtZXRhRGF0YUxlbmd0aDogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IobWV0YURhdGFMZW5ndGg6IG51bWJlciwgYm9keUxlbmd0aDogTG9uZyB8IG51bWJlciwgb2Zmc2V0OiBMb25nIHwgbnVtYmVyKSB7XG4gICAgICAgIHRoaXMubWV0YURhdGFMZW5ndGggPSBtZXRhRGF0YUxlbmd0aDtcbiAgICAgICAgdGhpcy5vZmZzZXQgPSB0eXBlb2Ygb2Zmc2V0ID09PSAnbnVtYmVyJyA/IG9mZnNldCA6IG9mZnNldC5sb3c7XG4gICAgICAgIHRoaXMuYm9keUxlbmd0aCA9IHR5cGVvZiBib2R5TGVuZ3RoID09PSAnbnVtYmVyJyA/IGJvZHlMZW5ndGggOiBib2R5TGVuZ3RoLmxvdztcbiAgICB9XG59XG4iXX0=
