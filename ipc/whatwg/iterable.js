"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const buffer_1 = require("../../util/buffer");
const compat_1 = require("../../util/compat");
const hack_1 = require("./hack");
function toReadableDOMStream(source, options) {
    if (compat_1.isAsyncIterable(source)) {
        return asyncIterableAsReadableDOMStream(source, options);
    }
    if (compat_1.isIterable(source)) {
        return iterableAsReadableDOMStream(source, options);
    }
    /* istanbul ignore next */
    throw new Error(`toReadableDOMStream() must be called with an Iterable or AsyncIterable`);
}
exports.toReadableDOMStream = toReadableDOMStream;
function iterableAsReadableDOMStream(source, options) {
    let it = null;
    const bm = (options && options.type === 'bytes') || false;
    const hwm = options && options.highWaterMark || (Math.pow(2, 24));
    return new ReadableStream(Object.assign({}, options, { start(controller) { next(controller, it || (it = source[Symbol.iterator]())); },
        pull(controller) { it ? (next(controller, it)) : controller.close(); },
        cancel() { (it && (it.return && it.return()) || true) && (it = null); } }), Object.assign({ highWaterMark: bm ? hwm : undefined }, options));
    function next(controller, it) {
        let buf;
        let r = null;
        let size = controller.desiredSize || null;
        while (!(r = it.next(bm ? size : null)).done) {
            if (ArrayBuffer.isView(r.value) && (buf = buffer_1.toUint8Array(r.value))) {
                size != null && bm && (size = size - buf.byteLength + 1);
                r.value = hack_1.protectArrayBufferFromWhatwgRefImpl(buf);
            }
            controller.enqueue(r.value);
            if (size != null && --size <= 0) {
                return;
            }
        }
        controller.close();
    }
}
function asyncIterableAsReadableDOMStream(source, options) {
    let it = null;
    const bm = (options && options.type === 'bytes') || false;
    const hwm = options && options.highWaterMark || (Math.pow(2, 24));
    return new ReadableStream(Object.assign({}, options, { start(controller) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { yield next(controller, it || (it = source[Symbol.asyncIterator]())); });
        },
        pull(controller) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { it ? (yield next(controller, it)) : controller.close(); });
        },
        cancel() {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { (it && (it.return && (yield it.return())) || true) && (it = null); });
        } }), Object.assign({ highWaterMark: bm ? hwm : undefined }, options));
    function next(controller, it) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let buf;
            let r = null;
            let size = controller.desiredSize || null;
            while (!(r = yield it.next(bm ? size : null)).done) {
                if (ArrayBuffer.isView(r.value) && (buf = buffer_1.toUint8Array(r.value))) {
                    size != null && bm && (size = size - buf.byteLength + 1);
                    r.value = hack_1.protectArrayBufferFromWhatwgRefImpl(buf);
                }
                controller.enqueue(r.value);
                if (size != null && --size <= 0) {
                    return;
                }
            }
            controller.close();
        });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImlwYy93aGF0d2cvaXRlcmFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDZEQUE2RDtBQUM3RCwrREFBK0Q7QUFDL0Qsd0RBQXdEO0FBQ3hELDZEQUE2RDtBQUM3RCxvREFBb0Q7QUFDcEQsNkRBQTZEO0FBQzdELDZEQUE2RDtBQUM3RCxFQUFFO0FBQ0YsK0NBQStDO0FBQy9DLEVBQUU7QUFDRiw2REFBNkQ7QUFDN0QsOERBQThEO0FBQzlELHlEQUF5RDtBQUN6RCw0REFBNEQ7QUFDNUQsMERBQTBEO0FBQzFELHFCQUFxQjs7O0FBRXJCLDhDQUFpRDtBQUVqRCw4Q0FBZ0U7QUFDaEUsaUNBQTZEO0FBRTdELFNBQWdCLG1CQUFtQixDQUFJLE1BQXNDLEVBQUUsT0FBa0M7SUFDN0csSUFBSSx3QkFBZSxDQUFJLE1BQU0sQ0FBQyxFQUFFO1FBQUUsT0FBTyxnQ0FBZ0MsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FBRTtJQUM3RixJQUFJLG1CQUFVLENBQUksTUFBTSxDQUFDLEVBQUU7UUFBRSxPQUFPLDJCQUEyQixDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztLQUFFO0lBQ25GLDBCQUEwQjtJQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLHdFQUF3RSxDQUFDLENBQUM7QUFDOUYsQ0FBQztBQUxELGtEQUtDO0FBRUQsU0FBUywyQkFBMkIsQ0FBSSxNQUFtQixFQUFFLE9BQWtDO0lBRTNGLElBQUksRUFBRSxHQUF1QixJQUFJLENBQUM7SUFDbEMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUM7SUFDMUQsTUFBTSxHQUFHLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxhQUFhLElBQUksQ0FBQyxTQUFBLENBQUMsRUFBSSxFQUFFLENBQUEsQ0FBQyxDQUFDO0lBRTFELE9BQU8sSUFBSSxjQUFjLG1CQUNsQixPQUFjLElBQ2pCLEtBQUssQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0UsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sS0FBSyxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLHFCQUN0RSxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFNBQVMsSUFBSyxPQUFPLEVBQUcsQ0FBQztJQUV4RCxTQUFTLElBQUksQ0FBQyxVQUE4QyxFQUFFLEVBQWU7UUFDekUsSUFBSSxHQUFlLENBQUM7UUFDcEIsSUFBSSxDQUFDLEdBQTZCLElBQUksQ0FBQztRQUN2QyxJQUFJLElBQUksR0FBRyxVQUFVLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztRQUMxQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUU7WUFDMUMsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxxQkFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO2dCQUM5RCxJQUFJLElBQUksSUFBSSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDekQsQ0FBQyxDQUFDLEtBQUssR0FBUywwQ0FBbUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUM1RDtZQUNELFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzVCLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLEVBQUU7Z0JBQUUsT0FBTzthQUFFO1NBQy9DO1FBQ0QsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3ZCLENBQUM7QUFDTCxDQUFDO0FBRUQsU0FBUyxnQ0FBZ0MsQ0FBSSxNQUF3QixFQUFFLE9BQWtDO0lBRXJHLElBQUksRUFBRSxHQUE0QixJQUFJLENBQUM7SUFDdkMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUM7SUFDMUQsTUFBTSxHQUFHLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxhQUFhLElBQUksQ0FBQyxTQUFBLENBQUMsRUFBSSxFQUFFLENBQUEsQ0FBQyxDQUFDO0lBRTFELE9BQU8sSUFBSSxjQUFjLG1CQUNsQixPQUFjLElBQ1gsS0FBSyxDQUFDLFVBQVU7MEVBQUksTUFBTSxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUFBO1FBQzFGLElBQUksQ0FBQyxVQUFVOzBFQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztTQUFBO1FBQzVFLE1BQU07MEVBQUssQ0FBQyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxLQUFJLE1BQU0sRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFBLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FBQSxxQkFDbEYsYUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLElBQUssT0FBTyxFQUFHLENBQUM7SUFFeEQsU0FBZSxJQUFJLENBQUMsVUFBOEMsRUFBRSxFQUFvQjs7WUFDcEYsSUFBSSxHQUFlLENBQUM7WUFDcEIsSUFBSSxDQUFDLEdBQTZCLElBQUksQ0FBQztZQUN2QyxJQUFJLElBQUksR0FBRyxVQUFVLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztZQUMxQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTtnQkFDaEQsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxxQkFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO29CQUM5RCxJQUFJLElBQUksSUFBSSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDekQsQ0FBQyxDQUFDLEtBQUssR0FBUywwQ0FBbUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDNUQ7Z0JBQ0QsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzVCLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLEVBQUU7b0JBQUUsT0FBTztpQkFBRTthQUMvQztZQUNELFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN2QixDQUFDO0tBQUE7QUFDTCxDQUFDIiwiZmlsZSI6ImlwYy93aGF0d2cvaXRlcmFibGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgdG9VaW50OEFycmF5IH0gZnJvbSAnLi4vLi4vdXRpbC9idWZmZXInO1xuaW1wb3J0IHsgUmVhZGFibGVET01TdHJlYW1PcHRpb25zIH0gZnJvbSAnLi4vLi4vaW8vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBpc0l0ZXJhYmxlLCBpc0FzeW5jSXRlcmFibGUgfSBmcm9tICcuLi8uLi91dGlsL2NvbXBhdCc7XG5pbXBvcnQgeyBwcm90ZWN0QXJyYXlCdWZmZXJGcm9tV2hhdHdnUmVmSW1wbCB9IGZyb20gJy4vaGFjayc7XG5cbmV4cG9ydCBmdW5jdGlvbiB0b1JlYWRhYmxlRE9NU3RyZWFtPFQ+KHNvdXJjZTogSXRlcmFibGU8VD4gfCBBc3luY0l0ZXJhYmxlPFQ+LCBvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKTogUmVhZGFibGVTdHJlYW08VD4ge1xuICAgIGlmIChpc0FzeW5jSXRlcmFibGU8VD4oc291cmNlKSkgeyByZXR1cm4gYXN5bmNJdGVyYWJsZUFzUmVhZGFibGVET01TdHJlYW0oc291cmNlLCBvcHRpb25zKTsgfVxuICAgIGlmIChpc0l0ZXJhYmxlPFQ+KHNvdXJjZSkpIHsgcmV0dXJuIGl0ZXJhYmxlQXNSZWFkYWJsZURPTVN0cmVhbShzb3VyY2UsIG9wdGlvbnMpOyB9XG4gICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICB0aHJvdyBuZXcgRXJyb3IoYHRvUmVhZGFibGVET01TdHJlYW0oKSBtdXN0IGJlIGNhbGxlZCB3aXRoIGFuIEl0ZXJhYmxlIG9yIEFzeW5jSXRlcmFibGVgKTtcbn1cblxuZnVuY3Rpb24gaXRlcmFibGVBc1JlYWRhYmxlRE9NU3RyZWFtPFQ+KHNvdXJjZTogSXRlcmFibGU8VD4sIG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpIHtcblxuICAgIGxldCBpdDogSXRlcmF0b3I8VD4gfCBudWxsID0gbnVsbDtcbiAgICBjb25zdCBibSA9IChvcHRpb25zICYmIG9wdGlvbnMudHlwZSA9PT0gJ2J5dGVzJykgfHwgZmFsc2U7XG4gICAgY29uc3QgaHdtID0gb3B0aW9ucyAmJiBvcHRpb25zLmhpZ2hXYXRlck1hcmsgfHwgKDIgKiogMjQpO1xuXG4gICAgcmV0dXJuIG5ldyBSZWFkYWJsZVN0cmVhbTxUPih7XG4gICAgICAgIC4uLm9wdGlvbnMgYXMgYW55LFxuICAgICAgICBzdGFydChjb250cm9sbGVyKSB7IG5leHQoY29udHJvbGxlciwgaXQgfHwgKGl0ID0gc291cmNlW1N5bWJvbC5pdGVyYXRvcl0oKSkpOyB9LFxuICAgICAgICBwdWxsKGNvbnRyb2xsZXIpIHsgaXQgPyAobmV4dChjb250cm9sbGVyLCBpdCkpIDogY29udHJvbGxlci5jbG9zZSgpOyB9LFxuICAgICAgICBjYW5jZWwoKSB7IChpdCAmJiAoaXQucmV0dXJuICYmIGl0LnJldHVybigpKSB8fCB0cnVlKSAmJiAoaXQgPSBudWxsKTsgfVxuICAgIH0sIHsgaGlnaFdhdGVyTWFyazogYm0gPyBod20gOiB1bmRlZmluZWQsIC4uLm9wdGlvbnMgfSk7XG5cbiAgICBmdW5jdGlvbiBuZXh0KGNvbnRyb2xsZXI6IFJlYWRhYmxlU3RyZWFtRGVmYXVsdENvbnRyb2xsZXI8VD4sIGl0OiBJdGVyYXRvcjxUPikge1xuICAgICAgICBsZXQgYnVmOiBVaW50OEFycmF5O1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8VD4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgbGV0IHNpemUgPSBjb250cm9sbGVyLmRlc2lyZWRTaXplIHx8IG51bGw7XG4gICAgICAgIHdoaWxlICghKHIgPSBpdC5uZXh0KGJtID8gc2l6ZSA6IG51bGwpKS5kb25lKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHIudmFsdWUpICYmIChidWYgPSB0b1VpbnQ4QXJyYXkoci52YWx1ZSkpKSB7XG4gICAgICAgICAgICAgICAgc2l6ZSAhPSBudWxsICYmIGJtICYmIChzaXplID0gc2l6ZSAtIGJ1Zi5ieXRlTGVuZ3RoICsgMSk7XG4gICAgICAgICAgICAgICAgci52YWx1ZSA9IDxhbnk+IHByb3RlY3RBcnJheUJ1ZmZlckZyb21XaGF0d2dSZWZJbXBsKGJ1Zik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250cm9sbGVyLmVucXVldWUoci52YWx1ZSk7XG4gICAgICAgICAgICBpZiAoc2l6ZSAhPSBudWxsICYmIC0tc2l6ZSA8PSAwKSB7IHJldHVybjsgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnRyb2xsZXIuY2xvc2UoKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGFzeW5jSXRlcmFibGVBc1JlYWRhYmxlRE9NU3RyZWFtPFQ+KHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucykge1xuXG4gICAgbGV0IGl0OiBBc3luY0l0ZXJhdG9yPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgY29uc3QgYm0gPSAob3B0aW9ucyAmJiBvcHRpb25zLnR5cGUgPT09ICdieXRlcycpIHx8IGZhbHNlO1xuICAgIGNvbnN0IGh3bSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5oaWdoV2F0ZXJNYXJrIHx8ICgyICoqIDI0KTtcblxuICAgIHJldHVybiBuZXcgUmVhZGFibGVTdHJlYW08VD4oe1xuICAgICAgICAuLi5vcHRpb25zIGFzIGFueSxcbiAgICAgICAgYXN5bmMgc3RhcnQoY29udHJvbGxlcikgeyBhd2FpdCBuZXh0KGNvbnRyb2xsZXIsIGl0IHx8IChpdCA9IHNvdXJjZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSkpOyB9LFxuICAgICAgICBhc3luYyBwdWxsKGNvbnRyb2xsZXIpIHsgaXQgPyAoYXdhaXQgbmV4dChjb250cm9sbGVyLCBpdCkpIDogY29udHJvbGxlci5jbG9zZSgpOyB9LFxuICAgICAgICBhc3luYyBjYW5jZWwoKSB7IChpdCAmJiAoaXQucmV0dXJuICYmIGF3YWl0IGl0LnJldHVybigpKSB8fCB0cnVlKSAmJiAoaXQgPSBudWxsKTsgfSxcbiAgICB9LCB7IGhpZ2hXYXRlck1hcms6IGJtID8gaHdtIDogdW5kZWZpbmVkLCAuLi5vcHRpb25zIH0pO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gbmV4dChjb250cm9sbGVyOiBSZWFkYWJsZVN0cmVhbURlZmF1bHRDb250cm9sbGVyPFQ+LCBpdDogQXN5bmNJdGVyYXRvcjxUPikge1xuICAgICAgICBsZXQgYnVmOiBVaW50OEFycmF5O1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8VD4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgbGV0IHNpemUgPSBjb250cm9sbGVyLmRlc2lyZWRTaXplIHx8IG51bGw7XG4gICAgICAgIHdoaWxlICghKHIgPSBhd2FpdCBpdC5uZXh0KGJtID8gc2l6ZSA6IG51bGwpKS5kb25lKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHIudmFsdWUpICYmIChidWYgPSB0b1VpbnQ4QXJyYXkoci52YWx1ZSkpKSB7XG4gICAgICAgICAgICAgICAgc2l6ZSAhPSBudWxsICYmIGJtICYmIChzaXplID0gc2l6ZSAtIGJ1Zi5ieXRlTGVuZ3RoICsgMSk7XG4gICAgICAgICAgICAgICAgci52YWx1ZSA9IDxhbnk+IHByb3RlY3RBcnJheUJ1ZmZlckZyb21XaGF0d2dSZWZJbXBsKGJ1Zik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250cm9sbGVyLmVucXVldWUoci52YWx1ZSk7XG4gICAgICAgICAgICBpZiAoc2l6ZSAhPSBudWxsICYmIC0tc2l6ZSA8PSAwKSB7IHJldHVybjsgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnRyb2xsZXIuY2xvc2UoKTtcbiAgICB9XG59XG4iXX0=
