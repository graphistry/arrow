"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const buffer_1 = require("../../util/buffer");
const compat_1 = require("../../util/compat");
const hack_1 = require("./hack");
/** @ignore */
function toReadableDOMStream(source, options) {
    if (compat_1.isAsyncIterable(source)) {
        return asyncIterableAsReadableDOMStream(source, options);
    }
    if (compat_1.isIterable(source)) {
        return iterableAsReadableDOMStream(source, options);
    }
    /* istanbul ignore next */
    throw new Error(`toReadableDOMStream() must be called with an Iterable or AsyncIterable`);
}
exports.toReadableDOMStream = toReadableDOMStream;
/** @ignore */
function iterableAsReadableDOMStream(source, options) {
    let it = null;
    const bm = (options && options.type === 'bytes') || false;
    const hwm = options && options.highWaterMark || (Math.pow(2, 24));
    return new ReadableStream(Object.assign({}, options, { start(controller) { next(controller, it || (it = source[Symbol.iterator]())); },
        pull(controller) { it ? (next(controller, it)) : controller.close(); },
        cancel() { (it && (it.return && it.return()) || true) && (it = null); } }), Object.assign({ highWaterMark: bm ? hwm : undefined }, options));
    function next(controller, it) {
        let buf;
        let r = null;
        let size = controller.desiredSize || null;
        while (!(r = it.next(bm ? size : null)).done) {
            if (ArrayBuffer.isView(r.value) && (buf = buffer_1.toUint8Array(r.value))) {
                size != null && bm && (size = size - buf.byteLength + 1);
                r.value = hack_1.protectArrayBufferFromWhatwgRefImpl(buf);
            }
            controller.enqueue(r.value);
            if (size != null && --size <= 0) {
                return;
            }
        }
        controller.close();
    }
}
/** @ignore */
function asyncIterableAsReadableDOMStream(source, options) {
    let it = null;
    const bm = (options && options.type === 'bytes') || false;
    const hwm = options && options.highWaterMark || (Math.pow(2, 24));
    return new ReadableStream(Object.assign({}, options, { start(controller) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { yield next(controller, it || (it = source[Symbol.asyncIterator]())); });
        },
        pull(controller) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { it ? (yield next(controller, it)) : controller.close(); });
        },
        cancel() {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { (it && (it.return && (yield it.return())) || true) && (it = null); });
        } }), Object.assign({ highWaterMark: bm ? hwm : undefined }, options));
    function next(controller, it) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let buf;
            let r = null;
            let size = controller.desiredSize || null;
            while (!(r = yield it.next(bm ? size : null)).done) {
                if (ArrayBuffer.isView(r.value) && (buf = buffer_1.toUint8Array(r.value))) {
                    size != null && bm && (size = size - buf.byteLength + 1);
                    r.value = hack_1.protectArrayBufferFromWhatwgRefImpl(buf);
                }
                controller.enqueue(r.value);
                if (size != null && --size <= 0) {
                    return;
                }
            }
            controller.close();
        });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN2QixDQUFDO0tBQUE7QUFDTCxDQUFDIiwiZmlsZSI6ImlwYy93aGF0d2cvaXRlcmFibGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgdG9VaW50OEFycmF5IH0gZnJvbSAnLi4vLi4vdXRpbC9idWZmZXInO1xuaW1wb3J0IHsgUmVhZGFibGVET01TdHJlYW1PcHRpb25zIH0gZnJvbSAnLi4vLi4vaW8vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBpc0l0ZXJhYmxlLCBpc0FzeW5jSXRlcmFibGUgfSBmcm9tICcuLi8uLi91dGlsL2NvbXBhdCc7XG5pbXBvcnQgeyBwcm90ZWN0QXJyYXlCdWZmZXJGcm9tV2hhdHdnUmVmSW1wbCB9IGZyb20gJy4vaGFjayc7XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgZnVuY3Rpb24gdG9SZWFkYWJsZURPTVN0cmVhbTxUPihzb3VyY2U6IEl0ZXJhYmxlPFQ+IHwgQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyk6IFJlYWRhYmxlU3RyZWFtPFQ+IHtcbiAgICBpZiAoaXNBc3luY0l0ZXJhYmxlPFQ+KHNvdXJjZSkpIHsgcmV0dXJuIGFzeW5jSXRlcmFibGVBc1JlYWRhYmxlRE9NU3RyZWFtKHNvdXJjZSwgb3B0aW9ucyk7IH1cbiAgICBpZiAoaXNJdGVyYWJsZTxUPihzb3VyY2UpKSB7IHJldHVybiBpdGVyYWJsZUFzUmVhZGFibGVET01TdHJlYW0oc291cmNlLCBvcHRpb25zKTsgfVxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgdGhyb3cgbmV3IEVycm9yKGB0b1JlYWRhYmxlRE9NU3RyZWFtKCkgbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBJdGVyYWJsZSBvciBBc3luY0l0ZXJhYmxlYCk7XG59XG5cbi8qKiBAaWdub3JlICovXG5mdW5jdGlvbiBpdGVyYWJsZUFzUmVhZGFibGVET01TdHJlYW08VD4oc291cmNlOiBJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucykge1xuXG4gICAgbGV0IGl0OiBJdGVyYXRvcjxUPiB8IG51bGwgPSBudWxsO1xuICAgIGNvbnN0IGJtID0gKG9wdGlvbnMgJiYgb3B0aW9ucy50eXBlID09PSAnYnl0ZXMnKSB8fCBmYWxzZTtcbiAgICBjb25zdCBod20gPSBvcHRpb25zICYmIG9wdGlvbnMuaGlnaFdhdGVyTWFyayB8fCAoMiAqKiAyNCk7XG5cbiAgICByZXR1cm4gbmV3IFJlYWRhYmxlU3RyZWFtPFQ+KHtcbiAgICAgICAgLi4ub3B0aW9ucyBhcyBhbnksXG4gICAgICAgIHN0YXJ0KGNvbnRyb2xsZXIpIHsgbmV4dChjb250cm9sbGVyLCBpdCB8fCAoaXQgPSBzb3VyY2VbU3ltYm9sLml0ZXJhdG9yXSgpKSk7IH0sXG4gICAgICAgIHB1bGwoY29udHJvbGxlcikgeyBpdCA/IChuZXh0KGNvbnRyb2xsZXIsIGl0KSkgOiBjb250cm9sbGVyLmNsb3NlKCk7IH0sXG4gICAgICAgIGNhbmNlbCgpIHsgKGl0ICYmIChpdC5yZXR1cm4gJiYgaXQucmV0dXJuKCkpIHx8IHRydWUpICYmIChpdCA9IG51bGwpOyB9XG4gICAgfSwgeyBoaWdoV2F0ZXJNYXJrOiBibSA/IGh3bSA6IHVuZGVmaW5lZCwgLi4ub3B0aW9ucyB9KTtcblxuICAgIGZ1bmN0aW9uIG5leHQoY29udHJvbGxlcjogUmVhZGFibGVTdHJlYW1EZWZhdWx0Q29udHJvbGxlcjxUPiwgaXQ6IEl0ZXJhdG9yPFQ+KSB7XG4gICAgICAgIGxldCBidWY6IFVpbnQ4QXJyYXk7XG4gICAgICAgIGxldCByOiBJdGVyYXRvclJlc3VsdDxUPiB8IG51bGwgPSBudWxsO1xuICAgICAgICBsZXQgc2l6ZSA9IGNvbnRyb2xsZXIuZGVzaXJlZFNpemUgfHwgbnVsbDtcbiAgICAgICAgd2hpbGUgKCEociA9IGl0Lm5leHQoYm0gPyBzaXplIDogbnVsbCkpLmRvbmUpIHtcbiAgICAgICAgICAgIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoci52YWx1ZSkgJiYgKGJ1ZiA9IHRvVWludDhBcnJheShyLnZhbHVlKSkpIHtcbiAgICAgICAgICAgICAgICBzaXplICE9IG51bGwgJiYgYm0gJiYgKHNpemUgPSBzaXplIC0gYnVmLmJ5dGVMZW5ndGggKyAxKTtcbiAgICAgICAgICAgICAgICByLnZhbHVlID0gPGFueT4gcHJvdGVjdEFycmF5QnVmZmVyRnJvbVdoYXR3Z1JlZkltcGwoYnVmKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShyLnZhbHVlKTtcbiAgICAgICAgICAgIGlmIChzaXplICE9IG51bGwgJiYgLS1zaXplIDw9IDApIHsgcmV0dXJuOyB9XG4gICAgICAgIH1cbiAgICAgICAgY29udHJvbGxlci5jbG9zZSgpO1xuICAgIH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uIGFzeW5jSXRlcmFibGVBc1JlYWRhYmxlRE9NU3RyZWFtPFQ+KHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucykge1xuXG4gICAgbGV0IGl0OiBBc3luY0l0ZXJhdG9yPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgY29uc3QgYm0gPSAob3B0aW9ucyAmJiBvcHRpb25zLnR5cGUgPT09ICdieXRlcycpIHx8IGZhbHNlO1xuICAgIGNvbnN0IGh3bSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5oaWdoV2F0ZXJNYXJrIHx8ICgyICoqIDI0KTtcblxuICAgIHJldHVybiBuZXcgUmVhZGFibGVTdHJlYW08VD4oe1xuICAgICAgICAuLi5vcHRpb25zIGFzIGFueSxcbiAgICAgICAgYXN5bmMgc3RhcnQoY29udHJvbGxlcikgeyBhd2FpdCBuZXh0KGNvbnRyb2xsZXIsIGl0IHx8IChpdCA9IHNvdXJjZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSkpOyB9LFxuICAgICAgICBhc3luYyBwdWxsKGNvbnRyb2xsZXIpIHsgaXQgPyAoYXdhaXQgbmV4dChjb250cm9sbGVyLCBpdCkpIDogY29udHJvbGxlci5jbG9zZSgpOyB9LFxuICAgICAgICBhc3luYyBjYW5jZWwoKSB7IChpdCAmJiAoaXQucmV0dXJuICYmIGF3YWl0IGl0LnJldHVybigpKSB8fCB0cnVlKSAmJiAoaXQgPSBudWxsKTsgfSxcbiAgICB9LCB7IGhpZ2hXYXRlck1hcms6IGJtID8gaHdtIDogdW5kZWZpbmVkLCAuLi5vcHRpb25zIH0pO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gbmV4dChjb250cm9sbGVyOiBSZWFkYWJsZVN0cmVhbURlZmF1bHRDb250cm9sbGVyPFQ+LCBpdDogQXN5bmNJdGVyYXRvcjxUPikge1xuICAgICAgICBsZXQgYnVmOiBVaW50OEFycmF5O1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8VD4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgbGV0IHNpemUgPSBjb250cm9sbGVyLmRlc2lyZWRTaXplIHx8IG51bGw7XG4gICAgICAgIHdoaWxlICghKHIgPSBhd2FpdCBpdC5uZXh0KGJtID8gc2l6ZSA6IG51bGwpKS5kb25lKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHIudmFsdWUpICYmIChidWYgPSB0b1VpbnQ4QXJyYXkoci52YWx1ZSkpKSB7XG4gICAgICAgICAgICAgICAgc2l6ZSAhPSBudWxsICYmIGJtICYmIChzaXplID0gc2l6ZSAtIGJ1Zi5ieXRlTGVuZ3RoICsgMSk7XG4gICAgICAgICAgICAgICAgci52YWx1ZSA9IDxhbnk+IHByb3RlY3RBcnJheUJ1ZmZlckZyb21XaGF0d2dSZWZJbXBsKGJ1Zik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250cm9sbGVyLmVucXVldWUoci52YWx1ZSk7XG4gICAgICAgICAgICBpZiAoc2l6ZSAhPSBudWxsICYmIC0tc2l6ZSA8PSAwKSB7IHJldHVybjsgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnRyb2xsZXIuY2xvc2UoKTtcbiAgICB9XG59XG4iXX0=
