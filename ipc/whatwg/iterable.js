"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const buffer_1 = require("../../util/buffer");
const compat_1 = require("../../util/compat");
/** @ignore */
function toDOMStream(source, options) {
    if (compat_1.isAsyncIterable(source)) {
        return asyncIterableAsReadableDOMStream(source, options);
    }
    if (compat_1.isIterable(source)) {
        return iterableAsReadableDOMStream(source, options);
    }
    /* istanbul ignore next */
    throw new Error(`toDOMStream() must be called with an Iterable or AsyncIterable`);
}
exports.toDOMStream = toDOMStream;
/** @ignore */
function iterableAsReadableDOMStream(source, options) {
    let it = null;
    const bm = (options && options.type === 'bytes') || false;
    const hwm = options && options.highWaterMark || (Math.pow(2, 24));
    return new ReadableStream(Object.assign({}, options, { start(controller) { next(controller, it || (it = source[Symbol.iterator]())); },
        pull(controller) { it ? (next(controller, it)) : controller.close(); },
        cancel() { (it && (it.return && it.return()) || true) && (it = null); } }), Object.assign({ highWaterMark: bm ? hwm : undefined }, options));
    function next(controller, it) {
        let buf;
        let r = null;
        let size = controller.desiredSize || null;
        while (!(r = it.next(bm ? size : null)).done) {
            if (ArrayBuffer.isView(r.value) && (buf = buffer_1.toUint8Array(r.value))) {
                size != null && bm && (size = size - buf.byteLength + 1);
                r.value = buf;
            }
            controller.enqueue(r.value);
            if (size != null && --size <= 0) {
                return;
            }
        }
        controller.close();
    }
}
/** @ignore */
function asyncIterableAsReadableDOMStream(source, options) {
    let it = null;
    const bm = (options && options.type === 'bytes') || false;
    const hwm = options && options.highWaterMark || (Math.pow(2, 24));
    return new ReadableStream(Object.assign({}, options, { start(controller) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { yield next(controller, it || (it = source[Symbol.asyncIterator]())); });
        },
        pull(controller) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { it ? (yield next(controller, it)) : controller.close(); });
        },
        cancel() {
            return tslib_1.__awaiter(this, void 0, void 0, function* () { (it && (it.return && (yield it.return())) || true) && (it = null); });
        } }), Object.assign({ highWaterMark: bm ? hwm : undefined }, options));
    function next(controller, it) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let buf;
            let r = null;
            let size = controller.desiredSize || null;
            while (!(r = yield it.next(bm ? size : null)).done) {
                if (ArrayBuffer.isView(r.value) && (buf = buffer_1.toUint8Array(r.value))) {
                    size != null && bm && (size = size - buf.byteLength + 1);
                    r.value = buf;
                }
                controller.enqueue(r.value);
                if (size != null && --size <= 0) {
                    return;
                }
            }
            controller.close();
        });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LCJmaWxlIjoiaXBjL3doYXR3Zy9pdGVyYWJsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyB0b1VpbnQ4QXJyYXkgfSBmcm9tICcuLi8uLi91dGlsL2J1ZmZlcic7XG5pbXBvcnQgeyBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMgfSBmcm9tICcuLi8uLi9pby9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGlzSXRlcmFibGUsIGlzQXN5bmNJdGVyYWJsZSB9IGZyb20gJy4uLy4uL3V0aWwvY29tcGF0JztcblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBmdW5jdGlvbiB0b0RPTVN0cmVhbTxUPihzb3VyY2U6IEl0ZXJhYmxlPFQ+IHwgQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyk6IFJlYWRhYmxlU3RyZWFtPFQ+IHtcbiAgICBpZiAoaXNBc3luY0l0ZXJhYmxlPFQ+KHNvdXJjZSkpIHsgcmV0dXJuIGFzeW5jSXRlcmFibGVBc1JlYWRhYmxlRE9NU3RyZWFtKHNvdXJjZSwgb3B0aW9ucyk7IH1cbiAgICBpZiAoaXNJdGVyYWJsZTxUPihzb3VyY2UpKSB7IHJldHVybiBpdGVyYWJsZUFzUmVhZGFibGVET01TdHJlYW0oc291cmNlLCBvcHRpb25zKTsgfVxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgdGhyb3cgbmV3IEVycm9yKGB0b0RPTVN0cmVhbSgpIG11c3QgYmUgY2FsbGVkIHdpdGggYW4gSXRlcmFibGUgb3IgQXN5bmNJdGVyYWJsZWApO1xufVxuXG4vKiogQGlnbm9yZSAqL1xuZnVuY3Rpb24gaXRlcmFibGVBc1JlYWRhYmxlRE9NU3RyZWFtPFQ+KHNvdXJjZTogSXRlcmFibGU8VD4sIG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpIHtcblxuICAgIGxldCBpdDogSXRlcmF0b3I8VD4gfCBudWxsID0gbnVsbDtcbiAgICBjb25zdCBibSA9IChvcHRpb25zICYmIG9wdGlvbnMudHlwZSA9PT0gJ2J5dGVzJykgfHwgZmFsc2U7XG4gICAgY29uc3QgaHdtID0gb3B0aW9ucyAmJiBvcHRpb25zLmhpZ2hXYXRlck1hcmsgfHwgKDIgKiogMjQpO1xuXG4gICAgcmV0dXJuIG5ldyBSZWFkYWJsZVN0cmVhbTxUPih7XG4gICAgICAgIC4uLm9wdGlvbnMgYXMgYW55LFxuICAgICAgICBzdGFydChjb250cm9sbGVyKSB7IG5leHQoY29udHJvbGxlciwgaXQgfHwgKGl0ID0gc291cmNlW1N5bWJvbC5pdGVyYXRvcl0oKSkpOyB9LFxuICAgICAgICBwdWxsKGNvbnRyb2xsZXIpIHsgaXQgPyAobmV4dChjb250cm9sbGVyLCBpdCkpIDogY29udHJvbGxlci5jbG9zZSgpOyB9LFxuICAgICAgICBjYW5jZWwoKSB7IChpdCAmJiAoaXQucmV0dXJuICYmIGl0LnJldHVybigpKSB8fCB0cnVlKSAmJiAoaXQgPSBudWxsKTsgfVxuICAgIH0sIHsgaGlnaFdhdGVyTWFyazogYm0gPyBod20gOiB1bmRlZmluZWQsIC4uLm9wdGlvbnMgfSk7XG5cbiAgICBmdW5jdGlvbiBuZXh0KGNvbnRyb2xsZXI6IFJlYWRhYmxlU3RyZWFtRGVmYXVsdENvbnRyb2xsZXI8VD4sIGl0OiBJdGVyYXRvcjxUPikge1xuICAgICAgICBsZXQgYnVmOiBVaW50OEFycmF5O1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8VD4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgbGV0IHNpemUgPSBjb250cm9sbGVyLmRlc2lyZWRTaXplIHx8IG51bGw7XG4gICAgICAgIHdoaWxlICghKHIgPSBpdC5uZXh0KGJtID8gc2l6ZSA6IG51bGwpKS5kb25lKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHIudmFsdWUpICYmIChidWYgPSB0b1VpbnQ4QXJyYXkoci52YWx1ZSkpKSB7XG4gICAgICAgICAgICAgICAgc2l6ZSAhPSBudWxsICYmIGJtICYmIChzaXplID0gc2l6ZSAtIGJ1Zi5ieXRlTGVuZ3RoICsgMSk7XG4gICAgICAgICAgICAgICAgci52YWx1ZSA9IDxhbnk+IGJ1ZjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShyLnZhbHVlKTtcbiAgICAgICAgICAgIGlmIChzaXplICE9IG51bGwgJiYgLS1zaXplIDw9IDApIHsgcmV0dXJuOyB9XG4gICAgICAgIH1cbiAgICAgICAgY29udHJvbGxlci5jbG9zZSgpO1xuICAgIH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uIGFzeW5jSXRlcmFibGVBc1JlYWRhYmxlRE9NU3RyZWFtPFQ+KHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucykge1xuXG4gICAgbGV0IGl0OiBBc3luY0l0ZXJhdG9yPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgY29uc3QgYm0gPSAob3B0aW9ucyAmJiBvcHRpb25zLnR5cGUgPT09ICdieXRlcycpIHx8IGZhbHNlO1xuICAgIGNvbnN0IGh3bSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5oaWdoV2F0ZXJNYXJrIHx8ICgyICoqIDI0KTtcblxuICAgIHJldHVybiBuZXcgUmVhZGFibGVTdHJlYW08VD4oe1xuICAgICAgICAuLi5vcHRpb25zIGFzIGFueSxcbiAgICAgICAgYXN5bmMgc3RhcnQoY29udHJvbGxlcikgeyBhd2FpdCBuZXh0KGNvbnRyb2xsZXIsIGl0IHx8IChpdCA9IHNvdXJjZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSkpOyB9LFxuICAgICAgICBhc3luYyBwdWxsKGNvbnRyb2xsZXIpIHsgaXQgPyAoYXdhaXQgbmV4dChjb250cm9sbGVyLCBpdCkpIDogY29udHJvbGxlci5jbG9zZSgpOyB9LFxuICAgICAgICBhc3luYyBjYW5jZWwoKSB7IChpdCAmJiAoaXQucmV0dXJuICYmIGF3YWl0IGl0LnJldHVybigpKSB8fCB0cnVlKSAmJiAoaXQgPSBudWxsKTsgfSxcbiAgICB9LCB7IGhpZ2hXYXRlck1hcms6IGJtID8gaHdtIDogdW5kZWZpbmVkLCAuLi5vcHRpb25zIH0pO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gbmV4dChjb250cm9sbGVyOiBSZWFkYWJsZVN0cmVhbURlZmF1bHRDb250cm9sbGVyPFQ+LCBpdDogQXN5bmNJdGVyYXRvcjxUPikge1xuICAgICAgICBsZXQgYnVmOiBVaW50OEFycmF5O1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8VD4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgbGV0IHNpemUgPSBjb250cm9sbGVyLmRlc2lyZWRTaXplIHx8IG51bGw7XG4gICAgICAgIHdoaWxlICghKHIgPSBhd2FpdCBpdC5uZXh0KGJtID8gc2l6ZSA6IG51bGwpKS5kb25lKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHIudmFsdWUpICYmIChidWYgPSB0b1VpbnQ4QXJyYXkoci52YWx1ZSkpKSB7XG4gICAgICAgICAgICAgICAgc2l6ZSAhPSBudWxsICYmIGJtICYmIChzaXplID0gc2l6ZSAtIGJ1Zi5ieXRlTGVuZ3RoICsgMSk7XG4gICAgICAgICAgICAgICAgci52YWx1ZSA9IDxhbnk+IGJ1ZjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShyLnZhbHVlKTtcbiAgICAgICAgICAgIGlmIChzaXplICE9IG51bGwgJiYgLS1zaXplIDw9IDApIHsgcmV0dXJuOyB9XG4gICAgICAgIH1cbiAgICAgICAgY29udHJvbGxlci5jbG9zZSgpO1xuICAgIH1cbn1cbiJdfQ==
