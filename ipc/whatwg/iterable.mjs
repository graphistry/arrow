// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import { toUint8Array } from '../../util/buffer';
import { isIterable, isAsyncIterable } from '../../util/compat';
import { protectArrayBufferFromWhatwgRefImpl } from './hack';
export function toReadableDOMStream(source, options) {
    if (isAsyncIterable(source)) {
        return asyncIterableAsReadableDOMStream(source, options);
    }
    if (isIterable(source)) {
        return iterableAsReadableDOMStream(source, options);
    }
    /* istanbul ignore next */
    throw new Error(`toReadableDOMStream() must be called with an Iterable or AsyncIterable`);
}
function iterableAsReadableDOMStream(source, options) {
    let it = null;
    const bm = (options && options.type === 'bytes') || false;
    const hwm = options && options.highWaterMark || (2 ** 24);
    return new ReadableStream({
        ...options,
        start(controller) { next(controller, it || (it = source[Symbol.iterator]())); },
        pull(controller) { it ? (next(controller, it)) : controller.close(); },
        cancel() { (it && (it.return && it.return()) || true) && (it = null); }
    }, { highWaterMark: bm ? hwm : undefined, ...options });
    function next(controller, it) {
        let buf;
        let r = null;
        let size = controller.desiredSize || null;
        while (!(r = it.next(bm ? size : null)).done) {
            if (ArrayBuffer.isView(r.value) && (buf = toUint8Array(r.value))) {
                size != null && bm && (size = size - buf.byteLength + 1);
                r.value = protectArrayBufferFromWhatwgRefImpl(buf);
            }
            controller.enqueue(r.value);
            if (size != null && --size <= 0) {
                return;
            }
        }
        controller.close();
    }
}
function asyncIterableAsReadableDOMStream(source, options) {
    let it = null;
    const bm = (options && options.type === 'bytes') || false;
    const hwm = options && options.highWaterMark || (2 ** 24);
    return new ReadableStream({
        ...options,
        async start(controller) { await next(controller, it || (it = source[Symbol.asyncIterator]())); },
        async pull(controller) { it ? (await next(controller, it)) : controller.close(); },
        async cancel() { (it && (it.return && await it.return()) || true) && (it = null); },
    }, { highWaterMark: bm ? hwm : undefined, ...options });
    async function next(controller, it) {
        let buf;
        let r = null;
        let size = controller.desiredSize || null;
        while (!(r = await it.next(bm ? size : null)).done) {
            if (ArrayBuffer.isView(r.value) && (buf = toUint8Array(r.value))) {
                size != null && bm && (size = size - buf.byteLength + 1);
                r.value = protectArrayBufferFromWhatwgRefImpl(buf);
            }
            controller.enqueue(r.value);
            if (size != null && --size <= 0) {
                return;
            }
        }
        controller.close();
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFLLENBQUMsQ0FBQztZQUM1QixJQUFJLElBQUksSUFBSSxJQUFJLElBQUksRUFBRSxJQUFJLElBQUksQ0FBQyxFQUFFO2dCQUFFLE9BQU87YUFBRTtTQUMvQztRQUNELFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN2QixDQUFDO0FBQ0wsQ0FBQyIsImZpbGUiOiJpcGMvd2hhdHdnL2l0ZXJhYmxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IHRvVWludDhBcnJheSB9IGZyb20gJy4uLy4uL3V0aWwvYnVmZmVyJztcbmltcG9ydCB7IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyB9IGZyb20gJy4uLy4uL2lvL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgaXNJdGVyYWJsZSwgaXNBc3luY0l0ZXJhYmxlIH0gZnJvbSAnLi4vLi4vdXRpbC9jb21wYXQnO1xuaW1wb3J0IHsgcHJvdGVjdEFycmF5QnVmZmVyRnJvbVdoYXR3Z1JlZkltcGwgfSBmcm9tICcuL2hhY2snO1xuXG5leHBvcnQgZnVuY3Rpb24gdG9SZWFkYWJsZURPTVN0cmVhbTxUPihzb3VyY2U6IEl0ZXJhYmxlPFQ+IHwgQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlRE9NU3RyZWFtT3B0aW9ucyk6IFJlYWRhYmxlU3RyZWFtPFQ+IHtcbiAgICBpZiAoaXNBc3luY0l0ZXJhYmxlPFQ+KHNvdXJjZSkpIHsgcmV0dXJuIGFzeW5jSXRlcmFibGVBc1JlYWRhYmxlRE9NU3RyZWFtKHNvdXJjZSwgb3B0aW9ucyk7IH1cbiAgICBpZiAoaXNJdGVyYWJsZTxUPihzb3VyY2UpKSB7IHJldHVybiBpdGVyYWJsZUFzUmVhZGFibGVET01TdHJlYW0oc291cmNlLCBvcHRpb25zKTsgfVxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgdGhyb3cgbmV3IEVycm9yKGB0b1JlYWRhYmxlRE9NU3RyZWFtKCkgbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBJdGVyYWJsZSBvciBBc3luY0l0ZXJhYmxlYCk7XG59XG5cbmZ1bmN0aW9uIGl0ZXJhYmxlQXNSZWFkYWJsZURPTVN0cmVhbTxUPihzb3VyY2U6IEl0ZXJhYmxlPFQ+LCBvcHRpb25zPzogUmVhZGFibGVET01TdHJlYW1PcHRpb25zKSB7XG5cbiAgICBsZXQgaXQ6IEl0ZXJhdG9yPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgY29uc3QgYm0gPSAob3B0aW9ucyAmJiBvcHRpb25zLnR5cGUgPT09ICdieXRlcycpIHx8IGZhbHNlO1xuICAgIGNvbnN0IGh3bSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5oaWdoV2F0ZXJNYXJrIHx8ICgyICoqIDI0KTtcblxuICAgIHJldHVybiBuZXcgUmVhZGFibGVTdHJlYW08VD4oe1xuICAgICAgICAuLi5vcHRpb25zIGFzIGFueSxcbiAgICAgICAgc3RhcnQoY29udHJvbGxlcikgeyBuZXh0KGNvbnRyb2xsZXIsIGl0IHx8IChpdCA9IHNvdXJjZVtTeW1ib2wuaXRlcmF0b3JdKCkpKTsgfSxcbiAgICAgICAgcHVsbChjb250cm9sbGVyKSB7IGl0ID8gKG5leHQoY29udHJvbGxlciwgaXQpKSA6IGNvbnRyb2xsZXIuY2xvc2UoKTsgfSxcbiAgICAgICAgY2FuY2VsKCkgeyAoaXQgJiYgKGl0LnJldHVybiAmJiBpdC5yZXR1cm4oKSkgfHwgdHJ1ZSkgJiYgKGl0ID0gbnVsbCk7IH1cbiAgICB9LCB7IGhpZ2hXYXRlck1hcms6IGJtID8gaHdtIDogdW5kZWZpbmVkLCAuLi5vcHRpb25zIH0pO1xuXG4gICAgZnVuY3Rpb24gbmV4dChjb250cm9sbGVyOiBSZWFkYWJsZVN0cmVhbURlZmF1bHRDb250cm9sbGVyPFQ+LCBpdDogSXRlcmF0b3I8VD4pIHtcbiAgICAgICAgbGV0IGJ1ZjogVWludDhBcnJheTtcbiAgICAgICAgbGV0IHI6IEl0ZXJhdG9yUmVzdWx0PFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgICAgIGxldCBzaXplID0gY29udHJvbGxlci5kZXNpcmVkU2l6ZSB8fCBudWxsO1xuICAgICAgICB3aGlsZSAoIShyID0gaXQubmV4dChibSA/IHNpemUgOiBudWxsKSkuZG9uZSkge1xuICAgICAgICAgICAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhyLnZhbHVlKSAmJiAoYnVmID0gdG9VaW50OEFycmF5KHIudmFsdWUpKSkge1xuICAgICAgICAgICAgICAgIHNpemUgIT0gbnVsbCAmJiBibSAmJiAoc2l6ZSA9IHNpemUgLSBidWYuYnl0ZUxlbmd0aCArIDEpO1xuICAgICAgICAgICAgICAgIHIudmFsdWUgPSA8YW55PiBwcm90ZWN0QXJyYXlCdWZmZXJGcm9tV2hhdHdnUmVmSW1wbChidWYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKHIudmFsdWUpO1xuICAgICAgICAgICAgaWYgKHNpemUgIT0gbnVsbCAmJiAtLXNpemUgPD0gMCkgeyByZXR1cm47IH1cbiAgICAgICAgfVxuICAgICAgICBjb250cm9sbGVyLmNsb3NlKCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBhc3luY0l0ZXJhYmxlQXNSZWFkYWJsZURPTVN0cmVhbTxUPihzb3VyY2U6IEFzeW5jSXRlcmFibGU8VD4sIG9wdGlvbnM/OiBSZWFkYWJsZURPTVN0cmVhbU9wdGlvbnMpIHtcblxuICAgIGxldCBpdDogQXN5bmNJdGVyYXRvcjxUPiB8IG51bGwgPSBudWxsO1xuICAgIGNvbnN0IGJtID0gKG9wdGlvbnMgJiYgb3B0aW9ucy50eXBlID09PSAnYnl0ZXMnKSB8fCBmYWxzZTtcbiAgICBjb25zdCBod20gPSBvcHRpb25zICYmIG9wdGlvbnMuaGlnaFdhdGVyTWFyayB8fCAoMiAqKiAyNCk7XG5cbiAgICByZXR1cm4gbmV3IFJlYWRhYmxlU3RyZWFtPFQ+KHtcbiAgICAgICAgLi4ub3B0aW9ucyBhcyBhbnksXG4gICAgICAgIGFzeW5jIHN0YXJ0KGNvbnRyb2xsZXIpIHsgYXdhaXQgbmV4dChjb250cm9sbGVyLCBpdCB8fCAoaXQgPSBzb3VyY2VbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkpKTsgfSxcbiAgICAgICAgYXN5bmMgcHVsbChjb250cm9sbGVyKSB7IGl0ID8gKGF3YWl0IG5leHQoY29udHJvbGxlciwgaXQpKSA6IGNvbnRyb2xsZXIuY2xvc2UoKTsgfSxcbiAgICAgICAgYXN5bmMgY2FuY2VsKCkgeyAoaXQgJiYgKGl0LnJldHVybiAmJiBhd2FpdCBpdC5yZXR1cm4oKSkgfHwgdHJ1ZSkgJiYgKGl0ID0gbnVsbCk7IH0sXG4gICAgfSwgeyBoaWdoV2F0ZXJNYXJrOiBibSA/IGh3bSA6IHVuZGVmaW5lZCwgLi4ub3B0aW9ucyB9KTtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIG5leHQoY29udHJvbGxlcjogUmVhZGFibGVTdHJlYW1EZWZhdWx0Q29udHJvbGxlcjxUPiwgaXQ6IEFzeW5jSXRlcmF0b3I8VD4pIHtcbiAgICAgICAgbGV0IGJ1ZjogVWludDhBcnJheTtcbiAgICAgICAgbGV0IHI6IEl0ZXJhdG9yUmVzdWx0PFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgICAgIGxldCBzaXplID0gY29udHJvbGxlci5kZXNpcmVkU2l6ZSB8fCBudWxsO1xuICAgICAgICB3aGlsZSAoIShyID0gYXdhaXQgaXQubmV4dChibSA/IHNpemUgOiBudWxsKSkuZG9uZSkge1xuICAgICAgICAgICAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhyLnZhbHVlKSAmJiAoYnVmID0gdG9VaW50OEFycmF5KHIudmFsdWUpKSkge1xuICAgICAgICAgICAgICAgIHNpemUgIT0gbnVsbCAmJiBibSAmJiAoc2l6ZSA9IHNpemUgLSBidWYuYnl0ZUxlbmd0aCArIDEpO1xuICAgICAgICAgICAgICAgIHIudmFsdWUgPSA8YW55PiBwcm90ZWN0QXJyYXlCdWZmZXJGcm9tV2hhdHdnUmVmSW1wbChidWYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKHIudmFsdWUpO1xuICAgICAgICAgICAgaWYgKHNpemUgIT0gbnVsbCAmJiAtLXNpemUgPD0gMCkgeyByZXR1cm47IH1cbiAgICAgICAgfVxuICAgICAgICBjb250cm9sbGVyLmNsb3NlKCk7XG4gICAgfVxufVxuIl19
