"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const stream_1 = require("stream");
const compat_1 = require("../../util/compat");
/** @ignore */
function toNodeStream(source, options) {
    if (compat_1.isAsyncIterable(source)) {
        return new AsyncIterableReadable(source[Symbol.asyncIterator](), options);
    }
    if (compat_1.isIterable(source)) {
        return new IterableReadable(source[Symbol.iterator](), options);
    }
    /* istanbul ignore next */
    throw new Error(`toNodeStream() must be called with an Iterable or AsyncIterable`);
}
exports.toNodeStream = toNodeStream;
/** @ignore */
class IterableReadable extends stream_1.Readable {
    constructor(it, options) {
        super(options);
        this._iterator = it;
        this._pulling = false;
        this._bytesMode = !options || !options.objectMode;
    }
    _read(size) {
        const it = this._iterator;
        if (it && !this._pulling && (this._pulling = true)) {
            this._pulling = this._pull(size, it);
        }
    }
    _destroy(e, cb) {
        let it = this._iterator, fn;
        it && (fn = e != null && it.throw || it.return);
        fn && fn.call(it, e);
        cb && cb(null);
    }
    _pull(size, it) {
        const bm = this._bytesMode;
        let r = null;
        while (this.readable && !(r = it.next(bm ? size : null)).done) {
            if (size != null) {
                size -= (bm && ArrayBuffer.isView(r.value) ? r.value.byteLength : 1);
            }
            if (!this.push(r.value) || size <= 0) {
                break;
            }
        }
        if ((r && r.done || !this.readable) && (this.push(null) || true)) {
            it.return && it.return();
        }
        return !this.readable;
    }
}
/** @ignore */
class AsyncIterableReadable extends stream_1.Readable {
    constructor(it, options) {
        super(options);
        this._iterator = it;
        this._pulling = false;
        this._bytesMode = !options || !options.objectMode;
    }
    _read(size) {
        const it = this._iterator;
        if (it && !this._pulling && (this._pulling = true)) {
            (async () => this._pulling = await this._pull(size, it))();
        }
    }
    _destroy(e, cb) {
        let it = this._iterator, fn;
        it && (fn = e != null && it.throw || it.return);
        fn && fn.call(it, e).then(() => cb && cb(null)) || (cb && cb(null));
    }
    async _pull(size, it) {
        const bm = this._bytesMode;
        let r = null;
        while (this.readable && !(r = await it.next(bm ? size : null)).done) {
            if (size != null) {
                size -= (bm && ArrayBuffer.isView(r.value) ? r.value.byteLength : 1);
            }
            if (!this.push(r.value) || size <= 0) {
                break;
            }
        }
        if ((r && r.done || !this.readable) && (this.push(null) || true)) {
            it.return && it.return();
        }
        return !this.readable;
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImlwYy9ub2RlL2l0ZXJhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw2REFBNkQ7QUFDN0QsK0RBQStEO0FBQy9ELHdEQUF3RDtBQUN4RCw2REFBNkQ7QUFDN0Qsb0RBQW9EO0FBQ3BELDZEQUE2RDtBQUM3RCw2REFBNkQ7QUFDN0QsRUFBRTtBQUNGLCtDQUErQztBQUMvQyxFQUFFO0FBQ0YsNkRBQTZEO0FBQzdELDhEQUE4RDtBQUM5RCx5REFBeUQ7QUFDekQsNERBQTREO0FBQzVELDBEQUEwRDtBQUMxRCxxQkFBcUI7O0FBRXJCLG1DQUFrQztBQUNsQyw4Q0FBZ0U7QUFJaEUsY0FBYztBQUNkLFNBQWdCLFlBQVksQ0FBSSxNQUFzQyxFQUFFLE9BQXlCO0lBQzdGLElBQUksd0JBQWUsQ0FBSSxNQUFNLENBQUMsRUFBRTtRQUFFLE9BQU8sSUFBSSxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FBRTtJQUM5RyxJQUFJLG1CQUFVLENBQUksTUFBTSxDQUFDLEVBQUU7UUFBRSxPQUFPLElBQUksZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQUU7SUFDL0YsMEJBQTBCO0lBQzFCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUVBQWlFLENBQUMsQ0FBQztBQUN2RixDQUFDO0FBTEQsb0NBS0M7QUFFRCxjQUFjO0FBQ2QsTUFBTSxnQkFBNkMsU0FBUSxpQkFBUTtJQUkvRCxZQUFZLEVBQWUsRUFBRSxPQUF5QjtRQUNsRCxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDZixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztJQUN0RCxDQUFDO0lBQ0QsS0FBSyxDQUFDLElBQVk7UUFDZCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzFCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEVBQUU7WUFDaEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztTQUN4QztJQUNMLENBQUM7SUFDRCxRQUFRLENBQUMsQ0FBZSxFQUFFLEVBQTZCO1FBQ25ELElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBTyxDQUFDO1FBQ2pDLEVBQUUsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLElBQUksSUFBSSxJQUFJLEVBQUUsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2hELEVBQUUsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyQixFQUFFLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFDTyxLQUFLLENBQUMsSUFBWSxFQUFFLEVBQWU7UUFDdkMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUMzQixJQUFJLENBQUMsR0FBNkIsSUFBSSxDQUFDO1FBQ3ZDLE9BQU8sSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQzNELElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtnQkFDZCxJQUFJLElBQUksQ0FBQyxFQUFFLElBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUN4RTtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxFQUFFO2dCQUFFLE1BQU07YUFBRTtTQUNuRDtRQUNELElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUU7WUFDOUQsRUFBRSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDNUI7UUFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUMxQixDQUFDO0NBQ0o7QUFFRCxjQUFjO0FBQ2QsTUFBTSxxQkFBa0QsU0FBUSxpQkFBUTtJQUlwRSxZQUFZLEVBQW9CLEVBQUUsT0FBeUI7UUFDdkQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7SUFDdEQsQ0FBQztJQUNELEtBQUssQ0FBQyxJQUFZO1FBQ2QsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUMxQixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxFQUFFO1lBQ2hELENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO1NBQzlEO0lBQ0wsQ0FBQztJQUNELFFBQVEsQ0FBQyxDQUFlLEVBQUUsRUFBNkI7UUFDbkQsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFPLENBQUM7UUFDakMsRUFBRSxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDaEQsRUFBRSxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUNPLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBWSxFQUFFLEVBQW9CO1FBQ2xELE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDM0IsSUFBSSxDQUFDLEdBQTZCLElBQUksQ0FBQztRQUN2QyxPQUFPLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ2pFLElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtnQkFDZCxJQUFJLElBQUksQ0FBQyxFQUFFLElBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUN4RTtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxFQUFFO2dCQUFFLE1BQU07YUFBRTtTQUNuRDtRQUNELElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUU7WUFDOUQsRUFBRSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDNUI7UUFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUMxQixDQUFDO0NBQ0oiLCJmaWxlIjoiaXBjL25vZGUvaXRlcmFibGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgUmVhZGFibGUgfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgaXNJdGVyYWJsZSwgaXNBc3luY0l0ZXJhYmxlIH0gZnJvbSAnLi4vLi4vdXRpbC9jb21wYXQnO1xuXG50eXBlIFJlYWRhYmxlT3B0aW9ucyA9IGltcG9ydCgnc3RyZWFtJykuUmVhZGFibGVPcHRpb25zO1xuXG4vKiogQGlnbm9yZSAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRvTm9kZVN0cmVhbTxUPihzb3VyY2U6IEl0ZXJhYmxlPFQ+IHwgQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlT3B0aW9ucyk6IFJlYWRhYmxlIHtcbiAgICBpZiAoaXNBc3luY0l0ZXJhYmxlPFQ+KHNvdXJjZSkpIHsgcmV0dXJuIG5ldyBBc3luY0l0ZXJhYmxlUmVhZGFibGUoc291cmNlW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpLCBvcHRpb25zKTsgfVxuICAgIGlmIChpc0l0ZXJhYmxlPFQ+KHNvdXJjZSkpIHsgcmV0dXJuIG5ldyBJdGVyYWJsZVJlYWRhYmxlKHNvdXJjZVtTeW1ib2wuaXRlcmF0b3JdKCksIG9wdGlvbnMpOyB9XG4gICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICB0aHJvdyBuZXcgRXJyb3IoYHRvTm9kZVN0cmVhbSgpIG11c3QgYmUgY2FsbGVkIHdpdGggYW4gSXRlcmFibGUgb3IgQXN5bmNJdGVyYWJsZWApO1xufVxuXG4vKiogQGlnbm9yZSAqL1xuY2xhc3MgSXRlcmFibGVSZWFkYWJsZTxUIGV4dGVuZHMgVWludDhBcnJheSB8IGFueT4gZXh0ZW5kcyBSZWFkYWJsZSB7XG4gICAgcHJpdmF0ZSBfcHVsbGluZzogYm9vbGVhbjtcbiAgICBwcml2YXRlIF9ieXRlc01vZGU6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfaXRlcmF0b3I6IEl0ZXJhdG9yPFQ+O1xuICAgIGNvbnN0cnVjdG9yKGl0OiBJdGVyYXRvcjxUPiwgb3B0aW9ucz86IFJlYWRhYmxlT3B0aW9ucykge1xuICAgICAgICBzdXBlcihvcHRpb25zKTtcbiAgICAgICAgdGhpcy5faXRlcmF0b3IgPSBpdDtcbiAgICAgICAgdGhpcy5fcHVsbGluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9ieXRlc01vZGUgPSAhb3B0aW9ucyB8fCAhb3B0aW9ucy5vYmplY3RNb2RlO1xuICAgIH1cbiAgICBfcmVhZChzaXplOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgaXQgPSB0aGlzLl9pdGVyYXRvcjtcbiAgICAgICAgaWYgKGl0ICYmICF0aGlzLl9wdWxsaW5nICYmICh0aGlzLl9wdWxsaW5nID0gdHJ1ZSkpIHtcbiAgICAgICAgICAgIHRoaXMuX3B1bGxpbmcgPSB0aGlzLl9wdWxsKHNpemUsIGl0KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBfZGVzdHJveShlOiBFcnJvciB8IG51bGwsIGNiOiAoZTogRXJyb3IgfCBudWxsKSA9PiB2b2lkKSB7XG4gICAgICAgIGxldCBpdCA9IHRoaXMuX2l0ZXJhdG9yLCBmbjogYW55O1xuICAgICAgICBpdCAmJiAoZm4gPSBlICE9IG51bGwgJiYgaXQudGhyb3cgfHwgaXQucmV0dXJuKTtcbiAgICAgICAgZm4gJiYgZm4uY2FsbChpdCwgZSk7XG4gICAgICAgIGNiICYmIGNiKG51bGwpO1xuICAgIH1cbiAgICBwcml2YXRlIF9wdWxsKHNpemU6IG51bWJlciwgaXQ6IEl0ZXJhdG9yPFQ+KSB7XG4gICAgICAgIGNvbnN0IGJtID0gdGhpcy5fYnl0ZXNNb2RlO1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8VD4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgd2hpbGUgKHRoaXMucmVhZGFibGUgJiYgIShyID0gaXQubmV4dChibSA/IHNpemUgOiBudWxsKSkuZG9uZSkge1xuICAgICAgICAgICAgaWYgKHNpemUgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHNpemUgLT0gKGJtICYmIEFycmF5QnVmZmVyLmlzVmlldyhyLnZhbHVlKSA/IHIudmFsdWUuYnl0ZUxlbmd0aCA6IDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF0aGlzLnB1c2goci52YWx1ZSkgfHwgc2l6ZSA8PSAwKSB7IGJyZWFrOyB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKChyICYmIHIuZG9uZSB8fCAhdGhpcy5yZWFkYWJsZSkgJiYgKHRoaXMucHVzaChudWxsKSB8fCB0cnVlKSkge1xuICAgICAgICAgICAgaXQucmV0dXJuICYmIGl0LnJldHVybigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAhdGhpcy5yZWFkYWJsZTtcbiAgICB9XG59XG5cbi8qKiBAaWdub3JlICovXG5jbGFzcyBBc3luY0l0ZXJhYmxlUmVhZGFibGU8VCBleHRlbmRzIFVpbnQ4QXJyYXkgfCBhbnk+IGV4dGVuZHMgUmVhZGFibGUge1xuICAgIHByaXZhdGUgX3B1bGxpbmc6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfYnl0ZXNNb2RlOiBib29sZWFuO1xuICAgIHByaXZhdGUgX2l0ZXJhdG9yOiBBc3luY0l0ZXJhdG9yPFQ+O1xuICAgIGNvbnN0cnVjdG9yKGl0OiBBc3luY0l0ZXJhdG9yPFQ+LCBvcHRpb25zPzogUmVhZGFibGVPcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKG9wdGlvbnMpO1xuICAgICAgICB0aGlzLl9pdGVyYXRvciA9IGl0O1xuICAgICAgICB0aGlzLl9wdWxsaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2J5dGVzTW9kZSA9ICFvcHRpb25zIHx8ICFvcHRpb25zLm9iamVjdE1vZGU7XG4gICAgfVxuICAgIF9yZWFkKHNpemU6IG51bWJlcikge1xuICAgICAgICBjb25zdCBpdCA9IHRoaXMuX2l0ZXJhdG9yO1xuICAgICAgICBpZiAoaXQgJiYgIXRoaXMuX3B1bGxpbmcgJiYgKHRoaXMuX3B1bGxpbmcgPSB0cnVlKSkge1xuICAgICAgICAgICAgKGFzeW5jICgpID0+IHRoaXMuX3B1bGxpbmcgPSBhd2FpdCB0aGlzLl9wdWxsKHNpemUsIGl0KSkoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBfZGVzdHJveShlOiBFcnJvciB8IG51bGwsIGNiOiAoZTogRXJyb3IgfCBudWxsKSA9PiB2b2lkKSB7XG4gICAgICAgIGxldCBpdCA9IHRoaXMuX2l0ZXJhdG9yLCBmbjogYW55O1xuICAgICAgICBpdCAmJiAoZm4gPSBlICE9IG51bGwgJiYgaXQudGhyb3cgfHwgaXQucmV0dXJuKTtcbiAgICAgICAgZm4gJiYgZm4uY2FsbChpdCwgZSkudGhlbigoKSA9PiBjYiAmJiBjYihudWxsKSkgfHwgKGNiICYmIGNiKG51bGwpKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBhc3luYyBfcHVsbChzaXplOiBudW1iZXIsIGl0OiBBc3luY0l0ZXJhdG9yPFQ+KSB7XG4gICAgICAgIGNvbnN0IGJtID0gdGhpcy5fYnl0ZXNNb2RlO1xuICAgICAgICBsZXQgcjogSXRlcmF0b3JSZXN1bHQ8VD4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgd2hpbGUgKHRoaXMucmVhZGFibGUgJiYgIShyID0gYXdhaXQgaXQubmV4dChibSA/IHNpemUgOiBudWxsKSkuZG9uZSkge1xuICAgICAgICAgICAgaWYgKHNpemUgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHNpemUgLT0gKGJtICYmIEFycmF5QnVmZmVyLmlzVmlldyhyLnZhbHVlKSA/IHIudmFsdWUuYnl0ZUxlbmd0aCA6IDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF0aGlzLnB1c2goci52YWx1ZSkgfHwgc2l6ZSA8PSAwKSB7IGJyZWFrOyB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKChyICYmIHIuZG9uZSB8fCAhdGhpcy5yZWFkYWJsZSkgJiYgKHRoaXMucHVzaChudWxsKSB8fCB0cnVlKSkge1xuICAgICAgICAgICAgaXQucmV0dXJuICYmIGl0LnJldHVybigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAhdGhpcy5yZWFkYWJsZTtcbiAgICB9XG59XG4iXX0=
