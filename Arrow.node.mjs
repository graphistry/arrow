// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import { Duplex, Readable } from 'stream';
import streamAdapters from './io/adapters';
import { RecordBatchReader } from './ipc/reader';
import { RecordBatchWriter } from './ipc/writer';
import { isIterable, isAsyncIterable } from './util/compat';
import { AsyncByteStream, AsyncByteQueue } from './io/stream';
streamAdapters.toReadableNodeStream = toReadableNodeStream;
RecordBatchReader['throughNode'] = recordBatchReaderThroughNodeStream;
RecordBatchWriter['throughNode'] = recordBatchWriterThroughNodeStream;
export * from './Arrow.dom';
function recordBatchReaderThroughNodeStream() {
    let reading = false;
    let reader = null;
    let through = new AsyncByteQueue();
    return new Duplex({
        allowHalfOpen: false,
        readableObjectMode: true,
        writableObjectMode: false,
        final(cb) { through && through.close(); cb(); },
        write(x, _, cb) { through && through.write(x); cb(); },
        read(size) {
            through && (reading || (reading = !!(async () => await next(this, size, reader || (reader = await open(through))))()));
        },
        destroy(err, cb) {
            reading = true;
            through && (err ? through.abort(err) : through.close());
            cb(reader = through = null);
        }
    });
    async function open(queue) {
        return await (await RecordBatchReader.from(queue)).open();
    }
    async function next(sink, size, reader) {
        let r = null;
        while (sink.readable && !(r = await reader.next()).done) {
            if (!sink.push(r.value) || (size != null && --size <= 0)) {
                return reading = false;
            }
        }
        sink.push(null);
        await reader.cancel();
    }
}
function recordBatchWriterThroughNodeStream() {
    let reading = false;
    let through = new AsyncByteQueue();
    let reader = new AsyncByteStream(through);
    let writer = new this().reset(through);
    return new Duplex({
        allowHalfOpen: false,
        writableObjectMode: true,
        readableObjectMode: false,
        final(cb) { writer && writer.close(); cb(); },
        write(x, _, cb) { writer && writer.write(x); cb(); },
        read(size) {
            reader && (reading || (reading = !!(async () => await next(this, size, reader))()));
        },
        destroy(err, cb) {
            reading = true;
            writer && (err ? writer.abort(err) : writer.close());
            cb(through = reader = writer = null);
        }
    });
    async function next(sink, size, reader) {
        let buf = null;
        while (sink.readable && (buf = await reader.read())) {
            if (!sink.push(buf) || (size != null && (size -= buf.byteLength) <= 0)) {
                return reading = false;
            }
        }
        sink.push(null);
        await reader.cancel();
    }
}
function toReadableNodeStream(source, options) {
    if (isAsyncIterable(source)) {
        return asyncIterableAsReadableNodeStream(source, options);
    }
    if (isIterable(source)) {
        return iterableAsReadableNodeStream(source, options);
    }
    throw new Error(`toReadableNodeStream() must be called with an Iterable or AsyncIterable`);
}
function iterableAsReadableNodeStream(source, options) {
    let it, reading = false;
    return new Readable({
        ...options,
        read(size) {
            !reading && (reading = true) &&
                next(this, size, (it || (it = source[Symbol.iterator]())));
        },
        destroy(e, cb) {
            if ((reading = true) && it || Boolean(cb(null))) {
                let fn = e == null ? it.return : it.throw;
                (fn && fn.call(it, e) || true) && cb(null);
            }
        },
    });
    function next(sink, size, it) {
        let r = null;
        while (sink.readable && (size == null || size-- > 0) && !(r = it.next()).done) {
            if (!sink.push(r.value)) {
                return reading = false;
            }
        }
        if (((r && r.done) || !sink.readable) && (reading = sink.push(null) || true)) {
            it.return && it.return();
        }
    }
}
function asyncIterableAsReadableNodeStream(source, options) {
    let it, reading = false;
    return new Readable({
        ...options,
        read(size) {
            reading || (reading = !!(async () => (await next(this, size, (it || (it = source[Symbol.asyncIterator]())))))());
        },
        destroy(e, cb) {
            if ((reading = true) && it || Boolean(cb(null))) {
                (async (fn) => {
                    (fn && await fn.call(it, e) || true) && cb(null);
                })(e == null ? it.return : it.throw);
            }
        },
    });
    async function next(sink, size, it) {
        let r = null;
        while (sink.readable && (size == null || size-- > 0) && !(r = await it.next()).done) {
            if (!sink.push(r.value)) {
                return reading = false;
            }
        }
        if (((r && r.done) || !sink.readable) && (reading = sink.push(null) || true)) {
            it.return && await it.return();
        }
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RUFBRTtZQUMxRSxFQUFFLENBQUMsTUFBTSxJQUFJLE1BQU0sRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2xDO0lBQ0wsQ0FBQztBQUNMLENBQUMiLCJmaWxlIjoiQXJyb3cubm9kZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBEYXRhVHlwZSB9IGZyb20gJy4vdHlwZSc7XG5pbXBvcnQgeyBEdXBsZXgsIFJlYWRhYmxlIH0gZnJvbSAnc3RyZWFtJztcbmltcG9ydCBzdHJlYW1BZGFwdGVycyBmcm9tICcuL2lvL2FkYXB0ZXJzJztcbmltcG9ydCB7IFJlY29yZEJhdGNoUmVhZGVyIH0gZnJvbSAnLi9pcGMvcmVhZGVyJztcbmltcG9ydCB7IFJlY29yZEJhdGNoV3JpdGVyIH0gZnJvbSAnLi9pcGMvd3JpdGVyJztcbmltcG9ydCB7IGlzSXRlcmFibGUsIGlzQXN5bmNJdGVyYWJsZSB9IGZyb20gJy4vdXRpbC9jb21wYXQnO1xuaW1wb3J0IHsgQXN5bmNCeXRlU3RyZWFtLCBBc3luY0J5dGVRdWV1ZSB9IGZyb20gJy4vaW8vc3RyZWFtJztcbmltcG9ydCB7IFJlY29yZEJhdGNoIH0gZnJvbSAnLi9yZWNvcmRiYXRjaCc7XG5cbnR5cGUgUmVhZGFibGVPcHRpb25zID0gaW1wb3J0KCdzdHJlYW0nKS5SZWFkYWJsZU9wdGlvbnM7XG5cbnN0cmVhbUFkYXB0ZXJzLnRvUmVhZGFibGVOb2RlU3RyZWFtID0gdG9SZWFkYWJsZU5vZGVTdHJlYW07XG5SZWNvcmRCYXRjaFJlYWRlclsndGhyb3VnaE5vZGUnXSA9IHJlY29yZEJhdGNoUmVhZGVyVGhyb3VnaE5vZGVTdHJlYW07XG5SZWNvcmRCYXRjaFdyaXRlclsndGhyb3VnaE5vZGUnXSA9IHJlY29yZEJhdGNoV3JpdGVyVGhyb3VnaE5vZGVTdHJlYW07XG5cbmV4cG9ydCAqIGZyb20gJy4vQXJyb3cuZG9tJztcblxuZnVuY3Rpb24gcmVjb3JkQmF0Y2hSZWFkZXJUaHJvdWdoTm9kZVN0cmVhbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55PigpIHtcblxuICAgIGxldCByZWFkaW5nID0gZmFsc2U7XG4gICAgbGV0IHJlYWRlcjogUmVjb3JkQmF0Y2hSZWFkZXI8VD4gfCBudWxsID0gbnVsbDtcbiAgICBsZXQgdGhyb3VnaCA9IG5ldyBBc3luY0J5dGVRdWV1ZSgpIGFzIEFzeW5jQnl0ZVF1ZXVlIHwgbnVsbDtcblxuICAgIHJldHVybiBuZXcgRHVwbGV4KHtcbiAgICAgICAgYWxsb3dIYWxmT3BlbjogZmFsc2UsXG4gICAgICAgIHJlYWRhYmxlT2JqZWN0TW9kZTogdHJ1ZSxcbiAgICAgICAgd3JpdGFibGVPYmplY3RNb2RlOiBmYWxzZSxcbiAgICAgICAgZmluYWwoY2IpIHsgdGhyb3VnaCAmJiB0aHJvdWdoLmNsb3NlKCk7IGNiKCk7IH0sXG4gICAgICAgIHdyaXRlKHgsIF8sIGNiKSB7IHRocm91Z2ggJiYgdGhyb3VnaC53cml0ZSh4KTsgY2IoKTsgfSxcbiAgICAgICAgcmVhZChzaXplOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgICAgIHRocm91Z2ggJiYgKHJlYWRpbmcgfHwgKHJlYWRpbmcgPSAhIShhc3luYyAoKSA9PlxuICAgICAgICAgICAgICAgIGF3YWl0IG5leHQodGhpcywgc2l6ZSwgcmVhZGVyIHx8IChyZWFkZXIgPSBhd2FpdCBvcGVuKHRocm91Z2gpKSlcbiAgICAgICAgICAgICkoKSkpO1xuICAgICAgICB9LFxuICAgICAgICBkZXN0cm95KGVyciwgY2IpIHtcbiAgICAgICAgICAgIHJlYWRpbmcgPSB0cnVlO1xuICAgICAgICAgICAgdGhyb3VnaCAmJiAoZXJyID8gdGhyb3VnaC5hYm9ydChlcnIpIDogdGhyb3VnaC5jbG9zZSgpKTtcbiAgICAgICAgICAgIGNiKHJlYWRlciA9IHRocm91Z2ggPSBudWxsKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gb3BlbihxdWV1ZTogQXN5bmNCeXRlUXVldWUpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IChhd2FpdCBSZWNvcmRCYXRjaFJlYWRlci5mcm9tKHF1ZXVlKSkub3BlbigpO1xuICAgIH1cblxuICAgIGFzeW5jIGZ1bmN0aW9uIG5leHQoc2luazogUmVhZGFibGUsIHNpemU6IG51bWJlciwgcmVhZGVyOiBSZWNvcmRCYXRjaFJlYWRlcjxUPik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGxldCByOiBJdGVyYXRvclJlc3VsdDxSZWNvcmRCYXRjaDxUPj4gfCBudWxsID0gbnVsbDtcbiAgICAgICAgd2hpbGUgKHNpbmsucmVhZGFibGUgJiYgIShyID0gYXdhaXQgcmVhZGVyLm5leHQoKSkuZG9uZSkge1xuICAgICAgICAgICAgaWYgKCFzaW5rLnB1c2goci52YWx1ZSkgfHwgKHNpemUgIT0gbnVsbCAmJiAtLXNpemUgPD0gMCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVhZGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHNpbmsucHVzaChudWxsKTtcbiAgICAgICAgYXdhaXQgcmVhZGVyLmNhbmNlbCgpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcmVjb3JkQmF0Y2hXcml0ZXJUaHJvdWdoTm9kZVN0cmVhbTxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9ID0gYW55Pih0aGlzOiB0eXBlb2YgUmVjb3JkQmF0Y2hXcml0ZXIpIHtcblxuICAgIGxldCByZWFkaW5nID0gZmFsc2U7XG4gICAgbGV0IHRocm91Z2g6IEFzeW5jQnl0ZVF1ZXVlIHwgbnVsbCA9IG5ldyBBc3luY0J5dGVRdWV1ZSgpO1xuICAgIGxldCByZWFkZXI6IEFzeW5jQnl0ZVN0cmVhbSB8IG51bGwgPSBuZXcgQXN5bmNCeXRlU3RyZWFtKHRocm91Z2gpO1xuICAgIGxldCB3cml0ZXI6IFJlY29yZEJhdGNoV3JpdGVyPFQ+IHwgbnVsbCA9IG5ldyB0aGlzPFQ+KCkucmVzZXQodGhyb3VnaCk7XG5cbiAgICByZXR1cm4gbmV3IER1cGxleCh7XG4gICAgICAgIGFsbG93SGFsZk9wZW46IGZhbHNlLFxuICAgICAgICB3cml0YWJsZU9iamVjdE1vZGU6IHRydWUsXG4gICAgICAgIHJlYWRhYmxlT2JqZWN0TW9kZTogZmFsc2UsXG4gICAgICAgIGZpbmFsKGNiKSB7IHdyaXRlciAmJiB3cml0ZXIuY2xvc2UoKTsgY2IoKTsgfSxcbiAgICAgICAgd3JpdGUoeCwgXywgY2IpIHsgd3JpdGVyICYmIHdyaXRlci53cml0ZSh4KTsgY2IoKTsgfSxcbiAgICAgICAgcmVhZChzaXplOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgICAgIHJlYWRlciAmJiAocmVhZGluZyB8fCAocmVhZGluZyA9ICEhKGFzeW5jICgpID0+XG4gICAgICAgICAgICAgICAgYXdhaXQgbmV4dCh0aGlzLCBzaXplLCByZWFkZXIpXG4gICAgICAgICAgICApKCkpKTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVzdHJveShlcnIsIGNiKSB7XG4gICAgICAgICAgICByZWFkaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIHdyaXRlciAmJiAoZXJyID8gd3JpdGVyLmFib3J0KGVycikgOiB3cml0ZXIuY2xvc2UoKSk7XG4gICAgICAgICAgICBjYih0aHJvdWdoID0gcmVhZGVyID0gd3JpdGVyID0gbnVsbCk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIG5leHQoc2luazogUmVhZGFibGUsIHNpemU6IG51bWJlciwgcmVhZGVyOiBBc3luY0J5dGVTdHJlYW0pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBsZXQgYnVmOiBVaW50OEFycmF5IHwgbnVsbCA9IG51bGw7XG4gICAgICAgIHdoaWxlIChzaW5rLnJlYWRhYmxlICYmIChidWYgPSBhd2FpdCByZWFkZXIucmVhZCgpKSkge1xuICAgICAgICAgICAgaWYgKCFzaW5rLnB1c2goYnVmKSB8fCAoc2l6ZSAhPSBudWxsICYmIChzaXplIC09IGJ1Zi5ieXRlTGVuZ3RoKSA8PSAwKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZWFkaW5nID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgc2luay5wdXNoKG51bGwpO1xuICAgICAgICBhd2FpdCByZWFkZXIuY2FuY2VsKCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiB0b1JlYWRhYmxlTm9kZVN0cmVhbTxUPihzb3VyY2U6IEl0ZXJhYmxlPFQ+IHwgQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlT3B0aW9ucyk6IFJlYWRhYmxlIHtcbiAgICBpZiAoaXNBc3luY0l0ZXJhYmxlPFQ+KHNvdXJjZSkpIHsgcmV0dXJuIGFzeW5jSXRlcmFibGVBc1JlYWRhYmxlTm9kZVN0cmVhbShzb3VyY2UsIG9wdGlvbnMpOyB9XG4gICAgaWYgKGlzSXRlcmFibGU8VD4oc291cmNlKSkgeyByZXR1cm4gaXRlcmFibGVBc1JlYWRhYmxlTm9kZVN0cmVhbShzb3VyY2UsIG9wdGlvbnMpOyB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGB0b1JlYWRhYmxlTm9kZVN0cmVhbSgpIG11c3QgYmUgY2FsbGVkIHdpdGggYW4gSXRlcmFibGUgb3IgQXN5bmNJdGVyYWJsZWApO1xufVxuXG5mdW5jdGlvbiBpdGVyYWJsZUFzUmVhZGFibGVOb2RlU3RyZWFtPFQ+KHNvdXJjZTogSXRlcmFibGU8VD4sIG9wdGlvbnM/OiBSZWFkYWJsZU9wdGlvbnMpIHtcbiAgICBsZXQgaXQ6IEl0ZXJhdG9yPFQ+LCByZWFkaW5nID0gZmFsc2U7XG4gICAgcmV0dXJuIG5ldyBSZWFkYWJsZSh7XG4gICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgIHJlYWQoc2l6ZTogbnVtYmVyKSB7XG4gICAgICAgICAgICAhcmVhZGluZyAmJiAocmVhZGluZyA9IHRydWUpICYmXG4gICAgICAgICAgICAgICAgbmV4dCh0aGlzLCBzaXplLCAoaXQgfHwgKGl0ID0gc291cmNlW1N5bWJvbC5pdGVyYXRvcl0oKSkpKTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVzdHJveShlOiBFcnJvciB8IG51bGwsIGNiOiAoZTogRXJyb3IgfCBudWxsKSA9PiB2b2lkKSB7XG4gICAgICAgICAgICBpZiAoKHJlYWRpbmcgPSB0cnVlKSAmJiBpdCB8fCBCb29sZWFuKGNiKG51bGwpKSkge1xuICAgICAgICAgICAgICAgIGxldCBmbiA9IGUgPT0gbnVsbCA/IGl0LnJldHVybiA6IGl0LnRocm93O1xuICAgICAgICAgICAgICAgIChmbiAmJiBmbi5jYWxsKGl0LCBlKSB8fCB0cnVlKSAmJiBjYihudWxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICB9KTtcbiAgICBmdW5jdGlvbiBuZXh0KHNpbms6IFJlYWRhYmxlLCBzaXplOiBudW1iZXIsIGl0OiBJdGVyYXRvcjxUPik6IGFueSB7XG4gICAgICAgIGxldCByOiBJdGVyYXRvclJlc3VsdDxUPiB8IG51bGwgPSBudWxsO1xuICAgICAgICB3aGlsZSAoc2luay5yZWFkYWJsZSAmJiAoc2l6ZSA9PSBudWxsIHx8IHNpemUtLSA+IDApICYmICEociA9IGl0Lm5leHQoKSkuZG9uZSkge1xuICAgICAgICAgICAgaWYgKCFzaW5rLnB1c2goci52YWx1ZSkpIHsgcmV0dXJuIHJlYWRpbmcgPSBmYWxzZTsgfVxuICAgICAgICB9XG4gICAgICAgIGlmICgoKHIgJiYgci5kb25lKSB8fCAhc2luay5yZWFkYWJsZSkgJiYgKHJlYWRpbmcgPSBzaW5rLnB1c2gobnVsbCkgfHwgdHJ1ZSkpIHtcbiAgICAgICAgICAgIGl0LnJldHVybiAmJiBpdC5yZXR1cm4oKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gYXN5bmNJdGVyYWJsZUFzUmVhZGFibGVOb2RlU3RyZWFtPFQ+KHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUPiwgb3B0aW9ucz86IFJlYWRhYmxlT3B0aW9ucykge1xuICAgIGxldCBpdDogQXN5bmNJdGVyYXRvcjxUPiwgcmVhZGluZyA9IGZhbHNlO1xuICAgIHJldHVybiBuZXcgUmVhZGFibGUoe1xuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICByZWFkKHNpemU6IG51bWJlcikge1xuICAgICAgICAgICAgcmVhZGluZyB8fCAocmVhZGluZyA9ICEhKGFzeW5jICgpID0+IChcbiAgICAgICAgICAgICAgICBhd2FpdCBuZXh0KHRoaXMsIHNpemUsIChpdCB8fCAoaXQgPSBzb3VyY2VbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkpKSlcbiAgICAgICAgICAgICkpKCkpO1xuICAgICAgICB9LFxuICAgICAgICBkZXN0cm95KGU6IEVycm9yIHwgbnVsbCwgY2I6IChlOiBFcnJvciB8IG51bGwpID0+IHZvaWQpIHtcbiAgICAgICAgICAgIGlmICgocmVhZGluZyA9IHRydWUpICYmIGl0IHx8IEJvb2xlYW4oY2IobnVsbCkpKSB7XG4gICAgICAgICAgICAgICAgKGFzeW5jIChmbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAoZm4gJiYgYXdhaXQgZm4uY2FsbChpdCwgZSkgfHwgdHJ1ZSkgJiYgY2IobnVsbClcbiAgICAgICAgICAgICAgICB9KShlID09IG51bGwgPyBpdC5yZXR1cm4gOiBpdC50aHJvdyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgfSk7XG4gICAgYXN5bmMgZnVuY3Rpb24gbmV4dChzaW5rOiBSZWFkYWJsZSwgc2l6ZTogbnVtYmVyLCBpdDogQXN5bmNJdGVyYXRvcjxUPik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGxldCByOiBJdGVyYXRvclJlc3VsdDxUPiB8IG51bGwgPSBudWxsO1xuICAgICAgICB3aGlsZSAoc2luay5yZWFkYWJsZSAmJiAoc2l6ZSA9PSBudWxsIHx8IHNpemUtLSA+IDApICYmICEociA9IGF3YWl0IGl0Lm5leHQoKSkuZG9uZSkge1xuICAgICAgICAgICAgaWYgKCFzaW5rLnB1c2goci52YWx1ZSkpIHsgcmV0dXJuIHJlYWRpbmcgPSBmYWxzZTsgfVxuICAgICAgICB9XG4gICAgICAgIGlmICgoKHIgJiYgci5kb25lKSB8fCAhc2luay5yZWFkYWJsZSkgJiYgKHJlYWRpbmcgPSBzaW5rLnB1c2gobnVsbCkgfHwgdHJ1ZSkpIHtcbiAgICAgICAgICAgIGl0LnJldHVybiAmJiBhd2FpdCBpdC5yZXR1cm4oKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==
