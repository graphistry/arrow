#! /usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const fs = require("fs");
const stream = require("stream");
const pretty_1 = require("../util/pretty");
const Arrow_node_1 = require("../Arrow.node");
const padLeft = require('pad-left');
const bignumJSONParse = require('json-bignum').parse;
const eos = require('util').promisify(stream.finished);
const argv = require(`command-line-args`)(cliOpts(), { partial: true });
const files = argv.help ? [] : [...(argv.file || []), ...(argv._unknown || [])].filter(Boolean);
const state = Object.assign({}, argv, { closed: false, hasRecords: false });
process.stdout.once('error', ({ code }) => (code === 'EPIPE') && (state.closed = true));
(() => tslib_1.__awaiter(this, void 0, void 0, function* () {
    const sources = argv.help ? [] : [
        ...files.map((file) => () => fs.createReadStream(file)),
        ...(process.stdin.isTTY ? [] : [() => process.stdin])
    ].filter(Boolean);
    let reader;
    for (const source of sources) {
        if (state.closed) {
            break;
        }
        if (reader = yield createRecordBatchReader(source)) {
            yield eos(reader
                .pipe(recordBatchRowsToString(state))
                .on('data', (x) => process.stdout.write(x)));
        }
    }
    return state.hasRecords ? 0 : print_usage();
}))()
    .then((x) => +x || 0, (err) => {
    if (err) {
        console.error(`${err && err.stack || err}`);
    }
    return process.exitCode || 1;
}).then((code) => process.exit(code));
function createRecordBatchReader(createSourceStream) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        let source = createSourceStream();
        let byteQueue = new Arrow_node_1.AsyncByteQueue();
        let reader = null;
        source.on('end', byteQueue.close.bind(byteQueue))
            .on('data', byteQueue.write.bind(byteQueue));
        try {
            reader = yield (yield Arrow_node_1.RecordBatchReader.from(source)).open();
        }
        catch (e) {
            reader = null;
        }
        if (!reader || reader.closed) {
            reader = null;
            yield byteQueue.closed;
            if (source instanceof fs.ReadStream) {
                source.close();
            }
            try {
                let json = bignumJSONParse(yield byteQueue.toString());
                reader = yield (yield Arrow_node_1.RecordBatchReader.from(json)).open();
            }
            catch (e) {
                reader = null;
            }
        }
        return (reader && !reader.closed) ? reader : null;
    });
}
function recordBatchRowsToString(state) {
    let rowId = 0, maxColWidths = [15], separator = `${state.separator || ' |'} `;
    return new stream.Transform({ transform, encoding: 'utf8', writableObjectMode: true, readableObjectMode: false });
    function transform(batch, _enc, cb) {
        batch = !(state.schema && state.schema.length) ? batch : batch.select(...state.schema);
        if (batch.length <= 0 || batch.numCols <= 0 || state.closed) {
            state.hasRecords || (state.hasRecords = false);
            return cb(undefined, null);
        }
        state.hasRecords = true;
        const header = ['row_id', ...batch.schema.fields.map((f) => `${f}`)].map(pretty_1.valueToString);
        // Pass one to convert to strings and count max column widths
        const newMaxWidths = measureColumnWidths(rowId, batch, header.map((x, i) => Math.max(maxColWidths[i] || 0, x.length)));
        // If any of the column widths changed, print the header again
        if ((rowId % 350) && JSON.stringify(newMaxWidths) !== JSON.stringify(maxColWidths)) {
            this.push(`\n${formatRow(header, newMaxWidths, separator)}`);
        }
        maxColWidths = newMaxWidths;
        for (const row of batch) {
            if (state.closed) {
                break;
            }
            else if (!row) {
                continue;
            }
            if (!(rowId % 350)) {
                this.push(`\n${formatRow(header, maxColWidths, separator)}`);
            }
            this.push(formatRow([rowId++, ...row].map(pretty_1.valueToString), maxColWidths, separator));
        }
        cb();
    }
}
function formatRow(row = [], maxColWidths = [], separator = ' |') {
    return row.map((x, j) => padLeft(x, maxColWidths[j])).join(separator) + '\n';
}
function measureColumnWidths(rowId, batch, maxColWidths = []) {
    for (const row of batch) {
        if (!row) {
            continue;
        }
        maxColWidths[0] = Math.max(maxColWidths[0] || 0, (`${rowId++}`).length);
        for (let val, j = -1, k = row.length; ++j < k;) {
            if (!ArrayBuffer.isView(val = row[j])) {
                maxColWidths[j + 1] = Math.max(maxColWidths[j + 1] || 0, pretty_1.valueToString(val).length);
            }
            else {
                // If we're printing a column of TypedArrays, ensure the column is wide enough to accommodate
                // the widest possible element for a given byte size, since JS omits leading zeroes. For example:
                // 1 |  [1137743649,2170567488,244696391,2122556476]
                // 2 |                                          null
                // 3 |   [637174007,2142281880,961736230,2912449282]
                // 4 |    [1035112265,21832886,412842672,2207710517]
                // 5 |                                          null
                // 6 |                                          null
                // 7 |     [2755142991,4192423256,2994359,467878370]
                const elementWidth = typedArrayElementWidths.get(val.constructor);
                maxColWidths[j + 1] = Math.max(maxColWidths[j + 1] || 0, 2 + // brackets on each end
                    (val.length - 1) + // commas between elements
                    (val.length * elementWidth) // width of stringified 2^N-1
                );
            }
        }
    }
    return maxColWidths;
}
// Measure the stringified representation of 2^N-1 for each TypedArray variant
const typedArrayElementWidths = (() => {
    const maxElementWidth = (ArrayType) => {
        const octets = Array.from({ length: ArrayType.BYTES_PER_ELEMENT - 1 }, _ => 255);
        return `${new ArrayType(new Uint8Array([...octets, 254]).buffer)[0]}`.length;
    };
    return new Map([
        [Int8Array, maxElementWidth(Int8Array)],
        [Int16Array, maxElementWidth(Int16Array)],
        [Int32Array, maxElementWidth(Int32Array)],
        [Uint8Array, maxElementWidth(Uint8Array)],
        [Uint16Array, maxElementWidth(Uint16Array)],
        [Uint32Array, maxElementWidth(Uint32Array)],
        [Float32Array, maxElementWidth(Float32Array)],
        [Float64Array, maxElementWidth(Float64Array)],
        [Uint8ClampedArray, maxElementWidth(Uint8ClampedArray)]
    ]);
})();
function cliOpts() {
    return [
        {
            type: String,
            name: 'schema', alias: 's',
            optional: true, multiple: true,
            typeLabel: '{underline columns}',
            description: 'A space-delimited list of column names'
        },
        {
            type: String,
            name: 'file', alias: 'f',
            optional: true, multiple: true,
            description: 'The Arrow file to read'
        },
        {
            type: String,
            name: 'sep', optional: true, default: '|',
            description: 'The column separator character'
        },
        {
            type: Boolean,
            name: 'help', optional: true, default: false,
            description: 'Print this usage guide.'
        }
    ];
}
function print_usage() {
    console.log(require('command-line-usage')([
        {
            header: 'arrow2csv',
            content: 'Print a CSV from an Arrow file'
        },
        {
            header: 'Synopsis',
            content: [
                '$ arrow2csv {underline file.arrow} [{bold --schema} column_name ...]',
                '$ arrow2csv [{bold --schema} column_name ...] [{bold --file} {underline file.arrow}]',
                '$ arrow2csv {bold -s} column_1 {bold -s} column_2 [{bold -f} {underline file.arrow}]',
                '$ arrow2csv [{bold --help}]'
            ]
        },
        {
            header: 'Options',
            optionList: cliOpts()
        },
        {
            header: 'Example',
            content: [
                '$ arrow2csv --schema foo baz -f simple.arrow --sep ","',
                '                                                      ',
                '> "row_id", "foo: Int32", "bar: Float64", "baz: Utf8"',
                '>        0,            1,              1,        "aa"',
                '>        1,         null,           null,        null',
                '>        2,            3,           null,        null',
                '>        3,            4,              4,       "bbb"',
                '>        4,            5,              5,      "cccc"',
            ]
        }
    ]));
    return 1;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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O1FBQ0Q7WUFDSSxJQUFJLEVBQUUsTUFBTTtZQUNaLElBQUksRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRztZQUN6QyxXQUFXLEVBQUUsZ0NBQWdDO1NBQ2hEO1FBQ0Q7WUFDSSxJQUFJLEVBQUUsT0FBTztZQUNiLElBQUksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSztZQUM1QyxXQUFXLEVBQUUseUJBQXlCO1NBQ3pDO0tBQ0osQ0FBQztBQUNOLENBQUM7QUFFRCxTQUFTLFdBQVc7SUFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUN0QztZQUNJLE1BQU0sRUFBRSxXQUFXO1lBQ25CLE9BQU8sRUFBRSxnQ0FBZ0M7U0FDNUM7UUFDRDtZQUNJLE1BQU0sRUFBRSxVQUFVO1lBQ2xCLE9BQU8sRUFBRTtnQkFDTCxzRUFBc0U7Z0JBQ3RFLHNGQUFzRjtnQkFDdEYsc0ZBQXNGO2dCQUN0Riw2QkFBNkI7YUFDaEM7U0FDSjtRQUNEO1lBQ0ksTUFBTSxFQUFFLFNBQVM7WUFDakIsVUFBVSxFQUFFLE9BQU8sRUFBRTtTQUN4QjtRQUNEO1lBQ0ksTUFBTSxFQUFFLFNBQVM7WUFDakIsT0FBTyxFQUFFO2dCQUNMLHdEQUF3RDtnQkFDeEQsd0RBQXdEO2dCQUN4RCx1REFBdUQ7Z0JBQ3ZELHVEQUF1RDtnQkFDdkQsdURBQXVEO2dCQUN2RCx1REFBdUQ7Z0JBQ3ZELHVEQUF1RDtnQkFDdkQsdURBQXVEO2FBQzFEO1NBQ0o7S0FDSixDQUFDLENBQUMsQ0FBQztJQUNKLE9BQU8sQ0FBQyxDQUFDO0FBQ2IsQ0FBQyIsImZpbGUiOiJiaW4vYXJyb3cyY3N2LmpzIiwic291cmNlc0NvbnRlbnQiOlsiIyEgL3Vzci9iaW4vZW52IG5vZGVcblxuLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbi8qIHRzbGludDpkaXNhYmxlICovXG5cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHN0cmVhbSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgdmFsdWVUb1N0cmluZyB9IGZyb20gJy4uL3V0aWwvcHJldHR5JztcbmltcG9ydCB7IFJlY29yZEJhdGNoLCBSZWNvcmRCYXRjaFJlYWRlciwgQXN5bmNCeXRlUXVldWUgfSBmcm9tICcuLi9BcnJvdy5ub2RlJztcblxuY29uc3QgcGFkTGVmdCA9IHJlcXVpcmUoJ3BhZC1sZWZ0Jyk7XG5jb25zdCBiaWdudW1KU09OUGFyc2UgPSByZXF1aXJlKCdqc29uLWJpZ251bScpLnBhcnNlO1xuY29uc3QgZW9zID0gcmVxdWlyZSgndXRpbCcpLnByb21pc2lmeShzdHJlYW0uZmluaXNoZWQpO1xuY29uc3QgYXJndiA9IHJlcXVpcmUoYGNvbW1hbmQtbGluZS1hcmdzYCkoY2xpT3B0cygpLCB7IHBhcnRpYWw6IHRydWUgfSk7XG5jb25zdCBmaWxlcyA9IGFyZ3YuaGVscCA/IFtdIDogWy4uLihhcmd2LmZpbGUgfHwgW10pLCAuLi4oYXJndi5fdW5rbm93biB8fCBbXSldLmZpbHRlcihCb29sZWFuKTtcblxuY29uc3Qgc3RhdGUgPSB7IC4uLmFyZ3YsIGNsb3NlZDogZmFsc2UsIGhhc1JlY29yZHM6IGZhbHNlIH07XG5wcm9jZXNzLnN0ZG91dC5vbmNlKCdlcnJvcicsICh7IGNvZGUgfSkgPT4gKGNvZGUgPT09ICdFUElQRScpICYmIChzdGF0ZS5jbG9zZWQgPSB0cnVlKSk7XG5cbihhc3luYyAoKSA9PiB7XG5cbiAgICBjb25zdCBzb3VyY2VzID0gYXJndi5oZWxwID8gW10gOiBbXG4gICAgICAgIC4uLmZpbGVzLm1hcCgoZmlsZSkgPT4gKCkgPT4gZnMuY3JlYXRlUmVhZFN0cmVhbShmaWxlKSksXG4gICAgICAgIC4uLihwcm9jZXNzLnN0ZGluLmlzVFRZID8gW10gOiBbKCkgPT4gcHJvY2Vzcy5zdGRpbl0pXG4gICAgXS5maWx0ZXIoQm9vbGVhbikgYXMgKCgpID0+IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSlbXTtcblxuICAgIGxldCByZWFkZXI6IFJlY29yZEJhdGNoUmVhZGVyIHwgbnVsbDtcblxuICAgIGZvciAoY29uc3Qgc291cmNlIG9mIHNvdXJjZXMpIHtcbiAgICAgICAgaWYgKHN0YXRlLmNsb3NlZCkgeyBicmVhazsgfVxuICAgICAgICBpZiAocmVhZGVyID0gYXdhaXQgY3JlYXRlUmVjb3JkQmF0Y2hSZWFkZXIoc291cmNlKSkge1xuICAgICAgICAgICAgYXdhaXQgZW9zKHJlYWRlclxuICAgICAgICAgICAgICAgIC5waXBlKHJlY29yZEJhdGNoUm93c1RvU3RyaW5nKHN0YXRlKSlcbiAgICAgICAgICAgICAgICAub24oJ2RhdGEnLCAoeCkgPT4gcHJvY2Vzcy5zdGRvdXQud3JpdGUoeCkpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBzdGF0ZS5oYXNSZWNvcmRzID8gMCA6IHByaW50X3VzYWdlKCk7XG59KSgpXG4udGhlbigoeCkgPT4gK3ggfHwgMCwgKGVycikgPT4ge1xuICAgIGlmIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgJHtlcnIgJiYgZXJyLnN0YWNrIHx8IGVycn1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHByb2Nlc3MuZXhpdENvZGUgfHwgMTtcbn0pLnRoZW4oKGNvZGUpID0+IHByb2Nlc3MuZXhpdChjb2RlKSk7XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVJlY29yZEJhdGNoUmVhZGVyKGNyZWF0ZVNvdXJjZVN0cmVhbTogKCkgPT4gTm9kZUpTLlJlYWRhYmxlU3RyZWFtKSB7XG5cbiAgICBsZXQgc291cmNlID0gY3JlYXRlU291cmNlU3RyZWFtKCk7XG4gICAgbGV0IGJ5dGVRdWV1ZSA9IG5ldyBBc3luY0J5dGVRdWV1ZSgpO1xuICAgIGxldCByZWFkZXI6IFJlY29yZEJhdGNoUmVhZGVyIHwgbnVsbCA9IG51bGw7XG4gICAgc291cmNlLm9uKCdlbmQnLCBieXRlUXVldWUuY2xvc2UuYmluZChieXRlUXVldWUpKVxuICAgICAgICAub24oJ2RhdGEnLCAgYnl0ZVF1ZXVlLndyaXRlLmJpbmQoYnl0ZVF1ZXVlKSk7XG5cbiAgICB0cnkge1xuICAgICAgICByZWFkZXIgPSBhd2FpdCAoYXdhaXQgUmVjb3JkQmF0Y2hSZWFkZXIuZnJvbShzb3VyY2UpKS5vcGVuKCk7XG4gICAgfSBjYXRjaCAoZSkgeyByZWFkZXIgPSBudWxsOyB9XG5cbiAgICBpZiAoIXJlYWRlciB8fCByZWFkZXIuY2xvc2VkKSB7XG4gICAgICAgIHJlYWRlciA9IG51bGw7XG4gICAgICAgIGF3YWl0IGJ5dGVRdWV1ZS5jbG9zZWQ7XG4gICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBmcy5SZWFkU3RyZWFtKSB7IHNvdXJjZS5jbG9zZSgpOyB9XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQganNvbiA9IGJpZ251bUpTT05QYXJzZShhd2FpdCBieXRlUXVldWUudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICByZWFkZXIgPSBhd2FpdCAoYXdhaXQgUmVjb3JkQmF0Y2hSZWFkZXIuZnJvbShqc29uKSkub3BlbigpO1xuICAgICAgICB9IGNhdGNoIChlKSB7IHJlYWRlciA9IG51bGw7IH1cbiAgICB9XG5cbiAgICByZXR1cm4gKHJlYWRlciAmJiAhcmVhZGVyLmNsb3NlZCkgPyByZWFkZXIgOiBudWxsO1xufVxuXG5mdW5jdGlvbiByZWNvcmRCYXRjaFJvd3NUb1N0cmluZyhzdGF0ZTogeyBjbG9zZWQ6IGJvb2xlYW4sIHNjaGVtYTogYW55LCBzZXBhcmF0b3I6IHN0cmluZywgaGFzUmVjb3JkczogYm9vbGVhbiB9KSB7XG5cbiAgICBsZXQgcm93SWQgPSAwLCBtYXhDb2xXaWR0aHMgPSBbMTVdLCBzZXBhcmF0b3IgPSBgJHtzdGF0ZS5zZXBhcmF0b3IgfHwgJyB8J30gYDtcblxuICAgIHJldHVybiBuZXcgc3RyZWFtLlRyYW5zZm9ybSh7IHRyYW5zZm9ybSwgZW5jb2Rpbmc6ICd1dGY4Jywgd3JpdGFibGVPYmplY3RNb2RlOiB0cnVlLCByZWFkYWJsZU9iamVjdE1vZGU6IGZhbHNlIH0pO1xuXG4gICAgZnVuY3Rpb24gdHJhbnNmb3JtKHRoaXM6IHN0cmVhbS5UcmFuc2Zvcm0sIGJhdGNoOiBSZWNvcmRCYXRjaCwgX2VuYzogc3RyaW5nLCBjYjogKGVycm9yPzogRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpIHtcbiAgICAgICAgYmF0Y2ggPSAhKHN0YXRlLnNjaGVtYSAmJiBzdGF0ZS5zY2hlbWEubGVuZ3RoKSA/IGJhdGNoIDogYmF0Y2guc2VsZWN0KC4uLnN0YXRlLnNjaGVtYSk7XG4gICAgICAgIGlmIChiYXRjaC5sZW5ndGggPD0gMCB8fCBiYXRjaC5udW1Db2xzIDw9IDAgfHwgc3RhdGUuY2xvc2VkKSB7XG4gICAgICAgICAgICBzdGF0ZS5oYXNSZWNvcmRzIHx8IChzdGF0ZS5oYXNSZWNvcmRzID0gZmFsc2UpO1xuICAgICAgICAgICAgcmV0dXJuIGNiKHVuZGVmaW5lZCwgbnVsbCk7XG4gICAgICAgIH1cblxuICAgICAgICBzdGF0ZS5oYXNSZWNvcmRzID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgaGVhZGVyID0gWydyb3dfaWQnLCAuLi5iYXRjaC5zY2hlbWEuZmllbGRzLm1hcCgoZikgPT4gYCR7Zn1gKV0ubWFwKHZhbHVlVG9TdHJpbmcpO1xuXG4gICAgICAgIC8vIFBhc3Mgb25lIHRvIGNvbnZlcnQgdG8gc3RyaW5ncyBhbmQgY291bnQgbWF4IGNvbHVtbiB3aWR0aHNcbiAgICAgICAgY29uc3QgbmV3TWF4V2lkdGhzID0gbWVhc3VyZUNvbHVtbldpZHRocyhyb3dJZCwgYmF0Y2gsIGhlYWRlci5tYXAoKHgsIGkpID0+IE1hdGgubWF4KG1heENvbFdpZHRoc1tpXSB8fCAwLCB4Lmxlbmd0aCkpKTtcblxuICAgICAgICAvLyBJZiBhbnkgb2YgdGhlIGNvbHVtbiB3aWR0aHMgY2hhbmdlZCwgcHJpbnQgdGhlIGhlYWRlciBhZ2FpblxuICAgICAgICBpZiAoKHJvd0lkICUgMzUwKSAmJiBKU09OLnN0cmluZ2lmeShuZXdNYXhXaWR0aHMpICE9PSBKU09OLnN0cmluZ2lmeShtYXhDb2xXaWR0aHMpKSB7XG4gICAgICAgICAgICB0aGlzLnB1c2goYFxcbiR7Zm9ybWF0Um93KGhlYWRlciwgbmV3TWF4V2lkdGhzLCBzZXBhcmF0b3IpfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgbWF4Q29sV2lkdGhzID0gbmV3TWF4V2lkdGhzO1xuXG4gICAgICAgIGZvciAoY29uc3Qgcm93IG9mIGJhdGNoKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUuY2xvc2VkKSB7IGJyZWFrOyB9XG4gICAgICAgICAgICBlbHNlIGlmICghcm93KSB7IGNvbnRpbnVlOyB9XG4gICAgICAgICAgICBpZiAoIShyb3dJZCAlIDM1MCkpIHsgdGhpcy5wdXNoKGBcXG4ke2Zvcm1hdFJvdyhoZWFkZXIsIG1heENvbFdpZHRocywgc2VwYXJhdG9yKX1gKTsgfVxuICAgICAgICAgICAgdGhpcy5wdXNoKGZvcm1hdFJvdyhbcm93SWQrKywgLi4ucm93XS5tYXAodmFsdWVUb1N0cmluZyksIG1heENvbFdpZHRocywgc2VwYXJhdG9yKSk7XG4gICAgICAgIH1cbiAgICAgICAgY2IoKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGZvcm1hdFJvdyhyb3c6IHN0cmluZ1tdID0gW10sIG1heENvbFdpZHRoczogbnVtYmVyW10gPSBbXSwgc2VwYXJhdG9yOiBzdHJpbmcgPSAnIHwnKSB7XG4gICAgcmV0dXJuIHJvdy5tYXAoKHgsIGopID0+IHBhZExlZnQoeCwgbWF4Q29sV2lkdGhzW2pdKSkuam9pbihzZXBhcmF0b3IpICsgJ1xcbic7XG59XG5cbmZ1bmN0aW9uIG1lYXN1cmVDb2x1bW5XaWR0aHMocm93SWQ6IG51bWJlciwgYmF0Y2g6IFJlY29yZEJhdGNoLCBtYXhDb2xXaWR0aHM6IG51bWJlcltdID0gW10pIHtcbiAgICBmb3IgKGNvbnN0IHJvdyBvZiBiYXRjaCkge1xuICAgICAgICBpZiAoIXJvdykgeyBjb250aW51ZTsgfVxuICAgICAgICBtYXhDb2xXaWR0aHNbMF0gPSBNYXRoLm1heChtYXhDb2xXaWR0aHNbMF0gfHwgMCwgKGAke3Jvd0lkKyt9YCkubGVuZ3RoKTtcbiAgICAgICAgZm9yIChsZXQgdmFsOiBhbnksIGogPSAtMSwgayA9IHJvdy5sZW5ndGg7ICsraiA8IGs7KSB7XG4gICAgICAgICAgICBpZiAoIUFycmF5QnVmZmVyLmlzVmlldyh2YWwgPSByb3dbal0pKSB7XG4gICAgICAgICAgICAgICAgbWF4Q29sV2lkdGhzW2ogKyAxXSA9IE1hdGgubWF4KG1heENvbFdpZHRoc1tqICsgMV0gfHwgMCwgdmFsdWVUb1N0cmluZyh2YWwpLmxlbmd0aCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIElmIHdlJ3JlIHByaW50aW5nIGEgY29sdW1uIG9mIFR5cGVkQXJyYXlzLCBlbnN1cmUgdGhlIGNvbHVtbiBpcyB3aWRlIGVub3VnaCB0byBhY2NvbW1vZGF0ZVxuICAgICAgICAgICAgICAgIC8vIHRoZSB3aWRlc3QgcG9zc2libGUgZWxlbWVudCBmb3IgYSBnaXZlbiBieXRlIHNpemUsIHNpbmNlIEpTIG9taXRzIGxlYWRpbmcgemVyb2VzLiBGb3IgZXhhbXBsZTpcbiAgICAgICAgICAgICAgICAvLyAxIHwgIFsxMTM3NzQzNjQ5LDIxNzA1Njc0ODgsMjQ0Njk2MzkxLDIxMjI1NTY0NzZdXG4gICAgICAgICAgICAgICAgLy8gMiB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbFxuICAgICAgICAgICAgICAgIC8vIDMgfCAgIFs2MzcxNzQwMDcsMjE0MjI4MTg4MCw5NjE3MzYyMzAsMjkxMjQ0OTI4Ml1cbiAgICAgICAgICAgICAgICAvLyA0IHwgICAgWzEwMzUxMTIyNjUsMjE4MzI4ODYsNDEyODQyNjcyLDIyMDc3MTA1MTddXG4gICAgICAgICAgICAgICAgLy8gNSB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbFxuICAgICAgICAgICAgICAgIC8vIDYgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGxcbiAgICAgICAgICAgICAgICAvLyA3IHwgICAgIFsyNzU1MTQyOTkxLDQxOTI0MjMyNTYsMjk5NDM1OSw0Njc4NzgzNzBdXG4gICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudFdpZHRoID0gdHlwZWRBcnJheUVsZW1lbnRXaWR0aHMuZ2V0KHZhbC5jb25zdHJ1Y3RvcikhO1xuXG4gICAgICAgICAgICAgICAgbWF4Q29sV2lkdGhzW2ogKyAxXSA9IE1hdGgubWF4KG1heENvbFdpZHRoc1tqICsgMV0gfHwgMCxcbiAgICAgICAgICAgICAgICAgICAgMiArIC8vIGJyYWNrZXRzIG9uIGVhY2ggZW5kXG4gICAgICAgICAgICAgICAgICAgICh2YWwubGVuZ3RoIC0gMSkgKyAvLyBjb21tYXMgYmV0d2VlbiBlbGVtZW50c1xuICAgICAgICAgICAgICAgICAgICAodmFsLmxlbmd0aCAqIGVsZW1lbnRXaWR0aCkgLy8gd2lkdGggb2Ygc3RyaW5naWZpZWQgMl5OLTFcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBtYXhDb2xXaWR0aHM7XG59XG5cbi8vIE1lYXN1cmUgdGhlIHN0cmluZ2lmaWVkIHJlcHJlc2VudGF0aW9uIG9mIDJeTi0xIGZvciBlYWNoIFR5cGVkQXJyYXkgdmFyaWFudFxuY29uc3QgdHlwZWRBcnJheUVsZW1lbnRXaWR0aHMgPSAoKCkgPT4ge1xuICAgIGNvbnN0IG1heEVsZW1lbnRXaWR0aCA9IChBcnJheVR5cGU6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBvY3RldHMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBBcnJheVR5cGUuQllURVNfUEVSX0VMRU1FTlQgLSAxIH0sIF8gPT4gMjU1KTtcbiAgICAgICAgcmV0dXJuIGAke25ldyBBcnJheVR5cGUobmV3IFVpbnQ4QXJyYXkoWy4uLm9jdGV0cywgMjU0XSkuYnVmZmVyKVswXX1gLmxlbmd0aDtcbiAgICB9O1xuICAgIHJldHVybiBuZXcgTWFwPGFueSwgbnVtYmVyPihbXG4gICAgICAgIFtJbnQ4QXJyYXksIG1heEVsZW1lbnRXaWR0aChJbnQ4QXJyYXkpXSxcbiAgICAgICAgW0ludDE2QXJyYXksIG1heEVsZW1lbnRXaWR0aChJbnQxNkFycmF5KV0sXG4gICAgICAgIFtJbnQzMkFycmF5LCBtYXhFbGVtZW50V2lkdGgoSW50MzJBcnJheSldLFxuICAgICAgICBbVWludDhBcnJheSwgbWF4RWxlbWVudFdpZHRoKFVpbnQ4QXJyYXkpXSxcbiAgICAgICAgW1VpbnQxNkFycmF5LCBtYXhFbGVtZW50V2lkdGgoVWludDE2QXJyYXkpXSxcbiAgICAgICAgW1VpbnQzMkFycmF5LCBtYXhFbGVtZW50V2lkdGgoVWludDMyQXJyYXkpXSxcbiAgICAgICAgW0Zsb2F0MzJBcnJheSwgbWF4RWxlbWVudFdpZHRoKEZsb2F0MzJBcnJheSldLFxuICAgICAgICBbRmxvYXQ2NEFycmF5LCBtYXhFbGVtZW50V2lkdGgoRmxvYXQ2NEFycmF5KV0sXG4gICAgICAgIFtVaW50OENsYW1wZWRBcnJheSwgbWF4RWxlbWVudFdpZHRoKFVpbnQ4Q2xhbXBlZEFycmF5KV1cbiAgICBdKVxufSkoKTtcblxuZnVuY3Rpb24gY2xpT3B0cygpIHtcbiAgICByZXR1cm4gW1xuICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgICAgICBuYW1lOiAnc2NoZW1hJywgYWxpYXM6ICdzJyxcbiAgICAgICAgICAgIG9wdGlvbmFsOiB0cnVlLCBtdWx0aXBsZTogdHJ1ZSxcbiAgICAgICAgICAgIHR5cGVMYWJlbDogJ3t1bmRlcmxpbmUgY29sdW1uc30nLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICdBIHNwYWNlLWRlbGltaXRlZCBsaXN0IG9mIGNvbHVtbiBuYW1lcydcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgICAgICAgbmFtZTogJ2ZpbGUnLCBhbGlhczogJ2YnLFxuICAgICAgICAgICAgb3B0aW9uYWw6IHRydWUsIG11bHRpcGxlOiB0cnVlLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgQXJyb3cgZmlsZSB0byByZWFkJ1xuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgICAgICBuYW1lOiAnc2VwJywgb3B0aW9uYWw6IHRydWUsIGRlZmF1bHQ6ICd8JyxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIGNvbHVtbiBzZXBhcmF0b3IgY2hhcmFjdGVyJ1xuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiBCb29sZWFuLFxuICAgICAgICAgICAgbmFtZTogJ2hlbHAnLCBvcHRpb25hbDogdHJ1ZSwgZGVmYXVsdDogZmFsc2UsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1ByaW50IHRoaXMgdXNhZ2UgZ3VpZGUuJ1xuICAgICAgICB9XG4gICAgXTsgICAgXG59XG5cbmZ1bmN0aW9uIHByaW50X3VzYWdlKCkge1xuICAgIGNvbnNvbGUubG9nKHJlcXVpcmUoJ2NvbW1hbmQtbGluZS11c2FnZScpKFtcbiAgICAgICAge1xuICAgICAgICAgICAgaGVhZGVyOiAnYXJyb3cyY3N2JyxcbiAgICAgICAgICAgIGNvbnRlbnQ6ICdQcmludCBhIENTViBmcm9tIGFuIEFycm93IGZpbGUnXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGhlYWRlcjogJ1N5bm9wc2lzJyxcbiAgICAgICAgICAgIGNvbnRlbnQ6IFtcbiAgICAgICAgICAgICAgICAnJCBhcnJvdzJjc3Yge3VuZGVybGluZSBmaWxlLmFycm93fSBbe2JvbGQgLS1zY2hlbWF9IGNvbHVtbl9uYW1lIC4uLl0nLFxuICAgICAgICAgICAgICAgICckIGFycm93MmNzdiBbe2JvbGQgLS1zY2hlbWF9IGNvbHVtbl9uYW1lIC4uLl0gW3tib2xkIC0tZmlsZX0ge3VuZGVybGluZSBmaWxlLmFycm93fV0nLFxuICAgICAgICAgICAgICAgICckIGFycm93MmNzdiB7Ym9sZCAtc30gY29sdW1uXzEge2JvbGQgLXN9IGNvbHVtbl8yIFt7Ym9sZCAtZn0ge3VuZGVybGluZSBmaWxlLmFycm93fV0nLFxuICAgICAgICAgICAgICAgICckIGFycm93MmNzdiBbe2JvbGQgLS1oZWxwfV0nXG4gICAgICAgICAgICBdXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGhlYWRlcjogJ09wdGlvbnMnLFxuICAgICAgICAgICAgb3B0aW9uTGlzdDogY2xpT3B0cygpXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGhlYWRlcjogJ0V4YW1wbGUnLFxuICAgICAgICAgICAgY29udGVudDogW1xuICAgICAgICAgICAgICAgICckIGFycm93MmNzdiAtLXNjaGVtYSBmb28gYmF6IC1mIHNpbXBsZS5hcnJvdyAtLXNlcCBcIixcIicsXG4gICAgICAgICAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcsXG4gICAgICAgICAgICAgICAgJz4gXCJyb3dfaWRcIiwgXCJmb286IEludDMyXCIsIFwiYmFyOiBGbG9hdDY0XCIsIFwiYmF6OiBVdGY4XCInLFxuICAgICAgICAgICAgICAgICc+ICAgICAgICAwLCAgICAgICAgICAgIDEsICAgICAgICAgICAgICAxLCAgICAgICAgXCJhYVwiJyxcbiAgICAgICAgICAgICAgICAnPiAgICAgICAgMSwgICAgICAgICBudWxsLCAgICAgICAgICAgbnVsbCwgICAgICAgIG51bGwnLFxuICAgICAgICAgICAgICAgICc+ICAgICAgICAyLCAgICAgICAgICAgIDMsICAgICAgICAgICBudWxsLCAgICAgICAgbnVsbCcsXG4gICAgICAgICAgICAgICAgJz4gICAgICAgIDMsICAgICAgICAgICAgNCwgICAgICAgICAgICAgIDQsICAgICAgIFwiYmJiXCInLFxuICAgICAgICAgICAgICAgICc+ICAgICAgICA0LCAgICAgICAgICAgIDUsICAgICAgICAgICAgICA1LCAgICAgIFwiY2NjY1wiJyxcbiAgICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgIF0pKTtcbiAgICByZXR1cm4gMTtcbn1cbiJdfQ==
