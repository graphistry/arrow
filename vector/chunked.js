"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const vector_1 = require("../util/vector");
const type_1 = require("../type");
const vector_2 = require("../vector");
const array_1 = require("../util/array");
/** @ignore */
class Chunked extends vector_2.AbstractVector {
    constructor(type, chunks = [], offsets = calculateOffsets(chunks)) {
        super();
        this._nullCount = -1;
        this._type = type;
        this._chunks = chunks;
        this._chunkOffsets = offsets;
        this._length = offsets[offsets.length - 1];
        this._numChildren = (this._type.children || []).length;
    }
    /** @nocollapse */
    static flatten(...vectors) {
        return array_1.selectAndFlattenChunks(vector_2.Vector, vectors);
    }
    /** @nocollapse */
    static concat(...chunks) {
        return new Chunked(chunks[0].type, Chunked.flatten(...chunks));
    }
    get type() { return this._type; }
    get length() { return this._length; }
    get chunks() { return this._chunks; }
    get typeId() { return this._type.typeId; }
    get data() {
        return this._chunks[0] ? this._chunks[0].data : null;
    }
    get ArrayType() { return this._type.ArrayType; }
    get numChildren() { return this._numChildren; }
    get stride() { return this._chunks[0] ? this._chunks[0].stride : 1; }
    get nullCount() {
        let nullCount = this._nullCount;
        if (nullCount < 0) {
            this._nullCount = nullCount = this._chunks.reduce((x, { nullCount }) => x + nullCount, 0);
        }
        return nullCount;
    }
    get indices() {
        if (type_1.DataType.isDictionary(this._type)) {
            if (!this._indices) {
                const chunks = this._chunks;
                this._indices = (chunks.length === 1
                    ? chunks[0].indices
                    : Chunked.concat(...chunks.map((x) => x.indices)));
            }
            return this._indices;
        }
        return null;
    }
    get dictionary() {
        if (type_1.DataType.isDictionary(this._type)) {
            return this._type.dictionaryVector;
        }
        return null;
    }
    *[Symbol.iterator]() {
        for (const chunk of this._chunks) {
            yield* chunk;
        }
    }
    clone(chunks = this._chunks) {
        return new Chunked(this._type, chunks);
    }
    concat(...others) {
        return this.clone(Chunked.flatten(this, ...others));
    }
    slice(begin, end) {
        return vector_1.clampRange(this, begin, end, this._sliceInternal);
    }
    getChildAt(index) {
        if (index < 0 || index >= this._numChildren) {
            return null;
        }
        let columns = this._children || (this._children = []);
        let child, field, chunks;
        if (child = columns[index]) {
            return child;
        }
        if (field = (this._type.children || [])[index]) {
            chunks = this._chunks
                .map((vector) => vector.getChildAt(index))
                .filter((vec) => vec != null);
            if (chunks.length > 0) {
                return (columns[index] = new Chunked(field.type, chunks));
            }
        }
        return null;
    }
    search(index, then) {
        let idx = index;
        // binary search to find the child vector and value indices
        let offsets = this._chunkOffsets, rhs = offsets.length - 1;
        // return early if out of bounds, or if there's just one child
        if (idx < 0) {
            return null;
        }
        if (idx >= offsets[rhs]) {
            return null;
        }
        if (rhs <= 1) {
            return then ? then(this, 0, idx) : [0, idx];
        }
        let lhs = 0, pos = 0, mid = 0;
        do {
            if (lhs + 1 === rhs) {
                return then ? then(this, lhs, idx - pos) : [lhs, idx - pos];
            }
            mid = lhs + ((rhs - lhs) / 2) | 0;
            idx >= offsets[mid] ? (lhs = mid) : (rhs = mid);
        } while (idx < offsets[rhs] && idx >= (pos = offsets[lhs]));
        return null;
    }
    isValid(index) {
        return !!this.search(index, this.isValidInternal);
    }
    get(index) {
        return this.search(index, this.getInternal);
    }
    set(index, value) {
        this.search(index, ({ chunks }, i, j) => chunks[i].set(j, value));
    }
    indexOf(element, offset) {
        if (offset && typeof offset === 'number') {
            return this.search(offset, (self, i, j) => this.indexOfInternal(self, i, j, element));
        }
        return this.indexOfInternal(this, 0, Math.max(0, offset || 0), element);
    }
    toArray() {
        const { chunks } = this;
        const n = chunks.length;
        let { ArrayType } = this._type;
        if (n <= 0) {
            return new ArrayType(0);
        }
        if (n <= 1) {
            return chunks[0].toArray();
        }
        let len = 0, src = new Array(n);
        for (let i = -1; ++i < n;) {
            len += (src[i] = chunks[i].toArray()).length;
        }
        if (ArrayType !== src[0].constructor) {
            ArrayType = src[0].constructor;
        }
        let dst = new ArrayType(len);
        let set = ArrayType === Array ? arraySet : typedSet;
        for (let i = -1, idx = 0; ++i < n;) {
            idx = set(src[i], dst, idx);
        }
        return dst;
    }
    getInternal({ _chunks }, i, j) { return _chunks[i].get(j); }
    isValidInternal({ _chunks }, i, j) { return _chunks[i].isValid(j); }
    indexOfInternal({ _chunks }, chunkIndex, fromIndex, element) {
        let i = chunkIndex - 1, n = _chunks.length;
        let start = fromIndex, offset = 0, found = -1;
        while (++i < n) {
            if (~(found = _chunks[i].indexOf(element, start))) {
                return offset + found;
            }
            start = 0;
            offset += _chunks[i].length;
        }
        return -1;
    }
    _sliceInternal(self, begin, end) {
        const slices = [];
        const { chunks, _chunkOffsets: chunkOffsets } = self;
        for (let i = -1, n = chunks.length; ++i < n;) {
            const chunk = chunks[i];
            const chunkLength = chunk.length;
            const chunkOffset = chunkOffsets[i];
            // If the child is to the right of the slice boundary, we can stop
            if (chunkOffset >= end) {
                break;
            }
            // If the child is to the left of of the slice boundary, exclude
            if (begin >= chunkOffset + chunkLength) {
                continue;
            }
            // If the child is between both left and right boundaries, include w/o slicing
            if (chunkOffset >= begin && (chunkOffset + chunkLength) <= end) {
                slices.push(chunk);
                continue;
            }
            // If the child overlaps one of the slice boundaries, include that slice
            const from = Math.max(0, begin - chunkOffset);
            const to = Math.min(end - chunkOffset, chunkLength);
            slices.push(chunk.slice(from, to));
        }
        return self.clone(slices);
    }
}
exports.Chunked = Chunked;
/** @ignore */
function calculateOffsets(vectors) {
    let offsets = new Uint32Array((vectors || []).length + 1);
    let offset = offsets[0] = 0, length = offsets.length;
    for (let index = 0; ++index < length;) {
        offsets[index] = (offset += vectors[index - 1].length);
    }
    return offsets;
}
/** @ignore */
const typedSet = (src, dst, offset) => {
    dst.set(src, offset);
    return (offset + src.length);
};
/** @ignore */
const arraySet = (src, dst, offset) => {
    let idx = offset - 1;
    for (let i = -1, n = src.length; ++i < n;) {
        dst[++idx] = src[i];
    }
    return idx;
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHO1FBQ3ZDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUN2QjtJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2YsQ0FBQyxDQUFDIiwiZmlsZSI6InZlY3Rvci9jaHVua2VkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IERhdGEgfSBmcm9tICcuLi9kYXRhJztcbmltcG9ydCB7IEZpZWxkIH0gZnJvbSAnLi4vc2NoZW1hJztcbmltcG9ydCB7IGNsYW1wUmFuZ2UgfSBmcm9tICcuLi91dGlsL3ZlY3Rvcic7XG5pbXBvcnQgeyBEYXRhVHlwZSwgRGljdGlvbmFyeSB9IGZyb20gJy4uL3R5cGUnO1xuaW1wb3J0IHsgRGljdGlvbmFyeVZlY3RvciB9IGZyb20gJy4vZGljdGlvbmFyeSc7XG5pbXBvcnQgeyBBYnN0cmFjdFZlY3RvciwgVmVjdG9yIH0gZnJvbSAnLi4vdmVjdG9yJztcbmltcG9ydCB7IHNlbGVjdEFuZEZsYXR0ZW5DaHVua3MgfSBmcm9tICcuLi91dGlsL2FycmF5JztcbmltcG9ydCB7IENsb25hYmxlLCBTbGljZWFibGUsIEFwcGxpY2F0aXZlIH0gZnJvbSAnLi4vdmVjdG9yJztcblxuLyoqIEBpZ25vcmUgKi9cbnR5cGUgQ2h1bmtlZERpY3Q8VCBleHRlbmRzIERhdGFUeXBlPiA9IFQgZXh0ZW5kcyBEaWN0aW9uYXJ5ID8gVFsnZGljdGlvbmFyeVZlY3RvciddIDogbnVsbCB8IG5ldmVyO1xuLyoqIEBpZ25vcmUgKi9cbnR5cGUgQ2h1bmtlZEtleXM8VCBleHRlbmRzIERhdGFUeXBlPiA9IFQgZXh0ZW5kcyBEaWN0aW9uYXJ5ID8gVmVjdG9yPFRbJ2luZGljZXMnXT4gfCBDaHVua2VkPFRbJ2luZGljZXMnXT4gOiBudWxsIHwgbmV2ZXI7XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgdHlwZSBTZWFyY2hDb250aW51YXRpb248VCBleHRlbmRzIENodW5rZWQ+ID0gKGNvbHVtbjogVCwgY2h1bmtJbmRleDogbnVtYmVyLCB2YWx1ZUluZGV4OiBudW1iZXIpID0+IGFueTtcblxuLyoqIEBpZ25vcmUgKi9cbmV4cG9ydCBjbGFzcyBDaHVua2VkPFQgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT5cbiAgICBleHRlbmRzIEFic3RyYWN0VmVjdG9yPFQ+XG4gICAgaW1wbGVtZW50cyBDbG9uYWJsZTxDaHVua2VkPFQ+PixcbiAgICAgICAgICAgICAgIFNsaWNlYWJsZTxDaHVua2VkPFQ+PixcbiAgICAgICAgICAgICAgIEFwcGxpY2F0aXZlPFQsIENodW5rZWQ8VD4+IHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZmxhdHRlbjxUIGV4dGVuZHMgRGF0YVR5cGU+KC4uLnZlY3RvcnM6IFZlY3RvcjxUPltdKSB7XG4gICAgICAgIHJldHVybiBzZWxlY3RBbmRGbGF0dGVuQ2h1bmtzPFZlY3RvcjxUPj4oVmVjdG9yLCB2ZWN0b3JzKTtcbiAgICB9XG5cbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIGNvbmNhdDxUIGV4dGVuZHMgRGF0YVR5cGU+KC4uLmNodW5rczogVmVjdG9yPFQ+W10pOiBDaHVua2VkPFQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBDaHVua2VkKGNodW5rc1swXS50eXBlLCBDaHVua2VkLmZsYXR0ZW4oLi4uY2h1bmtzKSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF90eXBlOiBUO1xuICAgIHByb3RlY3RlZCBfbGVuZ3RoOiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIF9jaHVua3M6IFZlY3RvcjxUPltdO1xuICAgIHByb3RlY3RlZCBfbnVtQ2hpbGRyZW46IG51bWJlcjtcbiAgICBwcm90ZWN0ZWQgX2NoaWxkcmVuPzogQ2h1bmtlZFtdO1xuICAgIHByb3RlY3RlZCBfbnVsbENvdW50OiBudW1iZXIgPSAtMTtcbiAgICBwcm90ZWN0ZWQgX2NodW5rT2Zmc2V0czogVWludDMyQXJyYXk7XG5cbiAgICBjb25zdHJ1Y3Rvcih0eXBlOiBULCBjaHVua3M6IFZlY3RvcjxUPltdID0gW10sIG9mZnNldHMgPSBjYWxjdWxhdGVPZmZzZXRzKGNodW5rcykpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5fdHlwZSA9IHR5cGU7XG4gICAgICAgIHRoaXMuX2NodW5rcyA9IGNodW5rcztcbiAgICAgICAgdGhpcy5fY2h1bmtPZmZzZXRzID0gb2Zmc2V0cztcbiAgICAgICAgdGhpcy5fbGVuZ3RoID0gb2Zmc2V0c1tvZmZzZXRzLmxlbmd0aCAtIDFdO1xuICAgICAgICB0aGlzLl9udW1DaGlsZHJlbiA9ICh0aGlzLl90eXBlLmNoaWxkcmVuIHx8IFtdKS5sZW5ndGg7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCB0eXBlKCkgeyByZXR1cm4gdGhpcy5fdHlwZTsgfVxuICAgIHB1YmxpYyBnZXQgbGVuZ3RoKCkgeyByZXR1cm4gdGhpcy5fbGVuZ3RoOyB9XG4gICAgcHVibGljIGdldCBjaHVua3MoKSB7IHJldHVybiB0aGlzLl9jaHVua3M7IH1cbiAgICBwdWJsaWMgZ2V0IHR5cGVJZCgpOiBUWydUVHlwZSddIHsgcmV0dXJuIHRoaXMuX3R5cGUudHlwZUlkOyB9XG4gICAgcHVibGljIGdldCBkYXRhKCk6IERhdGE8VD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fY2h1bmtzWzBdID8gdGhpcy5fY2h1bmtzWzBdLmRhdGEgOiA8YW55PiBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgQXJyYXlUeXBlKCkgeyByZXR1cm4gdGhpcy5fdHlwZS5BcnJheVR5cGU7IH1cbiAgICBwdWJsaWMgZ2V0IG51bUNoaWxkcmVuKCkgeyByZXR1cm4gdGhpcy5fbnVtQ2hpbGRyZW47IH1cbiAgICBwdWJsaWMgZ2V0IHN0cmlkZSgpIHsgcmV0dXJuIHRoaXMuX2NodW5rc1swXSA/IHRoaXMuX2NodW5rc1swXS5zdHJpZGUgOiAxOyB9XG4gICAgcHVibGljIGdldCBudWxsQ291bnQoKSB7XG4gICAgICAgIGxldCBudWxsQ291bnQgPSB0aGlzLl9udWxsQ291bnQ7XG4gICAgICAgIGlmIChudWxsQ291bnQgPCAwKSB7XG4gICAgICAgICAgICB0aGlzLl9udWxsQ291bnQgPSBudWxsQ291bnQgPSB0aGlzLl9jaHVua3MucmVkdWNlKCh4LCB7IG51bGxDb3VudCB9KSA9PiB4ICsgbnVsbENvdW50LCAwKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbENvdW50O1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfaW5kaWNlcz86IENodW5rZWRLZXlzPFQ+O1xuICAgIHB1YmxpYyBnZXQgaW5kaWNlcygpOiBDaHVua2VkS2V5czxUPiB8IG51bGwge1xuICAgICAgICBpZiAoRGF0YVR5cGUuaXNEaWN0aW9uYXJ5KHRoaXMuX3R5cGUpKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX2luZGljZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjaHVua3MgPSAoPGFueT4gdGhpcy5fY2h1bmtzKSBhcyBEaWN0aW9uYXJ5VmVjdG9yPFQsIGFueT5bXTtcbiAgICAgICAgICAgICAgICB0aGlzLl9pbmRpY2VzID0gKGNodW5rcy5sZW5ndGggPT09IDFcbiAgICAgICAgICAgICAgICAgICAgPyBjaHVua3NbMF0uaW5kaWNlc1xuICAgICAgICAgICAgICAgICAgICA6IENodW5rZWQuY29uY2F0KC4uLmNodW5rcy5tYXAoKHgpID0+IHguaW5kaWNlcykpKSBhcyBDaHVua2VkS2V5czxUPjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbmRpY2VzO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0IGRpY3Rpb25hcnkoKTogQ2h1bmtlZERpY3Q8VD4gfCBudWxsIHtcbiAgICAgICAgaWYgKERhdGFUeXBlLmlzRGljdGlvbmFyeSh0aGlzLl90eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuICg8YW55PiB0aGlzLl90eXBlLmRpY3Rpb25hcnlWZWN0b3IpIGFzIENodW5rZWREaWN0PFQ+O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyAqW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxUWydUVmFsdWUnXSB8IG51bGw+IHtcbiAgICAgICAgZm9yIChjb25zdCBjaHVuayBvZiB0aGlzLl9jaHVua3MpIHtcbiAgICAgICAgICAgIHlpZWxkKiBjaHVuaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjbG9uZShjaHVua3MgPSB0aGlzLl9jaHVua3MpOiBDaHVua2VkPFQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBDaHVua2VkKHRoaXMuX3R5cGUsIGNodW5rcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbmNhdCguLi5vdGhlcnM6IFZlY3RvcjxUPltdKTogQ2h1bmtlZDxUPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNsb25lKENodW5rZWQuZmxhdHRlbih0aGlzLCAuLi5vdGhlcnMpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2xpY2UoYmVnaW4/OiBudW1iZXIsIGVuZD86IG51bWJlcik6IENodW5rZWQ8VD4ge1xuICAgICAgICByZXR1cm4gY2xhbXBSYW5nZSh0aGlzLCBiZWdpbiwgZW5kLCB0aGlzLl9zbGljZUludGVybmFsKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q2hpbGRBdDxSIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+KGluZGV4OiBudW1iZXIpOiBDaHVua2VkPFI+IHwgbnVsbCB7XG5cbiAgICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLl9udW1DaGlsZHJlbikgeyByZXR1cm4gbnVsbDsgfVxuXG4gICAgICAgIGxldCBjb2x1bW5zID0gdGhpcy5fY2hpbGRyZW4gfHwgKHRoaXMuX2NoaWxkcmVuID0gW10pO1xuICAgICAgICBsZXQgY2hpbGQ6IENodW5rZWQ8Uj4sIGZpZWxkOiBGaWVsZDxSPiwgY2h1bmtzOiBWZWN0b3I8Uj5bXTtcblxuICAgICAgICBpZiAoY2hpbGQgPSBjb2x1bW5zW2luZGV4XSkgeyByZXR1cm4gY2hpbGQ7IH1cbiAgICAgICAgaWYgKGZpZWxkID0gKCh0aGlzLl90eXBlLmNoaWxkcmVuIHx8IFtdKVtpbmRleF0gYXMgRmllbGQ8Uj4pKSB7XG4gICAgICAgICAgICBjaHVua3MgPSB0aGlzLl9jaHVua3NcbiAgICAgICAgICAgICAgICAubWFwKCh2ZWN0b3IpID0+IHZlY3Rvci5nZXRDaGlsZEF0PFI+KGluZGV4KSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKCh2ZWMpOiB2ZWMgaXMgVmVjdG9yPFI+ID0+IHZlYyAhPSBudWxsKTtcbiAgICAgICAgICAgIGlmIChjaHVua3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAoY29sdW1uc1tpbmRleF0gPSBuZXcgQ2h1bmtlZDxSPihmaWVsZC50eXBlLCBjaHVua3MpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZWFyY2goaW5kZXg6IG51bWJlcik6IFtudW1iZXIsIG51bWJlcl0gfCBudWxsO1xuICAgIHB1YmxpYyBzZWFyY2g8TiBleHRlbmRzIFNlYXJjaENvbnRpbnVhdGlvbjxDaHVua2VkPFQ+Pj4oaW5kZXg6IG51bWJlciwgdGhlbj86IE4pOiBSZXR1cm5UeXBlPE4+O1xuICAgIHB1YmxpYyBzZWFyY2g8TiBleHRlbmRzIFNlYXJjaENvbnRpbnVhdGlvbjxDaHVua2VkPFQ+Pj4oaW5kZXg6IG51bWJlciwgdGhlbj86IE4pIHtcbiAgICAgICAgbGV0IGlkeCA9IGluZGV4O1xuICAgICAgICAvLyBiaW5hcnkgc2VhcmNoIHRvIGZpbmQgdGhlIGNoaWxkIHZlY3RvciBhbmQgdmFsdWUgaW5kaWNlc1xuICAgICAgICBsZXQgb2Zmc2V0cyA9IHRoaXMuX2NodW5rT2Zmc2V0cywgcmhzID0gb2Zmc2V0cy5sZW5ndGggLSAxO1xuICAgICAgICAvLyByZXR1cm4gZWFybHkgaWYgb3V0IG9mIGJvdW5kcywgb3IgaWYgdGhlcmUncyBqdXN0IG9uZSBjaGlsZFxuICAgICAgICBpZiAoaWR4IDwgMCAgICAgICAgICAgICkgeyByZXR1cm4gbnVsbDsgfVxuICAgICAgICBpZiAoaWR4ID49IG9mZnNldHNbcmhzXSkgeyByZXR1cm4gbnVsbDsgfVxuICAgICAgICBpZiAocmhzIDw9IDEgICAgICAgICAgICkgeyByZXR1cm4gdGhlbiA/IHRoZW4odGhpcywgMCwgaWR4KSA6IFswLCBpZHhdOyB9XG4gICAgICAgIGxldCBsaHMgPSAwLCBwb3MgPSAwLCBtaWQgPSAwO1xuICAgICAgICBkbyB7XG4gICAgICAgICAgICBpZiAobGhzICsgMSA9PT0gcmhzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoZW4gPyB0aGVuKHRoaXMsIGxocywgaWR4IC0gcG9zKSA6IFtsaHMsIGlkeCAtIHBvc107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtaWQgPSBsaHMgKyAoKHJocyAtIGxocykgLyAyKSB8IDA7XG4gICAgICAgICAgICBpZHggPj0gb2Zmc2V0c1ttaWRdID8gKGxocyA9IG1pZCkgOiAocmhzID0gbWlkKTtcbiAgICAgICAgfSB3aGlsZSAoaWR4IDwgb2Zmc2V0c1tyaHNdICYmIGlkeCA+PSAocG9zID0gb2Zmc2V0c1tsaHNdKSk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc1ZhbGlkKGluZGV4OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5zZWFyY2goaW5kZXgsIHRoaXMuaXNWYWxpZEludGVybmFsKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0KGluZGV4OiBudW1iZXIpOiBUWydUVmFsdWUnXSB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5zZWFyY2goaW5kZXgsIHRoaXMuZ2V0SW50ZXJuYWwpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQoaW5kZXg6IG51bWJlciwgdmFsdWU6IFRbJ1RWYWx1ZSddIHwgbnVsbCk6IHZvaWQge1xuICAgICAgICB0aGlzLnNlYXJjaChpbmRleCwgKHsgY2h1bmtzIH0sIGksIGopID0+IGNodW5rc1tpXS5zZXQoaiwgdmFsdWUpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW5kZXhPZihlbGVtZW50OiBUWydUVmFsdWUnXSwgb2Zmc2V0PzogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgaWYgKG9mZnNldCAmJiB0eXBlb2Ygb2Zmc2V0ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VhcmNoKG9mZnNldCwgKHNlbGYsIGksIGopID0+IHRoaXMuaW5kZXhPZkludGVybmFsKHNlbGYsIGksIGosIGVsZW1lbnQpKSE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXhPZkludGVybmFsKHRoaXMsIDAsIE1hdGgubWF4KDAsIG9mZnNldCB8fCAwKSwgZWxlbWVudCk7XG4gICAgfVxuXG4gICAgcHVibGljIHRvQXJyYXkoKTogVFsnVEFycmF5J10ge1xuICAgICAgICBjb25zdCB7IGNodW5rcyB9ID0gdGhpcztcbiAgICAgICAgY29uc3QgbiA9IGNodW5rcy5sZW5ndGg7XG4gICAgICAgIGxldCB7IEFycmF5VHlwZSB9ID0gdGhpcy5fdHlwZTtcbiAgICAgICAgaWYgKG4gPD0gMCkgeyByZXR1cm4gbmV3IEFycmF5VHlwZSgwKTsgfVxuICAgICAgICBpZiAobiA8PSAxKSB7IHJldHVybiBjaHVua3NbMF0udG9BcnJheSgpOyB9XG4gICAgICAgIGxldCBsZW4gPSAwLCBzcmMgPSBuZXcgQXJyYXkobik7XG4gICAgICAgIGZvciAobGV0IGkgPSAtMTsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGxlbiArPSAoc3JjW2ldID0gY2h1bmtzW2ldLnRvQXJyYXkoKSkubGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChBcnJheVR5cGUgIT09IHNyY1swXS5jb25zdHJ1Y3Rvcikge1xuICAgICAgICAgICAgQXJyYXlUeXBlID0gc3JjWzBdLmNvbnN0cnVjdG9yO1xuICAgICAgICB9XG4gICAgICAgIGxldCBkc3QgPSBuZXcgKEFycmF5VHlwZSBhcyBhbnkpKGxlbik7XG4gICAgICAgIGxldCBzZXQ6IGFueSA9IEFycmF5VHlwZSA9PT0gQXJyYXkgPyBhcnJheVNldCA6IHR5cGVkU2V0O1xuICAgICAgICBmb3IgKGxldCBpID0gLTEsIGlkeCA9IDA7ICsraSA8IG47KSB7XG4gICAgICAgICAgICBpZHggPSBzZXQoc3JjW2ldLCBkc3QsIGlkeCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRzdDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0SW50ZXJuYWwoeyBfY2h1bmtzIH06IENodW5rZWQ8VD4sIGk6IG51bWJlciwgajogbnVtYmVyKSB7IHJldHVybiBfY2h1bmtzW2ldLmdldChqKTsgfVxuICAgIHByb3RlY3RlZCBpc1ZhbGlkSW50ZXJuYWwoeyBfY2h1bmtzIH06IENodW5rZWQ8VD4sIGk6IG51bWJlciwgajogbnVtYmVyKSB7IHJldHVybiBfY2h1bmtzW2ldLmlzVmFsaWQoaik7IH1cbiAgICBwcm90ZWN0ZWQgaW5kZXhPZkludGVybmFsKHsgX2NodW5rcyB9OiBDaHVua2VkPFQ+LCBjaHVua0luZGV4OiBudW1iZXIsIGZyb21JbmRleDogbnVtYmVyLCBlbGVtZW50OiBUWydUVmFsdWUnXSkge1xuICAgICAgICBsZXQgaSA9IGNodW5rSW5kZXggLSAxLCBuID0gX2NodW5rcy5sZW5ndGg7XG4gICAgICAgIGxldCBzdGFydCA9IGZyb21JbmRleCwgb2Zmc2V0ID0gMCwgZm91bmQgPSAtMTtcbiAgICAgICAgd2hpbGUgKCsraSA8IG4pIHtcbiAgICAgICAgICAgIGlmICh+KGZvdW5kID0gX2NodW5rc1tpXS5pbmRleE9mKGVsZW1lbnQsIHN0YXJ0KSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2Zmc2V0ICsgZm91bmQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGFydCA9IDA7XG4gICAgICAgICAgICBvZmZzZXQgKz0gX2NodW5rc1tpXS5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIC0xO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfc2xpY2VJbnRlcm5hbChzZWxmOiBDaHVua2VkPFQ+LCBiZWdpbjogbnVtYmVyLCBlbmQ6IG51bWJlcikge1xuICAgICAgICBjb25zdCBzbGljZXM6IFZlY3RvcjxUPltdID0gW107XG4gICAgICAgIGNvbnN0IHsgY2h1bmtzLCBfY2h1bmtPZmZzZXRzOiBjaHVua09mZnNldHMgfSA9IHNlbGY7XG4gICAgICAgIGZvciAobGV0IGkgPSAtMSwgbiA9IGNodW5rcy5sZW5ndGg7ICsraSA8IG47KSB7XG4gICAgICAgICAgICBjb25zdCBjaHVuayA9IGNodW5rc1tpXTtcbiAgICAgICAgICAgIGNvbnN0IGNodW5rTGVuZ3RoID0gY2h1bmsubGVuZ3RoO1xuICAgICAgICAgICAgY29uc3QgY2h1bmtPZmZzZXQgPSBjaHVua09mZnNldHNbaV07XG4gICAgICAgICAgICAvLyBJZiB0aGUgY2hpbGQgaXMgdG8gdGhlIHJpZ2h0IG9mIHRoZSBzbGljZSBib3VuZGFyeSwgd2UgY2FuIHN0b3BcbiAgICAgICAgICAgIGlmIChjaHVua09mZnNldCA+PSBlbmQpIHsgYnJlYWs7IH1cbiAgICAgICAgICAgIC8vIElmIHRoZSBjaGlsZCBpcyB0byB0aGUgbGVmdCBvZiBvZiB0aGUgc2xpY2UgYm91bmRhcnksIGV4Y2x1ZGVcbiAgICAgICAgICAgIGlmIChiZWdpbiA+PSBjaHVua09mZnNldCArIGNodW5rTGVuZ3RoKSB7IGNvbnRpbnVlOyB9XG4gICAgICAgICAgICAvLyBJZiB0aGUgY2hpbGQgaXMgYmV0d2VlbiBib3RoIGxlZnQgYW5kIHJpZ2h0IGJvdW5kYXJpZXMsIGluY2x1ZGUgdy9vIHNsaWNpbmdcbiAgICAgICAgICAgIGlmIChjaHVua09mZnNldCA+PSBiZWdpbiAmJiAoY2h1bmtPZmZzZXQgKyBjaHVua0xlbmd0aCkgPD0gZW5kKSB7XG4gICAgICAgICAgICAgICAgc2xpY2VzLnB1c2goY2h1bmspO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gSWYgdGhlIGNoaWxkIG92ZXJsYXBzIG9uZSBvZiB0aGUgc2xpY2UgYm91bmRhcmllcywgaW5jbHVkZSB0aGF0IHNsaWNlXG4gICAgICAgICAgICBjb25zdCBmcm9tID0gTWF0aC5tYXgoMCwgYmVnaW4gLSBjaHVua09mZnNldCk7XG4gICAgICAgICAgICBjb25zdCB0byA9IE1hdGgubWluKGVuZCAtIGNodW5rT2Zmc2V0LCBjaHVua0xlbmd0aCk7XG4gICAgICAgICAgICBzbGljZXMucHVzaChjaHVuay5zbGljZShmcm9tLCB0bykgYXMgVmVjdG9yPFQ+KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2VsZi5jbG9uZShzbGljZXMpO1xuICAgIH1cbn1cblxuLyoqIEBpZ25vcmUgKi9cbmZ1bmN0aW9uIGNhbGN1bGF0ZU9mZnNldHM8VCBleHRlbmRzIERhdGFUeXBlPih2ZWN0b3JzOiBWZWN0b3I8VD5bXSkge1xuICAgIGxldCBvZmZzZXRzID0gbmV3IFVpbnQzMkFycmF5KCh2ZWN0b3JzIHx8IFtdKS5sZW5ndGggKyAxKTtcbiAgICBsZXQgb2Zmc2V0ID0gb2Zmc2V0c1swXSA9IDAsIGxlbmd0aCA9IG9mZnNldHMubGVuZ3RoO1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgKytpbmRleCA8IGxlbmd0aDspIHtcbiAgICAgICAgb2Zmc2V0c1tpbmRleF0gPSAob2Zmc2V0ICs9IHZlY3RvcnNbaW5kZXggLSAxXS5sZW5ndGgpO1xuICAgIH1cbiAgICByZXR1cm4gb2Zmc2V0cztcbn1cblxuLyoqIEBpZ25vcmUgKi9cbmNvbnN0IHR5cGVkU2V0ID0gKHNyYzogVHlwZWRBcnJheSwgZHN0OiBUeXBlZEFycmF5LCBvZmZzZXQ6IG51bWJlcikgPT4ge1xuICAgIGRzdC5zZXQoc3JjLCBvZmZzZXQpO1xuICAgIHJldHVybiAob2Zmc2V0ICsgc3JjLmxlbmd0aCk7XG59O1xuXG4vKiogQGlnbm9yZSAqL1xuY29uc3QgYXJyYXlTZXQgPSAoc3JjOiBhbnlbXSwgZHN0OiBhbnlbXSwgb2Zmc2V0OiBudW1iZXIpID0+IHtcbiAgICBsZXQgaWR4ID0gb2Zmc2V0IC0gMTtcbiAgICBmb3IgKGxldCBpID0gLTEsIG4gPSBzcmMubGVuZ3RoOyArK2kgPCBuOykge1xuICAgICAgICBkc3RbKytpZHhdID0gc3JjW2ldO1xuICAgIH1cbiAgICByZXR1cm4gaWR4O1xufTtcblxuLyoqIEBpZ25vcmUgKi9cbmludGVyZmFjZSBUeXBlZEFycmF5IGV4dGVuZHMgQXJyYXlCdWZmZXJWaWV3IHtcbiAgICByZWFkb25seSBsZW5ndGg6IG51bWJlcjtcbiAgICByZWFkb25seSBbbjogbnVtYmVyXTogbnVtYmVyO1xuICAgIHNldChhcnJheTogQXJyYXlMaWtlPG51bWJlcj4sIG9mZnNldD86IG51bWJlcik6IHZvaWQ7XG59XG4iXX0=
