"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const vector_1 = require("../vector");
const vector_2 = require("../util/vector");
class ChunkedVector extends vector_1.Vector {
    constructor(type, chunks = [], offsets = calculateOffsets(chunks)) {
        super();
        this._nullCount = -1;
        this._type = type;
        this._chunks = chunks;
        this._chunkOffsets = offsets;
        this._length = offsets[offsets.length - 1];
        this._numChildren = (this._type.children || []).length;
    }
    /** @nocollapse */
    static flatten(...vectors) {
        return vectors.reduce(function flatten(xs, x) {
            return x instanceof ChunkedVector ? x.chunks.reduce(flatten, xs) : [...xs, x];
        }, []).filter((x) => x instanceof vector_1.Vector);
    }
    /** @nocollapse */
    static concat(...vectors) {
        return new ChunkedVector(vectors[0].type, ChunkedVector.flatten(...vectors));
    }
    get type() { return this._type; }
    get length() { return this._length; }
    get chunks() { return this._chunks; }
    get typeId() { return this._type.typeId; }
    get ArrayType() { return this._type.ArrayType; }
    get numChildren() { return this._numChildren; }
    get data() { return this._chunks[0] ? this._chunks[0].data : null; }
    get stride() { return this._chunks[0] ? this._chunks[0].stride : 1; }
    get nullCount() {
        let nullCount = this._nullCount;
        if (nullCount < 0) {
            this._nullCount = nullCount = this._chunks.reduce((x, { nullCount }) => x + nullCount, 0);
        }
        return nullCount;
    }
    *[Symbol.iterator]() {
        for (const chunk of this._chunks) {
            yield* chunk;
        }
    }
    concat(...others) {
        return ChunkedVector.concat(this, ...others);
    }
    getChildAt(index) {
        if (index < 0 || index >= this._numChildren) {
            return null;
        }
        let columns = this._children || (this._children = []);
        let child, field, chunks;
        if (child = columns[index]) {
            return child;
        }
        if (field = (this._type.children || [])[index]) {
            chunks = this._chunks
                .map((vector) => vector.getChildAt(index))
                .filter((vec) => vec != null);
            if (chunks.length > 0) {
                return (columns[index] = new ChunkedVector(field.type, chunks));
            }
        }
        return null;
    }
    search(index, then) {
        let idx = index;
        // binary search to find the child vector and value indices
        let offsets = this._chunkOffsets, rhs = offsets.length - 1;
        // return early if out of bounds, or if there's just one child
        if (idx < 0) {
            return null;
        }
        if (idx >= offsets[rhs]) {
            return null;
        }
        if (rhs <= 1) {
            return then ? then(this, 0, idx) : [0, idx];
        }
        let lhs = 0, pos = 0, mid = 0;
        do {
            if (lhs + 1 === rhs) {
                return then ? then(this, lhs, idx - pos) : [lhs, idx - pos];
            }
            mid = lhs + ((rhs - lhs) / 2) | 0;
            idx >= offsets[mid] ? (lhs = mid) : (rhs = mid);
        } while (idx < offsets[rhs] && idx >= (pos = offsets[lhs]));
        return null;
    }
    isValid(index) {
        return !!this.search(index, this.isValidInternal);
    }
    get(index) {
        return this.search(index, this.getInternal);
    }
    set(index, value) {
        this.search(index, ({ chunks }, i, j) => chunks[i].set(j, value));
    }
    indexOf(element, offset) {
        if (offset && typeof offset === 'number') {
            return this.search(offset, (self, i, j) => this.indexOfInternal(self, i, j, element));
        }
        return this.indexOfInternal(this, 0, Math.max(0, offset || 0), element);
    }
    toArray() {
        const { chunks } = this;
        const n = chunks.length;
        let { ArrayType } = this._type;
        if (n <= 0) {
            return new ArrayType(0);
        }
        if (n <= 1) {
            return chunks[0].toArray();
        }
        let len = 0, src = new Array(n);
        for (let i = -1; ++i < n;) {
            len += (src[i] = chunks[i].toArray()).length;
        }
        if (ArrayType !== src[0].constructor) {
            ArrayType = src[0].constructor;
        }
        let dst = new ArrayType(len);
        let set = ArrayType === Array ? arraySet : typedSet;
        for (let i = -1, idx = 0; ++i < n;) {
            idx = set(src[i], dst, idx);
        }
        return dst;
    }
    slice(begin, end) {
        return vector_2.clampRange(this, begin, end, this.sliceInternal);
    }
    getInternal({ _chunks }, i, j) { return _chunks[i].get(j); }
    isValidInternal({ _chunks }, i, j) { return _chunks[i].isValid(j); }
    indexOfInternal({ _chunks }, chunkIndex, fromIndex, element) {
        let i = chunkIndex - 1, n = _chunks.length;
        let start = fromIndex, offset = 0, found = -1;
        while (++i < n) {
            if (~(found = _chunks[i].indexOf(element, start))) {
                return offset + found;
            }
            start = 0;
            offset += _chunks[i].length;
        }
        return -1;
    }
    sliceInternal(column, offset, length) {
        const slices = [];
        const { type, chunks, _chunkOffsets: chunkOffsets } = column;
        for (let i = -1, n = chunks.length; ++i < n;) {
            const chunk = chunks[i];
            const chunkLength = chunk.length;
            const chunkOffset = chunkOffsets[i];
            // If the child is to the right of the slice boundary, we can stop
            if (chunkOffset >= offset + length) {
                continue;
            }
            // If the child is to the left of of the slice boundary, exclude
            if (offset >= chunkOffset + chunkLength) {
                continue;
            }
            // If the child is between both left and right boundaries, include w/o slicing
            if (chunkOffset >= offset && (chunkOffset + chunkLength) <= offset + length) {
                slices.push(chunk);
                continue;
            }
            // If the child overlaps one of the slice boundaries, include that slice
            const begin = Math.max(0, offset - chunkOffset);
            const end = begin + Math.min(chunkLength - begin, (offset + length) - chunkOffset);
            slices.push(chunk.slice(begin, end));
        }
        return new ChunkedVector(type, slices);
    }
}
exports.ChunkedVector = ChunkedVector;
function calculateOffsets(vectors) {
    let offsets = new Uint32Array((vectors || []).length + 1);
    let offset = offsets[0] = 0, length = offsets.length;
    for (let index = 0; ++index < length;) {
        offsets[index] = (offset += vectors[index - 1].length);
    }
    return offsets;
}
const typedSet = (src, dst, offset) => {
    dst.set(src, offset);
    return (offset + src.length);
};
const arraySet = (src, dst, offset) => {
    let idx = offset - 1;
    for (let i = -1, n = src.length; ++i < n;) {
        dst[++idx] = src[i];
    }
    return idx;
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUNuQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUMxRDtJQUNELE9BQU8sT0FBTyxDQUFDO0FBQ25CLENBQUM7QUFFRCxNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQWUsRUFBRSxHQUFlLEVBQUUsTUFBYyxFQUFFLEVBQUU7SUFDbEUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDckIsT0FBTyxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDakMsQ0FBQyxDQUFDO0FBRUYsTUFBTSxRQUFRLEdBQUcsQ0FBQyxHQUFVLEVBQUUsR0FBVSxFQUFFLE1BQWMsRUFBRSxFQUFFO0lBQ3hELElBQUksR0FBRyxHQUFHLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDckIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUc7UUFDdkMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3ZCO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDLENBQUMiLCJmaWxlIjoidmVjdG9yL2NodW5rZWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgRmllbGQgfSBmcm9tICcuLi9zY2hlbWEnO1xuaW1wb3J0IHsgVmVjdG9yIH0gZnJvbSAnLi4vdmVjdG9yJztcbmltcG9ydCB7IERhdGFUeXBlIH0gZnJvbSAnLi4vdHlwZSc7XG5pbXBvcnQgeyBjbGFtcFJhbmdlIH0gZnJvbSAnLi4vdXRpbC92ZWN0b3InO1xuXG50eXBlIFNlYXJjaENvbnRpbnVhdGlvbjxUIGV4dGVuZHMgQ2h1bmtlZFZlY3Rvcj4gPSAoY29sdW1uOiBULCBjaHVua0luZGV4OiBudW1iZXIsIHZhbHVlSW5kZXg6IG51bWJlcikgPT4gYW55O1xuXG5leHBvcnQgY2xhc3MgQ2h1bmtlZFZlY3RvcjxUIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+IGV4dGVuZHMgVmVjdG9yPFQ+IHtcblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZmxhdHRlbjxUIGV4dGVuZHMgRGF0YVR5cGU+KC4uLnZlY3RvcnM6IFZlY3RvcjxUPltdKSB7XG4gICAgICAgIHJldHVybiB2ZWN0b3JzLnJlZHVjZShmdW5jdGlvbiBmbGF0dGVuKHhzOiBhbnlbXSwgeDogYW55KTogYW55W10ge1xuICAgICAgICAgICAgcmV0dXJuIHggaW5zdGFuY2VvZiBDaHVua2VkVmVjdG9yID8geC5jaHVua3MucmVkdWNlKGZsYXR0ZW4sIHhzKSA6IFsuLi54cywgeF07XG4gICAgICAgIH0sIFtdKS5maWx0ZXIoKHg6IGFueSk6IHggaXMgVmVjdG9yPFQ+ID0+IHggaW5zdGFuY2VvZiBWZWN0b3IpO1xuICAgIH1cblxuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY29uY2F0PFQgZXh0ZW5kcyBEYXRhVHlwZT4oLi4udmVjdG9yczogVmVjdG9yPFQ+W10pOiBWZWN0b3I8VD4ge1xuICAgICAgICByZXR1cm4gbmV3IENodW5rZWRWZWN0b3IodmVjdG9yc1swXS50eXBlLCBDaHVua2VkVmVjdG9yLmZsYXR0ZW4oLi4udmVjdG9ycykpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfdHlwZTogVDtcbiAgICBwcm90ZWN0ZWQgX2xlbmd0aDogbnVtYmVyO1xuICAgIHByb3RlY3RlZCBfbnVtQ2hpbGRyZW46IG51bWJlcjtcbiAgICBwcm90ZWN0ZWQgX2NodW5rczogVmVjdG9yPFQ+W107XG5cbiAgICBwcm90ZWN0ZWQgX251bGxDb3VudDogbnVtYmVyID0gLTE7XG4gICAgcHJvdGVjdGVkIF9jaGlsZHJlbj86IENodW5rZWRWZWN0b3JbXTtcbiAgICBwcm90ZWN0ZWQgX2NodW5rT2Zmc2V0czogVWludDMyQXJyYXk7XG5cbiAgICBjb25zdHJ1Y3Rvcih0eXBlOlQsIGNodW5rczogVmVjdG9yPFQ+W10gPSBbXSwgb2Zmc2V0cyA9IGNhbGN1bGF0ZU9mZnNldHMoY2h1bmtzKSkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLl90eXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5fY2h1bmtzID0gY2h1bmtzO1xuICAgICAgICB0aGlzLl9jaHVua09mZnNldHMgPSBvZmZzZXRzO1xuICAgICAgICB0aGlzLl9sZW5ndGggPSBvZmZzZXRzW29mZnNldHMubGVuZ3RoIC0gMV07XG4gICAgICAgIHRoaXMuX251bUNoaWxkcmVuID0gKHRoaXMuX3R5cGUuY2hpbGRyZW4gfHwgW10pLmxlbmd0aDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHR5cGUoKSB7IHJldHVybiB0aGlzLl90eXBlOyB9XG4gICAgcHVibGljIGdldCBsZW5ndGgoKSB7IHJldHVybiB0aGlzLl9sZW5ndGg7IH1cbiAgICBwdWJsaWMgZ2V0IGNodW5rcygpIHsgcmV0dXJuIHRoaXMuX2NodW5rczsgfVxuICAgIHB1YmxpYyBnZXQgdHlwZUlkKCkgeyByZXR1cm4gdGhpcy5fdHlwZS50eXBlSWQ7IH1cblxuICAgIHB1YmxpYyBnZXQgQXJyYXlUeXBlKCkgeyByZXR1cm4gdGhpcy5fdHlwZS5BcnJheVR5cGU7IH1cbiAgICBwdWJsaWMgZ2V0IG51bUNoaWxkcmVuKCkgeyByZXR1cm4gdGhpcy5fbnVtQ2hpbGRyZW47IH1cblxuICAgIHB1YmxpYyBnZXQgZGF0YSgpIHsgcmV0dXJuIHRoaXMuX2NodW5rc1swXSA/IHRoaXMuX2NodW5rc1swXS5kYXRhIDogPGFueT4gbnVsbDsgfVxuICAgIHB1YmxpYyBnZXQgc3RyaWRlKCkgeyByZXR1cm4gdGhpcy5fY2h1bmtzWzBdID8gdGhpcy5fY2h1bmtzWzBdLnN0cmlkZSA6IDE7IH1cblxuICAgIHB1YmxpYyBnZXQgbnVsbENvdW50KCkge1xuICAgICAgICBsZXQgbnVsbENvdW50ID0gdGhpcy5fbnVsbENvdW50O1xuICAgICAgICBpZiAobnVsbENvdW50IDwgMCkge1xuICAgICAgICAgICAgdGhpcy5fbnVsbENvdW50ID0gbnVsbENvdW50ID0gdGhpcy5fY2h1bmtzLnJlZHVjZSgoeCwgeyBudWxsQ291bnQgfSkgPT4geCArIG51bGxDb3VudCwgMCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGxDb3VudDtcbiAgICB9XG5cbiAgICBwdWJsaWMgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8VFsnVFZhbHVlJ10gfCBudWxsPiB7XG4gICAgICAgIGZvciAoY29uc3QgY2h1bmsgb2YgdGhpcy5fY2h1bmtzKSB7XG4gICAgICAgICAgICB5aWVsZCogY2h1bms7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY29uY2F0KC4uLm90aGVyczogVmVjdG9yPFQ+W10pOiBWZWN0b3I8VD4ge1xuICAgICAgICByZXR1cm4gQ2h1bmtlZFZlY3Rvci5jb25jYXQ8VD4odGhpcywgLi4ub3RoZXJzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q2hpbGRBdDxSIGV4dGVuZHMgRGF0YVR5cGUgPSBhbnk+KGluZGV4OiBudW1iZXIpOiBDaHVua2VkVmVjdG9yPFI+IHwgbnVsbCB7XG5cbiAgICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLl9udW1DaGlsZHJlbikgeyByZXR1cm4gbnVsbDsgfVxuXG4gICAgICAgIGxldCBjb2x1bW5zID0gdGhpcy5fY2hpbGRyZW4gfHwgKHRoaXMuX2NoaWxkcmVuID0gW10pO1xuICAgICAgICBsZXQgY2hpbGQ6IENodW5rZWRWZWN0b3I8Uj4sIGZpZWxkOiBGaWVsZDxSPiwgY2h1bmtzOiBWZWN0b3I8Uj5bXTtcblxuICAgICAgICBpZiAoY2hpbGQgPSBjb2x1bW5zW2luZGV4XSkgeyByZXR1cm4gY2hpbGQ7IH1cbiAgICAgICAgaWYgKGZpZWxkID0gKCh0aGlzLl90eXBlLmNoaWxkcmVuIHx8IFtdKVtpbmRleF0gYXMgRmllbGQ8Uj4pKSB7XG4gICAgICAgICAgICBjaHVua3MgPSB0aGlzLl9jaHVua3NcbiAgICAgICAgICAgICAgICAubWFwKCh2ZWN0b3IpID0+IHZlY3Rvci5nZXRDaGlsZEF0PFI+KGluZGV4KSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKCh2ZWMpOiB2ZWMgaXMgVmVjdG9yPFI+ID0+IHZlYyAhPSBudWxsKTtcbiAgICAgICAgICAgIGlmIChjaHVua3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAoY29sdW1uc1tpbmRleF0gPSBuZXcgQ2h1bmtlZFZlY3RvcjxSPihmaWVsZC50eXBlLCBjaHVua3MpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZWFyY2goaW5kZXg6IG51bWJlcik6IFtudW1iZXIsIG51bWJlcl0gfCBudWxsO1xuICAgIHB1YmxpYyBzZWFyY2g8TiBleHRlbmRzIFNlYXJjaENvbnRpbnVhdGlvbjxDaHVua2VkVmVjdG9yPFQ+Pj4oaW5kZXg6IG51bWJlciwgdGhlbj86IE4pOiBSZXR1cm5UeXBlPE4+O1xuICAgIHB1YmxpYyBzZWFyY2g8TiBleHRlbmRzIFNlYXJjaENvbnRpbnVhdGlvbjxDaHVua2VkVmVjdG9yPFQ+Pj4oaW5kZXg6IG51bWJlciwgdGhlbj86IE4pIHtcbiAgICAgICAgbGV0IGlkeCA9IGluZGV4O1xuICAgICAgICAvLyBiaW5hcnkgc2VhcmNoIHRvIGZpbmQgdGhlIGNoaWxkIHZlY3RvciBhbmQgdmFsdWUgaW5kaWNlc1xuICAgICAgICBsZXQgb2Zmc2V0cyA9IHRoaXMuX2NodW5rT2Zmc2V0cywgcmhzID0gb2Zmc2V0cy5sZW5ndGggLSAxO1xuICAgICAgICAvLyByZXR1cm4gZWFybHkgaWYgb3V0IG9mIGJvdW5kcywgb3IgaWYgdGhlcmUncyBqdXN0IG9uZSBjaGlsZFxuICAgICAgICBpZiAoaWR4IDwgMCAgICAgICAgICAgICkgeyByZXR1cm4gbnVsbDsgfVxuICAgICAgICBpZiAoaWR4ID49IG9mZnNldHNbcmhzXSkgeyByZXR1cm4gbnVsbDsgfVxuICAgICAgICBpZiAocmhzIDw9IDEgICAgICAgICAgICkgeyByZXR1cm4gdGhlbiA/IHRoZW4odGhpcywgMCwgaWR4KSA6IFswLCBpZHhdOyB9XG4gICAgICAgIGxldCBsaHMgPSAwLCBwb3MgPSAwLCBtaWQgPSAwO1xuICAgICAgICBkbyB7XG4gICAgICAgICAgICBpZiAobGhzICsgMSA9PT0gcmhzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoZW4gPyB0aGVuKHRoaXMsIGxocywgaWR4IC0gcG9zKSA6IFtsaHMsIGlkeCAtIHBvc107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtaWQgPSBsaHMgKyAoKHJocyAtIGxocykgLyAyKSB8IDA7XG4gICAgICAgICAgICBpZHggPj0gb2Zmc2V0c1ttaWRdID8gKGxocyA9IG1pZCkgOiAocmhzID0gbWlkKTtcbiAgICAgICAgfSB3aGlsZSAoaWR4IDwgb2Zmc2V0c1tyaHNdICYmIGlkeCA+PSAocG9zID0gb2Zmc2V0c1tsaHNdKSk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc1ZhbGlkKGluZGV4OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5zZWFyY2goaW5kZXgsIHRoaXMuaXNWYWxpZEludGVybmFsKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0KGluZGV4OiBudW1iZXIpOiBUWydUVmFsdWUnXSB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5zZWFyY2goaW5kZXgsIHRoaXMuZ2V0SW50ZXJuYWwpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQoaW5kZXg6IG51bWJlciwgdmFsdWU6IFRbJ1RWYWx1ZSddIHwgbnVsbCk6IHZvaWQge1xuICAgICAgICB0aGlzLnNlYXJjaChpbmRleCwgKHsgY2h1bmtzIH0sIGksIGopID0+IGNodW5rc1tpXS5zZXQoaiwgdmFsdWUpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW5kZXhPZihlbGVtZW50OiBUWydUVmFsdWUnXSwgb2Zmc2V0PzogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgaWYgKG9mZnNldCAmJiB0eXBlb2Ygb2Zmc2V0ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VhcmNoKG9mZnNldCwgKHNlbGYsIGksIGopID0+IHRoaXMuaW5kZXhPZkludGVybmFsKHNlbGYsIGksIGosIGVsZW1lbnQpKSE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXhPZkludGVybmFsKHRoaXMsIDAsIE1hdGgubWF4KDAsIG9mZnNldCB8fCAwKSwgZWxlbWVudCk7XG4gICAgfVxuXG4gICAgcHVibGljIHRvQXJyYXkoKTogVFsnVEFycmF5J10ge1xuICAgICAgICBjb25zdCB7IGNodW5rcyB9ID0gdGhpcztcbiAgICAgICAgY29uc3QgbiA9IGNodW5rcy5sZW5ndGg7XG4gICAgICAgIGxldCB7IEFycmF5VHlwZSB9ID0gdGhpcy5fdHlwZTtcbiAgICAgICAgaWYgKG4gPD0gMCkgeyByZXR1cm4gbmV3IEFycmF5VHlwZSgwKTsgfVxuICAgICAgICBpZiAobiA8PSAxKSB7IHJldHVybiBjaHVua3NbMF0udG9BcnJheSgpOyB9XG4gICAgICAgIGxldCBsZW4gPSAwLCBzcmMgPSBuZXcgQXJyYXkobik7XG4gICAgICAgIGZvciAobGV0IGkgPSAtMTsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGxlbiArPSAoc3JjW2ldID0gY2h1bmtzW2ldLnRvQXJyYXkoKSkubGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChBcnJheVR5cGUgIT09IHNyY1swXS5jb25zdHJ1Y3Rvcikge1xuICAgICAgICAgICAgQXJyYXlUeXBlID0gc3JjWzBdLmNvbnN0cnVjdG9yO1xuICAgICAgICB9XG4gICAgICAgIGxldCBkc3QgPSBuZXcgKEFycmF5VHlwZSBhcyBhbnkpKGxlbik7XG4gICAgICAgIGxldCBzZXQ6IGFueSA9IEFycmF5VHlwZSA9PT0gQXJyYXkgPyBhcnJheVNldCA6IHR5cGVkU2V0O1xuICAgICAgICBmb3IgKGxldCBpID0gLTEsIGlkeCA9IDA7ICsraSA8IG47KSB7XG4gICAgICAgICAgICBpZHggPSBzZXQoc3JjW2ldLCBkc3QsIGlkeCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRzdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2xpY2UoYmVnaW4/OiBudW1iZXIsIGVuZD86IG51bWJlcik6IENodW5rZWRWZWN0b3I8VD4ge1xuICAgICAgICByZXR1cm4gY2xhbXBSYW5nZSh0aGlzLCBiZWdpbiwgZW5kLCB0aGlzLnNsaWNlSW50ZXJuYWwpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRJbnRlcm5hbCh7IF9jaHVua3MgfTogQ2h1bmtlZFZlY3RvcjxUPiwgaTogbnVtYmVyLCBqOiBudW1iZXIpIHsgcmV0dXJuIF9jaHVua3NbaV0uZ2V0KGopOyB9XG4gICAgcHJvdGVjdGVkIGlzVmFsaWRJbnRlcm5hbCh7IF9jaHVua3MgfTogQ2h1bmtlZFZlY3RvcjxUPiwgaTogbnVtYmVyLCBqOiBudW1iZXIpIHsgcmV0dXJuIF9jaHVua3NbaV0uaXNWYWxpZChqKTsgfVxuICAgIHByb3RlY3RlZCBpbmRleE9mSW50ZXJuYWwoeyBfY2h1bmtzIH06IENodW5rZWRWZWN0b3I8VD4sIGNodW5rSW5kZXg6IG51bWJlciwgZnJvbUluZGV4OiBudW1iZXIsIGVsZW1lbnQ6IFRbJ1RWYWx1ZSddKSB7XG4gICAgICAgIGxldCBpID0gY2h1bmtJbmRleCAtIDEsIG4gPSBfY2h1bmtzLmxlbmd0aDtcbiAgICAgICAgbGV0IHN0YXJ0ID0gZnJvbUluZGV4LCBvZmZzZXQgPSAwLCBmb3VuZCA9IC0xO1xuICAgICAgICB3aGlsZSAoKytpIDwgbikge1xuICAgICAgICAgICAgaWYgKH4oZm91bmQgPSBfY2h1bmtzW2ldLmluZGV4T2YoZWxlbWVudCwgc3RhcnQpKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBvZmZzZXQgKyBmb3VuZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXJ0ID0gMDtcbiAgICAgICAgICAgIG9mZnNldCArPSBfY2h1bmtzW2ldLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gLTE7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHNsaWNlSW50ZXJuYWwoY29sdW1uOiBDaHVua2VkVmVjdG9yPFQ+LCBvZmZzZXQ6IG51bWJlciwgbGVuZ3RoOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3Qgc2xpY2VzOiBWZWN0b3I8VD5bXSA9IFtdO1xuICAgICAgICBjb25zdCB7IHR5cGUsIGNodW5rcywgX2NodW5rT2Zmc2V0czogY2h1bmtPZmZzZXRzIH0gPSBjb2x1bW47XG4gICAgICAgIGZvciAobGV0IGkgPSAtMSwgbiA9IGNodW5rcy5sZW5ndGg7ICsraSA8IG47KSB7XG4gICAgICAgICAgICBjb25zdCBjaHVuayA9IGNodW5rc1tpXTtcbiAgICAgICAgICAgIGNvbnN0IGNodW5rTGVuZ3RoID0gY2h1bmsubGVuZ3RoO1xuICAgICAgICAgICAgY29uc3QgY2h1bmtPZmZzZXQgPSBjaHVua09mZnNldHNbaV07XG4gICAgICAgICAgICAvLyBJZiB0aGUgY2hpbGQgaXMgdG8gdGhlIHJpZ2h0IG9mIHRoZSBzbGljZSBib3VuZGFyeSwgd2UgY2FuIHN0b3BcbiAgICAgICAgICAgIGlmIChjaHVua09mZnNldCA+PSBvZmZzZXQgKyBsZW5ndGgpIHsgY29udGludWU7IH1cbiAgICAgICAgICAgIC8vIElmIHRoZSBjaGlsZCBpcyB0byB0aGUgbGVmdCBvZiBvZiB0aGUgc2xpY2UgYm91bmRhcnksIGV4Y2x1ZGVcbiAgICAgICAgICAgIGlmIChvZmZzZXQgPj0gY2h1bmtPZmZzZXQgKyBjaHVua0xlbmd0aCkgeyBjb250aW51ZTsgfVxuICAgICAgICAgICAgLy8gSWYgdGhlIGNoaWxkIGlzIGJldHdlZW4gYm90aCBsZWZ0IGFuZCByaWdodCBib3VuZGFyaWVzLCBpbmNsdWRlIHcvbyBzbGljaW5nXG4gICAgICAgICAgICBpZiAoY2h1bmtPZmZzZXQgPj0gb2Zmc2V0ICYmIChjaHVua09mZnNldCArIGNodW5rTGVuZ3RoKSA8PSBvZmZzZXQgKyBsZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBzbGljZXMucHVzaChjaHVuayk7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBJZiB0aGUgY2hpbGQgb3ZlcmxhcHMgb25lIG9mIHRoZSBzbGljZSBib3VuZGFyaWVzLCBpbmNsdWRlIHRoYXQgc2xpY2VcbiAgICAgICAgICAgIGNvbnN0IGJlZ2luID0gTWF0aC5tYXgoMCwgb2Zmc2V0IC0gY2h1bmtPZmZzZXQpO1xuICAgICAgICAgICAgY29uc3QgZW5kID0gYmVnaW4gKyBNYXRoLm1pbihjaHVua0xlbmd0aCAtIGJlZ2luLCAob2Zmc2V0ICsgbGVuZ3RoKSAtIGNodW5rT2Zmc2V0KTtcbiAgICAgICAgICAgIHNsaWNlcy5wdXNoKGNodW5rLnNsaWNlKGJlZ2luLCBlbmQpIGFzIFZlY3RvcjxUPik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBDaHVua2VkVmVjdG9yKHR5cGUsIHNsaWNlcyk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVPZmZzZXRzPFQgZXh0ZW5kcyBEYXRhVHlwZT4odmVjdG9yczogVmVjdG9yPFQ+W10pIHtcbiAgICBsZXQgb2Zmc2V0cyA9IG5ldyBVaW50MzJBcnJheSgodmVjdG9ycyB8fCBbXSkubGVuZ3RoICsgMSk7XG4gICAgbGV0IG9mZnNldCA9IG9mZnNldHNbMF0gPSAwLCBsZW5ndGggPSBvZmZzZXRzLmxlbmd0aDtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7ICsraW5kZXggPCBsZW5ndGg7KSB7XG4gICAgICAgIG9mZnNldHNbaW5kZXhdID0gKG9mZnNldCArPSB2ZWN0b3JzW2luZGV4IC0gMV0ubGVuZ3RoKTtcbiAgICB9XG4gICAgcmV0dXJuIG9mZnNldHM7XG59XG5cbmNvbnN0IHR5cGVkU2V0ID0gKHNyYzogVHlwZWRBcnJheSwgZHN0OiBUeXBlZEFycmF5LCBvZmZzZXQ6IG51bWJlcikgPT4ge1xuICAgIGRzdC5zZXQoc3JjLCBvZmZzZXQpO1xuICAgIHJldHVybiAob2Zmc2V0ICsgc3JjLmxlbmd0aCk7XG59O1xuXG5jb25zdCBhcnJheVNldCA9IChzcmM6IGFueVtdLCBkc3Q6IGFueVtdLCBvZmZzZXQ6IG51bWJlcikgPT4ge1xuICAgIGxldCBpZHggPSBvZmZzZXQgLSAxO1xuICAgIGZvciAobGV0IGkgPSAtMSwgbiA9IHNyYy5sZW5ndGg7ICsraSA8IG47KSB7XG4gICAgICAgIGRzdFsrK2lkeF0gPSBzcmNbaV07XG4gICAgfVxuICAgIHJldHVybiBpZHg7XG59O1xuXG5pbnRlcmZhY2UgVHlwZWRBcnJheSBleHRlbmRzIEFycmF5QnVmZmVyVmlldyB7XG4gICAgcmVhZG9ubHkgbGVuZ3RoOiBudW1iZXI7XG4gICAgcmVhZG9ubHkgW246IG51bWJlcl06IG51bWJlcjtcbiAgICBzZXQoYXJyYXk6IEFycmF5TGlrZTxudW1iZXI+LCBvZmZzZXQ/OiBudW1iZXIpOiB2b2lkO1xufVxuIl19
