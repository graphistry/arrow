"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const schema_1 = require("../schema");
const type_1 = require("../type");
const pretty_1 = require("../util/pretty");
/** @ignore */ const columnDescriptor = { enumerable: true, configurable: false, get: () => { } };
/** @ignore */ const lengthDescriptor = { writable: false, enumerable: false, configurable: false, value: -1 };
/** @ignore */ const rowIndexDescriptor = { writable: false, enumerable: false, configurable: true, value: null };
/** @ignore */ const rowParentDescriptor = { writable: false, enumerable: false, configurable: false, value: null };
/** @ignore */ const row = { parent: rowParentDescriptor, rowIndex: rowIndexDescriptor };
/** @ignore */
class Row {
    constructor(fields, fieldsAreEnumerable) {
        lengthDescriptor.value = fields.length;
        Object.defineProperty(this, 'length', lengthDescriptor);
        fields.forEach((field, columnIndex) => {
            columnDescriptor.get = this._bindGetter(columnIndex);
            // set configurable to true to ensure Object.defineProperty
            // doesn't throw in the case of duplicate column names
            columnDescriptor.configurable = true;
            columnDescriptor.enumerable = fieldsAreEnumerable;
            Object.defineProperty(this, field.name, columnDescriptor);
            columnDescriptor.configurable = false;
            columnDescriptor.enumerable = !fieldsAreEnumerable;
            Object.defineProperty(this, columnIndex, columnDescriptor);
            columnDescriptor.get = null;
        });
    }
    /** @nocollapse */
    static new(schemaOrFields, fieldsAreEnumerable = false) {
        let schema, fields;
        if (Array.isArray(schemaOrFields)) {
            fields = schemaOrFields;
        }
        else {
            schema = schemaOrFields;
            fieldsAreEnumerable = true;
            fields = Object.keys(schema).map((x) => new schema_1.Field(x, schema[x]));
        }
        return new Row(fields, fieldsAreEnumerable);
    }
    *[Symbol.iterator]() {
        for (let i = -1, n = this.length; ++i < n;) {
            yield this[i];
        }
    }
    _bindGetter(colIndex) {
        return function () {
            let child = this.parent.getChildAt(colIndex);
            return child ? child.get(this.rowIndex) : null;
        };
    }
    get(key) { return this[key]; }
    bind(parent, rowIndex) {
        rowIndexDescriptor.value = rowIndex;
        rowParentDescriptor.value = parent;
        const bound = Object.create(this, row);
        rowIndexDescriptor.value = null;
        rowParentDescriptor.value = null;
        return bound;
    }
    toJSON() {
        return type_1.DataType.isStruct(this.parent.type) ? [...this] :
            Object.getOwnPropertyNames(this).reduce((props, prop) => {
                return (props[prop] = this[prop]) && props || props;
            }, {});
    }
    toString() {
        return type_1.DataType.isStruct(this.parent.type) ?
            [...this].map((x) => pretty_1.valueToString(x)).join(', ') :
            Object.getOwnPropertyNames(this).reduce((props, prop) => {
                return (props[prop] = pretty_1.valueToString(this[prop])) && props || props;
            }, {});
    }
}
exports.Row = Row;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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ZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IEZpZWxkIH0gZnJvbSAnLi4vc2NoZW1hJztcbmltcG9ydCB7IE1hcFZlY3RvciB9IGZyb20gJy4uL3ZlY3Rvci9tYXAnO1xuaW1wb3J0IHsgRGF0YVR5cGUsIFJvd0xpa2UgfSBmcm9tICcuLi90eXBlJztcbmltcG9ydCB7IHZhbHVlVG9TdHJpbmcgfSBmcm9tICcuLi91dGlsL3ByZXR0eSc7XG5pbXBvcnQgeyBTdHJ1Y3RWZWN0b3IgfSBmcm9tICcuLi92ZWN0b3Ivc3RydWN0JztcblxuLyoqIEBpZ25vcmUgKi8gY29uc3QgY29sdW1uRGVzY3JpcHRvciA9IHsgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiBmYWxzZSwgZ2V0OiAoKSA9PiB7fSB9O1xuLyoqIEBpZ25vcmUgKi8gY29uc3QgbGVuZ3RoRGVzY3JpcHRvciA9IHsgd3JpdGFibGU6IGZhbHNlLCBlbnVtZXJhYmxlOiBmYWxzZSwgY29uZmlndXJhYmxlOiBmYWxzZSwgdmFsdWU6IC0xIH07XG4vKiogQGlnbm9yZSAqLyBjb25zdCByb3dJbmRleERlc2NyaXB0b3IgPSB7IHdyaXRhYmxlOiBmYWxzZSwgZW51bWVyYWJsZTogZmFsc2UsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgdmFsdWU6IG51bGwgYXMgYW55IH07XG4vKiogQGlnbm9yZSAqLyBjb25zdCByb3dQYXJlbnREZXNjcmlwdG9yID0geyB3cml0YWJsZTogZmFsc2UsIGVudW1lcmFibGU6IGZhbHNlLCBjb25maWd1cmFibGU6IGZhbHNlLCB2YWx1ZTogbnVsbCBhcyBhbnkgfTtcbi8qKiBAaWdub3JlICovIGNvbnN0IHJvdyA9IHsgcGFyZW50OiByb3dQYXJlbnREZXNjcmlwdG9yLCByb3dJbmRleDogcm93SW5kZXhEZXNjcmlwdG9yIH07XG5cbi8qKiBAaWdub3JlICovXG5leHBvcnQgY2xhc3MgUm93PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0+IGltcGxlbWVudHMgSXRlcmFibGU8VFtrZXlvZiBUXVsnVFZhbHVlJ10+IHtcbiAgICBba2V5OiBzdHJpbmddOiBUW2tleW9mIFRdWydUVmFsdWUnXTtcbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBwdWJsaWMgc3RhdGljIG5ldzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9PihzY2hlbWFPckZpZWxkczogVCB8IEZpZWxkW10sIGZpZWxkc0FyZUVudW1lcmFibGUgPSBmYWxzZSk6IFJvd0xpa2U8VD4gJiBSb3c8VD4ge1xuICAgICAgICBsZXQgc2NoZW1hOiBULCBmaWVsZHM6IEZpZWxkW107XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNjaGVtYU9yRmllbGRzKSkge1xuICAgICAgICAgICAgZmllbGRzID0gc2NoZW1hT3JGaWVsZHM7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzY2hlbWEgPSBzY2hlbWFPckZpZWxkcztcbiAgICAgICAgICAgIGZpZWxkc0FyZUVudW1lcmFibGUgPSB0cnVlO1xuICAgICAgICAgICAgZmllbGRzID0gT2JqZWN0LmtleXMoc2NoZW1hKS5tYXAoKHgpID0+IG5ldyBGaWVsZCh4LCBzY2hlbWFbeF0pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFJvdzxUPihmaWVsZHMsIGZpZWxkc0FyZUVudW1lcmFibGUpIGFzIFJvd0xpa2U8VD4gJiBSb3c8VD47XG4gICAgfVxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwcml2YXRlIHBhcmVudDogVFBhcmVudDtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJpdmF0ZSByb3dJbmRleDogbnVtYmVyO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwdWJsaWMgcmVhZG9ubHkgbGVuZ3RoOiBudW1iZXI7XG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihmaWVsZHM6IEZpZWxkW10sIGZpZWxkc0FyZUVudW1lcmFibGU6IGJvb2xlYW4pIHtcbiAgICAgICAgbGVuZ3RoRGVzY3JpcHRvci52YWx1ZSA9IGZpZWxkcy5sZW5ndGg7XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnbGVuZ3RoJywgbGVuZ3RoRGVzY3JpcHRvcik7XG4gICAgICAgIGZpZWxkcy5mb3JFYWNoKChmaWVsZCwgY29sdW1uSW5kZXgpID0+IHtcbiAgICAgICAgICAgIGNvbHVtbkRlc2NyaXB0b3IuZ2V0ID0gdGhpcy5fYmluZEdldHRlcihjb2x1bW5JbmRleCk7XG4gICAgICAgICAgICAvLyBzZXQgY29uZmlndXJhYmxlIHRvIHRydWUgdG8gZW5zdXJlIE9iamVjdC5kZWZpbmVQcm9wZXJ0eVxuICAgICAgICAgICAgLy8gZG9lc24ndCB0aHJvdyBpbiB0aGUgY2FzZSBvZiBkdXBsaWNhdGUgY29sdW1uIG5hbWVzXG4gICAgICAgICAgICBjb2x1bW5EZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7XG4gICAgICAgICAgICBjb2x1bW5EZXNjcmlwdG9yLmVudW1lcmFibGUgPSBmaWVsZHNBcmVFbnVtZXJhYmxlO1xuICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIGZpZWxkLm5hbWUsIGNvbHVtbkRlc2NyaXB0b3IpO1xuICAgICAgICAgICAgY29sdW1uRGVzY3JpcHRvci5jb25maWd1cmFibGUgPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbHVtbkRlc2NyaXB0b3IuZW51bWVyYWJsZSA9ICFmaWVsZHNBcmVFbnVtZXJhYmxlO1xuICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIGNvbHVtbkluZGV4LCBjb2x1bW5EZXNjcmlwdG9yKTtcbiAgICAgICAgICAgIGNvbHVtbkRlc2NyaXB0b3IuZ2V0ID0gbnVsbCBhcyBhbnk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAqW1N5bWJvbC5pdGVyYXRvcl0odGhpczogUm93TGlrZTxUPikge1xuICAgICAgICBmb3IgKGxldCBpID0gLTEsIG4gPSB0aGlzLmxlbmd0aDsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIHlpZWxkIHRoaXNbaV07XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBfYmluZEdldHRlcihjb2xJbmRleDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAodGhpczogUm93PFQ+KSB7XG4gICAgICAgICAgICBsZXQgY2hpbGQgPSB0aGlzLnBhcmVudC5nZXRDaGlsZEF0KGNvbEluZGV4KTtcbiAgICAgICAgICAgIHJldHVybiBjaGlsZCA/IGNoaWxkLmdldCh0aGlzLnJvd0luZGV4KSA6IG51bGw7XG4gICAgICAgIH07XG4gICAgfVxuICAgIHB1YmxpYyBnZXQ8SyBleHRlbmRzIGtleW9mIFQ+KGtleTogSykgeyByZXR1cm4gKHRoaXMgYXMgYW55KVtrZXldIGFzIFRbS11bJ1RWYWx1ZSddOyB9XG4gICAgcHVibGljIGJpbmQ8VFBhcmVudCBleHRlbmRzIE1hcFZlY3RvcjxUPiB8IFN0cnVjdFZlY3RvcjxUPj4ocGFyZW50OiBUUGFyZW50LCByb3dJbmRleDogbnVtYmVyKSB7XG4gICAgICAgIHJvd0luZGV4RGVzY3JpcHRvci52YWx1ZSA9IHJvd0luZGV4O1xuICAgICAgICByb3dQYXJlbnREZXNjcmlwdG9yLnZhbHVlID0gcGFyZW50O1xuICAgICAgICBjb25zdCBib3VuZCA9IE9iamVjdC5jcmVhdGUodGhpcywgcm93KTtcbiAgICAgICAgcm93SW5kZXhEZXNjcmlwdG9yLnZhbHVlID0gbnVsbDtcbiAgICAgICAgcm93UGFyZW50RGVzY3JpcHRvci52YWx1ZSA9IG51bGw7XG4gICAgICAgIHJldHVybiBib3VuZCBhcyBSb3dMaWtlPFQ+O1xuICAgIH1cbiAgICBwdWJsaWMgdG9KU09OKCk6IGFueSB7XG4gICAgICAgIHJldHVybiBEYXRhVHlwZS5pc1N0cnVjdCh0aGlzLnBhcmVudC50eXBlKSA/IFsuLi50aGlzXSA6XG4gICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0aGlzKS5yZWR1Y2UoKHByb3BzOiBhbnksIHByb3A6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAocHJvcHNbcHJvcF0gPSAodGhpcyBhcyBhbnkpW3Byb3BdKSAmJiBwcm9wcyB8fCBwcm9wcztcbiAgICAgICAgICAgIH0sIHt9KTtcbiAgICB9XG4gICAgcHVibGljIHRvU3RyaW5nKCkge1xuICAgICAgICByZXR1cm4gRGF0YVR5cGUuaXNTdHJ1Y3QodGhpcy5wYXJlbnQudHlwZSkgP1xuICAgICAgICAgICAgWy4uLnRoaXNdLm1hcCgoeCkgPT4gdmFsdWVUb1N0cmluZyh4KSkuam9pbignLCAnKSA6XG4gICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0aGlzKS5yZWR1Y2UoKHByb3BzOiBhbnksIHByb3A6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAocHJvcHNbcHJvcF0gPSB2YWx1ZVRvU3RyaW5nKCh0aGlzIGFzIGFueSlbcHJvcF0pKSAmJiBwcm9wcyB8fCBwcm9wcztcbiAgICAgICAgICAgIH0sIHt9KTtcbiAgICB9XG59XG4iXX0=
