"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const schema_1 = require("../schema");
const type_1 = require("../type");
const pretty_1 = require("../util/pretty");
const columnDescriptor = { enumerable: true, configurable: false, get: () => { } };
const lengthDescriptor = { writable: false, enumerable: false, configurable: false, value: -1 };
const rowIndexDescriptor = { writable: false, enumerable: false, configurable: true, value: null };
const rowParentDescriptor = { writable: false, enumerable: false, configurable: false, value: null };
const row = { parent: rowParentDescriptor, rowIndex: rowIndexDescriptor };
class Row {
    constructor(fields, fieldsAreEnumerable) {
        lengthDescriptor.value = fields.length;
        Object.defineProperty(this, 'length', lengthDescriptor);
        fields.forEach((field, columnIndex) => {
            columnDescriptor.get = this._bindGetter(columnIndex);
            // set configurable to true to ensure Object.defineProperty
            // doesn't throw in the case of duplicate column names
            columnDescriptor.configurable = true;
            columnDescriptor.enumerable = fieldsAreEnumerable;
            Object.defineProperty(this, field.name, columnDescriptor);
            columnDescriptor.configurable = false;
            columnDescriptor.enumerable = !fieldsAreEnumerable;
            Object.defineProperty(this, columnIndex, columnDescriptor);
            columnDescriptor.get = null;
        });
    }
    /** @nocollapse */
    static new(schemaOrFields, fieldsAreEnumerable = false) {
        let schema, fields;
        if (Array.isArray(schemaOrFields)) {
            fields = schemaOrFields;
        }
        else {
            schema = schemaOrFields;
            fieldsAreEnumerable = true;
            fields = Object.keys(schema).map((x) => new schema_1.Field(x, schema[x]));
        }
        return new Row(fields, fieldsAreEnumerable);
    }
    *[Symbol.iterator]() {
        for (let i = -1, n = this.length; ++i < n;) {
            yield this[i];
        }
    }
    _bindGetter(colIndex) {
        return function () {
            let child = this.parent.getChildAt(colIndex);
            return child ? child.get(this.rowIndex) : null;
        };
    }
    get(key) { return this[key]; }
    bind(parent, rowIndex) {
        rowIndexDescriptor.value = rowIndex;
        rowParentDescriptor.value = parent;
        const bound = Object.create(this, row);
        rowIndexDescriptor.value = null;
        rowParentDescriptor.value = null;
        return bound;
    }
    toJSON() {
        return type_1.DataType.isStruct(this.parent.type) ? [...this] :
            Object.getOwnPropertyNames(this).reduce((props, prop) => {
                return (props[prop] = this[prop]) && props || props;
            }, {});
    }
    toString() {
        return type_1.DataType.isStruct(this.parent.type) ?
            [...this].map((x) => pretty_1.valueToString(x)).join(', ') :
            Object.getOwnPropertyNames(this).reduce((props, prop) => {
                return (props[prop] = pretty_1.valueToString(this[prop])) && props || props;
            }, {});
    }
}
exports.Row = Row;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUM7SUFDTSxNQUFNO1FBQ1QsT0FBTyxlQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFVLEVBQUUsSUFBWSxFQUFFLEVBQUU7Z0JBQ2pFLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUksSUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQTtZQUNoRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDZixDQUFDO0lBQ00sUUFBUTtRQUNYLE9BQU8sZUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDeEMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsc0JBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ25ELE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFVLEVBQUUsSUFBWSxFQUFFLEVBQUU7Z0JBQ2pFLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsc0JBQWEsQ0FBRSxJQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUE7WUFDL0UsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2YsQ0FBQztDQUNKO0FBcEVELGtCQW9FQyIsImZpbGUiOiJ2ZWN0b3Ivcm93LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IEZpZWxkIH0gZnJvbSAnLi4vc2NoZW1hJztcbmltcG9ydCB7IE1hcFZlY3RvciB9IGZyb20gJy4uL3ZlY3Rvci9tYXAnO1xuaW1wb3J0IHsgRGF0YVR5cGUsIFJvd0xpa2UgfSBmcm9tICcuLi90eXBlJztcbmltcG9ydCB7IHZhbHVlVG9TdHJpbmcgfSBmcm9tICcuLi91dGlsL3ByZXR0eSc7XG5pbXBvcnQgeyBTdHJ1Y3RWZWN0b3IgfSBmcm9tICcuLi92ZWN0b3Ivc3RydWN0JztcblxuY29uc3QgY29sdW1uRGVzY3JpcHRvciA9IHsgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiBmYWxzZSwgZ2V0OiAoKSA9PiB7fSB9O1xuY29uc3QgbGVuZ3RoRGVzY3JpcHRvciA9IHsgd3JpdGFibGU6IGZhbHNlLCBlbnVtZXJhYmxlOiBmYWxzZSwgY29uZmlndXJhYmxlOiBmYWxzZSwgdmFsdWU6IC0xIH07XG5jb25zdCByb3dJbmRleERlc2NyaXB0b3IgPSB7IHdyaXRhYmxlOiBmYWxzZSwgZW51bWVyYWJsZTogZmFsc2UsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgdmFsdWU6IG51bGwgYXMgYW55IH07XG5jb25zdCByb3dQYXJlbnREZXNjcmlwdG9yID0geyB3cml0YWJsZTogZmFsc2UsIGVudW1lcmFibGU6IGZhbHNlLCBjb25maWd1cmFibGU6IGZhbHNlLCB2YWx1ZTogbnVsbCBhcyBhbnkgfTtcbmNvbnN0IHJvdyA9IHsgcGFyZW50OiByb3dQYXJlbnREZXNjcmlwdG9yLCByb3dJbmRleDogcm93SW5kZXhEZXNjcmlwdG9yIH07XG5cbmV4cG9ydCBjbGFzcyBSb3c8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfT4gaW1wbGVtZW50cyBJdGVyYWJsZTxUW2tleW9mIFRdWydUVmFsdWUnXT4ge1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgbmV3PFQgZXh0ZW5kcyB7IFtrZXk6IHN0cmluZ106IERhdGFUeXBlIH0+KHNjaGVtYU9yRmllbGRzOiBUIHwgRmllbGRbXSwgZmllbGRzQXJlRW51bWVyYWJsZSA9IGZhbHNlKTogUm93TGlrZTxUPiAmIFJvdzxUPiB7XG4gICAgICAgIGxldCBzY2hlbWE6IFQsIGZpZWxkczogRmllbGRbXTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2NoZW1hT3JGaWVsZHMpKSB7XG4gICAgICAgICAgICBmaWVsZHMgPSBzY2hlbWFPckZpZWxkcztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNjaGVtYSA9IHNjaGVtYU9yRmllbGRzO1xuICAgICAgICAgICAgZmllbGRzQXJlRW51bWVyYWJsZSA9IHRydWU7XG4gICAgICAgICAgICBmaWVsZHMgPSBPYmplY3Qua2V5cyhzY2hlbWEpLm1hcCgoeCkgPT4gbmV3IEZpZWxkKHgsIHNjaGVtYVt4XSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgUm93PFQ+KGZpZWxkcywgZmllbGRzQXJlRW51bWVyYWJsZSkgYXMgUm93TGlrZTxUPiAmIFJvdzxUPjtcbiAgICB9XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHByaXZhdGUgcGFyZW50OiBUUGFyZW50O1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwcml2YXRlIHJvd0luZGV4OiBudW1iZXI7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHB1YmxpYyByZWFkb25seSBsZW5ndGg6IG51bWJlcjtcbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKGZpZWxkczogRmllbGRbXSwgZmllbGRzQXJlRW51bWVyYWJsZTogYm9vbGVhbikge1xuICAgICAgICBsZW5ndGhEZXNjcmlwdG9yLnZhbHVlID0gZmllbGRzLmxlbmd0aDtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdsZW5ndGgnLCBsZW5ndGhEZXNjcmlwdG9yKTtcbiAgICAgICAgZmllbGRzLmZvckVhY2goKGZpZWxkLCBjb2x1bW5JbmRleCkgPT4ge1xuICAgICAgICAgICAgY29sdW1uRGVzY3JpcHRvci5nZXQgPSB0aGlzLl9iaW5kR2V0dGVyKGNvbHVtbkluZGV4KTtcbiAgICAgICAgICAgIC8vIHNldCBjb25maWd1cmFibGUgdG8gdHJ1ZSB0byBlbnN1cmUgT2JqZWN0LmRlZmluZVByb3BlcnR5XG4gICAgICAgICAgICAvLyBkb2Vzbid0IHRocm93IGluIHRoZSBjYXNlIG9mIGR1cGxpY2F0ZSBjb2x1bW4gbmFtZXNcbiAgICAgICAgICAgIGNvbHVtbkRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbHVtbkRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGZpZWxkc0FyZUVudW1lcmFibGU7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgZmllbGQubmFtZSwgY29sdW1uRGVzY3JpcHRvcik7XG4gICAgICAgICAgICBjb2x1bW5EZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgY29sdW1uRGVzY3JpcHRvci5lbnVtZXJhYmxlID0gIWZpZWxkc0FyZUVudW1lcmFibGU7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgY29sdW1uSW5kZXgsIGNvbHVtbkRlc2NyaXB0b3IpO1xuICAgICAgICAgICAgY29sdW1uRGVzY3JpcHRvci5nZXQgPSBudWxsIGFzIGFueTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgICpbU3ltYm9sLml0ZXJhdG9yXSh0aGlzOiBSb3dMaWtlPFQ+KSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAtMSwgbiA9IHRoaXMubGVuZ3RoOyArK2kgPCBuOykge1xuICAgICAgICAgICAgeWllbGQgdGhpc1tpXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcml2YXRlIF9iaW5kR2V0dGVyKGNvbEluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aGlzOiBSb3c8VD4pIHtcbiAgICAgICAgICAgIGxldCBjaGlsZCA9IHRoaXMucGFyZW50LmdldENoaWxkQXQoY29sSW5kZXgpO1xuICAgICAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuZ2V0KHRoaXMucm93SW5kZXgpIDogbnVsbDtcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcHVibGljIGdldDxLIGV4dGVuZHMga2V5b2YgVD4oa2V5OiBLKSB7IHJldHVybiAodGhpcyBhcyBhbnkpW2tleV0gYXMgVFtLXVsnVFZhbHVlJ107IH1cbiAgICBwdWJsaWMgYmluZDxUUGFyZW50IGV4dGVuZHMgTWFwVmVjdG9yPFQ+IHwgU3RydWN0VmVjdG9yPFQ+PihwYXJlbnQ6IFRQYXJlbnQsIHJvd0luZGV4OiBudW1iZXIpIHtcbiAgICAgICAgcm93SW5kZXhEZXNjcmlwdG9yLnZhbHVlID0gcm93SW5kZXg7XG4gICAgICAgIHJvd1BhcmVudERlc2NyaXB0b3IudmFsdWUgPSBwYXJlbnQ7XG4gICAgICAgIGNvbnN0IGJvdW5kID0gT2JqZWN0LmNyZWF0ZSh0aGlzLCByb3cpO1xuICAgICAgICByb3dJbmRleERlc2NyaXB0b3IudmFsdWUgPSBudWxsO1xuICAgICAgICByb3dQYXJlbnREZXNjcmlwdG9yLnZhbHVlID0gbnVsbDtcbiAgICAgICAgcmV0dXJuIGJvdW5kIGFzIFJvd0xpa2U8VD47XG4gICAgfVxuICAgIHB1YmxpYyB0b0pTT04oKTogYW55IHtcbiAgICAgICAgcmV0dXJuIERhdGFUeXBlLmlzU3RydWN0KHRoaXMucGFyZW50LnR5cGUpID8gWy4uLnRoaXNdIDpcbiAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRoaXMpLnJlZHVjZSgocHJvcHM6IGFueSwgcHJvcDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChwcm9wc1twcm9wXSA9ICh0aGlzIGFzIGFueSlbcHJvcF0pICYmIHByb3BzIHx8IHByb3BzXG4gICAgICAgICAgICB9LCB7fSk7XG4gICAgfVxuICAgIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICAgICAgcmV0dXJuIERhdGFUeXBlLmlzU3RydWN0KHRoaXMucGFyZW50LnR5cGUpID9cbiAgICAgICAgICAgIFsuLi50aGlzXS5tYXAoKHgpID0+IHZhbHVlVG9TdHJpbmcoeCkpLmpvaW4oJywgJykgOlxuICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModGhpcykucmVkdWNlKChwcm9wczogYW55LCBwcm9wOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKHByb3BzW3Byb3BdID0gdmFsdWVUb1N0cmluZygodGhpcyBhcyBhbnkpW3Byb3BdKSkgJiYgcHJvcHMgfHwgcHJvcHNcbiAgICAgICAgICAgIH0sIHt9KTtcbiAgICB9XG59XG4iXX0=
