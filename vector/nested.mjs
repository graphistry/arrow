// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import { Vector } from '../vector';
import { valueToString } from '../util/pretty';
export class NestedView {
    constructor(data, children) {
        this.length = data.length;
        this.childData = data.childData;
        this.numChildren = data.childData.length;
        this._children = children || new Array(this.numChildren);
    }
    clone(data) {
        return new this.constructor(data, this._children);
    }
    isValid() {
        return true;
    }
    toArray() {
        return [...this];
    }
    indexOf(_) {
        throw new Error(`Not implemented yet`);
    }
    toJSON() { return this.toArray(); }
    toString() {
        return [...this].map((x) => valueToString(x)).join(', ');
    }
    get(index) {
        return this.getNested(this, index);
    }
    set(index, value) {
        return this.setNested(this, index, value);
    }
    getChildAt(index) {
        return index < 0 || index >= this.numChildren
            ? null
            : this._children[index] ||
                (this._children[index] = Vector.create(this.childData[index]));
    }
    *[Symbol.iterator]() {
        const get = this.getNested;
        const length = this.length;
        for (let index = -1; ++index < length;) {
            yield get(this, index);
        }
    }
}
export class UnionView extends NestedView {
    constructor(data, children) {
        super(data, children);
        this.length = data.length;
        this.typeIds = data.typeIds;
        this.typeIdToChildIndex = data.typeIdToChildIndex;
    }
    getNested(self, index) {
        return self.getChildValue(self, index, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    setNested(self, index, value) {
        return self.setChildValue(self, index, value, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    getChildValue(self, index, typeIds, _valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.get(index) : null;
    }
    setChildValue(self, index, value, typeIds, _valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.set(index, value) : null;
    }
    *[Symbol.iterator]() {
        const length = this.length;
        const get = this.getChildValue;
        const { typeIdToChildIndex } = this;
        const { typeIds, valueOffsets } = this;
        for (let index = -1; ++index < length;) {
            yield get(this, index, typeIds, valueOffsets, typeIdToChildIndex);
        }
    }
}
export class DenseUnionView extends UnionView {
    constructor(data, children) {
        super(data, children);
        this.valueOffsets = data.valueOffsets;
    }
    getNested(self, index) {
        return self.getChildValue(self, index, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    getChildValue(self, index, typeIds, valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.get(valueOffsets[index]) : null;
    }
    setChildValue(self, index, value, typeIds, valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.set(valueOffsets[index], value) : null;
    }
}
export class StructView extends NestedView {
    getNested(self, index) {
        return new RowView(self, self._children, index);
    }
    setNested(self, index, value) {
        let idx = -1, len = self.numChildren, child;
        if (!(value instanceof NestedView || value instanceof Vector)) {
            while (++idx < len) {
                if (child = self.getChildAt(idx)) {
                    child.set(index, value[idx]);
                }
            }
        }
        else {
            while (++idx < len) {
                if (child = self.getChildAt(idx)) {
                    child.set(index, value.get(idx));
                }
            }
        }
    }
}
export class MapView extends NestedView {
    constructor(data, children) {
        super(data, children);
        this.typeIds = data.type.children.reduce((xs, x, i) => (xs[x.name] = i) && xs || xs, Object.create(null));
    }
    getNested(self, index) {
        return new MapRowView(self, self._children, index);
    }
    setNested(self, index, value) {
        let typeIds = self.typeIds, child;
        if (!(value instanceof NestedView || value instanceof Vector)) {
            for (const key in typeIds) {
                if (child = self.getChildAt(typeIds[key])) {
                    child.set(index, value[key]);
                }
            }
        }
        else {
            for (const key in typeIds) {
                if (child = self.getChildAt(typeIds[key])) {
                    child.set(index, value.get(key));
                }
            }
        }
    }
}
export class RowView extends UnionView {
    constructor(data, children, rowIndex) {
        super(data, children);
        this.rowIndex = rowIndex || 0;
        this.length = data.numChildren;
    }
    clone(data) {
        return new this.constructor(data, this._children, this.rowIndex);
    }
    getChildValue(self, index, _typeIds, _valueOffsets) {
        const child = self.getChildAt(index);
        return child ? child.get(self.rowIndex) : null;
    }
    setChildValue(self, index, value, _typeIds, _valueOffsets) {
        const child = self.getChildAt(index);
        return child ? child.set(self.rowIndex, value) : null;
    }
}
export class MapRowView extends RowView {
    toJSON() {
        const get = this.getChildValue;
        const result = {};
        const typeIds = this.typeIds;
        for (const name in typeIds) {
            result[name] = get(this, name, typeIds, null);
        }
        return result;
    }
    getChildValue(self, key, typeIds, _valueOffsets) {
        const child = self.getChildAt(typeIds[key]);
        return child ? child.get(self.rowIndex) : null;
    }
    setChildValue(self, key, value, typeIds, _valueOffsets) {
        const child = self.getChildAt(typeIds[key]);
        return child ? child.set(self.rowIndex, value) : null;
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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TyxHQUFHLElBQUksQ0FBQyxPQUFrQyxDQUFDO1FBQ3hELEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDekIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBQ1MsYUFBYSxDQUFDLElBQWdCLEVBQUUsR0FBUSxFQUFFLE9BQVksRUFBRSxhQUFrQjtRQUNoRixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzVDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDbkQsQ0FBQztJQUNTLGFBQWEsQ0FBQyxJQUFnQixFQUFFLEdBQVEsRUFBRSxLQUFVLEVBQUUsT0FBWSxFQUFFLGFBQW1CO1FBQzdGLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDNUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDMUQsQ0FBQztDQUNKIiwiZmlsZSI6InZlY3Rvci9uZXN0ZWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgRGF0YSB9IGZyb20gJy4uL2RhdGEnO1xuaW1wb3J0IHsgVmlldywgVmVjdG9yIH0gZnJvbSAnLi4vdmVjdG9yJztcbmltcG9ydCB7IEl0ZXJhYmxlQXJyYXlMaWtlIH0gZnJvbSAnLi4vdHlwZSc7XG5pbXBvcnQgeyB2YWx1ZVRvU3RyaW5nIH0gZnJvbSAnLi4vdXRpbC9wcmV0dHknO1xuaW1wb3J0IHsgRGF0YVR5cGUsIE5lc3RlZFR5cGUsIERlbnNlVW5pb24sIFNwYXJzZVVuaW9uLCBTdHJ1Y3QsIE1hcF8gfSBmcm9tICcuLi90eXBlJztcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE5lc3RlZFZpZXc8VCBleHRlbmRzIE5lc3RlZFR5cGU+IGltcGxlbWVudHMgVmlldzxUPiB7XG4gICAgcHVibGljIGxlbmd0aDogbnVtYmVyO1xuICAgIHB1YmxpYyBudW1DaGlsZHJlbjogbnVtYmVyO1xuICAgIHB1YmxpYyBjaGlsZERhdGE6IERhdGE8YW55PltdO1xuICAgIHByb3RlY3RlZCBfY2hpbGRyZW46IFZlY3Rvcjxhbnk+W107XG4gICAgY29uc3RydWN0b3IoZGF0YTogRGF0YTxUPiwgY2hpbGRyZW4/OiBWZWN0b3I8YW55PltdKSB7XG4gICAgICAgIHRoaXMubGVuZ3RoID0gZGF0YS5sZW5ndGg7XG4gICAgICAgIHRoaXMuY2hpbGREYXRhID0gZGF0YS5jaGlsZERhdGE7XG4gICAgICAgIHRoaXMubnVtQ2hpbGRyZW4gPSBkYXRhLmNoaWxkRGF0YS5sZW5ndGg7XG4gICAgICAgIHRoaXMuX2NoaWxkcmVuID0gY2hpbGRyZW4gfHwgbmV3IEFycmF5KHRoaXMubnVtQ2hpbGRyZW4pO1xuICAgIH1cbiAgICBwdWJsaWMgY2xvbmUoZGF0YTogRGF0YTxUPik6IHRoaXMge1xuICAgICAgICByZXR1cm4gbmV3ICg8YW55PiB0aGlzLmNvbnN0cnVjdG9yKShkYXRhLCB0aGlzLl9jaGlsZHJlbikgYXMgdGhpcztcbiAgICB9XG4gICAgcHVibGljIGlzVmFsaWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBwdWJsaWMgdG9BcnJheSgpOiBJdGVyYWJsZUFycmF5TGlrZTxUWydUVmFsdWUnXT4ge1xuICAgICAgICByZXR1cm4gWy4uLnRoaXNdO1xuICAgIH1cbiAgICBwdWJsaWMgaW5kZXhPZihfOiBUWydUVmFsdWUnXSk6IG51bWJlciB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IGltcGxlbWVudGVkIHlldGApO1xuICAgIH1cbiAgICBwdWJsaWMgdG9KU09OKCk6IGFueSB7IHJldHVybiB0aGlzLnRvQXJyYXkoKTsgfVxuICAgIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzXS5tYXAoKHgpID0+IHZhbHVlVG9TdHJpbmcoeCkpLmpvaW4oJywgJyk7XG4gICAgfVxuICAgIHB1YmxpYyBnZXQoaW5kZXg6IG51bWJlcik6IFRbJ1RWYWx1ZSddIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TmVzdGVkKHRoaXMsIGluZGV4KTtcbiAgICB9XG4gICAgcHVibGljIHNldChpbmRleDogbnVtYmVyLCB2YWx1ZTogVFsnVFZhbHVlJ10pOiB2b2lkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0TmVzdGVkKHRoaXMsIGluZGV4LCB2YWx1ZSk7XG4gICAgfVxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBnZXROZXN0ZWQoc2VsZjogTmVzdGVkVmlldzxUPiwgaW5kZXg6IG51bWJlcik6IFRbJ1RWYWx1ZSddO1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBzZXROZXN0ZWQoc2VsZjogTmVzdGVkVmlldzxUPiwgaW5kZXg6IG51bWJlciwgdmFsdWU6IFRbJ1RWYWx1ZSddKTogdm9pZDtcbiAgICBwdWJsaWMgZ2V0Q2hpbGRBdDxSIGV4dGVuZHMgRGF0YVR5cGUgPSBEYXRhVHlwZT4oaW5kZXg6IG51bWJlcik6IFZlY3RvcjxSPiB8IG51bGwge1xuICAgICAgICByZXR1cm4gaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMubnVtQ2hpbGRyZW5cbiAgICAgICAgICAgID8gbnVsbFxuICAgICAgICAgICAgOiAodGhpcy5fY2hpbGRyZW5baW5kZXhdIGFzIFZlY3RvcjxSPikgfHxcbiAgICAgICAgICAgICAgKHRoaXMuX2NoaWxkcmVuW2luZGV4XSA9IFZlY3Rvci5jcmVhdGU8Uj4odGhpcy5jaGlsZERhdGFbaW5kZXhdKSk7XG4gICAgfVxuICAgIHB1YmxpYyAqW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxUWydUVmFsdWUnXT4ge1xuICAgICAgICBjb25zdCBnZXQgPSB0aGlzLmdldE5lc3RlZDtcbiAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5sZW5ndGg7XG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gLTE7ICsraW5kZXggPCBsZW5ndGg7KSB7XG4gICAgICAgICAgICB5aWVsZCBnZXQodGhpcywgaW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgVW5pb25WaWV3PFQgZXh0ZW5kcyAoRGVuc2VVbmlvbiB8IFNwYXJzZVVuaW9uKSA9IFNwYXJzZVVuaW9uPiBleHRlbmRzIE5lc3RlZFZpZXc8VD4ge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwdWJsaWMgdHlwZUlkczogSW50OEFycmF5O1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwdWJsaWMgdmFsdWVPZmZzZXRzPzogSW50MzJBcnJheTtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJvdGVjdGVkIHR5cGVJZFRvQ2hpbGRJbmRleDogeyBba2V5OiBudW1iZXJdOiBudW1iZXIgfTtcbiAgICBjb25zdHJ1Y3RvcihkYXRhOiBEYXRhPFQ+LCBjaGlsZHJlbj86IFZlY3Rvcjxhbnk+W10pIHtcbiAgICAgICAgc3VwZXIoZGF0YSwgY2hpbGRyZW4pO1xuICAgICAgICB0aGlzLmxlbmd0aCA9IGRhdGEubGVuZ3RoO1xuICAgICAgICB0aGlzLnR5cGVJZHMgPSBkYXRhLnR5cGVJZHM7XG4gICAgICAgIHRoaXMudHlwZUlkVG9DaGlsZEluZGV4ID0gZGF0YS50eXBlSWRUb0NoaWxkSW5kZXg7XG4gICAgfVxuICAgIHByb3RlY3RlZCBnZXROZXN0ZWQoc2VsZjogVW5pb25WaWV3PFQ+LCBpbmRleDogbnVtYmVyKTogVFsnVFZhbHVlJ10ge1xuICAgICAgICByZXR1cm4gc2VsZi5nZXRDaGlsZFZhbHVlKHNlbGYsIGluZGV4LCBzZWxmLnR5cGVJZHMsIHNlbGYudmFsdWVPZmZzZXRzLCBzZWxmLnR5cGVJZFRvQ2hpbGRJbmRleCk7XG4gICAgfVxuICAgIHByb3RlY3RlZCBzZXROZXN0ZWQoc2VsZjogVW5pb25WaWV3PFQ+LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogVFsnVFZhbHVlJ10pOiB2b2lkIHtcbiAgICAgICAgcmV0dXJuIHNlbGYuc2V0Q2hpbGRWYWx1ZShzZWxmLCBpbmRleCwgdmFsdWUsIHNlbGYudHlwZUlkcywgc2VsZi52YWx1ZU9mZnNldHMsIHNlbGYudHlwZUlkVG9DaGlsZEluZGV4KTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldENoaWxkVmFsdWUoc2VsZjogTmVzdGVkVmlldzxUPiwgaW5kZXg6IG51bWJlciwgdHlwZUlkczogSW50OEFycmF5LCBfdmFsdWVPZmZzZXRzOiBhbnksIHR5cGVJZFRvQ2hpbGRJbmRleDogeyBba2V5OiBudW1iZXJdOiBudW1iZXIgfSk6IGFueSB8IG51bGwge1xuICAgICAgICBjb25zdCBjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRUb0NoaWxkSW5kZXhbdHlwZUlkc1tpbmRleF1dKTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuZ2V0KGluZGV4KSA6IG51bGw7XG4gICAgfVxuICAgIHByb3RlY3RlZCBzZXRDaGlsZFZhbHVlKHNlbGY6IE5lc3RlZFZpZXc8VD4sIGluZGV4OiBudW1iZXIsIHZhbHVlOiBUWydUVmFsdWUnXSwgdHlwZUlkczogSW50OEFycmF5LCBfdmFsdWVPZmZzZXRzOiBhbnksIHR5cGVJZFRvQ2hpbGRJbmRleDogeyBba2V5OiBudW1iZXJdOiBudW1iZXIgfSk6IGFueSB8IG51bGwge1xuICAgICAgICBjb25zdCBjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRUb0NoaWxkSW5kZXhbdHlwZUlkc1tpbmRleF1dKTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuc2V0KGluZGV4LCB2YWx1ZSkgOiBudWxsO1xuICAgIH1cbiAgICBwdWJsaWMgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8VFsnVFZhbHVlJ10+IHtcbiAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGdldCA9IHRoaXMuZ2V0Q2hpbGRWYWx1ZTtcbiAgICAgICAgY29uc3QgeyB0eXBlSWRUb0NoaWxkSW5kZXggfSA9IHRoaXM7XG4gICAgICAgIGNvbnN0IHsgdHlwZUlkcywgdmFsdWVPZmZzZXRzIH0gPSB0aGlzO1xuICAgICAgICBmb3IgKGxldCBpbmRleCA9IC0xOyArK2luZGV4IDwgbGVuZ3RoOykge1xuICAgICAgICAgICAgeWllbGQgZ2V0KHRoaXMsIGluZGV4LCB0eXBlSWRzLCB2YWx1ZU9mZnNldHMsIHR5cGVJZFRvQ2hpbGRJbmRleCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBEZW5zZVVuaW9uVmlldyBleHRlbmRzIFVuaW9uVmlldzxEZW5zZVVuaW9uPiB7XG4gICAgcHVibGljIHZhbHVlT2Zmc2V0czogSW50MzJBcnJheTtcbiAgICBjb25zdHJ1Y3RvcihkYXRhOiBEYXRhPERlbnNlVW5pb24+LCBjaGlsZHJlbj86IFZlY3Rvcjxhbnk+W10pIHtcbiAgICAgICAgc3VwZXIoZGF0YSwgY2hpbGRyZW4pO1xuICAgICAgICB0aGlzLnZhbHVlT2Zmc2V0cyA9IGRhdGEudmFsdWVPZmZzZXRzO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgZ2V0TmVzdGVkKHNlbGY6IERlbnNlVW5pb25WaWV3LCBpbmRleDogbnVtYmVyKTogYW55IHwgbnVsbCB7XG4gICAgICAgIHJldHVybiBzZWxmLmdldENoaWxkVmFsdWUoc2VsZiwgaW5kZXgsIHNlbGYudHlwZUlkcywgc2VsZi52YWx1ZU9mZnNldHMsIHNlbGYudHlwZUlkVG9DaGlsZEluZGV4KTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldENoaWxkVmFsdWUoc2VsZjogTmVzdGVkVmlldzxEZW5zZVVuaW9uPiwgaW5kZXg6IG51bWJlciwgdHlwZUlkczogSW50OEFycmF5LCB2YWx1ZU9mZnNldHM6IGFueSwgdHlwZUlkVG9DaGlsZEluZGV4OiB7IFtrZXk6IG51bWJlcl06IG51bWJlciB9KTogYW55IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KHR5cGVJZFRvQ2hpbGRJbmRleFt0eXBlSWRzW2luZGV4XV0pO1xuICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5nZXQodmFsdWVPZmZzZXRzW2luZGV4XSkgOiBudWxsO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgc2V0Q2hpbGRWYWx1ZShzZWxmOiBOZXN0ZWRWaWV3PERlbnNlVW5pb24+LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogYW55LCB0eXBlSWRzOiBJbnQ4QXJyYXksIHZhbHVlT2Zmc2V0czogYW55LCB0eXBlSWRUb0NoaWxkSW5kZXg6IHsgW2tleTogbnVtYmVyXTogbnVtYmVyIH0pOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQodHlwZUlkVG9DaGlsZEluZGV4W3R5cGVJZHNbaW5kZXhdXSk7XG4gICAgICAgIHJldHVybiBjaGlsZCA/IGNoaWxkLnNldCh2YWx1ZU9mZnNldHNbaW5kZXhdLCB2YWx1ZSkgOiBudWxsO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN0cnVjdFZpZXcgZXh0ZW5kcyBOZXN0ZWRWaWV3PFN0cnVjdD4ge1xuICAgIHByb3RlY3RlZCBnZXROZXN0ZWQoc2VsZjogU3RydWN0VmlldywgaW5kZXg6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gbmV3IFJvd1ZpZXcoc2VsZiBhcyBhbnksIHNlbGYuX2NoaWxkcmVuLCBpbmRleCk7XG4gICAgfVxuICAgIHByb3RlY3RlZCBzZXROZXN0ZWQoc2VsZjogU3RydWN0VmlldywgaW5kZXg6IG51bWJlciwgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgICAgICBsZXQgaWR4ID0gLTEsIGxlbiA9IHNlbGYubnVtQ2hpbGRyZW4sIGNoaWxkOiBWZWN0b3IgfCBudWxsO1xuICAgICAgICBpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIE5lc3RlZFZpZXcgfHwgdmFsdWUgaW5zdGFuY2VvZiBWZWN0b3IpKSB7XG4gICAgICAgICAgICB3aGlsZSAoKytpZHggPCBsZW4pIHtcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPSBzZWxmLmdldENoaWxkQXQoaWR4KSkge1xuICAgICAgICAgICAgICAgICAgICBjaGlsZC5zZXQoaW5kZXgsIHZhbHVlW2lkeF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHdoaWxlICgrK2lkeCA8IGxlbikge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdChpZHgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkLnNldChpbmRleCwgdmFsdWUuZ2V0KGlkeCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIE1hcFZpZXcgZXh0ZW5kcyBOZXN0ZWRWaWV3PE1hcF8+IHtcbiAgICBwdWJsaWMgdHlwZUlkczogeyBbazogc3RyaW5nXTogbnVtYmVyIH07XG4gICAgY29uc3RydWN0b3IoZGF0YTogRGF0YTxNYXBfPiwgY2hpbGRyZW4/OiBWZWN0b3I8YW55PltdKSB7XG4gICAgICAgIHN1cGVyKGRhdGEsIGNoaWxkcmVuKTtcbiAgICAgICAgdGhpcy50eXBlSWRzID0gZGF0YS50eXBlLmNoaWxkcmVuLnJlZHVjZSgoeHMsIHgsIGkpID0+XG4gICAgICAgICAgICAoeHNbeC5uYW1lXSA9IGkpICYmIHhzIHx8IHhzLCBPYmplY3QuY3JlYXRlKG51bGwpKTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldE5lc3RlZChzZWxmOiBNYXBWaWV3LCBpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBuZXcgTWFwUm93VmlldyhzZWxmIGFzIGFueSwgc2VsZi5fY2hpbGRyZW4sIGluZGV4KTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHNldE5lc3RlZChzZWxmOiBNYXBWaWV3LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogeyBbazogc3RyaW5nXTogYW55IH0pOiB2b2lkIHtcbiAgICAgICAgbGV0IHR5cGVJZHMgPSBzZWxmLnR5cGVJZHMgYXMgYW55LCBjaGlsZDogVmVjdG9yIHwgbnVsbDtcbiAgICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBOZXN0ZWRWaWV3IHx8IHZhbHVlIGluc3RhbmNlb2YgVmVjdG9yKSkge1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdHlwZUlkcykge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRzW2tleV0pKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkLnNldChpbmRleCwgdmFsdWVba2V5XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdHlwZUlkcykge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRzW2tleV0pKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkLnNldChpbmRleCwgdmFsdWUuZ2V0KGtleSBhcyBhbnkpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSb3dWaWV3IGV4dGVuZHMgVW5pb25WaWV3PFNwYXJzZVVuaW9uPiB7XG4gICAgcHJvdGVjdGVkIHJvd0luZGV4OiBudW1iZXI7XG4gICAgY29uc3RydWN0b3IoZGF0YTogRGF0YTxTcGFyc2VVbmlvbj4gJiBOZXN0ZWRWaWV3PGFueT4sIGNoaWxkcmVuPzogVmVjdG9yPGFueT5bXSwgcm93SW5kZXg/OiBudW1iZXIpIHtcbiAgICAgICAgc3VwZXIoZGF0YSwgY2hpbGRyZW4pO1xuICAgICAgICB0aGlzLnJvd0luZGV4ID0gcm93SW5kZXggfHwgMDtcbiAgICAgICAgdGhpcy5sZW5ndGggPSBkYXRhLm51bUNoaWxkcmVuO1xuICAgIH1cbiAgICBwdWJsaWMgY2xvbmUoZGF0YTogRGF0YTxTcGFyc2VVbmlvbj4gJiBOZXN0ZWRWaWV3PGFueT4pOiB0aGlzIHtcbiAgICAgICAgcmV0dXJuIG5ldyAoPGFueT4gdGhpcy5jb25zdHJ1Y3RvcikoZGF0YSwgdGhpcy5fY2hpbGRyZW4sIHRoaXMucm93SW5kZXgpIGFzIHRoaXM7XG4gICAgfVxuICAgIHByb3RlY3RlZCBnZXRDaGlsZFZhbHVlKHNlbGY6IFJvd1ZpZXcsIGluZGV4OiBudW1iZXIsIF90eXBlSWRzOiBhbnksIF92YWx1ZU9mZnNldHM/OiBhbnkpOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQoaW5kZXgpO1xuICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5nZXQoc2VsZi5yb3dJbmRleCkgOiBudWxsO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgc2V0Q2hpbGRWYWx1ZShzZWxmOiBSb3dWaWV3LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogYW55LCBfdHlwZUlkczogYW55LCBfdmFsdWVPZmZzZXRzPzogYW55KTogYW55IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KGluZGV4KTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuc2V0KHNlbGYucm93SW5kZXgsIHZhbHVlKSA6IG51bGw7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTWFwUm93VmlldyBleHRlbmRzIFJvd1ZpZXcge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwdWJsaWMgdHlwZUlkczogYW55O1xuICAgIHB1YmxpYyB0b0pTT04oKSB7XG4gICAgICAgIGNvbnN0IGdldCA9IHRoaXMuZ2V0Q2hpbGRWYWx1ZTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge30gYXMgeyBbazogc3RyaW5nXTogYW55IH07XG4gICAgICAgIGNvbnN0IHR5cGVJZHMgPSB0aGlzLnR5cGVJZHMgYXMgeyBbazogc3RyaW5nXTogbnVtYmVyIH07XG4gICAgICAgIGZvciAoY29uc3QgbmFtZSBpbiB0eXBlSWRzKSB7XG4gICAgICAgICAgICByZXN1bHRbbmFtZV0gPSBnZXQodGhpcywgbmFtZSwgdHlwZUlkcywgbnVsbCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldENoaWxkVmFsdWUoc2VsZjogTWFwUm93Vmlldywga2V5OiBhbnksIHR5cGVJZHM6IGFueSwgX3ZhbHVlT2Zmc2V0czogYW55KTogYW55IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KHR5cGVJZHNba2V5XSk7XG4gICAgICAgIHJldHVybiBjaGlsZCA/IGNoaWxkLmdldChzZWxmLnJvd0luZGV4KSA6IG51bGw7XG4gICAgfVxuICAgIHByb3RlY3RlZCBzZXRDaGlsZFZhbHVlKHNlbGY6IE1hcFJvd1ZpZXcsIGtleTogYW55LCB2YWx1ZTogYW55LCB0eXBlSWRzOiBhbnksIF92YWx1ZU9mZnNldHM/OiBhbnkpOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQodHlwZUlkc1trZXldKTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuc2V0KHNlbGYucm93SW5kZXgsIHZhbHVlKSA6IG51bGw7XG4gICAgfVxufVxuIl19
