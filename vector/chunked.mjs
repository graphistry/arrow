// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import { Vector } from '../vector';
import { clampRange } from '../util/vector';
export class ChunkedVector extends Vector {
    constructor(type, chunks = [], offsets = calculateOffsets(chunks)) {
        super();
        this._nullCount = -1;
        this._type = type;
        this._chunks = chunks;
        this._chunkOffsets = offsets;
        this._length = offsets[offsets.length - 1];
        this._numChildren = (this._type.children || []).length;
    }
    /** @nocollapse */
    static flatten(...vectors) {
        return vectors.reduce(function flatten(xs, x) {
            return x instanceof ChunkedVector ? x.chunks.reduce(flatten, xs) : [...xs, x];
        }, []).filter((x) => x instanceof Vector);
    }
    /** @nocollapse */
    static concat(...vectors) {
        return new ChunkedVector(vectors[0].type, ChunkedVector.flatten(...vectors));
    }
    get type() { return this._type; }
    get length() { return this._length; }
    get chunks() { return this._chunks; }
    get typeId() { return this._type.typeId; }
    get ArrayType() { return this._type.ArrayType; }
    get numChildren() { return this._numChildren; }
    get data() { return this._chunks[0] ? this._chunks[0].data : null; }
    get stride() { return this._chunks[0] ? this._chunks[0].stride : 1; }
    get nullCount() {
        let nullCount = this._nullCount;
        if (nullCount < 0) {
            this._nullCount = nullCount = this._chunks.reduce((x, { nullCount }) => x + nullCount, 0);
        }
        return nullCount;
    }
    *[Symbol.iterator]() {
        for (const chunk of this._chunks) {
            yield* chunk;
        }
    }
    concat(...others) {
        return ChunkedVector.concat(this, ...others);
    }
    getChildAt(index) {
        if (index < 0 || index >= this._numChildren) {
            return null;
        }
        let columns = this._children || (this._children = []);
        let child, field, chunks;
        if (child = columns[index]) {
            return child;
        }
        if (field = (this._type.children || [])[index]) {
            chunks = this._chunks
                .map((vector) => vector.getChildAt(index))
                .filter((vec) => vec != null);
            if (chunks.length > 0) {
                return (columns[index] = new ChunkedVector(field.type, chunks));
            }
        }
        return null;
    }
    search(index, then) {
        let idx = index;
        // binary search to find the child vector and value indices
        let offsets = this._chunkOffsets, rhs = offsets.length - 1;
        // return early if out of bounds, or if there's just one child
        if (idx < 0) {
            return null;
        }
        if (idx >= offsets[rhs]) {
            return null;
        }
        if (rhs <= 1) {
            return then ? then(this, 0, idx) : [0, idx];
        }
        let lhs = 0, pos = 0, mid = 0;
        do {
            if (lhs + 1 === rhs) {
                return then ? then(this, lhs, idx - pos) : [lhs, idx - pos];
            }
            mid = lhs + ((rhs - lhs) / 2) | 0;
            idx >= offsets[mid] ? (lhs = mid) : (rhs = mid);
        } while (idx < offsets[rhs] && idx >= (pos = offsets[lhs]));
        return null;
    }
    isValid(index) {
        return !!this.search(index, this.isValidInternal);
    }
    get(index) {
        return this.search(index, this.getInternal);
    }
    set(index, value) {
        this.search(index, ({ chunks }, i, j) => chunks[i].set(j, value));
    }
    indexOf(element, offset) {
        if (offset && typeof offset === 'number') {
            return this.search(offset, (self, i, j) => this.indexOfInternal(self, i, j, element));
        }
        return this.indexOfInternal(this, 0, Math.max(0, offset || 0), element);
    }
    toArray() {
        const { chunks } = this;
        const n = chunks.length;
        let { ArrayType } = this._type;
        if (n <= 0) {
            return new ArrayType(0);
        }
        if (n <= 1) {
            return chunks[0].toArray();
        }
        let len = 0, src = new Array(n);
        for (let i = -1; ++i < n;) {
            len += (src[i] = chunks[i].toArray()).length;
        }
        if (ArrayType !== src[0].constructor) {
            ArrayType = src[0].constructor;
        }
        let dst = new ArrayType(len);
        let set = ArrayType === Array ? arraySet : typedSet;
        for (let i = -1, idx = 0; ++i < n;) {
            idx = set(src[i], dst, idx);
        }
        return dst;
    }
    slice(begin, end) {
        return clampRange(this, begin, end, this.sliceInternal);
    }
    getInternal({ _chunks }, i, j) { return _chunks[i].get(j); }
    isValidInternal({ _chunks }, i, j) { return _chunks[i].isValid(j); }
    indexOfInternal({ _chunks }, chunkIndex, fromIndex, element) {
        let i = chunkIndex - 1, n = _chunks.length;
        let start = fromIndex, offset = 0, found = -1;
        while (++i < n) {
            if (~(found = _chunks[i].indexOf(element, start))) {
                return offset + found;
            }
            start = 0;
            offset += _chunks[i].length;
        }
        return -1;
    }
    sliceInternal(column, offset, length) {
        const slices = [];
        const { type, chunks, _chunkOffsets: chunkOffsets } = column;
        for (let i = -1, n = chunks.length; ++i < n;) {
            const chunk = chunks[i];
            const chunkLength = chunk.length;
            const chunkOffset = chunkOffsets[i];
            // If the child is to the right of the slice boundary, we can stop
            if (chunkOffset >= offset + length) {
                continue;
            }
            // If the child is to the left of of the slice boundary, exclude
            if (offset >= chunkOffset + chunkLength) {
                continue;
            }
            // If the child is between both left and right boundaries, include w/o slicing
            if (chunkOffset >= offset && (chunkOffset + chunkLength) <= offset + length) {
                slices.push(chunk);
                continue;
            }
            // If the child overlaps one of the slice boundaries, include that slice
            const begin = Math.max(0, offset - chunkOffset);
            const end = begin + Math.min(chunkLength - begin, (offset + length) - chunkOffset);
            slices.push(chunk.slice(begin, end));
        }
        return new ChunkedVector(type, slices);
    }
}
function calculateOffsets(vectors) {
    let offsets = new Uint32Array((vectors || []).length + 1);
    let offset = offsets[0] = 0, length = offsets.length;
    for (let index = 0; ++index < length;) {
        offsets[index] = (offset += vectors[index - 1].length);
    }
    return offsets;
}
const typedSet = (src, dst, offset) => {
    dst.set(src, offset);
    return (offset + src.length);
};
const arraySet = (src, dst, offset) => {
    let idx = offset - 1;
    for (let i = -1, n = src.length; ++i < n;) {
        dst[++idx] = src[i];
    }
    return idx;
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LEtBQUssR0FBRyxDQUFDLEVBQUUsRUFBRSxLQUFLLEdBQUcsTUFBTSxHQUFHO1FBQ25DLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQzFEO0lBQ0QsT0FBTyxPQUFPLENBQUM7QUFDbkIsQ0FBQztBQUVELE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBZSxFQUFFLEdBQWUsRUFBRSxNQUFjLEVBQUUsRUFBRTtJQUNsRSxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNyQixPQUFPLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNqQyxDQUFDLENBQUM7QUFFRixNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQVUsRUFBRSxHQUFVLEVBQUUsTUFBYyxFQUFFLEVBQUU7SUFDeEQsSUFBSSxHQUFHLEdBQUcsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNyQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRztRQUN2QyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDdkI7SUFDRCxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUMsQ0FBQyIsImZpbGUiOiJ2ZWN0b3IvY2h1bmtlZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBGaWVsZCB9IGZyb20gJy4uL3NjaGVtYSc7XG5pbXBvcnQgeyBWZWN0b3IgfSBmcm9tICcuLi92ZWN0b3InO1xuaW1wb3J0IHsgRGF0YVR5cGUgfSBmcm9tICcuLi90eXBlJztcbmltcG9ydCB7IGNsYW1wUmFuZ2UgfSBmcm9tICcuLi91dGlsL3ZlY3Rvcic7XG5cbnR5cGUgU2VhcmNoQ29udGludWF0aW9uPFQgZXh0ZW5kcyBDaHVua2VkVmVjdG9yPiA9IChjb2x1bW46IFQsIGNodW5rSW5kZXg6IG51bWJlciwgdmFsdWVJbmRleDogbnVtYmVyKSA9PiBhbnk7XG5cbmV4cG9ydCBjbGFzcyBDaHVua2VkVmVjdG9yPFQgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4gZXh0ZW5kcyBWZWN0b3I8VD4ge1xuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBmbGF0dGVuPFQgZXh0ZW5kcyBEYXRhVHlwZT4oLi4udmVjdG9yczogVmVjdG9yPFQ+W10pIHtcbiAgICAgICAgcmV0dXJuIHZlY3RvcnMucmVkdWNlKGZ1bmN0aW9uIGZsYXR0ZW4oeHM6IGFueVtdLCB4OiBhbnkpOiBhbnlbXSB7XG4gICAgICAgICAgICByZXR1cm4geCBpbnN0YW5jZW9mIENodW5rZWRWZWN0b3IgPyB4LmNodW5rcy5yZWR1Y2UoZmxhdHRlbiwgeHMpIDogWy4uLnhzLCB4XTtcbiAgICAgICAgfSwgW10pLmZpbHRlcigoeDogYW55KTogeCBpcyBWZWN0b3I8VD4gPT4geCBpbnN0YW5jZW9mIFZlY3Rvcik7XG4gICAgfVxuXG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBjb25jYXQ8VCBleHRlbmRzIERhdGFUeXBlPiguLi52ZWN0b3JzOiBWZWN0b3I8VD5bXSk6IFZlY3RvcjxUPiB7XG4gICAgICAgIHJldHVybiBuZXcgQ2h1bmtlZFZlY3Rvcih2ZWN0b3JzWzBdLnR5cGUsIENodW5rZWRWZWN0b3IuZmxhdHRlbiguLi52ZWN0b3JzKSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF90eXBlOiBUO1xuICAgIHByb3RlY3RlZCBfbGVuZ3RoOiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIF9udW1DaGlsZHJlbjogbnVtYmVyO1xuICAgIHByb3RlY3RlZCBfY2h1bmtzOiBWZWN0b3I8VD5bXTtcblxuICAgIHByb3RlY3RlZCBfbnVsbENvdW50OiBudW1iZXIgPSAtMTtcbiAgICBwcm90ZWN0ZWQgX2NoaWxkcmVuPzogQ2h1bmtlZFZlY3RvcltdO1xuICAgIHByb3RlY3RlZCBfY2h1bmtPZmZzZXRzOiBVaW50MzJBcnJheTtcblxuICAgIGNvbnN0cnVjdG9yKHR5cGU6VCwgY2h1bmtzOiBWZWN0b3I8VD5bXSA9IFtdLCBvZmZzZXRzID0gY2FsY3VsYXRlT2Zmc2V0cyhjaHVua3MpKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX3R5cGUgPSB0eXBlO1xuICAgICAgICB0aGlzLl9jaHVua3MgPSBjaHVua3M7XG4gICAgICAgIHRoaXMuX2NodW5rT2Zmc2V0cyA9IG9mZnNldHM7XG4gICAgICAgIHRoaXMuX2xlbmd0aCA9IG9mZnNldHNbb2Zmc2V0cy5sZW5ndGggLSAxXTtcbiAgICAgICAgdGhpcy5fbnVtQ2hpbGRyZW4gPSAodGhpcy5fdHlwZS5jaGlsZHJlbiB8fCBbXSkubGVuZ3RoO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgdHlwZSgpIHsgcmV0dXJuIHRoaXMuX3R5cGU7IH1cbiAgICBwdWJsaWMgZ2V0IGxlbmd0aCgpIHsgcmV0dXJuIHRoaXMuX2xlbmd0aDsgfVxuICAgIHB1YmxpYyBnZXQgY2h1bmtzKCkgeyByZXR1cm4gdGhpcy5fY2h1bmtzOyB9XG4gICAgcHVibGljIGdldCB0eXBlSWQoKSB7IHJldHVybiB0aGlzLl90eXBlLnR5cGVJZDsgfVxuXG4gICAgcHVibGljIGdldCBBcnJheVR5cGUoKSB7IHJldHVybiB0aGlzLl90eXBlLkFycmF5VHlwZTsgfVxuICAgIHB1YmxpYyBnZXQgbnVtQ2hpbGRyZW4oKSB7IHJldHVybiB0aGlzLl9udW1DaGlsZHJlbjsgfVxuXG4gICAgcHVibGljIGdldCBkYXRhKCkgeyByZXR1cm4gdGhpcy5fY2h1bmtzWzBdID8gdGhpcy5fY2h1bmtzWzBdLmRhdGEgOiA8YW55PiBudWxsOyB9XG4gICAgcHVibGljIGdldCBzdHJpZGUoKSB7IHJldHVybiB0aGlzLl9jaHVua3NbMF0gPyB0aGlzLl9jaHVua3NbMF0uc3RyaWRlIDogMTsgfVxuXG4gICAgcHVibGljIGdldCBudWxsQ291bnQoKSB7XG4gICAgICAgIGxldCBudWxsQ291bnQgPSB0aGlzLl9udWxsQ291bnQ7XG4gICAgICAgIGlmIChudWxsQ291bnQgPCAwKSB7XG4gICAgICAgICAgICB0aGlzLl9udWxsQ291bnQgPSBudWxsQ291bnQgPSB0aGlzLl9jaHVua3MucmVkdWNlKCh4LCB7IG51bGxDb3VudCB9KSA9PiB4ICsgbnVsbENvdW50LCAwKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbENvdW50O1xuICAgIH1cblxuICAgIHB1YmxpYyAqW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxUWydUVmFsdWUnXSB8IG51bGw+IHtcbiAgICAgICAgZm9yIChjb25zdCBjaHVuayBvZiB0aGlzLl9jaHVua3MpIHtcbiAgICAgICAgICAgIHlpZWxkKiBjaHVuaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjb25jYXQoLi4ub3RoZXJzOiBWZWN0b3I8VD5bXSk6IFZlY3RvcjxUPiB7XG4gICAgICAgIHJldHVybiBDaHVua2VkVmVjdG9yLmNvbmNhdDxUPih0aGlzLCAuLi5vdGhlcnMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRDaGlsZEF0PFIgZXh0ZW5kcyBEYXRhVHlwZSA9IGFueT4oaW5kZXg6IG51bWJlcik6IENodW5rZWRWZWN0b3I8Uj4gfCBudWxsIHtcblxuICAgICAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMuX251bUNoaWxkcmVuKSB7IHJldHVybiBudWxsOyB9XG5cbiAgICAgICAgbGV0IGNvbHVtbnMgPSB0aGlzLl9jaGlsZHJlbiB8fCAodGhpcy5fY2hpbGRyZW4gPSBbXSk7XG4gICAgICAgIGxldCBjaGlsZDogQ2h1bmtlZFZlY3RvcjxSPiwgZmllbGQ6IEZpZWxkPFI+LCBjaHVua3M6IFZlY3RvcjxSPltdO1xuXG4gICAgICAgIGlmIChjaGlsZCA9IGNvbHVtbnNbaW5kZXhdKSB7IHJldHVybiBjaGlsZDsgfVxuICAgICAgICBpZiAoZmllbGQgPSAoKHRoaXMuX3R5cGUuY2hpbGRyZW4gfHwgW10pW2luZGV4XSBhcyBGaWVsZDxSPikpIHtcbiAgICAgICAgICAgIGNodW5rcyA9IHRoaXMuX2NodW5rc1xuICAgICAgICAgICAgICAgIC5tYXAoKHZlY3RvcikgPT4gdmVjdG9yLmdldENoaWxkQXQ8Uj4oaW5kZXgpKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoKHZlYyk6IHZlYyBpcyBWZWN0b3I8Uj4gPT4gdmVjICE9IG51bGwpO1xuICAgICAgICAgICAgaWYgKGNodW5rcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChjb2x1bW5zW2luZGV4XSA9IG5ldyBDaHVua2VkVmVjdG9yPFI+KGZpZWxkLnR5cGUsIGNodW5rcykpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHVibGljIHNlYXJjaChpbmRleDogbnVtYmVyKTogW251bWJlciwgbnVtYmVyXSB8IG51bGw7XG4gICAgcHVibGljIHNlYXJjaDxOIGV4dGVuZHMgU2VhcmNoQ29udGludWF0aW9uPENodW5rZWRWZWN0b3I8VD4+PihpbmRleDogbnVtYmVyLCB0aGVuPzogTik6IFJldHVyblR5cGU8Tj47XG4gICAgcHVibGljIHNlYXJjaDxOIGV4dGVuZHMgU2VhcmNoQ29udGludWF0aW9uPENodW5rZWRWZWN0b3I8VD4+PihpbmRleDogbnVtYmVyLCB0aGVuPzogTikge1xuICAgICAgICBsZXQgaWR4ID0gaW5kZXg7XG4gICAgICAgIC8vIGJpbmFyeSBzZWFyY2ggdG8gZmluZCB0aGUgY2hpbGQgdmVjdG9yIGFuZCB2YWx1ZSBpbmRpY2VzXG4gICAgICAgIGxldCBvZmZzZXRzID0gdGhpcy5fY2h1bmtPZmZzZXRzLCByaHMgPSBvZmZzZXRzLmxlbmd0aCAtIDE7XG4gICAgICAgIC8vIHJldHVybiBlYXJseSBpZiBvdXQgb2YgYm91bmRzLCBvciBpZiB0aGVyZSdzIGp1c3Qgb25lIGNoaWxkXG4gICAgICAgIGlmIChpZHggPCAwICAgICAgICAgICAgKSB7IHJldHVybiBudWxsOyB9XG4gICAgICAgIGlmIChpZHggPj0gb2Zmc2V0c1tyaHNdKSB7IHJldHVybiBudWxsOyB9XG4gICAgICAgIGlmIChyaHMgPD0gMSAgICAgICAgICAgKSB7IHJldHVybiB0aGVuID8gdGhlbih0aGlzLCAwLCBpZHgpIDogWzAsIGlkeF07IH1cbiAgICAgICAgbGV0IGxocyA9IDAsIHBvcyA9IDAsIG1pZCA9IDA7XG4gICAgICAgIGRvIHtcbiAgICAgICAgICAgIGlmIChsaHMgKyAxID09PSByaHMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhlbiA/IHRoZW4odGhpcywgbGhzLCBpZHggLSBwb3MpIDogW2xocywgaWR4IC0gcG9zXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1pZCA9IGxocyArICgocmhzIC0gbGhzKSAvIDIpIHwgMDtcbiAgICAgICAgICAgIGlkeCA+PSBvZmZzZXRzW21pZF0gPyAobGhzID0gbWlkKSA6IChyaHMgPSBtaWQpO1xuICAgICAgICB9IHdoaWxlIChpZHggPCBvZmZzZXRzW3Joc10gJiYgaWR4ID49IChwb3MgPSBvZmZzZXRzW2xoc10pKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHVibGljIGlzVmFsaWQoaW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gISF0aGlzLnNlYXJjaChpbmRleCwgdGhpcy5pc1ZhbGlkSW50ZXJuYWwpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQoaW5kZXg6IG51bWJlcik6IFRbJ1RWYWx1ZSddIHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlYXJjaChpbmRleCwgdGhpcy5nZXRJbnRlcm5hbCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldChpbmRleDogbnVtYmVyLCB2YWx1ZTogVFsnVFZhbHVlJ10gfCBudWxsKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc2VhcmNoKGluZGV4LCAoeyBjaHVua3MgfSwgaSwgaikgPT4gY2h1bmtzW2ldLnNldChqLCB2YWx1ZSkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbmRleE9mKGVsZW1lbnQ6IFRbJ1RWYWx1ZSddLCBvZmZzZXQ/OiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBpZiAob2Zmc2V0ICYmIHR5cGVvZiBvZmZzZXQgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZWFyY2gob2Zmc2V0LCAoc2VsZiwgaSwgaikgPT4gdGhpcy5pbmRleE9mSW50ZXJuYWwoc2VsZiwgaSwgaiwgZWxlbWVudCkpITtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5pbmRleE9mSW50ZXJuYWwodGhpcywgMCwgTWF0aC5tYXgoMCwgb2Zmc2V0IHx8IDApLCBlbGVtZW50KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9BcnJheSgpOiBUWydUQXJyYXknXSB7XG4gICAgICAgIGNvbnN0IHsgY2h1bmtzIH0gPSB0aGlzO1xuICAgICAgICBjb25zdCBuID0gY2h1bmtzLmxlbmd0aDtcbiAgICAgICAgbGV0IHsgQXJyYXlUeXBlIH0gPSB0aGlzLl90eXBlO1xuICAgICAgICBpZiAobiA8PSAwKSB7IHJldHVybiBuZXcgQXJyYXlUeXBlKDApOyB9XG4gICAgICAgIGlmIChuIDw9IDEpIHsgcmV0dXJuIGNodW5rc1swXS50b0FycmF5KCk7IH1cbiAgICAgICAgbGV0IGxlbiA9IDAsIHNyYyA9IG5ldyBBcnJheShuKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IC0xOyArK2kgPCBuOykge1xuICAgICAgICAgICAgbGVuICs9IChzcmNbaV0gPSBjaHVua3NbaV0udG9BcnJheSgpKS5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKEFycmF5VHlwZSAhPT0gc3JjWzBdLmNvbnN0cnVjdG9yKSB7XG4gICAgICAgICAgICBBcnJheVR5cGUgPSBzcmNbMF0uY29uc3RydWN0b3I7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGRzdCA9IG5ldyAoQXJyYXlUeXBlIGFzIGFueSkobGVuKTtcbiAgICAgICAgbGV0IHNldDogYW55ID0gQXJyYXlUeXBlID09PSBBcnJheSA/IGFycmF5U2V0IDogdHlwZWRTZXQ7XG4gICAgICAgIGZvciAobGV0IGkgPSAtMSwgaWR4ID0gMDsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGlkeCA9IHNldChzcmNbaV0sIGRzdCwgaWR4KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZHN0O1xuICAgIH1cblxuICAgIHB1YmxpYyBzbGljZShiZWdpbj86IG51bWJlciwgZW5kPzogbnVtYmVyKTogQ2h1bmtlZFZlY3RvcjxUPiB7XG4gICAgICAgIHJldHVybiBjbGFtcFJhbmdlKHRoaXMsIGJlZ2luLCBlbmQsIHRoaXMuc2xpY2VJbnRlcm5hbCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldEludGVybmFsKHsgX2NodW5rcyB9OiBDaHVua2VkVmVjdG9yPFQ+LCBpOiBudW1iZXIsIGo6IG51bWJlcikgeyByZXR1cm4gX2NodW5rc1tpXS5nZXQoaik7IH1cbiAgICBwcm90ZWN0ZWQgaXNWYWxpZEludGVybmFsKHsgX2NodW5rcyB9OiBDaHVua2VkVmVjdG9yPFQ+LCBpOiBudW1iZXIsIGo6IG51bWJlcikgeyByZXR1cm4gX2NodW5rc1tpXS5pc1ZhbGlkKGopOyB9XG4gICAgcHJvdGVjdGVkIGluZGV4T2ZJbnRlcm5hbCh7IF9jaHVua3MgfTogQ2h1bmtlZFZlY3RvcjxUPiwgY2h1bmtJbmRleDogbnVtYmVyLCBmcm9tSW5kZXg6IG51bWJlciwgZWxlbWVudDogVFsnVFZhbHVlJ10pIHtcbiAgICAgICAgbGV0IGkgPSBjaHVua0luZGV4IC0gMSwgbiA9IF9jaHVua3MubGVuZ3RoO1xuICAgICAgICBsZXQgc3RhcnQgPSBmcm9tSW5kZXgsIG9mZnNldCA9IDAsIGZvdW5kID0gLTE7XG4gICAgICAgIHdoaWxlICgrK2kgPCBuKSB7XG4gICAgICAgICAgICBpZiAofihmb3VuZCA9IF9jaHVua3NbaV0uaW5kZXhPZihlbGVtZW50LCBzdGFydCkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mZnNldCArIGZvdW5kO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhcnQgPSAwO1xuICAgICAgICAgICAgb2Zmc2V0ICs9IF9jaHVua3NbaV0ubGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAtMTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc2xpY2VJbnRlcm5hbChjb2x1bW46IENodW5rZWRWZWN0b3I8VD4sIG9mZnNldDogbnVtYmVyLCBsZW5ndGg6IG51bWJlcikge1xuICAgICAgICBjb25zdCBzbGljZXM6IFZlY3RvcjxUPltdID0gW107XG4gICAgICAgIGNvbnN0IHsgdHlwZSwgY2h1bmtzLCBfY2h1bmtPZmZzZXRzOiBjaHVua09mZnNldHMgfSA9IGNvbHVtbjtcbiAgICAgICAgZm9yIChsZXQgaSA9IC0xLCBuID0gY2h1bmtzLmxlbmd0aDsgKytpIDwgbjspIHtcbiAgICAgICAgICAgIGNvbnN0IGNodW5rID0gY2h1bmtzW2ldO1xuICAgICAgICAgICAgY29uc3QgY2h1bmtMZW5ndGggPSBjaHVuay5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCBjaHVua09mZnNldCA9IGNodW5rT2Zmc2V0c1tpXTtcbiAgICAgICAgICAgIC8vIElmIHRoZSBjaGlsZCBpcyB0byB0aGUgcmlnaHQgb2YgdGhlIHNsaWNlIGJvdW5kYXJ5LCB3ZSBjYW4gc3RvcFxuICAgICAgICAgICAgaWYgKGNodW5rT2Zmc2V0ID49IG9mZnNldCArIGxlbmd0aCkgeyBjb250aW51ZTsgfVxuICAgICAgICAgICAgLy8gSWYgdGhlIGNoaWxkIGlzIHRvIHRoZSBsZWZ0IG9mIG9mIHRoZSBzbGljZSBib3VuZGFyeSwgZXhjbHVkZVxuICAgICAgICAgICAgaWYgKG9mZnNldCA+PSBjaHVua09mZnNldCArIGNodW5rTGVuZ3RoKSB7IGNvbnRpbnVlOyB9XG4gICAgICAgICAgICAvLyBJZiB0aGUgY2hpbGQgaXMgYmV0d2VlbiBib3RoIGxlZnQgYW5kIHJpZ2h0IGJvdW5kYXJpZXMsIGluY2x1ZGUgdy9vIHNsaWNpbmdcbiAgICAgICAgICAgIGlmIChjaHVua09mZnNldCA+PSBvZmZzZXQgJiYgKGNodW5rT2Zmc2V0ICsgY2h1bmtMZW5ndGgpIDw9IG9mZnNldCArIGxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHNsaWNlcy5wdXNoKGNodW5rKTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIElmIHRoZSBjaGlsZCBvdmVybGFwcyBvbmUgb2YgdGhlIHNsaWNlIGJvdW5kYXJpZXMsIGluY2x1ZGUgdGhhdCBzbGljZVxuICAgICAgICAgICAgY29uc3QgYmVnaW4gPSBNYXRoLm1heCgwLCBvZmZzZXQgLSBjaHVua09mZnNldCk7XG4gICAgICAgICAgICBjb25zdCBlbmQgPSBiZWdpbiArIE1hdGgubWluKGNodW5rTGVuZ3RoIC0gYmVnaW4sIChvZmZzZXQgKyBsZW5ndGgpIC0gY2h1bmtPZmZzZXQpO1xuICAgICAgICAgICAgc2xpY2VzLnB1c2goY2h1bmsuc2xpY2UoYmVnaW4sIGVuZCkgYXMgVmVjdG9yPFQ+KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IENodW5rZWRWZWN0b3IodHlwZSwgc2xpY2VzKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZU9mZnNldHM8VCBleHRlbmRzIERhdGFUeXBlPih2ZWN0b3JzOiBWZWN0b3I8VD5bXSkge1xuICAgIGxldCBvZmZzZXRzID0gbmV3IFVpbnQzMkFycmF5KCh2ZWN0b3JzIHx8IFtdKS5sZW5ndGggKyAxKTtcbiAgICBsZXQgb2Zmc2V0ID0gb2Zmc2V0c1swXSA9IDAsIGxlbmd0aCA9IG9mZnNldHMubGVuZ3RoO1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgKytpbmRleCA8IGxlbmd0aDspIHtcbiAgICAgICAgb2Zmc2V0c1tpbmRleF0gPSAob2Zmc2V0ICs9IHZlY3RvcnNbaW5kZXggLSAxXS5sZW5ndGgpO1xuICAgIH1cbiAgICByZXR1cm4gb2Zmc2V0cztcbn1cblxuY29uc3QgdHlwZWRTZXQgPSAoc3JjOiBUeXBlZEFycmF5LCBkc3Q6IFR5cGVkQXJyYXksIG9mZnNldDogbnVtYmVyKSA9PiB7XG4gICAgZHN0LnNldChzcmMsIG9mZnNldCk7XG4gICAgcmV0dXJuIChvZmZzZXQgKyBzcmMubGVuZ3RoKTtcbn07XG5cbmNvbnN0IGFycmF5U2V0ID0gKHNyYzogYW55W10sIGRzdDogYW55W10sIG9mZnNldDogbnVtYmVyKSA9PiB7XG4gICAgbGV0IGlkeCA9IG9mZnNldCAtIDE7XG4gICAgZm9yIChsZXQgaSA9IC0xLCBuID0gc3JjLmxlbmd0aDsgKytpIDwgbjspIHtcbiAgICAgICAgZHN0WysraWR4XSA9IHNyY1tpXTtcbiAgICB9XG4gICAgcmV0dXJuIGlkeDtcbn07XG5cbmludGVyZmFjZSBUeXBlZEFycmF5IGV4dGVuZHMgQXJyYXlCdWZmZXJWaWV3IHtcbiAgICByZWFkb25seSBsZW5ndGg6IG51bWJlcjtcbiAgICByZWFkb25seSBbbjogbnVtYmVyXTogbnVtYmVyO1xuICAgIHNldChhcnJheTogQXJyYXlMaWtlPG51bWJlcj4sIG9mZnNldD86IG51bWJlcik6IHZvaWQ7XG59XG4iXX0=
