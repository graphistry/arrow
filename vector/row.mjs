// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
import { Field } from '../schema';
import { DataType } from '../type';
import { valueToString } from '../util/pretty';
const columnDescriptor = { enumerable: true, configurable: false, get: () => { } };
const lengthDescriptor = { writable: false, enumerable: false, configurable: false, value: -1 };
const rowIndexDescriptor = { writable: false, enumerable: false, configurable: true, value: null };
const rowParentDescriptor = { writable: false, enumerable: false, configurable: false, value: null };
const row = { parent: rowParentDescriptor, rowIndex: rowIndexDescriptor };
export class Row {
    constructor(fields, fieldsAreEnumerable) {
        lengthDescriptor.value = fields.length;
        Object.defineProperty(this, 'length', lengthDescriptor);
        fields.forEach((field, columnIndex) => {
            columnDescriptor.get = this._bindGetter(columnIndex);
            // set configurable to true to ensure Object.defineProperty
            // doesn't throw in the case of duplicate column names
            columnDescriptor.configurable = true;
            columnDescriptor.enumerable = fieldsAreEnumerable;
            Object.defineProperty(this, field.name, columnDescriptor);
            columnDescriptor.configurable = false;
            columnDescriptor.enumerable = !fieldsAreEnumerable;
            Object.defineProperty(this, columnIndex, columnDescriptor);
            columnDescriptor.get = null;
        });
    }
    /** @nocollapse */
    static new(schemaOrFields, fieldsAreEnumerable = false) {
        let schema, fields;
        if (Array.isArray(schemaOrFields)) {
            fields = schemaOrFields;
        }
        else {
            schema = schemaOrFields;
            fieldsAreEnumerable = true;
            fields = Object.keys(schema).map((x) => new Field(x, schema[x]));
        }
        return new Row(fields, fieldsAreEnumerable);
    }
    *[Symbol.iterator]() {
        for (let i = -1, n = this.length; ++i < n;) {
            yield this[i];
        }
    }
    _bindGetter(colIndex) {
        return function () {
            let child = this.parent.getChildAt(colIndex);
            return child ? child.get(this.rowIndex) : null;
        };
    }
    get(key) { return this[key]; }
    bind(parent, rowIndex) {
        rowIndexDescriptor.value = rowIndex;
        rowParentDescriptor.value = parent;
        const bound = Object.create(this, row);
        rowIndexDescriptor.value = null;
        rowParentDescriptor.value = null;
        return bound;
    }
    toJSON() {
        return DataType.isStruct(this.parent.type) ? [...this] :
            Object.getOwnPropertyNames(this).reduce((props, prop) => {
                return (props[prop] = this[prop]) && props || props;
            }, {});
    }
    toString() {
        return DataType.isStruct(this.parent.type) ?
            [...this].map((x) => valueToString(x)).join(', ') :
            Object.getOwnPropertyNames(this).reduce((props, prop) => {
                return (props[prop] = valueToString(this[prop])) && props || props;
            }, {});
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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dGVudCI6WyIvLyBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4vLyBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbi8vIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4vLyByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4vLyB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4vLyBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Vcbi8vIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuLy9cbi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbi8vIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4vLyBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuLy8gS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4vLyBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4vLyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgRmllbGQgfSBmcm9tICcuLi9zY2hlbWEnO1xuaW1wb3J0IHsgTWFwVmVjdG9yIH0gZnJvbSAnLi4vdmVjdG9yL21hcCc7XG5pbXBvcnQgeyBEYXRhVHlwZSwgUm93TGlrZSB9IGZyb20gJy4uL3R5cGUnO1xuaW1wb3J0IHsgdmFsdWVUb1N0cmluZyB9IGZyb20gJy4uL3V0aWwvcHJldHR5JztcbmltcG9ydCB7IFN0cnVjdFZlY3RvciB9IGZyb20gJy4uL3ZlY3Rvci9zdHJ1Y3QnO1xuXG5jb25zdCBjb2x1bW5EZXNjcmlwdG9yID0geyBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IGZhbHNlLCBnZXQ6ICgpID0+IHt9IH07XG5jb25zdCBsZW5ndGhEZXNjcmlwdG9yID0geyB3cml0YWJsZTogZmFsc2UsIGVudW1lcmFibGU6IGZhbHNlLCBjb25maWd1cmFibGU6IGZhbHNlLCB2YWx1ZTogLTEgfTtcbmNvbnN0IHJvd0luZGV4RGVzY3JpcHRvciA9IHsgd3JpdGFibGU6IGZhbHNlLCBlbnVtZXJhYmxlOiBmYWxzZSwgY29uZmlndXJhYmxlOiB0cnVlLCB2YWx1ZTogbnVsbCBhcyBhbnkgfTtcbmNvbnN0IHJvd1BhcmVudERlc2NyaXB0b3IgPSB7IHdyaXRhYmxlOiBmYWxzZSwgZW51bWVyYWJsZTogZmFsc2UsIGNvbmZpZ3VyYWJsZTogZmFsc2UsIHZhbHVlOiBudWxsIGFzIGFueSB9O1xuY29uc3Qgcm93ID0geyBwYXJlbnQ6IHJvd1BhcmVudERlc2NyaXB0b3IsIHJvd0luZGV4OiByb3dJbmRleERlc2NyaXB0b3IgfTtcblxuZXhwb3J0IGNsYXNzIFJvdzxUIGV4dGVuZHMgeyBba2V5OiBzdHJpbmddOiBEYXRhVHlwZSB9PiBpbXBsZW1lbnRzIEl0ZXJhYmxlPFRba2V5b2YgVF1bJ1RWYWx1ZSddPiB7XG4gICAgW2tleTogc3RyaW5nXTogVFtrZXlvZiBUXVsnVFZhbHVlJ107XG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgcHVibGljIHN0YXRpYyBuZXc8VCBleHRlbmRzIHsgW2tleTogc3RyaW5nXTogRGF0YVR5cGUgfT4oc2NoZW1hT3JGaWVsZHM6IFQgfCBGaWVsZFtdLCBmaWVsZHNBcmVFbnVtZXJhYmxlID0gZmFsc2UpOiBSb3dMaWtlPFQ+ICYgUm93PFQ+IHtcbiAgICAgICAgbGV0IHNjaGVtYTogVCwgZmllbGRzOiBGaWVsZFtdO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzY2hlbWFPckZpZWxkcykpIHtcbiAgICAgICAgICAgIGZpZWxkcyA9IHNjaGVtYU9yRmllbGRzO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2NoZW1hID0gc2NoZW1hT3JGaWVsZHM7XG4gICAgICAgICAgICBmaWVsZHNBcmVFbnVtZXJhYmxlID0gdHJ1ZTtcbiAgICAgICAgICAgIGZpZWxkcyA9IE9iamVjdC5rZXlzKHNjaGVtYSkubWFwKCh4KSA9PiBuZXcgRmllbGQoeCwgc2NoZW1hW3hdKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBSb3c8VD4oZmllbGRzLCBmaWVsZHNBcmVFbnVtZXJhYmxlKSBhcyBSb3dMaWtlPFQ+ICYgUm93PFQ+O1xuICAgIH1cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJpdmF0ZSBwYXJlbnQ6IFRQYXJlbnQ7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHByaXZhdGUgcm93SW5kZXg6IG51bWJlcjtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHVibGljIHJlYWRvbmx5IGxlbmd0aDogbnVtYmVyO1xuICAgIHByaXZhdGUgY29uc3RydWN0b3IoZmllbGRzOiBGaWVsZFtdLCBmaWVsZHNBcmVFbnVtZXJhYmxlOiBib29sZWFuKSB7XG4gICAgICAgIGxlbmd0aERlc2NyaXB0b3IudmFsdWUgPSBmaWVsZHMubGVuZ3RoO1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2xlbmd0aCcsIGxlbmd0aERlc2NyaXB0b3IpO1xuICAgICAgICBmaWVsZHMuZm9yRWFjaCgoZmllbGQsIGNvbHVtbkluZGV4KSA9PiB7XG4gICAgICAgICAgICBjb2x1bW5EZXNjcmlwdG9yLmdldCA9IHRoaXMuX2JpbmRHZXR0ZXIoY29sdW1uSW5kZXgpO1xuICAgICAgICAgICAgLy8gc2V0IGNvbmZpZ3VyYWJsZSB0byB0cnVlIHRvIGVuc3VyZSBPYmplY3QuZGVmaW5lUHJvcGVydHlcbiAgICAgICAgICAgIC8vIGRvZXNuJ3QgdGhyb3cgaW4gdGhlIGNhc2Ugb2YgZHVwbGljYXRlIGNvbHVtbiBuYW1lc1xuICAgICAgICAgICAgY29sdW1uRGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlO1xuICAgICAgICAgICAgY29sdW1uRGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZmllbGRzQXJlRW51bWVyYWJsZTtcbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBmaWVsZC5uYW1lLCBjb2x1bW5EZXNjcmlwdG9yKTtcbiAgICAgICAgICAgIGNvbHVtbkRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gZmFsc2U7XG4gICAgICAgICAgICBjb2x1bW5EZXNjcmlwdG9yLmVudW1lcmFibGUgPSAhZmllbGRzQXJlRW51bWVyYWJsZTtcbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBjb2x1bW5JbmRleCwgY29sdW1uRGVzY3JpcHRvcik7XG4gICAgICAgICAgICBjb2x1bW5EZXNjcmlwdG9yLmdldCA9IG51bGwgYXMgYW55O1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgKltTeW1ib2wuaXRlcmF0b3JdKHRoaXM6IFJvd0xpa2U8VD4pIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IC0xLCBuID0gdGhpcy5sZW5ndGg7ICsraSA8IG47KSB7XG4gICAgICAgICAgICB5aWVsZCB0aGlzW2ldO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgX2JpbmRHZXR0ZXIoY29sSW5kZXg6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoaXM6IFJvdzxUPikge1xuICAgICAgICAgICAgbGV0IGNoaWxkID0gdGhpcy5wYXJlbnQuZ2V0Q2hpbGRBdChjb2xJbmRleCk7XG4gICAgICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5nZXQodGhpcy5yb3dJbmRleCkgOiBudWxsO1xuICAgICAgICB9O1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0PEsgZXh0ZW5kcyBrZXlvZiBUPihrZXk6IEspIHsgcmV0dXJuICh0aGlzIGFzIGFueSlba2V5XSBhcyBUW0tdWydUVmFsdWUnXTsgfVxuICAgIHB1YmxpYyBiaW5kPFRQYXJlbnQgZXh0ZW5kcyBNYXBWZWN0b3I8VD4gfCBTdHJ1Y3RWZWN0b3I8VD4+KHBhcmVudDogVFBhcmVudCwgcm93SW5kZXg6IG51bWJlcikge1xuICAgICAgICByb3dJbmRleERlc2NyaXB0b3IudmFsdWUgPSByb3dJbmRleDtcbiAgICAgICAgcm93UGFyZW50RGVzY3JpcHRvci52YWx1ZSA9IHBhcmVudDtcbiAgICAgICAgY29uc3QgYm91bmQgPSBPYmplY3QuY3JlYXRlKHRoaXMsIHJvdyk7XG4gICAgICAgIHJvd0luZGV4RGVzY3JpcHRvci52YWx1ZSA9IG51bGw7XG4gICAgICAgIHJvd1BhcmVudERlc2NyaXB0b3IudmFsdWUgPSBudWxsO1xuICAgICAgICByZXR1cm4gYm91bmQgYXMgUm93TGlrZTxUPjtcbiAgICB9XG4gICAgcHVibGljIHRvSlNPTigpOiBhbnkge1xuICAgICAgICByZXR1cm4gRGF0YVR5cGUuaXNTdHJ1Y3QodGhpcy5wYXJlbnQudHlwZSkgPyBbLi4udGhpc10gOlxuICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModGhpcykucmVkdWNlKChwcm9wczogYW55LCBwcm9wOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKHByb3BzW3Byb3BdID0gKHRoaXMgYXMgYW55KVtwcm9wXSkgJiYgcHJvcHMgfHwgcHJvcHNcbiAgICAgICAgICAgIH0sIHt9KTtcbiAgICB9XG4gICAgcHVibGljIHRvU3RyaW5nKCkge1xuICAgICAgICByZXR1cm4gRGF0YVR5cGUuaXNTdHJ1Y3QodGhpcy5wYXJlbnQudHlwZSkgP1xuICAgICAgICAgICAgWy4uLnRoaXNdLm1hcCgoeCkgPT4gdmFsdWVUb1N0cmluZyh4KSkuam9pbignLCAnKSA6XG4gICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0aGlzKS5yZWR1Y2UoKHByb3BzOiBhbnksIHByb3A6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAocHJvcHNbcHJvcF0gPSB2YWx1ZVRvU3RyaW5nKCh0aGlzIGFzIGFueSlbcHJvcF0pKSAmJiBwcm9wcyB8fCBwcm9wc1xuICAgICAgICAgICAgfSwge30pO1xuICAgIH1cbn1cbiJdfQ==
