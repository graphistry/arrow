"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const vector_1 = require("../vector");
const pretty_1 = require("../util/pretty");
class NestedView {
    constructor(data, children) {
        this.length = data.length;
        this.childData = data.childData;
        this.numChildren = data.childData.length;
        this._children = children || new Array(this.numChildren);
    }
    clone(data) {
        return new this.constructor(data, this._children);
    }
    isValid() {
        return true;
    }
    toArray() {
        return [...this];
    }
    indexOf(_) {
        throw new Error(`Not implemented yet`);
    }
    toJSON() { return this.toArray(); }
    toString() {
        return [...this].map((x) => pretty_1.valueToString(x)).join(', ');
    }
    get(index) {
        return this.getNested(this, index);
    }
    set(index, value) {
        return this.setNested(this, index, value);
    }
    getChildAt(index) {
        return index < 0 || index >= this.numChildren
            ? null
            : this._children[index] ||
                (this._children[index] = vector_1.Vector.create(this.childData[index]));
    }
    *[Symbol.iterator]() {
        const get = this.getNested;
        const length = this.length;
        for (let index = -1; ++index < length;) {
            yield get(this, index);
        }
    }
}
exports.NestedView = NestedView;
class UnionView extends NestedView {
    constructor(data, children) {
        super(data, children);
        this.length = data.length;
        this.typeIds = data.typeIds;
        this.typeIdToChildIndex = data.typeIdToChildIndex;
    }
    getNested(self, index) {
        return self.getChildValue(self, index, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    setNested(self, index, value) {
        return self.setChildValue(self, index, value, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    getChildValue(self, index, typeIds, _valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.get(index) : null;
    }
    setChildValue(self, index, value, typeIds, _valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.set(index, value) : null;
    }
    *[Symbol.iterator]() {
        const length = this.length;
        const get = this.getChildValue;
        const { typeIdToChildIndex } = this;
        const { typeIds, valueOffsets } = this;
        for (let index = -1; ++index < length;) {
            yield get(this, index, typeIds, valueOffsets, typeIdToChildIndex);
        }
    }
}
exports.UnionView = UnionView;
class DenseUnionView extends UnionView {
    constructor(data, children) {
        super(data, children);
        this.valueOffsets = data.valueOffsets;
    }
    getNested(self, index) {
        return self.getChildValue(self, index, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    getChildValue(self, index, typeIds, valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.get(valueOffsets[index]) : null;
    }
    setChildValue(self, index, value, typeIds, valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.set(valueOffsets[index], value) : null;
    }
}
exports.DenseUnionView = DenseUnionView;
class StructView extends NestedView {
    constructor(data, children) {
        super(data, children);
        // Make a customized RowView that includes proxies for
        class RowProxy extends RowView {
        }
        const proto = RowProxy.prototype;
        data.type.children.forEach(function (f, i) {
            Object.defineProperty(proto, f.name, {
                get: function () {
                    return this.get(i);
                },
                enumerable: true
            });
        });
        this.RowView = RowProxy;
    }
    getNested(self, index) {
        return new self.RowView(self, self._children, index);
    }
    setNested(self, index, value) {
        let idx = -1, len = self.numChildren, child;
        if (!(value instanceof NestedView || value instanceof vector_1.Vector)) {
            while (++idx < len) {
                if (child = self.getChildAt(idx)) {
                    child.set(index, value[idx]);
                }
            }
        }
        else {
            while (++idx < len) {
                if (child = self.getChildAt(idx)) {
                    child.set(index, value.get(idx));
                }
            }
        }
    }
}
exports.StructView = StructView;
class MapView extends NestedView {
    constructor(data, children) {
        super(data, children);
        this.typeIds = data.type.children.reduce((xs, x, i) => (xs[x.name] = i) && xs || xs, Object.create(null));
    }
    getNested(self, index) {
        return new MapRowView(self, self._children, index);
    }
    setNested(self, index, value) {
        let typeIds = self.typeIds, child;
        if (!(value instanceof NestedView || value instanceof vector_1.Vector)) {
            for (const key in typeIds) {
                if (child = self.getChildAt(typeIds[key])) {
                    child.set(index, value[key]);
                }
            }
        }
        else {
            for (const key in typeIds) {
                if (child = self.getChildAt(typeIds[key])) {
                    child.set(index, value.get(key));
                }
            }
        }
    }
}
exports.MapView = MapView;
class RowView extends UnionView {
    constructor(data, children, rowIndex) {
        super(data, children);
        this.rowIndex = rowIndex || 0;
        this.length = data.numChildren;
    }
    clone(data) {
        return new this.constructor(data, this._children, this.rowIndex);
    }
    getChildValue(self, index, _typeIds, _valueOffsets) {
        const child = self.getChildAt(index);
        return child ? child.get(self.rowIndex) : null;
    }
    setChildValue(self, index, value, _typeIds, _valueOffsets) {
        const child = self.getChildAt(index);
        return child ? child.set(self.rowIndex, value) : null;
    }
}
exports.RowView = RowView;
class MapRowView extends RowView {
    toJSON() {
        const get = this.getChildValue;
        const result = {};
        const typeIds = this.typeIds;
        for (const name in typeIds) {
            result[name] = get(this, name, typeIds, null);
        }
        return result;
    }
    getChildValue(self, key, typeIds, _valueOffsets) {
        const child = self.getChildAt(typeIds[key]);
        return child ? child.get(self.rowIndex) : null;
    }
    setChildValue(self, key, value, typeIds, _valueOffsets) {
        const child = self.getChildAt(typeIds[key]);
        return child ? child.set(self.rowIndex, value) : null;
    }
}
exports.MapRowView = MapRowView;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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TTtRQUNULE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDL0IsTUFBTSxNQUFNLEdBQUcsRUFBMEIsQ0FBQztRQUMxQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBa0MsQ0FBQztRQUN4RCxLQUFLLE1BQU0sSUFBSSxJQUFJLE9BQU8sRUFBRTtZQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ2pEO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUNTLGFBQWEsQ0FBQyxJQUFnQixFQUFFLEdBQVEsRUFBRSxPQUFZLEVBQUUsYUFBa0I7UUFDaEYsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUM1QyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNuRCxDQUFDO0lBQ1MsYUFBYSxDQUFDLElBQWdCLEVBQUUsR0FBUSxFQUFFLEtBQVUsRUFBRSxPQUFZLEVBQUUsYUFBbUI7UUFDN0YsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUM1QyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDMUQsQ0FBQztDQUNKO0FBcEJELGdDQW9CQyIsImZpbGUiOiJ2ZWN0b3IvbmVzdGVkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuLy8gb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4vLyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuLy8gcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuLy8gdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuLy8gXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4vLyB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4vLyBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuLy8gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbi8vIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuLy8gc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuLy8gdW5kZXIgdGhlIExpY2Vuc2UuXG5cbmltcG9ydCB7IERhdGEgfSBmcm9tICcuLi9kYXRhJztcbmltcG9ydCB7IFZpZXcsIFZlY3RvciB9IGZyb20gJy4uL3ZlY3Rvcic7XG5pbXBvcnQgeyBJdGVyYWJsZUFycmF5TGlrZSB9IGZyb20gJy4uL3R5cGUnO1xuaW1wb3J0IHsgdmFsdWVUb1N0cmluZyB9IGZyb20gJy4uL3V0aWwvcHJldHR5JztcbmltcG9ydCB7IERhdGFUeXBlLCBOZXN0ZWRUeXBlLCBEZW5zZVVuaW9uLCBTcGFyc2VVbmlvbiwgU3RydWN0LCBNYXBfIH0gZnJvbSAnLi4vdHlwZSc7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBOZXN0ZWRWaWV3PFQgZXh0ZW5kcyBOZXN0ZWRUeXBlPiBpbXBsZW1lbnRzIFZpZXc8VD4ge1xuICAgIHB1YmxpYyBsZW5ndGg6IG51bWJlcjtcbiAgICBwdWJsaWMgbnVtQ2hpbGRyZW46IG51bWJlcjtcbiAgICBwdWJsaWMgY2hpbGREYXRhOiBEYXRhPGFueT5bXTtcbiAgICBwcm90ZWN0ZWQgX2NoaWxkcmVuOiBWZWN0b3I8YW55PltdO1xuICAgIGNvbnN0cnVjdG9yKGRhdGE6IERhdGE8VD4sIGNoaWxkcmVuPzogVmVjdG9yPGFueT5bXSkge1xuICAgICAgICB0aGlzLmxlbmd0aCA9IGRhdGEubGVuZ3RoO1xuICAgICAgICB0aGlzLmNoaWxkRGF0YSA9IGRhdGEuY2hpbGREYXRhO1xuICAgICAgICB0aGlzLm51bUNoaWxkcmVuID0gZGF0YS5jaGlsZERhdGEubGVuZ3RoO1xuICAgICAgICB0aGlzLl9jaGlsZHJlbiA9IGNoaWxkcmVuIHx8IG5ldyBBcnJheSh0aGlzLm51bUNoaWxkcmVuKTtcbiAgICB9XG4gICAgcHVibGljIGNsb25lKGRhdGE6IERhdGE8VD4pOiB0aGlzIHtcbiAgICAgICAgcmV0dXJuIG5ldyAoPGFueT4gdGhpcy5jb25zdHJ1Y3RvcikoZGF0YSwgdGhpcy5fY2hpbGRyZW4pIGFzIHRoaXM7XG4gICAgfVxuICAgIHB1YmxpYyBpc1ZhbGlkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcHVibGljIHRvQXJyYXkoKTogSXRlcmFibGVBcnJheUxpa2U8VFsnVFZhbHVlJ10+IHtcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzXTtcbiAgICB9XG4gICAgcHVibGljIGluZGV4T2YoXzogVFsnVFZhbHVlJ10pOiBudW1iZXIge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBpbXBsZW1lbnRlZCB5ZXRgKTtcbiAgICB9XG4gICAgcHVibGljIHRvSlNPTigpOiBhbnkgeyByZXR1cm4gdGhpcy50b0FycmF5KCk7IH1cbiAgICBwdWJsaWMgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpc10ubWFwKCh4KSA9PiB2YWx1ZVRvU3RyaW5nKHgpKS5qb2luKCcsICcpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0KGluZGV4OiBudW1iZXIpOiBUWydUVmFsdWUnXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldE5lc3RlZCh0aGlzLCBpbmRleCk7XG4gICAgfVxuICAgIHB1YmxpYyBzZXQoaW5kZXg6IG51bWJlciwgdmFsdWU6IFRbJ1RWYWx1ZSddKTogdm9pZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnNldE5lc3RlZCh0aGlzLCBpbmRleCwgdmFsdWUpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0TmVzdGVkKHNlbGY6IE5lc3RlZFZpZXc8VD4sIGluZGV4OiBudW1iZXIpOiBUWydUVmFsdWUnXTtcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2V0TmVzdGVkKHNlbGY6IE5lc3RlZFZpZXc8VD4sIGluZGV4OiBudW1iZXIsIHZhbHVlOiBUWydUVmFsdWUnXSk6IHZvaWQ7XG4gICAgcHVibGljIGdldENoaWxkQXQ8UiBleHRlbmRzIERhdGFUeXBlID0gRGF0YVR5cGU+KGluZGV4OiBudW1iZXIpOiBWZWN0b3I8Uj4gfCBudWxsIHtcbiAgICAgICAgcmV0dXJuIGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLm51bUNoaWxkcmVuXG4gICAgICAgICAgICA/IG51bGxcbiAgICAgICAgICAgIDogKHRoaXMuX2NoaWxkcmVuW2luZGV4XSBhcyBWZWN0b3I8Uj4pIHx8XG4gICAgICAgICAgICAgICh0aGlzLl9jaGlsZHJlbltpbmRleF0gPSBWZWN0b3IuY3JlYXRlPFI+KHRoaXMuY2hpbGREYXRhW2luZGV4XSkpO1xuICAgIH1cbiAgICBwdWJsaWMgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8VFsnVFZhbHVlJ10+IHtcbiAgICAgICAgY29uc3QgZ2V0ID0gdGhpcy5nZXROZXN0ZWQ7XG4gICAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMubGVuZ3RoO1xuICAgICAgICBmb3IgKGxldCBpbmRleCA9IC0xOyArK2luZGV4IDwgbGVuZ3RoOykge1xuICAgICAgICAgICAgeWllbGQgZ2V0KHRoaXMsIGluZGV4KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFVuaW9uVmlldzxUIGV4dGVuZHMgKERlbnNlVW5pb24gfCBTcGFyc2VVbmlvbikgPSBTcGFyc2VVbmlvbj4gZXh0ZW5kcyBOZXN0ZWRWaWV3PFQ+IHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHVibGljIHR5cGVJZHM6IEludDhBcnJheTtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHVibGljIHZhbHVlT2Zmc2V0cz86IEludDMyQXJyYXk7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHByb3RlY3RlZCB0eXBlSWRUb0NoaWxkSW5kZXg6IHsgW2tleTogbnVtYmVyXTogbnVtYmVyIH07XG4gICAgY29uc3RydWN0b3IoZGF0YTogRGF0YTxUPiwgY2hpbGRyZW4/OiBWZWN0b3I8YW55PltdKSB7XG4gICAgICAgIHN1cGVyKGRhdGEsIGNoaWxkcmVuKTtcbiAgICAgICAgdGhpcy5sZW5ndGggPSBkYXRhLmxlbmd0aDtcbiAgICAgICAgdGhpcy50eXBlSWRzID0gZGF0YS50eXBlSWRzO1xuICAgICAgICB0aGlzLnR5cGVJZFRvQ2hpbGRJbmRleCA9IGRhdGEudHlwZUlkVG9DaGlsZEluZGV4O1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgZ2V0TmVzdGVkKHNlbGY6IFVuaW9uVmlldzxUPiwgaW5kZXg6IG51bWJlcik6IFRbJ1RWYWx1ZSddIHtcbiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0Q2hpbGRWYWx1ZShzZWxmLCBpbmRleCwgc2VsZi50eXBlSWRzLCBzZWxmLnZhbHVlT2Zmc2V0cywgc2VsZi50eXBlSWRUb0NoaWxkSW5kZXgpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgc2V0TmVzdGVkKHNlbGY6IFVuaW9uVmlldzxUPiwgaW5kZXg6IG51bWJlciwgdmFsdWU6IFRbJ1RWYWx1ZSddKTogdm9pZCB7XG4gICAgICAgIHJldHVybiBzZWxmLnNldENoaWxkVmFsdWUoc2VsZiwgaW5kZXgsIHZhbHVlLCBzZWxmLnR5cGVJZHMsIHNlbGYudmFsdWVPZmZzZXRzLCBzZWxmLnR5cGVJZFRvQ2hpbGRJbmRleCk7XG4gICAgfVxuICAgIHByb3RlY3RlZCBnZXRDaGlsZFZhbHVlKHNlbGY6IE5lc3RlZFZpZXc8VD4sIGluZGV4OiBudW1iZXIsIHR5cGVJZHM6IEludDhBcnJheSwgX3ZhbHVlT2Zmc2V0czogYW55LCB0eXBlSWRUb0NoaWxkSW5kZXg6IHsgW2tleTogbnVtYmVyXTogbnVtYmVyIH0pOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQodHlwZUlkVG9DaGlsZEluZGV4W3R5cGVJZHNbaW5kZXhdXSk7XG4gICAgICAgIHJldHVybiBjaGlsZCA/IGNoaWxkLmdldChpbmRleCkgOiBudWxsO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgc2V0Q2hpbGRWYWx1ZShzZWxmOiBOZXN0ZWRWaWV3PFQ+LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogVFsnVFZhbHVlJ10sIHR5cGVJZHM6IEludDhBcnJheSwgX3ZhbHVlT2Zmc2V0czogYW55LCB0eXBlSWRUb0NoaWxkSW5kZXg6IHsgW2tleTogbnVtYmVyXTogbnVtYmVyIH0pOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQodHlwZUlkVG9DaGlsZEluZGV4W3R5cGVJZHNbaW5kZXhdXSk7XG4gICAgICAgIHJldHVybiBjaGlsZCA/IGNoaWxkLnNldChpbmRleCwgdmFsdWUpIDogbnVsbDtcbiAgICB9XG4gICAgcHVibGljICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPFRbJ1RWYWx1ZSddPiB7XG4gICAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMubGVuZ3RoO1xuICAgICAgICBjb25zdCBnZXQgPSB0aGlzLmdldENoaWxkVmFsdWU7XG4gICAgICAgIGNvbnN0IHsgdHlwZUlkVG9DaGlsZEluZGV4IH0gPSB0aGlzO1xuICAgICAgICBjb25zdCB7IHR5cGVJZHMsIHZhbHVlT2Zmc2V0cyB9ID0gdGhpcztcbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAtMTsgKytpbmRleCA8IGxlbmd0aDspIHtcbiAgICAgICAgICAgIHlpZWxkIGdldCh0aGlzLCBpbmRleCwgdHlwZUlkcywgdmFsdWVPZmZzZXRzLCB0eXBlSWRUb0NoaWxkSW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGVuc2VVbmlvblZpZXcgZXh0ZW5kcyBVbmlvblZpZXc8RGVuc2VVbmlvbj4ge1xuICAgIHB1YmxpYyB2YWx1ZU9mZnNldHM6IEludDMyQXJyYXk7XG4gICAgY29uc3RydWN0b3IoZGF0YTogRGF0YTxEZW5zZVVuaW9uPiwgY2hpbGRyZW4/OiBWZWN0b3I8YW55PltdKSB7XG4gICAgICAgIHN1cGVyKGRhdGEsIGNoaWxkcmVuKTtcbiAgICAgICAgdGhpcy52YWx1ZU9mZnNldHMgPSBkYXRhLnZhbHVlT2Zmc2V0cztcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldE5lc3RlZChzZWxmOiBEZW5zZVVuaW9uVmlldywgaW5kZXg6IG51bWJlcik6IGFueSB8IG51bGwge1xuICAgICAgICByZXR1cm4gc2VsZi5nZXRDaGlsZFZhbHVlKHNlbGYsIGluZGV4LCBzZWxmLnR5cGVJZHMsIHNlbGYudmFsdWVPZmZzZXRzLCBzZWxmLnR5cGVJZFRvQ2hpbGRJbmRleCk7XG4gICAgfVxuICAgIHByb3RlY3RlZCBnZXRDaGlsZFZhbHVlKHNlbGY6IE5lc3RlZFZpZXc8RGVuc2VVbmlvbj4sIGluZGV4OiBudW1iZXIsIHR5cGVJZHM6IEludDhBcnJheSwgdmFsdWVPZmZzZXRzOiBhbnksIHR5cGVJZFRvQ2hpbGRJbmRleDogeyBba2V5OiBudW1iZXJdOiBudW1iZXIgfSk6IGFueSB8IG51bGwge1xuICAgICAgICBjb25zdCBjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRUb0NoaWxkSW5kZXhbdHlwZUlkc1tpbmRleF1dKTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuZ2V0KHZhbHVlT2Zmc2V0c1tpbmRleF0pIDogbnVsbDtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHNldENoaWxkVmFsdWUoc2VsZjogTmVzdGVkVmlldzxEZW5zZVVuaW9uPiwgaW5kZXg6IG51bWJlciwgdmFsdWU6IGFueSwgdHlwZUlkczogSW50OEFycmF5LCB2YWx1ZU9mZnNldHM6IGFueSwgdHlwZUlkVG9DaGlsZEluZGV4OiB7IFtrZXk6IG51bWJlcl06IG51bWJlciB9KTogYW55IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KHR5cGVJZFRvQ2hpbGRJbmRleFt0eXBlSWRzW2luZGV4XV0pO1xuICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5zZXQodmFsdWVPZmZzZXRzW2luZGV4XSwgdmFsdWUpIDogbnVsbDtcbiAgICB9XG59XG5cbnR5cGUgUm93UHJveHkgPSB7W25hbWU6IHN0cmluZ106IGFueX07XG5pbnRlcmZhY2UgUm93Vmlld0NvbnN0cnVjdG9yPFQgZXh0ZW5kcyBSb3dQcm94eSA9IFJvd1Byb3h5PiB7XG4gICAgcmVhZG9ubHkgcHJvdG90eXBlOiBUICYgUm93VmlldztcbiAgICBuZXcgKGRhdGE6IERhdGE8U3BhcnNlVW5pb24+ICYgTmVzdGVkVmlldzxhbnk+LCBjaGlsZHJlbj86IFZlY3Rvcjxhbnk+W10sIHJvd0luZGV4PzogbnVtYmVyKTogVCAmIFJvd1ZpZXc7XG59XG5cbmV4cG9ydCBjbGFzcyBTdHJ1Y3RWaWV3IGV4dGVuZHMgTmVzdGVkVmlldzxTdHJ1Y3Q+IHtcbiAgICBwcml2YXRlIFJvd1ZpZXc6IFJvd1ZpZXdDb25zdHJ1Y3RvcjtcblxuICAgIGNvbnN0cnVjdG9yKGRhdGE6IERhdGE8U3RydWN0PiwgY2hpbGRyZW4/OiBWZWN0b3I8YW55PltdKSB7XG4gICAgICAgIHN1cGVyKGRhdGEsIGNoaWxkcmVuKTtcblxuICAgICAgICAvLyBNYWtlIGEgY3VzdG9taXplZCBSb3dWaWV3IHRoYXQgaW5jbHVkZXMgcHJveGllcyBmb3JcbiAgICAgICAgY2xhc3MgUm93UHJveHkgZXh0ZW5kcyBSb3dWaWV3IHt9XG5cbiAgICAgICAgY29uc3QgcHJvdG8gPSBSb3dQcm94eS5wcm90b3R5cGU7XG5cbiAgICAgICAgZGF0YS50eXBlLmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGYsIGkpIHtcbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90bywgZi5uYW1lLCB7XG4gICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcyBhcyBhbnkgYXMgUm93VmlldykuZ2V0KGkpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuUm93VmlldyA9IChSb3dQcm94eSBhcyBhbnkpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgZ2V0TmVzdGVkKHNlbGY6IFN0cnVjdFZpZXcsIGluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBzZWxmLlJvd1ZpZXcoc2VsZiBhcyBhbnksIHNlbGYuX2NoaWxkcmVuLCBpbmRleCk7XG4gICAgfVxuICAgIHByb3RlY3RlZCBzZXROZXN0ZWQoc2VsZjogU3RydWN0VmlldywgaW5kZXg6IG51bWJlciwgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgICAgICBsZXQgaWR4ID0gLTEsIGxlbiA9IHNlbGYubnVtQ2hpbGRyZW4sIGNoaWxkOiBWZWN0b3IgfCBudWxsO1xuICAgICAgICBpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIE5lc3RlZFZpZXcgfHwgdmFsdWUgaW5zdGFuY2VvZiBWZWN0b3IpKSB7XG4gICAgICAgICAgICB3aGlsZSAoKytpZHggPCBsZW4pIHtcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPSBzZWxmLmdldENoaWxkQXQoaWR4KSkge1xuICAgICAgICAgICAgICAgICAgICBjaGlsZC5zZXQoaW5kZXgsIHZhbHVlW2lkeF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHdoaWxlICgrK2lkeCA8IGxlbikge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdChpZHgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkLnNldChpbmRleCwgdmFsdWUuZ2V0KGlkeCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIE1hcFZpZXcgZXh0ZW5kcyBOZXN0ZWRWaWV3PE1hcF8+IHtcbiAgICBwdWJsaWMgdHlwZUlkczogeyBbazogc3RyaW5nXTogbnVtYmVyIH07XG4gICAgY29uc3RydWN0b3IoZGF0YTogRGF0YTxNYXBfPiwgY2hpbGRyZW4/OiBWZWN0b3I8YW55PltdKSB7XG4gICAgICAgIHN1cGVyKGRhdGEsIGNoaWxkcmVuKTtcbiAgICAgICAgdGhpcy50eXBlSWRzID0gZGF0YS50eXBlLmNoaWxkcmVuLnJlZHVjZSgoeHMsIHgsIGkpID0+XG4gICAgICAgICAgICAoeHNbeC5uYW1lXSA9IGkpICYmIHhzIHx8IHhzLCBPYmplY3QuY3JlYXRlKG51bGwpKTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldE5lc3RlZChzZWxmOiBNYXBWaWV3LCBpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBuZXcgTWFwUm93VmlldyhzZWxmIGFzIGFueSwgc2VsZi5fY2hpbGRyZW4sIGluZGV4KTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHNldE5lc3RlZChzZWxmOiBNYXBWaWV3LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogeyBbazogc3RyaW5nXTogYW55IH0pOiB2b2lkIHtcbiAgICAgICAgbGV0IHR5cGVJZHMgPSBzZWxmLnR5cGVJZHMgYXMgYW55LCBjaGlsZDogVmVjdG9yIHwgbnVsbDtcbiAgICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBOZXN0ZWRWaWV3IHx8IHZhbHVlIGluc3RhbmNlb2YgVmVjdG9yKSkge1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdHlwZUlkcykge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRzW2tleV0pKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkLnNldChpbmRleCwgdmFsdWVba2V5XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdHlwZUlkcykge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRzW2tleV0pKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkLnNldChpbmRleCwgdmFsdWUuZ2V0KGtleSBhcyBhbnkpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSb3dWaWV3IGV4dGVuZHMgVW5pb25WaWV3PFNwYXJzZVVuaW9uPiB7XG4gICAgcHJvdGVjdGVkIHJvd0luZGV4OiBudW1iZXI7XG4gICAgY29uc3RydWN0b3IoZGF0YTogRGF0YTxTcGFyc2VVbmlvbj4gJiBOZXN0ZWRWaWV3PGFueT4sIGNoaWxkcmVuPzogVmVjdG9yPGFueT5bXSwgcm93SW5kZXg/OiBudW1iZXIpIHtcbiAgICAgICAgc3VwZXIoZGF0YSwgY2hpbGRyZW4pO1xuICAgICAgICB0aGlzLnJvd0luZGV4ID0gcm93SW5kZXggfHwgMDtcbiAgICAgICAgdGhpcy5sZW5ndGggPSBkYXRhLm51bUNoaWxkcmVuO1xuICAgIH1cbiAgICBwdWJsaWMgY2xvbmUoZGF0YTogRGF0YTxTcGFyc2VVbmlvbj4gJiBOZXN0ZWRWaWV3PGFueT4pOiB0aGlzIHtcbiAgICAgICAgcmV0dXJuIG5ldyAoPGFueT4gdGhpcy5jb25zdHJ1Y3RvcikoZGF0YSwgdGhpcy5fY2hpbGRyZW4sIHRoaXMucm93SW5kZXgpIGFzIHRoaXM7XG4gICAgfVxuICAgIHByb3RlY3RlZCBnZXRDaGlsZFZhbHVlKHNlbGY6IFJvd1ZpZXcsIGluZGV4OiBudW1iZXIsIF90eXBlSWRzOiBhbnksIF92YWx1ZU9mZnNldHM/OiBhbnkpOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQoaW5kZXgpO1xuICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5nZXQoc2VsZi5yb3dJbmRleCkgOiBudWxsO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgc2V0Q2hpbGRWYWx1ZShzZWxmOiBSb3dWaWV3LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogYW55LCBfdHlwZUlkczogYW55LCBfdmFsdWVPZmZzZXRzPzogYW55KTogYW55IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KGluZGV4KTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuc2V0KHNlbGYucm93SW5kZXgsIHZhbHVlKSA6IG51bGw7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTWFwUm93VmlldyBleHRlbmRzIFJvd1ZpZXcge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwdWJsaWMgdHlwZUlkczogYW55O1xuICAgIHB1YmxpYyB0b0pTT04oKSB7XG4gICAgICAgIGNvbnN0IGdldCA9IHRoaXMuZ2V0Q2hpbGRWYWx1ZTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge30gYXMgeyBbazogc3RyaW5nXTogYW55IH07XG4gICAgICAgIGNvbnN0IHR5cGVJZHMgPSB0aGlzLnR5cGVJZHMgYXMgeyBbazogc3RyaW5nXTogbnVtYmVyIH07XG4gICAgICAgIGZvciAoY29uc3QgbmFtZSBpbiB0eXBlSWRzKSB7XG4gICAgICAgICAgICByZXN1bHRbbmFtZV0gPSBnZXQodGhpcywgbmFtZSwgdHlwZUlkcywgbnVsbCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldENoaWxkVmFsdWUoc2VsZjogTWFwUm93Vmlldywga2V5OiBhbnksIHR5cGVJZHM6IGFueSwgX3ZhbHVlT2Zmc2V0czogYW55KTogYW55IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KHR5cGVJZHNba2V5XSk7XG4gICAgICAgIHJldHVybiBjaGlsZCA/IGNoaWxkLmdldChzZWxmLnJvd0luZGV4KSA6IG51bGw7XG4gICAgfVxuICAgIHByb3RlY3RlZCBzZXRDaGlsZFZhbHVlKHNlbGY6IE1hcFJvd1ZpZXcsIGtleTogYW55LCB2YWx1ZTogYW55LCB0eXBlSWRzOiBhbnksIF92YWx1ZU9mZnNldHM/OiBhbnkpOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQodHlwZUlkc1trZXldKTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuc2V0KHNlbGYucm93SW5kZXgsIHZhbHVlKSA6IG51bGw7XG4gICAgfVxufVxuIl19
