"use strict";
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
Object.defineProperty(exports, "__esModule", { value: true });
const vector_1 = require("../vector");
const pretty_1 = require("../util/pretty");
class NestedView {
    constructor(data, children) {
        this.length = data.length;
        this.childData = data.childData;
        this.numChildren = data.childData.length;
        this._children = children || new Array(this.numChildren);
    }
    clone(data) {
        return new this.constructor(data, this._children);
    }
    isValid() {
        return true;
    }
    toArray() {
        return [...this];
    }
    indexOf(_) {
        throw new Error(`Not implemented yet`);
    }
    toJSON() { return this.toArray(); }
    toString() {
        return [...this].map((x) => pretty_1.valueToString(x)).join(', ');
    }
    get(index) {
        return this.getNested(this, index);
    }
    set(index, value) {
        return this.setNested(this, index, value);
    }
    getChildAt(index) {
        return index < 0 || index >= this.numChildren
            ? null
            : this._children[index] ||
                (this._children[index] = vector_1.Vector.create(this.childData[index]));
    }
    *[Symbol.iterator]() {
        const get = this.getNested;
        const length = this.length;
        for (let index = -1; ++index < length;) {
            yield get(this, index);
        }
    }
}
exports.NestedView = NestedView;
class UnionView extends NestedView {
    constructor(data, children) {
        super(data, children);
        this.length = data.length;
        this.typeIds = data.typeIds;
        this.typeIdToChildIndex = data.typeIdToChildIndex;
    }
    getNested(self, index) {
        return self.getChildValue(self, index, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    setNested(self, index, value) {
        return self.setChildValue(self, index, value, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    getChildValue(self, index, typeIds, _valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.get(index) : null;
    }
    setChildValue(self, index, value, typeIds, _valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.set(index, value) : null;
    }
    *[Symbol.iterator]() {
        const length = this.length;
        const get = this.getChildValue;
        const { typeIdToChildIndex } = this;
        const { typeIds, valueOffsets } = this;
        for (let index = -1; ++index < length;) {
            yield get(this, index, typeIds, valueOffsets, typeIdToChildIndex);
        }
    }
}
exports.UnionView = UnionView;
class DenseUnionView extends UnionView {
    constructor(data, children) {
        super(data, children);
        this.valueOffsets = data.valueOffsets;
    }
    getNested(self, index) {
        return self.getChildValue(self, index, self.typeIds, self.valueOffsets, self.typeIdToChildIndex);
    }
    getChildValue(self, index, typeIds, valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.get(valueOffsets[index]) : null;
    }
    setChildValue(self, index, value, typeIds, valueOffsets, typeIdToChildIndex) {
        const child = self.getChildAt(typeIdToChildIndex[typeIds[index]]);
        return child ? child.set(valueOffsets[index], value) : null;
    }
}
exports.DenseUnionView = DenseUnionView;
class StructView extends NestedView {
    getNested(self, index) {
        return new RowView(self, self._children, index);
    }
    setNested(self, index, value) {
        let idx = -1, len = self.numChildren, child;
        if (!(value instanceof NestedView || value instanceof vector_1.Vector)) {
            while (++idx < len) {
                if (child = self.getChildAt(idx)) {
                    child.set(index, value[idx]);
                }
            }
        }
        else {
            while (++idx < len) {
                if (child = self.getChildAt(idx)) {
                    child.set(index, value.get(idx));
                }
            }
        }
    }
}
exports.StructView = StructView;
class MapView extends NestedView {
    constructor(data, children) {
        super(data, children);
        this.typeIds = data.type.children.reduce((xs, x, i) => (xs[x.name] = i) && xs || xs, Object.create(null));
    }
    getNested(self, index) {
        return new MapRowView(self, self._children, index);
    }
    setNested(self, index, value) {
        let typeIds = self.typeIds, child;
        if (!(value instanceof NestedView || value instanceof vector_1.Vector)) {
            for (const key in typeIds) {
                if (child = self.getChildAt(typeIds[key])) {
                    child.set(index, value[key]);
                }
            }
        }
        else {
            for (const key in typeIds) {
                if (child = self.getChildAt(typeIds[key])) {
                    child.set(index, value.get(key));
                }
            }
        }
    }
}
exports.MapView = MapView;
class RowView extends UnionView {
    constructor(data, children, rowIndex) {
        super(data, children);
        this.rowIndex = rowIndex || 0;
        this.length = data.numChildren;
    }
    clone(data) {
        return new this.constructor(data, this._children, this.rowIndex);
    }
    getChildValue(self, index, _typeIds, _valueOffsets) {
        const child = self.getChildAt(index);
        return child ? child.get(self.rowIndex) : null;
    }
    setChildValue(self, index, value, _typeIds, _valueOffsets) {
        const child = self.getChildAt(index);
        return child ? child.set(self.rowIndex, value) : null;
    }
}
exports.RowView = RowView;
class MapRowView extends RowView {
    toJSON() {
        const get = this.getChildValue;
        const result = {};
        const typeIds = this.typeIds;
        for (const name in typeIds) {
            result[name] = get(this, name, typeIds, null);
        }
        return result;
    }
    getChildValue(self, key, typeIds, _valueOffsets) {
        const child = self.getChildAt(typeIds[key]);
        return child ? child.get(self.rowIndex) : null;
    }
    setChildValue(self, key, value, typeIds, _valueOffsets) {
        const child = self.getChildAt(typeIds[key]);
        return child ? child.set(self.rowIndex, value) : null;
    }
}
exports.MapRowView = MapRowView;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsT0FBa0MsQ0FBQztRQUN4RCxHQUFHLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEQsQ0FBQztRQUNELE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUNTLGFBQWEsQ0FBQyxJQUFnQixFQUFFLEdBQVEsRUFBRSxPQUFZLEVBQUUsYUFBa0I7UUFDaEYsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUM1QyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ25ELENBQUM7SUFDUyxhQUFhLENBQUMsSUFBZ0IsRUFBRSxHQUFRLEVBQUUsS0FBVSxFQUFFLE9BQVksRUFBRSxhQUFtQjtRQUM3RixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzVDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQzFELENBQUM7Q0FDSjtBQXBCRCxnQ0FvQkMiLCJmaWxlIjoidmVjdG9yL25lc3RlZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbi8vIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuLy8gZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbi8vIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbi8vIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbi8vIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuLy8gd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuLy9cbi8vICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuLy8gc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbi8vIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4vLyBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbi8vIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbi8vIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBEYXRhIH0gZnJvbSAnLi4vZGF0YSc7XG5pbXBvcnQgeyBWaWV3LCBWZWN0b3IgfSBmcm9tICcuLi92ZWN0b3InO1xuaW1wb3J0IHsgSXRlcmFibGVBcnJheUxpa2UgfSBmcm9tICcuLi90eXBlJztcbmltcG9ydCB7IHZhbHVlVG9TdHJpbmcgfSBmcm9tICcuLi91dGlsL3ByZXR0eSc7XG5pbXBvcnQgeyBEYXRhVHlwZSwgTmVzdGVkVHlwZSwgRGVuc2VVbmlvbiwgU3BhcnNlVW5pb24sIFN0cnVjdCwgTWFwXyB9IGZyb20gJy4uL3R5cGUnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgTmVzdGVkVmlldzxUIGV4dGVuZHMgTmVzdGVkVHlwZT4gaW1wbGVtZW50cyBWaWV3PFQ+IHtcbiAgICBwdWJsaWMgbGVuZ3RoOiBudW1iZXI7XG4gICAgcHVibGljIG51bUNoaWxkcmVuOiBudW1iZXI7XG4gICAgcHVibGljIGNoaWxkRGF0YTogRGF0YTxhbnk+W107XG4gICAgcHJvdGVjdGVkIF9jaGlsZHJlbjogVmVjdG9yPGFueT5bXTtcbiAgICBjb25zdHJ1Y3RvcihkYXRhOiBEYXRhPFQ+LCBjaGlsZHJlbj86IFZlY3Rvcjxhbnk+W10pIHtcbiAgICAgICAgdGhpcy5sZW5ndGggPSBkYXRhLmxlbmd0aDtcbiAgICAgICAgdGhpcy5jaGlsZERhdGEgPSBkYXRhLmNoaWxkRGF0YTtcbiAgICAgICAgdGhpcy5udW1DaGlsZHJlbiA9IGRhdGEuY2hpbGREYXRhLmxlbmd0aDtcbiAgICAgICAgdGhpcy5fY2hpbGRyZW4gPSBjaGlsZHJlbiB8fCBuZXcgQXJyYXkodGhpcy5udW1DaGlsZHJlbik7XG4gICAgfVxuICAgIHB1YmxpYyBjbG9uZShkYXRhOiBEYXRhPFQ+KTogdGhpcyB7XG4gICAgICAgIHJldHVybiBuZXcgKDxhbnk+IHRoaXMuY29uc3RydWN0b3IpKGRhdGEsIHRoaXMuX2NoaWxkcmVuKSBhcyB0aGlzO1xuICAgIH1cbiAgICBwdWJsaWMgaXNWYWxpZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHB1YmxpYyB0b0FycmF5KCk6IEl0ZXJhYmxlQXJyYXlMaWtlPFRbJ1RWYWx1ZSddPiB7XG4gICAgICAgIHJldHVybiBbLi4udGhpc107XG4gICAgfVxuICAgIHB1YmxpYyBpbmRleE9mKF86IFRbJ1RWYWx1ZSddKTogbnVtYmVyIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBOb3QgaW1wbGVtZW50ZWQgeWV0YCk7XG4gICAgfVxuICAgIHB1YmxpYyB0b0pTT04oKTogYW55IHsgcmV0dXJuIHRoaXMudG9BcnJheSgpOyB9XG4gICAgcHVibGljIHRvU3RyaW5nKCkge1xuICAgICAgICByZXR1cm4gWy4uLnRoaXNdLm1hcCgoeCkgPT4gdmFsdWVUb1N0cmluZyh4KSkuam9pbignLCAnKTtcbiAgICB9XG4gICAgcHVibGljIGdldChpbmRleDogbnVtYmVyKTogVFsnVFZhbHVlJ10ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXROZXN0ZWQodGhpcywgaW5kZXgpO1xuICAgIH1cbiAgICBwdWJsaWMgc2V0KGluZGV4OiBudW1iZXIsIHZhbHVlOiBUWydUVmFsdWUnXSk6IHZvaWQge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXROZXN0ZWQodGhpcywgaW5kZXgsIHZhbHVlKTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGdldE5lc3RlZChzZWxmOiBOZXN0ZWRWaWV3PFQ+LCBpbmRleDogbnVtYmVyKTogVFsnVFZhbHVlJ107XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IHNldE5lc3RlZChzZWxmOiBOZXN0ZWRWaWV3PFQ+LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogVFsnVFZhbHVlJ10pOiB2b2lkO1xuICAgIHB1YmxpYyBnZXRDaGlsZEF0PFIgZXh0ZW5kcyBEYXRhVHlwZSA9IERhdGFUeXBlPihpbmRleDogbnVtYmVyKTogVmVjdG9yPFI+IHwgbnVsbCB7XG4gICAgICAgIHJldHVybiBpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5udW1DaGlsZHJlblxuICAgICAgICAgICAgPyBudWxsXG4gICAgICAgICAgICA6ICh0aGlzLl9jaGlsZHJlbltpbmRleF0gYXMgVmVjdG9yPFI+KSB8fFxuICAgICAgICAgICAgICAodGhpcy5fY2hpbGRyZW5baW5kZXhdID0gVmVjdG9yLmNyZWF0ZTxSPih0aGlzLmNoaWxkRGF0YVtpbmRleF0pKTtcbiAgICB9XG4gICAgcHVibGljICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPFRbJ1RWYWx1ZSddPiB7XG4gICAgICAgIGNvbnN0IGdldCA9IHRoaXMuZ2V0TmVzdGVkO1xuICAgICAgICBjb25zdCBsZW5ndGggPSB0aGlzLmxlbmd0aDtcbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAtMTsgKytpbmRleCA8IGxlbmd0aDspIHtcbiAgICAgICAgICAgIHlpZWxkIGdldCh0aGlzLCBpbmRleCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBVbmlvblZpZXc8VCBleHRlbmRzIChEZW5zZVVuaW9uIHwgU3BhcnNlVW5pb24pID0gU3BhcnNlVW5pb24+IGV4dGVuZHMgTmVzdGVkVmlldzxUPiB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHB1YmxpYyB0eXBlSWRzOiBJbnQ4QXJyYXk7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHB1YmxpYyB2YWx1ZU9mZnNldHM/OiBJbnQzMkFycmF5O1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwcm90ZWN0ZWQgdHlwZUlkVG9DaGlsZEluZGV4OiB7IFtrZXk6IG51bWJlcl06IG51bWJlciB9O1xuICAgIGNvbnN0cnVjdG9yKGRhdGE6IERhdGE8VD4sIGNoaWxkcmVuPzogVmVjdG9yPGFueT5bXSkge1xuICAgICAgICBzdXBlcihkYXRhLCBjaGlsZHJlbik7XG4gICAgICAgIHRoaXMubGVuZ3RoID0gZGF0YS5sZW5ndGg7XG4gICAgICAgIHRoaXMudHlwZUlkcyA9IGRhdGEudHlwZUlkcztcbiAgICAgICAgdGhpcy50eXBlSWRUb0NoaWxkSW5kZXggPSBkYXRhLnR5cGVJZFRvQ2hpbGRJbmRleDtcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldE5lc3RlZChzZWxmOiBVbmlvblZpZXc8VD4sIGluZGV4OiBudW1iZXIpOiBUWydUVmFsdWUnXSB7XG4gICAgICAgIHJldHVybiBzZWxmLmdldENoaWxkVmFsdWUoc2VsZiwgaW5kZXgsIHNlbGYudHlwZUlkcywgc2VsZi52YWx1ZU9mZnNldHMsIHNlbGYudHlwZUlkVG9DaGlsZEluZGV4KTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHNldE5lc3RlZChzZWxmOiBVbmlvblZpZXc8VD4sIGluZGV4OiBudW1iZXIsIHZhbHVlOiBUWydUVmFsdWUnXSk6IHZvaWQge1xuICAgICAgICByZXR1cm4gc2VsZi5zZXRDaGlsZFZhbHVlKHNlbGYsIGluZGV4LCB2YWx1ZSwgc2VsZi50eXBlSWRzLCBzZWxmLnZhbHVlT2Zmc2V0cywgc2VsZi50eXBlSWRUb0NoaWxkSW5kZXgpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgZ2V0Q2hpbGRWYWx1ZShzZWxmOiBOZXN0ZWRWaWV3PFQ+LCBpbmRleDogbnVtYmVyLCB0eXBlSWRzOiBJbnQ4QXJyYXksIF92YWx1ZU9mZnNldHM6IGFueSwgdHlwZUlkVG9DaGlsZEluZGV4OiB7IFtrZXk6IG51bWJlcl06IG51bWJlciB9KTogYW55IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KHR5cGVJZFRvQ2hpbGRJbmRleFt0eXBlSWRzW2luZGV4XV0pO1xuICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5nZXQoaW5kZXgpIDogbnVsbDtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHNldENoaWxkVmFsdWUoc2VsZjogTmVzdGVkVmlldzxUPiwgaW5kZXg6IG51bWJlciwgdmFsdWU6IFRbJ1RWYWx1ZSddLCB0eXBlSWRzOiBJbnQ4QXJyYXksIF92YWx1ZU9mZnNldHM6IGFueSwgdHlwZUlkVG9DaGlsZEluZGV4OiB7IFtrZXk6IG51bWJlcl06IG51bWJlciB9KTogYW55IHwgbnVsbCB7XG4gICAgICAgIGNvbnN0IGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KHR5cGVJZFRvQ2hpbGRJbmRleFt0eXBlSWRzW2luZGV4XV0pO1xuICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5zZXQoaW5kZXgsIHZhbHVlKSA6IG51bGw7XG4gICAgfVxuICAgIHB1YmxpYyAqW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxUWydUVmFsdWUnXT4ge1xuICAgICAgICBjb25zdCBsZW5ndGggPSB0aGlzLmxlbmd0aDtcbiAgICAgICAgY29uc3QgZ2V0ID0gdGhpcy5nZXRDaGlsZFZhbHVlO1xuICAgICAgICBjb25zdCB7IHR5cGVJZFRvQ2hpbGRJbmRleCB9ID0gdGhpcztcbiAgICAgICAgY29uc3QgeyB0eXBlSWRzLCB2YWx1ZU9mZnNldHMgfSA9IHRoaXM7XG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gLTE7ICsraW5kZXggPCBsZW5ndGg7KSB7XG4gICAgICAgICAgICB5aWVsZCBnZXQodGhpcywgaW5kZXgsIHR5cGVJZHMsIHZhbHVlT2Zmc2V0cywgdHlwZUlkVG9DaGlsZEluZGV4KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIERlbnNlVW5pb25WaWV3IGV4dGVuZHMgVW5pb25WaWV3PERlbnNlVW5pb24+IHtcbiAgICBwdWJsaWMgdmFsdWVPZmZzZXRzOiBJbnQzMkFycmF5O1xuICAgIGNvbnN0cnVjdG9yKGRhdGE6IERhdGE8RGVuc2VVbmlvbj4sIGNoaWxkcmVuPzogVmVjdG9yPGFueT5bXSkge1xuICAgICAgICBzdXBlcihkYXRhLCBjaGlsZHJlbik7XG4gICAgICAgIHRoaXMudmFsdWVPZmZzZXRzID0gZGF0YS52YWx1ZU9mZnNldHM7XG4gICAgfVxuICAgIHByb3RlY3RlZCBnZXROZXN0ZWQoc2VsZjogRGVuc2VVbmlvblZpZXcsIGluZGV4OiBudW1iZXIpOiBhbnkgfCBudWxsIHtcbiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0Q2hpbGRWYWx1ZShzZWxmLCBpbmRleCwgc2VsZi50eXBlSWRzLCBzZWxmLnZhbHVlT2Zmc2V0cywgc2VsZi50eXBlSWRUb0NoaWxkSW5kZXgpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgZ2V0Q2hpbGRWYWx1ZShzZWxmOiBOZXN0ZWRWaWV3PERlbnNlVW5pb24+LCBpbmRleDogbnVtYmVyLCB0eXBlSWRzOiBJbnQ4QXJyYXksIHZhbHVlT2Zmc2V0czogYW55LCB0eXBlSWRUb0NoaWxkSW5kZXg6IHsgW2tleTogbnVtYmVyXTogbnVtYmVyIH0pOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQodHlwZUlkVG9DaGlsZEluZGV4W3R5cGVJZHNbaW5kZXhdXSk7XG4gICAgICAgIHJldHVybiBjaGlsZCA/IGNoaWxkLmdldCh2YWx1ZU9mZnNldHNbaW5kZXhdKSA6IG51bGw7XG4gICAgfVxuICAgIHByb3RlY3RlZCBzZXRDaGlsZFZhbHVlKHNlbGY6IE5lc3RlZFZpZXc8RGVuc2VVbmlvbj4sIGluZGV4OiBudW1iZXIsIHZhbHVlOiBhbnksIHR5cGVJZHM6IEludDhBcnJheSwgdmFsdWVPZmZzZXRzOiBhbnksIHR5cGVJZFRvQ2hpbGRJbmRleDogeyBba2V5OiBudW1iZXJdOiBudW1iZXIgfSk6IGFueSB8IG51bGwge1xuICAgICAgICBjb25zdCBjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRUb0NoaWxkSW5kZXhbdHlwZUlkc1tpbmRleF1dKTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuc2V0KHZhbHVlT2Zmc2V0c1tpbmRleF0sIHZhbHVlKSA6IG51bGw7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3RydWN0VmlldyBleHRlbmRzIE5lc3RlZFZpZXc8U3RydWN0PiB7XG4gICAgcHJvdGVjdGVkIGdldE5lc3RlZChzZWxmOiBTdHJ1Y3RWaWV3LCBpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBuZXcgUm93VmlldyhzZWxmIGFzIGFueSwgc2VsZi5fY2hpbGRyZW4sIGluZGV4KTtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHNldE5lc3RlZChzZWxmOiBTdHJ1Y3RWaWV3LCBpbmRleDogbnVtYmVyLCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgICAgIGxldCBpZHggPSAtMSwgbGVuID0gc2VsZi5udW1DaGlsZHJlbiwgY2hpbGQ6IFZlY3RvciB8IG51bGw7XG4gICAgICAgIGlmICghKHZhbHVlIGluc3RhbmNlb2YgTmVzdGVkVmlldyB8fCB2YWx1ZSBpbnN0YW5jZW9mIFZlY3RvcikpIHtcbiAgICAgICAgICAgIHdoaWxlICgrK2lkeCA8IGxlbikge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdChpZHgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkLnNldChpbmRleCwgdmFsdWVbaWR4XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgd2hpbGUgKCsraWR4IDwgbGVuKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KGlkeCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGQuc2V0KGluZGV4LCB2YWx1ZS5nZXQoaWR4KSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTWFwVmlldyBleHRlbmRzIE5lc3RlZFZpZXc8TWFwXz4ge1xuICAgIHB1YmxpYyB0eXBlSWRzOiB7IFtrOiBzdHJpbmddOiBudW1iZXIgfTtcbiAgICBjb25zdHJ1Y3RvcihkYXRhOiBEYXRhPE1hcF8+LCBjaGlsZHJlbj86IFZlY3Rvcjxhbnk+W10pIHtcbiAgICAgICAgc3VwZXIoZGF0YSwgY2hpbGRyZW4pO1xuICAgICAgICB0aGlzLnR5cGVJZHMgPSBkYXRhLnR5cGUuY2hpbGRyZW4ucmVkdWNlKCh4cywgeCwgaSkgPT5cbiAgICAgICAgICAgICh4c1t4Lm5hbWVdID0gaSkgJiYgeHMgfHwgeHMsIE9iamVjdC5jcmVhdGUobnVsbCkpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgZ2V0TmVzdGVkKHNlbGY6IE1hcFZpZXcsIGluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBNYXBSb3dWaWV3KHNlbGYgYXMgYW55LCBzZWxmLl9jaGlsZHJlbiwgaW5kZXgpO1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgc2V0TmVzdGVkKHNlbGY6IE1hcFZpZXcsIGluZGV4OiBudW1iZXIsIHZhbHVlOiB7IFtrOiBzdHJpbmddOiBhbnkgfSk6IHZvaWQge1xuICAgICAgICBsZXQgdHlwZUlkcyA9IHNlbGYudHlwZUlkcyBhcyBhbnksIGNoaWxkOiBWZWN0b3IgfCBudWxsO1xuICAgICAgICBpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIE5lc3RlZFZpZXcgfHwgdmFsdWUgaW5zdGFuY2VvZiBWZWN0b3IpKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0eXBlSWRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KHR5cGVJZHNba2V5XSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGQuc2V0KGluZGV4LCB2YWx1ZVtrZXldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0eXBlSWRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkID0gc2VsZi5nZXRDaGlsZEF0KHR5cGVJZHNba2V5XSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGQuc2V0KGluZGV4LCB2YWx1ZS5nZXQoa2V5IGFzIGFueSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJvd1ZpZXcgZXh0ZW5kcyBVbmlvblZpZXc8U3BhcnNlVW5pb24+IHtcbiAgICBwcm90ZWN0ZWQgcm93SW5kZXg6IG51bWJlcjtcbiAgICBjb25zdHJ1Y3RvcihkYXRhOiBEYXRhPFNwYXJzZVVuaW9uPiAmIE5lc3RlZFZpZXc8YW55PiwgY2hpbGRyZW4/OiBWZWN0b3I8YW55PltdLCByb3dJbmRleD86IG51bWJlcikge1xuICAgICAgICBzdXBlcihkYXRhLCBjaGlsZHJlbik7XG4gICAgICAgIHRoaXMucm93SW5kZXggPSByb3dJbmRleCB8fCAwO1xuICAgICAgICB0aGlzLmxlbmd0aCA9IGRhdGEubnVtQ2hpbGRyZW47XG4gICAgfVxuICAgIHB1YmxpYyBjbG9uZShkYXRhOiBEYXRhPFNwYXJzZVVuaW9uPiAmIE5lc3RlZFZpZXc8YW55Pik6IHRoaXMge1xuICAgICAgICByZXR1cm4gbmV3ICg8YW55PiB0aGlzLmNvbnN0cnVjdG9yKShkYXRhLCB0aGlzLl9jaGlsZHJlbiwgdGhpcy5yb3dJbmRleCkgYXMgdGhpcztcbiAgICB9XG4gICAgcHJvdGVjdGVkIGdldENoaWxkVmFsdWUoc2VsZjogUm93VmlldywgaW5kZXg6IG51bWJlciwgX3R5cGVJZHM6IGFueSwgX3ZhbHVlT2Zmc2V0cz86IGFueSk6IGFueSB8IG51bGwge1xuICAgICAgICBjb25zdCBjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdChpbmRleCk7XG4gICAgICAgIHJldHVybiBjaGlsZCA/IGNoaWxkLmdldChzZWxmLnJvd0luZGV4KSA6IG51bGw7XG4gICAgfVxuICAgIHByb3RlY3RlZCBzZXRDaGlsZFZhbHVlKHNlbGY6IFJvd1ZpZXcsIGluZGV4OiBudW1iZXIsIHZhbHVlOiBhbnksIF90eXBlSWRzOiBhbnksIF92YWx1ZU9mZnNldHM/OiBhbnkpOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQoaW5kZXgpO1xuICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5zZXQoc2VsZi5yb3dJbmRleCwgdmFsdWUpIDogbnVsbDtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBNYXBSb3dWaWV3IGV4dGVuZHMgUm93VmlldyB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHB1YmxpYyB0eXBlSWRzOiBhbnk7XG4gICAgcHVibGljIHRvSlNPTigpIHtcbiAgICAgICAgY29uc3QgZ2V0ID0gdGhpcy5nZXRDaGlsZFZhbHVlO1xuICAgICAgICBjb25zdCByZXN1bHQgPSB7fSBhcyB7IFtrOiBzdHJpbmddOiBhbnkgfTtcbiAgICAgICAgY29uc3QgdHlwZUlkcyA9IHRoaXMudHlwZUlkcyBhcyB7IFtrOiBzdHJpbmddOiBudW1iZXIgfTtcbiAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIHR5cGVJZHMpIHtcbiAgICAgICAgICAgIHJlc3VsdFtuYW1lXSA9IGdldCh0aGlzLCBuYW1lLCB0eXBlSWRzLCBudWxsKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBwcm90ZWN0ZWQgZ2V0Q2hpbGRWYWx1ZShzZWxmOiBNYXBSb3dWaWV3LCBrZXk6IGFueSwgdHlwZUlkczogYW55LCBfdmFsdWVPZmZzZXRzOiBhbnkpOiBhbnkgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzZWxmLmdldENoaWxkQXQodHlwZUlkc1trZXldKTtcbiAgICAgICAgcmV0dXJuIGNoaWxkID8gY2hpbGQuZ2V0KHNlbGYucm93SW5kZXgpIDogbnVsbDtcbiAgICB9XG4gICAgcHJvdGVjdGVkIHNldENoaWxkVmFsdWUoc2VsZjogTWFwUm93Vmlldywga2V5OiBhbnksIHZhbHVlOiBhbnksIHR5cGVJZHM6IGFueSwgX3ZhbHVlT2Zmc2V0cz86IGFueSk6IGFueSB8IG51bGwge1xuICAgICAgICBjb25zdCBjaGlsZCA9IHNlbGYuZ2V0Q2hpbGRBdCh0eXBlSWRzW2tleV0pO1xuICAgICAgICByZXR1cm4gY2hpbGQgPyBjaGlsZC5zZXQoc2VsZi5yb3dJbmRleCwgdmFsdWUpIDogbnVsbDtcbiAgICB9XG59XG4iXX0=
